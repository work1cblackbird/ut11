#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// Функция возвращает таблицы состояний заказов клиентов и давальцев
//
//	Параметры:
//		МассивСсылок - Массив - массив заказов, таблицы состояний которых требуется получить
// Возвращаемое значение:
//	Структура - структура состояний содержащая значения:
//		ТаблицаСостоянийЗаказов
//		ТаблицаПредыдущихСостоянийЗаказов
//
Функция ТаблицыСостоянийЗаказов(МассивСсылок) Экспорт
	
	ТаблицаСостоянийЗаказов = ТаблицаСостоянийЗаказов(МассивСсылок);
	ТаблицаПредыдущихСостоянийЗаказов = ТаблицаПредыдущихСостоянийЗаказов(МассивСсылок);
	
	Возврат Новый Структура("ТаблицаСостоянийЗаказов, ТаблицаПредыдущихСостоянийЗаказов",
		ТаблицаСостоянийЗаказов, ТаблицаПредыдущихСостоянийЗаказов);
	
КонецФункции

// Отражает изменения состояний заказов в регистре.
//
// Параметры:
//  Заказы - Массив из ДокументСсылка - массив отражаемых заказов.
//  Ошибки - Неопределено, Соответствие из КлючИЗначение - со структурой:
//                          *Ключ     - ДокументСсылка -
//                          *Значение - Строка - Подробное представление ошибки.
//
Процедура ОтразитьСостоянияЗаказов(Заказы, Ошибки = Неопределено) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Таблица.Ссылка      КАК Заказ,
	|	НЕ Таблица.Проведен КАК УдалениеПроведения
	|ИЗ
	|	Документ.ЗаказКлиента КАК Таблица
	|ГДЕ
	|	Таблица.Ссылка В (&Заказы)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Таблица.Ссылка      КАК Заказ,
	|	НЕ Таблица.Проведен КАК УдалениеПроведения
	|ИЗ
	|	Документ.ЗаявкаНаВозвратТоваровОтКлиента КАК Таблица
	|ГДЕ
	|	Таблица.Ссылка В (&Заказы)
	|";
	
	Запрос.УстановитьПараметр("Заказы", Заказы);
	
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	ТаблицаЗаказов = Результат.Выгрузить();
	
	КоличествоЗаказов = ТаблицаЗаказов.Количество();
	Если КоличествоЗаказов = 1 Тогда
		
		СтрокаТаблицы = ТаблицаЗаказов[0];
		
		ОтобранныеЗаказы = Новый Массив;
		ОтобранныеЗаказы.Добавить(СтрокаТаблицы.Заказ);
		
		УдалениеПроведения = СтрокаТаблицы.УдалениеПроведения;
		
		ОтразитьСостояниеЗаказа(ОтобранныеЗаказы, УдалениеПроведения, Ошибки);
		
	ИначеЕсли КоличествоЗаказов > 1 Тогда
		
		ТаблицаЗаказов.Индексы.Добавить("УдалениеПроведения");
		
		Отбор = Новый Структура("УдалениеПроведения");
		
		Отбор.УдалениеПроведения = Истина;
		ТаблицаОтобранныхЗаказов = ТаблицаЗаказов.Скопировать(Отбор, "Заказ");
		Если ТаблицаОтобранныхЗаказов.Количество() > 0 Тогда
			
			ОтобранныеЗаказы = ТаблицаОтобранныхЗаказов.ВыгрузитьКолонку("Заказ");
			ОтразитьСостояниеЗаказа(ОтобранныеЗаказы, Отбор.УдалениеПроведения, Ошибки);
			
		КонецЕсли;
		
		Отбор.УдалениеПроведения = Ложь;
		ТаблицаОтобранныхЗаказов = ТаблицаЗаказов.Скопировать(Отбор, "Заказ");
		Если ТаблицаОтобранныхЗаказов.Количество() > 0 Тогда
			
			ОтобранныеЗаказы = ТаблицаОтобранныхЗаказов.ВыгрузитьКолонку("Заказ");
			ОтразитьСостояниеЗаказа(ОтобранныеЗаказы, Отбор.УдалениеПроведения, Ошибки);
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// Дополняет текст запроса механизма расчета состояний.
// 
// Параметры:
// 	Запрос - Запрос - используется для установки параметров запроса.
// 
// Возвращаемое значение:
//	Соответствие - соответствие имен таблиц изменения регистров и текстов запросов.
//	
Функция СоответствиеЗапросовКонтрольнымРегистрам(Запрос) Экспорт

	СоответствиеЗаданий = Новый Соответствие();
	СоответствиеЗаданий.Вставить("РеестрДокументовИзменения", ТекстЗапросаРеестрДокументов(Запрос));
	СоответствиеЗаданий.Вставить("ДвиженияРаспоряженияНаОтгрузкуИзменение", ТекстЗапросаРаспоряженияНаОтгрузку(Запрос));
	СоответствиеЗаданий.Вставить("РасчетыСКлиентамиИзменения", ТекстЗапросаРасчетыСКлиентами(Запрос));
	СоответствиеЗаданий.Вставить("ДвиженияТоварыКОтгрузкеИзменение", ТекстЗапросаТоварыКОтгрузке(Запрос));
	СоответствиеЗаданий.Вставить("ТоварыКПоступлениюИзменение", ТекстЗапросаТоварыКПоступлению(Запрос));
	Если Не РаспределениеЗапасов.ДосчитыватьРегистрРегламентнымЗаданием() Тогда
		СоответствиеЗаданий.Вставить("СостоянияЗаказовКлиентовИзменение",
			ТекстЗапросаСостоянияЗаказовКлиентовИзменение(Запрос));
	КонецЕсли;
	Возврат СоответствиеЗаданий;
	
КонецФункции

// Добавляет задания к отражению состояния заказов в механизме проведения документов.
// 
// Параметры:
//  Источник       - см. СостоянияДокументов.ДобавитьЗаданияКОтражениюСостоянияЗаказов.Источник
//  Заказы         - см. СостоянияДокументов.ДобавитьЗаданияКОтражениюСостоянияЗаказов.ОтражаемыеДокументы
//  Действие       - см. СостоянияДокументов.ДобавитьЗаданияКОтражениюСостоянияЗаказов.Действие
//  ТаблицаЗаданий - см. ОтложенныеЗадания.ДобавитьЗаданияВОчередь.ТаблицаЗаданий
//
Процедура ДобавитьЗаданияКОтражениюСостоянияЗаказов(
			Источник,
			Заказы,
			Действие = "",
			ТаблицаЗаданий = Неопределено) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если Источник <> Неопределено И Заказы.Найти(Источник.Ссылка) = Неопределено Тогда
		Заказы.Добавить(Источник.Ссылка);
	КонецЕсли;
	
	ТипыЗаказов = ТипыЗаказовДляОтраженияСостояний();
	
	Для каждого Заказ Из Заказы Цикл
		
		Если ТипыЗаказов.Найти(ТипЗнч(Заказ)) = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		РегистрыСведений.ЗаданияКОтражениюСостоянияЗаказов.ДобавитьЗадания(Заказ, Действие, ТаблицаЗаданий);
		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс

Функция ПараметрыАктуализацииСостоянийЗаказов() Экспорт
	
	Результат = Новый Структура("ПравилоОтбораЗаписей,ФункцияСравненияЗаписей,ФункцияСравненияЗаписейВоВременнуюТаблицу");
	
	Результат.ПравилоОтбораЗаписей =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	РаспределениеЗапасов.ЗаказНаОтгрузку КАК ЗаказНаОтгрузку
		|ПОМЕСТИТЬ ТаблицаПереопределяемый
		|ИЗ
		|	ФильтрПереопределяемый КАК Товары
		|		
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РаспределениеЗапасов КАК РаспределениеЗапасов
		|		ПО РаспределениеЗапасов.Номенклатура  = Товары.Номенклатура
		|		И РаспределениеЗапасов.Характеристика = Товары.Характеристика
		|		И РаспределениеЗапасов.Склад          = Товары.Склад
		|		И РаспределениеЗапасов.Назначение     = Товары.Назначение
		|		И РаспределениеЗапасов.Состояние В(
		|				ЗНАЧЕНИЕ(Перечисление.РаспределениеЗапасовСостояния.Обеспечить),
		|				ЗНАЧЕНИЕ(Перечисление.РаспределениеЗапасовСостояния.ОжидаетсяПоНеподтвержденномуЗаказу),
		|				ЗНАЧЕНИЕ(Перечисление.РаспределениеЗапасовСостояния.ОбеспеченКДате))
		|			
		|ГДЕ
		|	НЕ РаспределениеЗапасов.Номенклатура ЕСТЬ NULL
		|		И ТИПЗНАЧЕНИЯ(РаспределениеЗапасов.ЗаказНаОтгрузку) В(
		|			ТИП(Документ.ЗаказКлиента),
		|			ТИП(Документ.ЗаявкаНаВозвратТоваровОтКлиента))
		|ИНДЕКСИРОВАТЬ ПО
		|	ЗаказНаОтгрузку";
		
	Результат.ФункцияСравненияЗаписейВоВременнуюТаблицу =
		"ВЫБРАТЬ
		|	ПередЗаписью.ЗаказНаОтгрузку КАК Заказ
		|ПОМЕСТИТЬ ИзменениеПереопределяемый
		|ИЗ
		|	ПередЗаписьюПереопределяемый КАК ПередЗаписью
		|		
		|		ЛЕВОЕ СОЕДИНЕНИЕ ПриЗаписиПереопределяемый КАК ПриЗаписи
		|		ПО ПриЗаписи.ЗаказНаОтгрузку = ПередЗаписью.ЗаказНаОтгрузку
		|ГДЕ
		|		ПриЗаписи.ЗаказНаОтгрузку ЕСТЬ NULL
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	ПриЗаписи.ЗаказНаОтгрузку КАК Заказ
		|ИЗ
		|	ПриЗаписиПереопределяемый КАК ПриЗаписи
		|		
		|		ЛЕВОЕ СОЕДИНЕНИЕ ПередЗаписьюПереопределяемый КАК ПередЗаписью
		|		ПО ПередЗаписью.ЗаказНаОтгрузку = ПриЗаписи.ЗаказНаОтгрузку
		|ГДЕ
		|	ПередЗаписью.ЗаказНаОтгрузку ЕСТЬ NULL";
	
	Результат.ФункцияСравненияЗаписей = СтрЗаменить(Результат.ФункцияСравненияЗаписейВоВременнуюТаблицу,
		"ПОМЕСТИТЬ ИзменениеПереопределяемый", "");

	Возврат Результат;
	
КонецФункции

// Возвращает типы заказов по которым нужно отразить состояния.
//
// Возвращаемое значение:
//  Массив из Тип - Типы заказов отражения состояний
//
Функция ТипыЗаказовДляОтраженияСостояний() Экспорт
	
	ТипыЗаказов = Новый Массив;
	ТипыЗаказов.Добавить(Тип("ДокументСсылка.ЗаказКлиента"));
	ТипыЗаказов.Добавить(Тип("ДокументСсылка.ЗаявкаНаВозвратТоваровОтКлиента"));
	
	Возврат ТипыЗаказов;
	
КонецФункции

// Возвращает таблицу действий для отражения состояния заказов.
// Подробное описание в функции СостоянияДокументов.ИнициализироватьТаблицуДействийДляОтраженияСостоянияЗаказов.
// 
// Возвращаемое значение:
//  - Неопределено,
//  - см. СостоянияДокументов.ИнициализироватьТаблицуДействийДляОтраженияСостоянияЗаказов
//
Функция ДействияДляОтраженияСостоянияЗаказов() Экспорт
	
	Возврат Неопределено;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Процедура по переданной ссылке на заказ рассчитывает и записывает в регистр сведений состояние заказа.
//
//	Параметры:
//  Заказы - ДокументСсылка - документ, в рамках проведения которого перерасчитывается состояние
//  УдалениеПроведения - Булево - признак обработки удаления проведения.
//  Ошибки - см. ОтразитьСостоянияЗаказов.Ошибки
//
Процедура ОтразитьСостояниеЗаказа(Заказы, УдалениеПроведения = Ложь, Ошибки = Неопределено)
	
	Если УдалениеПроведения Тогда
		
		Для Каждого Заказ Из Заказы Цикл
			
			Набор = РегистрыСведений.СостоянияЗаказовКлиентов.СоздатьНаборЗаписей();
			Набор.Отбор.Заказ.Установить(Заказ);
			
			Попытка
				Набор.Записать(Истина);
			Исключение
				
				ТекстОшибки = ТекстОшибкиОтражения(Заказ, ИнформацияОбОшибке());
				
				ЗаписьЖурналаРегистрации(
					ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(),
					УровеньЖурналаРегистрации.Предупреждение,
					Заказ.Метаданные(),
					Заказ,
					ТекстОшибки);
				
				Если Ошибки <> Неопределено Тогда
					Ошибки.Вставить(Заказ, ТекстОшибки);
				КонецЕсли;
				
			КонецПопытки;
			
		КонецЦикла;
		
		Возврат;
		
	КонецЕсли;
	
	СтруктураПоиска = Новый Структура("Заказ, Состояние, ДатаСобытия, 
		|СуммаОплаты, ПроцентОплаты, СуммаОтгрузки, ПроцентОтгрузки, СуммаДолга, ПроцентДолга, ЕстьРасхожденияОрдерНакладная");
	
	ТаблицаСостоянийЗаказов = ТаблицаСостоянийЗаказов(Заказы);
	ТаблицаПредыдущихСостоянийЗаказов = ТаблицаПредыдущихСостоянийЗаказов(Заказы);
	
	Для Каждого СтрокаТаблицы Из ТаблицаСостоянийЗаказов Цикл
		
		ЗаполнитьЗначенияСвойств(СтруктураПоиска, СтрокаТаблицы);
		МассивДействующихСостояний = ТаблицаПредыдущихСостоянийЗаказов.НайтиСтроки(СтруктураПоиска);
		
		СостояниеИзменено = НЕ Булево(МассивДействующихСостояний.Количество());
		Если СостояниеИзменено Тогда
			
			Набор = РегистрыСведений.СостоянияЗаказовКлиентов.СоздатьНаборЗаписей();
			Набор.Отбор.Заказ.Установить(СтрокаТаблицы.Заказ);
			
			СтрокаНабора = Набор.Добавить();
			
			ПроцентДолгаОплатыДоОкругления = СтрокаТаблицы.ПроцентОплаты + СтрокаТаблицы.ПроцентДолга;
			ОкруглитьПроценты(СтрокаТаблицы.ПроцентОтгрузки);
			ОкруглитьПроценты(СтрокаТаблицы.ПроцентОплаты);
			ОкруглитьПроценты(СтрокаТаблицы.ПроцентДолга);
			ОстатокПослеОкругления = ПроцентДолгаОплатыДоОкругления - СтрокаТаблицы.ПроцентОплаты - СтрокаТаблицы.ПроцентДолга;
			ОкруглитьПроценты(ПроцентДолгаОплатыДоОкругления);
			// Если оплата и долг в сумме 100%, хвосты от округления добавим, по возможности, к долгу, 
			// чтобы оплата сходилась с текстом гиперссылки "Состояние расчетов"
			Если ОстатокПослеОкругления <> 0 
				И ПроцентДолгаОплатыДоОкругления = СтрокаТаблицы.ПроцентОтгрузки 
				И СтрокаТаблицы.ПроцентОплаты > 0
				И СтрокаТаблицы.ПроцентДолга > 0
				И СтрокаТаблицы.СуммаДолга > 0 Тогда
				Если СтрокаТаблицы.ПроцентДолга + ОстатокПослеОкругления < 1 Тогда
					СтрокаТаблицы.ПроцентОплаты = СтрокаТаблицы.ПроцентОплаты + ОстатокПослеОкругления;
				Иначе
					СтрокаТаблицы.ПроцентДолга = СтрокаТаблицы.ПроцентДолга + ОстатокПослеОкругления;
				КонецЕсли;
			КонецЕсли;
			
			ЗаполнитьЗначенияСвойств(СтрокаНабора, СтрокаТаблицы);
			
			Попытка
				Набор.Записать(Истина);
			Исключение
				
				ТекстОшибки = ТекстОшибкиОтражения(СтрокаТаблицы.Заказ, ИнформацияОбОшибке());
				
				ЗаписьЖурналаРегистрации(
					ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(),
					УровеньЖурналаРегистрации.Предупреждение,
					СтрокаТаблицы.Заказ.Метаданные(),
					СтрокаТаблицы.Заказ,
					ТекстОшибки);
				
				Если Ошибки <> Неопределено Тогда
					Ошибки.Вставить(СтрокаТаблицы.Заказ, ТекстОшибки);
				КонецЕсли;
				
			КонецПопытки;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Функция ТекстОшибкиОтражения(Заказ, ИнформацияОбОшибке)
	
	Если ТипЗнч(Заказ) = Тип("ДокументСсылка.ЗаказКлиента") Тогда
		
		Шаблон = НСтр("ru = 'Не удалось отразить состояние заказа клиента: %1 по причине: %2'");
		
	ИначеЕсли ТипЗнч(Заказ) = Тип("ДокументСсылка.ЗаявкаНаВозвратТоваровОтКлиента") Тогда
		
		Шаблон = НСтр("ru = 'Не удалось отразить состояние заявки на возврат: %1 по причине: %2'");
		
	КонецЕсли;
	
	Возврат СтрШаблон(Шаблон, Заказ, ОбработкаОшибок.ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
	
КонецФункции

// Округляет проценты отгрузки, оплаты, долга
//
// Параметры:
//	ОкругляемоеЧисло - Число - округляемое число.
//
Процедура ОкруглитьПроценты(ОкругляемоеЧисло)
	
	Если ОкругляемоеЧисло > 99
		И ОкругляемоеЧисло < 100 Тогда
		
		ОкругляемоеЧисло = 99;
		
	КонецЕсли;
	
	Если ОкругляемоеЧисло > 0
		И ОкругляемоеЧисло < 1 Тогда
		
		ОкругляемоеЧисло = 1;
		
	КонецЕсли;
	
	ОкругляемоеЧисло = Окр(ОкругляемоеЧисло);
	
КонецПроцедуры

// Функция возвращает таблицу значений с состояниями документов.
//
//	Параметры:
//		МассивСсылок - Массив - (состоящий из ДокументСсылка) ссылки на документы, по которым
//					нужно рассчитать состояние. В модуле менеджера документов должна быть определена функция
//					ТекстЗапросаДляРасчетаДатыАктуальностиСостоянийЗаказов(), которая возвращает текст запроса по датам актуальности и
//					ТекстЗапросаДляРасчетаСостоянийЗаказов(), которая возвращает текст запроса по состояниям заказов.
//	Возвращаемое значение:
//		ТаблицаЗначений:
//			Заказ - ДокументСсылка
//			Состояние - ПеречислениеСсылка.СостоянияЗаказовКлиентов, ПеречислениеСсылка.СостоянияЗаявокНаВозвратТоваровОтКлиента
//			ДатаСобытия - Дата
//			СуммаОплаты - Число
//			ПроцентОплаты - Число
//			СуммаОтгрузки - Число
//			ПроцентОтгрузки - Число
//			СуммаДолга - Число
//			ПроцентДолга - Число
//			ЕстьРасхожденияОрдерНакладная - Булево
//
Функция ТаблицаСостоянийЗаказов(МассивСсылок)
	
	СоотвествиеТипов = ОбщегоНазначенияУТ.СоответствиеМассивовПоТипамОбъектов(МассивСсылок);
	
	НоваяАрхитектураВзаиморасчетов = ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов");
	
	ТекстыПакета = Новый Массив;
	ТекстыПакета.Добавить(ТекстЗапросаДляРасчетаДатСобытийСостоянийЗаказов());
	ТекстыПакета.Добавить(ТекстЗапросаДляРасчетаСостоянийОбеспеченияЗаказа());
	ТекстыПакета.Добавить(ТекстЗапросаЧастичноВНаличии());
	ТекстыПакета.Добавить(ТекстЗапросаДляРасчетаРасхожденийОрдерНакладная());
	ТекстЗапросаДопустимыхОтклонения = ТекстЗапросаДопустимыхОтклонения(СоотвествиеТипов);
	Если Не ПустаяСтрока(ТекстЗапросаДопустимыхОтклонения) Тогда
		ТекстыПакета.Добавить(ТекстЗапросаДопустимыхОтклонения);
	КонецЕсли;
	
	Если НоваяАрхитектураВзаиморасчетов Тогда
		ТекстыПакета.Добавить(ТекстЗапросаСостояниеВзаиморасчетов());
	Иначе
		ТекстыПакета.Добавить(ТекстЗапросаРасчетов());
		ТекстыПакета.Добавить(ТекстЗапросаОстатковРасчетов());
	КонецЕсли;
	
	ТекстыПоДокументам = Новый Массив;
	ТекстыСостоянияОфлайнРасчетов = Новый Массив;
	
	ПервыйЗапрос = Истина;
	
	Для Каждого ТипДокумента Из СоотвествиеТипов Цикл
		
		Если ТипДокумента.Ключ = "Документ.ЗаказКлиента"
			Или ТипДокумента.Ключ = "Документ.ЗаявкаНаВозвратТоваровОтКлиента" Тогда
			
			МенеджерОбъекта             = ОбщегоНазначения.МенеджерОбъектаПоПолномуИмени(ТипДокумента.Ключ);
			ТекстыПоДокументам.Добавить(МенеджерОбъекта.ТекстЗапросаДляРасчетаСостоянийЗаказов());
			
			Если Не НоваяАрхитектураВзаиморасчетов Тогда
				Если ПервыйЗапрос Тогда
					ТекстыСостоянияОфлайнРасчетов.Добавить(ТекстЗапросаСостояниеОфлайнВзаиморасчетов(ТипДокумента.Ключ));
				Иначе
					ТекстыСостоянияОфлайнРасчетов.Добавить(
						СтрЗаменить(ТекстЗапросаСостояниеОфлайнВзаиморасчетов(ТипДокумента.Ключ), "ПОМЕСТИТЬ ВтСостояниеВзаиморасчетов", ""));
				КонецЕсли;
			КонецЕсли;
			
			ПервыйЗапрос = Ложь;
		КонецЕсли;
	КонецЦикла;
	
	Если ТекстыСостоянияОфлайнРасчетов.Количество() > 0 Тогда
		ТекстыПакета.Добавить(СтрСоединить(ТекстыСостоянияОфлайнРасчетов, ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении()));
	КонецЕсли;
	ТекстыПакета.Добавить(СтрСоединить(ТекстыПоДокументам, ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении()));
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.Текст = СтрСоединить(ТекстыПакета, ОбщегоНазначения.РазделительПакетаЗапросов());
	Запрос.УстановитьПараметр("МассивЗаказов", МассивСсылок);
	Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДатаСеанса());
	Запрос.УстановитьПараметр("МенеджерСоздаетОрдера", Константы.РежимФормированияРасходныхОрдеров.Получить() = Перечисления.РежимыФормированияРасходныхОрдеров.Менеджером);
	Запрос.УстановитьПараметр("КонтролироватьЗакрытиеЗаказа", 
			ПолучитьФункциональнуюОпцию("НеЗакрыватьЗаказыКлиентовБезПолнойОплаты")
				ИЛИ ПолучитьФункциональнуюОпцию("НеЗакрыватьЗаказыКлиентовБезПолнойОтгрузки"));
				
	
	Запрос.УстановитьПараметр("МерныеТипыВеличин", Справочники.УпаковкиЕдиницыИзмерения.МерныеТипыЕдиницИзмерений());
	Запрос.УстановитьПараметр("ДопустимоеОтклонениеОтгрузкиПриемкиМерныхТоваров",
		Константы.ДопустимоеОтклонениеОтгрузкиПриемкиМерныхТоваров.Получить());
	
	ГраницыОборотов = ОбщегоНазначенияУТ.ГраницыОборотовРегистра("РаспоряженияНаОтгрузку",
																"Распоряжение В (&МассивЗаказов)",
																Запрос.Параметры);
	
	Запрос.УстановитьПараметр("НачПериодЗаказыКлиентов", ГраницыОборотов.МинимальнаяДата);
	Запрос.УстановитьПараметр("КонПериодЗаказыКлиентов", ГраницыОборотов.МаксимальнаяДата);
	
	ГраницыОборотов = ОбщегоНазначенияУТ.ГраницыОборотовРегистра("ТоварыКОтгрузке",
																"ДокументОтгрузки В (&МассивЗаказов)",
																Запрос.Параметры);
	
	Запрос.УстановитьПараметр("НачПериодТоварыКОтгрузке", ГраницыОборотов.МинимальнаяДата);
	Запрос.УстановитьПараметр("КонПериодТоварыКОтгрузке", ГраницыОборотов.МаксимальнаяДата);
	Запрос.УстановитьПараметр("ДанныеОтчета", 4);

	ТаблицаСостояний = Запрос.Выполнить().Выгрузить();
	
	Возврат ТаблицаСостояний;
	
КонецФункции

// Функция возвращает текст запроса для расчета даты актуальности состояний заказов.
//
// Возвращаемое значение:
//	Строка - Текст запроса
//
Функция ТекстЗапросаДляРасчетаДатСобытийСостоянийЗаказов()
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетов,
		|	ОбъектыРасчетов.Объект КАК ЗаказКлиента
		|ПОМЕСТИТЬ ВтОбъектыРасчетов
		|ИЗ
		|	Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
		|ГДЕ
		|	ОбъектыРасчетов.Объект В (&МассивЗаказов)
		|;
		|ВЫБРАТЬ
		|	НАЧАЛОПЕРИОДА(РасчетыСКлиентами.Период, ДЕНЬ) КАК Период,
		|	СУММА(РасчетыСКлиентами.КОплате) КАК КОплатеПриход,
		|	РасчетыСКлиентами.ОбъектРасчетов КАК ОбъектРасчетов
		|ПОМЕСТИТЬ ЭтапыРасчетов
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентами КАК РасчетыСКлиентами
		|ГДЕ
		|	РасчетыСКлиентами.ОбъектРасчетов В (
		|		ВЫБРАТЬ ОбъектРасчетов ИЗ ВтОбъектыРасчетов)
		|	И РасчетыСКлиентами.Активность
		|	И РасчетыСКлиентами.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И РасчетыСКлиентами.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиенту)
		|	И РасчетыСКлиентами.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности)
		|	И РасчетыСКлиентами.АналитикаУчетаПоПартнерам.Организация = ОбъектРасчетов.Организация
		|	И РасчетыСКлиентами.КОплате <> 0
		|СГРУППИРОВАТЬ ПО
		|	РасчетыСКлиентами.ОбъектРасчетов,
		|	НАЧАЛОПЕРИОДА(РасчетыСКлиентами.Период, ДЕНЬ)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	РасчетыСКлиентами.ОбъектРасчетов КАК ОбъектРасчетов,
		|	СУММА(РасчетыСКлиентами.КОплате) КАК КОплатеРасход
		|ПОМЕСТИТЬ ОплаченоПоЗаказам
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентами КАК РасчетыСКлиентами
		|ГДЕ
		|	РасчетыСКлиентами.ОбъектРасчетов В (
		|		ВЫБРАТЬ ОбъектРасчетов ИЗ ВтОбъектыРасчетов)
		|	И РасчетыСКлиентами.Активность
		|	И РасчетыСКлиентами.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И РасчетыСКлиентами.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиенту)
		|	И РасчетыСКлиентами.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности)
		|	И РасчетыСКлиентами.АналитикаУчетаПоПартнерам.Организация = ОбъектРасчетов.Организация
		|СГРУППИРОВАТЬ ПО
		|	РасчетыСКлиентами.ОбъектРасчетов
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЭтапыРасчетов.Период КАК Период,
		|	ЭтапыРасчетов.ОбъектРасчетов КАК ОбъектРасчетов
		|ПОМЕСТИТЬ РезультатРасчетов
		|ИЗ
		|	ЭтапыРасчетов КАК ЭтапыРасчетов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ЭтапыРасчетов КАК РасчетыСКлиентами
		|		ПО (РасчетыСКлиентами.Период <= ЭтапыРасчетов.Период)
		|			И (РасчетыСКлиентами.ОбъектРасчетов = ЭтапыРасчетов.ОбъектРасчетов)
		|		ЛЕВОЕ СОЕДИНЕНИЕ ОплаченоПоЗаказам КАК Оплачено
		|		ПО ЭтапыРасчетов.ОбъектРасчетов = Оплачено.ОбъектРасчетов
		|
		|СГРУППИРОВАТЬ ПО
		|	ЭтапыРасчетов.Период,
		|	ЭтапыРасчетов.ОбъектРасчетов,
		|	Оплачено.КОплатеРасход
		|
		|ИМЕЮЩИЕ
		|	СУММА(РасчетыСКлиентами.КОплатеПриход) - ЕСТЬNULL(Оплачено.КОплатеРасход, 0) > 0
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	МИНИМУМ(РезультатРасчетов.Период) КАК ДатаАктуальности,
		|	РезультатРасчетов.ОбъектРасчетов КАК ОбъектРасчетов
		|ПОМЕСТИТЬ ДатыАктуальностиЗаказовКлиентов
		|ИЗ
		|	РезультатРасчетов КАК РезультатРасчетов
		|
		|СГРУППИРОВАТЬ ПО
		|	РезультатРасчетов.ОбъектРасчетов";
		
	Тексты = Новый Массив();
	Тексты.Добавить(ТекстЗапроса);
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	МИНИМУМ(ЗапасыИПотребности.ДатаСобытия) КАК МинимальнаяДатаОтгрузки,
		|	ЗапасыИПотребности.Заказ КАК ЗаказКлиента
		|ПОМЕСТИТЬ ДатыОтгрузкиЗаказовКлиентов
		|ИЗ
		|	РегистрНакопления.ЗапасыИПотребности.Остатки(, Заказ В(&МассивЗаказов)) КАК ЗапасыИПотребности
		|ГДЕ
		|	ЗапасыИПотребности.РезервироватьНаСкладеОстаток > 0
		|		ИЛИ ЗапасыИПотребности.РезервироватьПоМереПоступленияОстаток > 0
		|		ИЛИ ЗапасыИПотребности.ОтложитьРезервированиеОстаток > 0
		|		ИЛИ ЗапасыИПотребности.КОбеспечениюОстаток > 0
		|		ИЛИ ЗапасыИПотребности.НеОбеспечиватьОстаток > 0
		|СГРУППИРОВАТЬ ПО
		|	ЗапасыИПотребности.Заказ";
	
	Тексты.Добавить(ТекстЗапроса);
	
	Тексты.Добавить(
		"УНИЧТОЖИТЬ ЭтапыРасчетов;
		|УНИЧТОЖИТЬ РезультатРасчетов
		|");
	
	ТекстЗапроса = СтрСоединить(Тексты, ОбщегоНазначения.РазделительПакетаЗапросов());
	
	Возврат ТекстЗапроса;
	
КонецФункции

// Функция возвращает текст запроса для расчета состояний обеспечения заказов.
//
// Возвращаемое значение:
//	Строка - Текст запроса
//
Функция ТекстЗапросаДляРасчетаСостоянийОбеспеченияЗаказа()
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	Таблица.Ссылка КАК Ссылка,
		|	МАКСИМУМ(Таблица.ВариантОбеспечения = ЗНАЧЕНИЕ(Перечисление.ВариантыОбеспечения.НеТребуется)
		|				И Таблица.Номенклатура.ТипНоменклатуры В(
		|					ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар),
		|					ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))) КАК ЕстьКОбеспечению,
		|	МАКСИМУМ(Таблица.ВариантОбеспечения В(
		|				ЗНАЧЕНИЕ(Перечисление.ВариантыОбеспечения.КОбеспечению),
		|				ЗНАЧЕНИЕ(Перечисление.ВариантыОбеспечения.РезервироватьПоМереПоступления))) КАК ЕстьТребующиеРаспределенияЗапасов,
		|	
		|	МИНИМУМ(Таблица.ВариантОбеспечения = ЗНАЧЕНИЕ(Перечисление.ВариантыОбеспечения.Отгрузить)) КАК ВсеОтгрузить
		|ПОМЕСТИТЬ ВТОбеспечениеЗаказа
		|ИЗ
		|	Документ.ЗаказКлиента.Товары КАК Таблица
		|ГДЕ
		|	Таблица.Ссылка В(&МассивЗаказов)
		|		И НЕ Таблица.Отменено
		|
		|СГРУППИРОВАТЬ ПО
		|	Таблица.Ссылка
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	Таблица.Ссылка КАК Ссылка,
		|	МАКСИМУМ(Таблица.ВариантОбеспечения = ЗНАЧЕНИЕ(Перечисление.ВариантыОбеспечения.НеТребуется)
		|				И Таблица.Номенклатура.ТипНоменклатуры В(
		|					ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар),
		|					ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))) КАК ЕстьКОбеспечению,
		|	МАКСИМУМ(Таблица.ВариантОбеспечения В(
		|				ЗНАЧЕНИЕ(Перечисление.ВариантыОбеспечения.КОбеспечению),
		|				ЗНАЧЕНИЕ(Перечисление.ВариантыОбеспечения.РезервироватьПоМереПоступления))) КАК ЕстьТребующиеРаспределенияЗапасов,
		|	
		|	МИНИМУМ(Таблица.ВариантОбеспечения = ЗНАЧЕНИЕ(Перечисление.ВариантыОбеспечения.Отгрузить)) КАК ВсеОтгрузить
		|ИЗ
		|	Документ.ЗаявкаНаВозвратТоваровОтКлиента.ЗаменяющиеТовары КАК Таблица
		|ГДЕ
		|	Таблица.Ссылка В(&МассивЗаказов)
		|		И НЕ Таблица.Отменено
		|
		|СГРУППИРОВАТЬ ПО
		|	Таблица.Ссылка
		|";
	
	Возврат ТекстЗапроса
	
КонецФункции


// Функция возвращает текст запроса для расчета расхождений ордер-накладная.
//
// Возвращаемое значение:
//	Строка - Текст запроса
//
Функция ТекстЗапросаДляРасчетаРасхожденийОрдерНакладная()
	
	ТекстЗапроса = ТекстЗапросаДляРасчетаЕстьОрдер() + "
		|ВЫБРАТЬ
		|	ТоварыКОтгрузке.ДокументОтгрузки КАК ЗаказКлиента,
		|	МАКСИМУМ(ВЫБОР
		|		КОГДА ТоварыКОтгрузке.КОформлениюПриход > 0 
		|			И ТоварыКОтгрузке.КОформлениюРасход <> (ТоварыКОтгрузке.СобраноПриход + ТоварыКОтгрузке.КОтгрузкеРасход) ТОГДА
		|			ИСТИНА
		|		ИНАЧЕ
		|			ЛОЖЬ
		|	КОНЕЦ) КАК ЕстьРасхожденияОрдерНакладная,
		|	МАКСИМУМ(ВЫБОР
		|		КОГДА &МенеджерСоздаетОрдера
		|			И (ТоварыКОтгрузке.Склад.ИспользоватьОрдернуюСхемуПриОтгрузке
		|				И ТоварыКОтгрузке.Склад.ДатаНачалаОрдернойСхемыПриОтгрузке <= ЕСТЬNULL(РеквизитыРаспоряжения.ДатаДокументаИБ, ДАТАВРЕМЯ(1,1,1)))
		|			И ВТЕстьОрдер.ЕстьОрдер ЕСТЬ NULL ТОГДА
		|			ИСТИНА
		|		ИНАЧЕ
		|			ЛОЖЬ
		|	КОНЕЦ) КАК ТребуетсяОрдер
		|ПОМЕСТИТЬ ВТРасхожденияОрдерНакладная
		|ИЗ
		|	РегистрНакопления.ТоварыКОтгрузке.ОстаткиИОбороты(,,,,ДокументОтгрузки В (&МассивЗаказов)) КАК ТоварыКОтгрузке
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТЕстьОрдер КАК ВТЕстьОрдер
		|			ПО ТоварыКОтгрузке.ДокументОтгрузки = ВТЕстьОрдер.ЗаказКлиента
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РеестрДокументов КАК РеквизитыРаспоряжения
		|			ПО ТоварыКОтгрузке.ДокументОтгрузки = РеквизитыРаспоряжения.Ссылка
		|				И НЕ РеквизитыРаспоряжения.ДополнительнаяЗапись
		|
		|СГРУППИРОВАТЬ ПО
		|	ТоварыКОтгрузке.ДокументОтгрузки
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ЗаказКлиента
		|";
	
	Возврат ТекстЗапроса
	
КонецФункции

// Функция возвращает текст запроса для поиска расходных ордеров.
//
// Возвращаемое значение:
//	Строка - Текст запроса
//
Функция ТекстЗапросаДляРасчетаЕстьОрдер()
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ТоварыКОтгрузке.ДокументОтгрузки КАК ЗаказКлиента,
		|	ИСТИНА КАК ЕстьОрдер
		|ПОМЕСТИТЬ ВТЕстьОрдер
		|ИЗ
		|	РегистрНакопления.ТоварыКОтгрузке.ОстаткиИОбороты(, , Регистратор, , ДокументОтгрузки В (&МассивЗаказов)) КАК ТоварыКОтгрузке
		|ГДЕ
		|	ТоварыКОтгрузке.Регистратор ССЫЛКА Документ.РасходныйОрдерНаТовары
		|СГРУППИРОВАТЬ ПО
		|	ТоварыКОтгрузке.ДокументОтгрузки
		|ИНДЕКСИРОВАТЬ ПО
		|	ЗаказКлиента
		|;
		|";
	
	Возврат ТекстЗапроса
	
КонецФункции

// Функция возвращает таблицу значений с состояниями документов.
//
//	Параметры:
//		МассивСсылок - Массив - (состоящий из ДокументСсылка) ссылки на документы, по которым
//					нужно рассчитать состояние. В модуле менеджера документов должна быть определена функция
//					ТекстЗапросаДляРасчетаДатыАктуальностиСостоянийЗаказов(), которая возвращает текст запроса по датам актуальности и
//					ТекстЗапросаДляРасчетаСостоянийЗаказов(), которая возвращает текст запроса по состояниям заказов.
//	Возвращаемое значение:
//		ТаблицаЗначений:
//			Заказ - ДокументСсылка
//			Состояние - ПеречислениеСсылка.СостоянияЗаказовКлиентов, ПеречислениеСсылка.СостоянияЗаявокНаВозвратТоваровОтКлиента
//			ДатаСобытия - Дата
//			СуммаОплаты - Число
//			ПроцентОплаты - Число
//			СуммаОтгрузки - Число
//			ПроцентОтгрузки - Число
//			СуммаДолга - Число
//			ПроцентДолга - Число
//			ЕстьРасхожденияОрдерНакладная - Булево
//
Функция ТаблицаПредыдущихСостоянийЗаказов(МассивСсылок)
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	СостоянияЗаказовКлиентов.Заказ КАК Заказ,
	|	СостоянияЗаказовКлиентов.Состояние КАК Состояние,
	|	СостоянияЗаказовКлиентов.ДатаСобытия КАК ДатаСобытия,
	|	СостоянияЗаказовКлиентов.СуммаОплаты КАК СуммаОплаты,
	|	СостоянияЗаказовКлиентов.ПроцентОплаты КАК ПроцентОплаты,
	|	СостоянияЗаказовКлиентов.СуммаОтгрузки КАК СуммаОтгрузки,
	|	СостоянияЗаказовКлиентов.ПроцентОтгрузки КАК ПроцентОтгрузки,
	|	СостоянияЗаказовКлиентов.СуммаДолга КАК СуммаДолга,
	|	СостоянияЗаказовКлиентов.ПроцентДолга КАК ПроцентДолга,
	|	СостоянияЗаказовКлиентов.ЕстьРасхожденияОрдерНакладная КАК ЕстьРасхожденияОрдерНакладная
	|ИЗ
	|	РегистрСведений.СостоянияЗаказовКлиентов КАК СостоянияЗаказовКлиентов
	|ГДЕ
	|	СостоянияЗаказовКлиентов.Заказ В(&МассивСсылок)");
	
	Запрос.УстановитьПараметр("МассивСсылок", МассивСсылок);
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

Функция ТекстЗапросаЧастичноВНаличии()
	
	ТекстЗапроса =
		"
		|ВЫБРАТЬ
		|	Заказы.Ссылка КАК Ссылка
		|ПОМЕСТИТЬ ВТЧастичноВНаличии
		|ИЗ
		|	ВТОбеспечениеЗаказа КАК Заказы
		|ГДЕ
		|	Заказы.ЕстьТребующиеРаспределенияЗапасов
		|	И (ИСТИНА В(
		|		ВЫБРАТЬ ПЕРВЫЕ 1
		|			ИСТИНА КАК ЕстьЗаписи
		|		ИЗ
		|			РегистрСведений.РаспределениеЗапасов КАК Сведения
		|		ГДЕ
		|			Сведения.ЗаказНаОтгрузку = Заказы.Ссылка
		|				И Сведения.Состояние В(
		|					ЗНАЧЕНИЕ(Перечисление.РаспределениеЗапасовСостояния.ОбеспеченКДате),
		|					ЗНАЧЕНИЕ(Перечисление.РаспределениеЗапасовСостояния.ОжидаетсяПоНеподтвержденномуЗаказу),
		|					ЗНАЧЕНИЕ(Перечисление.РаспределениеЗапасовСостояния.Обеспечить)))
		// документ не был проведен
		|		ИЛИ НЕ ИСТИНА В(
		|				ВЫБРАТЬ ПЕРВЫЕ 1
		|					ИСТИНА КАК ЕстьЗаписи
		|				ИЗ
		|					РегистрСведений.РаспределениеЗапасов КАК Сведения
		|				ГДЕ
		|					Сведения.ЗаказНаОтгрузку = Заказы.Ссылка))
		|";
	
	Возврат ТекстЗапроса
	
КонецФункции

// Функция возвращает текст запроса для расчета допустимых отклонения мерных товаров.
Функция ТекстЗапросаДопустимыхОтклонения(СоотвествиеТипов)
	
	Если НЕ СоотвествиеТипов["Документ.ЗаказКлиента"] = Неопределено
		ИЛИ НЕ СоотвествиеТипов["Документ.ЗаявкаНаВозвратТоваровОтКлиента"] = Неопределено
		Тогда
		
		Возврат 
		"ВЫБРАТЬ
		|	ОстаткиИОбороты.Распоряжение КАК ЗаказКлиента,
		|	ОстаткиИОбороты.Номенклатура КАК Номенклатура,
		|	ОстаткиИОбороты.Характеристика КАК Характеристика,
		|	ОстаткиИОбороты.Склад КАК Склад,
		|	ОстаткиИОбороты.Серия КАК Серия,
		|	СУММА(ОстаткиИОбороты.КОформлениюОборот) КАК КОформлениюКонечныйОстаток,
		|	СУММА(ВЫБОР
		|			КОГДА ОстаткиИОбороты.ВидДвиженияРегистра = ЗНАЧЕНИЕ(Перечисление.ВидыДвиженияНакопления.Приход)
		|				ТОГДА ОстаткиИОбороты.КОформлениюОборот
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК КОформлениюПриход,
		|	СУММА(ОстаткиИОбороты.ЗаказаноОборот) КАК ЗаказаноКонечныйОстаток,
		|	СУММА(ОстаткиИОбороты.СуммаОборот) КАК СуммаКонечныйОстаток,
		|	СУММА(ВЫБОР
		|			КОГДА ОстаткиИОбороты.ВидДвиженияРегистра = ЗНАЧЕНИЕ(Перечисление.ВидыДвиженияНакопления.Приход)
		|				ТОГДА ОстаткиИОбороты.СуммаОборот
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК СуммаПриход,
		|	СУММА(ВЫБОР
		|			КОГДА ОстаткиИОбороты.ВидДвиженияРегистра = ЗНАЧЕНИЕ(Перечисление.ВидыДвиженияНакопления.Расход)
		|				ТОГДА -ОстаткиИОбороты.СуммаОборот
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК СуммаРасход
		|ПОМЕСТИТЬ ВТОстаткиИОбороты
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаОтгрузку.Обороты(&НачПериодЗаказыКлиентов, &КонПериодЗаказыКлиентов, 
		|				, Распоряжение В (&МассивЗаказов)) КАК ОстаткиИОбороты
		|
		|СГРУППИРОВАТЬ ПО
		|	ОстаткиИОбороты.Распоряжение,
		|	ОстаткиИОбороты.Номенклатура,
		|	ОстаткиИОбороты.Характеристика,
		|	ОстаткиИОбороты.Склад,
		|	ОстаткиИОбороты.Серия
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЗаказыОстатки.ЗаказКлиента КАК ЗаказКлиента,
		|	СУММА(ЗаказыОстатки.КОформлениюКонечныйОстаток) КАК КОформлениюКонечныйОстаток,
		|	СУММА(ЗаказыОстатки.ЗаказаноКонечныйОстаток) КАК ЗаказаноКонечныйОстаток,
		|	СУММА(ЗаказыОстатки.СуммаКонечныйОстаток) КАК СуммаКонечныйОстаток,
		|	СУММА(ЗаказыОстатки.СуммаРасходСУчетомМерныхТоваров) КАК СуммаРасходСУчетомМерныхТоваров,
		|	СУММА(ЗаказыОстатки.СуммаРасход) КАК СуммаРасход
		|ПОМЕСТИТЬ ВТЗаказыКлиентовОстатки
		|ИЗ
		|	(ВЫБРАТЬ
		|		ЗаказыКлиентовОстатки.ЗаказКлиента КАК ЗаказКлиента,
		|		ЗаказыКлиентовОстатки.Номенклатура КАК Номенклатура,
		|		ЗаказыКлиентовОстатки.Характеристика КАК Характеристика,
		|		ЗаказыКлиентовОстатки.Склад КАК Склад,
		|		ЗаказыКлиентовОстатки.Серия КАК Серия,
		|		ВЫБОР
		|			КОГДА ЗаказыКлиентовОстатки.Номенклатура.ЕдиницаИзмерения.ТипИзмеряемойВеличины В (&МерныеТипыВеличин)
		|				ТОГДА ВЫБОР
		|						КОГДА ЗаказыКлиентовОстатки.КОформлениюКонечныйОстаток <= ЗаказыКлиентовОстатки.КОформлениюПриход * (&ДопустимоеОтклонениеОтгрузкиПриемкиМерныхТоваров / 100)
		|								И ЗаказыКлиентовОстатки.КОформлениюКонечныйОстаток >= -(ЗаказыКлиентовОстатки.КОформлениюПриход * (&ДопустимоеОтклонениеОтгрузкиПриемкиМерныхТоваров / 100))
		|							ТОГДА 0
		|						ИНАЧЕ ЕСТЬNULL(ЗаказыКлиентовОстатки.КОформлениюКонечныйОстаток, 0)
		|					КОНЕЦ
		|			ИНАЧЕ ЕСТЬNULL(ЗаказыКлиентовОстатки.КОформлениюКонечныйОстаток, 0)
		|		КОНЕЦ КАК КОформлениюКонечныйОстаток,
		|		ВЫБОР
		|			КОГДА ЗаказыКлиентовОстатки.Номенклатура.ЕдиницаИзмерения.ТипИзмеряемойВеличины В (&МерныеТипыВеличин)
		|				ТОГДА ВЫБОР
		|						КОГДА ЗаказыКлиентовОстатки.ЗаказаноКонечныйОстаток <= ЗаказыКлиентовОстатки.КОформлениюПриход * (&ДопустимоеОтклонениеОтгрузкиПриемкиМерныхТоваров / 100)
		|								И ЗаказыКлиентовОстатки.ЗаказаноКонечныйОстаток >= -(ЗаказыКлиентовОстатки.КОформлениюПриход * (&ДопустимоеОтклонениеОтгрузкиПриемкиМерныхТоваров / 100))
		|							ТОГДА 0
		|						ИНАЧЕ ЕСТЬNULL(ЗаказыКлиентовОстатки.ЗаказаноКонечныйОстаток, 0)
		|					КОНЕЦ
		|			ИНАЧЕ ЕСТЬNULL(ЗаказыКлиентовОстатки.ЗаказаноКонечныйОстаток, 0)
		|		КОНЕЦ КАК ЗаказаноКонечныйОстаток,
		|		ЕСТЬNULL(ЗаказыКлиентовОстатки.СуммаКонечныйОстаток, 0) КАК СуммаКонечныйОстаток,
		|		ВЫБОР
		|			КОГДА ЗаказыКлиентовОстатки.Номенклатура.ЕдиницаИзмерения.ТипИзмеряемойВеличины В (&МерныеТипыВеличин)
		|				ТОГДА ВЫБОР
		|						КОГДА ЗаказыКлиентовОстатки.СуммаКонечныйОстаток <= ЗаказыКлиентовОстатки.СуммаПриход * (&ДопустимоеОтклонениеОтгрузкиПриемкиМерныхТоваров / 100)
		|								И ЗаказыКлиентовОстатки.СуммаКонечныйОстаток >= -ЗаказыКлиентовОстатки.СуммаПриход * (&ДопустимоеОтклонениеОтгрузкиПриемкиМерныхТоваров / 100)
		|							ТОГДА ЗаказыКлиентовОстатки.СуммаПриход
		|						ИНАЧЕ ЗаказыКлиентовОстатки.СуммаРасход
		|					КОНЕЦ
		|			ИНАЧЕ ЗаказыКлиентовОстатки.СуммаРасход
		|		КОНЕЦ КАК СуммаРасходСУчетомМерныхТоваров,
		|		ЕСТЬNULL(ЗаказыКлиентовОстатки.СуммаРасход, 0) КАК СуммаРасход
		|	ИЗ
		|		ВТОстаткиИОбороты КАК ЗаказыКлиентовОстатки) КАК ЗаказыОстатки
		|
		|СГРУППИРОВАТЬ ПО
		|	ЗаказыОстатки.ЗаказКлиента
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТоварыОстатки.ЗаказКлиента КАК ЗаказКлиента,
		|	СУММА(ТоварыОстатки.КОтгрузкеОстаток) КАК КОтгрузкеОстаток
		|ПОМЕСТИТЬ ВТТоварыКОтгрузкеОстатки
		|ИЗ
		|	(ВЫБРАТЬ
		|		ТоварыКОтгрузкеОстатки.ДокументОтгрузки КАК ЗаказКлиента,
		|		ТоварыКОтгрузкеОстатки.Номенклатура КАК Номенклатура,
		|		ТоварыКОтгрузкеОстатки.Характеристика КАК Характеристика,
		|		ТоварыКОтгрузкеОстатки.Склад КАК Склад,
		|		ТоварыКОтгрузкеОстатки.Серия КАК Серия,
		|		ВЫБОР
		|			КОГДА ТоварыКОтгрузкеОстатки.Номенклатура.ЕдиницаИзмерения.ТипИзмеряемойВеличины В (&МерныеТипыВеличин)
		|				ТОГДА ВЫБОР
		|						КОГДА ТоварыКОтгрузкеОстатки.КОтгрузкеКонечныйОстаток <= ТоварыКОтгрузкеОстатки.КОтгрузкеПриход * (&ДопустимоеОтклонениеОтгрузкиПриемкиМерныхТоваров / 100)
		|								И ТоварыКОтгрузкеОстатки.КОтгрузкеКонечныйОстаток >= -(ТоварыКОтгрузкеОстатки.КОтгрузкеПриход * (&ДопустимоеОтклонениеОтгрузкиПриемкиМерныхТоваров / 100))
		|							ТОГДА 0
		|						ИНАЧЕ ЕСТЬNULL(ТоварыКОтгрузкеОстатки.КОтгрузкеКонечныйОстаток, 0)
		|					КОНЕЦ
		|			ИНАЧЕ ЕСТЬNULL(ТоварыКОтгрузкеОстатки.КОтгрузкеКонечныйОстаток, 0)
		|		КОНЕЦ КАК КОтгрузкеОстаток
		|	ИЗ
		|		РегистрНакопления.ТоварыКОтгрузке.ОстаткиИОбороты(&НачПериодТоварыКОтгрузке, &КонПериодТоварыКОтгрузке, , , ДокументОтгрузки В (&МассивЗаказов)) КАК ТоварыКОтгрузкеОстатки) КАК ТоварыОстатки
		|
		|СГРУППИРОВАТЬ ПО
		|	ТоварыОстатки.ЗаказКлиента
		|
		|////////////////////////////////////////////////////////////////////////////////";

	Иначе
		
		Возврат "";
		
	КонецЕсли;
	
	
КонецФункции

Функция ТекстЗапросаРасчетов()
	
	Возврат "
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетовНакладная,
	|	ВтОбъектыРасчетов.ОбъектРасчетов КАК ОбъектРасчетовЗаказ,
	|	ВтОбъектыРасчетов.ЗаказКлиента КАК ЗаказКлиента,
	|	СУММА(ВЫБОР
	|			КОГДА ОбъектыРасчетов.Сумма = 0
	|				ТОГДА 0
	|			ИНАЧЕ РасчетыСКлиентамиОбороты.КОтгрузкеПриход / ОбъектыРасчетов.Сумма
	|		КОНЕЦ) КАК ДоляЗаказа
	|ПОМЕСТИТЬ ВтСвязьЗаказовНакладных
	|ИЗ
	|	РегистрНакопления.РасчетыСКлиентами.Обороты(, , Регистратор, ОбъектРасчетов В (ВЫБРАТЬ Т.ОбъектРасчетов ИЗ ВтОбъектыРасчетов КАК Т)) КАК РасчетыСКлиентамиОбороты
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
	|		ПО РасчетыСКлиентамиОбороты.Регистратор = ОбъектыРасчетов.Объект
	|			И НЕ ОбъектыРасчетов.ПометкаУдаления
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтОбъектыРасчетов КАК ВтОбъектыРасчетов
	|		ПО РасчетыСКлиентамиОбороты.ОбъектРасчетов = ВтОбъектыРасчетов.ОбъектРасчетов
	|
	|СГРУППИРОВАТЬ ПО
	|	ОбъектыРасчетов.Ссылка,
	|	ВтОбъектыРасчетов.ОбъектРасчетов,
	|	ВтОбъектыРасчетов.ЗаказКлиента
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДанныеПоРасчетам.ОбъектРасчетов КАК ОбъектРасчетов,
	|	ЕСТЬNULL(СУММА(ДанныеПоРасчетам.ОплатаФакт), 0) КАК ОплатаФакт,
	|	ЕСТЬNULL(СУММА(ДанныеПоРасчетам.КОплате), 0) КАК КОплатеКонечныйОстаток
	|ПОМЕСТИТЬ ВтДанныеПоРасчетамСКлиентами
	|ИЗ
	|	(ВЫБРАТЬ
	|		РасчетыСКлиентами.ОбъектРасчетов КАК ОбъектРасчетов,
	|		ВЫБОР
	|			КОГДА РасчетыСКлиентами.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносАванса)
	|				ИЛИ РасчетыСКлиентами.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РезервированиеАвансаКлиента) 
	|				ТОГДА ВЫБОР
	|					КОГДА РасчетыСКлиентами.КорОбъектРасчетов = ЗНАЧЕНИЕ(Справочник.ОбъектыРасчетов.ПустаяСсылка)
	|						ТОГДА ВЫБОР 
	|								КОГДА РасчетыСКлиентами.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|									ТОГДА -РасчетыСКлиентами.Сумма
	|								ИНАЧЕ РасчетыСКлиентами.Сумма
	|							КОНЕЦ
	|					ИНАЧЕ РасчетыСКлиентами.Сумма
	|				КОНЕЦ
	|			КОГДА РасчетыСКлиентами.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносПлатежаМеждуФилиалами)
	|				И РасчетыСКлиентами.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|			ТОГДА 0
	|			ИНАЧЕ ВЫБОР
	|					КОГДА РасчетыСКлиентами.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|						ИЛИ РасчетыСКлиентами.Регистратор ССЫЛКА Документ.КорректировкаРеализации
	|					ТОГДА 0
	|					ИНАЧЕ РасчетыСКлиентами.Сумма
	|				КОНЕЦ
	|		КОНЕЦ КАК ОплатаФакт,
	|		ВЫБОР
	|			КОГДА РасчетыСКлиентами.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА РасчетыСКлиентами.КОплате
	|			ИНАЧЕ -РасчетыСКлиентами.КОплате
	|		КОНЕЦ КАК КОплате
	|	ИЗ
	|		РегистрНакопления.РасчетыСКлиентами КАК РасчетыСКлиентами
	|	ГДЕ
	|		РасчетыСКлиентами.ОбъектРасчетов.Объект В (&МассивЗаказов)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ВтСвязьЗаказовНакладных.ОбъектРасчетовЗаказ КАК ОбъектРасчетов,
	|		0 КАК ОплатаФакт,
	|		ВЫБОР
	|			КОГДА РасчетыСКлиентами.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА РасчетыСКлиентами.КОплате
	|			ИНАЧЕ -РасчетыСКлиентами.КОплате
	|		КОНЕЦ КАК КОплате
	|	ИЗ
	|		РегистрНакопления.РасчетыСКлиентами КАК РасчетыСКлиентами
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтСвязьЗаказовНакладных КАК ВтСвязьЗаказовНакладных
	|			ПО РасчетыСКлиентами.ОбъектРасчетов = ВтСвязьЗаказовНакладных.ОбъектРасчетовНакладная
	|	ГДЕ
	|		РасчетыСКлиентами.ОбъектРасчетов В
	|				(ВЫБРАТЬ
	|					Т.ОбъектРасчетовНакладная
	|				ИЗ
	|					ВтСвязьЗаказовНакладных КАК Т)) КАК ДанныеПоРасчетам
	|
	|СГРУППИРОВАТЬ ПО
	|	ДанныеПоРасчетам.ОбъектРасчетов
	|";
	
КонецФункции

Функция ТекстЗапросаОстатковРасчетов()
	
	Возврат "
	|ВЫБРАТЬ
	|		РасчетыСКлиентами.ОбъектРасчетов КАК ОбъектРасчетов,
	|		ЕСТЬNULL(СУММА(ВЫБОР КОГДА РасчетыСКлиентами.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				И РасчетыСКлиентами.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиенту)
	|				И РасчетыСКлиентами.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности)
	|			ТОГДА РасчетыСКлиентами.КОплате
	|			ИНАЧЕ 0
	|		КОНЕЦ), 0) КАК КОплатеРасход,
	|		ЕСТЬNULL(СУММА(ВЫБОР КОГДА РасчетыСКлиентами.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|			ТОГДА - РасчетыСКлиентами.КОплате
	|			ИНАЧЕ РасчетыСКлиентами.КОплате
	|		КОНЕЦ), 0) КАК КОплатеКонечныйОстаток,
	|		ЕСТЬNULL(СУММА(ВЫБОР КОГДА РасчетыСКлиентами.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА РасчетыСКлиентами.КОтгрузке
	|			ИНАЧЕ 0
	|		КОНЕЦ), 0) КАК КОтгрузкеПриход,
	|		ЕСТЬNULL(СУММА(ВЫБОР КОГДА РасчетыСКлиентами.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|			ТОГДА - РасчетыСКлиентами.Сумма
	|			ИНАЧЕ РасчетыСКлиентами.Сумма
	|		КОНЕЦ), 0) КАК СуммаКонечныйОстаток
	|ПОМЕСТИТЬ ВтРасчетыСКлиентамиОстатки
	|	ИЗ
	|		РегистрНакопления.РасчетыСКлиентами КАК РасчетыСКлиентами
	|	ГДЕ
	|		РасчетыСКлиентами.ОбъектРасчетов В (ВЫБРАТЬ Т.ОбъектРасчетов ИЗ ВтОбъектыРасчетов КАК Т)
	|		И РасчетыСКлиентами.АналитикаУчетаПоПартнерам.Организация = ОбъектРасчетов.Организация
	|		И РасчетыСКлиентами.Активность
	|СГРУППИРОВАТЬ ПО
	|	РасчетыСКлиентами.ОбъектРасчетов
	|";
	
КонецФункции

Функция ТекстЗапросаСостояниеВзаиморасчетов()
	
	ТекстЗапроса = "
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ОбъектыРасчетов.Ссылка КАК Ссылка,
		|	ОбъектыРасчетов.Объект КАК Объект,
		|	ОбъектыРасчетов.Сумма КАК Сумма,
		|	ОбъектыРасчетов.СуммаВзаиморасчетов КАК СуммаВзаиморасчетов
		|ПОМЕСТИТЬ ВтЗаказы
		|ИЗ
		|	Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
		|ГДЕ
		|	ОбъектыРасчетов.Объект В(&МассивЗаказов)
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Ссылка
		|;
		|
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	РасчетыСКлиентамиОбороты.Регистратор КАК Регистратор,
		|	РасчетыСКлиентамиОбороты.ОбъектРасчетов КАК ОбъектРасчетов,
		|	РасчетыСКлиентамиОбороты.КОтгрузкеПриход КАК КОтгрузкеПриход
		|ПОМЕСТИТЬ ВтРасчетыСКлиентами
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентами.Обороты(
		|			,
		|			,
		|			Регистратор,
		|			ОбъектРасчетов В
		|				(ВЫБРАТЬ
		|					ВтЗаказы.Ссылка
		|				ИЗ
		|					ВтЗаказы)) КАК РасчетыСКлиентамиОбороты
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор,
		|	ОбъектРасчетов
		|;
		|
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ОбъектыРасчетов.Ссылка                КАК ОбъектРасчетовНакладная,
		|	ОбъектыРасчетовЗаказ.Ссылка           КАК ОбъектРасчетовЗаказ,
		|	ОбъектыРасчетовЗаказ.Объект           КАК Заказ,
		|	СУММА(ВЫРАЗИТЬ(ВЫБОР
		|			КОГДА ОбъектыРасчетов.СуммаВзаиморасчетов = 0
		|				ТОГДА ВЫБОР
		|						КОГДА ОбъектыРасчетов.Сумма = 0
		|							ТОГДА 0
		|						ИНАЧЕ РасчетыСКлиентамиОбороты.КОтгрузкеПриход / ОбъектыРасчетов.Сумма
		|					КОНЕЦ
		|			ИНАЧЕ РасчетыСКлиентамиОбороты.КОтгрузкеПриход / ОбъектыРасчетов.СуммаВзаиморасчетов
		|		КОНЕЦ КАК ЧИСЛО(20,10))) КАК ДоляЗаказа,
		|	МАКСИМУМ(ВЫБОР
		|			КОГДА ОбъектыРасчетовЗаказ.СуммаВзаиморасчетов = 0
		|				ТОГДА ОбъектыРасчетовЗаказ.Сумма
		|			ИНАЧЕ ОбъектыРасчетовЗаказ.СуммаВзаиморасчетов
		|		КОНЕЦ) КАК СуммаЗаказа
		|ПОМЕСТИТЬ ВтСвязьЗаказовНакладных
		|ИЗ
		|	ВтРасчетыСКлиентами КАК РасчетыСКлиентамиОбороты
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтЗаказы КАК ОбъектыРасчетовЗаказ
		|		ПО РасчетыСКлиентамиОбороты.ОбъектРасчетов = ОбъектыРасчетовЗаказ.Ссылка
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
		|		ПО РасчетыСКлиентамиОбороты.Регистратор = ОбъектыРасчетов.Объект
		|		И НЕ ОбъектыРасчетов.ПометкаУдаления
		|ГДЕ
		|	ОбъектыРасчетовЗаказ.Объект В (&МассивЗаказов)
		|
		|СГРУППИРОВАТЬ ПО
		|	ОбъектыРасчетов.Ссылка,
		|	ОбъектыРасчетовЗаказ.Ссылка,
		|	ОбъектыРасчетовЗаказ.Объект
		|ИНДЕКСИРОВАТЬ ПО
		|	ОбъектРасчетовНакладная
		|
		|;
		|
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Расчеты.Заказ                                  КАК Заказ,
		|	ЕСТЬNULL(СУММА(Расчеты.СуммаОплат), 0)         КАК СуммаОплаты,
		|	ЕСТЬNULL(СУММА(Расчеты.СуммаОплатПоЗаказу), 0) КАК ОплаченоПоЗаказу,
		|	ВЫБОР КОГДА ЕСТЬNULL(МАКСИМУМ(Расчеты.СуммаПервоначальныхВзаиморасчетов) - СУММА(Расчеты.СуммаОплат) + СУММА(Расчеты.СуммаСписаний), 0) <= 0
		|		ТОГДА ЕСТЬNULL(СУММА(Расчеты.СуммаЗадолженности), 0)
		|		ИНАЧЕ ЕСТЬNULL(МАКСИМУМ(Расчеты.СуммаПервоначальныхВзаиморасчетов) - СУММА(Расчеты.СуммаОплат) + СУММА(Расчеты.СуммаСписаний), 0)
		|	КОНЕЦ                                          КАК ОсталосьОплатить,
		|	ЕСТЬNULL(СУММА(Расчеты.СуммаОтгрузок), 0)      КАК СуммаОтгрузки,
		|	ЕСТЬNULL(СУММА(Расчеты.СуммаЗадолженности), 0) КАК СуммаДолга,
		|	ВЫБОР КОГДА ЕСТЬNULL(СУММА(Расчеты.СуммаОплат), 0) = 0
		|		ИЛИ ЕСТЬNULL(МАКСИМУМ(Расчеты.СуммаПервоначальныхВзаиморасчетов), 0) = 0
		|			ТОГДА 0
		|		ИНАЧЕ ВЫРАЗИТЬ(СУММА(Расчеты.СуммаОплат) * 100 / МАКСИМУМ(Расчеты.СуммаПервоначальныхВзаиморасчетов) КАК ЧИСЛО(20, 10))
		|	КОНЕЦ                                          КАК ПроцентОплаты,
		|	ВЫБОР КОГДА ЕСТЬNULL(СУММА(Расчеты.СуммаОтгрузок), 0) = 0
		|		ИЛИ ЕСТЬNULL(МАКСИМУМ(Расчеты.СуммаПервоначальныхВзаиморасчетов), 0) = 0
		|			ТОГДА 0
		|		ИНАЧЕ ВЫРАЗИТЬ(СУММА(Расчеты.СуммаОтгрузок) * 100 / МАКСИМУМ(Расчеты.СуммаПервоначальныхВзаиморасчетов) КАК ЧИСЛО(20, 10))
		|	КОНЕЦ                                          КАК ПроцентОтгрузки,
		|	ВЫБОР КОГДА ЕСТЬNULL(СУММА(Расчеты.СуммаЗадолженности), 0) = 0
		|		ИЛИ ЕСТЬNULL(МАКСИМУМ(Расчеты.СуммаПервоначальныхВзаиморасчетов), 0) = 0
		|			ТОГДА 0 
		|		КОГДА ЕСТЬNULL(СУММА(Расчеты.СуммаЗадолженности), 0) > 0
		|			ТОГДА ВЫРАЗИТЬ(СУММА(Расчеты.СуммаЗадолженности) * 100 / МАКСИМУМ(Расчеты.СуммаПервоначальныхВзаиморасчетов) КАК ЧИСЛО(20, 10))
		|		ИНАЧЕ - ВЫРАЗИТЬ(СУММА(Расчеты.СуммаЗадолженности) * 100 / МАКСИМУМ(Расчеты.СуммаПервоначальныхВзаиморасчетов) КАК ЧИСЛО(20, 10))
		|	КОНЕЦ                                          КАК ПроцентДолга
		|ПОМЕСТИТЬ ВтСостояниеВзаиморасчетов
		|ИЗ (ВЫБРАТЬ
		|		ОбъектыРасчетов.Объект        КАК Заказ,
		|		&ШаблонПоляОплачено           КАК СуммаОплат,
		|		&ШаблонПоляОплачено           КАК СуммаОплатПоЗаказу,
		|		&ШаблонПоляСписание           КАК СуммаСписаний,
		|		&ШаблонПоляОтгружено          КАК СуммаОтгрузок,
		|		ВЫБОР КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ТОГДА РасчетыПоСрокам.Долг - РасчетыПоСрокам.Предоплата
		|			ИНАЧЕ РасчетыПоСрокам.Предоплата - РасчетыПоСрокам.Долг
		|		КОНЕЦ                         КАК СуммаЗадолженности,
		|		ВЫБОР КОГДА ОбъектыРасчетов.СуммаВзаиморасчетов = 0
		|			ТОГДА ОбъектыРасчетов.Сумма
		|			ИНАЧЕ ОбъектыРасчетов.СуммаВзаиморасчетов
		|		КОНЕЦ                         КАК СуммаПервоначальныхВзаиморасчетов
		|	ИЗ
		|			РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК РасчетыПоСрокам
		|				ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
		|				ПО РасчетыПоСрокам.ОбъектРасчетов = ОбъектыРасчетов.Ссылка
		|		ГДЕ
		|			ОбъектыРасчетов.Объект В (&МассивЗаказов)
		|			И РасчетыПоСрокам.АналитикаУчетаПоПартнерам.Организация = ОбъектыРасчетов.Организация
		|			И РасчетыПоСрокам.Активность
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		ВтСвязьЗаказовНакладных.Заказ                                                        КАК Заказ,
		|		ВЫРАЗИТЬ((&ШаблонПоляОплачено) * ВтСвязьЗаказовНакладных.ДоляЗаказа КАК ЧИСЛО(31,2)) КАК СуммаОплат,
		|		ВЫРАЗИТЬ((&ШаблонПоляОплачено) * ВтСвязьЗаказовНакладных.ДоляЗаказа КАК ЧИСЛО(31,2)) КАК СуммаОплатПоЗаказу,
		|		ВЫРАЗИТЬ((&ШаблонПоляСписание) * ВтСвязьЗаказовНакладных.ДоляЗаказа КАК ЧИСЛО(31,2))   КАК СуммаСписаний,
		|		ВЫРАЗИТЬ((&ШаблонПоляОтгружено) * ВтСвязьЗаказовНакладных.ДоляЗаказа КАК ЧИСЛО(31,2))  КАК СуммаОтгрузок,
		|		ВЫРАЗИТЬ(ВЫБОР КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ТОГДА РасчетыПоСрокам.Долг - РасчетыПоСрокам.Предоплата
		|			ИНАЧЕ РасчетыПоСрокам.Предоплата - РасчетыПоСрокам.Долг
		|		КОНЕЦ * ВтСвязьЗаказовНакладных.ДоляЗаказа КАК ЧИСЛО(31,2))                          КАК СуммаЗадолженности,
		|		ВтСвязьЗаказовНакладных.СуммаЗаказа                                                  КАК СуммаПервоначальныхВзаиморасчетов
		|	ИЗ
		|		РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК РасчетыПоСрокам
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтСвязьЗаказовНакладных КАК ВтСвязьЗаказовНакладных
		|			ПО РасчетыПоСрокам.ОбъектРасчетов = ВтСвязьЗаказовНакладных.ОбъектРасчетовНакладная 
		|	ГДЕ
		|		РасчетыПоСрокам.ОбъектРасчетов В (ВЫБРАТЬ
		|							Т.ОбъектРасчетовНакладная
		|						ИЗ
		|							ВтСвязьЗаказовНакладных КАК Т)
		|		И РасчетыПоСрокам.АналитикаУчетаПоПартнерам.Организация = РасчетыПоСрокам.ОбъектРасчетов.Организация
		|		И РасчетыПоСрокам.Активность
		|	) КАК Расчеты
		|СГРУППИРОВАТЬ ПО
		|	Расчеты.Заказ
		|ИНДЕКСИРОВАТЬ ПО
		|	Заказ
		|";
	
	ШаблонПоляСуммаКорректировок = "
		|ВЫБОР 
		|	КОГДА ТИПЗНАЧЕНИЯ(РасчетыПоСрокам.ДокументРегистратор) = ТИП(Документ.КорректировкаРеализации)
		|		И НЕ РасчетыПоСрокам.Сторно
		|		ТОГДА 
		|			ВЫБОР
		|				КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|					ТОГДА ВЫБОР КОГДА Предоплата - Долг > 0 
		|							ТОГДА Предоплата - Долг
		|							ИНАЧЕ 0
		|						КОНЕЦ
		|				ИНАЧЕ ВЫБОР КОГДА Долг - Предоплата > 0 
		|						ТОГДА Долг - Предоплата
		|						ИНАЧЕ 0
		|					КОНЕЦ
		|			КОНЕЦ
		|	ИНАЧЕ 0
		|КОНЕЦ
		|";
	ТекстЗапроса = СтрЗаменить(
		ТекстЗапроса,
		"&ШаблонПоляОплачено",
		СтрШаблон(
			"%1 + %2 + %3",
			ВзаиморасчетыСервер.ШаблонПоляОплаченоКлиентом(),
			ВзаиморасчетыСервер.ШаблонПоляЗачтеноКлиенту(),
			ШаблонПоляСуммаКорректировок)); 
	ШаблонПоляСуммаКорректировок = "
		|ВЫБОР 
		|	КОГДА ТИПЗНАЧЕНИЯ(РасчетыПоСрокам.ДокументРегистратор) = ТИП(Документ.КорректировкаРеализации)
		|		И НЕ РасчетыПоСрокам.Сторно
		|		ТОГДА 
		|			ВЫБОР
		|				КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|					ТОГДА Предоплата - Долг 
		|				ИНАЧЕ Долг - Предоплата
		|			КОНЕЦ
		|	ИНАЧЕ 0
		|КОНЕЦ
		|";
	ТекстЗапроса = СтрЗаменить(
		ТекстЗапроса,
		"&ШаблонПоляОтгружено",
		СтрШаблон(
			"%1 + %2",
			ВзаиморасчетыСервер.ШаблонПоляОтгруженоКлиенту(),
			ШаблонПоляСуммаКорректировок));
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ШаблонПоляСписание", ВзаиморасчетыСервер.ШаблонПоляСписаниеПереоценкаЗадолженности());
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаСостояниеОфлайнВзаиморасчетов(ТипДокументаСтрокой)
	
	ТекстЗапроса = "
		|ВЫБРАТЬ 
		|	ДокументЗаказ.Ссылка                            КАК Заказ,
		|	РасчетыСКлиентамиОстатки.КОплатеРасход          КАК ОплаченоПоЗаказу,
		|	ВтДанныеПоРасчетамСКлиентами.КОплатеКонечныйОстаток КАК ОсталосьОплатить,
		|	ВЫБОР
		|		КОГДА ДокументЗаказ.Проведен
		|				И ДокументЗаказ.СуммаДокумента > 0
		|			ТОГДА ВЫБОР
		|				КОГДА ДокументЗаказ.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказам)
		|					ТОГДА ВЫРАЗИТЬ (ЕСТЬNULL(ОплаченоПоЗаказам.КОплатеРасход, 0) КАК ЧИСЛО(31,2))
		|				КОГДА ДокументЗаказ.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
		|					ТОГДА ВЫРАЗИТЬ (ЕСТЬNULL(ВтДанныеПоРасчетамСКлиентами.ОплатаФакт, 0) КАК ЧИСЛО(31,2))
		|				ИНАЧЕ 0
		|			КОНЕЦ
		|		ИНАЧЕ 0
		|	КОНЕЦ                                           КАК СуммаОплаты,
		|	ВЫБОР
		|		КОГДА ДокументЗаказ.Проведен
		|				И ДокументЗаказ.СуммаДокумента > 0
		|			ТОГДА ВЫБОР
		|				КОГДА ДокументЗаказ.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказам)
		|					ТОГДА ВЫРАЗИТЬ ((ЕСТЬNULL(ОплаченоПоЗаказам.КОплатеРасход, 0)) * 100 / ДокументЗаказ.СуммаДокумента КАК ЧИСЛО(20, 10))
		|				КОГДА ДокументЗаказ.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
		|					ТОГДА ВЫРАЗИТЬ ((ЕСТЬNULL(ВтДанныеПоРасчетамСКлиентами.ОплатаФакт, 0)) * 100 / ДокументЗаказ.СуммаДокумента КАК ЧИСЛО(20, 10))
		|				ИНАЧЕ 0
		|			КОНЕЦ
		|		ИНАЧЕ 0
		|	КОНЕЦ                                           КАК ПроцентОплаты,
		|	ВЫБОР
		|		КОГДА ДокументЗаказ.Проведен
		|				И ДокументЗаказ.СуммаДокумента > 0
		|				И (ДокументЗаказ.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказам)
		|					ИЛИ ДокументЗаказ.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным))
		|			ТОГДА ЕСТЬNULL(РасчетыСКлиентамиОстатки.КОтгрузкеПриход, 0)
		|		ИНАЧЕ 0
		|	КОНЕЦ                                           КАК СуммаОтгрузки,
		|	ВЫБОР
		|		КОГДА ДокументЗаказ.Проведен
		|				И ДокументЗаказ.СуммаДокумента > 0
		|				И (ДокументЗаказ.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказам)
		|					ИЛИ ДокументЗаказ.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным))
		|			ТОГДА ВЫРАЗИТЬ(ЕСТЬNULL(РасчетыСКлиентамиОстатки.КОтгрузкеПриход, 0) * 100 / ДокументЗаказ.СуммаДокумента КАК ЧИСЛО(20, 10))
		|		ИНАЧЕ 0
		|	КОНЕЦ                                           КАК ПроцентОтгрузки,
		|	ВЫБОР
		|		КОГДА ДокументЗаказ.Проведен
		|				И ДокументЗаказ.СуммаДокумента > 0
		|				И (ДокументЗаказ.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказам)
		|					ИЛИ ДокументЗаказ.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным))
		|			ТОГДА ВЫРАЗИТЬ(ЕСТЬNULL(РасчетыСКлиентамиОстатки.СуммаКонечныйОстаток, 0) КАК ЧИСЛО(31,2))
		|		ИНАЧЕ 0
		|	КОНЕЦ                                           КАК СуммаДолга,
		|	ВЫБОР
		|		КОГДА ДокументЗаказ.Проведен
		|				И ДокументЗаказ.СуммаДокумента > 0
		|				И (ДокументЗаказ.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказам)
		|					ИЛИ ДокументЗаказ.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным))
		|			ТОГДА ВЫРАЗИТЬ((ВЫБОР 
		|				КОГДА ЕСТЬNULL(РасчетыСКлиентамиОстатки.СуммаКонечныйОстаток, 0) > 0 
		|					ТОГДА ЕСТЬNULL(РасчетыСКлиентамиОстатки.СуммаКонечныйОстаток, 0)
		|				ИНАЧЕ ЕСТЬNULL(-РасчетыСКлиентамиОстатки.СуммаКонечныйОстаток, 0)
		|			КОНЕЦ * 100 / ДокументЗаказ.СуммаДокумента) КАК ЧИСЛО(20, 10))
		|		ИНАЧЕ 0
		|	КОНЕЦ                                           КАК ПроцентДолга
		|
		|ПОМЕСТИТЬ ВтСостояниеВзаиморасчетов
		|ИЗ
		|	#ИмяДокумента КАК ДокументЗаказ
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВтРасчетыСКлиентамиОстатки КАК РасчетыСКлиентамиОстатки
		|		ПО ДокументЗаказ.ОбъектРасчетов = РасчетыСКлиентамиОстатки.ОбъектРасчетов 
		|	ЛЕВОЕ СОЕДИНЕНИЕ ОплаченоПоЗаказам КАК ОплаченоПоЗаказам
		|		ПО ДокументЗаказ.ОбъектРасчетов = ОплаченоПоЗаказам.ОбъектРасчетов
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВтДанныеПоРасчетамСКлиентами КАК ВтДанныеПоРасчетамСКлиентами
		|		ПО ДокументЗаказ.ОбъектРасчетов = ВтДанныеПоРасчетамСКлиентами.ОбъектРасчетов
		|ГДЕ
		|	ДокументЗаказ.Ссылка В (&МассивЗаказов)
		|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "#ИмяДокумента", ТипДокументаСтрокой);
	
	Возврат ТекстЗапроса;
	
КонецФункции

#Область СлужебныеМетодыФормированияСостояний

#Область ТекстыЗапросовПоКонтрольнымРегистрам

Функция ТекстЗапросаРаспоряженияНаОтгрузку(Запрос)
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	Таблица.Распоряжение КАК ОтражаемыйДокумент
	|ИЗ
	|	ДвиженияРаспоряженияНаОтгрузкуИзменение КАК Таблица
	|";
	
	СтруктураТекстовЗапросов = ЗакрытиеМесяцаСервер.ИнициализироватьСтруктуруТекстовЗапросов(ТекстЗапроса);
	
	Возврат СтруктураТекстовЗапросов;
	
КонецФункции

Функция ТекстЗапросаРасчетыСКлиентами(Запрос)
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	ОбъектыРасчетов.Объект КАК ОтражаемыйДокумент
	|ИЗ
	|	РасчетыСКлиентамиИзменения КАК Таблица
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
	|		ПО ОбъектыРасчетов.Ссылка = Таблица.ОбъектРасчетов
	|ГДЕ
	|	ОбъектыРасчетов.ТипОбъектаРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыОбъектовРасчетов.Заказ)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ 
	|	РасчетыСКлиентами.ПродажаПоЗаказу КАК ОтражаемыйДокумент
	|ИЗ
	|	РегистрНакопления.РасчетыСКлиентами КАК РасчетыСКлиентами
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
	|		ПО ОбъектыРасчетов.Объект = РасчетыСКлиентами.ПродажаПоЗаказу
	|		И НЕ ОбъектыРасчетов.ПометкаУдаления
	|ГДЕ
	|	(РасчетыСКлиентами.АналитикаУчетаПоПартнерам, РасчетыСКлиентами.ОбъектРасчетов)
	|	В (ВЫБРАТЬ Т.АналитикаУчетаПоПартнерам, Т.ОбъектРасчетов ИЗ РасчетыСКлиентамиИзменения КАК Т)
	|	И РасчетыСКлиентами.ПродажаПоЗаказу <> НЕОПРЕДЕЛЕНО
	|";
	
	СтруктураТекстовЗапросов = ЗакрытиеМесяцаСервер.ИнициализироватьСтруктуруТекстовЗапросов(ТекстЗапроса);
	
	Возврат СтруктураТекстовЗапросов;
	
КонецФункции

Функция ТекстЗапросаТоварыКОтгрузке(Запрос)
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	Таблица.ДокументОтгрузки КАК ОтражаемыйДокумент
	|ИЗ
	|	ДвиженияТоварыКОтгрузкеИзменение КАК Таблица
	|ГДЕ
	|	ТИПЗНАЧЕНИЯ(Таблица.ДокументОтгрузки) В (ТИП(Документ.ЗаказКлиента),
	|	ТИП(Документ.ЗаявкаНаВозвратТоваровОтКлиента))
	|";
	
	СтруктураТекстовЗапросов = ЗакрытиеМесяцаСервер.ИнициализироватьСтруктуруТекстовЗапросов(ТекстЗапроса);
	
	Возврат СтруктураТекстовЗапросов;
	
КонецФункции

Функция ТекстЗапросаТоварыКПоступлению(Запрос)
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	Таблица.ДокументПоступления КАК ОтражаемыйДокумент
	|ИЗ
	|	ТоварыКПоступлениюИзменение КАК Таблица
	|ГДЕ
	|	ТИПЗНАЧЕНИЯ(Таблица.ДокументПоступления) В (ТИП(Документ.ЗаявкаНаВозвратТоваровОтКлиента))
	|";
	
	СтруктураТекстовЗапросов = ЗакрытиеМесяцаСервер.ИнициализироватьСтруктуруТекстовЗапросов(ТекстЗапроса);
	
	Возврат СтруктураТекстовЗапросов;
	
КонецФункции

Функция ТекстЗапросаСостоянияЗаказовКлиентовИзменение(Запрос)
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	Таблица.Заказ КАК ОтражаемыйДокумент
	|ИЗ
	|	СостоянияЗаказовКлиентовИзменение КАК Таблица
	|";
	
	СтруктураТекстовЗапросов = ЗакрытиеМесяцаСервер.ИнициализироватьСтруктуруТекстовЗапросов(ТекстЗапроса);
	
	Возврат СтруктураТекстовЗапросов;
	
КонецФункции

Функция ТекстЗапросаРеестрДокументов(Запрос)
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	Таблица.Ссылка КАК ОтражаемыйДокумент
	|ИЗ
	|	РеестрДокументовИзменения КАК Таблица
	|ГДЕ
	|	Таблица.Статус В (
	|		ЗНАЧЕНИЕ(Перечисление.СтатусыЗаказовКлиентов.НеСогласован),
	|		ЗНАЧЕНИЕ(Перечисление.СтатусыЗаявокНаВозвратТоваровОтКлиентов.НеСогласована))
	|";
	
	СтруктураТекстовЗапросов = ЗакрытиеМесяцаСервер.ИнициализироватьСтруктуруТекстовЗапросов(ТекстЗапроса);
	
	Возврат СтруктураТекстовЗапросов;
	
КонецФункции

#КонецОбласти

#КонецОбласти

#КонецОбласти

#КонецЕсли
