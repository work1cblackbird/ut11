#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// Переформировывает распоряжения на оформления счетов-фактур комиссионерам.
//
// Параметры:
// 	 ОтчетыКомиссионеров - Массив из ДокументСсылка.ОтчетПоКомиссииМеждуОрганизациями, ДокументСсылка.ОтчетКомиссионера- Отчеты по комиссии, по которым необходимо выполнить формирование распоряжений.
// 	 УдалитьЗаписи - Булево - Удаляем записи по отчету.
// 
Процедура ОбновитьСостояние(ОтчетыКомиссионеров, УдалитьЗаписи = Ложь) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если Не УдалитьЗаписи Тогда
		
		Запрос = Новый Запрос;
		Запрос.Текст =
		"ВЫБРАТЬ
		|	ДанныеОтчетовКомиссионеров.Организация КАК Организация,
		|	ДанныеОтчетовКомиссионеров.Регистратор КАК ОтчетКомиссионера,
		|	ДанныеОтчетовКомиссионеров.Контрагент  КАК Комиссионер,
		|	ДанныеОтчетовКомиссионеров.ДатаСчетаФактурыКомиссионера КАК ДатаСчетаФактуры,
		|	ДанныеОтчетовКомиссионеров.НомерСчетаФактурыКомиссионера КАК НомерСчетаФактуры,
		|	ДанныеОтчетовКомиссионеров.ПокупательКомиссионногоТовара КАК Покупатель,
		|	ДанныеОтчетовКомиссионеров.Валюта КАК Валюта,
		|	СУММА(ДанныеОтчетовКомиссионеров.СуммаБезНДС + ДанныеОтчетовКомиссионеров.СуммаНДС) КАК СуммаСНДС,
		|	СУММА(ДанныеОтчетовКомиссионеров.СуммаНДС) КАК СуммаНДС,
		|	ВЫБОР
		|		КОГДА ДанныеОтчетовКомиссионеров.ТипСчетаФактуры = &ИдентификаторСчетФактураКомиссионеру
		|			ТОГДА 1
		|		ИНАЧЕ 2
		|	КОНЕЦ КАК ТипДокумента
		|ПОМЕСТИТЬ СчетаФакутурыКомиссионеруКРегистрации
		|ИЗ
		|	РегистрСведений.ДанныеОснованийСчетовФактур КАК ДанныеОтчетовКомиссионеров
		|ГДЕ
		|	ДанныеОтчетовКомиссионеров.Регистратор В (&Ссылки)
		|	И ДанныеОтчетовКомиссионеров.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
		|	И (ДанныеОтчетовКомиссионеров.ТипСчетаФактуры = &ИдентификаторСчетФактураКомиссионеру
		|		ИЛИ ДанныеОтчетовКомиссионеров.ТипСчетаФактуры = &ИдентификаторСчетФактураВыданныйКомиссионеру)
		|	
		|СГРУППИРОВАТЬ ПО
		|	ДанныеОтчетовКомиссионеров.Организация,
		|	ДанныеОтчетовКомиссионеров.Регистратор,
		|	ДанныеОтчетовКомиссионеров.Контрагент,
		|	ДанныеОтчетовКомиссионеров.ДатаСчетаФактурыКомиссионера,
		|	ДанныеОтчетовКомиссионеров.НомерСчетаФактурыКомиссионера,
		|	ДанныеОтчетовКомиссионеров.ПокупательКомиссионногоТовара,
		|	ДанныеОтчетовКомиссионеров.Валюта,
		|	ДанныеОтчетовКомиссионеров.ТипСчетаФактуры
		|;
		|
		|ВЫБРАТЬ
		|	1 КАК ТипДокумента,
		|	СчетФактураКомиссионеру.Ссылка КАК Ссылка,
		|	СчетФактураКомиссионеру.Организация КАК Организация,
		|	СчетФактураКомиссионеру.ДокументОснование КАК ОтчетКомиссионера,
		|	СчетФактураКомиссионеру.Комиссионер КАК Комиссионер,
		|	ТаблицаПокупатели.Покупатель КАК Покупатель,
		|	НАЧАЛОПЕРИОДА(СчетФактураКомиссионеру.Дата, ДЕНЬ) КАК ДатаСчетаФактуры,
		|	ТаблицаПокупатели.НомерСчетаФактуры КАК НомерСчетаФактуры,
		|	СчетФактураКомиссионеру.Валюта КАК Валюта
		|ПОМЕСТИТЬ СчетаФактурыКомиссионеру
		|ИЗ
		|	Документ.СчетФактураКомиссионеру КАК СчетФактураКомиссионеру
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
		|		Документ.СчетФактураКомиссионеру.Покупатели КАК ТаблицаПокупатели
		|	ПО
		|		СчетФактураКомиссионеру.Ссылка = ТаблицаПокупатели.Ссылка
		|ГДЕ
		|	СчетФактураКомиссионеру.ДокументОснование В (&Ссылки)
		|	И СчетФактураКомиссионеру.Проведен
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	2 КАК ТипДокумента,
		|	СчетФактураВыданный.Ссылка КАК Ссылка,
		|	СчетФактураВыданный.Организация КАК Организация,
		|	СчетФактураВыданный.ДокументОснование КАК ОтчетКомиссионера,
		|	СчетФактураВыданный.Контрагент КАК Комиссионер,
		|	ТаблицаПокупатели.Покупатель КАК Покупатель,
		|	НАЧАЛОПЕРИОДА(СчетФактураВыданный.Дата, ДЕНЬ) КАК ДатаСчетаФактуры,
		|	ТаблицаПокупатели.НомерСчетаФактуры КАК НомерСчетаФактуры,
		|	СчетФактураВыданный.Валюта КАК Валюта
		|ИЗ
		|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
		|		Документ.СчетФактураВыданный.Покупатели КАК ТаблицаПокупатели
		|	ПО
		|		СчетФактураВыданный.Ссылка = ТаблицаПокупатели.Ссылка
		|ГДЕ
		|	СчетФактураВыданный.ДокументОснование В (&Ссылки)
		|	И СчетФактураВыданный.Проведен
		|;
		|
		|ВЫБРАТЬ
		|	КРегистрации.ОтчетКомиссионера,
		|	КРегистрации.Комиссионер,
		|	КРегистрации.Организация,
		|	КРегистрации.Покупатель,
		|	КРегистрации.ДатаСчетаФактуры,
		|	КРегистрации.НомерСчетаФактуры,
		|	КРегистрации.Валюта,
		|	КРегистрации.СуммаСНДС,
		|	КРегистрации.СуммаНДС
		|ИЗ
		|	СчетаФакутурыКомиссионеруКРегистрации КАК КРегистрации
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		СчетаФактурыКомиссионеру КАК СчетаФактурыКомиссионеру
		|	ПО
		|		КРегистрации.ТипДокумента = СчетаФактурыКомиссионеру.ТипДокумента
		|		И КРегистрации.ОтчетКомиссионера = СчетаФактурыКомиссионеру.ОтчетКомиссионера
		|		И КРегистрации.Покупатель = СчетаФактурыКомиссионеру.Покупатель
		|		И КРегистрации.НомерСчетаФактуры = СчетаФактурыКомиссионеру.НомерСчетаФактуры
		|		И (КРегистрации.ДатаСчетаФактуры = СчетаФактурыКомиссионеру.ДатаСчетаФактуры
		|			ИЛИ КРегистрации.ДатаСчетаФактуры = &ПустаяДата)
		|ГДЕ
		|	СчетаФактурыКомиссионеру.Ссылка ЕСТЬ NULL
		|";
		ИдентификаторСчетФактураКомиссионеру = ОбщегоНазначения.ИдентификаторОбъектаМетаданных("Документ.СчетФактураКомиссионеру");
		ИдентификаторСчетФактураВыданныйКомиссионеру = ОбщегоНазначения.ИдентификаторОбъектаМетаданных("Документ.СчетФактураВыданный");
		Запрос.УстановитьПараметр("ИдентификаторСчетФактураКомиссионеру", ИдентификаторСчетФактураКомиссионеру);
		Запрос.УстановитьПараметр("ИдентификаторСчетФактураВыданныйКомиссионеру", ИдентификаторСчетФактураВыданныйКомиссионеру);
		Запрос.УстановитьПараметр("Ссылки", ОтчетыКомиссионеров);
		Запрос.УстановитьПараметр("ПустаяДата", Дата(1,1,1));
		
		СчетаФактурыКомиссионерамКОформлению = Запрос.Выполнить().Выгрузить(); 
		СчетаФактурыКомиссионерамКОформлению.Индексы.Добавить("ОтчетКомиссионера");
		
	КонецЕсли;
	
	Для каждого ОтчетКомиссионера Из ОтчетыКомиссионеров Цикл
		НаборЗаписей = РегистрыСведений.СчетаФактурыКомиссионерамКОформлению.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.ОтчетКомиссионера.Установить(ОтчетКомиссионера);
		Если Не УдалитьЗаписи Тогда
			Строки = СчетаФактурыКомиссионерамКОформлению.НайтиСтроки(Новый Структура("ОтчетКомиссионера", ОтчетКомиссионера));
			Для каждого Строка Из Строки Цикл
				Запись = НаборЗаписей.Добавить();
				ЗаполнитьЗначенияСвойств(Запись, Строка);
			КонецЦикла;
		КонецЕсли;
		НаборЗаписей.Записывать = Истина;
		НаборЗаписей.Записать();
	КонецЦикла;
	
	УстановитьПривилегированныйРежим(Ложь);
	
КонецПроцедуры

#Область ДляВызоваИзДругихПодсистем

// СтандартныеПодсистемы.УправлениеДоступом

// См. УправлениеДоступомПереопределяемый.ПриЗаполненииСписковСОграничениемДоступа.
Процедура ПриЗаполненииОграниченияДоступа(Ограничение) Экспорт

	Ограничение.Текст =
	"РазрешитьЧтениеИзменение
	|ГДЕ
	|	ЗначениеРазрешено(ОтчетКомиссионера.Организация)
	|	И ЗначениеРазрешено(ОтчетКомиссионера.Партнер)";

КонецПроцедуры

// Конец СтандартныеПодсистемы.УправлениеДоступом

#КонецОбласти

#КонецОбласти

#КонецЕсли