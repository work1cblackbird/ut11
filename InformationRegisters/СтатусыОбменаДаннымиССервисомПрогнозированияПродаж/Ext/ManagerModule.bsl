#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// Получить статусы обмена данными.
// 
// Возвращаемое значение:
//  Структура - Получить статусы обмена данными:
//   * ОбменДаннымиАктивен - Булево -
//   * ТипОбмена - Число -
//   * ПоРасписанию - Булево -
//   * ВыгружаемаяСейчасКоллекция - ПеречислениеСсылка.КоллекцииСервисаПрогнозированияПродаж -
//   * ЗапланированоВыгрузитьОбъектовКоллекции - Число -
//   * ВыгруженоОбъектовКоллекции - Число -
//   * ДатаЗавершения - Дата -
//   * ДатаОбновленияЗаписи - Дата -
//   * ЕстьОшибка - Булево -
//   * ТекстОшибки - Строка -
Функция ПолучитьСтатусыОбменаДанными() Экспорт
	
	Запрос = Новый Запрос();
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СтатусыОбменаДаннымиССервисомПрогнозированияПродаж.ОбменДаннымиАктивен,
	|	СтатусыОбменаДаннымиССервисомПрогнозированияПродаж.ТипОбмена,
	|	СтатусыОбменаДаннымиССервисомПрогнозированияПродаж.ПоРасписанию,
	|	СтатусыОбменаДаннымиССервисомПрогнозированияПродаж.ВыгружаемаяСейчасКоллекция,
	|	СтатусыОбменаДаннымиССервисомПрогнозированияПродаж.ЗапланированоВыгрузитьОбъектовКоллекции,
	|	СтатусыОбменаДаннымиССервисомПрогнозированияПродаж.ЗапланированоВыгрузитьКоллекций,
	|	СтатусыОбменаДаннымиССервисомПрогнозированияПродаж.ВыгруженоОбъектовКоллекции,
	|	СтатусыОбменаДаннымиССервисомПрогнозированияПродаж.ВыгруженоКоллекций,
	|	СтатусыОбменаДаннымиССервисомПрогнозированияПродаж.ДатаЗавершения,
	|	СтатусыОбменаДаннымиССервисомПрогнозированияПродаж.ДатаОбновленияЗаписи,
	|	СтатусыОбменаДаннымиССервисомПрогнозированияПродаж.ЕстьОшибка,
	|	СтатусыОбменаДаннымиССервисомПрогнозированияПродаж.ТекстОшибки
	|ИЗ
	|	РегистрСведений.СтатусыОбменаДаннымиССервисомПрогнозированияПродаж КАК
	|		СтатусыОбменаДаннымиССервисомПрогнозированияПродаж
	|ГДЕ
	|	СтатусыОбменаДаннымиССервисомПрогнозированияПродаж.ИдентификаторЗаписи = &ИдентификаторЗаписи";
	Запрос.УстановитьПараметр("ИдентификаторЗаписи", "1");
	
	Ответ = ШаблонЗаполненияПолейКоллекций();
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		ЗаполнитьЗначенияСвойств(Ответ, Выборка);
	КонецЕсли;
	
	Возврат Ответ;
	
КонецФункции

// Очистить статусы обмена данными.
//
Процедура ОчиститьСтатусыОбменаДанными() Экспорт
	
	НачатьТранзакцию();
	Попытка
		БлокировкаДанных = Новый БлокировкаДанных;
		ЭлементБлокировкиДанных = БлокировкаДанных.Добавить("РегистрСведений.СтатусыОбменаДаннымиССервисомПрогнозированияПродаж");
		ЭлементБлокировкиДанных.УстановитьЗначение("ИдентификаторЗаписи", "1");
		ЭлементБлокировкиДанных.Режим = РежимБлокировкиДанных.Исключительный;
		БлокировкаДанных.Заблокировать();
	
		НаборЗаписей = РегистрыСведений.СтатусыОбменаДаннымиССервисомПрогнозированияПродаж.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.ИдентификаторЗаписи.Установить("1");
		НаборЗаписей.Прочитать();
		
		НаборЗаписей.Очистить();
		
		Запись = НаборЗаписей.Добавить();
		Запись.ИдентификаторЗаписи  = "1";
		Запись.ДатаОбновленияЗаписи = ТекущаяДатаСеанса();
		
		НаборЗаписей.Записать();
		
		ЗафиксироватьТранзакцию();
	Исключение
		ОтменитьТранзакцию();
		СобытиеЖурналаРегистрации = СервисПрогнозированияПереопределяемый.ТекстСобытиеЖурналаРегистрации();
		ЗаписьЖурналаРегистрации(СобытиеЖурналаРегистрации,
			УровеньЖурналаРегистрации.Ошибка,
			Метаданные.РегистрыСведений.СтатусыОбменаДаннымиССервисомПрогнозированияПродаж,
			,
			ОбработкаОшибок.ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
	КонецПопытки;
	
КонецПроцедуры

// Записать статусы обмена данными.
// 
// Параметры:
//  ЗначенияПолейКоллекции - см. ШаблонЗаполненияПолейКоллекций
// 
Процедура ЗаписатьСтатусыОбменаДанными(ЗначенияПолейКоллекции) Экспорт
	
	НачатьТранзакцию();
	Попытка
		БлокировкаДанных = Новый БлокировкаДанных;
		ЭлементБлокировкиДанных = БлокировкаДанных.Добавить("РегистрСведений.СтатусыОбменаДаннымиССервисомПрогнозированияПродаж");
		ЭлементБлокировкиДанных.УстановитьЗначение("ИдентификаторЗаписи", "1");
		ЭлементБлокировкиДанных.Режим = РежимБлокировкиДанных.Исключительный;
		БлокировкаДанных.Заблокировать();
	
		НаборЗаписей = РегистрыСведений.СтатусыОбменаДаннымиССервисомПрогнозированияПродаж.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.ИдентификаторЗаписи.Установить("1");
		НаборЗаписей.Прочитать();
		
		НаборЗаписей.Очистить();
		
		Запись = НаборЗаписей.Добавить();
		ЗаполнитьЗначенияСвойств(Запись, ЗначенияПолейКоллекции);
		Запись.ИдентификаторЗаписи = "1";
		Запись.ДатаОбновленияЗаписи = ТекущаяДатаСеанса();
		
		НаборЗаписей.Записать();
		
		ЗафиксироватьТранзакцию();
	Исключение
		ОтменитьТранзакцию();
		СобытиеЖурналаРегистрации = СервисПрогнозированияПереопределяемый.ТекстСобытиеЖурналаРегистрации();
		ЗаписьЖурналаРегистрации(СобытиеЖурналаРегистрации,
			УровеньЖурналаРегистрации.Ошибка,
			Метаданные.РегистрыСведений.СтатусыОбменаДаннымиССервисомПрогнозированияПродаж,
			,
			ОбработкаОшибок.ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
	КонецПопытки;
	
КонецПроцедуры

// Шаблон заполнения полей коллекций.
// 
// Возвращаемое значение:
//  Структура - Шаблон заполнения полей коллекций:
//   * ОбменДаннымиАктивен - Булево -
//   * ТипОбмена - Число - 0 - выгрузка, 1 - загрузка.
//   * ПоРасписанию - Булево -
//   * ВыгружаемаяСейчасКоллекция - ПеречислениеСсылка.КоллекцииСервисаПрогнозированияПродаж -
//   * ЗапланированоВыгрузитьОбъектовКоллекции - Число -
//   * ВыгруженоОбъектовКоллекции - Число - 
//   * ДатаЗавершения - Дата -
//   * ЕстьОшибка - Булево -
//   * ТекстОшибки - Строка -
Функция ШаблонЗаполненияПолейКоллекций() Экспорт
	
	Ответ = Новый Структура();
	Ответ.Вставить("ОбменДаннымиАктивен", Ложь);
	Ответ.Вставить("ТипОбмена", 0); // 0 - выгрузка, 1 - загрузка.
	Ответ.Вставить("ПоРасписанию", Ложь);
	Ответ.Вставить("ВыгружаемаяСейчасКоллекция", Перечисления.КоллекцииСервисаПрогнозированияПродаж.ПустаяСсылка());
	Ответ.Вставить("ЗапланированоВыгрузитьОбъектовКоллекции", 0);
	Ответ.Вставить("ВыгруженоОбъектовКоллекции", 0);
	Ответ.Вставить("ЗапланированоВыгрузитьКоллекций", 0);
	Ответ.Вставить("ВыгруженоКоллекций", 0);
	Ответ.Вставить("ДатаЗавершения", Дата(1,1,1));
	Ответ.Вставить("ДатаОбновленияЗаписи", Дата(1, 1, 1));
	Ответ.Вставить("ЕстьОшибка", Ложь);
	Ответ.Вставить("ТекстОшибки", "");
	
	Возврат Ответ;
	
КонецФункции

#КонецОбласти

#КонецЕсли
