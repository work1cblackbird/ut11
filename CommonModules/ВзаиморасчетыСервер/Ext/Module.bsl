#Область ПрограммныйИнтерфейс

#Область ПроцедурыИФункцииВыбораДокументаРасчетов

// Заполнение данных выбора объекта расчетов.
//  
// Параметры:
//		ДанныеВыбора - СписокЗначений из СправочникСсылка.ОбъектыРасчетов - Заполняемые данные выбора.
//		СтруктураОтбора - см. ВзаиморасчетыКлиентСервер.СтруктураОтбораДанныхВыбора
//		ВводПоСтроке - Булево - Признак того, что происходит ввод по строке.
//		ЭтоУИП - Булево - Уиникальный идентификатор платежа
//
Процедура ЗаполнитьДанныеВыбораОбъектаРасчетов(ДанныеВыбора, СтруктураОтбора, ВводПоСтроке = Истина, ЭтоУИП = Ложь) Экспорт
	
	Запрос = Новый Запрос;
	
	УсловияЗапроса = Новый Массив;
	УсловияЗапроса.Добавить("ИСТИНА");
	
	Запрос.Текст = ТекстЗапросаВременныхТаблицДанныхВыбора();
	Запрос.УстановитьПараметр("УчитыватьФилиалы", СтруктураОтбора.УчитыватьФилиалы);
		
	Запрос.УстановитьПараметр("Организация", СтруктураОтбора.Организация);
	УсловияЗапроса.Добавить(
		"(ОбъектыРасчетов.Организация = &Организация
		|ИЛИ 
		|	НЕ &Организация В (ВЫБРАТЬ Т.ГоловнаяОрганизация ИЗ ВтГоловнаяОрганизация КАК Т)
		| 	И ОбъектыРасчетов.Договор В 
		|		(ВЫБРАТЬ 
		|			ВтЦентрализованныеДоговоры.Ссылка 
		|		ИЗ ВтЦентрализованныеДоговоры)
		|	И (ОбъектыРасчетов.Организация В (ВЫБРАТЬ Т.ГоловнаяОрганизация ИЗ ВтГоловнаяОрганизация КАК Т)
		|		ИЛИ ЕСТЬNULL(Договоры.РазрешаетсяПередачаОплатМеждуФилиалами, ЛОЖЬ))
		|ИЛИ 
		|	&Организация В (ВЫБРАТЬ Т.ГоловнаяОрганизация ИЗ ВтГоловнаяОрганизация КАК Т)
		|	И ОбъектыРасчетов.Организация.ГоловнаяОрганизация = &Организация
		|	И ОбъектыРасчетов.Организация.ДопускаютсяВзаиморасчетыЧерезГоловнуюОрганизацию)");
	
	Если СтруктураОтбора.ВводОстатков Тогда
		
		Если СтруктураОтбора.ХозяйственнаяОперацияВводаОстатков = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ВводОстатковПремийКлиентам") Тогда
			
			УсловияЗапроса.Добавить("(ВЫРАЗИТЬ(ОбъектыРасчетов.Объект КАК Документ.ПервичныйДокумент).ТипПервичногоДокумента = ЗНАЧЕНИЕ(Перечисление.ТипыПервичныхДокументов.АктПремииКлиенту))");
			
		Иначе
			
			Запрос.УстановитьПараметр("ВыборАванса", СтруктураОтбора.ВыборАванса);
			УсловияЗапроса.Добавить("((ОбъектыРасчетов.ТипОбъектаРасчетов <> ЗНАЧЕНИЕ(Перечисление.ТипыОбъектовРасчетов.Накладная)
				|		ИЛИ ОбъектыРасчетов.Объект ССЫЛКА Документ.ПервичныйДокумент
				|			И ВЫРАЗИТЬ(ОбъектыРасчетов.Объект КАК Документ.ПервичныйДокумент).ТипПервичногоДокумента <> ЗНАЧЕНИЕ(Перечисление.ТипыПервичныхДокументов.АктПремииКлиенту)
				|			И НЕ &ВыборАванса)
				|	И (ОбъектыРасчетов.ТипОбъектаРасчетов <> ЗНАЧЕНИЕ(Перечисление.ТипыОбъектовРасчетов.ПлатежВозврат)
				|		ИЛИ (ОбъектыРасчетов.Объект ССЫЛКА Документ.ПервичныйДокумент
				|			ИЛИ ОбъектыРасчетов.Объект ССЫЛКА Справочник.ПодарочныеСертификаты)
				|			И &ВыборАванса))");
			
		КонецЕсли;
		
	Иначе
		УсловияЗапроса.Добавить("
			|(НЕ ОбъектыРасчетов.Объект ССЫЛКА Справочник.ПодарочныеСертификаты)");
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СтруктураОтбора.ТипРасчетов) Тогда
		УсловияЗапроса.Добавить("ОбъектыРасчетов.ТипРасчетов = &ТипРасчетов");
		Запрос.УстановитьПараметр("ТипРасчетов", СтруктураОтбора.ТипРасчетов);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СтруктураОтбора.Контрагент) Тогда
		Если СтруктураОтбора.ВводОстатков Тогда
			УсловияЗапроса.Добавить("(ОбъектыРасчетов.Контрагент В (&Контрагент)
				|	ИЛИ ОбъектыРасчетов.ТипОбъектаРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыОбъектовРасчетов.Договор)
				|	И ЕСТЬNULL(Договоры.ДоговорСКомиссионером.ВестиРасчетыЧерезКонечныхПокупателей, ЛОЖЬ)
				|	И Договоры.Контрагент В(&Контрагент))");
			УсловияЗапроса.Добавить("НЕ (ОбъектыРасчетов.ТипОбъектаРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыОбъектовРасчетов.Договор)
				|	И ЕСТЬNULL(Договоры.ДоговорСКомиссионером.ВестиРасчетыЧерезКонечныхПокупателей, ЛОЖЬ)
				|	И Договоры.КомиссионерКонтрагент В(&Контрагент))");
		Иначе
			УсловияЗапроса.Добавить("ОбъектыРасчетов.Контрагент = &Контрагент");
		КонецЕсли;
		Запрос.УстановитьПараметр("Контрагент", СтруктураОтбора.Контрагент);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СтруктураОтбора.Текст) Тогда
		Если ВводПоСтроке Тогда
			Запрос.УстановитьПараметр("СтрокаПоиска", "%" + СтруктураОтбора.Текст + "%");
			Если ЭтоУИП Тогда
				УсловияЗапроса.Добавить("ОбъектыРасчетов.ИдентификаторПлатежа ПОДОБНО &СтрокаПоиска");
			Иначе
				УсловияЗапроса.Добавить("ОбъектыРасчетов.Номер ПОДОБНО &СтрокаПоиска");
			КонецЕсли;
		Иначе
			Запрос.УстановитьПараметр("СтрокаПоиска", СтруктураОтбора.Текст);
			Если ЭтоУИП Тогда
				УсловияЗапроса.Добавить("ОбъектыРасчетов.ИдентификаторПлатежа В (&СтрокаПоиска)");
			Иначе
				УсловияЗапроса.Добавить("ОбъектыРасчетов.Номер В (&СтрокаПоиска)");
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Запрос.Текст = Запрос.Текст + ТекстЗапросаВыбораОбъектаРасчетов(ВводПоСтроке);
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ДинамическиеУсловия", СтрСоединить(УсловияЗапроса, " И ")); 
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		
		ЗначениеВыбора = СтруктураЗначениеВыбора();
		ЗаполнитьЗначенияСвойств(ЗначениеВыбора, Выборка);
		
		ДанныеВыбора.Добавить(
			Новый Структура("Значение, ПометкаУдаления", 
				ЗначениеВыбора, 
				Выборка.Состояние = 2 Или Выборка.ПометкаУдаления),
			Строка(Выборка.ОбъектРасчетов));
	КонецЦикла;
	
	Если ВводПоСтроке Тогда
		ДанныеВыбора.СортироватьПоПредставлению();
	КонецЕсли;
	
КонецПроцедуры

// Заполнение данных выбора основания платежа.
//
// Параметры:
//		ДанныеВыбора - СписокЗначений из ДокументСсылка - Заполняемые данные выбора.
//		СтруктураОтбора - см. ВзаиморасчетыКлиентСервер.СтруктураОтбораДанныхВыбора
//		ВводПоСтроке - Булево - Признак того, что происходит ввод по строке.
//		ЭтоУИП - Булево - Уиникальный идентификатор платежа
//
Процедура ЗаполнитьДанныеВыбораОснованияПлатежа(ДанныеВыбора, СтруктураОтбора, ВводПоСтроке = Истина, ЭтоУИП = Ложь) Экспорт
	
	Запрос = Новый Запрос;
	
	ИспользоватьДоговорыМеждуОрганизациями = ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыМеждуОрганизациями");
	ЭтоРасчетыСКлиентом = СтруктураОтбора.ТипРасчетов = Перечисления.ТипыРасчетовСПартнерами.РасчетыСКлиентом;
	
	Запрос.УстановитьПараметр("Организация", СтруктураОтбора.Организация);
	Запрос.УстановитьПараметр("УчитыватьФилиалы", СтруктураОтбора.УчитыватьФилиалы);
	
	ОтборТиповРасчетовДляДоговоров = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(СтруктураОтбора.ТипРасчетов);
	ОтборТиповРасчетовДляДоговоров.Добавить(Перечисления.ТипыРасчетовСПартнерами.ПустаяСсылка());
	Запрос.УстановитьПараметр("ТипыРасчетовДоговоров", ОтборТиповРасчетовДляДоговоров);
	СписокТиповДоговоров = ?(ЭтоРасчетыСКлиентом, 
	                         ВзаиморасчетыКлиентСервер.ТипыДоговоровСКлиентом(),
	                         ВзаиморасчетыКлиентСервер.ТипыДоговоровСПоставщиком());
	Запрос.УстановитьПараметр("ТипыДоговоров", СписокТиповДоговоров.ВыгрузитьЗначения());
	
	ТекстЗапросаВтМеждуОрганизациями = "";
	Если ЗначениеЗаполнено(СтруктураОтбора.Контрагент) Тогда
		Запрос.УстановитьПараметр("Контрагент", СтруктураОтбора.Контрагент);
		Запрос.УстановитьПараметр("ПоВсемКонтрагентам", Ложь);
		Если ИспользоватьДоговорыМеждуОрганизациями Тогда
			ТекстЗапросаВтМеждуОрганизациями = "
				|ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	Организации.Ссылка КАК Ссылка
				|ПОМЕСТИТЬ ВтОтборМеждуОрганизациями
				|ИЗ
				|	Справочник.Организации КАК Организации
				|ГДЕ
				|	Организации.Ссылка В (&Контрагент)
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Организации.Ссылка КАК Ссылка
				|ИЗ
				|	Справочник.Организации КАК Организации
				|ГДЕ
				|	Организации.ГоловнаяОрганизация В (&Контрагент)
				|	И Организации.ДопускаютсяВзаиморасчетыЧерезГоловнуюОрганизацию
				|;
				|";
		КонецЕсли;
	КонецЕсли;
	
	Если СтруктураОтбора.ТипыОснований.Количество() > 0 Тогда
		Запрос.УстановитьПараметр("ТипыОснований", СтруктураОтбора.ТипыОснований);
	КонецЕсли;
	
	Запрос.УстановитьПараметр("ПодборДебиторскойЗадолженности", СтруктураОтбора.ПодборДебиторскойЗадолженности);
	
	Если ЗначениеЗаполнено(СтруктураОтбора.Текст) Тогда
		Если ВводПоСтроке Тогда
			Запрос.УстановитьПараметр("СтрокаПоиска", "%" + СтруктураОтбора.Текст + "%");
		Иначе
			Запрос.УстановитьПараметр("СтрокаПоиска", СтруктураОтбора.Текст);
		КонецЕсли;
	КонецЕсли;
	
	ТекстыЗапросов = Новый Массив;
	
	// По реестру документов
	ТекстЗапроса = ТекстЗапросаВыбораОснованияПлатежа(ВводПоСтроке, СтруктураОтбора, Ложь, ЭтоРасчетыСКлиентом, ЭтоУИП, 0);
	ТекстыЗапросов.Добавить(ТекстЗапроса);
	
	// По договорам контрагентов
	ТекстЗапроса = ТекстЗапросаВыбораОснованияПлатежа(ВводПоСтроке, СтруктураОтбора, Ложь, ЭтоРасчетыСКлиентом, ЭтоУИП, 1);
	ТекстыЗапросов.Добавить(ТекстЗапроса);
	
	// По договорам между организациями
	Если ИспользоватьДоговорыМеждуОрганизациями Тогда
		ТекстЗапроса = ТекстЗапросаВыбораОснованияПлатежа(ВводПоСтроке, СтруктураОтбора, Ложь, ЭтоРасчетыСКлиентом, ЭтоУИП, 2);
		ТекстыЗапросов.Добавить(ТекстЗапроса);
	КонецЕсли;
	
	Запрос.Текст = ТекстЗапросаВременныхТаблицДанныхВыбора() 
	               + ТекстЗапросаВтМеждуОрганизациями
	               + СтрСоединить(ТекстыЗапросов, ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении());
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		
		ЗначениеВыбора = СтруктураЗначениеВыбора();
		ЗаполнитьЗначенияСвойств(ЗначениеВыбора, Выборка);
		Если Не ЗначениеЗаполнено(ЗначениеВыбора.ОбъектРасчетов) Тогда
			ДополнитьСтруктуруОбъектомРасчетовИВалютойВзаиморасчетов(ЗначениеВыбора);
		КонецЕсли;
		
		ДанныеВыбора.Добавить(
			Новый Структура("Значение, ПометкаУдаления", 
				ЗначениеВыбора, 
				Выборка.Состояние = 2),
			Строка(Выборка.ОснованиеПлатежа));
		
	КонецЦикла;
	
	Если ВводПоСтроке Тогда
		ДанныеВыбора.СортироватьПоПредставлению();
		Счетчик = ДанныеВыбора.Количество();
		Пока Счетчик > 10 Цикл
			Счетчик = Счетчик - 1;
			ДанныеВыбора.Удалить(Счетчик);
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

// Заполнение данных выбора идентификатора платежа.
//
// Параметры:
//		ДанныеВыбора - СписокЗначений из СправочникСсылка.ОбъектыРасчетов - Заполняемые данные выбора.
//		СтруктураОтбора - см. ВзаиморасчетыКлиентСервер.СтруктураОтбораДанныхВыбора
//		ВводПоСтроке - Булево - Признак того, что происходит ввод по строке.
//
Процедура ЗаполнитьДанныеВыбораУИП(ДанныеВыбора, СтруктураОтбора, ВводПоСтроке = Истина) Экспорт
	
	ДанныеВыбораПоОбъектам = Новый СписокЗначений();
	ЗаполнитьДанныеВыбораОбъектаРасчетов(ДанныеВыбораПоОбъектам, СтруктураОтбора, ВводПоСтроке, Истина);
	НайденныеУИП = Новый Массив;
	
	Для Каждого ЭлементСписка Из ДанныеВыбораПоОбъектам Цикл
		Если НайденныеУИП.Найти(ЭлементСписка.Значение.Значение.ИдентификаторПлатежа) = Неопределено Тогда
			ДанныеВыбора.Добавить( 
				ЭлементСписка.Значение, 
				Строка(ЭлементСписка.Значение.Значение.ИдентификаторПлатежа) + " (" + Строка(ЭлементСписка.Значение.Значение.Контрагент)+ ")");
			НайденныеУИП.Добавить(ЭлементСписка.Значение.Значение.ИдентификаторПлатежа);
		КонецЕсли;
	КонецЦикла;
	
	ИскатьОснования = Ложь;
	Если ВводПоСтроке Тогда
		Если ДанныеВыбораПоОбъектам.Количество() < 10 Тогда
			ИскатьОснования = Истина;
		КонецЕсли;
	Иначе
		Если ТипЗнч(СтруктураОтбора.Текст) = Тип("Массив") Тогда
			Если НайденныеУИП.Количество() < СтруктураОтбора.Текст.Количество() Тогда
				ИскатьОснования = Истина;
			КонецЕсли;
		Иначе
			Если НайденныеУИП.Количество() = 0 Тогда
				ИскатьОснования = Истина;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если ИскатьОснования Тогда
		
		ДанныеВыбораПоОснованиям = Новый СписокЗначений();
		ЗаполнитьДанныеВыбораОснованияПлатежа(ДанныеВыбораПоОснованиям, СтруктураОтбора, ВводПоСтроке, Истина);
		
		Для Каждого ЭлементСписка Из ДанныеВыбораПоОснованиям Цикл
			Если НайденныеУИП.Найти(ЭлементСписка.Значение.Значение.ИдентификаторПлатежа) = Неопределено Тогда
				ДанныеВыбора.Добавить( 
					ЭлементСписка.Значение, 
					Строка(ЭлементСписка.Значение.Значение.ИдентификаторПлатежа) + " (" + Строка(ЭлементСписка.Значение.Значение.Контрагент)+ ")");
				НайденныеУИП.Добавить(ЭлементСписка.Значение.Значение.ИдентификаторПлатежа);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Если ВводПоСтроке Тогда
		ДанныеВыбора.СортироватьПоПредставлению();
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ПроцедурыИФункцииЗаполненияДокументов

// Процедура заполнения табличной части "РасшифровкаПлатежа" по заказу клиента.
//
// Параметры:
//	ПараметрыЗаполнения - См. ВзаиморасчетыСервер.ПараметрыЗаполненияРасшифровкиПлатежаПоЗаказу.
//	РасшифровкаПлатежа - ТабличнаяЧасть, ТаблицаЗначений - Табличная часть документа, выгрузка колонок табличной части по документу.
//	СуммаКОплате - Число - Сумма к оплате, если известна.
//	Организация - СправочникСсылка.Организации - Организация, осуществляющая продажу.
//	ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - вид операции платежного документа.
//
Процедура ЗаполнитьРасшифровкуПлатежаПоЗаказуКлиента(ПараметрыЗаполнения, РасшифровкаПлатежа, СуммаКОплате = 0, Организация = Неопределено, ХозяйственнаяОперация = Неопределено) Экспорт
	
	ЗаказКлиента     = ПараметрыЗаполнения.ЗаказКлиента;
	Договор          = ПараметрыЗаполнения.Договор;
	ВалютаДокумента  = ПараметрыЗаполнения.ВалютаДокумента;
	Партнер          = ПараметрыЗаполнения.Партнер;
	ОснованиеПлатежа = ПараметрыЗаполнения.ОснованиеПлатежа;

	УстановитьПривилегированныйРежим(Истина);
	Если ЗначениеЗаполнено(ВалютаДокумента) Тогда
		
		ЭтоЗаказИлиЗаявка = ТипЗнч(ЗаказКлиента) = Тип("ДокументСсылка.ЗаказКлиента")
			Или ТипЗнч(ЗаказКлиента) = Тип("ДокументСсылка.ЗаявкаНаВозвратТоваровОтКлиента")
			Или (ТипЗнч(ЗаказКлиента) = Тип("Массив") 
				И (ТипЗнч(ЗаказКлиента[0]) = Тип("ДокументСсылка.ЗаказКлиента")
				Или ТипЗнч(ЗаказКлиента[0]) = Тип("ДокументСсылка.ЗаявкаНаВозвратТоваровОтКлиента")));
		
		ЭтоЗаказ = ТипЗнч(ЗаказКлиента) = Тип("ДокументСсылка.ЗаказКлиента")
			ИЛИ ТипЗнч(ЗаказКлиента) = Тип("ДокументСсылка.ЗаявкаНаВозвратТоваровОтКлиента")
			ИЛИ ТипЗнч(ЗаказКлиента) = Тип("Массив");
			
		ИменаРеквизитов = "ПорядокРасчетов";
		ИменаРеквизитов = ИменаРеквизитов + ?(ЭтоЗаказИлиЗаявка, ",ЭтоЗаказКакСчет","");
		
		Если ТипЗнч(ЗаказКлиента) = Тип("Массив") Тогда
			СтруктураРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ЗаказКлиента[0], ИменаРеквизитов);
		Иначе
			СтруктураРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ЗаказКлиента, ИменаРеквизитов);
		КонецЕсли;
		
		ИспользоватьРасширенныеВозможностиЗаказаКлиента = ?(ЭтоЗаказИлиЗаявка,
			Не СтруктураРеквизитов.ЭтоЗаказКакСчет,
			ПолучитьФункциональнуюОпцию("ИспользоватьРасширенныеВозможностиЗаказаКлиента"));
		ПорядокРасчетов = СтруктураРеквизитов.ПорядокРасчетов;
		
		КолонкиТаблицыРасшифровкиПлатежа = Неопределено;
		
		Если ТипЗнч(РасшифровкаПлатежа) = Тип("ТаблицаЗначений") Тогда
			КолонкиТаблицыРасшифровкиПлатежа = РасшифровкаПлатежа.Колонки;
		Иначе
			КолонкиТаблицыРасшифровкиПлатежа = Метаданные.НайтиПоТипу(ТипЗнч(РасшифровкаПлатежа)).Реквизиты;
		КонецЕсли;
		
		Если ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоДоговорамКонтрагентов
			ИЛИ ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоДоговорамНакладным 
				И (ЭтоЗаказ ИЛИ ТипЗнч(ЗаказКлиента) = Тип("СправочникСсылка.ДоговорыКонтрагентов")) Тогда
			
			Если НЕ Константы.НоваяАрхитектураВзаиморасчетов.Получить() Тогда
			ТекстЗапроса = 
			"ВЫБРАТЬ
			|	РасчетыСКлиентами.ДатаПлатежа КАК Период,
			|	РасчетыСКлиентами.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
			|	РасчетыСКлиентами.ОбъектРасчетов КАК ОбъектРасчетов,
			|	РасчетыСКлиентами.Валюта КАК Валюта,
			|	РасчетыСКлиентами.КОплате КАК КОплате,
			|	ДоговорыКонтрагентов.СтатьяДвиженияДенежныхСредств КАК СтатьяДвиженияДенежныхСредств,
			|	ОбъектыРасчетов.Объект КАК Объект,
			|	ОбъектыРасчетов.Организация КАК Организация
			|ПОМЕСТИТЬ ВтРасчетыСКлиентами
			|ИЗ
			|	РегистрНакопления.РасчетыСКлиентами КАК РасчетыСКлиентами
			|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
			|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
			|			ПО ОбъектыРасчетов.Объект = ДоговорыКонтрагентов.Ссылка
			|		ПО РасчетыСКлиентами.ОбъектРасчетов = ОбъектыРасчетов.Ссылка
			|			И НЕ ОбъектыРасчетов.ПометкаУдаления
			|ГДЕ
			|	РасчетыСКлиентами.Активность
			|	И РасчетыСКлиентами.Регистратор В(&ЗаказКлиента)
			|	И РасчетыСКлиентами.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
			|	И РасчетыСКлиентами.КОплате > 0
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	РасчетыСКлиентами.Период КАК Период,
			|	РасчетыСКлиентами.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
			|	РасчетыСКлиентами.ОбъектРасчетов КАК ОбъектРасчетов,
			|	РасчетыСКлиентами.СтатьяДвиженияДенежныхСредств КАК СтатьяДвиженияДенежныхСредств,
			|	Аналитика.Партнер КАК Партнер,
			|	РасчетыСКлиентами.Валюта КАК Валюта,
			|	РасчетыСКлиентами.Объект КАК Объект,
			|	РасчетыСКлиентами.Организация КАК Организация,
			|	СУММА(РасчетыСКлиентами.КОплате) КАК СуммаПоГрафику
			|ПОМЕСТИТЬ ТаблицаКОплате
			|ИЗ
			|	ВтРасчетыСКлиентами КАК РасчетыСКлиентами
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
			|		ПО РасчетыСКлиентами.АналитикаУчетаПоПартнерам = Аналитика.КлючАналитики
			|			И (&Организация = Аналитика.Организация
			|				ИЛИ &Организация = НЕОПРЕДЕЛЕНО)
			|
			|СГРУППИРОВАТЬ ПО
			|	РасчетыСКлиентами.Период,
			|	РасчетыСКлиентами.ОбъектРасчетов,
			|	РасчетыСКлиентами.АналитикаУчетаПоПартнерам,
			|	РасчетыСКлиентами.Валюта,
			|	Аналитика.Партнер,
			|	РасчетыСКлиентами.СтатьяДвиженияДенежныхСредств,
			|	РасчетыСКлиентами.Объект,
			|	РасчетыСКлиентами.Организация
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	&ТекущаяДата,
			|	Аналитика.КлючАналитики,
			|	ОбъектыРасчетов.Ссылка,
			|	ДанныеДоговора.СтатьяДвиженияДенежныхСредств,
			|	ДанныеДоговора.Партнер,
			|	ДанныеДоговора.ВалютаВзаиморасчетов,
			|	ОбъектыРасчетов.Объект,
			|	ОбъектыРасчетов.Организация,
			|	0
			|ИЗ
			|	Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
			|		ПО ДанныеДоговора.Партнер = Аналитика.Партнер
			|			И ДанныеДоговора.Контрагент = Аналитика.Контрагент
			|			И ДанныеДоговора.Организация = Аналитика.Организация
			|			И ДанныеДоговора.Ссылка = Аналитика.Договор
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
			|			ПО ДанныеДоговора.Ссылка = ОбъектыРасчетов.Объект
			|				И НЕ ОбъектыРасчетов.ПометкаУдаления
			|ГДЕ
			|	ДанныеДоговора.Ссылка В(&ЗаказКлиента)
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	МИНИМУМ(ТаблицаКОплате.Период) КАК Период,
			|	ТаблицаКОплате.Объект КАК ОснованиеПлатежа,
			|	ТаблицаКОплате.ОбъектРасчетов КАК ОбъектРасчетов,
			|	ТаблицаКОплате.Организация КАК Организация,
			|	ТаблицаКОплате.СтатьяДвиженияДенежныхСредств КАК СтатьяДвиженияДенежныхСредств,
			|	ТаблицаКОплате.Партнер КАК Партнер,
			|	ТаблицаКОплате.Валюта КАК ВалютаВзаиморасчетов,
			|	ВЫБОР
			|		КОГДА СУММА(ТаблицаКОплате.СуммаПоГрафику) > 0
			|				И СУММА(ТаблицаКОплате.СуммаПоГрафику) <= МАКСИМУМ(РасчетыСКлиентамиОстатки.КОплатеОстаток - РасчетыСКлиентамиОстатки.ОплачиваетсяОстаток)
			|			ТОГДА СУММА(ТаблицаКОплате.СуммаПоГрафику)
			|		ИНАЧЕ МАКСИМУМ(РасчетыСКлиентамиОстатки.КОплатеОстаток - РасчетыСКлиентамиОстатки.ОплачиваетсяОстаток)
			|	КОНЕЦ КАК СуммаПоГрафику,
			|	СУММА(0) КАК СуммаОплаты
			|ИЗ
			|	ТаблицаКОплате КАК ТаблицаКОплате
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентами.Остатки(
			|				,
			|				(АналитикаУчетаПоПартнерам, ОбъектРасчетов, Валюта) В
			|					(ВЫБРАТЬ
			|						ТаблицаКОплате.АналитикаУчетаПоПартнерам,
			|						ТаблицаКОплате.ОбъектРасчетов,
			|						ТаблицаКОплате.Валюта
			|					ИЗ
			|						ТаблицаКОплате)) КАК РасчетыСКлиентамиОстатки
			|		ПО ТаблицаКОплате.АналитикаУчетаПоПартнерам = РасчетыСКлиентамиОстатки.АналитикаУчетаПоПартнерам
			|			И ТаблицаКОплате.ОбъектРасчетов = РасчетыСКлиентамиОстатки.ОбъектРасчетов
			|			И ТаблицаКОплате.Валюта = РасчетыСКлиентамиОстатки.Валюта
			|
			|СГРУППИРОВАТЬ ПО
			|	ТаблицаКОплате.ОбъектРасчетов,
			|	ТаблицаКОплате.СтатьяДвиженияДенежныхСредств,
			|	ТаблицаКОплате.Партнер,
			|	ТаблицаКОплате.Валюта,
			|	ТаблицаКОплате.Объект,
			|	ТаблицаКОплате.Организация
			|ИТОГИ ПО
			|	ОснованиеПлатежа";
			Иначе
				ТекстЗапроса = 
				"ВЫБРАТЬ
				|	РаспоряженияНаОтгрузку.Регистратор КАК Объект
				|ПОМЕСТИТЬ ВтОбъекты
				|ИЗ
				|	РегистрНакопления.РаспоряженияНаОтгрузку КАК РаспоряженияНаОтгрузку
				|ГДЕ
				|	РаспоряженияНаОтгрузку.Распоряжение В(&ЗаказКлиента)
				|	И РаспоряженияНаОтгрузку.Активность
				|	И РаспоряженияНаОтгрузку.ВидДвиженияРегистра = ЗНАЧЕНИЕ(Перечисление.ВидыДвиженияНакопления.Расход)
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	&Договор
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетов,
				|	ОбъектыРасчетов.ФормаОплаты КАК ФормаОплаты,
				|	ОбъектыРасчетов.Договор КАК Договор,
				|	ОбъектыРасчетов.Соглашение КАК Соглашение
				|ПОМЕСТИТЬ ВТОбъектыРасчетов
				|ИЗ
				|	Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
				|ГДЕ
				|	ОбъектыРасчетов.Объект В
				|			(ВЫБРАТЬ
				|				Т.Объект
				|			ИЗ
				|				ВтОбъекты КАК Т)
				|	И НЕ ОбъектыРасчетов.ПометкаУдаления
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетов,
				|	ОбъектыРасчетов.ФормаОплаты КАК ФормаОплаты,
				|	ОбъектыРасчетов.Договор КАК Договор,
				|	ОбъектыРасчетов.Соглашение КАК Соглашение
				|ИЗ
				|	Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
				|ГДЕ
				|	ОбъектыРасчетов.Объект В (&ЗаказКлиента)
				|	И НЕ ОбъектыРасчетов.ПометкаУдаления
				|
				|ИНДЕКСИРОВАТЬ ПО
				|	ОбъектРасчетов
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ГрафикИсполненияДоговора.Ссылка КАК ДокументПлан
				|ПОМЕСТИТЬ ВтДокументыПлана
				|ИЗ
				|	Документ.ГрафикИсполненияДоговора КАК ГрафикИсполненияДоговора
				|ГДЕ
				|	ГрафикИсполненияДоговора.Договор = &Договор
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	РеестрДокументов.Ссылка
				|ИЗ
				|	РегистрСведений.РеестрДокументов КАК РеестрДокументов
				|ГДЕ
				|	РеестрДокументов.Ссылка В(&ЗаказКлиента)
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ОбъектыРасчетов.Объект КАК ОснованиеПлатежа,
				|	РасчетыСКлиентами.ОбъектРасчетов КАК ОбъектРасчетов,
				|	Аналитика.Организация КАК Организация,
				|	Аналитика.Партнер КАК Партнер,
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств, ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
				|			ТОГДА ВЫРАЗИТЬ(ОбъектыРасчетов.Соглашение КАК Справочник.СоглашенияСКлиентами).СтатьяДвиженияДенежныхСредств
				|		ИНАЧЕ ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств
				|	КОНЕЦ КАК СтатьяДвиженияДенежныхСредств,
				|	РасчетыСКлиентами.ДатаПлановогоПогашения КАК Период,
				|	РасчетыСКлиентами.Валюта КАК ВалютаВзаиморасчетов,
				|	ОбъектыРасчетов.ФормаОплаты КАК ФормаОплаты,
				|	РасчетыСКлиентами.КОплатеОстаток КАК СуммаПоГрафику,
				|	ЕСТЬNULL(РасчетыСКлиентамиОбороты.ОплачиваетсяОборот, 0) КАК СуммаОплаты
				|ИЗ
				|	РегистрНакопления.РасчетыСКлиентамиПланОплат.Остатки(
				|			,
				|			ОбъектРасчетов В
				|					(ВЫБРАТЬ
				|						ВтОбъектыРасчетов.ОбъектРасчетов
				|					ИЗ
				|						ВтОбъектыРасчетов)
				|				И (ТИПЗНАЧЕНИЯ(&ЗаказКлиента) = ТИП(Справочник.ДоговорыКонтрагентов)
				|					ИЛИ ДокументПлан В
				|						(ВЫБРАТЬ
				|							Т.ДокументПлан
				|						ИЗ
				|							ВтДокументыПлана КАК Т))) КАК РасчетыСКлиентами
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
				|		ПО РасчетыСКлиентами.АналитикаУчетаПоПартнерам = Аналитика.КлючАналитики
				|			И (&Организация = Аналитика.Организация
				|				ИЛИ &Организация = НЕОПРЕДЕЛЕНО)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
				|		ПО РасчетыСКлиентами.ОбъектРасчетов = ОбъектыРасчетов.Ссылка
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентами.Обороты(, , Период, ОбъектРасчетов В (ВЫБРАТЬ ОбъектРасчетов ИЗ ВтОбъектыРасчетов)) КАК РасчетыСКлиентамиОбороты
				|			ПО (РасчетыСКлиентамиОбороты.ОбъектРасчетов = РасчетыСКлиентами.ОбъектРасчетов)
				|				И (РасчетыСКлиентамиОбороты.Валюта = РасчетыСКлиентами.Валюта)
				|				И (РасчетыСКлиентамиОбороты.АналитикаУчетаПоПартнерам = РасчетыСКлиентами.АналитикаУчетаПоПартнерам)
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	ОбъектыРасчетов.Объект,
				|	РасчетыСКлиентами.ОбъектРасчетов,
				|	Аналитика.Организация,
				|	Аналитика.Партнер,
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств, ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
				|			ТОГДА ВЫРАЗИТЬ(ОбъектыРасчетов.Соглашение КАК Справочник.СоглашенияСКлиентами).СтатьяДвиженияДенежныхСредств
				|		ИНАЧЕ ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств
				|	КОНЕЦ,
				|	РасчетыСКлиентами.ДатаПлановогоПогашения,
				|	РасчетыСКлиентами.Валюта,
				|	ОбъектыРасчетов.ФормаОплаты,
				|	РасчетыСКлиентами.ДолгОстаток,
				|	ЕСТЬNULL(РасчетыСКлиентамиОбороты.ОплачиваетсяОборот, 0) КАК СуммаОплаты
				|ИЗ
				|	РегистрНакопления.РасчетыСКлиентамиПоСрокам.Остатки(
				|			,
				|			ОбъектРасчетов В
				|				(ВЫБРАТЬ
				|					ВтОбъектыРасчетов.ОбъектРасчетов
				|				ИЗ
				|					ВтОбъектыРасчетов)) КАК РасчетыСКлиентами
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
				|		ПО РасчетыСКлиентами.АналитикаУчетаПоПартнерам = Аналитика.КлючАналитики
				|			И (&Организация = Аналитика.Организация
				|				ИЛИ &Организация = НЕОПРЕДЕЛЕНО)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
				|		ПО РасчетыСКлиентами.ОбъектРасчетов = ОбъектыРасчетов.Ссылка
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентами.Обороты(, , Период, ОбъектРасчетов В (ВЫБРАТЬ ОбъектРасчетов ИЗ ВтОбъектыРасчетов)) КАК РасчетыСКлиентамиОбороты
				|			ПО (РасчетыСКлиентамиОбороты.ОбъектРасчетов = РасчетыСКлиентами.ОбъектРасчетов)
				|				И (РасчетыСКлиентамиОбороты.Валюта = РасчетыСКлиентами.Валюта)
				|				И (РасчетыСКлиентамиОбороты.АналитикаУчетаПоПартнерам = РасчетыСКлиентами.АналитикаУчетаПоПартнерам)
				|
				|УПОРЯДОЧИТЬ ПО
				|	РасчетыСКлиентами.ДатаПлановогоПогашения
				|ИТОГИ ПО
				|	ОбъектРасчетов"
			КонецЕсли;
			
		ИначеЕсли НЕ ИспользоватьРасширенныеВозможностиЗаказаКлиента
			И ЭтоЗаказ
			И ПорядокРасчетов <> Перечисления.ПорядокРасчетов.ПоНакладным Тогда
			
			ТекстЗапроса = "
			|ВЫБРАТЬ
			|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетов,
			|	ОбъектыРасчетов.Организация КАК Организация,
			|	ОбъектыРасчетов.Партнер КАК Партнер,
			|	ОбъектыРасчетов.Объект КАК Объект
			|ПОМЕСТИТЬ ВТОбъектыРасчетов
			|ИЗ 
			|	Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
			|ГДЕ
			|	ОбъектыРасчетов.Объект В (&ЗаказКлиента)
			|	И НЕ ОбъектыРасчетов.ПометкаУдаления
			|;
			|ВЫБРАТЬ
			|	Заказ.Ссылка КАК ОснованиеПлатежа,
			|	ОбъектыРасчетов.ОбъектРасчетов КАК ОбъектРасчетов,
			|	ОбъектыРасчетов.Организация КАК Организация,
			|	ОбъектыРасчетов.Партнер КАК Партнер,
			|	Заказ.Соглашение КАК Соглашение,
			|	ВЫБОР
			|		КОГДА ЕСТЬNULL(Заказ.Договор.СтатьяДвиженияДенежныхСредств, ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
			|			ТОГДА ВЫРАЗИТЬ(Заказ.Соглашение КАК Справочник.СоглашенияСКлиентами).СтатьяДвиженияДенежныхСредств
			|		ИНАЧЕ Заказ.Договор.СтатьяДвиженияДенежныхСредств
			|	КОНЕЦ КАК СтатьяДвиженияДенежныхСредств,
			|	ЭтапыОплатыЗаказа.ДатаПлатежа КАК Период,
			|	Заказ.Валюта КАК ВалютаВзаиморасчетов,
			|	Заказ.ФормаОплаты КАК ФормаОплаты,
			|	ЭтапыОплатыЗаказа.НомерСтроки КАК НомерСтроки,
			|	ЭтапыОплатыЗаказа.СуммаПлатежа + ЭтапыОплатыЗаказа.СуммаЗалогаЗаТару КАК СуммаПоГрафику,
			|	ЕСТЬNULL(РасчетыСКлиентамиОбороты.СуммаРасход, 0) КАК СуммаОплаты
			|ИЗ
			|	Документ.ЗаказКлиента КАК Заказ
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказКлиента.ЭтапыГрафикаОплаты КАК ЭтапыОплатыЗаказа
			|		ПО Заказ.Ссылка = ЭтапыОплатыЗаказа.Ссылка
			|		ЛЕВОЕ СОЕДИНЕНИЕ ВТОбъектыРасчетов КАК ОбъектыРасчетов
			|		ПО ОбъектыРасчетов.Объект = Заказ.Ссылка
			|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентами.Обороты(, , , ОбъектРасчетов В (ВЫБРАТЬ ОбъектРасчетов ИЗ ВТОбъектыРасчетов)) КАК РасчетыСКлиентамиОбороты
			|		ПО ОбъектыРасчетов.ОбъектРасчетов = РасчетыСКлиентамиОбороты.ОбъектРасчетов
			|ГДЕ
			|	Заказ.Ссылка В(&ЗаказКлиента)
			|	И Заказ.ЭтоЗаказКакСчет
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	ЗаявкаНаВозвратТоваровОтКлиента.Ссылка,
			|	ОбъектыРасчетов.ОбъектРасчетов КАК ОбъектРасчетов,
			|	ОбъектыРасчетов.Организация КАК Организация,
			|	Аналитика.Партнер,
			|	ЗаявкаНаВозвратТоваровОтКлиента.Соглашение,
			|	ВЫБОР
			|		КОГДА ЕСТЬNULL(ЗаявкаНаВозвратТоваровОтКлиента.Договор.СтатьяДвиженияДенежныхСредств, ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
			|			ТОГДА ВЫРАЗИТЬ(ЗаявкаНаВозвратТоваровОтКлиента.Соглашение КАК Справочник.СоглашенияСКлиентами).СтатьяДвиженияДенежныхСредств
			|		ИНАЧЕ ЗаявкаНаВозвратТоваровОтКлиента.Договор.СтатьяДвиженияДенежныхСредств
			|	КОНЕЦ,
			|	ЗаявкаНаВозвратТоваровОтКлиентаЭтапыГрафикаОплаты.ДатаПлатежа,
			|	ЗаявкаНаВозвратТоваровОтКлиента.Валюта,
			|	ЗаявкаНаВозвратТоваровОтКлиента.ФормаОплаты,
			|	ЗаявкаНаВозвратТоваровОтКлиентаЭтапыГрафикаОплаты.НомерСтроки КАК НомерСтроки,
			|	ЗаявкаНаВозвратТоваровОтКлиентаЭтапыГрафикаОплаты.СуммаПлатежа + ЗаявкаНаВозвратТоваровОтКлиентаЭтапыГрафикаОплаты.СуммаЗалогаЗаТару,
			|	ЕСТЬNULL(РасчетыСКлиентамиОбороты.СуммаРасход, 0)
			|ИЗ
			|	Документ.ЗаявкаНаВозвратТоваровОтКлиента КАК ЗаявкаНаВозвратТоваровОтКлиента
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаявкаНаВозвратТоваровОтКлиента.ЭтапыГрафикаОплаты КАК ЗаявкаНаВозвратТоваровОтКлиентаЭтапыГрафикаОплаты
			|		ПО ЗаявкаНаВозвратТоваровОтКлиента.Ссылка = ЗаявкаНаВозвратТоваровОтКлиентаЭтапыГрафикаОплаты.Ссылка
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
			|		ПО ЗаявкаНаВозвратТоваровОтКлиента.Партнер = Аналитика.Партнер
			|			И ЗаявкаНаВозвратТоваровОтКлиента.Контрагент = Аналитика.Контрагент
			|			И ЗаявкаНаВозвратТоваровОтКлиента.Организация = Аналитика.Организация
			|			И ЗаявкаНаВозвратТоваровОтКлиента.Договор = Аналитика.Договор
			|		ЛЕВОЕ СОЕДИНЕНИЕ ВТОбъектыРасчетов КАК ОбъектыРасчетов
			|		ПО ОбъектыРасчетов.Объект = ЗаявкаНаВозвратТоваровОтКлиента.Ссылка
			|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентами.Обороты(, , , ОбъектРасчетов В (ВЫБРАТЬ Объект ИЗ ВТОбъектыРасчетов)) КАК РасчетыСКлиентамиОбороты
			|		ПО ОбъектыРасчетов.ОбъектРасчетов = РасчетыСКлиентамиОбороты.ОбъектРасчетов
			|ГДЕ
			|	ЗаявкаНаВозвратТоваровОтКлиента.Ссылка В(&ЗаказКлиента)
			|	И ЗаявкаНаВозвратТоваровОтКлиента.ЭтоЗаказКакСчет
			|УПОРЯДОЧИТЬ ПО
			|	НомерСтроки
			|ИТОГИ ПО
			|	ОснованиеПлатежа";
		Иначе
				
			Если НЕ Константы.НоваяАрхитектураВзаиморасчетов.Получить() Тогда
			ТекстЗапроса = "
			|ВЫБРАТЬ
			|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетов,
			|	ОбъектыРасчетов.Организация КАК Организация,
			|	ОбъектыРасчетов.Партнер КАК Партнер,
			|	ОбъектыРасчетов.Договор КАК Договор,
			|	ВЫБОР
			|		КОГДА ЕСТЬNULL(ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств, ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
			|			ТОГДА ВЫРАЗИТЬ(ОбъектыРасчетов.Соглашение КАК Справочник.СоглашенияСКлиентами).СтатьяДвиженияДенежныхСредств
			|		ИНАЧЕ ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств
			|	КОНЕЦ КАК СтатьяДвиженияДенежныхСредств,
			|	ОбъектыРасчетов.Объект КАК Объект
			|ПОМЕСТИТЬ ВТОбъектыРасчетов
			|ИЗ 
			|	Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
			|ГДЕ
			|	ОбъектыРасчетов.Объект В (&ЗаказКлиента)
			|	И НЕ ОбъектыРасчетов.ПометкаУдаления
			|;
			|ВЫБРАТЬ
			|	ОбъектыРасчетов.Объект КАК ОснованиеПлатежа,
			|	РасчетыСКлиентами.ОбъектРасчетов КАК ОбъектРасчетов,
			|	ОбъектыРасчетов.Организация КАК Организация,
			|	Аналитика.Партнер КАК Партнер,
			|	ОбъектыРасчетов.СтатьяДвиженияДенежныхСредств КАК СтатьяДвиженияДенежныхСредств,
			|	РасчетыСКлиентами.ДатаПлатежа КАК Период,
			|	РасчетыСКлиентами.Валюта КАК ВалютаВзаиморасчетов,
			|	РасчетыСКлиентами.ФормаОплаты КАК ФормаОплаты,
			|	РасчетыСКлиентами.КОплате КАК СуммаПоГрафику,
			|	ЕСТЬNULL(РасчетыСКлиентамиОбороты.КОплатеРасход, 0) + ЕСТЬNULL(РасчетыСКлиентамиОбороты.ОплачиваетсяОборот, 0) КАК СуммаОплаты
			|ИЗ
			|	РегистрНакопления.РасчетыСКлиентами КАК РасчетыСКлиентами
			|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентами.Обороты(, , Период, ) КАК РасчетыСКлиентамиОбороты
			|		ПО РасчетыСКлиентами.ОбъектРасчетов = РасчетыСКлиентамиОбороты.ОбъектРасчетов
			|			И РасчетыСКлиентами.Валюта = РасчетыСКлиентамиОбороты.Валюта
			|			И РасчетыСКлиентами.АналитикаУчетаПоПартнерам = РасчетыСКлиентамиОбороты.АналитикаУчетаПоПартнерам
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
			|		ПО РасчетыСКлиентами.АналитикаУчетаПоПартнерам = Аналитика.КлючАналитики
			|			И (&Организация = Аналитика.Организация
			|				ИЛИ &Организация = НЕОПРЕДЕЛЕНО)
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОбъектыРасчетов КАК ОбъектыРасчетов
			|		ПО РасчетыСКлиентами.ОбъектРасчетов = ОбъектыРасчетов.ОбъектРасчетов
			|ГДЕ
			|	РасчетыСКлиентами.Активность
			|	И РасчетыСКлиентами.ОбъектРасчетов В(ВЫБРАТЬ ОбъектРасчетов ИЗ ВТОбъектыРасчетов)
			|	И РасчетыСКлиентами.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
			|	И РасчетыСКлиентами.КОплате > 0
			|
			|УПОРЯДОЧИТЬ ПО
			|	РасчетыСКлиентами.ДатаПлатежа,
			|	РасчетыСКлиентами.НомерСтроки
			|ИТОГИ ПО
			|	ОснованиеПлатежа";
			Иначе
			ТекстЗапроса = "
				|ВЫБРАТЬ
				|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетов,
				|	ОбъектыРасчетов.ФормаОплаты КАК ФормаОплаты,
				|	ОбъектыРасчетов.Договор КАК Договор,
				|	ОбъектыРасчетов.Соглашение КАК Соглашение
				|ПОМЕСТИТЬ ВТОбъектыРасчетов
				|ИЗ 
				|	Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
				|ГДЕ
				|	ОбъектыРасчетов.Объект В (&ЗаказКлиента)
				|	И НЕ ОбъектыРасчетов.ПометкаУдаления
				|ИНДЕКСИРОВАТЬ ПО 
				|	ОбъектРасчетов
				|; 
				|ВЫБРАТЬ
				|	ОбъектыРасчетов.Объект                      КАК ОснованиеПлатежа,
				|	РасчетыСКлиентами.ОбъектРасчетов            КАК ОбъектРасчетов,
				|	Аналитика.Организация                       КАК Организация,
				|	Аналитика.Партнер                           КАК Партнер,
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств, ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
				|			ТОГДА ВЫРАЗИТЬ(ОбъектыРасчетов.Соглашение КАК Справочник.СоглашенияСКлиентами).СтатьяДвиженияДенежныхСредств
				|		ИНАЧЕ ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств
				|	КОНЕЦ                                       КАК СтатьяДвиженияДенежныхСредств,
				|	РасчетыСКлиентами.ДатаПлановогоПогашения    КАК Период,
				|	РасчетыСКлиентами.Валюта                    КАК ВалютаВзаиморасчетов,
				|	ОбъектыРасчетов.ФормаОплаты                 КАК ФормаОплаты,
				|	РасчетыСКлиентами.КОплатеОстаток            КАК СуммаПоГрафику,
				|	ЕСТЬNULL(РасчетыСКлиентамиОбороты.ОплачиваетсяОборот, 0) КАК СуммаОплаты
				|ИЗ
				|	РегистрНакопления.РасчетыСКлиентамиПланОплат.Остатки(,ОбъектРасчетов В (ВЫБРАТЬ ОбъектРасчетов ИЗ ВтОбъектыРасчетов)) КАК РасчетыСКлиентами
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
				|			ПО РасчетыСКлиентами.АналитикаУчетаПоПартнерам = Аналитика.КлючАналитики
				|				И (&Организация = Аналитика.Организация
				|					ИЛИ &Организация = НЕОПРЕДЕЛЕНО)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
				|			ПО РасчетыСКлиентами.ОбъектРасчетов = ОбъектыРасчетов.Ссылка
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентами.Обороты(, , Период, ОбъектРасчетов В (ВЫБРАТЬ ОбъектРасчетов ИЗ ВтОбъектыРасчетов)) КАК РасчетыСКлиентамиОбороты
				|			ПО (РасчетыСКлиентамиОбороты.ОбъектРасчетов = РасчетыСКлиентами.ОбъектРасчетов)
				|				И (РасчетыСКлиентамиОбороты.Валюта = РасчетыСКлиентами.Валюта)
				|				И (РасчетыСКлиентамиОбороты.АналитикаУчетаПоПартнерам = РасчетыСКлиентами.АналитикаУчетаПоПартнерам)
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	ОбъектыРасчетов.Объект                      КАК ОснованиеПлатежа,
				|	РасчетыСКлиентами.ОбъектРасчетов            КАК ОбъектРасчетов,
				|	Аналитика.Организация                       КАК Организация,
				|	Аналитика.Партнер                           КАК Партнер,
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств, ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
				|			ТОГДА ВЫРАЗИТЬ(ОбъектыРасчетов.Соглашение КАК Справочник.СоглашенияСКлиентами).СтатьяДвиженияДенежныхСредств
				|		ИНАЧЕ ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств
				|	КОНЕЦ                                       КАК СтатьяДвиженияДенежныхСредств,
				|	РасчетыСКлиентами.ДатаПлановогоПогашения    КАК Период,
				|	РасчетыСКлиентами.Валюта                    КАК ВалютаВзаиморасчетов,
				|	ОбъектыРасчетов.ФормаОплаты                 КАК ФормаОплаты,
				|	РасчетыСКлиентами.ДолгОстаток               КАК СуммаПоГрафику,
				|	ЕСТЬNULL(РасчетыСКлиентамиОбороты.ОплачиваетсяОборот, 0) КАК СуммаОплаты
				|ИЗ
				|	РегистрНакопления.РасчетыСКлиентамиПоСрокам.Остатки(,ОбъектРасчетов В (ВЫБРАТЬ ОбъектРасчетов ИЗ ВтОбъектыРасчетов)) КАК РасчетыСКлиентами
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
				|			ПО РасчетыСКлиентами.АналитикаУчетаПоПартнерам = Аналитика.КлючАналитики
				|				И (&Организация = Аналитика.Организация
				|					ИЛИ &Организация = НЕОПРЕДЕЛЕНО)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
				|			ПО РасчетыСКлиентами.ОбъектРасчетов = ОбъектыРасчетов.Ссылка
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентами.Обороты(, , Период, ОбъектРасчетов В (ВЫБРАТЬ ОбъектРасчетов ИЗ ВтОбъектыРасчетов)) КАК РасчетыСКлиентамиОбороты
				|			ПО (РасчетыСКлиентамиОбороты.ОбъектРасчетов = РасчетыСКлиентами.ОбъектРасчетов)
				|				И (РасчетыСКлиентамиОбороты.Валюта = РасчетыСКлиентами.Валюта)
				|				И (РасчетыСКлиентамиОбороты.АналитикаУчетаПоПартнерам = РасчетыСКлиентами.АналитикаУчетаПоПартнерам)
				|УПОРЯДОЧИТЬ ПО
				|	ДатаПлановогоПогашения
				|ИТОГИ ПО
				|	ОбъектРасчетов";
			КонецЕсли;
			
		КонецЕсли;
		
		Запрос = Новый Запрос(ТекстЗапроса);
		
		Запрос.УстановитьПараметр("ЗаказКлиента", ЗаказКлиента);
		Запрос.УстановитьПараметр("ПоДоговорам", ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоДоговорамКонтрагентов
												ИЛИ ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоДоговорамНакладным);
		Запрос.УстановитьПараметр("Договор", Договор);
		Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДатаСеанса());
		Запрос.УстановитьПараметр("Организация", Организация);
		
		Если ХозяйственнаяОперация = Неопределено Тогда 
			СтатьяДДСПоХО = Справочники.СтатьиДвиженияДенежныхСредств.СтатьяДвиженияДенежныхСредствПоХозяйственнойОперации(Перечисления.ХозяйственныеОперации.ПоступлениеОплатыОтКлиента);
		Иначе
			СтатьяДДСПоХО = Справочники.СтатьиДвиженияДенежныхСредств.СтатьяДвиженияДенежныхСредствПоХозяйственнойОперации(ХозяйственнаяОперация);
		КонецЕсли;
		
		ВыборкаПоЗаказам = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаПоЗаказам.Следующий() Цикл
			
			СуммаПоГрафикуВсего = 0;
			УчтеноСуммаОплаты = 0;
		
			Выборка = ВыборкаПоЗаказам.Выбрать();
			Пока Выборка.Следующий() Цикл
				
				СуммаОплаты = ?(Выборка.СуммаОплаты < 0, 0, Выборка.СуммаОплаты);
				// Найдем первый неоплаченный этап.
				Если (Выборка.СуммаПоГрафику + СуммаПоГрафикуВсего) > СуммаОплаты Тогда
					
					НоваяСтрока = РасшифровкаПлатежа.Добавить();
					ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
					
					Если КолонкиТаблицыРасшифровкиПлатежа.Найти("ОснованиеПлатежа") <> Неопределено Тогда
						
						НоваяСтрока.ОснованиеПлатежа = ОснованиеПлатежа;
						
						Если Не ЗначениеЗаполнено(НоваяСтрока.ОснованиеПлатежа) Тогда
							НоваяСтрока.ОснованиеПлатежа = Выборка.ОснованиеПлатежа;
						КонецЕсли;
					
					КонецЕсли;
					
					Если КолонкиТаблицыРасшифровкиПлатежа.Найти("Организация") <> Неопределено Тогда
						НоваяСтрока.Организация = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НоваяСтрока.ОбъектРасчетов, "Организация");
					КонецЕсли;
					
					Если Не ЗначениеЗаполнено(НоваяСтрока.СтатьяДвиженияДенежныхСредств) Тогда
						НоваяСтрока.СтатьяДвиженияДенежныхСредств = СтатьяДДСПоХО;
					Иначе
						
						Если ХозяйственнаяОперация <> Неопределено Тогда
							НоваяСтрока.СтатьяДвиженияДенежныхСредств = СтатьяДДСПоХО;
						КонецЕсли;
						
					КонецЕсли;
					
					НоваяСтрока.СуммаВзаиморасчетов = Выборка.СуммаПоГрафику + СуммаПоГрафикуВсего - (СуммаОплаты + УчтеноСуммаОплаты);
					
					Если СуммаКОплате <> 0 Тогда
						НоваяСтрока.СуммаВзаиморасчетов = Мин(НоваяСтрока.СуммаВзаиморасчетов, СуммаКОплате);
						СуммаКОплате = СуммаКОплате - НоваяСтрока.СуммаВзаиморасчетов;
						УчтеноСуммаОплаты = УчтеноСуммаОплаты + НоваяСтрока.СуммаВзаиморасчетов;
						СуммаПоГрафикуВсего = СуммаПоГрафикуВсего + Выборка.СуммаПоГрафику;
					КонецЕсли;
					
					Если ЗначениеЗаполнено(Договор) Тогда
						ДоговорРеквизиты = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Договор, "ВестиРасчетыЧерезКонечныхПокупателей, Партнер");
					КонецЕсли;
					
					Если ТипЗнч(ОснованиеПлатежа) = Тип("ДокументСсылка.РеализацияТоваровУслуг")
						И ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ОснованиеПлатежа, "ХозяйственнаяОперация") = Перечисления.ХозяйственныеОперации.РеализацияЧерезКомиссионера
						И ЗначениеЗаполнено(Договор) И ДоговорРеквизиты.ВестиРасчетыЧерезКонечныхПокупателей Тогда
						НоваяСтрока.ОбъектРасчетов = ОбъектыРасчетовСервер.ПолучитьОбъектРасчетовПоСсылке(Договор,
							Организация,
							Перечисления.ТипыРасчетовСПартнерами.РасчетыСКлиентом);
						НоваяСтрока.Партнер = ДоговорРеквизиты.Партнер;
					КонецЕсли;
					
					НоваяСтрока.Сумма = РаботаСКурсамиВалютУТ.ПересчитатьВВалюту(
					                    	НоваяСтрока.СуммаВзаиморасчетов,
					                    	ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(Выборка.Организация),
					                    	Выборка.ВалютаВзаиморасчетов,
					                    	ВалютаДокумента,
					                    	ТекущаяДатаСеанса(),
					                    	НоваяСтрока.ОбъектРасчетов);
					
					Если СуммаКОплате = 0 Тогда
						Прервать;
					КонецЕсли;
					
				Иначе
					
					Если ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратОплатыКлиенту Тогда 
						
						НоваяСтрока = РасшифровкаПлатежа.Добавить();
						ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
						
						Если Не ЗначениеЗаполнено(НоваяСтрока.СтатьяДвиженияДенежныхСредств) Тогда
							НоваяСтрока.СтатьяДвиженияДенежныхСредств = СтатьяДДСПоХО;
						КонецЕсли;
						
						Если КолонкиТаблицыРасшифровкиПлатежа.Найти("Организация") <> Неопределено Тогда
							НоваяСтрока.Организация = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НоваяСтрока.ОбъектРасчетов, "Организация");
						КонецЕсли;
						
						НоваяСтрока.СуммаВзаиморасчетов = Выборка.СуммаПоГрафику;
						НоваяСтрока.Сумма = РаботаСКурсамиВалютУТ.ПересчитатьВВалюту(
						                    	НоваяСтрока.СуммаВзаиморасчетов,
						                    	ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(
						                    		?(КолонкиТаблицыРасшифровкиПлатежа.Найти("Организация") <> Неопределено, НоваяСтрока.Организация, Выборка.Организация)),
						                    	Выборка.ВалютаВзаиморасчетов,
						                    	ВалютаДокумента,
						                    	ТекущаяДатаСеанса(),
						                    	Выборка.ОбъектРасчетов);
					Иначе
						СуммаПоГрафикуВсего = СуммаПоГрафикуВсего + Выборка.СуммаПоГрафику;
					КонецЕсли;

				КонецЕсли;
			КонецЦикла;
		КонецЦикла;
		
		Если РасшифровкаПлатежа.Количество() = 0 Тогда
			НоваяСтрока = РасшифровкаПлатежа.Добавить();
			
			Если ЗначениеЗаполнено(Договор)
				И (ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоДоговорамКонтрагентов
				ИЛИ ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоДоговорамНакладным) Тогда
				
				Если КолонкиТаблицыРасшифровкиПлатежа.Найти("ОснованиеПлатежа") <> Неопределено Тогда
					НоваяСтрока.ОснованиеПлатежа = Договор;
				КонецЕсли;
				НоваяСтрока.ОбъектРасчетов = ОбъектыРасчетовСервер.ПолучитьОбъектРасчетовПоСсылке(
					Договор,, Перечисления.ТипыРасчетовСПартнерами.РасчетыСКлиентом);
				УстановитьПривилегированныйРежим(Истина);
				РеквизитыДоговора = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
					Договор, "Партнер, СтатьяДвиженияДенежныхСредств");
				УстановитьПривилегированныйРежим(Ложь);
				НоваяСтрока.Партнер = РеквизитыДоговора.Партнер;
				НоваяСтрока.СтатьяДвиженияДенежныхСредств = РеквизитыДоговора.СтатьяДвиженияДенежныхСредств;
				Если Не ЗначениеЗаполнено(НоваяСтрока.СтатьяДвиженияДенежныхСредств) Тогда
					НоваяСтрока.СтатьяДвиженияДенежныхСредств = СтатьяДДСПоХО;
				КонецЕсли;
				Если КолонкиТаблицыРасшифровкиПлатежа.Найти("Организация") <> Неопределено Тогда
					НоваяСтрока.Организация = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НоваяСтрока.ОбъектРасчетов, "Организация");
				КонецЕсли;
				
			ИначеЕсли ТипЗнч(ЗаказКлиента) <> Тип("Массив") Тогда
				
				Если КолонкиТаблицыРасшифровкиПлатежа.Найти("ОснованиеПлатежа") <> Неопределено Тогда
					НоваяСтрока.ОснованиеПлатежа = ЗаказКлиента;
				КонецЕсли;
				НоваяСтрока.ОбъектРасчетов = ОбъектыРасчетовСервер.ПолучитьОбъектРасчетовПоСсылке(
					ЗаказКлиента,, Перечисления.ТипыРасчетовСПартнерами.РасчетыСКлиентом);
				НоваяСтрока.Партнер = Партнер;
				Если ЗначениеЗаполнено(Договор) Тогда
					НоваяСтрока.СтатьяДвиженияДенежныхСредств = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Договор, "СтатьяДвиженияДенежныхСредств");
				КонецЕсли;
				Если Не ЗначениеЗаполнено(НоваяСтрока.СтатьяДвиженияДенежныхСредств) Тогда
					НоваяСтрока.СтатьяДвиженияДенежныхСредств = СтатьяДДСПоХО;
				КонецЕсли;
				Если КолонкиТаблицыРасшифровкиПлатежа.Найти("Организация") <> Неопределено Тогда
					НоваяСтрока.Организация = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НоваяСтрока.ОбъектРасчетов, "Организация");
				КонецЕсли;
				
			КонецЕсли;
		Иначе
			
			КолонкиГруппировки = "ОбъектРасчетов, СтатьяДвиженияДенежныхСредств, Партнер, ВалютаВзаиморасчетов, ДатаПогашения";
			
			Если КолонкиТаблицыРасшифровкиПлатежа.Найти("ОснованиеПлатежа") <> Неопределено Тогда
				КолонкиГруппировки = КолонкиГруппировки + ", ОснованиеПлатежа";
			КонецЕсли;
			
			Если КолонкиТаблицыРасшифровкиПлатежа.Найти("Организация") <> Неопределено Тогда
				КолонкиГруппировки = КолонкиГруппировки + ", Организация";
			КонецЕсли;
			
			РасшифровкаПлатежа.Свернуть(КолонкиГруппировки, "Сумма, СуммаВзаиморасчетов");
			
		КонецЕсли;
		
		ДенежныеСредстваСервер.ЗаполнитьНДСВРасшифровке(РасшифровкаПлатежа,
			ДенежныеСредстваСервер.РасшифровкаПлатежаНДС(Организация, ТекущаяДатаСеанса(), ВалютаДокумента, РасшифровкаПлатежа.ВыгрузитьКолонку("ОбъектРасчетов"), Истина));
	КонецЕсли;
	
КонецПроцедуры

// Процедура заполнения табличной части "РасшифровкаПлатежа" по счету на оплату.
//
// Параметры:
//	СчетНаОплату - ДокументСсылка.СчетНаОплатуКлиенту - Документ - основание.
//	Организация - СправочникСсылка.Организации - Документ - основание.
//	ЗаказКлиента - ДокументСсылка.ЗаказКлиента - Заказ.
//	ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа поступления денежных средств.
//	РасшифровкаПлатежа - ТабличнаяЧасть - Табличная часть документа.
//
Процедура ЗаполнитьРасшифровкуПлатежаПоСчетуНаОплату(СчетНаОплату, Организация, ЗаказКлиента, ВалютаДокумента, РасшифровкаПлатежа) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	ОбъектРасчетов = ОбъектыРасчетовСервер.ПолучитьОбъектРасчетовПоСсылке(ЗаказКлиента);
	
	// Заполнение табличной части "Расшифровка платежа"
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	РасчетыСКлиентами.СчетНаОплату,
	|	СУММА(
	|		ВЫБОР КОГДА РасчетыСКлиентами.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА
	|			РасчетыСКлиентами.Сумма
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ
	|		) КАК СуммаОплаты
	|ПОМЕСТИТЬ ВтРасчетыПоСчету
	|ИЗ
	|	РегистрНакопления.РасчетыСКлиентами КАК РасчетыСКлиентами
	|ГДЕ
	|	РасчетыСКлиентами.Активность
	|	И РасчетыСКлиентами.СчетНаОплату = &СчетНаОплату
	|СГРУППИРОВАТЬ ПО
	|	РасчетыСКлиентами.СчетНаОплату
	|ИНДЕКСИРОВАТЬ ПО
	|	СчетНаОплату
	|;
	|
	|ВЫБРАТЬ
	|	ЕСТЬNULL(СУММА(Расчеты.КОплатеОстаток - Расчеты.ОплачиваетсяОстаток), 0) КАК СуммаВзаиморасчетов
	|ПОМЕСТИТЬ ВтРасчеты
	|ИЗ
	|	(ВЫБРАТЬ
	|		РасчетыСКлиентами.КОплатеОстаток      КАК КОплатеОстаток,
	|		0                                     КАК ОплачиваетсяОстаток
	|	ИЗ
	|		РегистрНакопления.РасчетыСКлиентамиПланОплат.Остатки(,ОбъектРасчетов = &ОбъектРасчетов) КАК РасчетыСКлиентами
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		РасчетыСКлиентами.ДолгОстаток         КАК КОплатеОстаток,
	|		0                                     КАК ОплачиваетсяОстаток
	|	ИЗ
	|		РегистрНакопления.РасчетыСКлиентамиПоСрокам.Остатки(,ОбъектРасчетов = &ОбъектРасчетов) КАК РасчетыСКлиентами
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		0                                     КАК КОплатеОстаток,
	|		РасчетыСКлиентами.ОплачиваетсяОстаток КАК ОплачиваетсяОстаток
	|	ИЗ
	|		РегистрНакопления.РасчетыСКлиентами.Остатки(,ОбъектРасчетов = &ОбъектРасчетов) КАК РасчетыСКлиентами) КАК Расчеты
	|;
	|
	|ВЫБРАТЬ
	|	СчетНаОплатуКлиенту.Ссылка КАК ОснованиеПлатежа,
	|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетов,
	|	ОбъектыРасчетов.Организация КАК Организация,
	|	СчетНаОплатуКлиенту.ДокументОснование.Партнер КАК Партнер,
	|	СчетНаОплатуКлиенту.ДокументОснование.Соглашение КАК Соглашение,
	|	
	|	ВЫБОР КОГДА СчетНаОплатуКлиенту.Договор.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов) ТОГДА
	|		СчетНаОплатуКлиенту.Договор.СтатьяДвиженияДенежныхСредств
	|	ИНАЧЕ
	|		ВЫБОР КОГДА ЕСТЬNULL(СчетНаОплатуКлиенту.Договор.СтатьяДвиженияДенежныхСредств, ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка) ТОГДА
	|			ВЫРАЗИТЬ(СчетНаОплатуКлиенту.ДокументОснование.Соглашение КАК Справочник.СоглашенияСКлиентами).СтатьяДвиженияДенежныхСредств
	|		ИНАЧЕ
	|			СчетНаОплатуКлиенту.Договор.СтатьяДвиженияДенежныхСредств
	|		КОНЕЦ
	|	КОНЕЦ КАК СтатьяДвиженияДенежныхСредств,
	|	
	|	ЕСТЬNULL(ОбъектыРасчетов.ВалютаВзаиморасчетов,
	|		ЕСТЬNULL(
	|			СчетНаОплатуКлиенту.ДокументОснование.ВалютаВзаиморасчетов, 
	|			СчетНаОплатуКлиенту.ДокументОснование.Валюта)
	|	) КАК ВалютаВзаиморасчетов,
	|	СчетНаОплатуКлиенту.Валюта КАК ВалютаСчета,
	|
	|	СчетНаОплатуКлиенту.СуммаДокумента КАК СуммаСчета,
	|	ЕСТЬNULL(РасчетыСКлиентамиОстатки.СуммаВзаиморасчетов, 0) КАК СуммаВзаиморасчетов,
	|	ЕСТЬNULL(РасчетыСКлиентами.СуммаОплаты, 0) КАК СуммаОплатыПоСчету,
	|
	|	СчетНаОплатуКлиенту.ДокументОснование ССЫЛКА Справочник.ДоговорыКонтрагентов
	|		ИЛИ ЕСТЬNULL(СчетНаОплатуКлиенту.Договор.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов), ЛОЖЬ) КАК ОплатаПоДоговору
	|ИЗ
	|	Документ.СчетНаОплатуКлиенту КАК СчетНаОплатуКлиенту
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтРасчетыПоСчету КАК РасчетыСКлиентами
	|	ПО
	|		СчетНаОплатуКлиенту.Ссылка = РасчетыСКлиентами.СчетНаОплату
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ВтРасчеты КАК РасчетыСКлиентамиОстатки
	|	ПО
	|		ИСТИНА
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
	|		ПО ВЫБОР КОГДА СчетНаОплатуКлиенту.Договор.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов) 
	|			ТОГДА СчетНаОплатуКлиенту.Договор
	|			ИНАЧЕ СчетНаОплатуКлиенту.ДокументОснование
	|		КОНЕЦ = ОбъектыРасчетов.Объект
	|		И ОбъектыРасчетов.ТипРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.РасчетыСКлиентом)
	|		И НЕ ОбъектыРасчетов.ПометкаУдаления
	|		
	|ГДЕ
	|	СчетНаОплатуКлиенту.Ссылка = &СчетНаОплату
	|";
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("СчетНаОплату", СчетНаОплату);
	Запрос.УстановитьПараметр("ОбъектРасчетов", ОбъектРасчетов);
	
	СтатьяДДСПоХО = Справочники.СтатьиДвиженияДенежныхСредств.СтатьяДвиженияДенежныхСредствПоХозяйственнойОперации(Перечисления.ХозяйственныеОперации.ПоступлениеОплатыОтКлиента);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		НоваяСтрока = РасшифровкаПлатежа.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
		Если Не ЗначениеЗаполнено(НоваяСтрока.СтатьяДвиженияДенежныхСредств) Тогда
			НоваяСтрока.СтатьяДвиженияДенежныхСредств = СтатьяДДСПоХО;
		КонецЕсли;
		
		// Счет может быть выставлен не в валюте взаииморасчетов,
		// поэтому нужно пересчитать его сумму в валюту взаиморасчетов,
		// чтобы сравнить с оплатами по счету и остатками расчетов
		СуммаСчетаВВалютеВзаиморасчетов = Выборка.СуммаСчета;
		Если Выборка.ВалютаСчета <> Выборка.ВалютаВзаиморасчетов Тогда
			СуммаСчетаВВалютеВзаиморасчетов = РаботаСКурсамиВалютУТ.ПересчитатьВВалюту(
			                                  	Выборка.СуммаСчета,
			                                  	ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(Выборка.Организация),
			                                  	Выборка.ВалютаСчета,
			                                  	Выборка.ВалютаВзаиморасчетов,
			                                  	ТекущаяДатаСеанса(),
			                                  	ОбъектРасчетов);
		КонецЕсли;
		Если Выборка.ОплатаПоДоговору Тогда
			СуммаВзаиморасчетов = СуммаСчетаВВалютеВзаиморасчетов - Выборка.СуммаОплатыПоСчету;
		ИначеЕсли Выборка.СуммаВзаиморасчетов < СуммаСчетаВВалютеВзаиморасчетов Тогда
			СуммаВзаиморасчетов = Выборка.СуммаВзаиморасчетов;
		ИначеЕсли СуммаСчетаВВалютеВзаиморасчетов > Выборка.СуммаОплатыПоСчету Тогда
			СуммаВзаиморасчетов = СуммаСчетаВВалютеВзаиморасчетов - Выборка.СуммаОплатыПоСчету;
		Иначе
			СуммаВзаиморасчетов = 0;
		КонецЕсли;
		НоваяСтрока.СуммаВзаиморасчетов = СуммаВзаиморасчетов;
		
		Если СуммаВзаиморасчетов = СуммаСчетаВВалютеВзаиморасчетов
			И ВалютаДокумента = Выборка.ВалютаСчета Тогда
			НоваяСтрока.Сумма = Выборка.СуммаСчета;
		ИначеЕсли ВалютаДокумента = Выборка.ВалютаВзаиморасчетов Тогда
			НоваяСтрока.Сумма = СуммаВзаиморасчетов;
		Иначе
			НоваяСтрока.Сумма = РаботаСКурсамиВалютУТ.ПересчитатьВВалюту(
			                    	СуммаВзаиморасчетов,
			                    	ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(Выборка.Организация),
			                    	Выборка.ВалютаВзаиморасчетов,
			                    	ВалютаДокумента,
			                    	ТекущаяДатаСеанса(),
			                    	ОбъектРасчетов);
		КонецЕсли;
	КонецЕсли;
	
	Если РасшифровкаПлатежа.Количество() = 0 Тогда
		НоваяСтрока = РасшифровкаПлатежа.Добавить();
		НоваяСтрока.СчетНаОплату = СчетНаОплату;
	КонецЕсли;
	
	ДенежныеСредстваСервер.ЗаполнитьНДСВРасшифровке(РасшифровкаПлатежа,
		ДенежныеСредстваСервер.РасшифровкаПлатежаНДС(Организация, ТекущаяДатаСеанса(), ВалютаДокумента, ОбъектРасчетов, Истина));
	
КонецПроцедуры

// Процедура заполнения табличной части "РасшифровкаПлатежа" по возврату товаров от клиента.
//
// Параметры:
//	Объекты - ДокументСсылка, Массив из ДокументСсылка - Документ основание.
//	Организация - СправочникСсылка.Организации - Организация документа.
//	ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа поступления денежных средств.
//	СуммаДокумента - Число - Сумма документа - основания.
//	Партнер - СправочникСсылка.Партнеры - Партнер документа - основания.
//	РасшифровкаПлатежа - ТабличнаяЧасть - Табличная часть документа.
//
Процедура ЗаполнитьРасшифровкуПлатежаПоВозвратуТоваровОтКлиента(Объекты, Организация, ВалютаДокумента, СуммаДокумента, Партнер, РасшифровкаПлатежа) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если ЗначениеЗаполнено(ВалютаДокумента) Тогда
		
		Запрос = Новый Запрос("
		|ВЫБРАТЬ
		|	ОбъектыРасчетов.Объект КАК Объект,
		|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетов,
		|	ОбъектыРасчетов.Организация КАК Организация
		|ПОМЕСТИТЬ ВТОбъектыРасчетов
		|ИЗ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
		|ГДЕ
		|	ОбъектыРасчетов.Объект В (&Объекты)
		|	И НЕ ОбъектыРасчетов.ПометкаУдаления
		|;
		|ВЫБРАТЬ
		|	РасчетыСКлиентами.ОбъектРасчетов КАК ОбъектРасчетов,
		|	ОбъектыРасчетов.Организация КАК Организация,
		|	РасчетыСКлиентами.Валюта КАК ВалютаВзаиморасчетов,
		|	(-РасчетыСКлиентами.КОплатеОстаток) КАК СуммаВзаиморасчетов
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентами.Остатки(,
		|		ОбъектРасчетов В (ВЫБРАТЬ ОбъектРасчетов ИЗ ВТОбъектыРасчетов)
		|	) КАК РасчетыСКлиентами
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОбъектыРасчетов КАК ОбъектыРасчетов
		|		ПО РасчетыСКлиентами.ОбъектРасчетов = ОбъектыРасчетов.ОбъектРасчетов
		|ГДЕ
		|	РасчетыСКлиентами.КОплатеОстаток < 0
		|УПОРЯДОЧИТЬ ПО
		|	ВЫБОР КОГДА ОбъектыРасчетов.Объект ССЫЛКА Документ.ВозвратТоваровОтКлиента ТОГДА
		|		1
		|	ИНАЧЕ
		|		2
		|	КОНЕЦ
		|");
		
		Запрос.УстановитьПараметр("Объекты", Объекты);
		
		СтатьяДДСПоХО = Справочники.СтатьиДвиженияДенежныхСредств.СтатьяДвиженияДенежныхСредствПоХозяйственнойОперации(
			Перечисления.ХозяйственныеОперации.ВозвратОплатыКлиенту);
		
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			НоваяСтрока = РасшифровкаПлатежа.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
			НоваяСтрока.Партнер = Партнер;
			НоваяСтрока.СтатьяДвиженияДенежныхСредств = СтатьяДДСПоХО;
			
			Сумма = РаботаСКурсамиВалютУТ.ПересчитатьВВалюту(
			        	НоваяСтрока.СуммаВзаиморасчетов,
			        	ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(Выборка.Организация),
			        	Выборка.ВалютаВзаиморасчетов,
			        	ВалютаДокумента,
			        	ТекущаяДатаСеанса(),
			        	Выборка.ОбъектРасчетов);
			
			Если Сумма <= СуммаДокумента Тогда
				НоваяСтрока.Сумма = Сумма;
			Иначе
				НоваяСтрока.Сумма = СуммаДокумента;
				НоваяСтрока.СуммаВзаиморасчетов = 0;
			КонецЕсли;
		Иначе
			НоваяСтрока = РасшифровкаПлатежа.Добавить();
			НоваяСтрока.Партнер = Партнер;
			НоваяСтрока.Сумма = СуммаДокумента;
		КонецЕсли;
		
		ДенежныеСредстваСервер.ЗаполнитьНДСВРасшифровке(РасшифровкаПлатежа,
			ДенежныеСредстваСервер.РасшифровкаПлатежаНДС(Организация, ТекущаяДатаСеанса(), ВалютаДокумента, РасшифровкаПлатежа.ВыгрузитьКолонку("ОбъектРасчетов"), Ложь));
	КонецЕсли;
КонецПроцедуры

// Процедура заполнения табличной части "РасшифровкаПлатежа" по заказу поставщику.
//
// Параметры:
//	ЗаказПоставщику - ДокументСсылка.ЗаказПоставщику - Документ - основание.
//	Договор - СправочникСсылка.ДоговорыКонтрагентов - Договор для заполнения.
//	ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа поступления денежных средств.
//	СуммаКОплате - Число - Сумма к оплате поставщику.
//	РасшифровкаПлатежа - ТабличнаяЧасть - Табличная часть документа.
//	ЖелательнаяДатаПлатежа - Дата - Дата платежа по графику.
//  Организация - СправочникСсылка.Организации - Организация, осуществляющая закупку.
//
Процедура ЗаполнитьРасшифровкуПлатежаПоЗаказуПоставщику(ЗаказПоставщику, Договор, ВалютаДокумента, Знач СуммаКОплате, РасшифровкаПлатежа, ЖелательнаяДатаПлатежа = Неопределено, Организация = Неопределено) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если ЗначениеЗаполнено(ВалютаДокумента) Тогда
		
		Если ТипЗнч(ЗаказПоставщику) = Тип("Массив") Тогда
			ПорядокРасчетов = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ЗаказПоставщику[0], "ПорядокРасчетов");
		Иначе
			ПорядокРасчетов = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ЗаказПоставщику, "ПорядокРасчетов");
		КонецЕсли;
		
		Если (ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоДоговорамКонтрагентов
			ИЛИ ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоДоговорамНакладным)
			И ТипЗнч(ЗаказПоставщику) <> Тип("СправочникСсылка.ДоговорыКонтрагентов") Тогда
			
			Если НЕ Константы.НоваяАрхитектураВзаиморасчетов.Получить() Тогда
			ТекстЗапроса = "
			|ВЫБРАТЬ
			|	ВЫБОР
			|		КОГДА РасчетыСПоставщиками.ДатаПлатежа < &ТекущаяДата
			|			ТОГДА &ТекущаяДата
			|		ИНАЧЕ РасчетыСПоставщиками.ДатаПлатежа
			|	КОНЕЦ                                          КАК Период,
			|	РасчетыСПоставщиками.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
			|	РасчетыСПоставщиками.ОбъектРасчетов            КАК ОбъектРасчетов,
			|	ВЫБОР
			|		КОГДА ЕСТЬNULL(РасчетыСПоставщиками.ОбъектРасчетов.Договор.СтатьяДвиженияДенежныхСредств, ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
			|			ТОГДА ВЫРАЗИТЬ(РасчетыСПоставщиками.ОбъектРасчетов.Соглашение КАК Справочник.СоглашенияСПоставщиками).СтатьяДвиженияДенежныхСредств
			|		ИНАЧЕ РасчетыСПоставщиками.ОбъектРасчетов.Договор.СтатьяДвиженияДенежныхСредств
			|	КОНЕЦ КАК СтатьяДвиженияДенежныхСредств,
			|	Аналитика.Партнер							   КАК Партнер,
			|	РасчетыСПоставщиками.Валюта					   КАК Валюта,
			|	СУММА(РасчетыСПоставщиками.КОплате)			   КАК СуммаПоГрафику
			|ПОМЕСТИТЬ ТаблицаКОплате
			|ИЗ
			|	РегистрНакопления.РасчетыСПоставщиками КАК РасчетыСПоставщиками
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
			|		ПО РасчетыСПоставщиками.АналитикаУчетаПоПартнерам = Аналитика.КлючАналитики
			|		И (&Организация = Аналитика.Организация
			|			ИЛИ &Организация = Неопределено)
			|ГДЕ
			|	РасчетыСПоставщиками.Активность
			|	И РасчетыСПоставщиками.Регистратор В (&ЗаказПоставщику)
			|	И (РасчетыСПоставщиками.ОбъектРасчетов.ТипОбъектаРасчетов <> ЗНАЧЕНИЕ(Перечисление.ТипыОбъектовРасчетов.Договор)
			|		ИЛИ &ПорядокРасчетов <> ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным))
			|	И РасчетыСПоставщиками.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
			|	И РасчетыСПоставщиками.КОплате > 0
			|
			|СГРУППИРОВАТЬ ПО
			|	ВЫБОР
			|		КОГДА РасчетыСПоставщиками.ДатаПлатежа < &ТекущаяДата
			|			ТОГДА &ТекущаяДата
			|		ИНАЧЕ РасчетыСПоставщиками.ДатаПлатежа
			|	КОНЕЦ,
			|	РасчетыСПоставщиками.ОбъектРасчетов,
			|	ВЫБОР
			|		КОГДА ЕСТЬNULL(РасчетыСПоставщиками.ОбъектРасчетов.Договор.СтатьяДвиженияДенежныхСредств, ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
			|			ТОГДА ВЫРАЗИТЬ(РасчетыСПоставщиками.ОбъектРасчетов.Соглашение КАК Справочник.СоглашенияСПоставщиками).СтатьяДвиженияДенежныхСредств
			|		ИНАЧЕ РасчетыСПоставщиками.ОбъектРасчетов.Договор.СтатьяДвиженияДенежныхСредств
			|	КОНЕЦ,
			|	РасчетыСПоставщиками.АналитикаУчетаПоПартнерам,
			|	РасчетыСПоставщиками.Валюта,
			|	Аналитика.Партнер
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	&ТекущаяДата КАК Период,
			|	Аналитика.КлючАналитики КАК АналитикаУчетаПоПартнерам,
			|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетов,
			|	ДанныеДоговора.СтатьяДвиженияДенежныхСредств КАК СтатьяДвиженияДенежныхСредств,
			|	ДанныеДоговора.Партнер КАК Партнер,
			|	ДанныеДоговора.ВалютаВзаиморасчетов КАК Валюта,
			|	0 КАК СуммаПоГрафику
			|ИЗ
			|	Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
			|		ПО ДанныеДоговора.Партнер = Аналитика.Партнер
			|			И ДанныеДоговора.Контрагент = Аналитика.Контрагент
			|			И ДанныеДоговора.Организация = Аналитика.Организация
			|			И ДанныеДоговора.Ссылка = Аналитика.Договор
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
			|			ПО ДанныеДоговора.Ссылка = ОбъектыРасчетов.Объект
			|				И НЕ ОбъектыРасчетов.ПометкаУдаления
			|ГДЕ
			|	ДанныеДоговора.Ссылка В (&ЗаказПоставщику)
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	МИНИМУМ(ТаблицаКОплате.Период) КАК Период,
			|	ТаблицаКОплате.ОбъектРасчетов  КАК ОбъектРасчетов,
			|	ТаблицаКОплате.ОбъектРасчетов.Организация  КАК Организация,
			|	ТаблицаКОплате.СтатьяДвиженияДенежныхСредств КАК СтатьяДвиженияДенежныхСредств,
			|	ТаблицаКОплате.Партнер		   КАК Партнер,
			|	ТаблицаКОплате.Валюта		   КАК ВалютаВзаиморасчетов,
			|
			|	ВЫБОР
			|		КОГДА СУММА(ТаблицаКОплате.СуммаПоГрафику) > 0 И СУММА(ТаблицаКОплате.СуммаПоГрафику) <=
			|				МАКСИМУМ(РасчетыСПоставщикамиОстатки.ОплачиваетсяОстаток-РасчетыСПоставщикамиОстатки.КОплатеОстаток)
			|			ТОГДА СУММА(ТаблицаКОплате.СуммаПоГрафику)
			|		ИНАЧЕ МАКСИМУМ(РасчетыСПоставщикамиОстатки.ОплачиваетсяОстаток-РасчетыСПоставщикамиОстатки.КОплатеОстаток)
			|	КОНЕЦ КАК СуммаПоГрафику,
			|	СУММА(0) КАК СуммаОплаты
			|
			|ИЗ
			|	ТаблицаКОплате КАК ТаблицаКОплате
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСПоставщиками.Остатки(
			|				,
			|				(АналитикаУчетаПоПартнерам, ОбъектРасчетов, Валюта) В
			|					(ВЫБРАТЬ
			|						ТаблицаКОплате.АналитикаУчетаПоПартнерам,
			|						ТаблицаКОплате.ОбъектРасчетов,
			|						ТаблицаКОплате.Валюта
			|					ИЗ
			|						ТаблицаКОплате)) КАК РасчетыСПоставщикамиОстатки
			|		ПО ТаблицаКОплате.АналитикаУчетаПоПартнерам = РасчетыСПоставщикамиОстатки.АналитикаУчетаПоПартнерам
			|			И ТаблицаКОплате.ОбъектРасчетов = РасчетыСПоставщикамиОстатки.ОбъектРасчетов
			|			И ТаблицаКОплате.Валюта = РасчетыСПоставщикамиОстатки.Валюта
			|
			|СГРУППИРОВАТЬ ПО
			|	ТаблицаКОплате.ОбъектРасчетов,
			|	ТаблицаКОплате.СтатьяДвиженияДенежныхСредств,
			|	ТаблицаКОплате.Партнер,
			|	ТаблицаКОплате.Валюта
			|
			|ИТОГИ ПО
			|	ТаблицаКОплате.ОбъектРасчетов
			|";
			Иначе
				ТекстЗапроса = 
				"ВЫБРАТЬ
				|	ЗаказыПоставщикам.Регистратор КАК Объект
				|ПОМЕСТИТЬ ВтОбъекты
				|ИЗ
				|	РегистрНакопления.ЗаказыПоставщикам КАК ЗаказыПоставщикам
				|ГДЕ
				|	ЗаказыПоставщикам.ЗаказПоставщику В(&ЗаказПоставщику)
				|	И ЗаказыПоставщикам.Активность
				|	И ЗаказыПоставщикам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	&Договор
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетов,
				|	ОбъектыРасчетов.ФормаОплаты КАК ФормаОплаты,
				|	ОбъектыРасчетов.Договор КАК Договор,
				|	ОбъектыРасчетов.Соглашение КАК Соглашение
				|ПОМЕСТИТЬ ВТОбъектыРасчетов
				|ИЗ
				|	Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
				|ГДЕ
				|	ОбъектыРасчетов.Объект В
				|			(ВЫБРАТЬ
				|				Т.Объект
				|			ИЗ
				|				ВтОбъекты КАК Т)
				|	И НЕ ОбъектыРасчетов.ПометкаУдаления
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетов,
				|	ОбъектыРасчетов.ФормаОплаты КАК ФормаОплаты,
				|	ОбъектыРасчетов.Договор КАК Договор,
				|	ОбъектыРасчетов.Соглашение КАК Соглашение
				|ИЗ
				|	Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
				|ГДЕ
				|	ОбъектыРасчетов.Объект В (&ЗаказПоставщику)
				|	И НЕ ОбъектыРасчетов.ПометкаУдаления
				|
				|ИНДЕКСИРОВАТЬ ПО
				|	ОбъектРасчетов
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ГрафикИсполненияДоговора.Ссылка КАК ДокументПлан
				|ПОМЕСТИТЬ ВтДокументыПлана
				|ИЗ
				|	Документ.ГрафикИсполненияДоговора КАК ГрафикИсполненияДоговора
				|ГДЕ
				|	ГрафикИсполненияДоговора.Договор = &Договор
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	РеестрДокументов.Ссылка
				|ИЗ
				|	РегистрСведений.РеестрДокументов КАК РеестрДокументов
				|ГДЕ
				|	РеестрДокументов.Ссылка В(&ЗаказПоставщику)
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	РасчетыСПоставщикамиОбороты.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
				|	РасчетыСПоставщикамиОбороты.ОбъектРасчетов КАК ОбъектРасчетов,
				|	РасчетыСПоставщикамиОбороты.Валюта КАК Валюта,
				|	-РасчетыСПоставщикамиОбороты.ОплачиваетсяОборот КАК СуммаОплаты
				|ПОМЕСТИТЬ ПодготовленоКОплате
				|ИЗ
				|	РегистрНакопления.РасчетыСПоставщиками.Обороты(
				|			,
				|			,
				|			Период,
				|			ОбъектРасчетов В
				|				(ВЫБРАТЬ
				|					ВтОбъектыРасчетов.ОбъектРасчетов
				|				ИЗ
				|					ВтОбъектыРасчетов)) КАК РасчетыСПоставщикамиОбороты
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	РасчетыСПоставщиками.ОбъектРасчетов            КАК ОбъектРасчетов,
				|	РасчетыСПоставщиками.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
				|	Аналитика.Партнер                              КАК Партнер,
				|	Аналитика.Организация                          КАК Организация,
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств, ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
				|			ТОГДА ВЫРАЗИТЬ(ОбъектыРасчетов.Соглашение КАК Справочник.СоглашенияСПоставщиками).СтатьяДвиженияДенежныхСредств
				|		ИНАЧЕ ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств
				|	КОНЕЦ                                          КАК СтатьяДвиженияДенежныхСредств,
				|	ВЫБОР
				|		КОГДА РасчетыСПоставщиками.ДатаПлановогоПогашения < &ТекущаяДата
				|			ТОГДА &ТекущаяДата
				|		ИНАЧЕ РасчетыСПоставщиками.ДатаПлановогоПогашения
				|	КОНЕЦ                                          КАК Период,
				|	РасчетыСПоставщиками.Валюта                    КАК ВалютаВзаиморасчетов,
				|	ОбъектыРасчетов.ФормаОплаты                    КАК ФормаОплаты,
				|	РасчетыСПоставщиками.КОплатеОстаток            КАК СуммаПоГрафику
				|ПОМЕСТИТЬ ОстаткиКОплате
				|ИЗ
				|	РегистрНакопления.РасчетыСПоставщикамиПланОплат.Остатки(
				|			,
				|			ОбъектРасчетов В
				|					(ВЫБРАТЬ
				|						ОбъектРасчетов 
				|					ИЗ 
				|						ВтОбъектыРасчетов)
				|				И ДокументПлан В
				|						(ВЫБРАТЬ
				|							Т.ДокументПлан
				|						ИЗ
				|							ВтДокументыПлана КАК Т)) КАК РасчетыСПоставщиками
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
				|			ПО РасчетыСПоставщиками.АналитикаУчетаПоПартнерам = Аналитика.КлючАналитики
				|				И (&Организация = Аналитика.Организация
				|					ИЛИ &Организация = НЕОПРЕДЕЛЕНО)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
				|			ПО РасчетыСПоставщиками.ОбъектРасчетов = ОбъектыРасчетов.Ссылка
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	РасчетыСПоставщиками.ОбъектРасчетов            КАК ОбъектРасчетов,
				|	РасчетыСПоставщиками.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
				|	Аналитика.Партнер                              КАК Партнер,
				|	Аналитика.Организация                          КАК Организация,
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств, ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
				|			ТОГДА ВЫРАЗИТЬ(ОбъектыРасчетов.Соглашение КАК Справочник.СоглашенияСПоставщиками).СтатьяДвиженияДенежныхСредств
				|		ИНАЧЕ ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств
				|	КОНЕЦ                                          КАК СтатьяДвиженияДенежныхСредств,
				|	ВЫБОР
				|		КОГДА РасчетыСПоставщиками.ДатаПлановогоПогашения < &ТекущаяДата
				|			ТОГДА &ТекущаяДата
				|		ИНАЧЕ РасчетыСПоставщиками.ДатаПлановогоПогашения
				|	КОНЕЦ                                          КАК Период,
				|	РасчетыСПоставщиками.Валюта                    КАК ВалютаВзаиморасчетов,
				|	ОбъектыРасчетов.ФормаОплаты                    КАК ФормаОплаты,
				|	РасчетыСПоставщиками.ДолгОстаток               КАК СуммаПоГрафику
				|ИЗ
				|	РегистрНакопления.РасчетыСПоставщикамиПоСрокам.Остатки(,ОбъектРасчетов В (ВЫБРАТЬ ОбъектРасчетов ИЗ ВтОбъектыРасчетов)) КАК РасчетыСПоставщиками
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
				|			ПО РасчетыСПоставщиками.АналитикаУчетаПоПартнерам = Аналитика.КлючАналитики
				|				И (&Организация = Аналитика.Организация
				|					ИЛИ &Организация = НЕОПРЕДЕЛЕНО)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
				|			ПО РасчетыСПоставщиками.ОбъектРасчетов = ОбъектыРасчетов.Ссылка
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВложенныйЗапрос.ОбъектРасчетов КАК ОбъектРасчетов,
				|	ВложенныйЗапрос.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
				|	ВложенныйЗапрос.Партнер КАК Партнер,
				|	ВложенныйЗапрос.Организация КАК Организация,
				|	ВложенныйЗапрос.СтатьяДвиженияДенежныхСредств КАК СтатьяДвиженияДенежныхСредств,
				|	ВложенныйЗапрос.Период КАК Период,
				|	ВложенныйЗапрос.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
				|	ВложенныйЗапрос.ФормаОплаты КАК ФормаОплаты,
				|	ВложенныйЗапрос.СуммаПоГрафику КАК СуммаПоГрафику,
				|	ЕСТЬNULL(ПодготовленоКОплате.СуммаОплаты, 0) КАК СуммаОплаты
				|ИЗ
				|	(ВЫБРАТЬ
				|		ОстаткиКОплате.ОбъектРасчетов КАК ОбъектРасчетов,
				|		ОстаткиКОплате.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
				|		ОстаткиКОплате.Партнер КАК Партнер,
				|		ОстаткиКОплате.Организация КАК Организация,
				|		ОстаткиКОплате.СтатьяДвиженияДенежныхСредств КАК СтатьяДвиженияДенежныхСредств,
				|		ОстаткиКОплате.Период КАК Период,
				|		ОстаткиКОплате.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
				|		ОстаткиКОплате.ФормаОплаты КАК ФормаОплаты,
				|		СУММА(ОстаткиКОплате.СуммаПоГрафику) КАК СуммаПоГрафику
				|	ИЗ
				|		ОстаткиКОплате КАК ОстаткиКОплате
				|	
				|	СГРУППИРОВАТЬ ПО
				|		ОстаткиКОплате.ОбъектРасчетов,
				|		ОстаткиКОплате.АналитикаУчетаПоПартнерам,
				|		ОстаткиКОплате.Партнер,
				|		ОстаткиКОплате.Организация,
				|		ОстаткиКОплате.СтатьяДвиженияДенежныхСредств,
				|		ОстаткиКОплате.Период,
				|		ОстаткиКОплате.ВалютаВзаиморасчетов,
				|		ОстаткиКОплате.ФормаОплаты) КАК ВложенныйЗапрос
				|		ЛЕВОЕ СОЕДИНЕНИЕ ПодготовленоКОплате КАК ПодготовленоКОплате
				|		ПО (ВложенныйЗапрос.ОбъектРасчетов = ПодготовленоКОплате.ОбъектРасчетов
				|				И ВложенныйЗапрос.АналитикаУчетаПоПартнерам = ПодготовленоКОплате.АналитикаУчетаПоПартнерам
				|				И ВложенныйЗапрос.ВалютаВзаиморасчетов = ПодготовленоКОплате.Валюта)
				|
				|УПОРЯДОЧИТЬ ПО
				|	Период
				|ИТОГИ ПО
				|	ОбъектРасчетов
				|";
			КонецЕсли;
			
		Иначе
			
			Если НЕ Константы.НоваяАрхитектураВзаиморасчетов.Получить() Тогда
			ТекстЗапроса = "
			|ВЫБРАТЬ
			|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетов,
			|	ОбъектыРасчетов.Объект КАК Объект,
			|	ВЫБОР
			|		КОГДА
			|			ЕСТЬNULL(ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств,ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
			|			ТОГДА ВЫРАЗИТЬ(ОбъектыРасчетов.Соглашение КАК Справочник.СоглашенияСПоставщиками).СтатьяДвиженияДенежныхСредств
			|		ИНАЧЕ ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств
			|	КОНЕЦ КАК СтатьяДвиженияДенежныхСредств
			|ПОМЕСТИТЬ ВТОбъектыРасчетов
			|ИЗ 
			|	Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
			|ГДЕ
			|	ОбъектыРасчетов.Объект В (&ЗаказПоставщику)
			|	И НЕ ОбъектыРасчетов.ПометкаУдаления
			|; 
			|ВЫБРАТЬ
			|	РасчетыСПоставщиками.ОбъектРасчетов КАК ОбъектРасчетов,
			|	РасчетыСПоставщиками.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
			|	Аналитика.Партнер КАК Партнер,
			|	ОбъектыРасчетов.СтатьяДвиженияДенежныхСредств КАК СтатьяДвиженияДенежныхСредств,
			|	ВЫБОР
			|		КОГДА РасчетыСПоставщиками.ДатаПлатежа < &ТекущаяДата
			|			ТОГДА &ТекущаяДата
			|		ИНАЧЕ РасчетыСПоставщиками.ДатаПлатежа
			|	КОНЕЦ КАК Период,
			|	РасчетыСПоставщиками.Валюта КАК ВалютаВзаиморасчетов,
			|	РасчетыСПоставщиками.ФормаОплаты КАК ФормаОплаты,
			|	СУММА(РасчетыСПоставщиками.КОплате) КАК СуммаПоГрафику
			|ПОМЕСТИТЬ ЭтапыОплаты
			|ИЗ
			|	РегистрНакопления.РасчетыСПоставщиками КАК РасчетыСПоставщиками
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
			|		ПО РасчетыСПоставщиками.АналитикаУчетаПоПартнерам = Аналитика.КлючАналитики
			|			И (&Организация = Аналитика.Организация
			|				ИЛИ &Организация = НЕОПРЕДЕЛЕНО)
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОбъектыРасчетов КАК ОбъектыРасчетов
			|			ПО РасчетыСПоставщиками.ОбъектРасчетов = ОбъектыРасчетов.ОбъектРасчетов
			|ГДЕ
			|	РасчетыСПоставщиками.Активность
			|	И РасчетыСПоставщиками.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
			|	И РасчетыСПоставщиками.КОплате > 0
			|СГРУППИРОВАТЬ ПО
			|	РасчетыСПоставщиками.ОбъектРасчетов,
			|	РасчетыСПоставщиками.АналитикаУчетаПоПартнерам,
			|	Аналитика.Партнер,
			|	ВЫБОР
			|		КОГДА РасчетыСПоставщиками.ДатаПлатежа < &ТекущаяДата
			|			ТОГДА &ТекущаяДата
			|		ИНАЧЕ РасчетыСПоставщиками.ДатаПлатежа
			|	КОНЕЦ,
			|	РасчетыСПоставщиками.Валюта,
			|	РасчетыСПоставщиками.ФормаОплаты,
			|	ОбъектыРасчетов.СтатьяДвиженияДенежныхСредств
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ЭтапыОплаты.ОбъектРасчетов КАК ОбъектРасчетов,
			|	ЭтапыОплаты.ОбъектРасчетов.Организация КАК Организация,
			|	ЭтапыОплаты.Партнер,
			|	ЭтапыОплаты.СтатьяДвиженияДенежныхСредств,
			|	ЭтапыОплаты.Период,
			|	ЭтапыОплаты.ВалютаВзаиморасчетов,
			|	ЭтапыОплаты.ФормаОплаты,
			|	ЭтапыОплаты.СуммаПоГрафику,
			|	СУММА(ЕСТЬNULL(РасчетыСПоставщикамиОбороты.КОплатеПриход, 0) -
			|		ЕСТЬNULL(РасчетыСПоставщикамиОбороты.ОплачиваетсяОборот, 0)) КАК СуммаОплаты
			|ИЗ
			|	ЭтапыОплаты КАК ЭтапыОплаты
			|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСПоставщиками.Обороты(, , Период, ) КАК РасчетыСПоставщикамиОбороты
			|		ПО (РасчетыСПоставщикамиОбороты.ОбъектРасчетов = ЭтапыОплаты.ОбъектРасчетов)
			|			И (РасчетыСПоставщикамиОбороты.Валюта = ЭтапыОплаты.ВалютаВзаиморасчетов)
			|			И (РасчетыСПоставщикамиОбороты.АналитикаУчетаПоПартнерам = ЭтапыОплаты.АналитикаУчетаПоПартнерам)
			|
			|СГРУППИРОВАТЬ ПО
			|	ЭтапыОплаты.ОбъектРасчетов,
			|	ЭтапыОплаты.Партнер,
			|	ЭтапыОплаты.СтатьяДвиженияДенежныхСредств,
			|	ЭтапыОплаты.Период,
			|	ЭтапыОплаты.ВалютаВзаиморасчетов,
			|	ЭтапыОплаты.ФормаОплаты,
			|	ЭтапыОплаты.СуммаПоГрафику
			|
			|УПОРЯДОЧИТЬ ПО
			|	ЭтапыОплаты.Период
			|ИТОГИ ПО
			|	ОбъектРасчетов";
			Иначе
			ТекстЗапроса = "
				|ВЫБРАТЬ
				|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетов,
				|	ОбъектыРасчетов.ФормаОплаты КАК ФормаОплаты,
				|	ОбъектыРасчетов.Договор КАК Договор,
				|	ОбъектыРасчетов.Соглашение КАК Соглашение
				|ПОМЕСТИТЬ ВТОбъектыРасчетов
				|ИЗ 
				|	Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
				|ГДЕ
				|	ОбъектыРасчетов.Объект В (&ЗаказПоставщику)
				|	И НЕ ОбъектыРасчетов.ПометкаУдаления
				|ИНДЕКСИРОВАТЬ ПО 
				|	ОбъектРасчетов
				|; 
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	РасчетыСПоставщикамиОбороты.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
				|	РасчетыСПоставщикамиОбороты.ОбъектРасчетов КАК ОбъектРасчетов,
				|	РасчетыСПоставщикамиОбороты.Валюта КАК Валюта,
				|	-РасчетыСПоставщикамиОбороты.ОплачиваетсяОборот КАК СуммаОплаты
				|ПОМЕСТИТЬ ПодготовленоКОплате
				|ИЗ
				|	РегистрНакопления.РасчетыСПоставщиками.Обороты(
				|			,
				|			,
				|			Период,
				|			ОбъектРасчетов В
				|				(ВЫБРАТЬ
				|					ВтОбъектыРасчетов.ОбъектРасчетов
				|				ИЗ
				|					ВтОбъектыРасчетов)) КАК РасчетыСПоставщикамиОбороты
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	РасчетыСПоставщиками.ОбъектРасчетов            КАК ОбъектРасчетов,
				|	РасчетыСПоставщиками.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
				|	Аналитика.Партнер                              КАК Партнер,
				|	Аналитика.Организация                          КАК Организация,
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств, ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
				|			ТОГДА ВЫРАЗИТЬ(ОбъектыРасчетов.Соглашение КАК Справочник.СоглашенияСПоставщиками).СтатьяДвиженияДенежныхСредств
				|		ИНАЧЕ ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств
				|	КОНЕЦ                                          КАК СтатьяДвиженияДенежныхСредств,
				|	ВЫБОР
				|		КОГДА РасчетыСПоставщиками.ДатаПлановогоПогашения < &ТекущаяДата
				|			ТОГДА &ТекущаяДата
				|		ИНАЧЕ РасчетыСПоставщиками.ДатаПлановогоПогашения
				|	КОНЕЦ                                          КАК Период,
				|	РасчетыСПоставщиками.Валюта                    КАК ВалютаВзаиморасчетов,
				|	ОбъектыРасчетов.ФормаОплаты                    КАК ФормаОплаты,
				|	РасчетыСПоставщиками.КОплатеОстаток            КАК СуммаПоГрафику
				|ПОМЕСТИТЬ ОстаткиКОплате
				|ИЗ
				|	РегистрНакопления.РасчетыСПоставщикамиПланОплат.Остатки(,ОбъектРасчетов В (ВЫБРАТЬ ОбъектРасчетов ИЗ ВтОбъектыРасчетов)) КАК РасчетыСПоставщиками
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
				|			ПО РасчетыСПоставщиками.АналитикаУчетаПоПартнерам = Аналитика.КлючАналитики
				|				И (&Организация = Аналитика.Организация
				|					ИЛИ &Организация = НЕОПРЕДЕЛЕНО)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
				|			ПО РасчетыСПоставщиками.ОбъектРасчетов = ОбъектыРасчетов.Ссылка
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	РасчетыСПоставщиками.ОбъектРасчетов            КАК ОбъектРасчетов,
				|	РасчетыСПоставщиками.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
				|	Аналитика.Партнер                              КАК Партнер,
				|	Аналитика.Организация                          КАК Организация,
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств, ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
				|			ТОГДА ВЫРАЗИТЬ(ОбъектыРасчетов.Соглашение КАК Справочник.СоглашенияСПоставщиками).СтатьяДвиженияДенежныхСредств
				|		ИНАЧЕ ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств
				|	КОНЕЦ                                          КАК СтатьяДвиженияДенежныхСредств,
				|	ВЫБОР
				|		КОГДА РасчетыСПоставщиками.ДатаПлановогоПогашения < &ТекущаяДата
				|			ТОГДА &ТекущаяДата
				|		ИНАЧЕ РасчетыСПоставщиками.ДатаПлановогоПогашения
				|	КОНЕЦ                                          КАК Период,
				|	РасчетыСПоставщиками.Валюта                    КАК ВалютаВзаиморасчетов,
				|	ОбъектыРасчетов.ФормаОплаты                    КАК ФормаОплаты,
				|	РасчетыСПоставщиками.ДолгОстаток               КАК СуммаПоГрафику
				|ИЗ
				|	РегистрНакопления.РасчетыСПоставщикамиПоСрокам.Остатки(,ОбъектРасчетов В (ВЫБРАТЬ ОбъектРасчетов ИЗ ВтОбъектыРасчетов)) КАК РасчетыСПоставщиками
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
				|			ПО РасчетыСПоставщиками.АналитикаУчетаПоПартнерам = Аналитика.КлючАналитики
				|				И (&Организация = Аналитика.Организация
				|					ИЛИ &Организация = НЕОПРЕДЕЛЕНО)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
				|			ПО РасчетыСПоставщиками.ОбъектРасчетов = ОбъектыРасчетов.Ссылка
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВложенныйЗапрос.ОбъектРасчетов КАК ОбъектРасчетов,
				|	ВложенныйЗапрос.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
				|	ВложенныйЗапрос.Партнер КАК Партнер,
				|	ВложенныйЗапрос.Организация КАК Организация,
				|	ВложенныйЗапрос.СтатьяДвиженияДенежныхСредств КАК СтатьяДвиженияДенежныхСредств,
				|	ВложенныйЗапрос.Период КАК Период,
				|	ВложенныйЗапрос.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
				|	ВложенныйЗапрос.ФормаОплаты КАК ФормаОплаты,
				|	ВложенныйЗапрос.СуммаПоГрафику КАК СуммаПоГрафику,
				|	ЕСТЬNULL(ПодготовленоКОплате.СуммаОплаты, 0) КАК СуммаОплаты
				|ИЗ
				|	(ВЫБРАТЬ
				|		ОстаткиКОплате.ОбъектРасчетов КАК ОбъектРасчетов,
				|		ОстаткиКОплате.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
				|		ОстаткиКОплате.Партнер КАК Партнер,
				|		ОстаткиКОплате.Организация КАК Организация,
				|		ОстаткиКОплате.СтатьяДвиженияДенежныхСредств КАК СтатьяДвиженияДенежныхСредств,
				|		ОстаткиКОплате.Период КАК Период,
				|		ОстаткиКОплате.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
				|		ОстаткиКОплате.ФормаОплаты КАК ФормаОплаты,
				|		СУММА(ОстаткиКОплате.СуммаПоГрафику) КАК СуммаПоГрафику
				|	ИЗ
				|		ОстаткиКОплате КАК ОстаткиКОплате
				|	
				|	СГРУППИРОВАТЬ ПО
				|		ОстаткиКОплате.ОбъектРасчетов,
				|		ОстаткиКОплате.АналитикаУчетаПоПартнерам,
				|		ОстаткиКОплате.Партнер,
				|		ОстаткиКОплате.Организация,
				|		ОстаткиКОплате.СтатьяДвиженияДенежныхСредств,
				|		ОстаткиКОплате.Период,
				|		ОстаткиКОплате.ВалютаВзаиморасчетов,
				|		ОстаткиКОплате.ФормаОплаты) КАК ВложенныйЗапрос
				|		ЛЕВОЕ СОЕДИНЕНИЕ ПодготовленоКОплате КАК ПодготовленоКОплате
				|		ПО (ВложенныйЗапрос.ОбъектРасчетов = ПодготовленоКОплате.ОбъектРасчетов
				|				И ВложенныйЗапрос.АналитикаУчетаПоПартнерам = ПодготовленоКОплате.АналитикаУчетаПоПартнерам
				|				И ВложенныйЗапрос.ВалютаВзаиморасчетов = ПодготовленоКОплате.Валюта)
				|
				|УПОРЯДОЧИТЬ ПО
				|	Период
				|ИТОГИ ПО
				|	ОбъектРасчетов
				|";
			КонецЕсли;
			
		КонецЕсли;
		
		Запрос = Новый Запрос(ТекстЗапроса);
		
		Запрос.УстановитьПараметр("ПорядокРасчетов",ПорядокРасчетов);
		Запрос.УстановитьПараметр("ЗаказПоставщику", ЗаказПоставщику);
		Запрос.УстановитьПараметр("Организация", Организация);
		Запрос.УстановитьПараметр("Договор", Договор);
		Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДатаСеанса());
		
		СтатьяДДСПоХО = Справочники.СтатьиДвиженияДенежныхСредств.СтатьяДвиженияДенежныхСредствПоХозяйственнойОперации(Перечисления.ХозяйственныеОперации.ОплатаПоставщику);
		СуммаКРаспределению = СуммаКОплате;
		
		ВыборкаПоЗаказам = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаПоЗаказам.Следующий() Цикл
			
			СуммаПоГрафикуВсего = 0;
			УчтеноСуммаОплаты = 0;
			
			Выборка = ВыборкаПоЗаказам.Выбрать();
			Пока Выборка.Следующий() Цикл
				
				Если (СуммаКРаспределению <> 0 И СуммаКОплате = 0) 
					ИЛИ (СуммаКРаспределению = 0
					И Выборка.Период > ТекущаяДатаСеанса()
					И РасшифровкаПлатежа.Количество() <> 0) Тогда
					Прервать;
				КонецЕсли;
					
				СуммаОплаты = ?(Выборка.СуммаОплаты < 0, 0, Выборка.СуммаОплаты);
				// Найдем первый неоплаченный этап.
				Если (Выборка.СуммаПоГрафику + СуммаПоГрафикуВсего) > СуммаОплаты
				 ИЛИ СуммаКОплате <> 0 Тогда
					
					НоваяСтрока = РасшифровкаПлатежа.Добавить();
					ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
					Если Не ЗначениеЗаполнено(НоваяСтрока.СтатьяДвиженияДенежныхСредств) Тогда
						НоваяСтрока.СтатьяДвиженияДенежныхСредств = СтатьяДДСПоХО;
					КонецЕсли;
					НоваяСтрока.СуммаВзаиморасчетов = Выборка.СуммаПоГрафику + СуммаПоГрафикуВсего - (СуммаОплаты + УчтеноСуммаОплаты);
					Если СуммаКОплате <> 0 Тогда
						НоваяСтрока.СуммаВзаиморасчетов = Мин(НоваяСтрока.СуммаВзаиморасчетов, СуммаКОплате);
						СуммаКОплате = СуммаКОплате - НоваяСтрока.СуммаВзаиморасчетов;
						УчтеноСуммаОплаты = УчтеноСуммаОплаты + НоваяСтрока.СуммаВзаиморасчетов;
						СуммаПоГрафикуВсего = СуммаПоГрафикуВсего + Выборка.СуммаПоГрафику;
					КонецЕсли;
					
					НоваяСтрока.Сумма = РаботаСКурсамиВалютУТ.ПересчитатьВВалюту(
					                    	НоваяСтрока.СуммаВзаиморасчетов,
					                    	ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(Выборка.Организация),
					                    	Выборка.ВалютаВзаиморасчетов,
					                    	ВалютаДокумента,
					                    	ТекущаяДатаСеанса(),
					                    	Выборка.ОбъектРасчетов);
					
					Если ЗначениеЗаполнено(ЖелательнаяДатаПлатежа) Тогда
						ЖелательнаяДатаПлатежа = Мин(ЖелательнаяДатаПлатежа, Выборка.Период);
					Иначе
						ЖелательнаяДатаПлатежа = Выборка.Период;
					КонецЕсли;
					
					Если НоваяСтрока.СуммаВзаиморасчетов = 0 И НоваяСтрока.Сумма = 0 Тогда
						РасшифровкаПлатежа.Удалить(НоваяСтрока);
					КонецЕсли;
					
				Иначе
					
					СуммаПоГрафикуВсего = СуммаПоГрафикуВсего + Выборка.СуммаПоГрафику;
					
				КонецЕсли;
				
			КонецЦикла;
			
		КонецЦикла;
	
		Если РасшифровкаПлатежа.Количество() = 0 Тогда
			НоваяСтрока = РасшифровкаПлатежа.Добавить();
			Если ЗначениеЗаполнено(Договор)
				И (ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоДоговорамКонтрагентов
				ИЛИ ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоДоговорамНакладным) Тогда
				
				НоваяСтрока.ОбъектРасчетов = ОбъектыРасчетовСервер.ПолучитьОбъектРасчетовПоСсылке(
					Договор,, Перечисления.ТипыРасчетовСПартнерами.РасчетыСПоставщиком);
				УстановитьПривилегированныйРежим(Истина);
				РеквизитыДоговора = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
					Договор, "Партнер, СтатьяДвиженияДенежныхСредств");
				УстановитьПривилегированныйРежим(Ложь);
				НоваяСтрока.Партнер = РеквизитыДоговора.Партнер;
				НоваяСтрока.СтатьяДвиженияДенежныхСредств = РеквизитыДоговора.СтатьяДвиженияДенежныхСредств;
				Если Не ЗначениеЗаполнено(НоваяСтрока.СтатьяДвиженияДенежныхСредств) Тогда
					НоваяСтрока.СтатьяДвиженияДенежныхСредств = СтатьяДДСПоХО;
				КонецЕсли;
				
			ИначеЕсли ТипЗнч(ЗаказПоставщику) <> Тип("Массив") Тогда
				
				НоваяСтрока.ОбъектРасчетов	= ОбъектыРасчетовСервер.ПолучитьОбъектРасчетовПоСсылке(ЗаказПоставщику,,Перечисления.ТипыРасчетовСПартнерами.РасчетыСПоставщиком);
				Если ЗначениеЗаполнено(НоваяСтрока.ОбъектРасчетов) Тогда
					РеквизитыОбъектаРасчетов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(НоваяСтрока.ОбъектРасчетов, "Партнер, ВалютаВзаиморасчетов");
					ЗаполнитьЗначенияСвойств(НоваяСтрока, РеквизитыОбъектаРасчетов);
				Иначе
					НоваяСтрока.Партнер = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ЗаказПоставщику, "Партнер");
				КонецЕсли;
				Если ЗначениеЗаполнено(Договор) Тогда
					НоваяСтрока.СтатьяДвиженияДенежныхСредств = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Договор, "СтатьяДвиженияДенежныхСредств");
				КонецЕсли;
				Если Не ЗначениеЗаполнено(НоваяСтрока.СтатьяДвиженияДенежныхСредств) Тогда
					НоваяСтрока.СтатьяДвиженияДенежныхСредств = СтатьяДДСПоХО;
				КонецЕсли;
			КонецЕсли;
		
		Иначе
			РасшифровкаПлатежа.Свернуть("ОбъектРасчетов, Партнер, СтатьяДвиженияДенежныхСредств, ВалютаВзаиморасчетов", "Сумма, СуммаВзаиморасчетов");
		КонецЕсли;
		
		ДенежныеСредстваСервер.ЗаполнитьНДСВРасшифровке(РасшифровкаПлатежа,
			ДенежныеСредстваСервер.РасшифровкаПлатежаНДС(Организация, ТекущаяДатаСеанса(), ВалютаДокумента, РасшифровкаПлатежа.ВыгрузитьКолонку("ОбъектРасчетов"), Ложь));
	КонецЕсли;
	
КонецПроцедуры

// Процедура заполнения табличной части "РасшифровкаПлатежа" по возврату поставщику.
//
// Параметры:
//	Объекты - ДокументСсылка, Массив из ДокументСсылка - Документ основание.
//	Организация - СправочникСсылка.Организации - Организация документа.
//	ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа поступления денежных средств.
//	СуммаДокумента - Число - Сумма документа - основания.
//	Партнер - СправочникСсылка.Партнеры - Партнер документа - основания.
//	РасшифровкаПлатежа - ТабличнаяЧасть - Табличная часть документа.
//
Процедура ЗаполнитьРасшифровкуПлатежаПоВозвратуПоставщику(Объекты, Организация, ВалютаДокумента, СуммаДокумента, Партнер, РасшифровкаПлатежа) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если ЗначениеЗаполнено(ВалютаДокумента) Тогда
		
		Запрос = Новый Запрос("ВЫБРАТЬ
		|	ОбъектыРасчетов.Объект КАК Объект,
		|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетов,
		|	ОбъектыРасчетов.Организация КАК Организация,
		|	ОбъектыРасчетов.Договор КАК Договор,
		|	ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(ОбъектыРасчетов.Объект) = ТИП(Справочник.ДоговорыКонтрагентов)
		|			ТОГДА ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств
		|		КОГДА
		|			ЕСТЬNULL(ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств, ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = 
		|				ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
		|			ТОГДА ВЫРАЗИТЬ(ОбъектыРасчетов.Соглашение КАК Справочник.СоглашенияСПоставщиками).СтатьяДвиженияДенежныхСредств
		|		ИНАЧЕ ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств
		|	КОНЕЦ КАК СтатьяДвиженияДенежныхСредств
		|ПОМЕСТИТЬ ВТОбъектыРасчетов
		|ИЗ
		|	Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
		|ГДЕ
		|	ОбъектыРасчетов.Объект В (&Объекты)
		|	И НЕ ОбъектыРасчетов.ПометкаУдаления
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ОбъектыРасчетов.Объект КАК ОснованиеПлатежа,
		|	РасчетыСПоставщиками.ОбъектРасчетов КАК ОбъектРасчетов,
		|	ОбъектыРасчетов.Организация КАК Организация,
		|	ОбъектыРасчетов.СтатьяДвиженияДенежныхСредств КАК СтатьяДвиженияДенежныхСредств,
		|	РасчетыСПоставщиками.Валюта КАК ВалютаВзаиморасчетов,
		|	РасчетыСПоставщиками.КОплатеОстаток КАК СуммаВзаиморасчетов
		|ИЗ
		|	РегистрНакопления.РасчетыСПоставщиками.Остатки(,
		|		ОбъектРасчетов В (ВЫБРАТЬ ОбъектРасчетов ИЗ ВТОбъектыРасчетов)
		|	) КАК РасчетыСПоставщиками
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОбъектыРасчетов КАК ОбъектыРасчетов
		|		ПО ОбъектыРасчетов.ОбъектРасчетов = РасчетыСПоставщиками.ОбъектРасчетов
		|ГДЕ
		|	РасчетыСПоставщиками.КОплатеОстаток > 0
		|");
		
		Запрос.УстановитьПараметр("Объекты", Объекты);
		
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			НоваяСтрока = РасшифровкаПлатежа.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
			НоваяСтрока.Партнер = Партнер;
			
			Сумма = РаботаСКурсамиВалютУТ.ПересчитатьВВалюту(
			        	НоваяСтрока.СуммаВзаиморасчетов,
			        	ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(Выборка.Организация),
			        	Выборка.ВалютаВзаиморасчетов,
			        	ВалютаДокумента,
			        	ТекущаяДатаСеанса(),
			        	Выборка.ОбъектРасчетов);
			
			Если Сумма <= СуммаДокумента Тогда
				НоваяСтрока.Сумма = Сумма;
			Иначе
				НоваяСтрока.Сумма = СуммаДокумента;
				НоваяСтрока.СуммаВзаиморасчетов = 0;
			КонецЕсли;
		КонецЕсли;
		
		ДенежныеСредстваСервер.ЗаполнитьНДСВРасшифровке(РасшифровкаПлатежа,
			ДенежныеСредстваСервер.РасшифровкаПлатежаНДС(Организация, ТекущаяДатаСеанса(), ВалютаДокумента, РасшифровкаПлатежа.ВыгрузитьКолонку("ОбъектРасчетов"), Истина));
	КонецЕсли;
	
КонецПроцедуры

// Процедура заполнения табличной части "РасшифровкаПлатежа" по договору.
//
// Параметры:
//		Договор - СправочникСсылка.ДоговорыКонтрагентов - Договор для получения остатков.
//		ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
//		РасшифровкаПлатежа - ТаблицаЗначений - Таблица для заполнения.
//		Организация - СправочникСсылка.Организации - Необязательное, организация для получения остатков расчетов.
//
Процедура ЗаполнитьРасшифровкуПлатежаПоДоговоруСПоставщиком(Договор, ВалютаДокумента, РасшифровкаПлатежа, Организация) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если ЗначениеЗаполнено(ВалютаДокумента) Тогда
		
		Запрос = Новый Запрос("
		|ВЫБРАТЬ
		|	ЕСТЬNULL(ОбъектыРасчетов.Ссылка, ЗНАЧЕНИЕ(Справочник.ОбъектыРасчетов.ПустаяСсылка)) КАК ОбъектРасчетов,
		|	ЕСТЬNULL(Аналитика.Партнер, ДанныеДоговора.Партнер) КАК Партнер,
		|	ЕСТЬNULL(РасчетыСПоставщикамиОстатки.Валюта, ДанныеДоговора.ВалютаВзаиморасчетов) КАК ВалютаВзаиморасчетов,
		|	ЕСТЬNULL(РасчетыСПоставщикамиОстатки.ОплачиваетсяОстаток - РасчетыСПоставщикамиОстатки.КОплатеОстаток, 0) КАК СуммаВзаиморасчетов
		|ИЗ
		|	Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
		|	ПО
		|		ОбъектыРасчетов.Объект = &Договор
		|		И ОбъектыРасчетов.Организация = &Организация
		|		И НЕ ОбъектыРасчетов.ПометкаУдаления
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		РегистрНакопления.РасчетыСПоставщиками.Остатки(, ОбъектРасчетов.Объект = &Договор) КАК РасчетыСПоставщикамиОстатки
		|	ПО
		|		ИСТИНА
		|		
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|		ПО РасчетыСПоставщикамиОстатки.АналитикаУчетаПоПартнерам = Аналитика.КлючАналитики
		|			И (&Организация = Аналитика.Организация
		|				ИЛИ &Организация = НЕОПРЕДЕЛЕНО)
		|ГДЕ
		|	ДанныеДоговора.Ссылка = &Договор
		|");
		
		Запрос.УстановитьПараметр("Договор", Договор);
		Запрос.УстановитьПараметр("Организация", Организация);
		
		СтатьяДДСПоХО = Справочники.СтатьиДвиженияДенежныхСредств.СтатьяДвиженияДенежныхСредствПоХозяйственнойОперации(
			Перечисления.ХозяйственныеОперации.ОплатаПоставщику);
		
		Выборка = Запрос.Выполнить().Выбрать();
		Выборка.Следующий();
		
		НоваяСтрока = РасшифровкаПлатежа.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
		
		НоваяСтрока.СтатьяДвиженияДенежныхСредств = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Договор, "СтатьяДвиженияДенежныхСредств");
		Если Не ЗначениеЗаполнено(НоваяСтрока.СтатьяДвиженияДенежныхСредств) Тогда
			НоваяСтрока.СтатьяДвиженияДенежныхСредств = СтатьяДДСПоХО;
		КонецЕсли;
		
		НоваяСтрока.Сумма = РаботаСКурсамиВалютУТ.ПересчитатьВВалюту(
		                    	НоваяСтрока.СуммаВзаиморасчетов,
		                    	ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(Организация),
		                    	Выборка.ВалютаВзаиморасчетов,
		                    	ВалютаДокумента,
		                    	ТекущаяДатаСеанса(),
		                    	Выборка.ОбъектРасчетов);
		
		ДенежныеСредстваСервер.ЗаполнитьНДСВРасшифровке(РасшифровкаПлатежа,
			ДенежныеСредстваСервер.РасшифровкаПлатежаНДС(Организация, ТекущаяДатаСеанса(), ВалютаДокумента, РасшифровкаПлатежа.ВыгрузитьКолонку("ОбъектРасчетов"), Ложь));
	КонецЕсли;
	
КонецПроцедуры

// Процедура получает результат запроса по остаткам расчетов с партнером.
//
// Параметры:
//	Организация - СправочникСсылка.Организации - Организация документа.
//	Контрагент - СправочникСсылка.Контрагенты - Контрагент, выбранный в документе.
//	ТипЗадолженности - ПеречислениеСсылка.ТипыЗадолженности - Тип задолженности.
//	ТипРасчетов - ПеречислениеСсылка.ТипыРасчетовСПартнерами - Тип расчетов.
//	Дата - Дата - Дата документа.
//	Валюта - СправочникСсылка.Валюты - Валюта документа.
//	Задолженность - ТаблицаЗначений - Расшифровка платежа документа.
//
Процедура ЗаполнитьЗадолженностьПоОстаткам(Организация, Контрагент, ТипЗадолженности, ТипРасчетов, Дата, Валюта, Задолженность) Экспорт
	
	ТекстРасчетыСКлиентами = 
	"ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.РасчетыСКлиентом) КАК ТипРасчетов,
	|	РегистрАналитикаУчетаПоПартнерам.Партнер КАК Партнер,
	|	РасчетыСКлиентамиОстатки.ОбъектРасчетов КАК ОбъектРасчетов,
	|	РасчетыСКлиентамиОстатки.ОбъектРасчетов.Организация КАК Организация,
	|	РасчетыСКлиентамиОстатки.ОбъектРасчетов.Дата КАК Дата,
	|	РасчетыСКлиентамиОстатки.ОбъектРасчетов.Номер КАК Номер,
	|	РасчетыСКлиентамиОстатки.Валюта КАК ВалютаВзаиморасчетов,
	|	
	|	
	|	ВЫБОР КОГДА РасчетыСКлиентамиОстатки.СуммаОстаток < 0 ТОГДА
	|		-РасчетыСКлиентамиОстатки.СуммаОстаток
	|	ИНАЧЕ
	|		РасчетыСКлиентамиОстатки.СуммаОстаток
	|	КОНЕЦ КАК СуммаВзаиморасчетов,
	|	0 КАК Сумма
	|ИЗ
	|	РегистрНакопления.РасчетыСКлиентами.Остатки(&Граница,
	|		АналитикаУчетаПоПартнерам В (
	|			ВЫБРАТЬ
	|				РегистрАналитикаУчетаПоПартнерам.КлючАналитики КАК АналитикаУчетаПоПартнерам
	|			ИЗ
	|				РегистрСведений.АналитикаУчетаПоПартнерам КАК РегистрАналитикаУчетаПоПартнерам
	|			ГДЕ
	|				РегистрАналитикаУчетаПоПартнерам.Организация = &Организация
	|				И РегистрАналитикаУчетаПоПартнерам.Контрагент = &Контрагент
	|			)
	|		) КАК РасчетыСКлиентамиОстатки
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		РегистрСведений.АналитикаУчетаПоПартнерам КАК РегистрАналитикаУчетаПоПартнерам
	|	ПО 
	|		РасчетыСКлиентамиОстатки.АналитикаУчетаПоПартнерам = РегистрАналитикаУчетаПоПартнерам.КлючАналитики
	|
	|ГДЕ
	|	ВЫБОР КОГДА &ТипЗадолженности = ЗНАЧЕНИЕ(Перечисление.ТипыЗадолженности.Дебиторская)
	|		И РасчетыСКлиентамиОстатки.СуммаОстаток >= 0
	|	ТОГДА
	|		ИСТИНА
	|	КОГДА &ТипЗадолженности = ЗНАЧЕНИЕ(Перечисление.ТипыЗадолженности.Кредиторская)
	|		И РасчетыСКлиентамиОстатки.СуммаОстаток <= 0
	|	ТОГДА
	|		ИСТИНА
	|	ИНАЧЕ
	|		ЛОЖЬ
	|	КОНЕЦ";
	
	ТекстРасчетыСПоставщиками = 
	"ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.РасчетыСПоставщиком) КАК ТипРасчетов,
	|	РегистрАналитикаУчетаПоПартнерам.Партнер КАК Партнер,
	|	РасчетыСПоставщикамиОстатки.ОбъектРасчетов КАК ОбъектРасчетов,
	|	РасчетыСПоставщикамиОстатки.ОбъектРасчетов.Организация КАК Организация,
	|	РасчетыСПоставщикамиОстатки.ОбъектРасчетов.Дата КАК Дата,
	|	РасчетыСПоставщикамиОстатки.ОбъектРасчетов.Номер КАК Номер,
	|	РасчетыСПоставщикамиОстатки.Валюта КАК ВалютаВзаиморасчетов,
	|	
	|	
	|	ВЫБОР КОГДА РасчетыСПоставщикамиОстатки.СуммаОстаток < 0 ТОГДА
	|		-РасчетыСПоставщикамиОстатки.СуммаОстаток
	|	ИНАЧЕ
	|		РасчетыСПоставщикамиОстатки.СуммаОстаток
	|	КОНЕЦ КАК СуммаВзаиморасчетов,
	|	0 КАК Сумма
	|ИЗ
	|	РегистрНакопления.РасчетыСПоставщиками.Остатки(&Граница,
	|		АналитикаУчетаПоПартнерам В (
	|			ВЫБРАТЬ
	|				РегистрАналитикаУчетаПоПартнерам.КлючАналитики КАК АналитикаУчетаПоПартнерам
	|			ИЗ
	|				РегистрСведений.АналитикаУчетаПоПартнерам КАК РегистрАналитикаУчетаПоПартнерам
	|			ГДЕ
	|				РегистрАналитикаУчетаПоПартнерам.Организация = &Организация
	|				И РегистрАналитикаУчетаПоПартнерам.Контрагент = &Контрагент
	|			)
	|		) КАК РасчетыСПоставщикамиОстатки
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		РегистрСведений.АналитикаУчетаПоПартнерам КАК РегистрАналитикаУчетаПоПартнерам
	|	ПО 
	|		РасчетыСПоставщикамиОстатки.АналитикаУчетаПоПартнерам = РегистрАналитикаУчетаПоПартнерам.КлючАналитики
	|
	|ГДЕ
	|	ВЫБОР КОГДА &ТипЗадолженности = ЗНАЧЕНИЕ(Перечисление.ТипыЗадолженности.Дебиторская) 
	|		И РасчетыСПоставщикамиОстатки.СуммаОстаток >= 0
	|	ТОГДА
	|		ИСТИНА
	|	КОГДА &ТипЗадолженности = ЗНАЧЕНИЕ(Перечисление.ТипыЗадолженности.Кредиторская)
	|		И РасчетыСПоставщикамиОстатки.СуммаОстаток <= 0
	|	ТОГДА
	|		ИСТИНА
	|	ИНАЧЕ
	|		ЛОЖЬ
	|	КОНЕЦ";
	
	ТекстЗапроса = "";
	
	Если Не ЗначениеЗаполнено(ТипРасчетов) Тогда
		
		ТекстЗапроса = ТекстРасчетыСКлиентами + "
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|" + ТекстРасчетыСПоставщиками;
		
	ИначеЕсли ТипРасчетов = Перечисления.ТипыРасчетовСПартнерами.РасчетыСКлиентом Тогда
		ТекстЗапроса = ТекстРасчетыСКлиентами;
	Иначе //РасчетыСПоставщиком
		ТекстЗапроса = ТекстРасчетыСПоставщиками;
	КонецЕсли;
	
	ТекстЗапроса = ТекстЗапроса + "
	|
	|УПОРЯДОЧИТЬ ПО
	|	Дата,
	|	Номер
	|";
	
	Запрос = Новый Запрос(ТекстЗапроса);
	
	МоментВремени = КонецДня(Дата);
	Граница = Новый Граница(МоментВремени, ВидГраницы.Включая);
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("Контрагент", Контрагент);
	Запрос.УстановитьПараметр("Граница", Граница);
	Запрос.УстановитьПараметр("ТипЗадолженности", ТипЗадолженности);
	
	Задолженность.Очистить();
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		
		Если ЗначениеЗаполнено(Валюта)
		 И Валюта <> Выборка.ВалютаВзаиморасчетов Тогда
		
			Сумма = РаботаСКурсамиВалютУТ.ПересчитатьВВалюту(
			        	Выборка.СуммаВзаиморасчетов,
			        	ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(Выборка.Организация),
			        	Выборка.ВалютаВзаиморасчетов,
			        	Валюта,
			        	МоментВремени,
			        	Выборка.ОбъектРасчетов);
		
		Иначе
			Сумма = Выборка.СуммаВзаиморасчетов;
		КонецЕсли;
		
		Если Сумма <> 0 Тогда
			НоваяСтрока = Задолженность.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
			НоваяСтрока.Сумма = Сумма;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

// Процедура получает результат запроса по остаткам расчетов с партнером по документам.
//
// Параметры:
//	Организация - СправочникСсылка.Организации - Организация документа.
//	Контрагент - СправочникСсылка.Контрагенты - Контрагент, выбранный в документе.
//	ТипЗадолженности - ПеречислениеСсылка.ТипыЗадолженности - Тип задолженности.
//	ТипРасчетов - ПеречислениеСсылка.ТипыРасчетовСПартнерами - Тип расчетов.
//	Дата - Дата - Дата документа.
//	Валюта - СправочникСсылка.Валюты - Валюта документа.
//	Задолженность - ДанныеФормыКоллекция - Табличная часть документа.
//
Процедура ЗаполнитьЗадолженностьПоОстаткамВзаиморасчетов(Организация, Контрагент, ТипЗадолженности, ТипРасчетов, Дата, Валюта, Задолженность) Экспорт
	
	Задолженность.Очистить();
	
	ТекстВтАналитика = 
	"ВЫБРАТЬ
	|	Организации.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ ВтОрганизации
	|ИЗ
	|	Справочник.Организации КАК Организации
	|ГДЕ
	|	Организации.ГоловнаяОрганизация = &Организация
	|	И Организации.ДопускаютсяВзаиморасчетыЧерезГоловнуюОрганизацию
	|	И Организации.ОбособленноеПодразделение
	|	ИЛИ Организации.Ссылка = &Организация
	|;
	|ВЫБРАТЬ
	|	РегистрАналитикаУчетаПоПартнерам.КлючАналитики КАК АналитикаУчетаПоПартнерам
	|ПОМЕСТИТЬ ВтАналитика
	|ИЗ
	|	РегистрСведений.АналитикаУчетаПоПартнерам КАК РегистрАналитикаУчетаПоПартнерам
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтОрганизации
	|			ПО ВтОрганизации.Ссылка = РегистрАналитикаУчетаПоПартнерам.Организация
	|ГДЕ
	|	РегистрАналитикаУчетаПоПартнерам.Контрагент = &Контрагент
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|";
	
	Если НЕ ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов") Тогда
		
		ТекстРасчетыСКлиентами = 
		
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.РасчетыСКлиентом) КАК ТипРасчетов,
		|	РегистрАналитикаУчетаПоПартнерам.Партнер     КАК Партнер,
		|	РегистрАналитикаУчетаПоПартнерам.Организация КАК Организация,
		|	РасчетыСКлиентамиОстатки.ЗаказКлиента        КАК ОбъектРасчетов,
		|	РасчетыСКлиентамиОстатки.Валюта              КАК ВалютаВзаиморасчетов,
		|	РасчетыСКлиентамиОстатки.РасчетныйДокумент КАК РасчетныйДокумент,
		|	
		|	ВЫБОР КОГДА РасчетыСКлиентамиОстатки.ДолгОстаток + РасчетыСКлиентамиОстатки.ПредоплатаОстаток < 0 ТОГДА
		|		-(РасчетыСКлиентамиОстатки.ДолгОстаток + РасчетыСКлиентамиОстатки.ПредоплатаОстаток)
		|	ИНАЧЕ
		|		РасчетыСКлиентамиОстатки.ДолгОстаток + РасчетыСКлиентамиОстатки.ПредоплатаОстаток
		|	КОНЕЦ КАК СуммаВзаиморасчетов,
		|
		|	ВЫБОР КОГДА РасчетыСКлиентамиОстатки.ДолгРеглОстаток + РасчетыСКлиентамиОстатки.ПредоплатаРеглОстаток < 0 ТОГДА
		|		-(РасчетыСКлиентамиОстатки.ДолгРеглОстаток + РасчетыСКлиентамиОстатки.ПредоплатаРеглОстаток)
		|	ИНАЧЕ
		|		РасчетыСКлиентамиОстатки.ДолгРеглОстаток + РасчетыСКлиентамиОстатки.ПредоплатаРеглОстаток
		|	КОНЕЦ КАК СуммаРегл,
		|
		|	ВЫБОР КОГДА РасчетыСКлиентамиОстатки.ДолгУпрОстаток + РасчетыСКлиентамиОстатки.ПредоплатаУпрОстаток < 0 ТОГДА
		|		-(РасчетыСКлиентамиОстатки.ДолгУпрОстаток + РасчетыСКлиентамиОстатки.ПредоплатаУпрОстаток)
		|	ИНАЧЕ
		|		РасчетыСКлиентамиОстатки.ДолгУпрОстаток + РасчетыСКлиентамиОстатки.ПредоплатаУпрОстаток
		|	КОНЕЦ КАК СуммаУпр
		|
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентамиПоДокументам.Остатки(&Граница,
		|		АналитикаУчетаПоПартнерам В (
		|			ВЫБРАТЬ
		|				ВтАналитика.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам
		|			ИЗ
		|				ВтАналитика КАК ВтАналитика)
		|		) КАК РасчетыСКлиентамиОстатки
		|	ЛЕВОЕ СОЕДИНЕНИЕ 
		|		РегистрСведений.АналитикаУчетаПоПартнерам КАК РегистрАналитикаУчетаПоПартнерам
		|	ПО 
		|		РасчетыСКлиентамиОстатки.АналитикаУчетаПоПартнерам = РегистрАналитикаУчетаПоПартнерам.КлючАналитики
		|
		|ГДЕ
		|	ВЫБОР КОГДА &ТипЗадолженности = ЗНАЧЕНИЕ(Перечисление.ТипыЗадолженности.Дебиторская)
		|		И (РасчетыСКлиентамиОстатки.ДолгОстаток > 0 ИЛИ РасчетыСКлиентамиОстатки.ПредоплатаОстаток > 0)
		|	ТОГДА
		|		ИСТИНА
		|	КОГДА &ТипЗадолженности = ЗНАЧЕНИЕ(Перечисление.ТипыЗадолженности.Кредиторская)
		|		И (РасчетыСКлиентамиОстатки.ДолгОстаток < 0 ИЛИ РасчетыСКлиентамиОстатки.ПредоплатаОстаток < 0)
		|	ТОГДА
		|		ИСТИНА
		|	ИНАЧЕ
		|		ЛОЖЬ
		|	КОНЕЦ";
		
		ТекстРасчетыСПоставщиками = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.РасчетыСПоставщиком) КАК ТипРасчетов,
		|	РегистрАналитикаУчетаПоПартнерам.Партнер     КАК Партнер,
		|	РегистрАналитикаУчетаПоПартнерам.Организация КАК Организация,
		|	РасчетыСПоставщикамиОстатки.ЗаказПоставщику  КАК ОбъектРасчетов,
		|	РасчетыСПоставщикамиОстатки.Валюта           КАК ВалютаВзаиморасчетов,
		|	РасчетыСПоставщикамиОстатки.РасчетныйДокумент КАК РасчетныйДокумент,
		|	
		|	ВЫБОР КОГДА РасчетыСПоставщикамиОстатки.ДолгОстаток + РасчетыСПоставщикамиОстатки.ПредоплатаОстаток < 0 ТОГДА
		|		-(РасчетыСПоставщикамиОстатки.ДолгОстаток + РасчетыСПоставщикамиОстатки.ПредоплатаОстаток)
		|	ИНАЧЕ
		|		РасчетыСПоставщикамиОстатки.ДолгОстаток + РасчетыСПоставщикамиОстатки.ПредоплатаОстаток
		|	КОНЕЦ КАК СуммаВзаиморасчетов,
		|	
		|	ВЫБОР КОГДА РасчетыСПоставщикамиОстатки.ДолгРеглОстаток + РасчетыСПоставщикамиОстатки.ПредоплатаРеглОстаток < 0 ТОГДА
		|		-(РасчетыСПоставщикамиОстатки.ДолгРеглОстаток + РасчетыСПоставщикамиОстатки.ПредоплатаРеглОстаток)
		|	ИНАЧЕ
		|		РасчетыСПоставщикамиОстатки.ДолгРеглОстаток + РасчетыСПоставщикамиОстатки.ПредоплатаРеглОстаток
		|	КОНЕЦ КАК СуммаРегл,
		|
		|	ВЫБОР КОГДА РасчетыСПоставщикамиОстатки.ДолгУпрОстаток + РасчетыСПоставщикамиОстатки.ПредоплатаУпрОстаток < 0 ТОГДА
		|		-(РасчетыСПоставщикамиОстатки.ДолгУпрОстаток + РасчетыСПоставщикамиОстатки.ПредоплатаУпрОстаток)
		|	ИНАЧЕ
		|		РасчетыСПоставщикамиОстатки.ДолгУпрОстаток + РасчетыСПоставщикамиОстатки.ПредоплатаУпрОстаток
		|	КОНЕЦ КАК СуммаУпр
		|ИЗ
		|	РегистрНакопления.РасчетыСПоставщикамиПоДокументам.Остатки(&Граница,
		|		АналитикаУчетаПоПартнерам В (
		|			ВЫБРАТЬ
		|				ВтАналитика.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам
		|			ИЗ
		|				ВтАналитика КАК ВтАналитика)
		|		) КАК РасчетыСПоставщикамиОстатки
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ 
		|		РегистрСведений.АналитикаУчетаПоПартнерам КАК РегистрАналитикаУчетаПоПартнерам
		|	ПО 
		|		РасчетыСПоставщикамиОстатки.АналитикаУчетаПоПартнерам = РегистрАналитикаУчетаПоПартнерам.КлючАналитики
		|
		|ГДЕ
		|	ВЫБОР КОГДА &ТипЗадолженности = ЗНАЧЕНИЕ(Перечисление.ТипыЗадолженности.Дебиторская) 
		|		И (РасчетыСПоставщикамиОстатки.ДолгОстаток > 0 ИЛИ РасчетыСПоставщикамиОстатки.ПредоплатаОстаток > 0)
		|	ТОГДА
		|		ИСТИНА
		|	КОГДА &ТипЗадолженности = ЗНАЧЕНИЕ(Перечисление.ТипыЗадолженности.Кредиторская)
		|		И (РасчетыСПоставщикамиОстатки.ДолгОстаток < 0 ИЛИ РасчетыСПоставщикамиОстатки.ПредоплатаОстаток < 0)
		|	ТОГДА
		|		ИСТИНА
		|	ИНАЧЕ
		|		ЛОЖЬ
		|	КОНЕЦ";
		
		ТекстЗапроса = "";
		
		Если Не ЗначениеЗаполнено(ТипРасчетов) Тогда
			
			ТекстЗапроса = ТекстВтАналитика + ТекстРасчетыСКлиентами + "
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|" + ТекстРасчетыСПоставщиками;
			
		ИначеЕсли ТипРасчетов = Перечисления.ТипыРасчетовСПартнерами.РасчетыСКлиентом Тогда
			ТекстЗапроса = ТекстВтАналитика + ТекстРасчетыСКлиентами;
		Иначе
			ТекстЗапроса = ТекстВтАналитика + ТекстРасчетыСПоставщиками;
		КонецЕсли;
		
		Запрос = Новый Запрос(ТекстЗапроса);
		
		МоментВремени = КонецДня(Дата);
		Граница = Новый Граница(МоментВремени, ВидГраницы.Включая);
		Запрос.УстановитьПараметр("Организация", Организация);
		Запрос.УстановитьПараметр("Контрагент", Контрагент);
		Запрос.УстановитьПараметр("Граница", Граница);
		Запрос.УстановитьПараметр("ТипЗадолженности", ТипЗадолженности);
		
	Иначе
		
		ТекстРасчетыСКлиентами = "
			|ВЫБРАТЬ РАЗРЕШЕННЫЕ
			|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.РасчетыСКлиентом) КАК ТипРасчетов,
			|	РегистрАналитикаУчетаПоПартнерам.Партнер     КАК Партнер,
			|	РегистрАналитикаУчетаПоПартнерам.Организация КАК Организация,
			|	РасчетыСКлиентамиОстатки.ОбъектРасчетов      КАК ОбъектРасчетов,
			|	РасчетыСКлиентамиОстатки.Валюта              КАК ВалютаВзаиморасчетов,
			|	
			|	РасчетыСКлиентамиОстатки.ДолгОстаток + РасчетыСКлиентамиОстатки.ПредоплатаОстаток КАК СуммаВзаиморасчетов,
			|	РасчетыСКлиентамиОстатки.ДолгРеглОстаток + РасчетыСКлиентамиОстатки.ПредоплатаРеглОстаток КАК СуммаРегл,
			|	РасчетыСКлиентамиОстатки.ДолгУпрОстаток + РасчетыСКлиентамиОстатки.ПредоплатаУпрОстаток КАК СуммаУпр
			|ИЗ
			|	РегистрНакопления.РасчетыСКлиентамиПоСрокам.Остатки(&Граница,
			|		&Валюта
			|		И АналитикаУчетаПоПартнерам В (
			|			ВЫБРАТЬ
			|				ВтАналитика.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам
			|			ИЗ
			|				ВтАналитика КАК ВтАналитика)
			|		) КАК РасчетыСКлиентамиОстатки
			|	ЛЕВОЕ СОЕДИНЕНИЕ 
			|		РегистрСведений.АналитикаУчетаПоПартнерам КАК РегистрАналитикаУчетаПоПартнерам
			|	ПО
			|		РасчетыСКлиентамиОстатки.АналитикаУчетаПоПартнерам = РегистрАналитикаУчетаПоПартнерам.КлючАналитики
			|ГДЕ
			|	ВЫБОР КОГДА &ТипЗадолженности = ЗНАЧЕНИЕ(Перечисление.ТипыЗадолженности.Дебиторская)
			|		И РасчетыСКлиентамиОстатки.ДолгОстаток > 0
			|	ТОГДА
			|		ИСТИНА
			|	КОГДА &ТипЗадолженности = ЗНАЧЕНИЕ(Перечисление.ТипыЗадолженности.Кредиторская)
			|		И РасчетыСКлиентамиОстатки.ПредоплатаОстаток > 0
			|	ТОГДА
			|		ИСТИНА
			|	ИНАЧЕ
			|		ЛОЖЬ
			|	КОНЕЦ";
		
		ТекстРасчетыСПоставщиками = "
			|ВЫБРАТЬ РАЗРЕШЕННЫЕ
			|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.РасчетыСПоставщиком) КАК ТипРасчетов,
			|	РегистрАналитикаУчетаПоПартнерам.Партнер          КАК Партнер,
			|	РегистрАналитикаУчетаПоПартнерам.Организация      КАК Организация,
			|	РасчетыСПоставщикамиОстатки.ОбъектРасчетов   КАК ОбъектРасчетов,
			|	РасчетыСПоставщикамиОстатки.Валюта           КАК ВалютаВзаиморасчетов,
			|	
			|	РасчетыСПоставщикамиОстатки.ДолгОстаток + РасчетыСПоставщикамиОстатки.ПредоплатаОстаток КАК СуммаВзаиморасчетов,
			|	РасчетыСПоставщикамиОстатки.ДолгРеглОстаток + РасчетыСПоставщикамиОстатки.ПредоплатаРеглОстаток КАК СуммаРегл,
			|	РасчетыСПоставщикамиОстатки.ДолгУпрОстаток + РасчетыСПоставщикамиОстатки.ПредоплатаУпрОстаток КАК СуммаУпр
			|ИЗ
			|	РегистрНакопления.РасчетыСПоставщикамиПоСрокам.Остатки(&Граница,
			|		&Валюта
			|		И АналитикаУчетаПоПартнерам В (
			|			ВЫБРАТЬ
			|				ВтАналитика.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам
			|			ИЗ
			|				ВтАналитика КАК ВтАналитика)
			|		) КАК РасчетыСПоставщикамиОстатки
			|	ЛЕВОЕ СОЕДИНЕНИЕ 
			|		РегистрСведений.АналитикаУчетаПоПартнерам КАК РегистрАналитикаУчетаПоПартнерам
			|	ПО
			|		РасчетыСПоставщикамиОстатки.АналитикаУчетаПоПартнерам = РегистрАналитикаУчетаПоПартнерам.КлючАналитики
			|ГДЕ
			|	ВЫБОР КОГДА &ТипЗадолженности = ЗНАЧЕНИЕ(Перечисление.ТипыЗадолженности.Дебиторская) 
			|		И РасчетыСПоставщикамиОстатки.ПредоплатаОстаток > 0
			|	ТОГДА
			|		ИСТИНА
			|	КОГДА &ТипЗадолженности = ЗНАЧЕНИЕ(Перечисление.ТипыЗадолженности.Кредиторская)
			|		И РасчетыСПоставщикамиОстатки.ДолгОстаток > 0
			|	ТОГДА
			|		ИСТИНА
			|	ИНАЧЕ
			|		ЛОЖЬ
			|	КОНЕЦ";
		
		Запрос     = Новый Запрос;
		
		МоментВремени = КонецДня(Дата);
		Граница = Новый Граница(МоментВремени, ВидГраницы.Включая);
		Запрос.УстановитьПараметр("Организация", Организация);
		Запрос.УстановитьПараметр("Контрагент", Контрагент);
		Запрос.УстановитьПараметр("Граница", Граница);
		Запрос.УстановитьПараметр("ТипЗадолженности", ТипЗадолженности);
		Запрос.УстановитьПараметр("Валюта", Валюта);
		
		Если Не ЗначениеЗаполнено(ТипРасчетов) Тогда
			ТекстЗапроса = ТекстВтАналитика + ТекстРасчетыСКлиентами + "
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|" + ТекстРасчетыСПоставщиками;
		ИначеЕсли ТипРасчетов = Перечисления.ТипыРасчетовСПартнерами.РасчетыСКлиентом Тогда
			ТекстЗапроса =  ТекстВтАналитика + ТекстРасчетыСКлиентами;
		Иначе
			ТекстЗапроса = ТекстВтАналитика + ТекстРасчетыСПоставщиками;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Валюта) Тогда
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&Валюта", "Валюта = &Валюта");
		Иначе
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&Валюта", "ИСТИНА");
		КонецЕсли;
		
		Запрос.Текст = ТекстЗапроса;
		
	КонецЕсли;
	
	Остатки = Запрос.Выполнить().Выгрузить();
	Остатки.Свернуть("ТипРасчетов, Партнер, Организация, ОбъектРасчетов, ВалютаВзаиморасчетов","СуммаВзаиморасчетов, СуммаРегл, СуммаУпр");
	
	Для Каждого СтрокаОстатков Из Остатки Цикл
		
		НоваяСтрока = Задолженность.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаОстатков);
		
	КонецЦикла;
	
КонецПроцедуры

// Пересчитывает суммы расшифровки платежа в выбранную валюту.
//
// Параметры:
//		Объект - ДокументОбъект - Документ для пересчета суммы.
//		СуммаВсего - Число - Сумма документа.
//
Процедура ПересчитатьСуммыВВалютуРасшифровкаПлатежа(Объект, СуммаВсего) Экспорт
	
	СуммаДокумента = СуммаВсего;
	ИтогСумма = Объект.РасшифровкаПлатежа.Итог("Сумма");
	
	// Пересчитаем суммы в табличной части документа.
	Если ИтогСумма <> 0 Тогда
		
		Для Каждого СтрокаТаблицы Из Объект.РасшифровкаПлатежа Цикл
			
			Сумма = Окр(СуммаДокумента * СтрокаТаблицы.Сумма / ИтогСумма, 2, 1);
			ИтогСумма = ИтогСумма - СтрокаТаблицы.Сумма;
			СуммаДокумента = СуммаДокумента - Сумма;
			СтрокаТаблицы.Сумма = Сумма;
			
			Если ЗначениеЗаполнено(СтрокаТаблицы.ОбъектРасчетов) Тогда
				Если СтрокаТаблицы.ВалютаВзаиморасчетов = Объект.Валюта Тогда
					СтрокаТаблицы.СуммаВзаиморасчетов = 0;
				КонецЕсли;
			Иначе
				СтрокаТаблицы.ВалютаВзаиморасчетов = Неопределено;
				СтрокаТаблицы.СуммаВзаиморасчетов = 0;
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

// Функция определяет порядок оплаты в иностранной валюте.
//
// Параметры:
//  ВалютаОплаты - СправочникСсылка.Валюты - Необязательное, валюта предполагаемой оплаты.
//  Организация - СправочникСсылка.Организации - Необязательное, определяет валюту регламентированного учета.
//
// Возвращаемое значение:
//  Булево - оплата производится в иностранной валюте.
//
Функция ПолучитьОплатуВВалютеПоУмолчанию(Знач ВалютаОплаты = Неопределено, Знач Организация = Неопределено) Экспорт
	
	Если ЗначениеЗаполнено(Организация) Тогда
		ВалютаРегламентированногоУчета = ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(Организация);
	Иначе
		ВалютаРегламентированногоУчета = ЗначениеНастроекПовтИсп.БазоваяВалютаПоУмолчанию();
	КонецЕсли;
	Если НЕ ЗначениеЗаполнено(ВалютаОплаты) Тогда
		ВалютаОплаты = ВалютаРегламентированногоУчета;
	КонецЕсли;
	
	Если НЕ ВалютаОплаты = ВалютаРегламентированногоУчета Тогда
		ОплатаВВалюте = Истина;
	Иначе
		ОплатаВВалюте = Ложь;
	КонецЕсли;
	
	Возврат ОплатаВВалюте;
	
КонецФункции

#КонецОбласти

#Область ПроцедурыИФункцииФормированияДвиженийПоРасчетамСКонтрагентами

// Процедура заполняет сумму взаиморасчетов в табличной части "Расшифровка платежка"
// в документах движения денежных средств.
//
// Параметры:
//	Валюта - СправочникСсылка.Валюты - Валюта, указанная в документе.
//	Дата - Дата - Дата документа.
//	ТабличнаяЧасть - ТабличнаяЧасть - Табличная часть документа.
//	Организация - СправочникСсылка.Организации - Организация документа. Определяет базовую валюту получения курсов.
Процедура ЗаполнитьСуммуВзаиморасчетовВТабличнойЧасти(Валюта, Дата, ТабличнаяЧасть, Организация) Экспорт
	
	// Если табличная часть пустая или в табличной части заполнена сумма взаиморасчетов,
	// то выполнение процедуры не требуется.
	Если (ТабличнаяЧасть.Количество() = 0
	 ИЛИ ТабличнаяЧасть.Найти(0, "СуммаВзаиморасчетов") = Неопределено)
	 И ТабличнаяЧасть.Найти(Справочники.Валюты.ПустаяСсылка(), "ВалютаВзаиморасчетов") = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	
	Запрос = Новый Запрос("
	|ВЫБРАТЬ
	|	*
	|ПОМЕСТИТЬ ИсходнаяТаблицаДокумента
	|ИЗ
	|	&ТаблицаДокумента КАК ТаблицаДокумента
	|ГДЕ
	|	ТаблицаДокумента.СуммаВзаиморасчетов = 0
	|	ИЛИ ТаблицаДокумента.ВалютаВзаиморасчетов = ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка)
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Таблица.*,
	|	Таблица.Валюта КАК Валюта,
	|	Таблица.ОбъектРасчетов КАК ОбъектРасчетов,
	|		
	|	ВЫБОР КОГДА Таблица.Партнер = ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка) ТОГДА
	|		Таблица.ОбъектРасчетов.Партнер
	|	ИНАЧЕ
	|		Таблица.Партнер
	|	КОНЕЦ КАК Партнер,
	|	
	|	ВЫБОР КОГДА Таблица.ВалютаВзаиморасчетов <> ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка) ТОГДА
	|		Таблица.ВалютаВзаиморасчетов
	|	ИНАЧЕ
	|		ВЫБОР КОГДА Таблица.ОбъектРасчетов <> ЗНАЧЕНИЕ(Справочник.ОбъектыРасчетов.ПустаяСсылка) ТОГДА
	|			Таблица.ОбъектРасчетов.ВалютаВзаиморасчетов
	|		ИНАЧЕ
	|			&Валюта
	|		КОНЕЦ
	|	КОНЕЦ КАК ВалютаВзаиморасчетов
	|	
	|ПОМЕСТИТЬ ТаблицаДокумента
	|ИЗ
	|	ИсходнаяТаблицаДокумента КАК Таблица
	|;
	|
	|//////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КурсДоговора.Период КАК Период,
	|	КурсДоговора.Договор КАК Договор,
	|	КурсДоговора.КурсЧислитель КАК КурсЧислитель,
	|	КурсДоговора.КурсЗнаменатель КАК КурсЗнаменатель
	|ПОМЕСТИТЬ втКурсыДоговоров
	|ИЗ
	|	РегистрСведений.КурсыВалютРасчетовПоДоговорам.СрезПоследних(&Дата) КАК КурсДоговора
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаДокумента.ОбъектРасчетов КАК ОбъектРасчетов,
	|	ВЫБОР
	|		КОГДА ОбъектыРасчетов.ТипОбъектаРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыОбъектовРасчетов.Накладная)
	|				И ЕСТЬNULL(ОбъектыРасчетов.Договор.ВариантКурсаДоговора, ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.Переменный)) = ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.ФиксированныйНаДатуОтгрузки)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.ФиксированныйНаДатуОтгрузки)
	|		ИНАЧЕ ЕСТЬNULL(ОбъектыРасчетов.Договор.ВариантКурсаДоговора, ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.Переменный))
	|	КОНЕЦ КАК ВариантКурсаДоговора,
	|	ОбъектыРасчетов.ТипОбъектаРасчетов КАК ТипОбъектаРасчетов,
	|	КурсыДокументов.КурсЧислительВалютыВзаиморасчетов КАК КурсЧислительВалютыВзаиморасчетов,
	|	КурсыДокументов.КурсЗнаменательВалютыВзаиморасчетов КАК КурсЗнаменательВалютыВзаиморасчетов,
	|	КурсыДокументов.КурсЧислительВалютыУправленческогоУчета КАК КурсЧислительВалютыУправленческогоУчета,
	|	КурсыДокументов.КурсЗнаменательВалютыУправленческогоУчета КАК КурсЗнаменательВалютыУправленческогоУчета,
	|	КурсыДокументов.КурсЧислительВалютыДокумента КАК КурсЧислительВалютыДокумента,
	|	КурсыДокументов.КурсЗнаменательВалютыДокумента КАК КурсЗнаменательВалютыДокумента,
	|	КурсыДокументов.ВалютаДокумента КАК ВалютаДокумента,
	|	ОбъектыРасчетов.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
	|	ОбъектыРасчетов.Организация.ВалютаРегламентированногоУчета КАК ВалютаРегламентированногоУчета,
	|	ОбъектыРасчетов.Дата КАК Дата,
	|	ЕСТЬNULL(КурсыДоговоров.Период, ДАТАВРЕМЯ(1, 1, 1)) КАК ПериодКурсаДоговора,
	|	КурсыДоговоров.КурсЧислитель КАК КурсЧислительВалютыДоговора,
	|	КурсыДоговоров.КурсЗнаменатель КАК КурсЗнаменательВалютыДоговора
	|ПОМЕСТИТЬ ДанныеОбъектаРасчетов
	|ИЗ
	|	ТаблицаДокумента КАК ТаблицаДокумента
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
	|		Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов 
	|		ПО ТаблицаДокумента.ОбъектРасчетов = ОбъектыРасчетов.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ВалютыИКурсыДокументов КАК КурсыДокументов
	|		ПО ОбъектыРасчетов.Объект = КурсыДокументов.Документ
	|		ЛЕВОЕ СОЕДИНЕНИЕ втКурсыДоговоров КАК КурсыДоговоров
	|		ПО ОбъектыРасчетов.Договор = КурсыДоговоров.Договор
	|ГДЕ 
	|	ТаблицаДокумента.СуммаВзаиморасчетов = 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ 
	|	КурсыВалют.ОбъектРасчетов КАК ОбъектРасчетов,
	|	КурсыВалют.ВалютаДокумента КАК Валюта,
	|	КурсыВалют.БазоваяВалюта КАК БазоваяВалюта,
	|	КурсыВалют.ДатаКурса КАК ДатаКурса,
	|	МАКСИМУМ(КурсыВалют.КурсЧислитель) КАК КурсЧислитель,
	|	МАКСИМУМ(КурсыВалют.КурсЗнаменатель) КАК КурсЗнаменатель
	|ПОМЕСТИТЬ ВтКурсыВалют
	|ИЗ (
	|	ВЫБРАТЬ 
	|		ДанныеОбъектаРасчетов.ОбъектРасчетов КАК ОбъектРасчетов,
	|		ДанныеОбъектаРасчетов.ВалютаДокумента КАК ВалютаДокумента,
	|		ДанныеОбъектаРасчетов.ВалютаРегламентированногоУчета КАК БазоваяВалюта,
	|		ДанныеОбъектаРасчетов.Дата КАК ДатаКурса,
	|		ДанныеОбъектаРасчетов.КурсЧислительВалютыДокумента КАК КурсЧислитель,
	|		ДанныеОбъектаРасчетов.КурсЗнаменательВалютыДокумента КАК КурсЗнаменатель
	|	ИЗ
	|		ДанныеОбъектаРасчетов КАК ДанныеОбъектаРасчетов
	|	ГДЕ
	|		ДанныеОбъектаРасчетов.ВариантКурсаДоговора = ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.ФиксированныйНаДатуОтгрузки)
	|		И ДанныеОбъектаРасчетов.ТипОбъектаРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыОбъектовРасчетов.Накладная)
	|		И ДанныеОбъектаРасчетов.ВалютаДокумента = &Валюта
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДанныеОбъектаРасчетов.ОбъектРасчетов КАК ОбъектРасчетов,
	|		ДанныеОбъектаРасчетов.ВалютаДокумента КАК Валюта,
	|		ДанныеОбъектаРасчетов.ВалютаРегламентированногоУчета КАК БазоваяВалюта,
	|		ДанныеОбъектаРасчетов.Дата КАК ДатаКурса,
	|		ДанныеОбъектаРасчетов.КурсЧислительВалютыДокумента КАК КурсЧислитель,
	|		ДанныеОбъектаРасчетов.КурсЗнаменательВалютыДокумента КАК КурсЗнаменатель
	|	ИЗ
	|		ДанныеОбъектаРасчетов КАК ДанныеОбъектаРасчетов
	|	ГДЕ
	|		ДанныеОбъектаРасчетов.ВариантКурсаДоговора = ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.ФиксированныйНаДатуОтгрузки)
	|		И ДанныеОбъектаРасчетов.ТипОбъектаРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыОбъектовРасчетов.Накладная)
	|		И ДанныеОбъектаРасчетов.ВалютаДокумента В (ВЫБРАТЬ Т.ВалютаВзаиморасчетов ИЗ ТаблицаДокумента КАК Т)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДанныеОбъектаРасчетов.ОбъектРасчетов КАК ОбъектРасчетов,
	|		ДанныеОбъектаРасчетов.ВалютаДокумента КАК Валюта,
	|		ДанныеОбъектаРасчетов.ВалютаРегламентированногоУчета КАК БазоваяВалюта,
	|		ДанныеОбъектаРасчетов.Дата КАК ДатаКурса,
	|		ДанныеОбъектаРасчетов.КурсЧислительВалютыДокумента КАК КурсЧислитель,
	|		ДанныеОбъектаРасчетов.КурсЗнаменательВалютыДокумента КАК КурсЗнаменатель
	|	ИЗ
	|		ДанныеОбъектаРасчетов КАК ДанныеОбъектаРасчетов
	|	ГДЕ
	|		ДанныеОбъектаРасчетов.ВариантКурсаДоговора = ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.ФиксированныйНаДатуОтгрузки)
	|		И ДанныеОбъектаРасчетов.ТипОбъектаРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыОбъектовРасчетов.Накладная)
	|		И ДанныеОбъектаРасчетов.ВалютаДокумента В (ВЫБРАТЬ Т.Валюта ИЗ ТаблицаДокумента КАК Т)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДанныеОбъектаРасчетов.ОбъектРасчетов КАК ОбъектРасчетов,
	|		ДанныеОбъектаРасчетов.ВалютаВзаиморасчетов,
	|		ДанныеОбъектаРасчетов.ВалютаРегламентированногоУчета,
	|		ДанныеОбъектаРасчетов.Дата,
	|		ДанныеОбъектаРасчетов.КурсЧислительВалютыВзаиморасчетов,
	|		ДанныеОбъектаРасчетов.КурсЗнаменательВалютыВзаиморасчетов
	|	ИЗ
	|		ДанныеОбъектаРасчетов КАК ДанныеОбъектаРасчетов
	|	ГДЕ
	|		ДанныеОбъектаРасчетов.ВариантКурсаДоговора = ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.ФиксированныйНаДатуОтгрузки)
	|		И ДанныеОбъектаРасчетов.ТипОбъектаРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыОбъектовРасчетов.Накладная)
	|		И ДанныеОбъектаРасчетов.ВалютаВзаиморасчетов = &Валюта
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДанныеОбъектаРасчетов.ОбъектРасчетов КАК ОбъектРасчетов,
	|		ДанныеОбъектаРасчетов.ВалютаВзаиморасчетов,
	|		ДанныеОбъектаРасчетов.ВалютаРегламентированногоУчета,
	|		ДанныеОбъектаРасчетов.Дата,
	|		ДанныеОбъектаРасчетов.КурсЧислительВалютыВзаиморасчетов,
	|		ДанныеОбъектаРасчетов.КурсЗнаменательВалютыВзаиморасчетов
	|	ИЗ
	|		ДанныеОбъектаРасчетов КАК ДанныеОбъектаРасчетов
	|	ГДЕ
	|		ДанныеОбъектаРасчетов.ВариантКурсаДоговора = ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.ФиксированныйНаДатуОтгрузки)
	|		И ДанныеОбъектаРасчетов.ТипОбъектаРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыОбъектовРасчетов.Накладная)
	|		И ДанныеОбъектаРасчетов.ВалютаВзаиморасчетов В (ВЫБРАТЬ Т.ВалютаВзаиморасчетов ИЗ ТаблицаДокумента КАК Т)
	|	
	|		ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|			ДанныеОбъектаРасчетов.ОбъектРасчетов КАК ОбъектРасчетов,
	|		ДанныеОбъектаРасчетов.ВалютаВзаиморасчетов,
	|		ДанныеОбъектаРасчетов.ВалютаРегламентированногоУчета,
	|		ДанныеОбъектаРасчетов.Дата,
	|		ДанныеОбъектаРасчетов.КурсЧислительВалютыВзаиморасчетов,
	|		ДанныеОбъектаРасчетов.КурсЗнаменательВалютыВзаиморасчетов
	|		ИЗ
	|		ДанныеОбъектаРасчетов КАК ДанныеОбъектаРасчетов
	|	ГДЕ
	|		ДанныеОбъектаРасчетов.ВариантКурсаДоговора = ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.ФиксированныйНаДатуОтгрузки)
	|		И ДанныеОбъектаРасчетов.ТипОбъектаРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыОбъектовРасчетов.Накладная)
	|		И ДанныеОбъектаРасчетов.ВалютаВзаиморасчетов В (ВЫБРАТЬ Т.Валюта ИЗ ТаблицаДокумента КАК Т)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДанныеОбъектаРасчетов.ОбъектРасчетов КАК ОбъектРасчетов,
	|		&ВалютаУпр,
	|		ДанныеОбъектаРасчетов.ВалютаРегламентированногоУчета,
	|		ДанныеОбъектаРасчетов.Дата,
	|		ДанныеОбъектаРасчетов.КурсЧислительВалютыУправленческогоУчета,
	|		ДанныеОбъектаРасчетов.КурсЗнаменательВалютыУправленческогоУчета
	|	ИЗ
	|		ДанныеОбъектаРасчетов КАК ДанныеОбъектаРасчетов
	|	ГДЕ
	|		ДанныеОбъектаРасчетов.ВариантКурсаДоговора = ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.ФиксированныйНаДатуОтгрузки)
	|		И ДанныеОбъектаРасчетов.ТипОбъектаРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыОбъектовРасчетов.Накладная)
	|		И &ВалютаУпр = &Валюта
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДанныеОбъектаРасчетов.ОбъектРасчетов КАК ОбъектРасчетов,
	|		&ВалютаУпр,
	|		ДанныеОбъектаРасчетов.ВалютаРегламентированногоУчета,
	|		ДанныеОбъектаРасчетов.Дата,
	|		ДанныеОбъектаРасчетов.КурсЧислительВалютыУправленческогоУчета,
	|		ДанныеОбъектаРасчетов.КурсЗнаменательВалютыУправленческогоУчета
	|	ИЗ
	|		ДанныеОбъектаРасчетов КАК ДанныеОбъектаРасчетов
	|	ГДЕ
	|		ДанныеОбъектаРасчетов.ВариантКурсаДоговора = ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.ФиксированныйНаДатуОтгрузки)
	|		И ДанныеОбъектаРасчетов.ТипОбъектаРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыОбъектовРасчетов.Накладная)
	|		И &ВалютаУпр В (ВЫБРАТЬ Т.ВалютаВзаиморасчетов ИЗ ТаблицаДокумента КАК Т)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДанныеОбъектаРасчетов.ОбъектРасчетов КАК ОбъектРасчетов,
	|		&ВалютаУпр,
	|		ДанныеОбъектаРасчетов.ВалютаРегламентированногоУчета,
	|		ДанныеОбъектаРасчетов.Дата,
	|		ДанныеОбъектаРасчетов.КурсЧислительВалютыУправленческогоУчета,
	|		ДанныеОбъектаРасчетов.КурсЗнаменательВалютыУправленческогоУчета
	|	ИЗ
	|		ДанныеОбъектаРасчетов КАК ДанныеОбъектаРасчетов
	|	ГДЕ
	|		ДанныеОбъектаРасчетов.ВариантКурсаДоговора = ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.ФиксированныйНаДатуОтгрузки)
	|		И ДанныеОбъектаРасчетов.ТипОбъектаРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыОбъектовРасчетов.Накладная)
	|		И &ВалютаУпр В (ВЫБРАТЬ Т.Валюта ИЗ ТаблицаДокумента КАК Т)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДанныеОбъектаРасчетов.ОбъектРасчетов КАК ОбъектРасчетов,
	|		ДанныеОбъектаРасчетов.ВалютаВзаиморасчетов,
	|		ДанныеОбъектаРасчетов.ВалютаРегламентированногоУчета,
	|		ДанныеОбъектаРасчетов.ПериодКурсаДоговора,
	|		ДанныеОбъектаРасчетов.КурсЧислительВалютыДоговора,
	|		ДанныеОбъектаРасчетов.КурсЗнаменательВалютыДоговора
	|	ИЗ
	|		ДанныеОбъектаРасчетов КАК ДанныеОбъектаРасчетов
	|	ГДЕ
	|		ДанныеОбъектаРасчетов.ВариантКурсаДоговора = ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.УстановленныйВДоговоре)
	|		И ДанныеОбъектаРасчетов.ВалютаВзаиморасчетов = &Валюта
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДанныеОбъектаРасчетов.ОбъектРасчетов КАК ОбъектРасчетов,
	|		ДанныеОбъектаРасчетов.ВалютаВзаиморасчетов,
	|		ДанныеОбъектаРасчетов.ВалютаРегламентированногоУчета,
	|		ДанныеОбъектаРасчетов.ПериодКурсаДоговора,
	|		ДанныеОбъектаРасчетов.КурсЧислительВалютыДоговора,
	|		ДанныеОбъектаРасчетов.КурсЗнаменательВалютыДоговора
	|	ИЗ
	|		ДанныеОбъектаРасчетов КАК ДанныеОбъектаРасчетов
	|	ГДЕ
	|		ДанныеОбъектаРасчетов.ВариантКурсаДоговора = ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.УстановленныйВДоговоре)
	|		И ДанныеОбъектаРасчетов.ВалютаВзаиморасчетов В (ВЫБРАТЬ Т.Валюта ИЗ ТаблицаДокумента КАК Т)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДанныеОбъектаРасчетов.ОбъектРасчетов КАК ОбъектРасчетов,
	|		ДанныеОбъектаРасчетов.ВалютаВзаиморасчетов,
	|		ДанныеОбъектаРасчетов.ВалютаРегламентированногоУчета,
	|		ДанныеОбъектаРасчетов.ПериодКурсаДоговора,
	|		ДанныеОбъектаРасчетов.КурсЧислительВалютыДоговора,
	|		ДанныеОбъектаРасчетов.КурсЗнаменательВалютыДоговора
	|	ИЗ
	|		ДанныеОбъектаРасчетов КАК ДанныеОбъектаРасчетов
	|	ГДЕ
	|		ДанныеОбъектаРасчетов.ВариантКурсаДоговора = ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.УстановленныйВДоговоре)
	|		И ДанныеОбъектаРасчетов.ВалютаВзаиморасчетов В (ВЫБРАТЬ Т.ВалютаВзаиморасчетов ИЗ ТаблицаДокумента КАК Т)) КАК КурсыВалют
	|СГРУППИРОВАТЬ ПО
	|	КурсыВалют.ОбъектРасчетов,
	|	КурсыВалют.ВалютаДокумента,
	|	КурсыВалют.БазоваяВалюта,
	|	КурсыВалют.ДатаКурса
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|	
	|ВЫБРАТЬ
	|	ТаблицаДокумента.НомерСтроки КАК НомерСтроки,
	|	ТаблицаДокумента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
	|	ТаблицаДокумента.ОбъектРасчетов КАК ОбъектРасчетов,
	|	ТаблицаДокумента.Партнер КАК Партнер,
	|
	|	ВЫБОР КОГДА ТаблицаДокумента.СуммаВзаиморасчетов = 0 И КурсыВалютМультивалютногоДокумента.КурсЧислитель ЕСТЬ NULL ТОГДА
	|		(ТаблицаДокумента.Сумма *
	|		ЕСТЬNULL(ВтКурсыВалютДокумента.КурсЧислитель, ЕСТЬNULL(КурсыВалютДокумента.КурсЧислитель, 1)) * 
	|		ЕСТЬNULL(ВтКурсыВалют.КурсЗнаменатель, ЕСТЬNULL(КурсыВалют.КурсЗнаменатель, 1))
	|		) / (
	|		ЕСТЬNULL(ВтКурсыВалют.КурсЧислитель, ЕСТЬNULL(КурсыВалют.КурсЧислитель, 1)) * 
	|		ЕСТЬNULL(ВтКурсыВалютДокумента.КурсЗнаменатель, ЕСТЬNULL(КурсыВалютДокумента.КурсЗнаменатель, 1))
	|		)
	|	КОГДА ТаблицаДокумента.СуммаВзаиморасчетов = 0 И НЕ КурсыВалютМультивалютногоДокумента.КурсЧислитель ЕСТЬ NULL ТОГДА
	|		(ТаблицаДокумента.Сумма *
	|		ЕСТЬNULL(ВтКурсыВалютМультивалютногоДокумента.КурсЧислитель, ЕСТЬNULL(КурсыВалютМультивалютногоДокумента.КурсЧислитель, 1)) * 
	|		ЕСТЬNULL(ВтКурсыВалют.КурсЗнаменатель, ЕСТЬNULL(КурсыВалют.КурсЗнаменатель, 1))
	|		) / (
	|		ЕСТЬNULL(ВтКурсыВалют.КурсЧислитель, ЕСТЬNULL(КурсыВалют.КурсЧислитель, 1)) * 
	|		ЕСТЬNULL(ВтКурсыВалютМультивалютногоДокумента.КурсЗнаменатель, ЕСТЬNULL(КурсыВалютМультивалютногоДокумента.КурсЗнаменатель, 1))
	|		)
	|	ИНАЧЕ
	|		ТаблицаДокумента.СуммаВзаиморасчетов
	|	КОНЕЦ КАК СуммаВзаиморасчетов
	|ИЗ
	|	ТаблицаДокумента КАК ТаблицаДокумента
	|	
	|	// Определим курс валюты документа.
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ВтКурсыВалют КАК ВтКурсыВалютДокумента
	|	ПО ТаблицаДокумента.ОбъектРасчетов = ВтКурсыВалютДокумента.ОбъектРасчетов
	|		И ВтКурсыВалютДокумента.Валюта = &Валюта	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		РегистрСведений.ОтносительныеКурсыВалют.СрезПоследних(&Дата, Валюта = &Валюта И БазоваяВалюта = &БазоваяВалюта) КАК КурсыВалютДокумента
	|	ПО
	|		ИСТИНА
	|	
	|	// Определим курс валюты документа
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ВтКурсыВалют КАК ВтКурсыВалютМультивалютногоДокумента
	|	ПО ТаблицаДокумента.ОбъектРасчетов = ВтКурсыВалютМультивалютногоДокумента.ОбъектРасчетов
	|		И ТаблицаДокумента.Валюта = ВтКурсыВалютМультивалютногоДокумента.Валюта	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		РегистрСведений.ОтносительныеКурсыВалют.СрезПоследних(&Дата, БазоваяВалюта = &БазоваяВалюта) КАК КурсыВалютМультивалютногоДокумента
	|	ПО
	|		ТаблицаДокумента.Валюта = КурсыВалютМультивалютногоДокумента.Валюта
	|		
	|	// Определим курс валюты взаиморасчетов.
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ВтКурсыВалют КАК ВтКурсыВалют
	|	ПО ТаблицаДокумента.ОбъектРасчетов = ВтКурсыВалют.ОбъектРасчетов
	|		И ТаблицаДокумента.ВалютаВзаиморасчетов = ВтКурсыВалют.Валюта	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		РегистрСведений.ОтносительныеКурсыВалют.СрезПоследних(&Дата, БазоваяВалюта = &БазоваяВалюта) КАК КурсыВалют
	|	ПО
	|		ТаблицаДокумента.ВалютаВзаиморасчетов = КурсыВалют.Валюта
	|
	|УПОРЯДОЧИТЬ ПО
	|	ТаблицаДокумента.НомерСтроки
	|;
	|");
	Запрос.УстановитьПараметр("Дата", Дата);
	Запрос.УстановитьПараметр("Валюта", Валюта);
	Запрос.УстановитьПараметр("БазоваяВалюта", ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(Организация));
	Запрос.УстановитьПараметр("ВалютаУпр", ЗначениеНастроекПовтИсп.ВалютаУправленческогоУчета());
	
	ТаблицаДокумента = ТабличнаяЧасть.Выгрузить();
	Если ТаблицаДокумента.Колонки.Найти("Партнер") = Неопределено Тогда
		ТаблицаДокумента.Колонки.Добавить("Партнер", Новый ОписаниеТипов("СправочникСсылка.Партнеры"));
	КонецЕсли;
	Если ТаблицаДокумента.Колонки.Найти("Валюта") = Неопределено Тогда
		ТаблицаДокумента.Колонки.Добавить("Валюта", Новый ОписаниеТипов("СправочникСсылка.Валюты"));
	КонецЕсли;
	
	Запрос.УстановитьПараметр("ТаблицаДокумента", ТаблицаДокумента);
	
	// Получим таблицу документа с рассчитанной суммой взаиморасчетов.
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		
		СтрокаТаблицы = ТабличнаяЧасть.Найти(Выборка.НомерСтроки, "НомерСтроки");
		ЗаполнитьЗначенияСвойств(СтрокаТаблицы, Выборка, ,"НомерСтроки");
		
	КонецЦикла;
	
КонецПроцедуры

// Устарела.
// Процедура заполняет сумму взаиморасчетов в шапке документа.
//
// Параметры:
//	ДокументОбъект - ДокументОбъект - Текущий документ
//	ИмяТЧ - Строка - Необязательный, имя табличной части для расчета суммы документа
//	СтруктураКурса - Структура - Необязательный, параметры курса документа:
//       * КурсЧислитель - Число - Курс числитель валюты.
//       * КурсЗнаменатель - Число - Курс знаменатель валюты.
//	Дата - Дата - Дата, на которую будет получен курс, если не задана структура курса.
// 
Процедура ЗаполнитьСуммуВзаиморасчетов(ДокументОбъект, ИмяТЧ = "", СтруктураКурса = Неопределено, Дата = Неопределено) Экспорт
	
	Если ЗначениеЗаполнено(ИмяТЧ) Тогда
		СуммаДокумента = ДокументОбъект[ИмяТЧ].Итог("Сумма");
		Если Не ДокументОбъект.ЦенаВключаетНДС Тогда
			СуммаДокумента = СуммаДокумента + ДокументОбъект[ИмяТЧ].Итог("СуммаНДС");
		КонецЕсли;
	Иначе
		СуммаДокумента = ДокументОбъект.СуммаДокумента;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Дата) Тогда
		Дата = ДокументОбъект.Дата;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СтруктураКурса) И ТипЗнч(СтруктураКурса) = Тип("Структура") Тогда
		
		ВалютаРегУчета = ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(ДокументОбъект.Организация);
		
		Если  ДокументОбъект.Валюта = ВалютаРегУчета И НЕ ДокументОбъект.ВалютаВзаиморасчетов = ВалютаРегУчета Тогда
			КурсЧислительВалютыДокумента = 1;
			КурсЗнаменательВалютыДокумента = 1;
			КурсЧислительВалютыВзаиморасчетов = СтруктураКурса.КурсЧислитель;
			КурсЗнаменательВалютыВзаиморасчетов = СтруктураКурса.КурсЗнаменатель;
		Иначе
			КурсЧислительВалютыДокумента = СтруктураКурса.КурсЧислитель;
			КурсЗнаменательВалютыДокумента  = СтруктураКурса.КурсЗнаменатель;
			КурсЧислительВалютыВзаиморасчетов = 1;
			КурсЗнаменательВалютыВзаиморасчетов = 1;
		КонецЕсли;
		
		ПараметрыВалютыДок = Новый Структура("Валюта, КурсЧислитель, КурсЗнаменатель",
				ДокументОбъект.Валюта, КурсЧислительВалютыДокумента, КурсЗнаменательВалютыДокумента);
		ПараметрыВалютыВР  = Новый Структура("Валюта, КурсЧислитель, КурсЗнаменатель",
				ДокументОбъект.ВалютаВзаиморасчетов, КурсЧислительВалютыВзаиморасчетов, КурсЗнаменательВалютыВзаиморасчетов);
			
		ДокументОбъект.СуммаВзаиморасчетов = РаботаСКурсамиВалютУТ.ПересчитатьПоКурсу(СуммаДокумента,
				ПараметрыВалютыДок,ПараметрыВалютыВР);
			
	Иначе
		
		Запрос = Новый Запрос("
		|ВЫБРАТЬ
		|	(&СуммаДокумента *
		|	ЕСТЬNULL(КурсыВалютДокумента.КурсЧислитель, 1) * 
		|	ЕСТЬNULL(КурсыВалют.КурсЗнаменатель, 1)
		|	) / (
		|	ЕСТЬNULL(КурсыВалют.КурсЧислитель, 1) * 
		|	ЕСТЬNULL(КурсыВалютДокумента.КурсЗнаменатель, 1)
		|	) КАК СуммаВзаиморасчетов
		|	
		|ИЗ	
		|	РегистрСведений.ОтносительныеКурсыВалют.СрезПоследних(&Дата,
		|		Валюта = &ВалютаДокумента И БазоваяВалюта = &БазоваяВалюта
		|	) КАК КурсыВалютДокумента
		|	
		|	// Определим курс валюты взаиморасчетов.
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		РегистрСведений.ОтносительныеКурсыВалют.СрезПоследних(&Дата, 
		|			Валюта = &ВалютаВзаиморасчетов И БазоваяВалюта = &БазоваяВалюта
		|	) КАК КурсыВалют ПО ИСТИНА
		|");
		
		Запрос.УстановитьПараметр("Дата", Дата);
		Запрос.УстановитьПараметр("ВалютаДокумента", ДокументОбъект.Валюта);
		Запрос.УстановитьПараметр("ВалютаВзаиморасчетов", ДокументОбъект.ВалютаВзаиморасчетов);
		Запрос.УстановитьПараметр("СуммаДокумента", СуммаДокумента);
		Запрос.УстановитьПараметр("БазоваяВалюта", ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(ДокументОбъект.Организация));
		
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			Если ДокументОбъект.СуммаВзаиморасчетов <> Выборка.СуммаВзаиморасчетов Тогда
				ДокументОбъект.СуммаВзаиморасчетов = Выборка.СуммаВзаиморасчетов;
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// Устарела.
// Процедура заполняет сумму взаиморасчетов в шапке документа.
//
// Параметры:
// ДокументОбъект - ДокументОбъект - Текущий документ
// ИмяТЧ - Строка - Необязательный, имя табличной части, где рассчитывается сумма взаиморасчетов
// СтруктураКурса - Структура - Необязательный, параметры курса документа:
//       * КурсЧислитель   - Число - Курс числитель валюты
//       * КурсЗнаменатель - Число - Курс знаменатель валюты
//
Процедура ЗаполнитьСуммуВзаиморасчетовВПоступлении(ДокументОбъект, ИмяТЧ = "Товары", СтруктураКурса = Неопределено) Экспорт
	
	Если ДокументОбъект[ИмяТЧ].НайтиСтроки(Новый Структура("СуммаВзаиморасчетов", 0)).Количество()=0 Тогда
		
		ДокументОбъект.СуммаВзаиморасчетов = ДокументОбъект[ИмяТЧ].Итог("СуммаВзаиморасчетов");
		
	Иначе
		
		СуммаДокумента = ДокументОбъект[ИмяТЧ].Итог("Сумма");
		Если Не ДокументОбъект.ЦенаВключаетНДС Тогда
			СуммаДокумента = СуммаДокумента + ДокументОбъект[ИмяТЧ].Итог("СуммаНДС");
		КонецЕсли;
		
		Если ЗначениеЗаполнено(СтруктураКурса) И ТипЗнч(СтруктураКурса) = Тип("Структура") Тогда
			
			ВалютаРегУчета = ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(ДокументОбъект.Организация);
			
			Если ДокументОбъект.Валюта = ВалютаРегУчета И НЕ ДокументОбъект.ВалютаВзаиморасчетов = ВалютаРегУчета Тогда
				КурсЧислительВалютыДокумента = 1;
				КурсЗнаменательВалютыДокумента = 1;
				КурсЧислительВалютыВзаиморасчетов = СтруктураКурса.КурсЧислитель;
				КурсЗнаменательВалютыВзаиморасчетов = СтруктураКурса.КурсЗнаменатель;
			Иначе
				КурсЧислительВалютыДокумента = СтруктураКурса.КурсЧислитель;
				КурсЗнаменательВалютыДокумента = СтруктураКурса.КурсЗнаменатель;
				КурсЧислительВалютыВзаиморасчетов = 1;
				КурсЗнаменательВалютыВзаиморасчетов = 1;
			КонецЕсли;
			
			ПараметрыВалютыДок = Новый Структура("Валюта, КурсЧислитель, КурсЗнаменатель",
				ДокументОбъект.Валюта, КурсЧислительВалютыДокумента, КурсЗнаменательВалютыДокумента);
			ПараметрыВалютыВР  = Новый Структура("Валюта, КурсЧислитель, КурсЗнаменатель",
				ДокументОбъект.ВалютаВзаиморасчетов, КурсЧислительВалютыВзаиморасчетов, КурсЗнаменательВалютыВзаиморасчетов);
			
			ДокументОбъект.СуммаВзаиморасчетов = РаботаСКурсамиВалютУТ.ПересчитатьПоКурсу(СуммаДокумента,
				ПараметрыВалютыДок,ПараметрыВалютыВР);
			
		Иначе
			
			Запрос = Новый Запрос("
			|ВЫБРАТЬ
			|	(&СуммаДокумента *
			|	ЕСТЬNULL(КурсыВалютДокумента.КурсЧислитель, 1) * 
			|	ЕСТЬNULL(КурсыВалют.КурсЗнаменатель, 1)
			|	) / (
			|	ЕСТЬNULL(КурсыВалют.КурсЧислитель, 1) * 
			|	ЕСТЬNULL(КурсыВалютДокумента.КурсЗнаменатель, 1)
			|	) КАК СуммаВзаиморасчетов
			|	
			|ИЗ	
			|	РегистрСведений.ОтносительныеКурсыВалют.СрезПоследних(&Дата,
			|		Валюта = &ВалютаДокумента И БазоваяВалюта = &БазоваяВалюта
			|	) КАК КурсыВалютДокумента
			|	
			|	// Определим курс валюты взаиморасчетов.
			|	ЛЕВОЕ СОЕДИНЕНИЕ
			|		РегистрСведений.ОтносительныеКурсыВалют.СрезПоследних(&Дата, 
			|			Валюта = &ВалютаВзаиморасчетов И БазоваяВалюта = &БазоваяВалюта
			|	) КАК КурсыВалют ПО ИСТИНА
			|");
			
			Запрос.УстановитьПараметр("Дата", ДокументОбъект.Дата);
			Запрос.УстановитьПараметр("ВалютаДокумента", ДокументОбъект.Валюта);
			Запрос.УстановитьПараметр("ВалютаВзаиморасчетов", ДокументОбъект.ВалютаВзаиморасчетов);
			Запрос.УстановитьПараметр("СуммаДокумента", СуммаДокумента);
			Запрос.УстановитьПараметр("БазоваяВалюта", ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(ДокументОбъект.Организация));
			
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				Если ДокументОбъект.СуммаВзаиморасчетов <> Выборка.СуммаВзаиморасчетов Тогда
					ДокументОбъект.СуммаВзаиморасчетов = Выборка.СуммаВзаиморасчетов;
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// Устарела.
// Процедура заполняет сумму НДС взаиморасчетов в табличной части документа.
//
// Параметры:
//	Документ - ДокументОбъект - Текущий документ.
//	ИмяТабличнойЧасти - Строка - Имя табличной части документа для заполнения.
// 
Процедура ЗаполнитьСуммуНДСВзаиморасчетовВТабличнойЧасти(Документ, ИмяТабличнойЧасти) Экспорт
	
	ТабличнаяЧасть = Документ[ИмяТабличнойЧасти];
	
	ВалютаДокумента = Документ.Валюта;
	ВалютаЗаказа    = Документ.ВалютаВзаиморасчетов;
	
	Если ВалютаДокумента = ВалютаЗаказа Тогда
		
		Для Индекс = 0 По ТабличнаяЧасть.Количество()-1 Цикл
			Если Не ЗначениеЗаполнено(ТабличнаяЧасть[Индекс].СуммаНДСВзаиморасчетов)
			 ИЛИ ТабличнаяЧасть[Индекс].СуммаНДСВзаиморасчетов <> ТабличнаяЧасть[Индекс].СуммаНДС Тогда
				ТабличнаяЧасть[Индекс].СуммаНДСВзаиморасчетов = ТабличнаяЧасть[Индекс].СуммаНДС;
			КонецЕсли;
		КонецЦикла;
		
	Иначе
	
		Для Каждого Строка Из ТабличнаяЧасть Цикл
			
			Строка.СуммаНДСВзаиморасчетов = ЦенообразованиеКлиентСервер.РассчитатьСуммуНДС(Строка.СуммаВзаиморасчетов, Строка.СтавкаНДС);
			
		КонецЦикла;
	
	КонецЕсли;
	
КонецПроцедуры

// Процедура заполняет сумму расшифровки платежа в соответствии с суммой документа.
//
// Параметры:
//		СуммаДокумента - Число - Сумма документа для заполнения.
//		РасшифровкаПлатежа - ТаблицаЗначений - Таблица для заполнения.
//		ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта по умолчанию.
//
Процедура ЗаполнитьСуммуРасшифровкиПлатежаПоСуммеДокумента(Знач СуммаДокумента, РасшифровкаПлатежа, ВалютаВзаиморасчетов = Неопределено) Экспорт
	
	СуммаРасшифровкиПлатежа = РасшифровкаПлатежа.Итог("Сумма");
	Если СуммаДокумента <> СуммаРасшифровкиПлатежа Тогда
		
		Если РасшифровкаПлатежа.Количество() = 0 Тогда
			НоваяСтрока = РасшифровкаПлатежа.Добавить();
			НоваяСтрока.Сумма = СуммаДокумента;
			Если НЕ ВалютаВзаиморасчетов = Неопределено Тогда
				НоваяСтрока.ВалютаВзаиморасчетов = ВалютаВзаиморасчетов;
			КонецЕсли;
		Иначе
			
			Разница = СуммаДокумента - СуммаРасшифровкиПлатежа;
			МассивУдаляемыхСтрок = Новый Массив;
			
			// Корректируются суммы в строках с пустым заказом.
			Для Каждого СтрокаТаблицы Из РасшифровкаПлатежа Цикл
				
				Если Не ЗначениеЗаполнено(СтрокаТаблицы.ОбъектРасчетов) Тогда
					СтрокаТаблицы.Сумма = Макс(СтрокаТаблицы.Сумма + Разница, 0);
					СтрокаТаблицы.СуммаВзаиморасчетов = 0;
					Разница = СуммаДокумента - РасшифровкаПлатежа.Итог("Сумма");
				КонецЕсли;
				
				Если СтрокаТаблицы.Сумма = 0 Тогда
					МассивУдаляемыхСтрок.Добавить(СтрокаТаблицы);
				КонецЕсли;
				
				Если Разница = 0 Тогда
					Прервать;
				КонецЕсли;
				
			КонецЦикла;
			
			// Уменьшаются суммы в строках с указанным заказом.
			Если Разница < 0 Тогда
				
				Для Каждого СтрокаТаблицы Из РасшифровкаПлатежа Цикл
					
					Если ЗначениеЗаполнено(СтрокаТаблицы.ОбъектРасчетов) Тогда
						СтрокаТаблицы.Сумма = Макс(СтрокаТаблицы.Сумма + Разница, 0);
						СтрокаТаблицы.СуммаВзаиморасчетов = 0;
						Разница = СуммаДокумента - РасшифровкаПлатежа.Итог("Сумма");
					КонецЕсли;
					
					Если СтрокаТаблицы.Сумма = 0 Тогда
						МассивУдаляемыхСтрок.Добавить(СтрокаТаблицы);
					КонецЕсли;
					
					Если Разница = 0 Тогда
						Прервать;
					КонецЕсли;
					
				КонецЦикла;
				
			КонецЕсли;
			
			// Остаток нераспределенной суммы будет отнесен на новую строку.
			Если Разница <> 0 Тогда
				НоваяСтрока = РасшифровкаПлатежа.Добавить();
				НоваяСтрока.Сумма = Разница;
				Если НЕ ВалютаВзаиморасчетов = Неопределено Тогда
					НоваяСтрока.ВалютаВзаиморасчетов = ВалютаВзаиморасчетов;
				КонецЕсли;
			КонецЕсли;
			
			// Строки с нулевой суммой будут удалены.
			Для Каждого СтрокаТаблицы Из МассивУдаляемыхСтрок Цикл
				РасшифровкаПлатежа.Удалить(СтрокаТаблицы);
			КонецЦикла;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// Процедура заполняет или очищает табличную часть расшифровка платежа накладной при расчетах по накладным.
//
// Параметры:
//	СуммаДокумента		- Число - Сумма текущего документа.
//	СуммаВзаиморасчетов - Число - Сумма взаиморасчетов документа.
//	РасшифровкаПлатежа	- ТаблицаЗначений - Расшифровка платежа накладной для заполнения:
//		* СуммаВзаиморасчетов	- Число - Сумма взаиморасчетов по строке.
//		* Сумма					- Число - Сумма в валюте документа.
//		* ОбъектРасчетов		- СправочникСсылка.ОбъектыРасчетов - Ссылки на объекты расчетов зачтенных платежи/самого документа.
//	ОбъектРасчетов		- СправочникСсылка.ОбъектыРасчетов - Ссылка на объект расчетов документа владельца расшифровки.
//
Процедура ЗаполнитьСуммыРасшифровкиНакладной(Знач СуммаДокумента, ЗНАЧ СуммаВзаиморасчетов, РасшифровкаПлатежа, ОбъектРасчетов) Экспорт
	
	Если СуммаДокумента = 0 ИЛИ СуммаВзаиморасчетов = 0 Тогда
		РасшифровкаПлатежа.Очистить();
		Возврат;
	КонецЕсли;
	
	ТребуетсяПерераспределениеСуммы = Ложь;
	СуммаРасшифровкиПлатежа = РасшифровкаПлатежа.Итог("СуммаВзаиморасчетов");
	НовыйКурсЧислительВзаиморасчетов = ?(СуммаДокумента = 0 ИЛИ СуммаВзаиморасчетов = 0, 0, СуммаДокумента / СуммаВзаиморасчетов);
	
	Если СуммаВзаиморасчетов <> СуммаРасшифровкиПлатежа Тогда
		
		Разница = СуммаВзаиморасчетов - СуммаРасшифровкиПлатежа;
		ТребуетсяПерераспределениеСуммы = Истина;
		
		Если Разница > 0 Тогда
			
			Для Сч = 0 По РасшифровкаПлатежа.Количество()-1 Цикл
				СтрокаРасшифровки = РасшифровкаПлатежа[Сч];
				Если СтрокаРасшифровки.ОбъектРасчетов = ОбъектРасчетов Тогда
					СтрокаРасшифровки.СуммаВзаиморасчетов = СтрокаРасшифровки.СуммаВзаиморасчетов + Разница;
					Разница = 0;
				КонецЕсли;
			КонецЦикла;
			
			Если Разница > 0 Тогда
				СтрокаРасшифровки = РасшифровкаПлатежа.Добавить();
				СтрокаРасшифровки.СуммаВзаиморасчетов = Разница;
				СтрокаРасшифровки.ОбъектРасчетов = ОбъектРасчетов;
			КонецЕсли;
			
		КонецЕсли;
		
		Если Разница < 0 Тогда
			
			Для Сч = 0 По РасшифровкаПлатежа.Количество()-1 Цикл
				СтрокаРасшифровки = РасшифровкаПлатежа[Сч];
				Если СтрокаРасшифровки.ОбъектРасчетов = ОбъектРасчетов Тогда
					СуммаВзаиморасчетовДо = СтрокаРасшифровки.СуммаВзаиморасчетов;
					СтрокаРасшифровки.СуммаВзаиморасчетов = Макс(0,СтрокаРасшифровки.СуммаВзаиморасчетов + Разница);
					Разница = Разница + (СуммаВзаиморасчетовДо - СтрокаРасшифровки.СуммаВзаиморасчетов);
				КонецЕсли;
			КонецЦикла;
			
			Если Разница < 0 Тогда
			
				Для Сч = 0 По РасшифровкаПлатежа.Количество()-1 Цикл
					СтрокаРасшифровки = РасшифровкаПлатежа[Сч];
					Если СтрокаРасшифровки.ОбъектРасчетов <> ОбъектРасчетов Тогда
						СуммаВзаиморасчетовДо = СтрокаРасшифровки.СуммаВзаиморасчетов;
						СтрокаРасшифровки.СуммаВзаиморасчетов = Макс(0,СтрокаРасшифровки.СуммаВзаиморасчетов + Разница);
						Разница = Разница + (СуммаВзаиморасчетовДо - СтрокаРасшифровки.СуммаВзаиморасчетов);
					КонецЕсли;
				КонецЦикла;
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
	СуммаРасшифровкиПлатежа = РасшифровкаПлатежа.Итог("Сумма");
	Если ТребуетсяПерераспределениеСуммы ИЛИ СуммаДокумента <> СуммаРасшифровкиПлатежа Тогда
		
		Если РасшифровкаПлатежа.Количество() = 1 Тогда
			РасшифровкаПлатежа[0].Сумма = СуммаДокумента;
		ИначеЕсли РасшифровкаПлатежа.Количество() > 1 Тогда
			
			НераспределеннаяСумма = СуммаДокумента;
			Для Сч = 0 По РасшифровкаПлатежа.Количество()-1 Цикл
				СтрокаРасшифровки = РасшифровкаПлатежа[Сч];
				Если Сч = РасшифровкаПлатежа.Количество()-1 Тогда
					СтрокаРасшифровки.Сумма = НераспределеннаяСумма;
				Иначе
					СтрокаРасшифровки.Сумма = СтрокаРасшифровки.СуммаВзаиморасчетов * НовыйКурсЧислительВзаиморасчетов;
					НераспределеннаяСумма = НераспределеннаяСумма - СтрокаРасшифровки.Сумма;
				КонецЕсли;
			КонецЦикла;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Сч = 0;
	Пока Сч < РасшифровкаПлатежа.Количество() Цикл
		
		Если РасшифровкаПлатежа[Сч].СуммаВзаиморасчетов = 0 Тогда
			РасшифровкаПлатежа.Удалить(Сч);
		Иначе
			Сч = Сч +1;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область Проведение

// Формирует параметры для проведения документа по регистрам учетного механизма через общий механизм проведения.
//
// Параметры:
//  Документ - ДокументОбъект - записываемый документ.
//  Свойства - См. ПроведениеДокументов.СвойстваДокумента.
//
// Возвращаемое значение:
//  См. ПроведениеДокументов.ПараметрыУчетногоМеханизма.
//
Функция ПараметрыДляПроведенияДокумента(Документ, Свойства) Экспорт
	
	Параметры = ПроведениеДокументов.ПараметрыУчетногоМеханизма();
	
	Параметры.ЕстьПроизводныеДвижения = Истина;
	
	// Для Регистра накопления ПроцентныеРасходыДисконтирования механизм проведения документов используется у документов
	// ВводОстатковВзаиморасчетов и Сторно
	Если ТипЗнч(Документ) = Тип("ДокументОбъект.Сторно") Тогда
		ДокументыДляДисконтирования = РегистрыНакопления.ПроцентныеРасходыДисконтирования.ПолучитьТипыДокументовУчаствующихВДисконтировании();
		ТребуютсяДвиженияПроцентныеРасходыДисконтирования = ДокументыДляДисконтирования.Найти(ТипЗнч(Документ.СторнируемыйДокумент)) <> Неопределено;
	Иначе
		ТребуютсяДвиженияПроцентныеРасходыДисконтирования = ТипЗнч(Документ) = Тип("ДокументОбъект.ВводОстатковВзаиморасчетов");
	КонецЕсли;
	
	// Проведение
	Если Свойства.РежимЗаписи = РежимЗаписиДокумента.Проведение Тогда
		
		Параметры.ПодчиненныеРегистры.Добавить(Метаданные.РегистрыНакопления.РасчетыСКлиентами);
		Параметры.ПодчиненныеРегистры.Добавить(Метаданные.РегистрыНакопления.РасчетыСКлиентамиПланОплат);
		Параметры.ПодчиненныеРегистры.Добавить(Метаданные.РегистрыНакопления.РасчетыСКлиентамиПланОтгрузок);
		Параметры.ПодчиненныеРегистры.Добавить(Метаданные.РегистрыНакопления.РасчетыСПоставщиками);
		Параметры.ПодчиненныеРегистры.Добавить(Метаданные.РегистрыНакопления.РасчетыСПоставщикамиПланОплат);
		Параметры.ПодчиненныеРегистры.Добавить(Метаданные.РегистрыНакопления.РасчетыСПоставщикамиПланПоставок);
		
		Если ТребуютсяДвиженияПроцентныеРасходыДисконтирования Тогда
			Параметры.ПодчиненныеРегистры.Добавить(Метаданные.РегистрыНакопления.ПроцентныеРасходыДисконтирования);
		КонецЕсли;
		
	КонецЕсли;
	
	// Контроль
	Если Свойства.РежимЗаписи <> РежимЗаписиДокумента.Запись Тогда
		
		Параметры.КонтрольныеРегистрыИзменений.Добавить(Метаданные.РегистрыНакопления.РасчетыСКлиентами);
		Параметры.КонтрольныеРегистрыИзменений.Добавить(Метаданные.РегистрыНакопления.РасчетыСПоставщиками);
		Если ТребуютсяДвиженияПроцентныеРасходыДисконтирования Тогда
			Параметры.КонтрольныеРегистрыИзменений.Добавить(Метаданные.РегистрыНакопления.ПроцентныеРасходыДисконтирования);
		КонецЕсли;
		
		Параметры.КонтрольныеРегистрыЗаданий.Добавить(Метаданные.РегистрыНакопления.РасчетыСКлиентами);
		Параметры.КонтрольныеРегистрыЗаданий.Добавить(Метаданные.РегистрыНакопления.РасчетыСПоставщиками);
		Параметры.КонтрольныеРегистрыЗаданий.Добавить(Метаданные.РегистрыНакопления.РасчетыСКлиентамиПоДокументам);
		Параметры.КонтрольныеРегистрыЗаданий.Добавить(Метаданные.РегистрыНакопления.РасчетыСПоставщикамиПоДокументам);
		Если ТребуютсяДвиженияПроцентныеРасходыДисконтирования Тогда
			Параметры.КонтрольныеРегистрыЗаданий.Добавить(Метаданные.РегистрыНакопления.ПроцентныеРасходыДисконтирования);
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Параметры;
	
КонецФункции

// Возвращает тексты запросов для сторнирования движений при исправлении документов
// 
// Параметры:
// 	МетаданныеДокумента - ОбъектМетаданныхДокумент - Метаданные документа, который проводится.
// 
// Возвращаемое значение:
// 	Соответствие Из КлючИЗначение - Содержит тексты запросов сторнирования, где:
// 		* Ключ - Строка - Полное имя регистра.
// 		* Значение - Строка - Текст запроса.
//
Функция ТекстыЗапросовСторнирования(МетаданныеДокумента) Экспорт
	
	ДвиженияДокумента = МетаданныеДокумента.Движения;
	ТекстыЗапросов = Новый Соответствие();
	
	МетаданныеРегистра = Метаданные.РегистрыНакопления.РасчетыСКлиентами;
	ДвиженияДокумента = МетаданныеДокумента.Движения;
	
	Если ДвиженияДокумента.Содержит(МетаданныеРегистра) Тогда
		ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ДокументыСторно.Ссылка КАК Регистратор,
		|	ДокументыСторно.Дата   КАК Период,
		|	ДокументыСторно.Дата   КАК ДатаРегистратора,
		|	ДокументыСторно.Номер  КАК НомерРегистратора,
		|	&ПоляВыборки,
		|	ДокументыСторно.СторнируемыйДокумент КАК СвязанныйДокумент,
		|	ИСТИНА КАК Сторно,
		|	ДанныеРегистра.СуммаПриемник КАК СуммаПриемник,
		|	1 Вид
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентами КАК ДанныеРегистра
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
		|		&ИмяДокумента КАК ДокументыСторно
		|	ПО
		|		ДанныеРегистра.Регистратор = ДокументыСторно.СторнируемыйДокумент
		|		И ДокументыСторно.Ссылка В (&Ссылка)
		|ГДЕ
		|	НЕ ДанныеРегистра.Сторно
		|";
		
		МассивПолейВыборки = Новый Массив;
		
		Исключения = Новый Массив;
		
		Исключения.Добавить(МетаданныеРегистра.СтандартныеРеквизиты.Активность.Имя);
		Исключения.Добавить(МетаданныеРегистра.СтандартныеРеквизиты.НомерСтроки.Имя);
		Исключения.Добавить(МетаданныеРегистра.СтандартныеРеквизиты.Регистратор.Имя);
		Исключения.Добавить(МетаданныеРегистра.СтандартныеРеквизиты.Период.Имя);
		Исключения.Добавить(МетаданныеРегистра.Реквизиты.Сторно.Имя);
		Исключения.Добавить(МетаданныеРегистра.Реквизиты.ПорядокОперации.Имя);
		Исключения.Добавить(МетаданныеРегистра.Реквизиты.ПорядокЗачетаПоДатеПлатежа.Имя);
		Исключения.Добавить(МетаданныеРегистра.Реквизиты.СвязанныйДокумент.Имя);
		Исключения.Добавить(МетаданныеРегистра.Реквизиты.ДатаРегистратора.Имя);
		Исключения.Добавить(МетаданныеРегистра.Реквизиты.СуммаПриемник.Имя);
		
		ПроведениеДокументов.ДобавитьПоляВыборкиСторнирующегоЗапроса(МетаданныеРегистра.СтандартныеРеквизиты, 
			МассивПолейВыборки,
			Исключения);
		ПроведениеДокументов.ДобавитьПоляВыборкиСторнирующегоЗапроса(МетаданныеРегистра.Измерения, 
			МассивПолейВыборки,
			Исключения);
		ПроведениеДокументов.ДобавитьПоляВыборкиСторнирующегоЗапроса(МетаданныеРегистра.Ресурсы, 
			МассивПолейВыборки,
			Исключения,
			Истина);
		ПроведениеДокументов.ДобавитьПоляВыборкиСторнирующегоЗапроса(МетаданныеРегистра.Реквизиты, 
			МассивПолейВыборки,
			Исключения,
			Истина);
			
		ТекстПоляВыборки= СтрСоединить(МассивПолейВыборки,"," + Символы.ПС);
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ПоляВыборки", ТекстПоляВыборки);
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ИмяДокумента", МетаданныеДокумента.ПолноеИмя());
		ТекстыЗапросов.Вставить(МетаданныеРегистра.ПолноеИмя(), ТекстЗапроса);
		
	КонецЕсли;
	
	МетаданныеРегистра = Метаданные.РегистрыНакопления.РасчетыСПоставщиками;
	Если ДвиженияДокумента.Содержит(МетаданныеРегистра) Тогда
		ШаблонЗапроса = "
		|ВЫБРАТЬ
		|	ДокументыСторно.Ссылка КАК Регистратор,
		|	ДокументыСторно.Дата   КАК Период,
		|	ДокументыСторно.Дата   КАК ДатаРегистратора,
		|	ДокументыСторно.Номер  КАК НомерРегистратора,
		|	&ПоляВыборки,
		|	ДокументыСторно.СторнируемыйДокумент КАК СвязанныйДокумент,
		|	ИСТИНА КАК Сторно,
		|	ДанныеРегистра.СуммаПриемник КАК СуммаПриемник,
		|	1 КАК Вид
		|ИЗ
		|	РегистрНакопления.РасчетыСПоставщиками КАК ДанныеРегистра
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
		|		&ИмяДокумента КАК ДокументыСторно
		|	ПО
		|		ДанныеРегистра.Регистратор = ДокументыСторно.СторнируемыйДокумент
		|		И ДокументыСторно.Ссылка В (&Ссылка)
		|ГДЕ
		|	НЕ ДанныеРегистра.Сторно
		|";
		
		МассивПолейВыборки = Новый Массив;
		
		Исключения = Новый Массив;
		Исключения.Добавить(МетаданныеРегистра.СтандартныеРеквизиты.Активность.Имя);
		Исключения.Добавить(МетаданныеРегистра.СтандартныеРеквизиты.НомерСтроки.Имя);
		Исключения.Добавить(МетаданныеРегистра.СтандартныеРеквизиты.Регистратор.Имя);
		Исключения.Добавить(МетаданныеРегистра.СтандартныеРеквизиты.Период.Имя);
		Исключения.Добавить(МетаданныеРегистра.Реквизиты.Сторно.Имя);
		Исключения.Добавить(МетаданныеРегистра.Реквизиты.ПорядокОперации.Имя);
		Исключения.Добавить(МетаданныеРегистра.Реквизиты.ПорядокЗачетаПоДатеПлатежа.Имя);
		Исключения.Добавить(МетаданныеРегистра.Реквизиты.СвязанныйДокумент.Имя);
		Исключения.Добавить(МетаданныеРегистра.Реквизиты.ДатаРегистратора.Имя);
		Исключения.Добавить(МетаданныеРегистра.Реквизиты.СуммаПриемник.Имя);
		
		ПроведениеДокументов.ДобавитьПоляВыборкиСторнирующегоЗапроса(МетаданныеРегистра.СтандартныеРеквизиты, 
			МассивПолейВыборки,
			Исключения);
		ПроведениеДокументов.ДобавитьПоляВыборкиСторнирующегоЗапроса(МетаданныеРегистра.Измерения, 
			МассивПолейВыборки,
			Исключения);
		ПроведениеДокументов.ДобавитьПоляВыборкиСторнирующегоЗапроса(МетаданныеРегистра.Ресурсы, 
			МассивПолейВыборки,
			Исключения,
			Истина);
		ПроведениеДокументов.ДобавитьПоляВыборкиСторнирующегоЗапроса(МетаданныеРегистра.Реквизиты, 
			МассивПолейВыборки,
			Исключения,
			Истина);
			
		ТекстПоляВыборки= СтрСоединить(МассивПолейВыборки,"," + Символы.ПС);
		ТекстЗапроса = СтрЗаменить(ШаблонЗапроса, "&ПоляВыборки", ТекстПоляВыборки);
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ИмяДокумента", МетаданныеДокумента.ПолноеИмя());
		ТекстыЗапросов.Вставить(МетаданныеРегистра.ПолноеИмя(), ТекстЗапроса);
	КонецЕсли;
	
	МетаданныеРегистра = Метаданные.РегистрыНакопления.ПроцентныеРасходыДисконтирования;
	Если ДвиженияДокумента.Содержит(МетаданныеРегистра) Тогда
		ШаблонЗапроса = "
		|ВЫБРАТЬ
		|	ДокументыСторно.Ссылка КАК Регистратор,
		|	ДокументыСторно.Дата   КАК Период,
		|	ДокументыСторно.Дата   КАК ДатаРегистратора,
		|	ДокументыСторно.Номер  КАК НомерРегистратора,
		|	&ПоляВыборки,
		|	ДокументыСторно.СторнируемыйДокумент КАК СвязанныйДокумент,
		|	ИСТИНА КАК Сторно,
		|	1 КАК Вид
		|ИЗ
		|	РегистрНакопления.ПроцентныеРасходыДисконтирования КАК ДанныеРегистра
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
		|		&ИмяДокумента КАК ДокументыСторно
		|	ПО
		|		ДанныеРегистра.Регистратор = ДокументыСторно.СторнируемыйДокумент
		|		И ДокументыСторно.Ссылка В (&Ссылка)
		|ГДЕ
		|	НЕ ДанныеРегистра.Сторно
		|";
		
		МассивПолейВыборки = Новый Массив;
		
		Исключения = Новый Массив;
		Исключения.Добавить(МетаданныеРегистра.СтандартныеРеквизиты.Активность.Имя);
		Исключения.Добавить(МетаданныеРегистра.СтандартныеРеквизиты.НомерСтроки.Имя);
		Исключения.Добавить(МетаданныеРегистра.СтандартныеРеквизиты.Регистратор.Имя);
		Исключения.Добавить(МетаданныеРегистра.СтандартныеРеквизиты.Период.Имя);
		Исключения.Добавить(МетаданныеРегистра.Реквизиты.Сторно.Имя);
		Исключения.Добавить(МетаданныеРегистра.Реквизиты.СтавкаДисконтирования.Имя);
		Исключения.Добавить(МетаданныеРегистра.Реквизиты.ФактическаяЗадолженностьБезНДС.Имя);
		Исключения.Добавить(МетаданныеРегистра.Реквизиты.ДисконтированнаяЗадолженностьБезНДС.Имя);
		Исключения.Добавить(МетаданныеРегистра.Реквизиты.РассчитанныйОстатокПроцентов.Имя);
		Исключения.Добавить(МетаданныеРегистра.Реквизиты.ФактическаяЗадолженностьБезНДСРегл.Имя);
		Исключения.Добавить(МетаданныеРегистра.Реквизиты.ДисконтированнаяЗадолженностьБезНДСРегл.Имя);
		Исключения.Добавить(МетаданныеРегистра.Реквизиты.РассчитанныйОстатокПроцентовРегл.Имя);
		Исключения.Добавить(МетаданныеРегистра.Реквизиты.ФактическаяЗадолженностьБезНДСУпр.Имя);
		Исключения.Добавить(МетаданныеРегистра.Реквизиты.ДисконтированнаяЗадолженностьБезНДСУпр.Имя);
		Исключения.Добавить(МетаданныеРегистра.Реквизиты.РассчитанныйОстатокПроцентовУпр.Имя);
		
		ПроведениеДокументов.ДобавитьПоляВыборкиСторнирующегоЗапроса(МетаданныеРегистра.СтандартныеРеквизиты, 
			МассивПолейВыборки,
			Исключения);
		ПроведениеДокументов.ДобавитьПоляВыборкиСторнирующегоЗапроса(МетаданныеРегистра.Измерения, 
			МассивПолейВыборки,
			Исключения);
		ПроведениеДокументов.ДобавитьПоляВыборкиСторнирующегоЗапроса(МетаданныеРегистра.Ресурсы, 
			МассивПолейВыборки,
			Исключения,
			Истина);
		ПроведениеДокументов.ДобавитьПоляВыборкиСторнирующегоЗапроса(МетаданныеРегистра.Реквизиты, 
			МассивПолейВыборки,
			Исключения,
			Истина);
			
		ТекстПоляВыборки= СтрСоединить(МассивПолейВыборки,"," + Символы.ПС);
		ТекстЗапроса = СтрЗаменить(ШаблонЗапроса, "&ПоляВыборки", ТекстПоляВыборки);
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ИмяДокумента", МетаданныеДокумента.ПолноеИмя());
		ТекстыЗапросов.Вставить(МетаданныеРегистра.ПолноеИмя(), ТекстЗапроса);
	КонецЕсли;
	
	Возврат ТекстыЗапросов;
	
КонецФункции

// Дополняет текст запроса механизма проверки даты запрета по таблице изменений.
// 
// Параметры:
// 	Запрос - Запрос - используется для установки параметров запроса.
// 
// Возвращаемое значение:
//	Соответствие Из КлючИЗначение:
//		* Ключ - Строка - Имя временной таблицы изменений регистра.
//		* Значение - Строка - Текст запроса.
//	
Функция ТекстыЗапросовКонтрольДатыЗапретаПоТаблицеИзменений(Запрос) Экспорт

	СоответствиеТекстовЗапросов = Новый Соответствие();
	Возврат СоответствиеТекстовЗапросов;
	
КонецФункции

// Процедура формирования движений по подчиненным регистрам взаиморасчетов.
//
// Параметры:
//   ТаблицыДляДвижений - Структура - таблицы данных документа
//   Движения - КоллекцияДвижений - коллекция наборов записей движений документа
//   Отказ - Булево - признак отказа от проведения документа.
//
Процедура ОтразитьДвижения(ТаблицыДляДвижений, Движения, Отказ) Экспорт
	
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	НоваяАрхитектураВзаиморасчетов = Константы.НоваяАрхитектураВзаиморасчетов.Получить();
	
	// Заполнение аналитики вынесено вперед
	// потому что для проверки приемников при проведении документа взаимозачета задолженности
	// между двумя организациями и одним контрагентом требуются обе таблицы расчетов
	// т.к. приемник задолженности может быть в другом регистре
	ТаблицаРасчетыСКлиентами = Неопределено;
	ТаблицыДляДвижений.Свойство("Таблица" + "РасчетыСКлиентами", ТаблицаРасчетыСКлиентами);
	Если ЗначениеЗаполнено(ТаблицаРасчетыСКлиентами) Тогда
		ПроверитьЗаполнитьАналитикуУчетаПоПартнерам(ТаблицаРасчетыСКлиентами);
	КонецЕсли;
	Если ТаблицаРасчетыСКлиентами <> Неопределено И ТаблицаРасчетыСКлиентами.Колонки.Найти("Сторно") = Неопределено Тогда
		ТаблицаРасчетыСКлиентами.Колонки.Добавить("Сторно", Новый ОписаниеТипов("Булево"));
	КонецЕсли;
	
	ТаблицаРасчетыСПоставщиками = Неопределено;
	ТаблицыДляДвижений.Свойство("Таблица" + "РасчетыСПоставщиками", ТаблицаРасчетыСПоставщиками);
	Если ЗначениеЗаполнено(ТаблицаРасчетыСПоставщиками) Тогда
		ПроверитьЗаполнитьАналитикуУчетаПоПартнерам(ТаблицаРасчетыСПоставщиками);
	КонецЕсли;
	Если ТаблицаРасчетыСПоставщиками <> Неопределено И ТаблицаРасчетыСПоставщиками.Колонки.Найти("Сторно") = Неопределено Тогда
		ТаблицаРасчетыСПоставщиками.Колонки.Добавить("Сторно", Новый ОписаниеТипов("Булево"));
	КонецЕсли;
	
	#Область РасчетыСКлиентами
	
	Если ЗначениеЗаполнено(ТаблицаРасчетыСКлиентами) Тогда
		
		ПроверитьОбъектыРасчетовНаПометкуУдаления(ТаблицаРасчетыСКлиентами,Отказ,Истина);
		
			ТипДокумента = ТипЗнч(Движения.РасчетыСКлиентами.Отбор.Регистратор.Значение);
			ДобавитьЗаполнитьПорядокРасчетовСКлиентами(ТаблицаРасчетыСКлиентами, ТипДокумента);
			
			ТаблицаПриемников = Новый ТаблицаЗначений;
			ТаблицаПриемников.Колонки.Добавить("АналитикаУчетаПоПартнерамПриемник", Новый ОписаниеТипов("СправочникСсылка.КлючиАналитикиУчетаПоПартнерам"));
			ТаблицаПриемников.Колонки.Добавить("ОбъектРасчетовПриемник", Новый ОписаниеТипов("СправочникСсылка.ОбъектыРасчетов"));
			ТаблицаПриемников.Колонки.Добавить("ВалютаПриемник", Новый ОписаниеТипов("СправочникСсылка.Валюты"));
			ТаблицаПриемников.Колонки.Добавить("Сторно", Новый ОписаниеТипов("Булево"));
			
			ПроверятьТипЗаказа =  ТаблицаРасчетыСКлиентами.Колонки.Найти("ПродажаПоЗаказу") <> Неопределено;
			ПроверятьСвязиИсточниковПриемников = ТаблицаРасчетыСКлиентами.Колонки.Найти("ОбъектРасчетовПриемник") <> Неопределено;
			
			Для Каждого Стр Из ТаблицаРасчетыСКлиентами Цикл
				Если ПроверятьТипЗаказа И НЕ ЗначениеЗаполнено(Стр.ПродажаПоЗаказу) И Стр.ПродажаПоЗаказу <> Неопределено Тогда
					Стр.ПродажаПоЗаказу = Неопределено;
				КонецЕсли;
				
				Если Стр.Сторно = Неопределено Тогда
					Стр.Сторно = Ложь;
				КонецЕсли;
				Если ПроверятьСвязиИсточниковПриемников Тогда
					Если НоваяАрхитектураВзаиморасчетов Тогда
						ПоДаннымОбъектаРасчетовИсточника = ?(Стр.ПоДаннымОбъектаРасчетовИсточника = Неопределено,Ложь,Стр.ПоДаннымОбъектаРасчетовИсточника);
						КонтрольнаяСумма = ЗначениеЗаполнено(Стр.ОбъектРасчетовПриемник)
							+ ЗначениеЗаполнено(Стр.АналитикаУчетаПоПартнерамПриемник)
							+ ЗначениеЗаполнено(Стр.ВалютаПриемник)
							+ (ЗначениеЗаполнено(Стр.СуммаПриемник) И ЗначениеЗаполнено(Стр.Сумма));
						Если НЕ ПоДаннымОбъектаРасчетовИсточника И КонтрольнаяСумма <> 4 И КонтрольнаяСумма <> 0 Тогда
							ВызватьИсключение(СтрШаблон(НСтр("ru = 'Некорректно заполнена аналитика или сумма приемника в движениях по %1'"),
													Метаданные.РегистрыНакопления.РасчетыСПоставщиками.Имя));
						КонецЕсли;
					Иначе
						Стр.АналитикаУчетаПоПартнерамПриемник = Справочники.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка();
						Стр.ОбъектРасчетовПриемник = Справочники.ОбъектыРасчетов.ПустаяСсылка();
						Стр.ВалютаПриемник = Справочники.Валюты.ПустаяСсылка();
						Стр.СуммаПриемник = 0;
						Стр.ПоДаннымОбъектаРасчетовИсточника = Ложь;
					КонецЕсли;
				КонецЕсли;
				
				Если ПроверятьСвязиИсточниковПриемников И ЗначениеЗаполнено(Стр.ОбъектРасчетовПриемник) Тогда
					ЗаполнитьЗначенияСвойств(ТаблицаПриемников.Добавить(),Новый Структура("ОбъектРасчетовПриемник, АналитикаУчетаПоПартнерамПриемник, ВалютаПриемник, Сторно",
							Стр.ОбъектРасчетовПриемник, Стр.АналитикаУчетаПоПартнерамПриемник, Стр.ВалютаПриемник, Стр.Сторно));
				КонецЕсли;
			КонецЦикла;
			
			Если ТаблицаПриемников.Количество() > 0 Тогда
				ТаблицаПриемников.Свернуть("ОбъектРасчетовПриемник, АналитикаУчетаПоПартнерамПриемник, ВалютаПриемник, Сторно");
				ТаблицаРасчетыСКлиентами.Индексы.Добавить("ОбъектРасчетов,АналитикаУчетаПоПартнерам,Валюта,Сторно");
				СтруктураПоиска = Новый Структура("ОбъектРасчетов,АналитикаУчетаПоПартнерам,Валюта,ПоДаннымОбъектаРасчетовИсточника,Сторно");
				Для Каждого Стр Из ТаблицаПриемников Цикл
					СтруктураПоиска.АналитикаУчетаПоПартнерам = Стр.АналитикаУчетаПоПартнерамПриемник;
					СтруктураПоиска.ОбъектРасчетов = Стр.ОбъектРасчетовПриемник;
					СтруктураПоиска.Валюта = Стр.ВалютаПриемник;
					СтруктураПоиска.Сторно = Стр.Сторно;
					СтруктураПоиска.ПоДаннымОбъектаРасчетовИсточника = Истина;
					
					ЕстьВКлиентах = ТаблицаРасчетыСКлиентами.НайтиСтроки(СтруктураПоиска).Количество() > 0;
					ЕстьВПоставщиках = ТаблицаРасчетыСПоставщиками <> Неопределено
										И ТаблицаРасчетыСПоставщиками.НайтиСтроки(СтруктураПоиска).Количество() > 0;
					Если НЕ (ЕстьВКлиентах ИЛИ ЕстьВПоставщиках) Тогда
						Если ТаблицаРасчетыСПоставщиками <> Неопределено Тогда
							ВызватьИсключение(СтрШаблон(НСтр("ru = 'Не найдены движения приемника в движениях по %1 и %2'"),
												Метаданные.РегистрыНакопления.РасчетыСКлиентами.Имя,
												Метаданные.РегистрыНакопления.РасчетыСПоставщиками.Имя));
						Иначе
							ВызватьИсключение(СтрШаблон(НСтр("ru = 'Не найдены движения приемника в движениях по %1'"),
												Метаданные.РегистрыНакопления.РасчетыСКлиентами.Имя));
						КонецЕсли;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			
			Движения.РасчетыСКлиентами.Записывать = Истина;
			Движения.РасчетыСКлиентами.Загрузить(ТаблицаРасчетыСКлиентами);
	КонецЕсли;
	
	Если Движения.Найти("РасчетыСКлиентами") <> Неопределено
		И Движения.РасчетыСКлиентами.Записывать
		И Не ЗначениеЗаполнено(ТаблицаРасчетыСКлиентами) Тогда
		Движения.РасчетыСКлиентамиПоДокументам.Записывать = Истина;
	КонецЕсли;
	
	#КонецОбласти
	
	#Область РасчетыСКлиентамиПланОплат
	
	ИмяТаблицыРасчетыСКлиентамиПланОплат = "Таблица" + "РасчетыСКлиентамиПланОплат";
	Если ТаблицыДляДвижений.Свойство(ИмяТаблицыРасчетыСКлиентамиПланОплат) Тогда
		
		ТаблицаРасчетыСКлиентамиПланОплат = ТаблицыДляДвижений[ИмяТаблицыРасчетыСКлиентамиПланОплат];

		Если ЗначениеЗаполнено(ТаблицаРасчетыСКлиентамиПланОплат) Тогда
		
			ТипДокумента = ТипЗнч(Движения.РасчетыСКлиентамиПланОплат.Отбор.Регистратор.Значение);
			ДобавитьЗаполнитьПорядокРасчетовСКлиентами(ТаблицаРасчетыСКлиентамиПланОплат, ТипДокумента);
			ПроверитьЗаполнитьАналитикуУчетаПоПартнерам(ТаблицаРасчетыСКлиентамиПланОплат);
			
			Движения.РасчетыСКлиентамиПланОплат.Записывать = Истина;
			Движения.РасчетыСКлиентамиПланОплат.Загрузить(ТаблицаРасчетыСКлиентамиПланОплат);
			
		КонецЕсли;
		
	КонецЕсли;
	
	#КонецОбласти
	
	#Область РасчетыСКлиентамиПланОтгрузок
	
	ИмяТаблицыРасчетыСКлиентамиПланОтгрузок = "Таблица" + "РасчетыСКлиентамиПланОтгрузок";
	Если ТаблицыДляДвижений.Свойство(ИмяТаблицыРасчетыСКлиентамиПланОтгрузок) Тогда
		
		ТаблицаРасчетыСКлиентамиПланОтгрузок = ТаблицыДляДвижений[ИмяТаблицыРасчетыСКлиентамиПланОтгрузок];

		Если ЗначениеЗаполнено(ТаблицаРасчетыСКлиентамиПланОтгрузок) Тогда
		
			ТипДокумента = ТипЗнч(Движения.РасчетыСКлиентамиПланОтгрузок.Отбор.Регистратор.Значение);
			ДобавитьЗаполнитьПорядокРасчетовСКлиентами(ТаблицаРасчетыСКлиентамиПланОтгрузок, ТипДокумента);
			ПроверитьЗаполнитьАналитикуУчетаПоПартнерам(ТаблицаРасчетыСКлиентамиПланОтгрузок);
			
			Движения.РасчетыСКлиентамиПланОтгрузок.Записывать = Истина;
			Движения.РасчетыСКлиентамиПланОтгрузок.Загрузить(ТаблицаРасчетыСКлиентамиПланОтгрузок);
			
		КонецЕсли;
		
	КонецЕсли;
	
	#КонецОбласти
	
	#Область РасчетыСПоставщиками
	
	Если ЗначениеЗаполнено(ТаблицаРасчетыСПоставщиками) Тогда
		
		ПроверитьОбъектыРасчетовНаПометкуУдаления(ТаблицаРасчетыСПоставщиками, Отказ, Ложь);
		
			ТипДокумента = ТипЗнч(Движения.РасчетыСПоставщиками.Отбор.Регистратор.Значение);
			ДобавитьЗаполнитьПорядокРасчетовСПоставщиками(ТаблицаРасчетыСПоставщиками, ТипДокумента);
			
			ТаблицаПриемников = Новый ТаблицаЗначений;
			ТаблицаПриемников.Колонки.Добавить("АналитикаУчетаПоПартнерамПриемник", Новый ОписаниеТипов("СправочникСсылка.КлючиАналитикиУчетаПоПартнерам"));
			ТаблицаПриемников.Колонки.Добавить("ОбъектРасчетовПриемник", Новый ОписаниеТипов("СправочникСсылка.ОбъектыРасчетов"));
			ТаблицаПриемников.Колонки.Добавить("ВалютаПриемник", Новый ОписаниеТипов("СправочникСсылка.Валюты"));
			ТаблицаПриемников.Колонки.Добавить("Сторно", Новый ОписаниеТипов("Булево"));
			
			ПроверятьТипЗаказа =  ТаблицаРасчетыСПоставщиками.Колонки.Найти("ЗакупкаПоЗаказу") <> Неопределено;
			ПроверятьСвязиИсточниковПриемников = ТаблицаРасчетыСПоставщиками.Колонки.Найти("ОбъектРасчетовПриемник") <> Неопределено;
			
			Для Каждого Стр Из ТаблицаРасчетыСПоставщиками Цикл
				Если ПроверятьТипЗаказа И НЕ ЗначениеЗаполнено(Стр.ЗакупкаПоЗаказу) И Стр.ЗакупкаПоЗаказу <> Неопределено Тогда
					Стр.ЗакупкаПоЗаказу = Неопределено;
				КонецЕсли;
				
				Если Стр.Сторно = Неопределено Тогда
					Стр.Сторно = Ложь;
				КонецЕсли;
				Если ПроверятьСвязиИсточниковПриемников Тогда
					Если НоваяАрхитектураВзаиморасчетов Тогда
						ПоДаннымОбъектаРасчетовИсточника = ?(Стр.ПоДаннымОбъектаРасчетовИсточника = Неопределено,Ложь,Стр.ПоДаннымОбъектаРасчетовИсточника);
						КонтрольнаяСумма = ЗначениеЗаполнено(Стр.ОбъектРасчетовПриемник)
							+ ЗначениеЗаполнено(Стр.АналитикаУчетаПоПартнерамПриемник)
							+ ЗначениеЗаполнено(Стр.ВалютаПриемник)
							+ (ЗначениеЗаполнено(Стр.СуммаПриемник) И ЗначениеЗаполнено(Стр.Сумма));
						Если НЕ ПоДаннымОбъектаРасчетовИсточника И КонтрольнаяСумма <> 4 И КонтрольнаяСумма <> 0 Тогда
							ВызватьИсключение(СтрШаблон(НСтр("ru = 'Некорректно заполнена аналитика или сумма приемника в движениях по %1'"),
													Метаданные.РегистрыНакопления.РасчетыСПоставщиками.Имя));
						КонецЕсли;
					Иначе
						Стр.АналитикаУчетаПоПартнерамПриемник = Справочники.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка();
						Стр.ОбъектРасчетовПриемник = Справочники.ОбъектыРасчетов.ПустаяСсылка();
						Стр.ВалютаПриемник = Справочники.Валюты.ПустаяСсылка();
						Стр.СуммаПриемник = 0;
						Стр.ПоДаннымОбъектаРасчетовИсточника = Ложь;
					КонецЕсли;
				КонецЕсли;
				
				Если ПроверятьСвязиИсточниковПриемников И ЗначениеЗаполнено(Стр.ОбъектРасчетовПриемник) Тогда
					ЗаполнитьЗначенияСвойств(ТаблицаПриемников.Добавить(),Новый Структура("ОбъектРасчетовПриемник, АналитикаУчетаПоПартнерамПриемник, ВалютаПриемник, Сторно",
						Стр.ОбъектРасчетовПриемник, Стр.АналитикаУчетаПоПартнерамПриемник, Стр.ВалютаПриемник, Стр.Сторно));
				КонецЕсли;
			КонецЦикла;
			
			Если ТаблицаПриемников.Количество() > 0 Тогда
				ТаблицаПриемников.Свернуть("ОбъектРасчетовПриемник, АналитикаУчетаПоПартнерамПриемник, ВалютаПриемник, Сторно");
				ТаблицаРасчетыСПоставщиками.Индексы.Добавить("ОбъектРасчетов,АналитикаУчетаПоПартнерам,Валюта,Сторно");
				СтруктураПоиска = Новый Структура("ОбъектРасчетов,АналитикаУчетаПоПартнерам,Валюта,ПоДаннымОбъектаРасчетовИсточника,Сторно");
				Для Каждого Стр Из ТаблицаПриемников Цикл
					СтруктураПоиска.АналитикаУчетаПоПартнерам = Стр.АналитикаУчетаПоПартнерамПриемник;
					СтруктураПоиска.ОбъектРасчетов = Стр.ОбъектРасчетовПриемник;
					СтруктураПоиска.Валюта = Стр.ВалютаПриемник;
					СтруктураПоиска.Сторно = Стр.Сторно;
					СтруктураПоиска.ПоДаннымОбъектаРасчетовИсточника = Истина;
					
					ЕстьВПоставщиках = ТаблицаРасчетыСПоставщиками.НайтиСтроки(СтруктураПоиска).Количество() > 0;
					ЕстьВКлиентах = ТаблицаРасчетыСКлиентами <> Неопределено
										И ТаблицаРасчетыСКлиентами.НайтиСтроки(СтруктураПоиска).Количество() > 0;
					Если НЕ (ЕстьВКлиентах ИЛИ ЕстьВПоставщиках) Тогда
						Если ТаблицаРасчетыСКлиентами <> Неопределено Тогда
							ВызватьИсключение(СтрШаблон(НСтр("ru = 'Не найдены движения приемника в движениях по %1 и %2'"),
												Метаданные.РегистрыНакопления.РасчетыСКлиентами.Имя,
												Метаданные.РегистрыНакопления.РасчетыСПоставщиками.Имя));
						Иначе
							ВызватьИсключение(СтрШаблон(НСтр("ru = 'Не найдены движения приемника в движениях по %1'"),
												Метаданные.РегистрыНакопления.РасчетыСПоставщиками.Имя));
						КонецЕсли;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			
			Движения.РасчетыСПоставщиками.Записывать = Истина;
			Движения.РасчетыСПоставщиками.Загрузить(ТаблицаРасчетыСПоставщиками);
	КонецЕсли;
	
	Если Движения.Найти("РасчетыСПоставщиками") <> Неопределено
		И Движения.РасчетыСПоставщиками.Записывать
		И Не ЗначениеЗаполнено(ТаблицаРасчетыСПоставщиками) Тогда
		Движения.РасчетыСПоставщикамиПоДокументам.Записывать = Истина;
	КонецЕсли;
	
	#КонецОбласти
	
	#Область РасчетыСПоставщикамиПланОплат
	
	ИмяТаблицыРасчетыСПоставщикамиПланОплат = "Таблица" + "РасчетыСПоставщикамиПланОплат";
	Если ТаблицыДляДвижений.Свойство(ИмяТаблицыРасчетыСПоставщикамиПланОплат) Тогда
		
		ТаблицаРасчетыСПоставщикамиПланОплат = ТаблицыДляДвижений[ИмяТаблицыРасчетыСПоставщикамиПланОплат];

		Если ЗначениеЗаполнено(ТаблицаРасчетыСПоставщикамиПланОплат) Тогда
		
			ТипДокумента = ТипЗнч(Движения.РасчетыСПоставщикамиПланОплат.Отбор.Регистратор.Значение);
			ДобавитьЗаполнитьПорядокРасчетовСПоставщиками(ТаблицаРасчетыСПоставщикамиПланОплат, ТипДокумента);
			ПроверитьЗаполнитьАналитикуУчетаПоПартнерам(ТаблицаРасчетыСПоставщикамиПланОплат);
			
			Движения.РасчетыСПоставщикамиПланОплат.Записывать = Истина;
			Движения.РасчетыСПоставщикамиПланОплат.Загрузить(ТаблицаРасчетыСПоставщикамиПланОплат);
			
		КонецЕсли;
		
	КонецЕсли;
	
	#КонецОбласти
	
	#Область РасчетыСПоставщикамиПланПоставок
	
	ИмяТаблицыРасчетыСПоставщикамиПланПоставок = "Таблица" + "РасчетыСПоставщикамиПланПоставок";
	Если ТаблицыДляДвижений.Свойство(ИмяТаблицыРасчетыСПоставщикамиПланПоставок) Тогда
		
		ТаблицаРасчетыСПоставщикамиПланПоставок = ТаблицыДляДвижений[ИмяТаблицыРасчетыСПоставщикамиПланПоставок];

		Если ЗначениеЗаполнено(ТаблицаРасчетыСПоставщикамиПланПоставок) Тогда
		
			ТипДокумента = ТипЗнч(Движения.РасчетыСПоставщикамиПланПоставок.Отбор.Регистратор.Значение);
			ДобавитьЗаполнитьПорядокРасчетовСПоставщиками(ТаблицаРасчетыСПоставщикамиПланПоставок, ТипДокумента);
			ПроверитьЗаполнитьАналитикуУчетаПоПартнерам(ТаблицаРасчетыСПоставщикамиПланПоставок);
			
			Движения.РасчетыСПоставщикамиПланПоставок.Записывать = Истина;
			Движения.РасчетыСПоставщикамиПланПоставок.Загрузить(ТаблицаРасчетыСПоставщикамиПланПоставок);
			
		КонецЕсли;
		
	КонецЕсли;
	
	#КонецОбласти
	
	#Область РасчетыПоДисконтированию
	ПроведениеДокументов.ОтразитьДвижения(ТаблицыДляДвижений, Движения, "ПроцентныеРасходыДисконтирования");
	#КонецОбласти
	
КонецПроцедуры

// Формирует тексты запросов для контроля изменений записанных движений регистров.
//
// Параметры:
//  Запрос - Запрос - запрос, хранящий параметры используемые в списке запросов
//  ТекстыЗапроса - СписокЗначений - список текстов запросов и их имен.
//  Документ - ДокументОбъект - записываемый документ.
//
Процедура ИнициализироватьДанныеКонтроляИзменений(Запрос, ТекстыЗапроса, Документ) Экспорт
	
	#Область РасчетыСКлиентами
	
	Если ПроведениеДокументов.ЕстьЗаписиВТаблице(Документ, "ДвиженияРасчетыСКлиентамиИзменение") Тогда
		
		ТекстЗапроса =
			"ВЫБРАТЬ
			|	ТаблицаЗаказы.ОбъектРасчетов КАК ОбъектРасчетов,
			|	ТаблицаЗаказы.Валюта         КАК Валюта,
			|	СУММА(ВЫБОР
			|			КОГДА ТаблицаЗаказы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
			|				И ТаблицаЗаказы.ОбъектРасчетов.Объект = ТаблицаЗаказы.Регистратор
			|				И НЕ ТаблицаЗаказы.ИсключатьПриКонтроле ТОГДА
			|				ТаблицаЗаказы.КОплате
			|			ИНАЧЕ 0
			|		КОНЕЦ)                 КАК СуммаЗаказа,
			|	СУММА(ВЫБОР
			|			КОГДА ТаблицаЗаказы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
			|				ТОГДА ТаблицаЗаказы.Сумма
			|			ИНАЧЕ 0
			|		КОНЕЦ +
			|		ВЫБОР
			|			КОГДА ТаблицаЗаказы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
			|				ТОГДА -ТаблицаЗаказы.Оплачивается
			|			ИНАЧЕ ТаблицаЗаказы.Оплачивается
			|		КОНЕЦ)                 КАК СуммаОплаты
			|ИЗ
			|	РегистрНакопления.РасчетыСКлиентами КАК ТаблицаЗаказы
			|ГДЕ
			|	(ТаблицаЗаказы.ОбъектРасчетов, ТаблицаЗаказы.Валюта, ТаблицаЗаказы.Активность) В
			|			(ВЫБРАТЬ
			|				Таблица.ОбъектРасчетов,
			|				Таблица.Валюта,
			|				ИСТИНА
			|			ИЗ
			|				ДвиженияРасчетыСКлиентамиИзменение КАК Таблица)
			|
			|СГРУППИРОВАТЬ ПО
			|	ТаблицаЗаказы.Валюта,
			|	ТаблицаЗаказы.ОбъектРасчетов
			|
			|ИМЕЮЩИЕ
			|	СУММА(ВЫБОР
			|			КОГДА ТаблицаЗаказы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
			|				И ТаблицаЗаказы.ОбъектРасчетов.Объект = ТаблицаЗаказы.Регистратор
			|				И НЕ ТаблицаЗаказы.ИсключатьПриКонтроле ТОГДА
			|				ТаблицаЗаказы.КОплате
			|			ИНАЧЕ 0
			|		КОНЕЦ) > 0
			|	И
			|	СУММА(ВЫБОР
			|			КОГДА ТаблицаЗаказы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
			|				И ТаблицаЗаказы.ОбъектРасчетов.Объект = ТаблицаЗаказы.Регистратор
			|				И НЕ ТаблицаЗаказы.ИсключатьПриКонтроле ТОГДА
			|				ТаблицаЗаказы.КОплате
			|			ИНАЧЕ 0
			|		КОНЕЦ)
			|	>
			|	СУММА(ВЫБОР
			|			КОГДА ТаблицаЗаказы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
			|				ТОГДА ТаблицаЗаказы.Сумма
			|			ИНАЧЕ 0
			|		КОНЕЦ +
			|		ВЫБОР
			|			КОГДА ТаблицаЗаказы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
			|				ТОГДА -ТаблицаЗаказы.Оплачивается
			|			ИНАЧЕ ТаблицаЗаказы.Оплачивается
			|		КОНЕЦ)";
		
		ТекстыЗапроса.Добавить(ТекстЗапроса, "ОшибкиРасчетыСКлиентами");
		
	КонецЕсли;
	
	#КонецОбласти
	
	#Область СуммыСрокЗадолженности
		
	Если ПроведениеДокументов.ЕстьЗаписиВТаблице(Документ, "ДвиженияРасчетыСКлиентамиИзменениеСуммыДолга")
		Или ПроведениеДокументов.ЕстьЗаписиВТаблице(Документ, "ДвиженияРасчетыСКлиентамиИзменениеКонтрольСрока") Тогда
		
		ТекстыЗапроса.Добавить(
			"ВЫБРАТЬ
			|	ДвиженияРасчетыСКлиентамиИзменениеСуммыДолга.АналитикаУчетаПоПартнерам.Договор КАК Договор
			|ПОМЕСТИТЬ ДанныеДоговоровИзменениеСуммыДолга
			|ИЗ
			|	ДвиженияРасчетыСКлиентамиИзменениеСуммыДолга КАК ДвиженияРасчетыСКлиентамиИзменениеСуммыДолга
			|
			|ИНДЕКСИРОВАТЬ ПО
			|	Договор");
		
		ТекстыЗапроса.Добавить(
			"ВЫБРАТЬ
			|	ДвиженияРасчетыСКлиентамиИзменениеКонтрольСрока.АналитикаУчетаПоПартнерам.Договор КАК Договор
			|ПОМЕСТИТЬ ДанныеДоговоровИзменениеКонтрольСрока
			|ИЗ
			|	ДвиженияРасчетыСКлиентамиИзменениеКонтрольСрока КАК ДвиженияРасчетыСКлиентамиИзменениеКонтрольСрока
			|
			|ИНДЕКСИРОВАТЬ ПО
			|	Договор");
		
		ТекстыЗапроса.Добавить(
			"ВЫБРАТЬ
			|	ТаблицаДвижений.Договор                             КАК Договор,
			|	ДанныеДоговора.ВалютаВзаиморасчетов                 КАК Валюта,
			|	ДанныеДоговора.ОграничиватьСуммуЗадолженности       КАК ОграничиватьСуммуЗадолженности,
			|	ДанныеДоговора.ДопустимаяСуммаЗадолженности         КАК ДопустимаяСуммаЗадолженности,
			|	ЛОЖЬ                                                КАК ЗапрещаетсяПросроченнаяЗадолженность
			|
			|ПОМЕСТИТЬ ДанныеДоговоровПредварительные
			|ИЗ
			|	ДанныеДоговоровИзменениеСуммыДолга КАК ТаблицаДвижений
			|	
			|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
			|		Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
			|	ПО
			|		ТаблицаДвижений.Договор = ДанныеДоговора.Ссылка
			|
			|ГДЕ
			|	ДанныеДоговора.ОграничиватьСуммуЗадолженности
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	ТаблицаДвижений.ОбъектРасчетов                      КАК Договор,
			|	ДанныеДоговора.ВалютаВзаиморасчетов                 КАК Валюта,
			|	ДанныеДоговора.ОграничиватьСуммуЗадолженности       КАК ОграничиватьСуммуЗадолженности,
			|	ДанныеДоговора.ДопустимаяСуммаЗадолженности         КАК ДопустимаяСуммаЗадолженности,
			|	ЛОЖЬ                                                КАК ЗапрещаетсяПросроченнаяЗадолженность
			|
			|ИЗ
			|	ДвиженияРасчетыСКлиентамиИзменениеСуммыДолга КАК ТаблицаДвижений
			|	
			|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
			|		Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
			|	ПО
			|		ТаблицаДвижений.ОбъектРасчетов = ДанныеДоговора.Ссылка
			|
			|ГДЕ
			|	ДанныеДоговора.ОграничиватьСуммуЗадолженности
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	ТаблицаДвижений.Договор                             КАК Договор,
			|	ДанныеДоговора.ВалютаВзаиморасчетов                 КАК Валюта,
			|	ЛОЖЬ                                                КАК ОграничиватьСуммуЗадолженности,
			|	0                                                   КАК ДопустимаяСуммаЗадолженности,
			|	ДанныеДоговора.ЗапрещаетсяПросроченнаяЗадолженность КАК ЗапрещаетсяПросроченнаяЗадолженность
			|
			|ИЗ
			|	ДанныеДоговоровИзменениеКонтрольСрока КАК ТаблицаДвижений
			|	
			|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
			|		Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
			|	ПО
			|		ТаблицаДвижений.Договор = ДанныеДоговора.Ссылка
			|
			|ГДЕ
			|	ДанныеДоговора.ЗапрещаетсяПросроченнаяЗадолженность
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	ТаблицаДвижений.ОбъектРасчетов                      КАК Договор,
			|	ДанныеДоговора.ВалютаВзаиморасчетов                 КАК Валюта,
			|	ЛОЖЬ                                                КАК ОграничиватьСуммуЗадолженности,
			|	0                                                   КАК ДопустимаяСуммаЗадолженности,
			|	ДанныеДоговора.ЗапрещаетсяПросроченнаяЗадолженность КАК ЗапрещаетсяПросроченнаяЗадолженность
			|
			|ИЗ
			|	ДвиженияРасчетыСКлиентамиИзменениеКонтрольСрока КАК ТаблицаДвижений
			|	
			|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
			|		Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
			|	ПО
			|		ТаблицаДвижений.ОбъектРасчетов = ДанныеДоговора.Ссылка
			|
			|ГДЕ
			|	ДанныеДоговора.ЗапрещаетсяПросроченнаяЗадолженность");
		
		ТекстыЗапроса.Добавить(
			"ВЫБРАТЬ
			|	ДанныеДоговоров.Договор                                        КАК Договор,
			|	ДанныеДоговоров.Валюта                                         КАК Валюта,
			|	МАКСИМУМ(ДанныеДоговоров.ОграничиватьСуммуЗадолженности)       КАК КонтрольСуммы,
			|	МАКСИМУМ(ДанныеДоговоров.ДопустимаяСуммаЗадолженности)         КАК ДопустимаяСумма,
			|	МАКСИМУМ(ДанныеДоговоров.ЗапрещаетсяПросроченнаяЗадолженность) КАК КонтрольСрока
			|
			|ПОМЕСТИТЬ ДанныеДоговоров
			|ИЗ
			|	ДанныеДоговоровПредварительные КАК ДанныеДоговоров
			|
			|СГРУППИРОВАТЬ ПО
			|	ДанныеДоговоров.Договор,
			|	ДанныеДоговоров.Валюта");
		
		ТекстыЗапроса.Добавить(
			"ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	АналитикаПоПартнерам.КлючАналитики КАК КлючАналитики,
			|	ДанныеДоговоров.Договор            КАК Договор,
			|	ДанныеДоговоров.Валюта             КАК Валюта,
			|	ДанныеДоговоров.КонтрольСуммы      КАК КонтрольСуммы,
			|	ДанныеДоговоров.КонтрольСрока      КАК КонтрольСрока
			|
			|ПОМЕСТИТЬ ВтАналитикаПоПартнерам
			|ИЗ
			|	РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаПоПартнерам
			|	
			|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДанныеДоговоров КАК ДанныеДоговоров
			|	ПО
			|		АналитикаПоПартнерам.Договор = ДанныеДоговоров.Договор
			|");
			
			ТекстыЗапроса.Добавить("
			|ВЫБРАТЬ
			|	РасчетыСКлиентамиОстатки.ОбъектРасчетов           КАК ОбъектРасчетов,
			|	РасчетыСКлиентамиОстатки.Валюта                   КАК Валюта,
			|	РасчетыСКлиентамиОстатки.ОплачиваетсяОстаток      КАК ОплачиваетсяОстаток
			|ПОМЕСТИТЬ ОстаткиОплачивается
			|ИЗ РегистрНакопления.РасчетыСКлиентами.Остатки(
			|		&ПериодКонтроляСрокаДолга,
			|		(АналитикаУчетаПоПартнерам, Валюта) В (ВЫБРАТЬ Т.КлючАналитики, Т.Валюта ИЗ ВтАналитикаПоПартнерам КАК Т ГДЕ Т.КонтрольСрока)
			|	) КАК РасчетыСКлиентамиОстатки
			|ИНДЕКСИРОВАТЬ ПО
			|	ОбъектРасчетов,Валюта");
		
		Если ПроведениеДокументов.ЕстьЗаписиВТаблице(Документ, "ДвиженияРасчетыСКлиентамиИзменениеСуммыДолга") Тогда
			
			ТекстЗапроса = "
			|ВЫБРАТЬ
			|	АналитикаПоПартнерам.Договор                              КАК Договор,
			|	РасчетыСКлиентамиОстатки.Валюта                           КАК Валюта,
			|	МИНИМУМ(ДанныеДоговоров.ДопустимаяСумма)                  КАК ДопустимаяСуммаЗадолженности,
			|	СУММА(РасчетыСКлиентамиОстатки.СуммаОстаток) +
			|		СУММА(РасчетыСКлиентамиОстатки.ОтгружаетсяОстаток)    КАК СуммаОстаток,
			|
			|	СУММА(РасчетыСКлиентамиОстатки.СуммаОстаток) +
			|		СУММА(РасчетыСКлиентамиОстатки.ОтгружаетсяОстаток) -
			|		МИНИМУМ(ДанныеДоговоров.ДопустимаяСумма)              КАК СуммаПревышения
			|
			|ИЗ
			|	РегистрНакопления.РасчетыСКлиентами.Остатки(
			|		,
			|		(АналитикаУчетаПоПартнерам, Валюта) В (ВЫБРАТЬ Т.КлючАналитики, Т.Валюта ИЗ ВтАналитикаПоПартнерам КАК Т ГДЕ Т.КонтрольСуммы)
			|	) КАК РасчетыСКлиентамиОстатки
			|	
			|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
			|		ВтАналитикаПоПартнерам КАК АналитикаПоПартнерам
			|	ПО
			|		РасчетыСКлиентамиОстатки.АналитикаУчетаПоПартнерам = АналитикаПоПартнерам.КлючАналитики
			|		И РасчетыСКлиентамиОстатки.Валюта = АналитикаПоПартнерам.Валюта
			|	
			|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
			|		ДанныеДоговоров КАК ДанныеДоговоров
			|	ПО
			|		АналитикаПоПартнерам.Договор = ДанныеДоговоров.Договор
			|		И АналитикаПоПартнерам.Валюта = ДанныеДоговоров.Валюта
			|
			|СГРУППИРОВАТЬ ПО
			|	АналитикаПоПартнерам.Договор,
			|	РасчетыСКлиентамиОстатки.Валюта
			|ИМЕЮЩИЕ
			|	СУММА(РасчетыСКлиентамиОстатки.СуммаОстаток)+
			|		СУММА(РасчетыСКлиентамиОстатки.ОтгружаетсяОстаток) > МИНИМУМ(ДанныеДоговоров.ДопустимаяСумма)";
			
			ТекстыЗапроса.Добавить(ТекстЗапроса, "ОшибкиОграничениеСуммыЗадолженности");
			
		КонецЕсли;
		
		Если ПроведениеДокументов.ЕстьЗаписиВТаблице(Документ, "ДвиженияРасчетыСКлиентамиИзменениеКонтрольСрока") Тогда
			
			ТекстЗапроса =
				"ВЫБРАТЬ
				|	АналитикаПоПартнерам.Договор                              КАК Договор,
				|	РасчетыСКлиентамиОстатки.Валюта                           КАК Валюта,
				|	СУММА(ВЫБОР КОГДА РасчетыСКлиентамиОстатки.СуммаОстаток >
				|						РасчетыСКлиентамиОстатки.КОплатеОстаток - РасчетыСКлиентамиОстатки.ОплачиваетсяОстаток ТОГДА
				|		РасчетыСКлиентамиОстатки.КОплатеОстаток - РасчетыСКлиентамиОстатки.ОплачиваетсяОстаток
				|	ИНАЧЕ
				|		РасчетыСКлиентамиОстатки.СуммаОстаток
				|	КОНЕЦ) КАК ПросроченнаяЗадолженность
				|
				|ИЗ
				|	РегистрНакопления.РасчетыСКлиентами.Остатки(
				|		&ПериодКонтроляСрокаДолга,
				|		(АналитикаУчетаПоПартнерам, Валюта) В (ВЫБРАТЬ Т.КлючАналитики, Т.Валюта ИЗ ВтАналитикаПоПартнерам КАК Т ГДЕ Т.КонтрольСрока)
				|	) КАК РасчетыСКлиентамиОстатки
				|	
				|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
				|		ВтАналитикаПоПартнерам КАК АналитикаПоПартнерам
				|	ПО
				|		РасчетыСКлиентамиОстатки.АналитикаУчетаПоПартнерам = АналитикаПоПартнерам.КлючАналитики
				|		И РасчетыСКлиентамиОстатки.Валюта = АналитикаПоПартнерам.Валюта
				|	
				|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
				|		ДанныеДоговоров КАК ДанныеДоговоров
				|	ПО
				|		АналитикаПоПартнерам.Договор = ДанныеДоговоров.Договор
				|		И АналитикаПоПартнерам.Валюта = ДанныеДоговоров.Валюта
				|
				|ГДЕ
				|	НЕ &НоваяАрхитектураВзаиморасчетов
				|	И РасчетыСКлиентамиОстатки.СуммаОстаток > 0
				|	И (РасчетыСКлиентамиОстатки.КОплатеОстаток - РасчетыСКлиентамиОстатки.ОплачиваетсяОстаток) > 0
				|
				|СГРУППИРОВАТЬ ПО
				|	АналитикаПоПартнерам.Договор,
				|	РасчетыСКлиентамиОстатки.Валюта
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	АналитикаПоПартнерам.Договор                              КАК Договор,
				|	РасчетыСКлиентамиПоСрокамОстатки.Валюта                   КАК Валюта,
				|	СУММА(РасчетыСКлиентамиПоСрокамОстатки.ДолгОстаток 
				|			- ЕСТЬNULL(ОстаткиОплачивается.ОплачиваетсяОстаток,0)) КАК ПросроченнаяЗадолженность
				|
				|ИЗ
				|	РегистрНакопления.РасчетыСКлиентамиПоСрокам.Остатки(
				|		&ПериодКонтроляСрокаДолга,
				|		(АналитикаУчетаПоПартнерам, Валюта) В (ВЫБРАТЬ Т.КлючАналитики, Т.Валюта ИЗ ВтАналитикаПоПартнерам КАК Т ГДЕ Т.КонтрольСрока)
				|		И ДатаПлановогоПогашения < НАЧАЛОПЕРИОДА(&ДеньКонтроляСрокаДолга,ДЕНЬ)
				|	) КАК РасчетыСКлиентамиПоСрокамОстатки
				|	
				|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
				|		ВтАналитикаПоПартнерам КАК АналитикаПоПартнерам
				|	ПО
				|		РасчетыСКлиентамиПоСрокамОстатки.АналитикаУчетаПоПартнерам = АналитикаПоПартнерам.КлючАналитики
				|		И РасчетыСКлиентамиПоСрокамОстатки.Валюта = АналитикаПоПартнерам.Валюта
				|	
				|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
				|		ДанныеДоговоров КАК ДанныеДоговоров
				|	ПО
				|		АналитикаПоПартнерам.Договор = ДанныеДоговоров.Договор
				|		И АналитикаПоПартнерам.Валюта = ДанныеДоговоров.Валюта
				|
				|	ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиОплачивается КАК ОстаткиОплачивается
				|	ПО
				|		РасчетыСКлиентамиПоСрокамОстатки.ОбъектРасчетов = ОстаткиОплачивается.ОбъектРасчетов
				|		И РасчетыСКлиентамиПоСрокамОстатки.Валюта = ОстаткиОплачивается.Валюта
				|ГДЕ
				|	&НоваяАрхитектураВзаиморасчетов
				|
				|СГРУППИРОВАТЬ ПО
				|	АналитикаПоПартнерам.Договор,
				|	РасчетыСКлиентамиПоСрокамОстатки.Валюта
				|
				|ИМЕЮЩИЕ СУММА(РасчетыСКлиентамиПоСрокамОстатки.ДолгОстаток
				|			- ЕСТЬNULL(ОстаткиОплачивается.ОплачиваетсяОстаток,0)) > 0";
			
			Запрос.УстановитьПараметр("НоваяАрхитектураВзаиморасчетов", Константы.НоваяАрхитектураВзаиморасчетов.Получить());
			
			ТекстыЗапроса.Добавить(ТекстЗапроса, "ОшибкиКонтрольСрокаЗадолженности");
			
		КонецЕсли;
		
		ДеньКонтроляСрокаДолга = Макс(ТекущаяДатаСеанса(), Документ.Дата);
		Запрос.УстановитьПараметр("ПериодКонтроляСрокаДолга", Новый Граница(КонецДня(ДеньКонтроляСрокаДолга), ВидГраницы.Включая));
		Запрос.УстановитьПараметр("ДеньКонтроляСрокаДолга", ДеньКонтроляСрокаДолга);
		
	КонецЕсли;
	
	Если ПроведениеДокументов.ЕстьЗаписиВТаблице(Документ, "ДвиженияРасчетыСКлиентамиИзменениеОплачивается") Тогда
		
		ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ТаблицаОстатков.АналитикаУчетаПоПартнерам           КАК АналитикаУчетаПоПартнерам,
		|	ТаблицаОстатков.ОбъектРасчетов                      КАК ОбъектРасчетов,
		|	ТаблицаОстатков.Валюта                              КАК Валюта,
		|	ТаблицаОстатков.ЗаявкаНаРасходованиеДенежныхСредств КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	СУММА(ВЫБОР КОГДА ТаблицаОстатков.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА
		|			ТаблицаОстатков.Оплачивается
		|		ИНАЧЕ
		|			-ТаблицаОстатков.Оплачивается
		|		КОНЕЦ) КАК Сумма
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентами КАК ТаблицаОстатков
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДвиженияРасчетыСКлиентамиИзменениеОплачивается КАК Таблица
		|	ПО Таблица.АналитикаУчетаПоПартнерам = ТаблицаОстатков.АналитикаУчетаПоПартнерам
		|		И Таблица.ОбъектРасчетов = ТаблицаОстатков.ОбъектРасчетов
		|		И Таблица.Валюта = ТаблицаОстатков.Валюта
		|		И Таблица.ЗаявкаНаРасходованиеДенежныхСредств = ТаблицаОстатков.ЗаявкаНаРасходованиеДенежныхСредств
		|ГДЕ
		|	ТаблицаОстатков.ЗаявкаНаРасходованиеДенежныхСредств <> ЗНАЧЕНИЕ(Документ.ЗаявкаНаРасходованиеДенежныхСредств.ПустаяСсылка)
		|СГРУППИРОВАТЬ ПО
		|	ТаблицаОстатков.АналитикаУчетаПоПартнерам,
		|	ТаблицаОстатков.ОбъектРасчетов,
		|	ТаблицаОстатков.Валюта,
		|	ТаблицаОстатков.ЗаявкаНаРасходованиеДенежныхСредств
		|ИМЕЮЩИЕ
		|	СУММА(ВЫБОР КОГДА ТаблицаОстатков.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА
		|			ТаблицаОстатков.Оплачивается
		|		ИНАЧЕ
		|			-ТаблицаОстатков.Оплачивается
		|		КОНЕЦ) > 0
		|";
		
		ТекстыЗапроса.Добавить(ТекстЗапроса, "ОшибкиОплачивается");
		
	КонецЕсли;
	
	#КонецОбласти
	
	#Область Авансы
	
	Если ПроведениеДокументов.ЕстьЗаписиВТаблице(Документ, "РасчетыСКлиентамиИзменения") Тогда
		
		ТекстЗапроса =
			"ВЫБРАТЬ
			|	РасчетыСКлиентамиОстатки.ОбъектРасчетов        КАК ДокументАванса,
			|	РасчетыСКлиентамиОстатки.Валюта                КАК Валюта,
			|	РасчетыСКлиентамиОстатки.СуммаОстаток          КАК СуммаПревышения,
			|	СУММА(РасчетыСКлиентамиИзменения.Сумма)        КАК СуммаУменьшенияЗачета,
			|	МАКСИМУМ(РасчетыСКлиентамиИзменения.ВызыватьИсключение) КАК ВызыватьИсключение
			|	
			|ИЗ
			|	РегистрНакопления.РасчетыСКлиентами.Остатки(,
			|		(ОбъектРасчетов, Валюта) В (ВЫБРАТЬ ОбъектРасчетов, ВалютаРасчетов ИЗ РасчетыСКлиентамиИзменения ГДЕ Сумма <> 0)) КАК РасчетыСКлиентамиОстатки
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РасчетыСКлиентамиИзменения КАК РасчетыСКлиентамиИзменения
			|			ПО РасчетыСКлиентамиИзменения.ОбъектРасчетов = РасчетыСКлиентамиОстатки.ОбъектРасчетов
			|				И РасчетыСКлиентамиИзменения.ВалютаРасчетов = РасчетыСКлиентамиОстатки.Валюта
			|ГДЕ
			|	РасчетыСКлиентамиОстатки.СуммаОстаток > 0
			|	И (ТИПЗНАЧЕНИЯ(РасчетыСКлиентамиОстатки.ОбъектРасчетов.Объект) В (ТИП(Документ.ПоступлениеБезналичныхДенежныхСредств),
			|													ТИП(Документ.ПриходныйКассовыйОрдер),
			|													ТИП(Справочник.ПодарочныеСертификаты),
			|													ТИП(Документ.ВводОстатков),
			|													ТИП(Документ.ВводОстатковВзаиморасчетов))
			|		ИЛИ ТИПЗНАЧЕНИЯ(РасчетыСКлиентамиОстатки.ОбъектРасчетов.Объект) = ТИП(Документ.ОперацияПоПлатежнойКарте)
			|			И ВЫРАЗИТЬ(РасчетыСКлиентамиОстатки.ОбъектРасчетов.Объект КАК Документ.ОперацияПоПлатежнойКарте).ХозяйственнаяОперация
			|				= ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОплатыОтКлиента))
			|СГРУППИРОВАТЬ ПО
			|	РасчетыСКлиентамиОстатки.ОбъектРасчетов,
			|	РасчетыСКлиентамиОстатки.Валюта,
			|	РасчетыСКлиентамиОстатки.СуммаОстаток
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	РасчетыСКлиентамиОстатки.ОбъектРасчетов        КАК ДокументАванса,
			|	РасчетыСКлиентамиОстатки.Валюта                КАК Валюта,
			|	РасчетыСКлиентамиОстатки.СуммаОстаток          КАК СуммаПревышения,
			|	СУММА(РасчетыСКлиентамиИзменения.Сумма)        КАК СуммаУменьшенияЗачета,
			|	МАКСИМУМ(РасчетыСКлиентамиИзменения.ВызыватьИсключение) КАК ВызыватьИсключение
			|	
			|ИЗ
			|	РегистрНакопления.РасчетыСКлиентами.Остатки(,
			|		(ОбъектРасчетов, Валюта) В (ВЫБРАТЬ ОбъектРасчетов, ВалютаРасчетов ИЗ РасчетыСКлиентамиИзменения ГДЕ Сумма <> 0 И ОбъектРасчетов.КонтролироватьОстаткиАвансов)
			|	) КАК РасчетыСКлиентамиОстатки
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Константа.КонтролироватьОстаткиАвансов КАК ЗначениеКонстанты
			|			ПО ЗначениеКонстанты.Значение
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РасчетыСКлиентамиИзменения КАК РасчетыСКлиентамиИзменения
			|			ПО РасчетыСКлиентамиИзменения.ОбъектРасчетов = РасчетыСКлиентамиОстатки.ОбъектРасчетов
			|				И РасчетыСКлиентамиИзменения.ВалютаРасчетов = РасчетыСКлиентамиОстатки.Валюта
			|ГДЕ
			|	РасчетыСКлиентамиОстатки.СуммаОстаток > 0
			|СГРУППИРОВАТЬ ПО
			|	РасчетыСКлиентамиОстатки.ОбъектРасчетов,
			|	РасчетыСКлиентамиОстатки.Валюта,
			|	РасчетыСКлиентамиОстатки.СуммаОстаток
			|";
		

		ТекстыЗапроса.Добавить(ТекстЗапроса, "ОшибкиКонтрольЗачтенныхАвансовПоНакладнымКлиент");
		
	КонецЕсли;
	
	Если ПроведениеДокументов.ЕстьЗаписиВТаблице(Документ, "РасчетыСПоставщикамиИзменения") Тогда
		
		ТекстЗапроса =
			"ВЫБРАТЬ
			|	РасчетыСПоставщикамиОстатки.ОбъектРасчетов           КАК ДокументАванса,
			|	РасчетыСПоставщикамиОстатки.Валюта                   КАК Валюта,
			|	-РасчетыСПоставщикамиОстатки.СуммаОстаток             КАК СуммаПревышения,
			|	СУММА(РасчетыСПоставщикамиИзменения.Сумма)               КАК СуммаУменьшенияЗачета,
			|	МАКСИМУМ(РасчетыСПоставщикамиИзменения.ВызыватьИсключение) КАК ВызыватьИсключение
			|
			|ИЗ
			|	РегистрНакопления.РасчетыСПоставщиками.Остатки(,
			|		(ОбъектРасчетов, Валюта) В (ВЫБРАТЬ ОбъектРасчетов, ВалютаРасчетов ИЗ РасчетыСПоставщикамиИзменения ГДЕ Сумма <> 0)) КАК РасчетыСПоставщикамиОстатки
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РасчетыСПоставщикамиИзменения КАК РасчетыСПоставщикамиИзменения
			|			ПО РасчетыСПоставщикамиИзменения.ОбъектРасчетов = РасчетыСПоставщикамиОстатки.ОбъектРасчетов
			|				И РасчетыСПоставщикамиИзменения.ВалютаРасчетов = РасчетыСПоставщикамиОстатки.Валюта
			|				И РасчетыСПоставщикамиИзменения.Сумма <> 0
			|ГДЕ
			|	РасчетыСПоставщикамиОстатки.СуммаОстаток < 0
			|	И ТИПЗНАЧЕНИЯ(РасчетыСПоставщикамиОстатки.ОбъектРасчетов.Объект) В (ТИП(Документ.СписаниеБезналичныхДенежныхСредств),
			|													ТИП(Документ.РасходныйКассовыйОрдер),
			|													ТИП(Документ.ВводОстатков),
			|													ТИП(Документ.ВводОстатковВзаиморасчетов))
			|СГРУППИРОВАТЬ ПО
			|	РасчетыСПоставщикамиОстатки.ОбъектРасчетов,
			|	РасчетыСПоставщикамиОстатки.Валюта,
			|	-РасчетыСПоставщикамиОстатки.СуммаОстаток
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	РасчетыСПоставщикамиОстатки.ОбъектРасчетов           КАК ДокументАванса,
			|	РасчетыСПоставщикамиОстатки.Валюта                   КАК Валюта,
			|	-РасчетыСПоставщикамиОстатки.СуммаОстаток            КАК СуммаПревышения,
			|	СУММА(РасчетыСПоставщикамиИзменения.Сумма)           КАК СуммаУменьшенияЗачета,
			|	МАКСИМУМ(РасчетыСПоставщикамиИзменения.ВызыватьИсключение) КАК ВызыватьИсключение
			|
			|ИЗ
			|	РегистрНакопления.РасчетыСПоставщиками.Остатки(,
			|		(ОбъектРасчетов, Валюта) В (ВЫБРАТЬ ОбъектРасчетов, ВалютаРасчетов ИЗ РасчетыСПоставщикамиИзменения ГДЕ Сумма <> 0 И ОбъектРасчетов.КонтролироватьОстаткиАвансов)
			|	) КАК РасчетыСПоставщикамиОстатки
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Константа.КонтролироватьОстаткиАвансов КАК ЗначениеКонстанты
			|			ПО ЗначениеКонстанты.Значение
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РасчетыСПоставщикамиИзменения КАК РасчетыСПоставщикамиИзменения
			|			ПО РасчетыСПоставщикамиИзменения.ОбъектРасчетов = РасчетыСПоставщикамиОстатки.ОбъектРасчетов
			|				И РасчетыСПоставщикамиИзменения.ВалютаРасчетов = РасчетыСПоставщикамиОстатки.Валюта
			|				И РасчетыСПоставщикамиИзменения.Сумма <> 0
			|ГДЕ
			|	РасчетыСПоставщикамиОстатки.СуммаОстаток < 0
			|СГРУППИРОВАТЬ ПО
			|	РасчетыСПоставщикамиОстатки.ОбъектРасчетов,
			|	РасчетыСПоставщикамиОстатки.Валюта,
			|	-РасчетыСПоставщикамиОстатки.СуммаОстаток
			|	
			|";
		
		ТекстыЗапроса.Добавить(ТекстЗапроса, "ОшибкиКонтрольЗачтенныхАвансовПоНакладнымПоставщик");
		
	КонецЕсли;
	
	#КонецОбласти
	
	#Область ВводОстатков
	
	Если ПроведениеДокументов.ЕстьЗаписиВТаблице(Документ, "РасчетыСКлиентамиИзмененияВводОстатков") Тогда
		
		ТекстЗапроса =
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	РасчетыСКлиентамиИзменения.АналитикаУчетаПоПартнерам  КАК АналитикаУчетаПоПартнерам,
			|	РасчетыСКлиентамиИзменения.ОбъектРасчетов             КАК ОбъектРасчетов
			|ИЗ
			|	РасчетыСКлиентамиИзмененияВводОстатков КАК РасчетыСКлиентамиИзменения
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентами КАК РасчетыСКлиентами
			|			ПО РасчетыСКлиентамиИзменения.АналитикаУчетаПоПартнерам = РасчетыСКлиентами.АналитикаУчетаПоПартнерам
			|				И РасчетыСКлиентамиИзменения.ОбъектРасчетов = РасчетыСКлиентами.ОбъектРасчетов
			|				И РасчетыСКлиентамиИзменения.Период < РасчетыСКлиентами.Период 
			|				И ТИПЗНАЧЕНИЯ(РасчетыСКлиентами.Регистратор) В (ТИП(Документ.ВводОстатков),ТИП(Документ.ВводОстатковВзаиморасчетов))
			|				И РасчетыСКлиентами.Сумма <> 0
			|	
			|ГДЕ
			|	НЕ ТИПЗНАЧЕНИЯ(РасчетыСКлиентамиИзменения.Регистратор) В (ТИП(Документ.ВводОстатков),ТИП(Документ.ВводОстатковВзаиморасчетов))
			|";
		
		ТекстыЗапроса.Добавить(ТекстЗапроса, "ОшибкиЕстьВводОстатковПослеКлиенты");
		
		ТекстЗапроса =
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	РасчетыСКлиентамиИзменения.АналитикаУчетаПоПартнерам  КАК АналитикаУчетаПоПартнерам,
			|	РасчетыСКлиентамиИзменения.ОбъектРасчетов             КАК ОбъектРасчетов
			|ИЗ
			|	РасчетыСКлиентамиИзмененияВводОстатков КАК РасчетыСКлиентамиИзменения
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентами КАК РасчетыСКлиентами
			|			ПО РасчетыСКлиентамиИзменения.АналитикаУчетаПоПартнерам = РасчетыСКлиентами.АналитикаУчетаПоПартнерам
			|				И РасчетыСКлиентамиИзменения.ОбъектРасчетов = РасчетыСКлиентами.ОбъектРасчетов
			|				И РасчетыСКлиентамиИзменения.Период > РасчетыСКлиентами.Период 
			|				И НЕ ТИПЗНАЧЕНИЯ(РасчетыСКлиентами.Регистратор) В (ТИП(Документ.ВводОстатков),ТИП(Документ.ВводОстатковВзаиморасчетов))
			|				И РасчетыСКлиентами.Сумма <> 0
			|	
			|ГДЕ
			|	ТИПЗНАЧЕНИЯ(РасчетыСКлиентамиИзменения.Регистратор) В (ТИП(Документ.ВводОстатков),ТИП(Документ.ВводОстатковВзаиморасчетов))
			|";
		
		ТекстыЗапроса.Добавить(ТекстЗапроса, "ОшибкиЕстьДвиженияДоКлиенты");
		
	КонецЕсли;
	
	Если ПроведениеДокументов.ЕстьЗаписиВТаблице(Документ, "РасчетыСПоставщикамиИзмененияВводОстатков") Тогда
		
		ТекстЗапроса =
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	РасчетыСПоставщикамиИзменения.АналитикаУчетаПоПартнерам  КАК АналитикаУчетаПоПартнерам,
			|	РасчетыСПоставщикамиИзменения.ОбъектРасчетов             КАК ОбъектРасчетов
			|ИЗ
			|	РасчетыСПоставщикамиИзмененияВводОстатков КАК РасчетыСПоставщикамиИзменения
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСПоставщиками КАК РасчетыСПоставщиками
			|			ПО РасчетыСПоставщикамиИзменения.АналитикаУчетаПоПартнерам = РасчетыСПоставщиками.АналитикаУчетаПоПартнерам
			|				И РасчетыСПоставщикамиИзменения.ОбъектРасчетов = РасчетыСПоставщиками.ОбъектРасчетов
			|				И РасчетыСПоставщикамиИзменения.Период < РасчетыСПоставщиками.Период 
			|				И ТИПЗНАЧЕНИЯ(РасчетыСПоставщиками.Регистратор) В (ТИП(Документ.ВводОстатков),ТИП(Документ.ВводОстатковВзаиморасчетов))
			|				И РасчетыСПоставщиками.Сумма <> 0
			|	
			|ГДЕ
			|	НЕ ТИПЗНАЧЕНИЯ(РасчетыСПоставщикамиИзменения.Регистратор) В (ТИП(Документ.ВводОстатков),ТИП(Документ.ВводОстатковВзаиморасчетов))
			|";
		
		ТекстыЗапроса.Добавить(ТекстЗапроса, "ОшибкиЕстьВводОстатковПослеПоставщики");
		
		ТекстЗапроса =
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	РасчетыСПоставщикамиИзменения.АналитикаУчетаПоПартнерам  КАК АналитикаУчетаПоПартнерам,
			|	РасчетыСПоставщикамиИзменения.ОбъектРасчетов             КАК ОбъектРасчетов
			|ИЗ
			|	РасчетыСПоставщикамиИзмененияВводОстатков КАК РасчетыСПоставщикамиИзменения
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСПоставщиками КАК РасчетыСПоставщиками
			|			ПО РасчетыСПоставщикамиИзменения.АналитикаУчетаПоПартнерам = РасчетыСПоставщиками.АналитикаУчетаПоПартнерам
			|				И РасчетыСПоставщикамиИзменения.ОбъектРасчетов = РасчетыСПоставщиками.ОбъектРасчетов
			|				И РасчетыСПоставщикамиИзменения.Период > РасчетыСПоставщиками.Период 
			|				И НЕ ТИПЗНАЧЕНИЯ(РасчетыСПоставщиками.Регистратор) В (ТИП(Документ.ВводОстатков),ТИП(Документ.ВводОстатковВзаиморасчетов))
			|				И РасчетыСПоставщиками.Сумма <> 0
			|	
			|ГДЕ
			|	ТИПЗНАЧЕНИЯ(РасчетыСПоставщикамиИзменения.Регистратор) В (ТИП(Документ.ВводОстатков),ТИП(Документ.ВводОстатковВзаиморасчетов))
			|";
		
		ТекстыЗапроса.Добавить(ТекстЗапроса, "ОшибкиЕстьДвиженияДоПоставщики");
		
	КонецЕсли;
	#КонецОбласти
	
	#Область РасчетыСПоставщиками
	
	Если ПроведениеДокументов.ЕстьЗаписиВТаблице(Документ, "ДвиженияРасчетыСПоставщикамиИзменениеОплачивается") Тогда
		
		ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ТаблицаОстатков.АналитикаУчетаПоПартнерам           КАК АналитикаУчетаПоПартнерам,
		|	ТаблицаОстатков.ОбъектРасчетов                      КАК ОбъектРасчетов,
		|	ТаблицаОстатков.Валюта                              КАК Валюта,
		|	ТаблицаОстатков.ЗаявкаНаРасходованиеДенежныхСредств КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	СУММА(ВЫБОР КОГДА ТаблицаОстатков.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА
		|			ТаблицаОстатков.Оплачивается
		|		ИНАЧЕ
		|			-ТаблицаОстатков.Оплачивается
		|		КОНЕЦ) КАК Сумма
		|ИЗ
		|	РегистрНакопления.РасчетыСПоставщиками КАК ТаблицаОстатков
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДвиженияРасчетыСПоставщикамиИзменениеОплачивается КАК Таблица
		|	ПО Таблица.АналитикаУчетаПоПартнерам = ТаблицаОстатков.АналитикаУчетаПоПартнерам
		|		И Таблица.ОбъектРасчетов = ТаблицаОстатков.ОбъектРасчетов
		|		И Таблица.Валюта = ТаблицаОстатков.Валюта
		|		И Таблица.ЗаявкаНаРасходованиеДенежныхСредств = ТаблицаОстатков.ЗаявкаНаРасходованиеДенежныхСредств
		|ГДЕ
		|	ТаблицаОстатков.ЗаявкаНаРасходованиеДенежныхСредств <> ЗНАЧЕНИЕ(Документ.ЗаявкаНаРасходованиеДенежныхСредств.ПустаяСсылка)
		|СГРУППИРОВАТЬ ПО
		|	ТаблицаОстатков.АналитикаУчетаПоПартнерам,
		|	ТаблицаОстатков.ОбъектРасчетов,
		|	ТаблицаОстатков.Валюта,
		|	ТаблицаОстатков.ЗаявкаНаРасходованиеДенежныхСредств
		|ИМЕЮЩИЕ
		|	СУММА(ВЫБОР КОГДА ТаблицаОстатков.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА
		|			ТаблицаОстатков.Оплачивается
		|		ИНАЧЕ
		|			-ТаблицаОстатков.Оплачивается
		|		КОНЕЦ) > 0
		|";
		
		ТекстыЗапроса.Добавить(ТекстЗапроса, "ОшибкиОплачивается");
		
	КонецЕсли;
	
	#КонецОбласти
	
КонецПроцедуры

// Выводит сообщения пользователю при наличии ошибок контроля изменений записанных движений регистров.
//
// Параметры:
//  РезультатыКонтроля - Структура - таблицы с результатами контроля изменений
//  Документ - ДокументОбъект - записываемый документ
//  Отказ - Булево - признак отказа от проведения документа.
//
Процедура СообщитьОРезультатахКонтроляИзменений(РезультатыКонтроля, Документ, Отказ) Экспорт
	
	ДоступноОтклонениеОтУсловийОплаты = ПраваПользователяПовтИсп.ОтклонениеОтУсловийОплаты();
	
	#Область РасчетыСКлиентами
	
	Если ПроведениеДокументов.ЕстьЗаписиВТаблице(Документ, "ДвиженияРасчетыСКлиентамиИзменение") Тогда
		
		ШаблонСообщения = НСтр("ru = 'Нарушены условия оплаты, необходимые для обеспечения/отгрузки по %1,
			|Требуется %2 %4 оплачено %3 %4'");
		
		Для каждого СтрокаОшибки Из РезультатыКонтроля.ОшибкиРасчетыСКлиентами Цикл
			
			ТекстСообщения = СтрШаблон(ШаблонСообщения, СтрокаОшибки.ОбъектРасчетов,
				СтрокаОшибки.СуммаЗаказа, СтрокаОшибки.СуммаОплаты, СтрокаОшибки.Валюта);
			
			Если ДоступноОтклонениеОтУсловийОплаты Тогда
				ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, Документ);
			Иначе
				ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, Документ,,, Отказ);
			КонецЕсли;
		КонецЦикла;
		
	КонецЕсли;
	
	#КонецОбласти
	
	#Область СуммыСрокЗадолженности
	
	Если ПроведениеДокументов.ЕстьЗаписиВТаблице(Документ, "ДвиженияРасчетыСКлиентамиИзменениеСуммыДолга") Тогда
		
		ШаблонСообщения = НСтр("ru = 'По договору %1 превышена допустимая сумма кредита на %2 %3'");
		
		Для каждого СтрокаОшибки Из РезультатыКонтроля.ОшибкиОграничениеСуммыЗадолженности Цикл
			
			ТекстСообщения = СтрШаблон(ШаблонСообщения, СтрокаОшибки.Договор, СтрокаОшибки.СуммаПревышения,
				СтрокаОшибки.Валюта);
			
			Если ДоступноОтклонениеОтУсловийОплаты Тогда
				ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, Документ);
			Иначе
				ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, Документ,,, Отказ);
			КонецЕсли;
		КонецЦикла;
		
	КонецЕсли;
	
	Если ПроведениеДокументов.ЕстьЗаписиВТаблице(Документ, "ДвиженияРасчетыСКлиентамиИзменениеКонтрольСрока") Тогда
		
		ШаблонСообщения = НСтр("ru = 'По договору %1 имеется просроченная задолженность на сумму %2 %3'");
		
		Для каждого СтрокаОшибки Из РезультатыКонтроля.ОшибкиКонтрольСрокаЗадолженности Цикл
			
			ТекстСообщения = СтрШаблон(ШаблонСообщения, СтрокаОшибки.Договор, СтрокаОшибки.ПросроченнаяЗадолженность,
				СтрокаОшибки.Валюта);
			
			Если ДоступноОтклонениеОтУсловийОплаты Тогда
				ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, Документ);
			Иначе
				ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, Документ,,, Отказ);
			КонецЕсли;
		КонецЦикла;
		
	КонецЕсли;
	
	#КонецОбласти
	
	#Область Авансы
	
	Если ПроведениеДокументов.ЕстьЗаписиВТаблице(Документ, "РасчетыСКлиентамиИзменения") Тогда
		
		ШаблонСообщения = НСтр("ru = 'Не хватает остатка аванса на %1, текущий остаток %2 %4, требуется %3 %4'");
		
		Для каждого СтрокаОшибки Из РезультатыКонтроля.ОшибкиКонтрольЗачтенныхАвансовПоНакладнымКлиент Цикл
			
			СуммаОстаток = ?((СтрокаОшибки.СуммаПревышения - СтрокаОшибки.СуммаУменьшенияЗачета) < 0,0,СтрокаОшибки.СуммаПревышения - СтрокаОшибки.СуммаУменьшенияЗачета);
			
			ТекстСообщения = СтрШаблон(ШаблонСообщения,
										СтрокаОшибки.ДокументАванса,
										СуммаОстаток,
										СтрокаОшибки.СуммаПревышения,
										СтрокаОшибки.Валюта);
			
			Если ДоступноОтклонениеОтУсловийОплаты  ИЛИ НЕ СтрокаОшибки.ВызыватьИсключение Тогда
				ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, Документ);
			Иначе
				ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, Документ,,, Отказ);
			КонецЕсли;
		КонецЦикла;
		
	КонецЕсли;
	
	Если ПроведениеДокументов.ЕстьЗаписиВТаблице(Документ, "РасчетыСПоставщикамиИзменения") Тогда
		
		ШаблонСообщения = НСтр("ru = 'Не хватает остатка аванса на %1, текущий остаток %2 %4, требуется %3 %4'");
		
		Для каждого СтрокаОшибки Из РезультатыКонтроля.ОшибкиКонтрольЗачтенныхАвансовПоНакладнымПоставщик Цикл
			
			СуммаОстаток = ?((СтрокаОшибки.СуммаПревышения - СтрокаОшибки.СуммаУменьшенияЗачета) < 0, 0, СтрокаОшибки.СуммаПревышения - СтрокаОшибки.СуммаУменьшенияЗачета);
			
			ТекстСообщения = СтрШаблон(ШаблонСообщения,
										СтрокаОшибки.ДокументАванса,
										СуммаОстаток,
										СтрокаОшибки.СуммаПревышения,
										СтрокаОшибки.Валюта);
			
			Если ДоступноОтклонениеОтУсловийОплаты  ИЛИ НЕ СтрокаОшибки.ВызыватьИсключение Тогда
				ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, Документ);
			Иначе
				ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, Документ,,, Отказ);
			КонецЕсли;
		КонецЦикла;
		
	КонецЕсли;
	
	#КонецОбласти
	
	#Область ВводОстатков
	
	Если ПроведениеДокументов.ЕстьЗаписиВТаблице(Документ, "РасчетыСКлиентамиИзмененияВводОстатков") Тогда
		
		Для каждого СтрокаОшибки Из РезультатыКонтроля.ОшибкиЕстьВводОстатковПослеКлиенты Цикл
			
			ШаблонСообщения = НСтр("ru = 'Существуют документы ввода начальных остатков взаиморасчетов по объекту расчетов ""%1"", введенные позже изменяемого периода.'");
			ТекстСообщения = СтрШаблон(ШаблонСообщения, СтрокаОшибки.ОбъектРасчетов);
			ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, Документ,,, Отказ);
			
		КонецЦикла;
		
		Для каждого СтрокаОшибки Из РезультатыКонтроля.ОшибкиЕстьДвиженияДоКлиенты Цикл
			
			ШаблонСообщения = НСтр("ru = 'Существуют документы введенные раньше ввода начальных остатков взаиморасчетов по объекту расчетов ""%1"".'");
			ТекстСообщения = СтрШаблон(ШаблонСообщения, СтрокаОшибки.ОбъектРасчетов);
			ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, Документ,,, Отказ);
			
		КонецЦикла;
		
	КонецЕсли;
	
	Если ПроведениеДокументов.ЕстьЗаписиВТаблице(Документ, "РасчетыСПоставщикамиИзмененияВводОстатков") Тогда
		
		Для каждого СтрокаОшибки Из РезультатыКонтроля.ОшибкиЕстьВводОстатковПослеПоставщики Цикл
			
			ШаблонСообщения = НСтр("ru = 'Существуют документы ввода начальных остатков взаиморасчетов по объекту расчетов ""%1"", введенные позже изменяемого периода.'");
			ТекстСообщения = СтрШаблон(ШаблонСообщения, СтрокаОшибки.ОбъектРасчетов);
			ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, Документ,,, Отказ);
			
		КонецЦикла;
		
		Для каждого СтрокаОшибки Из РезультатыКонтроля.ОшибкиЕстьДвиженияДоПоставщики Цикл
			
			ШаблонСообщения = НСтр("ru = 'Существуют документы введенные раньше ввода начальных остатков взаиморасчетов по объекту расчетов ""%1"".'");
			ТекстСообщения = СтрШаблон(ШаблонСообщения, СтрокаОшибки.ОбъектРасчетов);
			ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, Документ,,, Отказ);
			
		КонецЦикла;
		
	КонецЕсли;
	
	#КонецОбласти
	
	#Область Оплачивается
	
	Если ПроведениеДокументов.ЕстьЗаписиВТаблице(Документ, "ДвиженияРасчетыСКлиентамиИзменениеОплачивается")
		Или ПроведениеДокументов.ЕстьЗаписиВТаблице(Документ, "ДвиженияРасчетыСПоставщикамиИзменениеОплачивается") Тогда
		
		ШаблонСообщения = НСтр("ru = 'По объекту расчетов %1 оплачивается больше, чем утверждено в заявке, на %2 %3'");
		
		Для каждого СтрокаОшибки Из РезультатыКонтроля.ОшибкиОплачивается Цикл
			ТекстСообщения = СтрШаблон(ШаблонСообщения,
				СтрокаОшибки.ОбъектРасчетов, СтрокаОшибки.Сумма, СтрокаОшибки.Валюта);
			ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, Документ,,, Отказ);
		КонецЦикла;
	КонецЕсли;
	
	#КонецОбласти
	
КонецПроцедуры

// Возникает перед выполнением записи регистров документа.
//
// Параметры:
//  Документ - ДокументОбъект - записываемый документ
//  МенеджерВременныхТаблиц - МенеджерВременныхТаблиц - менеджер временных таблиц,
//								используемый для хранения таблиц контроля изменений регистров.
//  Отказ - Булево - признак отказа от проведения документа.
//
Процедура ПередЗаписьюДвиженийДокумента(Документ, МенеджерВременныхТаблиц, Отказ) Экспорт
	
КонецПроцедуры

// Возникает после выполнения записи регистров документа.
//
// Параметры:
//  Документ - ДокументОбъект - записываемый документ
//  МенеджерВременныхТаблиц - МенеджерВременныхТаблиц - менеджер временных таблиц,
//								используемый для хранения таблиц контроля изменений регистров.
//  Отказ - Булево - признак отказа от проведения документа.
//
Процедура ПослеЗаписиДвиженийДокумента(Документ, МенеджерВременныхТаблиц, Отказ) Экспорт
	
	ЕстьИзмененияРасчетовСКлиентами = МенеджерВременныхТаблиц.Таблицы.Найти("РасчетыСКлиентамиИзменения") <> Неопределено;
	ЕстьИзмененияРасчетовСПоставщиками = МенеджерВременныхТаблиц.Таблицы.Найти("РасчетыСПоставщикамиИзменения") <> Неопределено;
	
	Если Отказ
		ИЛИ НЕ ЕстьИзмененияРасчетовСКлиентами
			И НЕ ЕстьИзмененияРасчетовСПоставщиками Тогда
		Возврат;
	КонецЕсли;
	
	Если ЕстьИзмененияРасчетовСКлиентами Тогда
		РегистрыСведений.ВспомогательнаяИнформацияВзаиморасчетов.ЗаполнитьВспомогательнуюИнформацию(МенеджерВременныхТаблиц, Истина);
	КонецЕсли;
	
	Если ЕстьИзмененияРасчетовСПоставщиками Тогда
		РегистрыСведений.ВспомогательнаяИнформацияВзаиморасчетов.ЗаполнитьВспомогательнуюИнформацию(МенеджерВременныхТаблиц, Ложь);
	КонецЕсли;
	
	ПараметрыИзменений = ОперативныеВзаиморасчетыСервер.ПараметрыРаспределенияРасчетов();
	ПараметрыИзменений.Регистратор             = Документ.Ссылка;
	ПараметрыИзменений.Загрузка                = Документ.ОбменДанными.Загрузка ИЛИ Константы.РаспределятьФактическиеРасчетыФоновымЗаданием.Получить();
	ПараметрыИзменений.ТаблицаИзменений        = ОперативныеВзаиморасчетыСервер.ТаблицаИзмененийДляПересчета(МенеджерВременныхТаблиц, Документ.Ссылка);
	
	ПроверитьПорядокОперацииОбъектовРасчетовИсточников(
		ПараметрыИзменений.ТаблицаИзменений,
		Документ.ДополнительныеСвойства.ПроведениеДокументов,
		Отказ);
	
	ПараметрыИзменений.РасчетПлановФоновымЗаданием = НЕ ПараметрыИзменений.Загрузка 
													 И Константы.РаспределятьПлановыеРасчетыФоновымЗаданием.Получить() 
													 И НЕ ОбщегоНазначения.ИнформационнаяБазаФайловая();
	ПараметрыИзменений.РаспределениеСУчетомПриемников = Истина;
	
	ОперативныеВзаиморасчетыСервер.ЗарегистрироватьИзмененияКОтложенномуРаспределению(ПараметрыИзменений);
	
	Если Документ.ОбменДанными.Загрузка ИЛИ Константы.РаспределятьФактическиеРасчетыФоновымЗаданием.Получить() Тогда
		Возврат;
	КонецЕсли;
	
	Если ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов") Тогда
		ОперативныеВзаиморасчетыСервер.ЗаполнитьОперативныеВзаиморасчетыПоТаблице(ПараметрыИзменений, Документ.ДополнительныеСвойства.ПроведениеДокументов);
		ОперативныеВзаиморасчетыСервер.ЗапуститьОтложенноеРаспределениеВзаиморасчетов();
	КонецЕсли;
	
	Если ВыполнятьПересчетГрафикаПлатежей(ПараметрыИзменений,
	                                      МенеджерВременныхТаблиц,
	                                      ЕстьИзмененияРасчетовСКлиентами,
	                                      ЕстьИзмененияРасчетовСПоставщиками) Тогда
		
		ТаблицаОбъектовОплаты = СформироватьТаблицуОбъектовОплаты(МенеджерВременныхТаблиц);
		ТаблицаОбъектовОплаты.Индексы.Добавить("ЭтоРасчетыСКлиентами");
		
		Если ЕстьИзмененияРасчетовСКлиентами Тогда
			РегистрыСведений.ГрафикПлатежей.РассчитатьГрафикПлатежейПоРасчетамСКлиентами(
				ТаблицаОбъектовОплаты.Скопировать(Новый Структура("ЭтоРасчетыСКлиентами",Истина)));
		КонецЕсли;
		
		Если ЕстьИзмененияРасчетовСПоставщиками Тогда
			РегистрыСведений.ГрафикПлатежей.РассчитатьГрафикПлатежейПоРасчетамСПоставщиками(
				ТаблицаОбъектовОплаты.Скопировать(Новый Структура("ЭтоРасчетыСКлиентами",Ложь)));
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры



// Формирует таблицу объектов расчетов, которые были раньше в движениях и которые сейчас будут записаны.
//
Функция СформироватьТаблицуОбъектовОплаты(МенеджерВременныхТаблиц)
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст = "";
	Если МенеджерВременныхТаблиц.Таблицы.Найти("РасчетыСКлиентамиИзменения") <> Неопределено Тогда
		Запрос.Текст = Запрос.Текст + "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ИСТИНА КАК ЭтоРасчетыСКлиентами,
		|	ЕСТЬNULL(Таблица.ОбъектРасчетов.Объект, Таблица.Документ) КАК ОбъектОплаты,
		|	Таблица.ОбъектРасчетов КАК ОбъектРасчетов
		|ИЗ
		|	РасчетыСКлиентамиИзменения КАК Таблица
		|ГДЕ
		|	Таблица.ОбъектРасчетов <> ЗНАЧЕНИЕ(Справочник.ОбъектыРасчетов.ПустаяСсылка)";
		
	КонецЕсли;
	
	Если МенеджерВременныхТаблиц.Таблицы.Найти("РасчетыСКлиентамиИзменения") <> Неопределено 
		И МенеджерВременныхТаблиц.Таблицы.Найти("РасчетыСПоставщикамиИзменения") <> Неопределено Тогда
		Запрос.Текст = Запрос.Текст + "
		|
		|ОБЪЕДИНИТЬ
		|";
	КонецЕсли;
	
	Если МенеджерВременныхТаблиц.Таблицы.Найти("РасчетыСПоставщикамиИзменения") <> Неопределено Тогда
		Запрос.Текст = Запрос.Текст + "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ЛОЖЬ КАК ЭтоРасчетыСКлиентами,
		|	Таблица.ОбъектРасчетов.Объект КАК ОбъектОплаты,
		|	Таблица.ОбъектРасчетов КАК ОбъектРасчетов
		|ИЗ
		|	РасчетыСПоставщикамиИзменения КАК Таблица
		|ГДЕ
		|	Таблица.ОбъектРасчетов <> ЗНАЧЕНИЕ(Справочник.ОбъектыРасчетов.ПустаяСсылка)
		|	И Таблица.ОбъектРасчетов.Объект <> Неопределено
		|";
	КонецЕсли;
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

// Если Объект расчетов приемник имеет порядок операции раньше источника
// то проведение документа будет прервано и выдано сообщение об ошибке
Процедура ПроверитьПорядокОперацииОбъектовРасчетовИсточников(ТаблицаИзменений, ДополнительныеСвойства, Отказ)
	
	Если ДополнительныеСвойства <> Неопределено
		И ДополнительныеСвойства.Свойство("СвойстваДокумента")
		И ДополнительныеСвойства.СвойстваДокумента.Свойство("РежимЗаписи")
		И ДополнительныеСвойства.СвойстваДокумента.РежимЗаписи = РежимЗаписиДокумента.Проведение Тогда
		ТаблицаДляПроверки = ТаблицаИзменений.Скопировать(,
			"АналитикаУчетаПоПартнерам,
			|ОбъектРасчетов,
			|ВалютаРасчетов,
			|ПоДаннымОбъектаРасчетовИсточника,
			|АналитикаУчетаПоПартнерамПриемник,
			|ОбъектРасчетовПриемник,
			|ВалютаПриемник,
			|ПорядокОперации");
		Для Каждого СтрокаТаблицы Из ТаблицаДляПроверки Цикл
			СтрокаТаблицы.ПорядокОперации = Лев(СтрокаТаблицы.ПорядокОперации, 8);
		КонецЦикла;
		ТаблицаДляПроверки.Индексы.Добавить("АналитикаУчетаПоПартнерамПриемник, ОбъектРасчетовПриемник, ВалютаПриемник");
		Отбор = Новый Структура("АналитикаУчетаПоПартнерамПриемник, ОбъектРасчетовПриемник, ВалютаПриемник");
		Для Каждого СтрокаТаблицы Из ТаблицаДляПроверки Цикл
			Если Не Отказ И СтрокаТаблицы.ПоДаннымОбъектаРасчетовИсточника Тогда
				Отбор.АналитикаУчетаПоПартнерамПриемник = СтрокаТаблицы.АналитикаУчетаПоПартнерам;
				Отбор.ОбъектРасчетовПриемник = СтрокаТаблицы.ОбъектРасчетов;
				Отбор.ВалютаПриемник = СтрокаТаблицы.ВалютаРасчетов;
				СтрокиИсточники = ТаблицаДляПроверки.НайтиСтроки(Отбор);
				Для Каждого СтрокаИсточник Из СтрокиИсточники Цикл
					Если СтрокаИсточник.ПорядокОперации > СтрокаТаблицы.ПорядокОперации Тогда
						ОбщегоНазначения.СообщитьПользователю(
							НСтр("ru = 'Дата движения объекта расчетов приемника не может быть меньше даты движения объекта расчетов источника.'"),,,,
							Отказ);
						Прервать;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область РасчетДатПлатежа_ОфлайнРасчеты
// В менеджер временных таблиц помещает таблицу "ТаблицаОстатковКлиентов",
// содержащую в себе даты платежа. Строится по регистру "Расчеты с клиентами по документам".
//
// Параметры:
//		МенеджерВременныхТаблиц - МенеджерВременныхТаблиц - Текущий менеджер временных таблиц для помещения таблиц.
//		ДатаОстатков - Дата - Дата остатков.
//
Процедура РассчитатьДатыПлатежаКлиента(МенеджерВременныхТаблиц, ДатаОстатков) Экспорт
	Если ПравоДоступа("Чтение",Метаданные.РегистрыНакопления.РасчетыСКлиентамиПоДокументам)
		И ПравоДоступа("Чтение",Метаданные.РегистрыНакопления.РасчетыСКлиентами) 
		И НЕ ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов") Тогда
		
		Запрос = Новый Запрос("
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Расчеты.АналитикаУчетаПоПартнерам               КАК АналитикаУчетаПоПартнерам,
		|	Расчеты.ОбъектРасчетов                          КАК ЗаказКлиента,
		|	Расчеты.Валюта                                  КАК Валюта,
		|	ВЫБОР КОГДА (Расчеты.СуммаОстаток - Расчеты.КОплатеОстаток) > 0
		|		ТОГДА Расчеты.КОплатеОстаток
		|		ИНАЧЕ Расчеты.СуммаОстаток
		|	КОНЕЦ                                           КАК ДолгОстаток,
		|	ВЫБОР КОГДА (Расчеты.СуммаОстаток - Расчеты.КОплатеОстаток) > 0
		|		ТОГДА Расчеты.КОплатеОстаток
		|		ИНАЧЕ Расчеты.СуммаОстаток
		|	КОНЕЦ                                           КАК ДолгОстатокНаКонецПериода,
		|	&ДатаОстатков                                   КАК ДатаПлатежа,
		|	ДОБАВИТЬКДАТЕ(&ДатаОстатков, СЕКУНДА, 1)        КАК Период,
		|	ИСТИНА                                          КАК ПросроченнаяЗадолженность
		|ПОМЕСТИТЬ ТаблицаОстатковКлиентов
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентами.Остатки(&Граница, ) КАК Расчеты
		|ГДЕ
		|	Расчеты.КОплатеОстаток > 0
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	Расчеты.АналитикаУчетаПоПартнерам               КАК АналитикаУчетаПоПартнерам,
		|	Расчеты.ОбъектРасчетов                          КАК ЗаказКлиента,
		|	Расчеты.Валюта                                  КАК Валюта,
		|	ВЫБОР КОГДА Расчеты.КОплатеОстаток < 0
		|			ТОГДА Расчеты.СуммаОстаток
		|			ИНАЧЕ ВЫБОР КОГДА (Расчеты.СуммаОстаток - Расчеты.КОплатеОстаток) > 0
		|					ТОГДА Расчеты.СуммаОстаток - Расчеты.КОплатеОстаток
		|					ИНАЧЕ Расчеты.КОплатеОстаток
		|			КОНЕЦ
		|	КОНЕЦ                                           КАК ДолгОстаток,
		|	ВЫБОР КОГДА Расчеты.КОплатеОстаток < 0
		|			ТОГДА Расчеты.СуммаОстаток
		|			ИНАЧЕ ВЫБОР КОГДА (Расчеты.СуммаОстаток - Расчеты.КОплатеОстаток) > 0
		|					ТОГДА Расчеты.СуммаОстаток - Расчеты.КОплатеОстаток
		|					ИНАЧЕ Расчеты.КОплатеОстаток
		|			КОНЕЦ
		|	КОНЕЦ                                           КАК ДолгОстатокНаКонецПериода,
		|	&ДатаОстатков                                   КАК ДатаПлатежа,
		|	ДОБАВИТЬКДАТЕ(&ДатаОстатков, СЕКУНДА, 1)        КАК Период,
		|	ЛОЖЬ                                            КАК ПросроченнаяЗадолженность
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентами.Остатки(&Граница, ) КАК Расчеты
		|ГДЕ
		|	Расчеты.КОплатеОстаток <= 0
		|;
		|/////////////////////////////////////////////////////////
		|ВЫБРАТЬ 
		|	1
		|ПОМЕСТИТЬ ТаблицаОтгрузокКлиентов
		|;
		|/////////////////////////////////////////////////////////
		|ВЫБРАТЬ 
		|	1
		|ПОМЕСТИТЬ ТаблицаПериодовКлиентов
		|");
		
		Параметры = Новый Массив(2);
		Параметры[0] = ДатаОстатков;
		Параметры[1] = ВидГраницы.Включая;
		Граница = Новый(Тип("Граница"),Параметры);
		
		Запрос.УстановитьПараметр("ДатаОстатков", ДатаОстатков);
		Запрос.УстановитьПараметр("Граница", Граница);
		
		Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
		Запрос.Выполнить();
		
 		Запрос.Текст = "
		|УНИЧТОЖИТЬ ТаблицаПериодовКлиентов
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ТаблицаОтгрузокКлиентов
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Расчеты.АналитикаУчетаПоПартнерам                  КАК АналитикаУчетаПоПартнерам,
		|	Расчеты.ОбъектРасчетов                             КАК ЗаказКлиента,
		|	Расчеты.Валюта                                     КАК Валюта,
		|	МАКСИМУМ(НАЧАЛОПЕРИОДА(Расчеты.ДатаПлатежа, День)) КАК ДатаПлатежа,
		|	МАКСИМУМ(Расчеты.Период)                           КАК Период,
		|	ТаблицаОстатков.ПросроченнаяЗадолженность          КАК ПросроченнаяЗадолженность
		|ПОМЕСТИТЬ ТаблицаПериодовКлиентов
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентами КАК Расчеты
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаОстатковКлиентов КАК ТаблицаОстатков
		|		ПО Расчеты.АналитикаУчетаПоПартнерам = ТаблицаОстатков.АналитикаУчетаПоПартнерам
		|			И Расчеты.ОбъектРасчетов = ТаблицаОстатков.ЗаказКлиента
		|			И Расчеты.Валюта = ТаблицаОстатков.Валюта
		|			И ТаблицаОстатков.ДолгОстаток <> 0
		|ГДЕ
		|	Расчеты.Активность
		|	И Расчеты.Период <= &ДатаОстатков
		|	И Расчеты.Период < ТаблицаОстатков.Период
		|	И (Расчеты.КОплате <> 0 ИЛИ Расчеты.КОтгрузке <> 0)
		|	И ТаблицаОстатков.ПросроченнаяЗадолженность
		|
		|СГРУППИРОВАТЬ ПО
		|	Расчеты.АналитикаУчетаПоПартнерам,
		|	Расчеты.ОбъектРасчетов,
		|	Расчеты.Валюта,
		|	ТаблицаОстатков.ПросроченнаяЗадолженность
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	Расчеты.АналитикаУчетаПоПартнерам                  КАК АналитикаУчетаПоПартнерам,
		|	Расчеты.ОбъектРасчетов                             КАК ЗаказКлиента,
		|	Расчеты.Валюта                                     КАК Валюта,
		|	МИНИМУМ(НАЧАЛОПЕРИОДА(Расчеты.ДатаПлатежа, День))  КАК ДатаПлатежа,
		|	МИНИМУМ(Расчеты.Период)                            КАК Период,
		|	ТаблицаОстатков.ПросроченнаяЗадолженность          КАК ПросроченнаяЗадолженность
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентами КАК Расчеты
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаОстатковКлиентов КАК ТаблицаОстатков
		|		ПО Расчеты.АналитикаУчетаПоПартнерам = ТаблицаОстатков.АналитикаУчетаПоПартнерам
		|			И Расчеты.ОбъектРасчетов = ТаблицаОстатков.ЗаказКлиента
		|			И Расчеты.Валюта = ТаблицаОстатков.Валюта
		|			И ТаблицаОстатков.ДолгОстаток <> 0
		|ГДЕ
		|	(Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИЛИ (Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И Расчеты.КОплате < 0))
		|	И Расчеты.Активность
		|	И Расчеты.Период > &ДатаОстатков
		|	И Расчеты.Период > ТаблицаОстатков.Период
		|	И (Расчеты.КОплате <> 0 ИЛИ Расчеты.КОтгрузке <> 0)
		|	И НЕ ТаблицаОстатков.ПросроченнаяЗадолженность
		|
		|СГРУППИРОВАТЬ ПО
		|	Расчеты.АналитикаУчетаПоПартнерам,
		|	Расчеты.ОбъектРасчетов,
		|	Расчеты.Валюта,
		|	ТаблицаОстатков.ПросроченнаяЗадолженность
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Периоды.АналитикаУчетаПоПартнерам             КАК АналитикаУчетаПоПартнерам,
		|	Периоды.ЗаказКлиента                          КАК ЗаказКлиента,
		|	Периоды.Валюта                                КАК Валюта,
		|	Периоды.Период                                КАК Период,
		|	НАЧАЛОПЕРИОДА(ВЫБОР КОГДА Периоды.ЗаказКлиента.Объект ССЫЛКА Справочник.ДоговорыКонтрагентов
		|		И Расчеты.Регистратор ССЫЛКА Документ.ГрафикИсполненияДоговора
		|		ТОГДА Расчеты.ДатаПлатежа
		|		КОГДА Расчеты.ДатаПлатежа = ДАТАВРЕМЯ(1,1,1)
		|		ТОГДА Расчеты.Период
		|		ИНАЧЕ Периоды.ДатаПлатежа
		|	КОНЕЦ, ДЕНЬ)                                  КАК ДатаПлатежа,
		|	СУММА(ВЫБОР КОГДА ЕСТЬNULL(Расчеты.КОплате, 0) < 0
		|			ТОГДА 0 - Расчеты.КОплате
		|			ИНАЧЕ ЕСТЬNULL(Расчеты.КОплате, 0)
		|	КОНЕЦ)                                        КАК Долг,
		|	Периоды.ПросроченнаяЗадолженность             КАК ПросроченнаяЗадолженность
		|ПОМЕСТИТЬ ТаблицаОтгрузокКлиентов
		|ИЗ
		|	ТаблицаПериодовКлиентов КАК Периоды
		|		
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентами КАК Расчеты
		|	ПО Периоды.АналитикаУчетаПоПартнерам   = Расчеты.АналитикаУчетаПоПартнерам
		|		И Периоды.ЗаказКлиента             = Расчеты.ОбъектРасчетов
		|		И Периоды.Валюта                   = Расчеты.Валюта
		|		И Расчеты.Активность
		|		И Расчеты.Период = Периоды.Период
		|		И (Расчеты.КОплате <> 0 ИЛИ Расчеты.КОтгрузке <> 0)
		|		И (Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ИЛИ (Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И Расчеты.КОплате < 0))
		|СГРУППИРОВАТЬ ПО
		|	Периоды.АналитикаУчетаПоПартнерам,
		|	Периоды.ЗаказКлиента,
		|	Периоды.Валюта,
		|	Периоды.Период,
		|	НАЧАЛОПЕРИОДА(ВЫБОР КОГДА Периоды.ЗаказКлиента.Объект ССЫЛКА Справочник.ДоговорыКонтрагентов
		|		И Расчеты.Регистратор ССЫЛКА Документ.ГрафикИсполненияДоговора
		|		ТОГДА Расчеты.ДатаПлатежа
		|		КОГДА Расчеты.ДатаПлатежа = ДАТАВРЕМЯ(1,1,1)
		|		ТОГДА Расчеты.Период
		|		ИНАЧЕ Периоды.ДатаПлатежа
		|	КОНЕЦ, ДЕНЬ),
		|	Периоды.ПросроченнаяЗадолженность
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Остатки.АналитикаУчетаПоПартнерам                   КАК АналитикаУчетаПоПартнерам,
		|	Остатки.ЗаказКлиента                                КАК ЗаказКлиента,
		|	Остатки.Валюта                                      КАК Валюта,
		|	ВЫБОР КОГДА Остатки.ДолгОстаток > ЕСТЬNULL(Отгрузки.Долг, 0)
		|			ТОГДА Остатки.ДолгОстаток - ЕСТЬNULL(Отгрузки.Долг, 0)
		|		ИНАЧЕ 0
		|	КОНЕЦ                                               КАК НовыйДолгОстаток,
		|	ВЫБОР КОГДА ЕСТЬNULL(Отгрузки.Долг, 0) = 0
		|		ТОГДА Остатки.ДолгОстатокНаКонецПериода
		|		ИНАЧЕ ВЫБОР КОГДА Остатки.ДолгОстаток > Отгрузки.Долг
		|			ТОГДА Отгрузки.Долг
		|			ИНАЧЕ Остатки.ДолгОстаток
		|		КОНЕЦ
		|	КОНЕЦ                                               КАК ДолгОстатокНаКонецПериода,
		|	Отгрузки.Период                                     КАК Период,
		|	ЕСТЬNULL(Отгрузки.ДатаПлатежа, Остатки.ДатаПлатежа) КАК ДатаПлатежа,
		|	Остатки.ПросроченнаяЗадолженность                   КАК ПросроченнаяЗадолженность
		|ПОМЕСТИТЬ НовыеОстаткиКлиентов
		|ИЗ
		|	ТаблицаОстатковКлиентов КАК Остатки
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаОтгрузокКлиентов КАК Отгрузки
		|	ПО Остатки.АналитикаУчетаПоПартнерам = Отгрузки.АналитикаУчетаПоПартнерам
		|		И Остатки.ЗаказКлиента = Отгрузки.ЗаказКлиента
		|		И Остатки.Валюта  = Отгрузки.Валюта
		|		И Остатки.ПросроченнаяЗадолженность = Отгрузки.ПросроченнаяЗадолженность
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ТаблицаОстатковКлиентов
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Остатки.АналитикаУчетаПоПартнерам    КАК АналитикаУчетаПоПартнерам,
		|	Остатки.ЗаказКлиента                 КАК ЗаказКлиента,
		|	Остатки.Валюта                       КАК Валюта,
		|	Остатки.Период                       КАК Период,
		|	Остатки.ДатаПлатежа                  КАК ДатаПлатежа,
		|	Остатки.НовыйДолгОстаток             КАК ДолгОстаток,
		|	Остатки.ДолгОстатокНаКонецПериода    КАК ДолгОстатокНаКонецПериода,
		|	Остатки.ПросроченнаяЗадолженность    КАК ПросроченнаяЗадолженность
		|ПОМЕСТИТЬ ТаблицаОстатковКлиентов
		|ИЗ
		|	НовыеОстаткиКлиентов КАК Остатки
		|ИНДЕКСИРОВАТЬ ПО
		|	АналитикаУчетаПоПартнерам,
		|	ЗаказКлиента,
		|	Валюта
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ НовыеОстаткиКлиентов
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ ПЕРВЫЕ 1
		|	1
		|ИЗ ТаблицаПериодовКлиентов
		|";
		
		Результат = Запрос.Выполнить();
		Счетчик = 0;
		МаксимальноеКоличествоИтераций = 1000;
		Пока Не Результат.Пустой() Цикл 
			Результат = Запрос.Выполнить();
			Счетчик = Счетчик + 1;
			Если Счетчик >= МаксимальноеКоличествоИтераций Тогда
				Прервать;
			КонецЕсли;
		КонецЦикла;
		Запрос.Текст = "
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Расчеты.АналитикаУчетаПоПартнерам         КАК АналитикаУчетаПоПартнерам,
		|	Расчеты.ЗаказКлиента                      КАК ЗаказКлиента,
		|	Расчеты.РасчетныйДокумент                 КАК РасчетныйДокумент,
		|	Расчеты.Валюта                            КАК Валюта,
		|	ТаблицаОстатков.ДатаПлатежа               КАК ДатаПлатежа,
		|	ТаблицаОстатков.ДолгОстатокНаКонецПериода КАК Долг
		|ПОМЕСТИТЬ ТаблицаОстатковКлиентовПоДокументам
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентамиПоДокументам.Остатки(&Граница, ) КАК Расчеты
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаОстатковКлиентов КАК ТаблицаОстатков
		|	ПО Расчеты.АналитикаУчетаПоПартнерам = ТаблицаОстатков.АналитикаУчетаПоПартнерам
		|		И Расчеты.ЗаказКлиента = ТаблицаОстатков.ЗаказКлиента
		|		И Расчеты.Валюта = ТаблицаОстатков.Валюта
		|ГДЕ
		|	Расчеты.ДолгОстаток > 0
		|;
		|//////////////////////////////////////////////
		|УНИЧТОЖИТЬ ТаблицаОстатковКлиентов
		|;
		|//////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Расчеты.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
		|	Расчеты.ЗаказКлиента              КАК ЗаказКлиента,
		|	Расчеты.РасчетныйДокумент         КАК РасчетныйДокумент,
		|	Расчеты.Валюта                    КАК Валюта,
		|	Расчеты.ДатаПлатежа               КАК ДатаПлатежа,
		|	Расчеты.Долг                      КАК КОплате,
		|	Расчеты.Долг                      КАК ДолгОстаток
		|ПОМЕСТИТЬ ТаблицаОстатковКлиентов
		|ИЗ
		|	ТаблицаОстатковКлиентовПоДокументам КАК Расчеты
		|";
		Запрос.Выполнить();
	Иначе
		Запрос = Новый Запрос("
		 |ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка) КАК АналитикаУчетаПоПартнерам,
		|	Неопределено                                                     КАК ЗаказКлиента,
		|	Неопределено                                                     КАК РасчетныйДокумент,
		|	ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка)                         КАК Валюта,
		|	ДАТАВРЕМЯ(1,1,1)                                                 КАК ДатаПлатежа,
		|	0                                                                КАК КОплате,
		|	0                                                                КАК ДолгОстаток
		|ПОМЕСТИТЬ ТаблицаОстатковКлиентов");
		Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
		Запрос.Выполнить();
	КонецЕсли;
КонецПроцедуры

// В менеджер временных таблиц помещает таблицу "ТаблицаОстатковПоставщиков",
// содержащую в себе даты платежа. Строится по регистру "Расчеты с поставщиками по документам".
//
// Параметры:
//		МенеджерВременныхТаблиц - МенеджерВременныхТаблиц - Текущий менеджер временных таблиц для помещения таблиц.
//		ДатаОстатков - Дата - Дата остатков.
//
Процедура РассчитатьДатыПлатежаПоставщика(МенеджерВременныхТаблиц, ДатаОстатков) Экспорт
	Если ПравоДоступа("Чтение",Метаданные.РегистрыНакопления.РасчетыСПоставщикамиПоДокументам)
		И ПравоДоступа("Чтение",Метаданные.РегистрыНакопления.РасчетыСПоставщиками)
		И НЕ ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов") Тогда
		
		Запрос = Новый Запрос("
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ 
		|	Расчеты.АналитикаУчетаПоПартнерам        КАК АналитикаУчетаПоПартнерам,
		|	Расчеты.ОбъектРасчетов                   КАК ЗаказПоставщику,
		|	Расчеты.Валюта                           КАК Валюта,
		|	-Расчеты.КОплатеОстаток                  КАК КОплатеОстаток,
		|	-Расчеты.КОплатеОстаток                  КАК КОплатеОстатокНаКонецПериода,
		|	&ДатаОстатков                            КАК ДатаПлатежа,
		|	ДОБАВИТЬКДАТЕ(&ДатаОстатков, СЕКУНДА, 1) КАК Период,
		|	ИСТИНА                                   КАК ПросроченнаяЗадолженность
		|ПОМЕСТИТЬ ТаблицаОстатковПоставщиков
		|ИЗ
		|	РегистрНакопления.РасчетыСПоставщиками.Остатки(&Граница, ) КАК Расчеты
		|ГДЕ
		|	Расчеты.КОплатеОстаток < 0
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	Расчеты.АналитикаУчетаПоПартнерам               КАК АналитикаУчетаПоПартнерам,
		|	Расчеты.ОбъектРасчетов                          КАК ЗаказПоставщику,
		|	Расчеты.Валюта                                  КАК Валюта,
		|	(Расчеты.СуммаОстаток - Расчеты.КОплатеОстаток) КАК КОплатеОстаток,
		|	(Расчеты.СуммаОстаток - Расчеты.КОплатеОстаток) КАК КОплатеОстатокНаКонецПериода,
		|	&ДатаОстатков                                   КАК ДатаПлатежа,
		|	ДОБАВИТЬКДАТЕ(&ДатаОстатков, СЕКУНДА, 1)        КАК Период,
		|	ЛОЖЬ                                            КАК ПросроченнаяЗадолженность
		|ИЗ
		|	РегистрНакопления.РасчетыСПоставщиками.Остатки(&Граница, ) КАК Расчеты
		|ГДЕ
		|	Расчеты.КОплатеОстаток >= 0 И Расчеты.СуммаОстаток <> 0
		|	И Расчеты.СуммаОстаток - Расчеты.КОплатеОстаток > 0
		|;
		|/////////////////////////////////////////////////////////
		|ВЫБРАТЬ 
		|	1
		|ПОМЕСТИТЬ ТаблицаПоступленийПоставщиков
		|;
		|/////////////////////////////////////////////////////////
		|ВЫБРАТЬ 
		|	1
		|ПОМЕСТИТЬ ТаблицаПериодовПоставщиков
		|");
		
		Параметры = Новый Массив(2);
		Параметры[0] = ДатаОстатков;
		Параметры[1] = ВидГраницы.Включая;
		Граница = Новый(Тип("Граница"),Параметры);
		
		Запрос.УстановитьПараметр("ДатаОстатков", ДатаОстатков);
		Запрос.УстановитьПараметр("Граница", Граница);
		Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
		Запрос.Выполнить();
		
		Запрос.Текст = "
		|УНИЧТОЖИТЬ ТаблицаПериодовПоставщиков
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ТаблицаПоступленийПоставщиков
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Расчеты.АналитикаУчетаПоПартнерам                  КАК АналитикаУчетаПоПартнерам,
		|	Расчеты.ОбъектРасчетов                             КАК ЗаказПоставщику,
		|	Расчеты.Валюта                                     КАК Валюта,
		|	МАКСИМУМ(НАЧАЛОПЕРИОДА(Расчеты.ДатаПлатежа, День)) КАК ДатаПлатежа,
		|	МАКСИМУМ(Расчеты.Период)                           КАК Период,
		|	ТаблицаОстатков.ПросроченнаяЗадолженность          КАК ПросроченнаяЗадолженность
		|ПОМЕСТИТЬ ТаблицаПериодовПоставщиков
		|ИЗ
		|	РегистрНакопления.РасчетыСПоставщиками КАК Расчеты
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаОстатковПоставщиков КАК ТаблицаОстатков
		|		ПО Расчеты.АналитикаУчетаПоПартнерам = ТаблицаОстатков.АналитикаУчетаПоПартнерам
		|			И Расчеты.ОбъектРасчетов = ТаблицаОстатков.ЗаказПоставщику
		|			И Расчеты.Валюта = ТаблицаОстатков.Валюта
		|			И ТаблицаОстатков.КОплатеОстаток <> 0
		|ГДЕ
		|	Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И Расчеты.Активность
		|	И Расчеты.Период <= &ДатаОстатков
		|	И Расчеты.Период < ТаблицаОстатков.Период
		|	И (Расчеты.КОплате <> 0 ИЛИ Расчеты.КПоступлению <> 0)
		|	И ТаблицаОстатков.ПросроченнаяЗадолженность
		|
		|СГРУППИРОВАТЬ ПО
		|	Расчеты.АналитикаУчетаПоПартнерам,
		|	Расчеты.ОбъектРасчетов,
		|	Расчеты.Валюта,
		|	ТаблицаОстатков.ПросроченнаяЗадолженность
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	Расчеты.АналитикаУчетаПоПартнерам                  КАК АналитикаУчетаПоПартнерам,
		|	Расчеты.ОбъектРасчетов                             КАК ЗаказПоставщику,
		|	Расчеты.Валюта                                     КАК Валюта,
		|	МИНИМУМ(НАЧАЛОПЕРИОДА(Расчеты.ДатаПлатежа, День))  КАК ДатаПлатежа,
		|	МАКСИМУМ(Расчеты.Период)                           КАК Период,
		|	ТаблицаОстатков.ПросроченнаяЗадолженность          КАК ПросроченнаяЗадолженность
		|ИЗ
		|	РегистрНакопления.РасчетыСПоставщиками КАК Расчеты
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаОстатковПоставщиков КАК ТаблицаОстатков
		|		ПО Расчеты.АналитикаУчетаПоПартнерам = ТаблицаОстатков.АналитикаУчетаПоПартнерам
		|			И Расчеты.ОбъектРасчетов = ТаблицаОстатков.ЗаказПоставщику
		|			И Расчеты.Валюта = ТаблицаОстатков.Валюта
		|			И ТаблицаОстатков.КОплатеОстаток <> 0
		|ГДЕ
		|	Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И Расчеты.Активность
		|	И Расчеты.Период > &ДатаОстатков
		|	И Расчеты.Период > ТаблицаОстатков.Период
		|	И (Расчеты.КОплате <> 0 ИЛИ Расчеты.КПоступлению <> 0)
		|	И НЕ ТаблицаОстатков.ПросроченнаяЗадолженность
		|
		|СГРУППИРОВАТЬ ПО
		|	Расчеты.АналитикаУчетаПоПартнерам,
		|	Расчеты.ОбъектРасчетов,
		|	Расчеты.Валюта,
		|	ТаблицаОстатков.ПросроченнаяЗадолженность
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Периоды.АналитикаУчетаПоПартнерам             КАК АналитикаУчетаПоПартнерам,
		|	Периоды.ЗаказПоставщику                       КАК ЗаказПоставщику,
		|	Периоды.Валюта                                КАК Валюта,
		|	Периоды.Период                                КАК Период,
		|	ВЫБОР КОГДА Периоды.ЗаказПоставщику.Объект ССЫЛКА Справочник.ДоговорыКонтрагентов
		|		И Расчеты.Регистратор ССЫЛКА Документ.ГрафикИсполненияДоговора
		|		ТОГДА Расчеты.ДатаПлатежа
		|		КОГДА Расчеты.ДатаПлатежа = ДАТАВРЕМЯ(1,1,1)
		|		ТОГДА Расчеты.Период
		|		ИНАЧЕ Периоды.ДатаПлатежа
		|	КОНЕЦ                                         КАК ДатаПлатежа,
		|	СУММА(ВЫБОР КОГДА ЕСТЬNULL(Расчеты.КОплате, 0) < 0
		|			ТОГДА 0 - Расчеты.КОплате
		|			ИНАЧЕ ЕСТЬNULL(Расчеты.КОплате, 0)
		|	КОНЕЦ)                                        КАК КОплате,
		|	Периоды.ПросроченнаяЗадолженность             КАК ПросроченнаяЗадолженность
		|ПОМЕСТИТЬ ТаблицаПоступленийПоставщиков
		|ИЗ
		|	ТаблицаПериодовПоставщиков КАК Периоды
		|		
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСПоставщиками КАК Расчеты
		|	ПО Периоды.АналитикаУчетаПоПартнерам   = Расчеты.АналитикаУчетаПоПартнерам
		|		И Периоды.ЗаказПоставщику          = Расчеты.ОбъектРасчетов
		|		И Периоды.Валюта                   = Расчеты.Валюта
		|		И Расчеты.Активность
		|		И Расчеты.Период = Периоды.Период
		|		И (Расчеты.КОплате <> 0 ИЛИ Расчеты.КПоступлению <> 0)
		|		И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|СГРУППИРОВАТЬ ПО
		|	Периоды.АналитикаУчетаПоПартнерам,
		|	Периоды.ЗаказПоставщику,
		|	Периоды.Валюта,
		|	Периоды.Период,
		|	ВЫБОР КОГДА Периоды.ЗаказПоставщику.Объект ССЫЛКА Справочник.ДоговорыКонтрагентов
		|		И Расчеты.Регистратор ССЫЛКА Документ.ГрафикИсполненияДоговора
		|		ТОГДА Расчеты.ДатаПлатежа
		|		КОГДА Расчеты.ДатаПлатежа = ДАТАВРЕМЯ(1,1,1)
		|		ТОГДА Расчеты.Период
		|		ИНАЧЕ Периоды.ДатаПлатежа
		|	КОНЕЦ,
		|	Периоды.ПросроченнаяЗадолженность
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Остатки.АналитикаУчетаПоПартнерам                      КАК АналитикаУчетаПоПартнерам,
		|	Остатки.ЗаказПоставщику                                КАК ЗаказПоставщику,
		|	Остатки.Валюта                                         КАК Валюта,
		|	ВЫБОР КОГДА Остатки.КОплатеОстаток > ЕСТЬNULL(Поступления.КОплате, 0)
		|			ТОГДА Остатки.КОплатеОстаток - ЕСТЬNULL(Поступления.КОплате, 0)
		|		ИНАЧЕ 0
		|	КОНЕЦ                                                  КАК НовыйКОплатеОстаток,
		|	ВЫБОР КОГДА ЕСТЬNULL(Поступления.КОплате, 0) = 0
		|		ТОГДА Остатки.КОплатеОстатокНаКонецПериода
		|		ИНАЧЕ ВЫБОР КОГДА Остатки.КОплатеОстатокНаКонецПериода > Поступления.КОплате
		|			ТОГДА Поступления.КОплате
		|			ИНАЧЕ Остатки.КОплатеОстатокНаКонецПериода
		|		КОНЕЦ
		|	КОНЕЦ                                                  КАК КОплатеОстатокНаКонецПериода,
		|	Поступления.Период                                     КАК Период,
		|	ЕСТЬNULL(Поступления.ДатаПлатежа, Остатки.ДатаПлатежа) КАК ДатаПлатежа,
		|	Остатки.ПросроченнаяЗадолженность                      КАК ПросроченнаяЗадолженность
		|ПОМЕСТИТЬ НовыеОстаткиПоставщиков
		|ИЗ
		|	ТаблицаОстатковПоставщиков КАК Остатки
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаПоступленийПоставщиков КАК Поступления
		|	ПО Остатки.АналитикаУчетаПоПартнерам = Поступления.АналитикаУчетаПоПартнерам
		|		И Остатки.ЗаказПоставщику = Поступления.ЗаказПоставщику
		|		И Остатки.Валюта  = Поступления.Валюта
		|		И Остатки.ПросроченнаяЗадолженность = Поступления.ПросроченнаяЗадолженность
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ТаблицаОстатковПоставщиков
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Остатки.АналитикаУчетаПоПартнерам    КАК АналитикаУчетаПоПартнерам,
		|	Остатки.ЗаказПоставщику              КАК ЗаказПоставщику,
		|	Остатки.Валюта                       КАК Валюта,
		|	Остатки.Период                       КАК Период,
		|	Остатки.ДатаПлатежа                  КАК ДатаПлатежа,
		|	Остатки.НовыйКОплатеОстаток          КАК КОплатеОстаток,
		|	Остатки.КОплатеОстатокНаКонецПериода КАК КОплатеОстатокНаКонецПериода,
		|	Остатки.ПросроченнаяЗадолженность    КАК ПросроченнаяЗадолженность
		|ПОМЕСТИТЬ ТаблицаОстатковПоставщиков
		|ИЗ
		|	НовыеОстаткиПоставщиков КАК Остатки
		|ИНДЕКСИРОВАТЬ ПО
		|	АналитикаУчетаПоПартнерам,
		|	ЗаказПоставщику,
		|	Валюта
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ НовыеОстаткиПоставщиков
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ ПЕРВЫЕ 1
		|	1
		|ИЗ ТаблицаПериодовПоставщиков
		|";
		
		Результат = Запрос.Выполнить();
		Счетчик = 0;
		МаксимальноеКоличествоИтераций = 1000;
		Пока Не Результат.Пустой() Цикл 
			Результат = Запрос.Выполнить();
			Счетчик = Счетчик + 1;
			Если Счетчик >= МаксимальноеКоличествоИтераций Тогда
				Прервать;
			КонецЕсли;
		КонецЦикла;
		Запрос.Текст = "
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Расчеты.АналитикаУчетаПоПартнерам            КАК АналитикаУчетаПоПартнерам,
		|	Расчеты.ЗаказПоставщику                      КАК ЗаказПоставщику,
		|	Расчеты.РасчетныйДокумент                    КАК РасчетныйДокумент,
		|	Расчеты.Валюта                               КАК Валюта,
		|	ТаблицаОстатков.ДатаПлатежа                  КАК ДатаПлатежа,
		|	ТаблицаОстатков.КОплатеОстатокНаКонецПериода КАК КОплате
		|ПОМЕСТИТЬ ТаблицаОстатковПоставщиковПоДокументам
		|ИЗ
		|	РегистрНакопления.РасчетыСПоставщикамиПоДокументам.Остатки(&Граница, ) КАК Расчеты
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаОстатковПоставщиков КАК ТаблицаОстатков
		|	ПО Расчеты.АналитикаУчетаПоПартнерам = ТаблицаОстатков.АналитикаУчетаПоПартнерам
		|		И Расчеты.ЗаказПоставщику = ТаблицаОстатков.ЗаказПоставщику
		|		И Расчеты.Валюта = ТаблицаОстатков.Валюта
		|ГДЕ
		|	Расчеты.ДолгОстаток < 0
		|;
		|//////////////////////////////////////////////
		|УНИЧТОЖИТЬ ТаблицаОстатковПоставщиков
		|;
		|//////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Расчеты.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
		|	Расчеты.ЗаказПоставщику           КАК ЗаказПоставщику,
		|	Расчеты.РасчетныйДокумент         КАК РасчетныйДокумент,
		|	Расчеты.Валюта                    КАК Валюта,
		|	Расчеты.ДатаПлатежа               КАК ДатаПлатежа,
		|	Расчеты.КОплате                   КАК КОплате,
		|	Расчеты.КОплате                   КАК ДолгОстаток
		|ПОМЕСТИТЬ ТаблицаОстатковПоставщиков
		|ИЗ
		|	ТаблицаОстатковПоставщиковПоДокументам КАК Расчеты
		|";
		Запрос.Выполнить();
	Иначе
		Запрос = Новый Запрос("
		 |ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка) КАК АналитикаУчетаПоПартнерам,
		|	Неопределено                                                     КАК ЗаказПоставщику,
		|	Неопределено                                                     КАК РасчетныйДокумент,
		|	ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка)                         КАК Валюта,
		|	ДАТАВРЕМЯ(1,1,1)                                                 КАК ДатаПлатежа,
		|	0                                                                КАК КОплате,
		|	0                                                                КАК ДолгОстаток
		|ПОМЕСТИТЬ ТаблицаОстатковПоставщиков");
		Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
		Запрос.Выполнить();
	КонецЕсли;
КонецПроцедуры

// В менеджер временных таблиц помещает таблицу содержащую в себе даты платежа.
// Строится по регистру "Расчеты с клиентами".
// Параметры:
//	ВременныеТаблицы - МенеджерВременныхТаблиц - Менеджер временных таблиц, в который будет помещен результат расчета.
//	ДатаОстатков - Дата - Период на который выполняется расчет дат платежа.
Процедура РассчитатьОперативныеДатыПлатежаКлиента(ВременныеТаблицы, ДатаОстатков) Экспорт
	Если ПравоДоступа("Чтение",Метаданные.РегистрыНакопления.РасчетыСКлиентами) Тогда
		Запрос = Новый Запрос("
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Расчеты.АналитикаУчетаПоПартнерам        КАК АналитикаУчетаПоПартнерам,
		|	Расчеты.ОбъектРасчетов                   КАК ЗаказКлиента,
		|	Расчеты.Валюта                           КАК Валюта,
		|	Расчеты.КОплатеОстаток                   КАК КОплатеОстаток,
		|	Расчеты.КОплатеОстаток                   КАК КОплатеОстатокНаКонецПериода,
		|	&ДатаОстатков                            КАК ДатаПлатежа,
		|	ДОБАВИТЬКДАТЕ(&ДатаОстатков, СЕКУНДА, 1) КАК Период
		|ПОМЕСТИТЬ ТаблицаОстатковКлиентовКОплате
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентами.Остатки(&ДатаОстатков, ) КАК Расчеты
		|;
		|/////////////////////////////////////////////////////////
		|ВЫБРАТЬ 
		|	1
		|ПОМЕСТИТЬ ТаблицаПериодовКлиентовКОплате
		|");
		Запрос.УстановитьПараметр("ДатаОстатков", ДатаОстатков);
		Запрос.МенеджерВременныхТаблиц = ВременныеТаблицы;
		Запрос.Выполнить();
		
		Запрос.Текст = "
		|УНИЧТОЖИТЬ ТаблицаПериодовКлиентовКОплате
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Расчеты.АналитикаУчетаПоПартнерам             КАК АналитикаУчетаПоПартнерам,
		|	Расчеты.ОбъектРасчетов                        КАК ЗаказКлиента,
		|	Расчеты.Валюта                                КАК Валюта,
		|	МАКСИМУМ(Расчеты.ДатаПлатежа)                 КАК ДатаПлатежа,
		|	МАКСИМУМ(НАЧАЛОПЕРИОДА(Расчеты.Период, День)) КАК Период
		|ПОМЕСТИТЬ ТаблицаПериодовКлиентовКОплате
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентами КАК Расчеты
		|		
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаОстатковКлиентовКОплате КАК ТаблицаОстатков
		|	ПО Расчеты.АналитикаУчетаПоПартнерам = ТаблицаОстатков.АналитикаУчетаПоПартнерам
		|		И Расчеты.ОбъектРасчетов = ТаблицаОстатков.ЗаказКлиента
		|		И Расчеты.Валюта = ТаблицаОстатков.Валюта
		|		И ТаблицаОстатков.КОплатеОстаток <> 0
		|ГДЕ
		|	Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И Расчеты.Активность
		|	И Расчеты.Период <= &ДатаОстатков
		|	И Расчеты.Период < ТаблицаОстатков.Период
		|	И Расчеты.КОплате <> 0
		|СГРУППИРОВАТЬ ПО
		|	Расчеты.АналитикаУчетаПоПартнерам,
		|	Расчеты.ОбъектРасчетов,
		|	Расчеты.Валюта
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Периоды.АналитикаУчетаПоПартнерам             КАК АналитикаУчетаПоПартнерам,
		|	Периоды.ЗаказКлиента                          КАК ЗаказКлиента,
		|	Периоды.Валюта                                КАК Валюта,
		|	Периоды.Период                                КАК Период,
		|	Периоды.ДатаПлатежа                           КАК ДатаПлатежа,
		|	СУММА(ЕСТЬNULL(Расчеты.КОплате, 0))      КАК КОплате
		|ПОМЕСТИТЬ ТаблицаОтгрузокКлиентовКОплате
		|ИЗ
		|	ТаблицаПериодовКлиентовКОплате КАК Периоды
		|		
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентами КАК Расчеты
		|	ПО Периоды.АналитикаУчетаПоПартнерам   = Расчеты.АналитикаУчетаПоПартнерам
		|		И Периоды.ЗаказКлиента             = Расчеты.ОбъектРасчетов
		|		И Периоды.Валюта                   = Расчеты.Валюта
		|		И Периоды.ДатаПлатежа              = Расчеты.ДатаПлатежа
		|		И Расчеты.Активность
		|		И (Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход))
		|		И (Расчеты.Период МЕЖДУ Периоды.Период И КОНЕЦПЕРИОДА(Периоды.Период, ДЕНЬ))
		|СГРУППИРОВАТЬ ПО
		|	Периоды.АналитикаУчетаПоПартнерам,
		|	Периоды.ЗаказКлиента,
		|	Периоды.Валюта,
		|	Периоды.Период,
		|	Периоды.ДатаПлатежа
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Остатки.АналитикаУчетаПоПартнерам         КАК АналитикаУчетаПоПартнерам,
		|	Остатки.ЗаказКлиента                      КАК ЗаказКлиента,
		|	Остатки.Валюта                            КАК Валюта,
		|	ВЫБОР КОГДА Остатки.КОплатеОстаток > ЕСТЬNULL(Отгрузки.КОплате, 0)
		|			ТОГДА Остатки.КОплатеОстаток - ЕСТЬNULL(Отгрузки.КОплате, 0)
		|		ИНАЧЕ 0
		|	КОНЕЦ                                     КАК НовыйКОплатеОстаток,
		|	Остатки.КОплатеОстатокНаКонецПериода КАК КОплатеОстатокНаКонецПериода,
		|	Отгрузки.Период                           КАК Период,
		|	ЕСТЬNULL(Отгрузки.ДатаПлатежа, Остатки.ДатаПлатежа) КАК ДатаПлатежа
		|ПОМЕСТИТЬ НовыеОстаткиКлиентовКОплате
		|ИЗ
		|	ТаблицаОстатковКлиентовКОплате КАК Остатки
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаОтгрузокКлиентовКОплате КАК Отгрузки
		|	ПО Остатки.АналитикаУчетаПоПартнерам = Отгрузки.АналитикаУчетаПоПартнерам
		|		И Остатки.ЗаказКлиента = Отгрузки.ЗаказКлиента
		|		И Остатки.Валюта  = Отгрузки.Валюта
		|		И Остатки.КОплатеОстаток <> 0
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ТаблицаОстатковКлиентовКОплате
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ТаблицаОтгрузокКлиентовКОплате
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Остатки.АналитикаУчетаПоПартнерам         КАК АналитикаУчетаПоПартнерам,
		|	Остатки.ЗаказКлиента                      КАК ЗаказКлиента,
		|	Остатки.ЗаказКлиента.Объект               КАК Объект,
		|	Остатки.Валюта                            КАК Валюта,
		|	Остатки.Период                            КАК Период,
		|	Остатки.ДатаПлатежа                       КАК ДатаПлатежа,
		|	Остатки.НовыйКОплатеОстаток          КАК КОплатеОстаток,
		|	Остатки.НовыйКОплатеОстаток          КАК КОплате,
		|	Остатки.КОплатеОстатокНаКонецПериода КАК КОплатеОстатокНаКонецПериода
		|ПОМЕСТИТЬ ТаблицаОстатковКлиентовКОплате
		|ИЗ
		|	НовыеОстаткиКлиентовКОплате КАК Остатки
		|ИНДЕКСИРОВАТЬ ПО
		|	АналитикаУчетаПоПартнерам,
		|	ЗаказКлиента,
		|	Валюта
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ НовыеОстаткиКлиентовКОплате
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ ПЕРВЫЕ 1
		|	1
		|ИЗ ТаблицаПериодовКлиентовКОплате
		|";
		
		Результат = Запрос.Выполнить();
		Пока Не Результат.Пустой() Цикл 
			Результат = Запрос.Выполнить();
		КонецЦикла;
	КонецЕсли;
КонецПроцедуры

// В менеджер временных таблиц помещает таблицу содержащую в себе даты платежа.
// Строится по регистру "Расчеты с поставщиками".
// Параметры:
//	ВременныеТаблицы - МенеджерВременныхТаблиц - Менеджер временных таблиц, в который будет помещен результат расчета.
//	ДатаОстатков - Дата - Период на который выполняется расчет дат платежа.
Процедура РассчитатьОперативныеДатыПлатежаПоставщика(ВременныеТаблицы, ДатаОстатков) Экспорт
	Если ПравоДоступа("Чтение",Метаданные.РегистрыНакопления.РасчетыСПоставщиками) Тогда
		Запрос = Новый Запрос("
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Расчеты.АналитикаУчетаПоПартнерам        КАК АналитикаУчетаПоПартнерам,
		|	Расчеты.ОбъектРасчетов                   КАК ЗаказПоставщику,
		|	Расчеты.Валюта                           КАК Валюта,
		|	Расчеты.КОплатеОстаток                   КАК КОплатеОстаток,
		|	Расчеты.КОплатеОстаток                   КАК КОплатеОстатокНаКонецПериода,
		|	&ДатаОстатков                            КАК ДатаПлатежа,
		|	ДОБАВИТЬКДАТЕ(&ДатаОстатков, СЕКУНДА, 1) КАК Период
		|ПОМЕСТИТЬ ТаблицаОстатковПоставщиковКОплате
		|ИЗ
		|	РегистрНакопления.РасчетыСПоставщиками.Остатки(&ДатаОстатков, ) КАК Расчеты
		|;
		|/////////////////////////////////////////////////////////
		|ВЫБРАТЬ 
		|	1
		|ПОМЕСТИТЬ ТаблицаПериодовПоставщиковКОплате
		|");
		Запрос.УстановитьПараметр("ДатаОстатков", ДатаОстатков);
		Запрос.МенеджерВременныхТаблиц = ВременныеТаблицы;
		Запрос.Выполнить();
		
		Запрос.Текст = "
		|УНИЧТОЖИТЬ ТаблицаПериодовПоставщиковКОплате
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Расчеты.АналитикаУчетаПоПартнерам             КАК АналитикаУчетаПоПартнерам,
		|	Расчеты.ОбъектРасчетов                        КАК ЗаказПоставщику,
		|	Расчеты.Валюта                                КАК Валюта,
		|	МАКСИМУМ(Расчеты.ДатаПлатежа)                 КАК ДатаПлатежа,
		|	МАКСИМУМ(НАЧАЛОПЕРИОДА(Расчеты.Период, День)) КАК Период
		|ПОМЕСТИТЬ ТаблицаПериодовПоставщиковКОплате
		|ИЗ
		|	РегистрНакопления.РасчетыСПоставщиками КАК Расчеты
		|		
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаОстатковПоставщиковКОплате КАК ТаблицаОстатков
		|	ПО Расчеты.АналитикаУчетаПоПартнерам = ТаблицаОстатков.АналитикаУчетаПоПартнерам
		|		И Расчеты.ОбъектРасчетов = ТаблицаОстатков.ЗаказПоставщику
		|		И Расчеты.Валюта = ТаблицаОстатков.Валюта
		|		И ТаблицаОстатков.КОплатеОстаток <> 0
		|ГДЕ
		|	Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И Расчеты.Активность
		|	И Расчеты.Период <= &ДатаОстатков
		|	И Расчеты.Период < ТаблицаОстатков.Период
		|	И Расчеты.КОплате <> 0
		|СГРУППИРОВАТЬ ПО
		|	Расчеты.АналитикаУчетаПоПартнерам,
		|	Расчеты.ОбъектРасчетов,
		|	Расчеты.Валюта
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Периоды.АналитикаУчетаПоПартнерам             КАК АналитикаУчетаПоПартнерам,
		|	Периоды.ЗаказПоставщику                       КАК ЗаказПоставщику,
		|	Периоды.Валюта                                КАК Валюта,
		|	Периоды.Период                                КАК Период,
		|	Периоды.ДатаПлатежа                           КАК ДатаПлатежа,
		|	СУММА(ЕСТЬNULL(Расчеты.КОплате, 0))           КАК КОплате
		|ПОМЕСТИТЬ ТаблицаОтгрузокПоставщиковКОплате
		|ИЗ
		|	ТаблицаПериодовПоставщиковКОплате КАК Периоды
		|		
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСПоставщиками КАК Расчеты
		|	ПО Периоды.АналитикаУчетаПоПартнерам   = Расчеты.АналитикаУчетаПоПартнерам
		|		И Периоды.ЗаказПоставщику          = Расчеты.ОбъектРасчетов
		|		И Периоды.ДатаПлатежа              = Расчеты.ДатаПлатежа
		|		И Периоды.Валюта                   = Расчеты.Валюта
		|		И Расчеты.Активность
		|		И (Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход))
		|		И (Расчеты.Период МЕЖДУ Периоды.Период И КОНЕЦПЕРИОДА(Периоды.Период, ДЕНЬ))
		|СГРУППИРОВАТЬ ПО
		|	Периоды.АналитикаУчетаПоПартнерам,
		|	Периоды.ЗаказПоставщику,
		|	Периоды.Валюта,
		|	Периоды.Период,
		|	Периоды.ДатаПлатежа
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Остатки.АналитикаУчетаПоПартнерам         КАК АналитикаУчетаПоПартнерам,
		|	Остатки.ЗаказПоставщику                   КАК ЗаказПоставщику,
		|	Остатки.Валюта                            КАК Валюта,
		|	ВЫБОР КОГДА Остатки.КОплатеОстаток > ЕСТЬNULL(Отгрузки.КОплате, 0)
		|			ТОГДА Остатки.КОплатеОстаток - ЕСТЬNULL(Отгрузки.КОплате, 0)
		|		ИНАЧЕ 0
		|	КОНЕЦ                                     КАК НовыйКОплатеОстаток,
		|	Остатки.КОплатеОстатокНаКонецПериода      КАК КОплатеОстатокНаКонецПериода,
		|	Отгрузки.Период                           КАК Период,
		|	ЕСТЬNULL(Отгрузки.ДатаПлатежа, Остатки.ДатаПлатежа) КАК ДатаПлатежа
		|ПОМЕСТИТЬ НовыеОстаткиПоставщиковКОплате
		|ИЗ
		|	ТаблицаОстатковПоставщиковКОплате КАК Остатки
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаОтгрузокПоставщиковКОплате КАК Отгрузки
		|	ПО Остатки.АналитикаУчетаПоПартнерам = Отгрузки.АналитикаУчетаПоПартнерам
		|		И Остатки.ЗаказПоставщику = Отгрузки.ЗаказПоставщику
		|		И Остатки.Валюта  = Отгрузки.Валюта
		|		И Остатки.КОплатеОстаток <> 0
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ТаблицаОстатковПоставщиковКОплате
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ТаблицаОтгрузокПоставщиковКОплате
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Остатки.АналитикаУчетаПоПартнерам         КАК АналитикаУчетаПоПартнерам,
		|	Остатки.ЗаказПоставщику                   КАК ЗаказПоставщику,
		|	Остатки.ЗаказПоставщику.Объект            КАК Объект,
		|	Остатки.Валюта                            КАК Валюта,
		|	Остатки.Период                            КАК Период,
		|	Остатки.ДатаПлатежа                       КАК ДатаПлатежа,
		|	Остатки.НовыйКОплатеОстаток          КАК КОплатеОстаток,
		|	Остатки.НовыйКОплатеОстаток          КАК КОплате,
		|	Остатки.КОплатеОстатокНаКонецПериода КАК КОплатеОстатокНаКонецПериода
		|ПОМЕСТИТЬ ТаблицаОстатковПоставщиковКОплате
		|ИЗ
		|	НовыеОстаткиПоставщиковКОплате КАК Остатки
		|ИНДЕКСИРОВАТЬ ПО
		|	АналитикаУчетаПоПартнерам,
		|	ЗаказПоставщику,
		|	Валюта
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ НовыеОстаткиПоставщиковКОплате
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ ПЕРВЫЕ 1
		|	1
		|ИЗ ТаблицаПериодовПоставщиковКОплате
		|";
		
		Результат = Запрос.Выполнить();
		Пока Не Результат.Пустой() Цикл 
			Результат = Запрос.Выполнить();
		КонецЦикла;
	КонецЕсли;
КонецПроцедуры

#КонецОбласти

#Область ПорядокРасчетов

// Устарела.
// Возвращает порядок расчетов по соглашению/договору, указанным в объекте.
//
// Параметры:
//	Объект - ДокументОбъект, Структура - Документ, по которому надо получить порядок расчетов.
//
// Возвращаемое значение:
//	ПеречислениеСсылка.ПорядокРасчетов - Порядок расчетов по умолчанию.
//
Функция ПорядокРасчетовПоУмолчанию(Объект) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	СтруктураОбъекта = Новый Структура("Соглашение, Договор");
	ЗаполнитьЗначенияСвойств(СтруктураОбъекта, Объект);
	
	Если ЗначениеЗаполнено(СтруктураОбъекта.Соглашение) Тогда
		РеквизитыСоглашения = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СтруктураОбъекта.Соглашение, "ИспользуютсяДоговорыКонтрагентов, ПорядокРасчетов");
		Если РеквизитыСоглашения.ИспользуютсяДоговорыКонтрагентов = Истина И ЗначениеЗаполнено(СтруктураОбъекта.Договор) Тогда
			ПорядокРасчетовПоДокументу = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктураОбъекта.Договор, "ПорядокРасчетов");
		ИначеЕсли РеквизитыСоглашения.ИспользуютсяДоговорыКонтрагентов = Ложь Тогда
			ПорядокРасчетовПоДокументу = РеквизитыСоглашения.ПорядокРасчетов;
		Иначе
			ПорядокРасчетовПоДокументу = Перечисления.ПорядокРасчетов.ПоЗаказам;
		КонецЕсли;
	ИначеЕсли ЗначениеЗаполнено(СтруктураОбъекта.Договор) Тогда
		ПорядокРасчетовПоДокументу = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктураОбъекта.Договор, "ПорядокРасчетов");
	Иначе
		ПорядокРасчетовПоДокументу = Перечисления.ПорядокРасчетов.ПоЗаказам;
	КонецЕсли;
	
	Возврат ПорядокРасчетовПоДокументу;
	
КонецФункции

// Определяет какие порядки расчетов можно использовать в выбранном документе.
//
// Параметры:
//	ЗначениеВДокументе - ПеречислениеСсылка.ПорядокРасчетов - Порядок расчетов, выбранный в документе.
//	ЗначениеПоУмолчанию - ПеречислениеСсылка.ПорядокРасчетов - Порядок расчетов, определяемый по соглашению/договору документа.
//	ПоЗаказу - Булево - Документ введен по заказу.
//	ЭтоЗаказ - Булево - Это заказ.
//	ЗаказКакСчет - Булево - это заказ и включена ФО заказ как счет.
//
// Возвращаемое значение:
//	СписокЗначений - Список доступных порядков расчета.
//
Функция ДоступныеПорядкиРасчетовПоДокументу(ЗначениеВДокументе, ЗначениеПоУмолчанию, ПоЗаказу = Ложь, ЭтоЗаказ = Ложь, ЗаказКакСчет = Ложь) Экспорт
	
	ПорядкиРасчетов = Новый СписокЗначений;
	
	Если ЗначениеЗаполнено(ЗначениеВДокументе) Тогда
		ПорядкиРасчетов.Добавить(ЗначениеВДокументе);
	КонецЕсли;
	
	Если НЕ ПоЗаказу Тогда
	
		Если ЗначениеПоУмолчанию = Перечисления.ПорядокРасчетов.ПоДоговорамКонтрагентов Тогда
			ПорядкиРасчетов.Добавить(Перечисления.ПорядокРасчетов.ПоДоговорамКонтрагентов);
			ПорядкиРасчетов.Добавить(Перечисления.ПорядокРасчетов.ПоДоговорамНакладным);
		КонецЕсли;
		
		Если ЗначениеПоУмолчанию = Перечисления.ПорядокРасчетов.ПоДоговорамНакладным Тогда
			ПорядкиРасчетов.Добавить(Перечисления.ПорядокРасчетов.ПоДоговорамНакладным);
		КонецЕсли;
		
		Если ЗначениеПоУмолчанию <> Перечисления.ПорядокРасчетов.ПоНакладным
				И (ПоЗаказу Или ЭтоЗаказ) Тогда
			ПорядкиРасчетов.Добавить(Перечисления.ПорядокРасчетов.ПоЗаказам);
			Если НЕ ЗаказКакСчет Тогда
				ПорядкиРасчетов.Добавить(Перечисления.ПорядокРасчетов.ПоЗаказамНакладным);
			КонецЕсли;
		КонецЕсли;
		
		ПорядкиРасчетов.Добавить(Перечисления.ПорядокРасчетов.ПоНакладным);
		
	КонецЕсли;
	МассивПорядков = ПорядкиРасчетов.ВыгрузитьЗначения();
	МассивПорядков = ОбщегоНазначенияКлиентСервер.СвернутьМассив(МассивПорядков);
	ПорядкиРасчетов.ЗагрузитьЗначения(МассивПорядков);
	
	Возврат ПорядкиРасчетов;
	
КонецФункции

// Возвращает порядок расчетов по переданным параметрам.
//
// Параметры:
//    ЭтоЗаказ - Булево - Истина, если это заказ.
//    ЗаказОснование - ДокументСсылка - Необязательный, заказ, по которому введен документ.
//    Соглашение - СправочникСсылка.СоглашенияСКлиентами, СправочникСсылка.СоглашенияСПоставщиками - Необязательный, соглашение документа.
//    Договор - СправочникСсылка.ДоговорыКонтрагентов - Необязательный, договор документа.
//
// Возвращаемое значение:
//    ПеречислениеСсылка.ПорядокРасчетов - Порядок расчетов.
//
Функция ПорядокРасчетов(ЭтоЗаказ, ЗаказОснование = Неопределено, Соглашение = Неопределено, Договор = Неопределено) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если ЗначениеЗаполнено(ЗаказОснование) Тогда
		ПорядокРасчетовПоДокументу = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ЗаказОснование, "ПорядокРасчетов");
	ИначеЕсли ЗначениеЗаполнено(Соглашение) Тогда
		УстановитьПривилегированныйРежим(Истина);
		РеквизитыСоглашения = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Соглашение, "ИспользуютсяДоговорыКонтрагентов, ПорядокРасчетов");
		УстановитьПривилегированныйРежим(Ложь);
		Если РеквизитыСоглашения.ИспользуютсяДоговорыКонтрагентов И ЗначениеЗаполнено(Договор) Тогда
			ПорядокРасчетовПоДокументу = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Договор, "ПорядокРасчетов");
		ИначеЕсли РеквизитыСоглашения.ИспользуютсяДоговорыКонтрагентов = Ложь Тогда
			ПорядокРасчетовПоДокументу = РеквизитыСоглашения.ПорядокРасчетов;
		Иначе
			ПорядокРасчетовПоДокументу = Перечисления.ПорядокРасчетов.ПоЗаказам;
		КонецЕсли;
	ИначеЕсли ЗначениеЗаполнено(Договор) Тогда
		ПорядокРасчетовПоДокументу = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Договор, "ПорядокРасчетов");
	ИначеЕсли ЭтоЗаказ Тогда
		ПорядокРасчетовПоДокументу = Перечисления.ПорядокРасчетов.ПоЗаказам;
	Иначе 
		ПорядокРасчетовПоДокументу = Перечисления.ПорядокРасчетов.ПоНакладным;
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Ложь);
	
	Возврат ПорядокРасчетовПоДокументу;
	
КонецФункции

#КонецОбласти

#Область ПрочиеПроцедуры

// Функция определяет вид договора контрагента для обмена
//	с конфигурацией "Бухгалтерия предприятия".
//
// Параметры:
//		ДокументРасчетов - ДокументСсылка - Документ расчетов, по которому нужно определить вид договора.
//		Соглашение - СправочникСсылка.СоглашенияСПоставщиками,СправочникСсылка.СоглашенияСКлиентами - Соглашение документа.
//		ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
//
// Возвращаемое значение:
// 		Строка - Вид договора, например, "СПокупателем".
Функция ВидДоговораКонтрагента(ДокументРасчетов, Соглашение, ХозяйственнаяОперация) Экспорт
	
	ВидДоговора = "";
	
	Если ЗначениеЗаполнено(ДокументРасчетов) Тогда
		
		Если ТипЗнч(ДокументРасчетов) = Тип("ДокументСсылка.ЗаказКлиента") Тогда
			Запрос = Новый Запрос("
			|ВЫБРАТЬ
			|	ВЫБОР КОГДА ДанныеДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаНаКомиссию) ТОГДА
			|		""СКомиссионером""
			|	ИНАЧЕ
			|		""СПокупателем""
			|	КОНЕЦ КАК ВидДоговора
			|ИЗ
			|	Документ.ЗаказКлиента КАК ДанныеДокумента
			|ГДЕ
			|	ДанныеДокумента.Ссылка = &Ссылка
			|");
			Запрос.УстановитьПараметр("Ссылка", ДокументРасчетов);
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				ВидДоговора = Выборка.ВидДоговора;
			Иначе
				ВидДоговора = "СПокупателем";
			КонецЕсли;
			
		ИначеЕсли ТипЗнч(ДокументРасчетов) = Тип("ДокументСсылка.ЗаявкаНаВозвратТоваровОтКлиента") Тогда
			Запрос = Новый Запрос("
			|ВЫБРАТЬ
			|	ВЫБОР КОГДА ДанныеДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтКомиссионера) ТОГДА
			|		""СКомиссионером""
			|	ИНАЧЕ
			|		""СПокупателем""
			|	КОНЕЦ КАК ВидДоговора
			|ИЗ
			|	Документ.ЗаявкаНаВозвратТоваровОтКлиента КАК ДанныеДокумента
			|ГДЕ
			|	ДанныеДокумента.Ссылка = &Ссылка
			|");
			Запрос.УстановитьПараметр("Ссылка", ДокументРасчетов);
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				ВидДоговора = Выборка.ВидДоговора;
			Иначе
				ВидДоговора = "СПокупателем";
			КонецЕсли;	
			
		ИначеЕсли ТипЗнч(ДокументРасчетов) = Тип("ДокументСсылка.ЗаказПоставщику") Тогда
			Запрос = Новый Запрос("
			|ВЫБРАТЬ
			|	ВЫБОР КОГДА ДанныеДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПриемНаКомиссию) ТОГДА
			|		""СКомитентом""
			|	ИНАЧЕ
			|		""СПоставщиком""
			|	КОНЕЦ КАК ВидДоговора
			|ИЗ
			|	Документ.ЗаказПоставщику КАК ДанныеДокумента
			|ГДЕ
			|	ДанныеДокумента.Ссылка = &Ссылка
			|");
			Запрос.УстановитьПараметр("Ссылка", ДокументРасчетов);
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				ВидДоговора = Выборка.ВидДоговора;
			Иначе
				ВидДоговора = "СПоставщиком";
			КонецЕсли;
			
		ИначеЕсли ТипЗнч(ДокументРасчетов) = Тип("ДокументСсылка.ПриобретениеТоваровУслуг") Тогда
			Запрос = Новый Запрос("
			|ВЫБРАТЬ
			|	ВЫБОР КОГДА ДанныеДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПриемНаКомиссию) ТОГДА
			|		""СКомитентом""
			|	ИНАЧЕ
			|		""СПоставщиком""
			|	КОНЕЦ КАК ВидДоговора
			|ИЗ
			|	Документ.ПриобретениеТоваровУслуг КАК ДанныеДокумента
			|ГДЕ
			|	ДанныеДокумента.Ссылка = &Ссылка
			|");
			Запрос.УстановитьПараметр("Ссылка", ДокументРасчетов);
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				ВидДоговора = Выборка.ВидДоговора;
			Иначе
				ВидДоговора = "СПоставщиком";
			КонецЕсли;
			
		ИначеЕсли ТипЗнч(ДокументРасчетов) = Тип("ДокументСсылка.ПриобретениеУслугПрочихАктивов") Тогда
			
			ВидДоговора = "СПоставщиком";
		ИначеЕсли ТипЗнч(ДокументРасчетов) = Тип("ДокументСсылка.РеализацияУслугПрочихАктивов") Тогда
			
			ВидДоговора = "СПокупателем";
			
		ИначеЕсли ТипЗнч(ДокументРасчетов) = Тип("ДокументСсылка.ВозвратТоваровПоставщику") Тогда
			Запрос = Новый Запрос("
			|ВЫБРАТЬ
			|	ВЫБОР КОГДА ДанныеДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровКомитенту) ТОГДА
			|		""СКомитентом""
			|	ИНАЧЕ
			|		""СПоставщиком""
			|	КОНЕЦ КАК ВидДоговора
			|ИЗ
			|	Документ.ВозвратТоваровПоставщику КАК ДанныеДокумента
			|ГДЕ
			|	ДанныеДокумента.Ссылка = &Ссылка
			|");
			Запрос.УстановитьПараметр("Ссылка", ДокументРасчетов);
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				ВидДоговора = Выборка.ВидДоговора;
			Иначе
				ВидДоговора = "СПоставщиком";
			КонецЕсли;	
			
		ИначеЕсли ТипЗнч(ДокументРасчетов) = Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда
			Запрос = Новый Запрос("
			|ВЫБРАТЬ
			|	ВЫБОР КОГДА ДанныеДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаНаКомиссию) ТОГДА
			|		""СКомиссионером""
			|	ИНАЧЕ
			|		""СПокупателем""
			|	КОНЕЦ КАК ВидДоговора
			|ИЗ
			|	Документ.РеализацияТоваровУслуг КАК ДанныеДокумента
			|ГДЕ
			|	ДанныеДокумента.Ссылка = &Ссылка
			|");
			Запрос.УстановитьПараметр("Ссылка", ДокументРасчетов);
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				ВидДоговора = Выборка.ВидДоговора;
			Иначе
				ВидДоговора = "СПокупателем";
			КонецЕсли;
			
		ИначеЕсли ТипЗнч(ДокументРасчетов) = Тип("ДокументСсылка.ВозвратТоваровОтКлиента") Тогда
			Запрос = Новый Запрос("
			|ВЫБРАТЬ
			|	ВЫБОР КОГДА ДанныеДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтКомиссионера) ТОГДА
			|		""СКомиссионером""
			|	ИНАЧЕ
			|		""СПокупателем""
			|	КОНЕЦ КАК ВидДоговора
			|ИЗ
			|	Документ.ВозвратТоваровОтКлиента КАК ДанныеДокумента
			|ГДЕ
			|	ДанныеДокумента.Ссылка = &Ссылка
			|");
			Запрос.УстановитьПараметр("Ссылка", ДокументРасчетов);
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				ВидДоговора = Выборка.ВидДоговора;
			Иначе
				ВидДоговора = "СПокупателем";
			КонецЕсли;	
			
		ИначеЕсли ТипЗнч(ДокументРасчетов) = Тип("ДокументСсылка.ОтчетКомиссионера")
		 ИЛИ ТипЗнч(ДокументРасчетов) = Тип("ДокументСсылка.ОтчетКомиссионераОСписании") Тогда
			ВидДоговора = "СКомиссионером";
			
		ИначеЕсли ТипЗнч(ДокументРасчетов) = Тип("ДокументСсылка.ОтчетКомитенту")
		 ИЛИ ТипЗнч(ДокументРасчетов) = Тип("ДокументСсылка.ОтчетКомитентуОСписании") Тогда
			ВидДоговора = "СКомитентом";
			
		ИначеЕсли ТипЗнч(ДокументРасчетов) = Тип("ДокументСсылка.ОтчетПоКомиссииМеждуОрганизациями") Тогда
			Если ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ОплатаДенежныхСредствВДругуюОрганизацию Тогда
				ВидДоговора = "СКомитентом";
				
			ИначеЕсли ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПоступлениеДенежныхСредствИзДругойОрганизации Тогда
				ВидДоговора = "СКомиссионером";
				
			Иначе
				ВидДоговора = "СКомитентом";
				
			КонецЕсли;
			
		ИначеЕсли ТипЗнч(ДокументРасчетов) = Тип("ДокументСсылка.ПередачаТоваровМеждуОрганизациями") Тогда
			Если ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ОплатаДенежныхСредствВДругуюОрганизацию Тогда
				ВидДоговора = "СПоставщиком";
				
			ИначеЕсли ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПоступлениеДенежныхСредствИзДругойОрганизации Тогда
				ВидДоговора = "СПокупателем";
				
			Иначе
				ВидДоговора = "СПоставщиком";
				
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
		
	Если ПустаяСтрока(ВидДоговора)
	 И ЗначениеЗаполнено(Соглашение) Тогда
		
		Если ТипЗнч(Соглашение) = Тип("СправочникСсылка.СоглашенияСПоставщиками") Тогда
			Запрос = Новый Запрос("
			|ВЫБРАТЬ
			|	ВЫБОР КОГДА ДанныеСправочника.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПриемНаКомиссию) ТОГДА
			|		""СКомитентом""
			|	ИНАЧЕ
			|		""СПоставщиком""
			|	КОНЕЦ КАК ВидДоговора
			|ИЗ
			|	Справочник.СоглашенияСПоставщиками КАК ДанныеСправочника
			|ГДЕ
			|	ДанныеСправочника.Ссылка = &Ссылка
			|");
			Запрос.УстановитьПараметр("Ссылка", Соглашение);
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				ВидДоговора = Выборка.ВидДоговора;
			Иначе
				ВидДоговора = "СПоставщиком";
			КонецЕсли;
			
		ИначеЕсли ТипЗнч(Соглашение) = Тип("СправочникСсылка.СоглашенияСКлиентами") Тогда
			Запрос = Новый Запрос("
			|ВЫБРАТЬ
			|	ВЫБОР КОГДА ДанныеСправочника.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаНаКомиссию) ТОГДА
			|		""СКомиссионером""
			|	ИНАЧЕ
			|		""СПокупателем""
			|	КОНЕЦ КАК ВидДоговора
			|ИЗ
			|	Справочник.СоглашенияСКлиентами КАК ДанныеСправочника
			|ГДЕ
			|	ДанныеСправочника.Ссылка = &Ссылка
			|");
			Запрос.УстановитьПараметр("Ссылка", Соглашение);
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				ВидДоговора = Выборка.ВидДоговора;
			Иначе
				ВидДоговора = "СПокупателем";
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
		
	Если ПустаяСтрока(ВидДоговора)
	 И ЗначениеЗаполнено(ХозяйственнаяОперация) Тогда
		
		Если ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПоступлениеОплатыОтКлиента
		 ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратОплатыКлиенту Тогда
			ВидДоговора = "СПокупателем";
		Иначе
			ВидДоговора = "СПоставщиком";
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат ВидДоговора;
	
КонецФункции

// Заменяет документы расчетов при вызове отчетов по взаиморасчетов из реализации.
// Если реализация по заказу клиента - документом расчетов является заказ клиента.
//
// Параметры:
// Параметры - ДанныеФормыСтруктура - Параметры отчета.
//
Процедура ЗаменитьДокументыРасчетовСКлиентами(Параметры) Экспорт
	
	Если Параметры.Свойство("Отбор") И Параметры.Отбор.Свойство("ЗаказКлиентаОтбор") Тогда
		
		УстановитьПривилегированныйРежим(Истина);
		
		ПараметрЗаказКлиента = Параметры.Отбор.ЗаказКлиентаОтбор;
		
		Запрос = Новый Запрос("
		|ВЫБРАТЬ
		|	ВЫБОР КОГДА ДанныеДокумента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов)
		|				ИЛИ ДанныеДокумента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным) ТОГДА
		|		ДанныеДокумента.Договор
		|	ИНАЧЕ
		|		ДанныеДокумента.Ссылка
		|	КОНЕЦ КАК ОбъектРасчетов
		|ПОМЕСТИТЬ ДанныеДокументов
		|ИЗ
		|	Документ.ЗаказКлиента КАК ДанныеДокумента
		|ГДЕ
		|	ДанныеДокумента.Ссылка В (&ЗаказКлиента)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВЫБОР КОГДА ДанныеДокумента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов)
		|			ИЛИ ДанныеДокумента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным) ТОГДА
		|		ДанныеДокумента.Договор
		|	ИНАЧЕ
		|		ДанныеДокумента.Ссылка
		|	КОНЕЦ КАК ОбъектРасчетов
		|ИЗ
		|	Документ.ЗаявкаНаВозвратТоваровОтКлиента КАК ДанныеДокумента
		|ГДЕ
		|	ДанныеДокумента.Ссылка В (&ЗаказКлиента)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВЫБОР КОГДА ДанныеДокумента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов) ТОГДА
		|		ДанныеДокумента.Договор
		|	КОГДА ДанныеДокумента.РеализацияПоЗаказам И НЕ ТаблицаТовары.ЗаказКлиента ЕСТЬ NULL
		|		И НЕ ДанныеДокумента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоНакладным) ТОГДА
		|		ТаблицаТовары.ЗаказКлиента
		|	ИНАЧЕ
		|		ДанныеДокумента.Ссылка
		|	КОНЕЦ КАК ОбъектРасчетов
		|ИЗ
		|	Документ.РеализацияТоваровУслуг КАК ДанныеДокумента
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК ТаблицаТовары
		|		ПО ТаблицаТовары.Ссылка = ДанныеДокумента.Ссылка
		|		И ДанныеДокумента.РеализацияПоЗаказам
		|ГДЕ
		|	ДанныеДокумента.Ссылка В (&ЗаказКлиента)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВЫБОР КОГДА ДанныеДокумента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов) ТОГДА
		|		ДанныеДокумента.Договор
		|	ИНАЧЕ
		|		ДанныеДокумента.Ссылка
		|	КОНЕЦ КАК ОбъектРасчетов
		|ИЗ
		|	Документ.РеализацияУслугПрочихАктивов КАК ДанныеДокумента
		|ГДЕ
		|	ДанныеДокумента.Ссылка В (&ЗаказКлиента)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВЫБОР КОГДА ДанныеДокумента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов) ТОГДА
		|		ДанныеДокумента.Договор
		|	КОГДА ДанныеДокумента.АктПоЗаказам И НЕ ТаблицаУслуги.ЗаказКлиента ЕСТЬ NULL
		|		И НЕ ДанныеДокумента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоНакладным) ТОГДА
		|		ТаблицаУслуги.ЗаказКлиента
		|	ИНАЧЕ
		|		ДанныеДокумента.Ссылка
		|	КОНЕЦ КАК ОбъектРасчетов
		|ИЗ
		|	Документ.АктВыполненныхРабот КАК ДанныеДокумента
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.АктВыполненныхРабот.Услуги КАК ТаблицаУслуги
		|		ПО ТаблицаУслуги.Ссылка = ДанныеДокумента.Ссылка
		|		И ДанныеДокумента.АктПоЗаказам
		|ГДЕ
		|	ДанныеДокумента.Ссылка В (&ЗаказКлиента)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВЫБОР КОГДА ДанныеДокумента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов) ТОГДА
		|		ДанныеДокумента.Договор
		|	КОГДА ДанныеДокумента.ПродажаПоЗаказам
		|		И НЕ ДанныеДокумента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоНакладным) ТОГДА
		|		ТаблицаТовары.ЗаказКлиента
		|	ИНАЧЕ
		|		ДанныеДокумента.ДокументОснование
		|	КОНЕЦ КАК ОбъектРасчетов
		|ИЗ
		|	Документ.КорректировкаРеализации КАК ДанныеДокумента
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаРеализации.Товары КАК ТаблицаТовары
		|		ПО ТаблицаТовары.Ссылка = ДанныеДокумента.Ссылка
		|ГДЕ
		|	ДанныеДокумента.Ссылка В (&ЗаказКлиента)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВЫБОР КОГДА ДанныеДокумента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов) ТОГДА
		|		ДанныеДокумента.Договор
		|	ИНАЧЕ
		|		ДанныеДокумента.Ссылка
		|	КОНЕЦ КАК ОбъектРасчетов
		|ИЗ
		|	Документ.ВыкупВозвратнойТарыКлиентом КАК ДанныеДокумента
		|ГДЕ
		|	ДанныеДокумента.Ссылка В (&ЗаказКлиента)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВЫБОР КОГДА ДанныеДокумента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов) ТОГДА
		|		ДанныеДокумента.Договор
		|	КОГДА ДанныеДокумента.ЗаявкаНаВозвратТоваровОтКлиента <> ЗНАЧЕНИЕ(Документ.ЗаявкаНаВозвратТоваровОтКлиента.ПустаяСсылка)
		|			И НЕ ДанныеДокумента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоНакладным) ТОГДА
		|		ДанныеДокумента.ЗаявкаНаВозвратТоваровОтКлиента
		|	ИНАЧЕ
		|		ДанныеДокумента.Ссылка
		|	КОНЕЦ КАК ОбъектРасчетов
		|ИЗ
		|	Документ.ВозвратТоваровОтКлиента КАК ДанныеДокумента
		|ГДЕ
		|	ДанныеДокумента.Ссылка В (&ЗаказКлиента)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ДанныеРегистра.ОбъектРасчетов КАК ОбъектРасчетов
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентами КАК ДанныеРегистра
		|ГДЕ
		|	ДанныеРегистра.Регистратор В (&ЗаказКлиента)
		|	И ДанныеРегистра.ОбъектРасчетов.ТипОбъектаРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыОбъектовРасчетов.ПлатежВозврат)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДанныеДокументов.ОбъектРасчетов КАК ОбъектРасчетов
		|ИЗ
		|	ДанныеДокументов КАК ДанныеДокументов
		|");
		
		Запрос.УстановитьПараметр("ЗаказКлиента", ПараметрЗаказКлиента);
		
		МассивДокументов = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("ОбъектРасчетов");
		
		Если ТипЗнч(ПараметрЗаказКлиента) = Тип("Массив") Тогда
			Для Каждого ТекЭлемент Из ПараметрЗаказКлиента Цикл
				Если ТипЗнч(ТекЭлемент) <> Тип("ДокументСсылка.ЗаказКлиента")
				 И ТипЗнч(ТекЭлемент) <> Тип("ДокументСсылка.ЗаявкаНаВозвратТоваровОтКлиента")
				 И ТипЗнч(ТекЭлемент) <> Тип("ДокументСсылка.РеализацияТоваровУслуг")
				 И ТипЗнч(ТекЭлемент) <> Тип("ДокументСсылка.РеализацияУслугПрочихАктивов")
				 И ТипЗнч(ТекЭлемент) <> Тип("ДокументСсылка.АктВыполненныхРабот")
				 И ТипЗнч(ТекЭлемент) <> Тип("ДокументСсылка.КорректировкаРеализации") Тогда
					МассивДокументов.Добавить(ТекЭлемент);
				КонецЕсли;
			КонецЦикла;
		ИначеЕсли ТипЗнч(ПараметрЗаказКлиента) <> Тип("ДокументСсылка.ЗаказКлиента")
		 И ТипЗнч(ПараметрЗаказКлиента) <> Тип("ДокументСсылка.ЗаявкаНаВозвратТоваровОтКлиента")
		 И ТипЗнч(ПараметрЗаказКлиента) <> Тип("ДокументСсылка.РеализацияТоваровУслуг")
		 И ТипЗнч(ПараметрЗаказКлиента) <> Тип("ДокументСсылка.РеализацияУслугПрочихАктивов")
		 И ТипЗнч(ПараметрЗаказКлиента) <> Тип("ДокументСсылка.АктВыполненныхРабот")
		 И ТипЗнч(ПараметрЗаказКлиента) <> Тип("ДокументСсылка.КорректировкаРеализации") Тогда
		 	МассивДокументов.Добавить(ПараметрЗаказКлиента);
		КонецЕсли;
		
		Для Счетчик = 0 По МассивДокументов.Количество() - 1 Цикл
			Если Не ТипЗнч(МассивДокументов[Счетчик]) = Тип("СправочникСсылка.ОбъектыРасчетов") Тогда
				МассивДокументов[Счетчик] = ОбъектыРасчетовСервер.ПолучитьОбъектРасчетовПоСсылке(МассивДокументов[Счетчик]);
			КонецЕсли;
		КонецЦикла;
		
		Параметры.Отбор.ЗаказКлиентаОтбор = МассивДокументов;
		
	КонецЕсли;
	
КонецПроцедуры

// Заменяет документы расчетов при вызове отчетов по взаиморасчетов из поступления.
// Если поступление по заказу поставщику - документом расчетов является заказ поставщику.
//
// Параметры:
// Параметры - ДанныеФормыСтруктура - Параметры отчета.
//
Процедура ЗаменитьДокументыРасчетовСПоставщиками(Параметры) Экспорт
	
	Если Параметры.Свойство("Отбор") И Параметры.Отбор.Свойство("ЗаказПоставщикуОтбор") Тогда
		
		УстановитьПривилегированныйРежим(Истина);
		
		ПараметрЗаказПоставщику = Параметры.Отбор.ЗаказПоставщикуОтбор;
		
		Запрос = Новый Запрос("
		|ВЫБРАТЬ
		|	ВЫБОР КОГДА ДанныеДокумента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов)
		|			ИЛИ ДанныеДокумента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным) ТОГДА
		|		ДанныеДокумента.Договор
		|	ИНАЧЕ
		|		ДанныеДокумента.Ссылка
		|	КОНЕЦ КАК ОбъектРасчетов
		|ПОМЕСТИТЬ ДанныеДокументов
		|ИЗ
		|	Документ.ЗаказПоставщику КАК ДанныеДокумента
		|ГДЕ
		|	ДанныеДокумента.Ссылка В (&ЗаказПоставщику)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВЫБОР КОГДА ДанныеДокумента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов) ТОГДА
		|		ДанныеДокумента.Договор
		|	КОГДА ДанныеДокумента.ПоступлениеПоЗаказам И НЕ ТаблицаТовары.ЗаказПоставщику ЕСТЬ NULL
		|		И НЕ ДанныеДокумента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоНакладным) ТОГДА
		|		ТаблицаТовары.ЗаказПоставщику
		|	ИНАЧЕ
		|		ДанныеДокумента.Ссылка
		|	КОНЕЦ КАК ОбъектРасчетов
		|ИЗ
		|	Документ.ПриобретениеТоваровУслуг КАК ДанныеДокумента
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПриобретениеТоваровУслуг.Товары КАК ТаблицаТовары
		|		ПО ТаблицаТовары.Ссылка = ДанныеДокумента.Ссылка
		|		И ДанныеДокумента.ПоступлениеПоЗаказам
		|ГДЕ
		|	ДанныеДокумента.Ссылка В (&ЗаказПоставщику)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВЫБОР КОГДА ДанныеДокумента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов) ТОГДА
		|		ДанныеДокумента.Договор
		|	ИНАЧЕ
		|		ДанныеДокумента.Ссылка
		|	КОНЕЦ КАК ОбъектРасчетов
		|ИЗ
		|	Документ.ПриобретениеУслугПрочихАктивов КАК ДанныеДокумента
		|ГДЕ
		|	ДанныеДокумента.Ссылка В (&ЗаказПоставщику)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ДанныеРегистра.ОбъектРасчетов.Объект КАК ОбъектРасчетов
		|ИЗ
		|	РегистрНакопления.РасчетыСПоставщиками КАК ДанныеРегистра
		|ГДЕ
		|	ДанныеРегистра.Регистратор В (&ЗаказПоставщику)
		|	И ТИПЗНАЧЕНИЯ(ДанныеРегистра.ОбъектРасчетов.Объект) В (ТИП(Документ.ПоступлениеБезналичныхДенежныхСредств),
		|												ТИП(Документ.СписаниеБезналичныхДенежныхСредств),
		|												ТИП(Документ.ПриходныйКассовыйОрдер),
		|												ТИП(Документ.РасходныйКассовыйОрдер),
		|												ТИП(Документ.ОперацияПоПлатежнойКарте),
		|												ТИП(Документ.ВводОстатков),
		|												ТИП(Документ.ВводОстатковВзаиморасчетов))
		|
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДанныеДокументов.ОбъектРасчетов КАК ОбъектРасчетов
		|ИЗ
		|	ДанныеДокументов КАК ДанныеДокументов
		|");
		
		Запрос.УстановитьПараметр("ЗаказПоставщику", ПараметрЗаказПоставщику);
		
		МассивДокументов = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("ОбъектРасчетов");
		
		Если ТипЗнч(ПараметрЗаказПоставщику) = Тип("Массив") Тогда
			Для Каждого ТекЭлемент Из ПараметрЗаказПоставщику Цикл
				Если ТипЗнч(ТекЭлемент) <> Тип("ДокументСсылка.ЗаказПоставщику")
				 И ТипЗнч(ТекЭлемент) <> Тип("ДокументСсылка.ПриобретениеТоваровУслуг")
				 И ТипЗнч(ТекЭлемент) <> Тип("ДокументСсылка.ПриобретениеУслугПрочихАктивов") Тогда
					МассивДокументов.Добавить(ТекЭлемент);
				КонецЕсли;
			КонецЦикла;
		ИначеЕсли ТипЗнч(ПараметрЗаказПоставщику) <> Тип("ДокументСсылка.ЗаказПоставщику")
		 И ТипЗнч(ПараметрЗаказПоставщику) <> Тип("ДокументСсылка.ПриобретениеТоваровУслуг")
		 И ТипЗнч(ПараметрЗаказПоставщику) <> Тип("ДокументСсылка.ПриобретениеУслугПрочихАктивов") Тогда
		 	МассивДокументов.Добавить(ПараметрЗаказПоставщику);
		КонецЕсли;
		
		Для Счетчик = 0 По МассивДокументов.Количество() - 1 Цикл
			Если Не ТипЗнч(МассивДокументов[Счетчик]) = Тип("СправочникСсылка.ОбъектыРасчетов") Тогда
				МассивДокументов[Счетчик] = ОбъектыРасчетовСервер.ПолучитьОбъектРасчетовПоСсылке(МассивДокументов[Счетчик]);
			КонецЕсли;
		КонецЦикла;
		
		Параметры.Отбор.ЗаказПоставщикуОтбор = МассивДокументов;
		
	КонецЕсли;
	
КонецПроцедуры

// Возвращает результат проверки количества вариантов классификации при отключенной опции "ИспользоватьНесколькоКлассификацийЗадолженности".
//
// Параметры:
// Количество - Число - количество элементов в справочнике "ВариантыКлассификацииЗадолженности".
// Форма - ФормаКлиентскогоПриложения - форма, источник проверки.
//
// Возвращаемое значение:
// Булево - Ложь, если проверка пройдена, Истина, если проверка не пройдена, выдать сообщение об ошибке.
//
Функция ПроверкаИСообщениеВариантовКлассификацииЗадолженности(Количество, Форма) Экспорт
	Если Форма = Неопределено Тогда
		ПрефиксСообщения = НСтр("ru = 'Не удалось заполнить поле ""Вариант классификации задолженности"".'");
	Иначе
		ПрефиксСообщения = "";
	КонецЕсли;
	
	СтатусВозврата = Ложь;
	Если Количество > 1 Тогда
		СообщениеОбОшибке = ПрефиксСообщения + НСтр("ru = 'В информационной базе введено несколько вариантов классификации задолженности.'") 
			+ Символы.ПС + Символы.ПС
			+ НСтр("ru = 'Включите функциональную опцию ""Предприятие - Несколько вариантов классификации задолженности"".'");
		ОбщегоНазначения.СообщитьПользователю(СообщениеОбОшибке);
		СтатусВозврата = Истина;
	ИначеЕсли Количество <> 1 Тогда
		СообщениеОбОшибке = ПрефиксСообщения + НСтр("ru = 'Возможно, в информационной базе не введено ни одного варианта классификации задолженности.'");
		ОбщегоНазначения.СообщитьПользователю(СообщениеОбОшибке);
		СтатусВозврата = Истина;
	КонецЕсли;

	Возврат СтатусВозврата;
КонецФункции 

// Формирует структуру отборов по партнеру и организации для контекстно вызываемых отчетов 
//   по расчетам с клиентом.
//
// Параметры:
//  МассивДокументов  - Массив - массив документов, которыми параметризуется отчет.
//  ИмяОтчета         - Строка - имя вызываемого отчета.
//  ИмяКоманды        - Строка - имя команды, при помощи которой вызывается отчет.вызываемого отчета.
//  Типы              - Массив - Массив типов параметра команды вызывающей отчет.
//
// Возвращаемое значение:
//   Структура   - сформированная структура отбора, где:
//      * Партнер - Массив из СправочникСсылка.Партнеры.
//      * Организация - Массив из СправочникСсылка.Организации.
//
Функция СтруктураОтборовОтчетовРасчетыСКлиентами(МассивДокументов, ИмяОтчета, ИмяКоманды, Типы = Неопределено) Экспорт
	
	СтруктураОтборов = Новый Структура;
	
	ШаблонЗапросаПоДокументам = "
	|ВЫБРАТЬ 
	|	Документ.Партнер,
	|	Документ.Организация
	|ПОМЕСТИТЬ ДокументыПартнерыОрганизации
	|ИЗ
	|	&ИмяТаблицы КАК Документ
	|ГДЕ
	|	Документ.Ссылка В(&МассивДокументов)";
	
	ТекстОбъединить = "
	|	
	|ОБЪЕДИНИТЬ ВСЕ
	|";
	
	ЭтоПервыйЗапросОбъединения = Истина;
	
	ТекстЗапроса = "";
	
	Коллекция = ?(ЗначениеЗаполнено(Типы), Типы, Метаданные.Отчеты[ИмяОтчета].Команды[ИмяКоманды].ТипПараметраКоманды.Типы());
	
	Для Каждого ТипПараметраКоманды Из Коллекция Цикл
		
		ОбъектМетаданныхДокумента = Метаданные.НайтиПоТипу(ТипПараметраКоманды);
		Если ПравоДоступа("Чтение", ОбъектМетаданныхДокумента) Тогда
			ИмяТаблицы = ОбъектМетаданныхДокумента.Имя;
			
			ТекстЗапросаПоДокументу = СтрЗаменить(ШаблонЗапросаПоДокументам, "&ИмяТаблицы", "Документ." + ИмяТаблицы);
			ТекстЗапросаПоДокументу = СтрЗаменить(ТекстЗапросаПоДокументу, 
			                                      "ПОМЕСТИТЬ ДокументыПартнерыОрганизации",
			                                      ?(НЕ ЭтоПервыйЗапросОбъединения,"", "ПОМЕСТИТЬ ДокументыПартнерыОрганизации"));
			
			ТекстЗапроса = ТекстЗапроса + ?(ЭтоПервыйЗапросОбъединения, "", ТекстОбъединить) + ТекстЗапросаПоДокументу;
			
			ЭтоПервыйЗапросОбъединения = Ложь;
		КонецЕсли;
		
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.Текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("МассивДокументов", МассивДокументов);
	
	УстановитьПривилегированныйРежим(Истина);
	Запрос.Выполнить();
	УстановитьПривилегированныйРежим(Ложь);
	
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ДокументыПартнерыОрганизации.Партнер
	|ИЗ
	|	Справочник.Партнеры КАК Партнеры
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыПартнерыОрганизации КАК ДокументыПартнерыОрганизации
	|		ПО Партнеры.Ссылка = ДокументыПартнерыОрганизации.Партнер
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ДокументыПартнерыОрганизации.Организация
	|ИЗ
	|	Справочник.Организации КАК Организации
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыПартнерыОрганизации КАК ДокументыПартнерыОрганизации
	|		ПО Организации.Ссылка = ДокументыПартнерыОрганизации.Организация";
	
	
	Результат = Запрос.ВыполнитьПакет();
	
	СтруктураОтборов.Вставить("Партнер", Результат[0].Выгрузить().ВыгрузитьКолонку("Партнер"));
	СтруктураОтборов.Вставить("Организация", Результат[1].Выгрузить().ВыгрузитьКолонку("Организация"));
	
	Возврат СтруктураОтборов;
	
КонецФункции

// Определяется возможная сумма списания с текущего остатка - весь остаток или только часть остатка равная сумме списания.
// При этом уменьшается текущий остаток на сумму списания и сама сумма списания.
//
// Параметры:
//  СуммаОстатка - Число - Текущий остаток с которого необходимо списать сумму.
//  СуммаКСписанию - Число - Сумма которую необходимо списать.
//  ПоследняяЧасть - Булево - если истина, то списать весь остаток.
//
// Возвращаемое значение:
//  Число - сумма которую необходимо списать или весь остаток целиком в случае если он меньше заданной суммы или
//          ПоследняяЧасть = Истина.
//
Функция СписатьСумму(СуммаОстатка, СуммаКСписанию, ПоследняяЧасть = Ложь) Экспорт
	
	СуммаСписания = 0;
	КСписанию = Макс(СуммаКСписанию, -СуммаКСписанию);
	Знак = ?(КСписанию = 0, 1, СуммаКСписанию/КСписанию);
	
	Если СуммаОстатка >= КСписанию И НЕ ПоследняяЧасть Тогда
		СуммаСписания = КСписанию;
		СуммаОстатка = СуммаОстатка - СуммаСписания;
		КСписанию = 0;
	Иначе
		СуммаСписания = СуммаОстатка;
		КСписанию = КСписанию - СуммаСписания;
		СуммаОстатка = 0;
	КонецЕсли;
	
	СуммаКСписанию = Знак * КСписанию;
	
	Возврат СуммаСписания;
	
КонецФункции

// Определяется возможная сумма списания с текущего остатка одного показателя, 
// пропорционально уже списанной по другому показателю.
// При этом уменьшается текущий остаток.
//
// Параметры:
//	СуммаОстатка - Число - Текущий остаток с которого необходимо списать сумму.
//	СуммаСписано - Число - Сумма которая уже списана с другого показателя.
//	СуммаВсего - Число - Сумма по другому показателю до списания.
//
// Возвращаемое значение:
//	Число - сумма которую необходимо списать.
//
Функция СписатьСуммуПропорционально(СуммаОстатка, СуммаСписано, СуммаВсего) Экспорт
	
	СуммаКСписанию = 0;
	Если СуммаВсего > 0 Тогда
		СуммаКСписанию = Окр(СуммаОстатка * СуммаСписано / СуммаВсего, 2);
	КонецЕсли;
	
	Возврат СписатьСумму(СуммаОстатка, СуммаКСписанию);
	
КонецФункции

// Функция - конструктор процедуры ВзаиморасчетыСервер.ЗаполнитьРасшифровкуПлатежаПоЗаказуКлиента.
//
// Возвращаемое значение:
//	Структура - Структура параметров:
//		* Партнер          - СправочникСсылка.Партнеры - Партнер документа-инициатора.
//		* Договор          - СправочникСсылка.ДоговорыКонтрагентов - Договор объекта расчетов.
//		* ЗаказКлиента     - ДокументСсылка.ЗаказКлиента - Объект расчетов.
//		* ВалютаДокумента  - СправочникСсылка.Валюты - Валюта документа поступления денежных средств.
//		* ОснованиеПлатежа - ДокументСсылка - Документ-основание.
//
Функция ПараметрыЗаполненияРасшифровкиПлатежаПоЗаказу() Экспорт
	
	Параметры = Новый Структура;
	Параметры.Вставить("Партнер");
	Параметры.Вставить("Договор");
	Параметры.Вставить("ЗаказКлиента");
	Параметры.Вставить("ВалютаДокумента");
	Параметры.Вставить("ОснованиеПлатежа");
	
	Возврат Параметры;
КонецФункции

// Функция возвращает максимальную дату из временной таблицы, которая содержит перечень документов.
//
// Параметры:
//	МенеджерВременныхТаблиц - МенеджерВременныхТаблиц - Содержит временную таблицу ТаблицаДанныхДокументов,
//														с перечнем документов одного типа.
// Возвращаемое значение:
// 	Дата - Максимальная дата в коллекци документов.
Функция ПолучитьМаксимальнуюДатуВКоллекцииДокументов(МенеджерВременныхТаблиц) Экспорт
	
	Запрос = Новый Запрос("
	|ВЫБРАТЬ
	|	ЕСТЬNULL(МАКСИМУМ(КоллекцияДокументов.Ссылка.Дата), НЕОПРЕДЕЛЕНО) КАК Период
	|ИЗ
	|	ТаблицаДанныхДокументов КАК КоллекцияДокументов
	|");
	
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	Результат = Запрос.Выполнить();
	
	Если Не Результат.Пустой() Тогда
		МаксимальнаяДата = Результат.Выгрузить()[0].Период;
		
		Если МаксимальнаяДата = Неопределено Тогда
			МаксимальнаяДата = ТекущаяДатаСеанса();
		КонецЕсли;
	Иначе
		МаксимальнаяДата = ТекущаяДатаСеанса();
	КонецЕсли;
	
	Возврат МаксимальнаяДата;
КонецФункции

// Процедура формирует записи в регистре сведений "Задания к распределению расчетов с клиентами",
// если текущий документ изменяет записи в регистре "Расчеты с клиентами".
// Параметры:
//	Документ - ДокументСсылка - Ссылка на документ-регистратор
//	МенеджерВременныхТаблиц - МенеджерВременныхТаблиц - Содержит временную таблицу изменений.
Процедура ОтразитьЗаданияКРаспределениюРасчетовСКлиентами(Документ, МенеджерВременныхТаблиц) Экспорт
	
	Если Константы.НоваяАрхитектураВзаиморасчетов.Получить() Тогда
		Возврат;
	КонецЕсли;
	
	ОписаниеЗамера = ОценкаПроизводительности.НачатьЗамерДлительнойОперации("ВзаиморасчетыСервер.ОтразитьЗаданияКРаспределениюРасчетовСКлиентами");
	
	ВременныеТаблицы = МенеджерВременныхТаблиц;
	
	Если (ВременныеТаблицы.Таблицы.Найти("РасчетыСКлиентамиИзменения") <> Неопределено
			ИЛИ ВременныеТаблицы.Таблицы.Найти("РасчетыСКлиентамиПоДокументамЗаданияКРасчетамСКлиентами") <> Неопределено)
		И ПланыОбмена.ГлавныйУзел() = Неопределено Тогда // есть изменения в оперативном регистре
		
		ШаблонВложенныйЗапрос = "
		|ВЫБРАТЬ
		|	Таблица.Месяц                        КАК Месяц,
		|	Таблица.АналитикаУчетаПоПартнерам    КАК АналитикаУчетаПоПартнерам,
		|	Ключи.Организация                    КАК Организация,
		|	Таблица.ОбъектРасчетов               КАК ОбъектРасчетов,
		|	Таблица.Документ                     КАК Документ
		|ИЗ
		|	&ТаблицаДанных КАК Таблица
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПоПартнерам КАК Ключи
		|	ПО Ключи.Ссылка = Таблица.АналитикаУчетаПоПартнерам
		|";
		
		ШаблонТекстУничтожениеВТ = "
		|;
		|//////////////////////////////
		|УНИЧТОЖИТЬ &ТаблицаДанных
		|";
		
		ТекстУничтожениеВТ = "";
		ВложенныйЗапрос = "";
		КоличествоТаблиц = 0;
		
		Если ВременныеТаблицы.Таблицы.Найти("РасчетыСКлиентамиИзменения") <> Неопределено Тогда
			ВложенныйЗапрос = СтрЗаменить(ШаблонВложенныйЗапрос, "&ТаблицаДанных", "(" + ТестЗапросаРаспределениеРасчетовСКлиентами() + ")");
			ВложенныйЗапрос = СтрЗаменить(ВложенныйЗапрос, "Ключи.Организация", "Таблица.Организация");
			КоличествоТаблиц = КоличествоТаблиц + 1;
		КонецЕсли;
		
		Если ВременныеТаблицы.Таблицы.Найти("РасчетыСКлиентамиПоДокументамЗаданияКРасчетамСКлиентами") <> Неопределено Тогда
			Если КоличествоТаблиц = 0 Тогда
				ВложенныйЗапрос = СтрЗаменить(ШаблонВложенныйЗапрос, "&ТаблицаДанных", "РасчетыСКлиентамиПоДокументамЗаданияКРасчетамСКлиентами");
				ТекстУничтожениеВТ = СтрЗаменить(ШаблонТекстУничтожениеВТ, "&ТаблицаДанных", "РасчетыСКлиентамиПоДокументамЗаданияКРасчетамСКлиентами");
			Иначе
				ВложенныйЗапрос = ВложенныйЗапрос + "
					|ОБЪЕДИНИТЬ ВСЕ
					|"
					+ СтрЗаменить(ШаблонВложенныйЗапрос, "&ТаблицаДанных", "РасчетыСКлиентамиПоДокументамЗаданияКРасчетамСКлиентами");
				ТекстУничтожениеВТ = ТекстУничтожениеВТ + СтрЗаменить(ШаблонТекстУничтожениеВТ, "&ТаблицаДанных", "РасчетыСКлиентамиПоДокументамЗаданияКРасчетамСКлиентами");
			КонецЕсли;
			КоличествоТаблиц = КоличествоТаблиц + 1;
		КонецЕсли;
		
		Если КоличествоТаблиц = 1 Тогда
			ТекстЗапроса = ВложенныйЗапрос + ТекстУничтожениеВТ;
		Иначе
			ШаблонТекстаЗапроса = "
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	Таблица.Месяц                        КАК Месяц,
			|	Таблица.АналитикаУчетаПоПартнерам    КАК АналитикаУчетаПоПартнерам,
			|	Таблица.Организация                  КАК Организация,
			|	Таблица.ОбъектРасчетов               КАК ОбъектРасчетов,
			|	Таблица.Документ                     КАК Документ
			|ИЗ
			|	(ВЫБРАТЬ &ВложенныйЗапрос
			|	) КАК Таблица
			|
			|";
			ТекстЗапроса = СтрЗаменить(ШаблонТекстаЗапроса, "ВЫБРАТЬ &ВложенныйЗапрос", ВложенныйЗапрос) + ТекстУничтожениеВТ;
		КонецЕсли;
		
		Запрос = Новый Запрос(ТекстЗапроса);
		Запрос.МенеджерВременныхТаблиц = ВременныеТаблицы;
		Запрос.УстановитьПараметр("НовыеРасчеты", ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов"));
		Выборка = Запрос.Выполнить().Выбрать();
		Пока Выборка.Следующий() Цикл
			НаборЗаписей = РегистрыСведений.ЗаданияКРаспределениюРасчетовСКлиентами.СоздатьМенеджерЗаписи();
			ЗаполнитьЗначенияСвойств(НаборЗаписей, Выборка);
			НаборЗаписей.НомерЗадания = Константы.НомерЗаданияКРаспределениюРасчетовСКлиентами.Получить();
			НаборЗаписей.Записать();
		КонецЦикла;
	КонецЕсли;
	
	ОценкаПроизводительности.ЗакончитьЗамерДлительнойОперации(ОписаниеЗамера, 1);
	
КонецПроцедуры

// Процедура формирует записи в регистре сведений "Задания к распределению расчетов с поставщиками",
// если текущий документ изменяет записи в регистре "Расчеты с поставщиками".
//
// Параметры:
//  Документ - ДокументСсылка - Ссылка на документ-регистратор
//  МенеджерВременныхТаблиц - МенеджерВременныхТаблиц - Содержит временную таблицу изменений.
//
Процедура ОтразитьЗаданияКРаспределениюРасчетовСПоставщиками(Документ, МенеджерВременныхТаблиц) Экспорт
	
	Если Константы.НоваяАрхитектураВзаиморасчетов.Получить() Тогда
		Возврат;
	КонецЕсли;
	
	ОписаниеЗамера = ОценкаПроизводительности.НачатьЗамерДлительнойОперации("ВзаиморасчетыСервер.ОтразитьЗаданияКРаспределениюРасчетовСПоставщиками");

	ВременныеТаблицы = МенеджерВременныхТаблиц;
	
	Если (ВременныеТаблицы.Таблицы.Найти("РасчетыСПоставщикамиИзменения") <> Неопределено
			ИЛИ ВременныеТаблицы.Таблицы.Найти("РасчетыСПоставщикамиПоДокументамЗаданияКРасчетамСПоставщиками") <> Неопределено)
		И ПланыОбмена.ГлавныйУзел() = Неопределено Тогда // есть изменения в оперативном регистре
		
		ШаблонВложенныйЗапрос = "
		|ВЫБРАТЬ
		|	Таблица.Месяц                        КАК Месяц,
		|	Таблица.АналитикаУчетаПоПартнерам    КАК АналитикаУчетаПоПартнерам,
		|	Ключи.Организация                    КАК Организация,
		|	Таблица.ОбъектРасчетов               КАК ОбъектРасчетов,
		|	Таблица.Документ                     КАК Документ
		|ИЗ
		|	&ТаблицаДанных КАК Таблица
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПоПартнерам КАК Ключи
		|	ПО Ключи.Ссылка = Таблица.АналитикаУчетаПоПартнерам
		|";
		
		ШаблонТекстУничтожениеВТ = "
		|;
		|//////////////////////////////
		|УНИЧТОЖИТЬ &ТаблицаДанных
		|";
		
		ТекстУничтожениеВТ = "";
		ВложенныйЗапрос = "";
		КоличествоТаблиц = 0;
		
		Если ВременныеТаблицы.Таблицы.Найти("РасчетыСПоставщикамиИзменения") <> Неопределено Тогда
			ВложенныйЗапрос = СтрЗаменить(ШаблонВложенныйЗапрос, "&ТаблицаДанных", "(" + ТестЗапросаРаспределениеРасчетовСПоставщиками() + ")");
			ВложенныйЗапрос = СтрЗаменить(ВложенныйЗапрос, "Ключи.Организация", "Таблица.Организация");
			КоличествоТаблиц = КоличествоТаблиц + 1;
		КонецЕсли;
		
		Если ВременныеТаблицы.Таблицы.Найти("РасчетыСПоставщикамиПоДокументамЗаданияКРасчетамСПоставщиками") <> Неопределено Тогда
			Если КоличествоТаблиц = 0 Тогда
				ВложенныйЗапрос = СтрЗаменить(ШаблонВложенныйЗапрос, "&ТаблицаДанных", "РасчетыСПоставщикамиПоДокументамЗаданияКРасчетамСПоставщиками");
				ТекстУничтожениеВТ = СтрЗаменить(ШаблонТекстУничтожениеВТ, "&ТаблицаДанных", "РасчетыСПоставщикамиПоДокументамЗаданияКРасчетамСПоставщиками");
			Иначе
				ВложенныйЗапрос = ВложенныйЗапрос + "
					|ОБЪЕДИНИТЬ ВСЕ
					|"
					+ СтрЗаменить(ШаблонВложенныйЗапрос, "&ТаблицаДанных", "РасчетыСПоставщикамиПоДокументамЗаданияКРасчетамСПоставщиками");
				ТекстУничтожениеВТ = ТекстУничтожениеВТ + СтрЗаменить(ШаблонТекстУничтожениеВТ, "&ТаблицаДанных", "РасчетыСПоставщикамиПоДокументамЗаданияКРасчетамСПоставщиками");
			КонецЕсли;
			КоличествоТаблиц = КоличествоТаблиц + 1;
		КонецЕсли;
		
		Если КоличествоТаблиц = 1 Тогда
			ТекстЗапроса = ВложенныйЗапрос + ТекстУничтожениеВТ;
		Иначе
			ШаблонТекстаЗапроса = "
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	Таблица.Месяц                        КАК Месяц,
			|	Таблица.АналитикаУчетаПоПартнерам    КАК АналитикаУчетаПоПартнерам,
			|	Таблица.Организация                  КАК Организация,
			|	Таблица.ОбъектРасчетов               КАК ОбъектРасчетов,
			|	Таблица.Документ                     КАК Документ
			|ИЗ
			|	(ВЫБРАТЬ &ВложенныйЗапрос
			|	) КАК Таблица
			|
			|";
			ТекстЗапроса = СтрЗаменить(ШаблонТекстаЗапроса, "ВЫБРАТЬ &ВложенныйЗапрос", ВложенныйЗапрос) + ТекстУничтожениеВТ;
		КонецЕсли;
		
		Запрос = Новый Запрос(ТекстЗапроса);
		Запрос.МенеджерВременныхТаблиц = ВременныеТаблицы;
		Запрос.УстановитьПараметр("НовыеРасчеты", ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов"));
		Выборка = Запрос.Выполнить().Выбрать();
		Пока Выборка.Следующий() Цикл
			НаборЗаписей = РегистрыСведений.ЗаданияКРаспределениюРасчетовСПоставщиками.СоздатьМенеджерЗаписи();
			ЗаполнитьЗначенияСвойств(НаборЗаписей, Выборка);
			НаборЗаписей.НомерЗадания = Константы.НомерЗаданияКРаспределениюРасчетовСПоставщиками.Получить();
			НаборЗаписей.Записать();
		КонецЦикла;
	КонецЕсли;
	
	ОценкаПроизводительности.ЗакончитьЗамерДлительнойОперации(ОписаниеЗамера, 1);
	
КонецПроцедуры

// Устарела.
// Функция определяет, является ли переданная хозяйственная операция операцией интеркампани.
//
// Параметры:
//	ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция для проверки.
//
// Возвращаемое значение:
//	Булево - Истина, если является операцией интеркампани.
//
Функция ХозяйственнаяОперацияИнтеркампани(ХозяйственнаяОперация) Экспорт
	
	Если ХозяйственнаяОперация = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ПоступлениеДенежныхСредствИзДругойОрганизации") 
		ИЛИ ХозяйственнаяОперация = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствВДругуюОрганизацию")
		ИЛИ ХозяйственнаяОперация = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ОплатаДенежныхСредствВДругуюОрганизацию")
		ИЛИ ХозяйственнаяОперация = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствОтДругойОрганизации") Тогда
		Возврат Истина;
	Иначе
		Возврат Ложь;
	КонецЕсли;
	
КонецФункции

// Устарела.
// Функция определяет, является ли переданная хозяйственная операция операцией с клиентом.
//
// Параметры:
//	ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция для проверки.
//
// Возвращаемое значение:
//	Булево - Истина, если является операцией с клиентом.
//
Функция ХозяйственнаяОперацияСКлиентом(ХозяйственнаяОперация) Экспорт
	
	Если ХозяйственнаяОперация = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ПоступлениеОплатыОтКлиента") 
		ИЛИ ХозяйственнаяОперация = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ВозвратОплатыКлиенту") Тогда
		Возврат Истина;
	Иначе
		Возврат Ложь;
	КонецЕсли;
	
КонецФункции

// Устарела.
// Функция определяет, является ли переданная хозяйственная операция операцией с поставщиком.
//
// Параметры:
//	ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция для проверки.
//
// Возвращаемое значение:
//	Булево - Истина, если является операцией с поставщиком.
//
Функция ХозяйственнаяОперацияСПоставщиком(ХозяйственнаяОперация) Экспорт
	
	Если ХозяйственнаяОперация = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ОплатаПоставщику") 
		ИЛИ ХозяйственнаяОперация = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствОтПоставщика") 
		ИЛИ ХозяйственнаяОперация = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ПеречислениеТаможне") Тогда
		Возврат Истина;
	Иначе
		Возврат Ложь;
	КонецЕсли;
	
КонецФункции

// Устарела.
// Функция определяет, является ли переданная хозяйственная операция операцией возврата денежных средств.
//
// Параметры:
//	ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция для проверки.
//
// Возвращаемое значение:
//	Булево - Истина, если является операцией возврата денежных средств.
//
Функция ХозяйственнаяОперацияВозвратДенежныхСредств(ХозяйственнаяОперация) Экспорт
	
	Если ХозяйственнаяОперация = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствОтДругойОрганизации")
		ИЛИ ХозяйственнаяОперация = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствВДругуюОрганизацию")
		ИЛИ ХозяйственнаяОперация = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствОтПоставщика")
		ИЛИ ХозяйственнаяОперация = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ВозвратОплатыКлиенту") Тогда
		Возврат Истина;
	Иначе
		Возврат Ложь;
	КонецЕсли;
	
КонецФункции

// Получение списка контрагентов по сделкам для отправки приглашений.
//
// Параметры:
//  Организация			 - СправочникСсылка - ссылка на организацию, от которой производится приглашение.
//  РежимЗаполнения		 - Строка - режим заполнения контрагентов: "ЗаполнитьПоПоставкам", "ЗаполнитьПоЗакупкам", "ЗаполнитьПоВсемСделкам".
//  НачалоПериода		 - Дата - начало периода заполнения.
//  СписокКонтрагентов	 - ТаблицаЗначений - список контрагентов:
//    * Ссылка - СправочникСсылка - контрагент.
//    * ЭлектроннаяПочта - Строка - адрес электронной почты.
//
Процедура ПолучитьКонтрагентовПоСделкам(Организация, РежимЗаполнения, НачалоПериода, СписокКонтрагентов) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ЗаполнитьПоПоставкам",   РежимЗаполнения = "ЗаполнитьПоПоставкам");
	Запрос.УстановитьПараметр("ЗаполнитьПоЗакупкам",    РежимЗаполнения = "ЗаполнитьПоЗакупкам");
	Запрос.УстановитьПараметр("ЗаполнитьПоВсемСделкам", РежимЗаполнения = "ЗаполнитьПоВсемСделкам");
	Запрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	Запрос.УстановитьПараметр("Организация",   Организация);
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Контрагенты.Ссылка КАК Ссылка
	|ИЗ
	|	(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		КлючиАналитикиУчетаПоПартнерам.Контрагент КАК Ссылка
	|	ИЗ
	|		РегистрНакопления.РасчетыСКлиентами.Обороты(&НачалоПериода, , , ) КАК РасчетыСКлиентамиОбороты
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПоПартнерам КАК КлючиАналитикиУчетаПоПартнерам
	|			ПО РасчетыСКлиентамиОбороты.АналитикаУчетаПоПартнерам = КлючиАналитикиУчетаПоПартнерам.Ссылка
	|	ГДЕ
	|		КлючиАналитикиУчетаПоПартнерам.Организация = &Организация
	|		И (&ЗаполнитьПоПоставкам
	|				ИЛИ &ЗаполнитьПоВсемСделкам)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		КлючиАналитикиУчетаПоПартнерам.Контрагент
	|	ИЗ
	|		РегистрНакопления.РасчетыСПоставщиками.Обороты(&НачалоПериода, , , ) КАК РасчетыСПоставщикамиОбороты
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПоПартнерам КАК КлючиАналитикиУчетаПоПартнерам
	|			ПО РасчетыСПоставщикамиОбороты.АналитикаУчетаПоПартнерам = КлючиАналитикиУчетаПоПартнерам.Ссылка
	|	ГДЕ
	|		КлючиАналитикиУчетаПоПартнерам.Организация = &Организация
	|		И (&ЗаполнитьПоЗакупкам
	|				ИЛИ &ЗаполнитьПоВсемСделкам)) КАК Контрагенты
	|
	|УПОРЯДОЧИТЬ ПО
	|	Контрагенты.Ссылка";
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Если ТипЗнч(Выборка.Ссылка) = Тип("СправочникСсылка.Контрагенты") Тогда
			НоваяСтрока = СписокКонтрагентов.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
			// ЭлектронноеВзаимодействие.ОбменСКонтрагентами
			ОбменСКонтрагентамиПереопределяемый.АдресЭлектроннойПочтыКонтрагента(
				Выборка.Ссылка, НоваяСтрока.ЭлектроннаяПочта);
			// Конец ЭлектронноеВзаимодействие.ОбменСКонтрагентами
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// ЭлектронноеВзаимодействие.ТорговыеПредложения
// Заполнение штрихкодов для выгрузки.
//
// Параметры:
//  Организации	 - Массив - Список организация, для которых производится выгрузка.
//  РежимПоставщика - Булево - Выгружать только данные по продажам.
//  РежимПокупателя - Булево - Выгружать только данные по покупкам.
//  Штрихкоды	 - ТаблицаЗначений - данные по штрихкодам, 
//                 см. ТорговыеПредложения.ОбновитьПодсказкиТорговыеПредложения:
//    * Штрихкод - Строка - штрихкод товара.
//    * Наименование - Строка - Наименование товара
//    * РежимПоставщика - Булево - признак использования штрихкода в продажах.
//    * РежимПокупателя - Булево - признак использования штрихкода в закупках.
//
Процедура ЗаполнитьШтрихкодыДляВыгрузки(Знач Организации, Знач РежимПоставщика, Знач РежимПокупателя, Штрихкоды) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Номенклатура.Организация КАК Организация,
	|	Номенклатура.Ссылка КАК Номенклатура,
	|	Номенклатура.Ссылка.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	Номенклатура.Характеристика КАК Характеристика
	|ПОМЕСТИТЬ ВтНоменклатура
	|ИЗ
	|	(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		КлючиАналитикиУчетаПоПартнерам.Организация КАК Организация,
	|		КлючиАналитикиУчетаНоменклатуры.Номенклатура КАК Ссылка,
	|		КлючиАналитикиУчетаНоменклатуры.Характеристика КАК Характеристика
	|	ИЗ
	|		РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериода, , , ) КАК ВыручкаИСебестоимостьПродаж
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КлючиАналитикиУчетаНоменклатуры
	|			ПО ВыручкаИСебестоимостьПродаж.АналитикаУчетаНоменклатуры = КлючиАналитикиУчетаНоменклатуры.Ссылка
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПоПартнерам КАК КлючиАналитикиУчетаПоПартнерам
	|			ПО ВыручкаИСебестоимостьПродаж.АналитикаУчетаПоПартнерам = КлючиАналитикиУчетаПоПартнерам.Ссылка
	|	ГДЕ
	|		КлючиАналитикиУчетаПоПартнерам.Организация В(&Организации)
	|		И &РежимПоставщика
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Закупки.Организация,
	|		КлючиАналитикиУчетаНоменклатуры.Номенклатура,
	|		КлючиАналитикиУчетаНоменклатуры.Характеристика
	|	ИЗ
	|		РегистрНакопления.Закупки.Обороты(&НачалоПериода, , , ) КАК Закупки
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КлючиАналитикиУчетаНоменклатуры
	|			ПО Закупки.АналитикаУчетаНоменклатуры = КлючиАналитикиУчетаНоменклатуры.Ссылка
	|	ГДЕ
	|		Закупки.Организация В(&Организации)
	|		И &РежимПокупателя) КАК Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 10000
	|	ВтНоменклатура.Организация КАК Организация,
	|	ВЫБОР
	|		КОГДА ВтНоменклатура.Номенклатура.НаименованиеПолное ПОДОБНО """"
	|			ТОГДА ВтНоменклатура.Номенклатура.Наименование
	|		ИНАЧЕ ВтНоменклатура.Номенклатура.НаименованиеПолное
	|	КОНЕЦ + ВЫБОР
	|		КОГДА ВтНоменклатура.Характеристика.Наименование ЕСТЬ NULL
	|				ИЛИ ВтНоменклатура.Характеристика.Наименование ПОДОБНО """"
	|			ТОГДА """"
	|		ИНАЧЕ "", "" + ВтНоменклатура.Характеристика.Наименование
	|	КОНЕЦ + ВЫБОР
	|		КОГДА ВтНоменклатура.ЕдиницаИзмерения.Наименование ЕСТЬ NULL
	|				ИЛИ ВтНоменклатура.ЕдиницаИзмерения.Наименование ПОДОБНО """"
	|			ТОГДА """"
	|		ИНАЧЕ "" ("" + ВтНоменклатура.ЕдиницаИзмерения.Наименование + "")""
	|	КОНЕЦ КАК Наименование,
	|	ШтрихкодыНоменклатуры.Штрихкод КАК Штрихкод,
	|	&РежимПоставщика КАК РежимПоставщика,
	|	&РежимПокупателя КАК РежимПокупателя
	|ИЗ
	|	ВтНоменклатура КАК ВтНоменклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
	|		ПО (ШтрихкодыНоменклатуры.Номенклатура = ВтНоменклатура.Номенклатура)
	|			И (ШтрихкодыНоменклатуры.Характеристика = ВтНоменклатура.Характеристика)
	|			И (ШтрихкодыНоменклатуры.Упаковка = ВтНоменклатура.ЕдиницаИзмерения
	|				ИЛИ ШтрихкодыНоменклатуры.Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка))
	|ГДЕ
	|	ПОДСТРОКА(ШтрихкодыНоменклатуры.Штрихкод, 1, 1) <> ""2""";
	
	Запрос.УстановитьПараметр("Организации",     Организации);
	Запрос.УстановитьПараметр("НачалоПериода", 	 НачалоДня(ДобавитьМесяц(ТекущаяДатаСеанса(), -6)));
	Запрос.УстановитьПараметр("РежимПоставщика", РежимПоставщика);
	Запрос.УстановитьПараметр("РежимПокупателя", РежимПокупателя);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		ЗаполнитьЗначенияСвойств(Штрихкоды.Добавить(), Выборка);
	КонецЦикла;
	
КонецПроцедуры
// Конец ЭлектронноеВзаимодействие.ТорговыеПредложения

// Функция определяет ведутся взаиморасчеты в иностранной валюте или в национальной
//
// Параметры:
//		ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов объекта.
//		ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - Валюта регламентированного учета.
//
// Возвращаемое значение:
//		Булево - Истина, если расчеты в иностранной валюте.
//
Функция ВзаиморасчетыВВалюте(ВалютаВзаиморасчетов, ВалютаРегламентированногоУчета) Экспорт
	
	Возврат ВалютаВзаиморасчетов <> ВалютаРегламентированногоУчета;
	
КонецФункции

// Функция возвращает ссылку на объект расчетов переданной ссылки.
//
// Параметры:
//		ОбъектСсылка - ОпределяемыйТип.ОбъектРасчетов - Документ по которому нужно определить объект расчетов.
//
// Возвращаемое значение:
// 		ОпределяемыйТип.ОбъектРасчетов - Объект расчетов документа..
//
Функция ОбъектРасчетовПоСсылке(ОбъектСсылка) Экспорт
	
	Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ОбъектСсылка, "ПорядокРасчетов") Тогда 
		Порядок = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ОбъектСсылка, "ПорядокРасчетов");
		Если Порядок = Перечисления.ПорядокРасчетов.ПоДоговорамКонтрагентов Тогда
			Если ТипЗнч(ОбъектСсылка) = Тип("СправочникСсылка.ДоговорыКонтрагентов") 
				ИЛИ ТипЗнч(ОбъектСсылка) = Тип("СправочникСсылка.ДоговорыМеждуОрганизациями") Тогда
				Возврат ОбъектСсылка
			Иначе
				Возврат ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ОбъектСсылка, "Договор");
			КонецЕсли;
		ИначеЕсли Порядок = Перечисления.ПорядокРасчетов.ПоЗаказам 
			И ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ОбъектСсылка, "ЗаказКлиента") Тогда
			Заказ = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ОбъектСсылка, "ЗаказКлиента");
			Если ЗначениеЗаполнено(Заказ) Тогда
				Возврат Заказ;
			КонецЕсли;
		ИначеЕсли Порядок = Перечисления.ПорядокРасчетов.ПоЗаказам 
			И ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ОбъектСсылка, "ЗаказПоставщику") Тогда
			Заказ = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ОбъектСсылка, "ЗаказПоставщику");
			Если ЗначениеЗаполнено(Заказ) Тогда
				Возврат Заказ;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Возврат ОбъектСсылка;
	
КонецФункции

// см. ОтчетыУТПереопределяемый.ДополнитьСоответствияРегистраторовОтчетаОДвижениях
//
Процедура ДополнитьСоответствияРегистраторовОтчетаОДвижениях(Документ, СоответствиеРегистров) Экспорт
	
	Если Документ.Метаданные().Движения.Содержит(Метаданные.РегистрыНакопления.РасчетыСКлиентами) Тогда
		СоответствиеРегистров.Вставить(Метаданные.РегистрыНакопления.РасчетыСКлиентамиПоСрокам, "ДокументРегистратор");
		СоответствиеРегистров.Вставить(Метаданные.РегистрыНакопления.РасчетыСКлиентамиПланОплат, "ДокументРегистратор");
		СоответствиеРегистров.Вставить(Метаданные.РегистрыНакопления.РасчетыСКлиентамиПланОтгрузок, "ДокументРегистратор");
	КонецЕсли;
	
	Если Документ.Метаданные().Движения.Содержит(Метаданные.РегистрыНакопления.РасчетыСПоставщиками) Тогда
		СоответствиеРегистров.Вставить(Метаданные.РегистрыНакопления.РасчетыСПоставщикамиПоСрокам, "ДокументРегистратор");
		СоответствиеРегистров.Вставить(Метаданные.РегистрыНакопления.РасчетыСПоставщикамиПланОплат, "ДокументРегистратор");
		СоответствиеРегистров.Вставить(Метаданные.РегистрыНакопления.РасчетыСПоставщикамиПланПоставок, "ДокументРегистратор");
	КонецЕсли;
	
	Если ТипЗнч(Документ) = Тип("ДокументСсылка.РасчетКурсовыхРазниц") Тогда
		СоответствиеРегистров.Вставить(Метаданные.РегистрыНакопления.РасчетыСКлиентамиПоСрокам, "ДокументРегистратор");
		СоответствиеРегистров.Вставить(Метаданные.РегистрыНакопления.РасчетыСПоставщикамиПоСрокам, "ДокументРегистратор");
	КонецЕсли;
	
КонецПроцедуры

// Отложенное обновление регистров взаиморасчетов завершено.
// 
// Параметры:
//  ТолькоФинансовые - Булево - Только финансовые
// 
// Возвращаемое значение:
//  Булево - Отложенное обновление регистров взаиморасчетов завершено
Функция ОтложенноеОбновлениеРегистровВзаиморасчетовЗавершено(ТолькоФинансовые = Ложь) Экспорт
	
	Если ОбновлениеИнформационнойБазы.ОтложенноеОбновлениеЗавершено() Тогда
		Возврат Истина;
	Иначе
		МассивОбъектов = Новый Массив();
		
		Если НЕ ТолькоФинансовые Тогда
			МассивОбъектов.Добавить(Метаданные.РегистрыНакопления.РасчетыСКлиентами);
			МассивОбъектов.Добавить(Метаданные.РегистрыНакопления.РасчетыСПоставщиками);
		КонецЕсли;
		
		Если Константы.НоваяАрхитектураВзаиморасчетов.Получить() Тогда
			МассивОбъектов.Добавить(Метаданные.РегистрыНакопления.РасчетыСКлиентамиПоСрокам);
			МассивОбъектов.Добавить(Метаданные.РегистрыНакопления.РасчетыСПоставщикамиПоСрокам);
			Если НЕ ТолькоФинансовые Тогда
				МассивОбъектов.Добавить(Метаданные.РегистрыНакопления.РасчетыСКлиентамиПланОплат);
				МассивОбъектов.Добавить(Метаданные.РегистрыНакопления.РасчетыСКлиентамиПланОтгрузок);
				МассивОбъектов.Добавить(Метаданные.РегистрыНакопления.РасчетыСПоставщикамиПланОплат);
				МассивОбъектов.Добавить(Метаданные.РегистрыНакопления.РасчетыСПоставщикамиПланПоставок);
			КонецЕсли;
		Иначе
			МассивОбъектов.Добавить(Метаданные.РегистрыНакопления.РасчетыСКлиентамиПоДокументам);
			МассивОбъектов.Добавить(Метаданные.РегистрыНакопления.РасчетыСПоставщикамиПоДокументам);
		КонецЕсли;
		
		Для Каждого ОбъектМетаданных Из МассивОбъектов Цикл
			Если НЕ ОбновлениеИнформационнойБазы.ОбработкаДанныхЗавершена(Неопределено, ОбъектМетаданных) Тогда
				Возврат Ложь;
			КонецЕсли;
		КонецЦикла;
		
		Возврат Истина;
	КонецЕсли;
	
КонецФункции

//++ Локализация

// Обработка обновления статуса Сверки взаиморасчетов (2.5.11) при записи регистра сведения Состояния по объектам учета ЭДО.
// Выполняется по подписке на событие ПриЗаписи.
// См. Подписку на событие ПриЗаписиСостоянияПоОбъектамУчетаЭДО.
// 
// Параметры:
//  Источник - РегистрСведенийНаборЗаписей.СостоянияПоОбъектамУчетаЭДО - Набор записей регистра сведений
//  Отказ - Булево - Признак отказа от записи
//  Замещение - Булево - Замещение
Процедура ОбновитьСтатусСверкиВзаиморасчетовПриЗаписиСостоянияПоОбъектамУчетаЭДОПриЗаписи(Источник, Отказ, Замещение) Экспорт
	
	Если Источник.ОбменДанными.Загрузка Тогда 
		Возврат;
	КонецЕсли;
	
	Для Каждого Запись Из Источник Цикл  
		Если ТипЗнч(Запись.СсылкаНаОбъект) = Тип("ДокументСсылка.СверкаВзаиморасчетов2_5_11") Тогда
			
			СостояниеЭДО = Запись.СостояниеЭДО;
			Статус = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Запись.СсылкаНаОбъект, "Статус");
			НовыйСтатус = "";
			
			Если (СостояниеЭДО = Перечисления.СостоянияДокументовЭДО.ОжидаетсяПередачаОператору
				Или СостояниеЭДО = Перечисления.СостоянияДокументовЭДО.ОжидаетсяПодтверждениеОператора)
				И Статус = Перечисления.СтатусыСверокВзаиморасчетов2_5_11.Создана Тогда
					
					НовыйСтатус = "НаСверке";
					
			ИначеЕсли (СостояниеЭДО = Перечисления.СостоянияДокументовЭДО.Аннулирован
				Или СостояниеЭДО = Перечисления.СостоянияДокументовЭДО.ТребуетсяПодтверждениеАннулирования
				Или СостояниеЭДО = Перечисления.СостоянияДокументовЭДО.ЗакрытПринудительно
				Или СостояниеЭДО = Перечисления.СостоянияДокументовЭДО.ТребуетсяОтправкаОтклонения
				Или СостояниеЭДО = Перечисления.СостоянияДокументовЭДО.ТребуетсяУточнение)
				И Не Статус = Перечисления.СтатусыСверокВзаиморасчетов2_5_11.Отклонена Тогда
					
					НовыйСтатус = "Отклонена";
					
			КонецЕсли;
			
			Если ЗначениеЗаполнено(НовыйСтатус) Тогда
				МассивДокументов = Новый Массив;
				МассивДокументов.Добавить(Запись.СсылкаНаОбъект);
				ОбщегоНазначенияУТВызовСервера.УстановитьСтатусДокументов(МассивДокументов, НовыйСтатус);
			КонецЕсли;
			
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры
//-- Локализация

// Возвращает текст запроса формирования временной таблицы оплаты партий.
//
// Параметры:
//  ИмяТаблицыВходныхДанные - Строка - Имя таблицы входных данных. Таблица должна содержать колонку Партия.
//  ИмяТаблицыОплат - Строка - Имя результирующей таблицы оплат
//
// Возвращаемое значение:
// 	Строка - Текст запроса, формирующий временную таблицу оплат партий. Таблица содержит колонки: Партия, ДокументОплаты, ДатаОплаты, СуммаОплаты.
// 			
Функция ТекстЗапросаТаблицыДанныхОплатыПартий(ИмяТаблицыВходныхДанные, ИмяТаблицыОплат) Экспорт
	
	ТекстЗапроса = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	РасчетыСПоставщиками.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	РасчетыСПоставщиками.ОбъектРасчетов КАК ОбъектРасчетов,
	|	РасчетыСПоставщиками.Регистратор КАК Партия
	|ПОМЕСТИТЬ ВтОтборРасчетов
	|ИЗ
	|	РегистрНакопления.РасчетыСПоставщиками КАК РасчетыСПоставщиками
	|ГДЕ
	|	РасчетыСПоставщиками.Регистратор В
	|			(ВЫБРАТЬ
	|				Т.Партия
	|			ИЗ
	|				#ИмяТаблицыВходныхДанные КАК Т)
	|	И РасчетыСПоставщиками.АналитикаУчетаПоПартнерам.Организация В (&СписокОрганизаций)
	|	И РасчетыСПоставщиками.Активность
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаПоПартнерам,
	|	ОбъектРасчетов,
	|	Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РасчетыПоСрокам.РасчетныйДокумент   КАК РасчетныйДокумент,
	|	РасчетыПоСрокам.ОбъектРасчетов      КАК ОбъектРасчетов,
	|	РасчетыПоСрокам.ДокументРегистратор КАК ДокументОплаты,
	|	СУММА(&Оплачено)                    КАК Оплачено,
	|	0                                   КАК Зачтено
	|ПОМЕСТИТЬ ВтРасчетыПоСрокам
	|ИЗ
	|	РегистрНакопления.РасчетыСПоставщикамиПоСрокам КАК РасчетыПоСрокам
	|ГДЕ
	|	(РасчетыПоСрокам.АналитикаУчетаПоПартнерам, 
	|	 РасчетыПоСрокам.ОбъектРасчетов, 
	|	 РасчетыПоСрокам.РасчетныйДокумент) В
	|			(ВЫБРАТЬ
	|				Т.АналитикаУчетаПоПартнерам,
	|				Т.ОбъектРасчетов,
	|				Т.Партия
	|			ИЗ
	|				ВтОтборРасчетов КАК Т)
	|	И РасчетыПоСрокам.Активность
	|	И РасчетыПоСрокам.Период <= &КонецМесяца
	|
	|СГРУППИРОВАТЬ ПО
	|	РасчетыПоСрокам.ДокументРегистратор,
	|	РасчетыПоСрокам.ОбъектРасчетов,
	|	РасчетыПоСрокам.РасчетныйДокумент
	|
	|ИМЕЮЩИЕ
	|	СУММА(&Оплачено) <> 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	РасчетыПоСрокам.РасчетныйДокумент    КАК РасчетныйДокумент,
	|	РасчетыПоСрокам.ОбъектРасчетов       КАК ОбъектРасчетов,
	|	РасчетыПоСрокамКор.РасчетныйДокумент КАК ДокументОплаты,
	|	СУММА(0)                             КАК Оплачено,
	|	СУММА(&Зачтено)                      КАК Зачтено
	|ИЗ
	|	РегистрНакопления.РасчетыСПоставщикамиПоСрокам КАК РасчетыПоСрокам
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСПоставщикамиПоСрокам КАК РасчетыПоСрокамКор
	|		ПО РасчетыПоСрокам.АналитикаУчетаПоПартнерам = РасчетыПоСрокамКор.АналитикаУчетаПоПартнерам
	|			И РасчетыПоСрокам.Валюта = РасчетыПоСрокамКор.Валюта
	|			И РасчетыПоСрокам.НастройкаХозяйственнойОперации = РасчетыПоСрокамКор.НастройкаХозяйственнойОперации
	|			И РасчетыПоСрокам.ИдентификаторФинЗаписи = РасчетыПоСрокамКор.ИдентификаторФинЗаписи
	|			И РасчетыПоСрокам.РасчетныйДокумент <> РасчетыПоСрокамКор.РасчетныйДокумент
	|ГДЕ
	|	(РасчетыПоСрокам.АналитикаУчетаПоПартнерам, 
	|	 РасчетыПоСрокам.ОбъектРасчетов, 
	|	 РасчетыПоСрокам.РасчетныйДокумент) В
	|			(ВЫБРАТЬ
	|				Т.АналитикаУчетаПоПартнерам,
	|				Т.ОбъектРасчетов,
	|				Т.Партия
	|			ИЗ
	|				ВтОтборРасчетов КАК Т)
	|	И РасчетыПоСрокам.Активность
	|	И РасчетыПоСрокам.Период <= &КонецМесяца
	|
	|СГРУППИРОВАТЬ ПО
	|	РасчетыПоСрокам.РасчетныйДокумент,
	|	РасчетыПоСрокам.ОбъектРасчетов,
	|	РасчетыПоСрокамКор.РасчетныйДокумент
	|
	|ИМЕЮЩИЕ
	|	СУММА(&Зачтено) <> 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	РасчетыПоСрокам.РасчетныйДокумент    КАК РасчетныйДокумент,
	|	РасчетыПоСрокам.ОбъектРасчетов       КАК ОбъектРасчетов,
	|	РасчетыПоСрокамКор.ДокументРегистратор КАК ДокументОплаты,
	|	СУММА(0)                             КАК Оплачено,
	|	СУММА(&Зачтено)                      КАК Зачтено
	|ИЗ
	|	РегистрНакопления.РасчетыСПоставщикамиПоСрокам КАК РасчетыПоСрокам
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСПоставщикамиПоСрокам КАК РасчетыПоСрокамКор
	|		ПО РасчетыПоСрокам.АналитикаУчетаПоПартнерам = РасчетыПоСрокамКор.АналитикаУчетаПоПартнерам
	|			И РасчетыПоСрокам.Валюта = РасчетыПоСрокамКор.Валюта
	|			И РасчетыПоСрокам.НастройкаХозяйственнойОперации = РасчетыПоСрокамКор.НастройкаХозяйственнойОперации
	|			И РасчетыПоСрокам.ИдентификаторФинЗаписи = РасчетыПоСрокамКор.ИдентификаторФинЗаписи
	|			И РасчетыПоСрокам.РасчетныйДокумент = РасчетыПоСрокамКор.РасчетныйДокумент
	|			И ТИПЗНАЧЕНИЯ(РасчетыПоСрокамКор.ДокументРегистратор) = ТИП(Документ.ВзаимозачетЗадолженности)
	|ГДЕ
	|	(РасчетыПоСрокам.АналитикаУчетаПоПартнерам, 
	|	 РасчетыПоСрокам.ОбъектРасчетов, 
	|	 РасчетыПоСрокам.РасчетныйДокумент) В
	|			(ВЫБРАТЬ
	|				Т.АналитикаУчетаПоПартнерам,
	|				Т.ОбъектРасчетов,
	|				Т.Партия
	|			ИЗ
	|				ВтОтборРасчетов КАК Т)
	|	И РасчетыПоСрокам.Активность
	|	И РасчетыПоСрокам.Период <= &КонецМесяца
	|
	|СГРУППИРОВАТЬ ПО
	|	РасчетыПоСрокам.РасчетныйДокумент,
	|	РасчетыПоСрокам.ОбъектРасчетов,
	|	РасчетыПоСрокамКор.ДокументРегистратор
	|
	|ИМЕЮЩИЕ
	|	СУММА(&Зачтено) <> 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументОплаты,
	|	ОбъектРасчетов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РасчетыПоСрокам.ДокументОплаты КАК ДокументОплаты,
	|	РасчетыПоСрокам.ОбъектРасчетов КАК ОбъектРасчетов,
	|	СУММА(ЕСТЬNULL(СуммыДокументовВВалютахУчета.СуммаБезНДСРегл, СуммыДокументовВВалютахУчетаСводно.СуммаБезНДСРегл)) КАК СуммаБезНДС,
	|	СУММА(ЕСТЬNULL(СуммыДокументовВВалютахУчета.СуммаНДСРегл, СуммыДокументовВВалютахУчетаСводно.СуммаНДСРегл)) КАК СуммаНДС
	|ПОМЕСТИТЬ ВтСуммыДокументовОплаты
	|ИЗ
	|	ВтРасчетыПоСрокам КАК РасчетыПоСрокам
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СуммыДокументовВВалютахУчета КАК СуммыДокументовВВалютахУчета
	|		ПО РасчетыПоСрокам.ДокументОплаты = СуммыДокументовВВалютахУчета.Регистратор
	|			И РасчетыПоСрокам.ОбъектРасчетов = СуммыДокументовВВалютахУчета.ОбъектРасчетов
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СуммыДокументовВВалютахУчета КАК СуммыДокументовВВалютахУчетаСводно
	|		ПО РасчетыПоСрокам.ДокументОплаты = СуммыДокументовВВалютахУчетаСводно.Регистратор
	|
	|СГРУППИРОВАТЬ ПО
	|	РасчетыПоСрокам.ДокументОплаты,
	|	РасчетыПоСрокам.ОбъектРасчетов
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументОплаты,
	|	ОбъектРасчетов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РасчетыПоСрокам.РасчетныйДокумент КАК РасчетныйДокумент,
	|	РасчетыПоСрокам.ДокументОплаты КАК ДокументОплаты,
	|	СУММА((РасчетыПоСрокам.Оплачено + РасчетыПоСрокам.Зачтено) 
	|		* ЕСТЬNULL(СуммыДокументовОплаты.СуммаБезНДС, 0)
	|		/ (ВЫБОР 
	|				КОГДА ЕСТЬNULL((СуммыДокументовОплаты.СуммаБезНДС + СуммыДокументовОплаты.СуммаНДС), 0) <> 0
	|					ТОГДА (СуммыДокументовОплаты.СуммаБезНДС + СуммыДокументовОплаты.СуммаНДС)
	|					ИНАЧЕ 1 
	|				КОНЕЦ)) КАК СуммаОплатыБезНДС
	|ПОМЕСТИТЬ ВтОплатыРасчетныхДокументов
	|ИЗ
	|	ВтРасчетыПоСрокам КАК РасчетыПоСрокам
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ВтСуммыДокументовОплаты КАК СуммыДокументовОплаты
	|	ПО
	|		РасчетыПоСрокам.ДокументОплаты = СуммыДокументовОплаты.ДокументОплаты
	|		И РасчетыПоСрокам.ОбъектРасчетов = СуммыДокументовОплаты.ОбъектРасчетов
	|
	|СГРУППИРОВАТЬ ПО
	|	РасчетыПоСрокам.РасчетныйДокумент,
	|	РасчетыПоСрокам.ДокументОплаты
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВтВходныеДанные.Партия КАК Партия,
	|	ЕСТЬNULL(ОплатыРасчетныхДокументов.ДокументОплаты, НЕОПРЕДЕЛЕНО) КАК ДокументОплаты,
	|	ЕСТЬNULL(НАЧАЛОПЕРИОДА(РеестрДокументов.ДатаДокументаИБ, ДЕНЬ), ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаОплаты,
	|	ЕСТЬNULL(ОплатыРасчетныхДокументов.СуммаОплатыБезНДС, 0) КАК СуммаОплаты
	|ПОМЕСТИТЬ #ИмяТаблицыОплат
	|ИЗ
	|	#ИмяТаблицыВходныхДанные КАК ВтВходныеДанные
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВтОплатыРасчетныхДокументов КАК ОплатыРасчетныхДокументов
	|		ПО ВтВходныеДанные.Партия = ОплатыРасчетныхДокументов.РасчетныйДокумент
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РеестрДокументов КАК РеестрДокументов
	|		ПО ОплатыРасчетныхДокументов.ДокументОплаты = РеестрДокументов.Ссылка
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВтОтборРасчетов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВтРасчетыПоСрокам
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВтСуммыДокументовОплаты
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВтОплатыРасчетныхДокументов
	|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "#ИмяТаблицыВходныхДанные", ИмяТаблицыВходныхДанные);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "#ИмяТаблицыОплат", ИмяТаблицыОплат);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&Оплачено", ШаблонПоляОплаченоПоставщику());
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&Зачтено", ШаблонПоляЗачтеноПоставщиком());
	// Получаем данные в валюте:
	//  4 - взаиморасчетов
	//  2 - управленческого учета
	//  3 - регламентированного учета
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ДанныеОтчета", "3");
	
	Возврат ТекстЗапроса;

КонецФункции

#КонецОбласти

#Область ФормированиеЗаданийКЗакрытиюМесяца

// Дополняет текст запроса механизма формирования заданий закрытия месяца.
// 
// Параметры:
// 	Запрос - Запрос - используется для установки параметров запроса.
// 	ТекстЗапроса - Строка - строка с текстом запроса.
// 	ТекстЗапросаВременныхТаблиц - Строка - строка с текстом запроса временных таблиц.
// 	ИменаВременныхТаблиц - Строка - массив имен создаваемых временных таблиц для последующего уничтожения.
Процедура ДополнитьТекстЗапросаЗаданийКЗакрытиюМесяца(Запрос, ТекстЗапроса, ТекстЗапросаВременныхТаблиц, ИменаВременныхТаблиц) Экспорт
	
	СоответствиеЗапросов = СоответствиеЗапросовКонтрольнымРегистрам(Запрос);
	
	Для Каждого ЭлементСоответствия Из СоответствиеЗапросов Цикл
		ЗакрытиеМесяцаСервер.ДополнитьНазванияТаблицДляЗаданий(Запрос, ЭлементСоответствия.Ключ);
		ЗакрытиеМесяцаСервер.ДополнитьТекстЗапросаЗаданий(ЭлементСоответствия.Ключ,
			ЭлементСоответствия.Значение,
			Запрос.МенеджерВременныхТаблиц.Таблицы,
			ТекстЗапроса,
			ТекстЗапросаВременныхТаблиц,
			ИменаВременныхТаблиц);
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область Модульность

#Область ОбщийПрограммныйИнтерфейс

// Возвращает структуру параметров механизма взаиморасчетов.
// Параметры описываются либо путем к данным объекта, либо фиксированным значением типа Булево, Строка и пр.
// Путь к данным может вести как в шапку документа ("Объект.Организация"), так и в табличную часть ("Объект.РасшифровкаПлатежа.Партнер").
// В одном документе может быть задано несколько структур параметров (пример - ОтчетКомиссионера).
// Для встраивания в документы рекомендуется использовать шаблон в конце метода.
//
// Возвращаемое значение:
// 	Структура - Структура параметров с ключами:
// 		* ЭлементыФормы - Структура - Имена элементов формы, используются для связи элемента с текущими параметрами:
// 			** ЗачетОплаты - Строка - Имя элемента, вызывающего помощник зачета оплат.
// 			** СуммаВзаиморасчетовТЧ - Строка - Имя элемента, отображающего колонку Сумма взаиморасчетов в основной табличной части.
// 			** ГиперссылкаРасшифровкаПлатежа - Строка - Имя элемента, отображающего сумму расшифровки платежа и открывающего ее редактирование.
// 			** РасшифровкаПлатежа - Строка - Имя элемента, отображающего табличную часть Расшифровка платежа на форме.
// 			** ПодборВРасшифровкуПлатежа - Строка - Имя кнопки, вызывающего подбор в расшифровку платежа.
// 			** НадписьВалюты - Строка - Имя гиперссылки, отображающей валюты и курс документа и вызывающего форму их редактирования.
// 			** НадписьЭтапы - Строка - Имя гиперссылки, отображающей график оплаты и открывающий форму редактирования правил оплаты.
// 			** НадписьРасчеты - Строка - Имя гиперссылки, отображающей состояние расчетов и открывающей отчет по взаиморасчетам.
// 			** ОграничениеЗадолженностиТекст - Строка - Имя гиперссылки, отображающей текст ограничения задолженности и открывающей соответствующий отчет.
// 			** ОграничениеЗадолженностиКартинка - Строка - Имя картинки, отображающей восклицательный знак при ограничении задолженности.
// 		* ЭтоЗаказ - Булево - Это документ - заказ, на основании которого будут вводиться накладные.
// 		* ЭтоСправочник - Булево - Это справочник (договоры или претензии).
// 		* ЭтоПродажаЗакупка - Булево - Это документ - накладная.
// 		* ТипРасчетов - ПеречислениеСсылка.ТипыРасчетовСПартнерами - Тип взаиморасчетов.
// 		* ИзменяетПланОплаты - Булево - Уменьшает или увеличивает планы к оплате от клиента или поставщику.
// 		* ИзменяетПланОтгрузкиПоставки - Булево - Уменьшает или увеличивает план отгрузки или поставки.
// 		
// 		* Дата - Строка - Путь к реквизиту объекта, содержащему дату документа.
// 		* ВалютаДокумента - Строка - Путь к реквизиту объекта, содержащему валюту документа.
// 		* СуммаДокумента - Строка - Путь к реквизиту объекта, содержащему сумму документа в валюте документа.
// 		* Организация - Строка- Путь к реквизиту объекта, содержащему организацию, от лица которой производится хозяйственная операция.
// 		* Партнер - Строка - Путь к реквизиту объекта, содержащему партнера, с которым возникают взаиморасчеты у организации.
// 		* Контрагент - Строка - Путь к реквизиту объекта, содержащему контрагента или организацию, с которой возникают взаиморасчеты у организации.
// 		
// 		* ВалютаВзаиморасчетов - Строка - Путь к реквизиту объекта, содержащему валюту, по который ведутся взаиморасчеты организации с контрагентом.
// 		* СуммаВзаиморасчетов - Строка - Путь к реквизиту объекта, содержащему общую сумму взаиморасчетов документа, без учета залога за тару.
// 		* СуммаНДСВзаиморасчетов - Строка - Путь к реквизиту объекта, содержащему сумму НДС в валюте взаиморасчетов.
// 		* СуммаВзаиморасчетовПоТаре - Строка - Путь к реквизиту объекта, содержащему общую сумму залога за тару.
// 		
// 		* Договор - Строка - Путь к реквизиту объекта, содержащему договор организации с контрагентом, в рамках которого возникают взаиморасчеты.
// 		* НаправлениеДеятельности - Строка - Путь к реквизиту объекта, содержащему направление деятельности организации, в рамках которой следует отражать взаиморасчеты.
// 		* ПорядокРасчетов - Строка - Путь к реквизиту объекта, содержащему порядок расчетов документа.
// 		* СуммаДокументаФорма - Строка - Путь к реквизиту формы, содержащему сумму документа с учетом залоговой тары.
// 		
// 		* ПутьКДаннымТЧ - Строка - Путь к реквизиту объекта, содержащему основную табличную часть документа.
// 		* ИмяРеквизитаТЧСуммаСНДС - Строка - Имя реквизита табличной части, содержащего сумму строки с ндс в валюте документа.
// 		* ИмяРеквизитаТЧЗаказ  - Строка - Имя реквизита табличной части, содержащего заказ, по которому производится отгрузка/поставка.
// 		
// 		* ПутьКДаннымТЧРасшифровкаПлатежа - Строка - Путь к реквизиту объекта, содержащему табличную часть "Расшифровка платежа" документа.
// 		* Соглашение - Строка - Путь к реквизиту объекта, содержащему соглашение с клиентом или поставщиком.
// 		* БанковскийСчетОрганизации - Строка - Путь к реквизиту объекта, содержащему банковский счет организации.
// 		* БанковскийСчетКонтрагента - Строка - Путь к реквизиту объекта, содержащему банковский счет контрагента.
// 		* Касса - Строка - Путь к реквизиту объекта, содержащему кассу.
// 		* ФормаОплаты - Строка - Путь к реквизиту объекта, содержащему форму оплаты.
// 		* ОплатаВВалюте - Строка - Путь к реквизиту объекта, содержащему признак "Оплата в валюте".
// 		* ИдентификаторПлатежа - Строка - Путь к реквизиту объекта, содержащему идентификатор платежа.
// 		* ГруппаФинансовогоУчета - Строка - Путь к реквизиту объекта, содержащему группу финансового учета расчетов.
// 		* ОбъектРасчетов - Строка - Пусть к реквизиту объекта или колонке ТЧ, хранящей ссылку /ссылки на справочник Объекты расчетов.
// 		* Ссылка - Строка - Пусть к реквизиту Ссылка, которая будет являться объектом расчетов при расчетах по накладным.
// 		* Подразделение - Строка - Путь к реквизиту объекта, содержащему подразделение.
// 		* Менеджер - Строка - Путь к реквизиту объекта, содержащему ответственного менеджера.
// 		* НомерВходящегоДокумента - Строка - Путь к реквизиту объекта, содержащему номер входящего документа.
// 		* ДатаВходящегоДокумента - Строка - Путь к реквизиту объекта, содержащему дату входящего документа.
// 		* НаименованиеПервичногоДокумента - Строка - Путь к реквизиту объекта, содержащему наименование первичного документа.
// 		
// 		* НакладнаяПоЗаказам - Строка - Путь к реквизиту объекта, содержащему признак того, что документ введен по заказу.
// 		* ЗаказОснование - Строка - Путь к реквизиту объекта, содержащему заказ, по которому введен документ.
// 		* ПартнерПрочиеОтношения - Булево - Истина, если подбирать следует только по партнерам с признаком "Прочие отношения".
// 		* ПодборДебиторскойЗадолженности - Булево - Истина, если подбирается дебиторская задолженность.
// 		* ПодборТолькоБезусловнойЗадолженности - Булево - Истина, если подбирается только фактическая задолженность.
// 		
// 		* КурсЧислитель - Строка - Путь к реквизиту объекта, содержащему курс-числитель валюты документа относительно валюты взаиморасчетов.
// 		* КурсЗнаменатель - Строка - Путь к реквизиту объекта, содержащему курс-знаменатель валюты документа относительно валюты взаиморасчетов.
// 		* ВалютыИКурсДокументаТолькоПросмотр - Булево - Истина, если в форме редактирования валют и курсов документа ничего нельзя менять.
// 		* ВалютаДокументаТолькоПросмотр - Булево - Истина, если в форме редактирования валют и курсов документа нельзя менять валюту документа.
// 		* ВалютаВзаиморасчетовТолькоПросмотр - Булево - Истина, если в форме редактирования валют и курсов документа  нельзя менять валюту взаиморасчетов.
// 		* НеПоказыватьРасчеты - Булево - Истина, если в форме редактирования валют и курсов документа нужно скрыть валюту и сумму взаиморасчетов.
// 		* НеПересчитыватьСуммуДокумента - Булево - Истина, если в форме редактирования валют и курсов документа не нужно предлагать пересчитывать сумму документа.
// 		
// 		* ПутьКДаннымТЧЭтапыОплаты - Строка - Путь к реквизиту объекта, содержащему табличную часть этапов графика оплаты.
// 		* ДатаПлатежа - Строка - Путь к реквизиту объекта, содержащему дату планового платежа по документу.
// 		* ГрафикОплаты - Строка - Путь к реквизиту объекта, содержащему шаблон графика оплаты документа.
// 		* ДатаСогласования - Строка - Путь к реквизиту объекта, содержащему дату, от которой следует считать этапы графика оплаты с отсчетом от даты согласования.
// 		* ДатаОтгрузки - Строка - Путь к реквизиту объекта, содержащему дату, от которой следует считать этапы графика оплаты с отсчетом от/до даты отгрузки и от даты перехода права собственности.
// 		
// 		* СуммаЗалогаЗаТаруФорма - Строка - Путь к реквизиту формы, содержащему сумму залога за тару в валюте документа.
// 		* ЭтапыОплатыТолькоПросмотр - Булево - Признак Только просмотр для открываемой формы редактирования правил оплаты.
// 		* ВозможнаНакладнаяПоНесколькимЗаказам - Булево - Истина, если накладная может быть введена по нескольким заказам.
// 		* ИсточникСуммТабличнаяЧасть - Булево - Истина, если объект предоставляет интерфейс ПоместитьСуммыПоЗаказамВоВременноеХранилище() для сложного расчета сумм документа
// 		
// 		* ДоговорКомиссионера - Строка - Путь к реквизиту объекта, содержащему договор с комиссионероом для определения реквизитов ГФУ, ПорядокРасчетов, ВалютаВзаиморасчетов, ОплатаВВалюте при учете продаж.
// 		* ВестиРасчетыЧерезКонечныхПокупателей - Булево - Признак, что взаиморасчеты по комиссионным продажам идут через конечного покупателя.
//
Функция ПараметрыМеханизма() Экспорт
	
	СтруктураПараметров = Новый Структура;
	
	//Имена элементов форм для текущего набора параметров
	ЭлементыФормы = Новый Структура();
	
	#Область ОбязательныеПараметры
	
	//Если все опции ложь, то это платеж или служебный документ.
	СтруктураПараметров.Вставить("ЭтоЗаказ",                         Ложь);
	СтруктураПараметров.Вставить("ЭтоСправочник",                    Ложь);
	СтруктураПараметров.Вставить("ЭтоПродажаЗакупка",                Ложь);
	
	//Определяет какой регистр двигают параметры, какие общие формы, перечисления и справочники использовать.
	СтруктураПараметров.Вставить("ТипРасчетов",                      Перечисления.ТипыРасчетовСПартнерами.ПустаяСсылка());
	СтруктураПараметров.Вставить("Организация",                      "Объект.Организация");
	
	// При определенных значениях реквизитов документа он может не изменять взаиморасчеты в части оплат или отгрузок.
	// Пример - Передача товара на комиссию.
	//
	// Если оба флага отрицательны, то скрывается гиперссылка "Расчеты", очищаются суммы взаиморасчеты и табличные части механизма.
	// При отрицательном значении будут скрыты кнопки ЗачетОплаты и ЭтапыОплаты, но можно будет менять валюты и курс.
	СтруктураПараметров.Вставить("ИзменяетПланОплаты",               Истина);
	СтруктураПараметров.Вставить("ИзменяетПланОтгрузкиПоставки",     Истина);
	
	// Дата отражения документа в системе.
	// Используется для получения остатков просроченной задолженности для функции ограничения задолженности.
	// Используется для получения курсов валют документа. 
	// Используется для заполнения этапов оплаты и расшифровки платежа по умолчанию.
	СтруктураПараметров.Вставить("Дата",                             "Объект.Дата");
	// Системный номер объекта
	СтруктураПараметров.Вставить("Номер",                            "Объект.Номер");
	
	// Валюта и сумма операции. Обязательно путь к реквизитам объекта.
	СтруктураПараметров.Вставить("ВалютаДокумента",                  "Объект.Валюта");
	СтруктураПараметров.Вставить("СуммаДокумента",                   "Объект.СуммаДокумента");
	
	// Используются для генерации объектов расчетов и аналитики.
	СтруктураПараметров.Вставить("Партнер",                          "Объект.Партнер");
	СтруктураПараметров.Вставить("Контрагент",                       "Объект.Контрагент");
	
	//При изменении этих реквизитов объекта парамтеры механизма будут перекэшированы.
	СтруктураПараметров.Вставить("ВлияющиеРеквизиты",                "");
	
	#КонецОбласти
	
	#Область НеобязательныеПараметры
	
	// Отличные от валюты и суммы документа реквизиты. Если не заполнен, то для чтения будет взята валюта документа.
	СтруктураПараметров.Вставить("ВалютаВзаиморасчетов",             "");
	СтруктураПараметров.Вставить("СуммаВзаиморасчетов",              "");
	СтруктураПараметров.Вставить("СуммаНДСВзаиморасчетов",              "");
	СтруктураПараметров.Вставить("СуммаВзаиморасчетовПоТаре",        "");
	
	// Используется для генерации аналитики проведения и объекта расчетов, определения графика исполнения договора.
	СтруктураПараметров.Вставить("Договор",                          "Объект.Договор");
	// Используется для получения реквизитов ГФУ, ПорядокРасчетов, ВалютаВзаиморасчетов, ОплатаВВалюте при учете продаж конечным покупателям.
	СтруктураПараметров.Вставить("ДоговорКомиссионера",              "");
	СтруктураПараметров.Вставить("ВестиРасчетыЧерезКонечныхПокупателей", Ложь);
	
	// Используется для генерации аналитики проведения и объекта расчетов.
	СтруктураПараметров.Вставить("НаправлениеДеятельности",          "Объект.НаправлениеДеятельности");
	
	// Порядок расчетов документа.
	СтруктураПараметров.Вставить("ПорядокРасчетов",                  "Объект.ПорядокРасчетов");
	СтруктураПараметров.Вставить("УсловныйПорядокРасчетов",          "");
	
	// Сумма всего с залоговой тарой. Путь к итоговому показателю формы (реквизиту).
	// Используется для отображения гиперссылок, редактирования и заполнения графика плановых оплат
	// редактирования расшифровки платежа и т.д.
	СтруктураПараметров.Вставить("СуммаДокументаФорма",              ""); 
	
	// Реквизит формы итоговых показателей, содержащий сумму залога за тару в валюте документа.
	// Используется в заполнении этапов графика оплаты.
	СтруктураПараметров.Вставить("СуммаЗалогаЗаТаруФорма",               "");
	
	// Табличная часть, по которой распределяется сумма взаиморасчетов, сумма залога за тару или разбивка накладной по заказам.
	// Используется для отображения гиперссылок, редактирования и заполнения графика плановых оплат
	// редактирования расшифровки платежа, если не заполнен параметр СуммаДокументаФорма.
	// В ТЧ заполняются объекты расчетов по заказам.
	СтруктураПараметров.Вставить("ПутьКДаннымТЧ",                    "");
	// Имя реквизита суммы с ндс табличной части.
	СтруктураПараметров.Вставить("ИмяРеквизитаТЧСуммаСНДС",          "СуммаСНДС");
	// Имя реквизита тч, содержащего заказ.
	СтруктураПараметров.Вставить("ИмяРеквизитаТЧЗаказ",              "");
	
	// Путь к табличной части Расшифровка платежа.
	// Используется в функция зачета оплат, распределения взаиморасчетов, распределения оплаты.
	СтруктураПараметров.Вставить("ПутьКДаннымТЧРасшифровкаПлатежа",  "");
	
	// Используется для заполнения значений по умолчанию, заполнения графика плановых оплат и даты платежа.
	СтруктураПараметров.Вставить("Соглашение",                       "Объект.Соглашение");
	
	// Используются для определения значения ОплатаВВалюте и в форме редактирования правил оплаты.
	СтруктураПараметров.Вставить("БанковскийСчетОрганизации",        "Объект.БанковскийСчетОрганизации");
	СтруктураПараметров.Вставить("БанковскийСчетКонтрагента",        "Объект.БанковскийСчетКонтрагента");
	СтруктураПараметров.Вставить("Касса",                            "Объект.Касса");
	СтруктураПараметров.Вставить("ФормаОплаты",                      "Объект.ФормаОплаты");
	СтруктураПараметров.Вставить("ОплатаВВалюте",                    "Объект.ОплатаВВалюте");
	// Используется в форме правил оплаты и для подбора в расшифровку платежа объектов расчетов.
	СтруктураПараметров.Вставить("ИдентификаторПлатежа",             "Объект.ИдентификаторПлатежа");
	СтруктураПараметров.Вставить("НалогообложениеНДС",               "Объект.НалогообложениеНДС");
	
	// Реквизиты для объекта расчетов, используются в проведении.
	СтруктураПараметров.Вставить("ГруппаФинансовогоУчета",           "Объект.ГруппаФинансовогоУчета");
	СтруктураПараметров.Вставить("Подразделение",                    "Объект.Подразделение");
	СтруктураПараметров.Вставить("Менеджер",                         "");
	СтруктураПараметров.Вставить("НомерВходящегоДокумента",          "");
	СтруктураПараметров.Вставить("ДатаВходящегоДокумента",           "");
	СтруктураПараметров.Вставить("НаименованиеПервичногоДокумента",  "");
		
	// Используется для определения объекта расчетов.
	СтруктураПараметров.Вставить("НакладнаяПоЗаказам",               "");
	
	// Заказ основание из шапки.
	// Используется при определении порядка расчетов по умолчанию и списка доступных порядков для выбора.
	// Используется для определения объекта расчетов.
	СтруктураПараметров.Вставить("ЗаказОснование",                   ""); 
	
	// Имя кнопки, открывающей помощник зачета оплат для текущего набора параметров.
	ЭлементыФормы.Вставить("ЗачетОплаты",                      "");
	// Имя элемента таблицы формы, отображающей сумму взаиморасчетов.
	// Используется для установки условного оформления.
	// Следует заполнить если документ поддерживает построчное ручное редактирование сумм взаиморасчетов.
	ЭлементыФормы.Вставить("СуммаВзаиморасчетовТЧ",            "");
	
	// Имя элемента формы содержащего группу финансового учета для отражения текущего набора параметров по БУ.
	ЭлементыФормы.Вставить("ГруппаФинансовогоУчета",           "");
	ЭлементыФормы.Вставить("НаправлениеДеятельности",          "");
	
	// Место хранения ссылки/ссылок на справочник Объекты расчетов. Может быть в шапке или в табличной части.
	СтруктураПараметров.Вставить("ОбъектРасчетов",             "");
	
	СтруктураПараметров.Вставить("Ссылка",                     "Объект.Ссылка");
	
	// Расчет сумм документа через алгоритм модуля объекта документа
	СтруктураПараметров.Вставить("ИсточникСуммТабличнаяЧасть", Ложь);
	
	#КонецОбласти
	
	#Область РедактированиеРасшифровкиПлатежа
	
	// Если расшифровка редактируется в общей форме, используется в Зачете возвратов товаров.
	ЭлементыФормы.Вставить("ГиперссылкаРасшифровкаПлатежа",    "");
	
	// Если расшифровка редактируется в документе.
	// Используется в распределении оплаты.
	СтруктураПараметров.Вставить("ПлатежиПо275ФЗ",             "");
	ЭлементыФормы.Вставить("РасшифровкаПлатежа",               "");
	ЭлементыФормы.Вставить("ПодборВРасшифровкуПлатежа",        "");
	
	// Настройки подбора и выбора в ТЧ Расшифровка платежа
	
	// Для подбора остатков расчетов по партнерам с типом расчетов Прочие отношения, без отбора по партнеру.
	СтруктураПараметров.Вставить("ПартнерПрочиеОтношения",               Ложь); 
	СтруктураПараметров.Вставить("ПодборДебиторскойЗадолженности",       Ложь);
	СтруктураПараметров.Вставить("ПодборТолькоБезусловнойЗадолженности", Ложь);
	
	#КонецОбласти
	
	#Область РедактированиеВалютИВалютныхСуммДокумента
	
	// Курс документа - одна пара для документа.
	// Используются для расчета суммы взаиморасчетов и в форме редактирования валют и курсов документа.
	СтруктураПараметров.Вставить("КурсЧислитель",                           "");
	СтруктураПараметров.Вставить("КурсЗнаменатель",                         "");
	
	// Имя гиперссылки, отображающей текущий курс взаиморасчетов документа и открывающей соответствующую форму.
	ЭлементыФормы.Вставить("НадписьВалюты",                    "");
	
	// Используется, когда в вызывающей форме не стоит флаг ТолькоПросмотр, но ограничить редактирование валют нужно.
	СтруктураПараметров.Вставить("ВалютыИКурсДокументаТолькоПросмотр", Ложь);
	
	// Используются в условии через ИЛИ с правом отклонения от условий продаж/закупок.
	СтруктураПараметров.Вставить("ВалютаДокументаТолькоПросмотр",      Ложь);
	СтруктураПараметров.Вставить("ВалютаВзаиморасчетовТолькоПросмотр", Ложь);
	
	// Если не следует показывать сумму и валюту взаиморасчетов исходя из данных документа.
	СтруктураПараметров.Вставить("НеПоказыватьРасчеты",                Ложь);
	// Если не требуется предлагать пересчет суммы документа.
	СтруктураПараметров.Вставить("НеПересчитыватьСуммуДокумента",      Ложь);
	
	#КонецОбласти
	
	#Область ГрафикПлановойОплатыИДатаПлатежа
	
	// Функция Этапы оплаты и дата платежа
	СтруктураПараметров.Вставить("ПутьКДаннымТЧЭтапыОплаты",           "");
	СтруктураПараметров.Вставить("ДатаПлатежа",                        "");
	СтруктураПараметров.Вставить("ГрафикОплаты",                       "");
	СтруктураПараметров.Вставить("ДатаСогласования",                   "");
	СтруктураПараметров.Вставить("ДатаОтгрузки",                       "Объект.Дата");
	СтруктураПараметров.Вставить("ДатаПереходаПраваСобственности",     "");
	СтруктураПараметров.Вставить("НетКонтроляПредоплаты",              Ложь);
	СтруктураПараметров.Вставить("ЕстьДатаПереходаПраваСобственности", Ложь);
	СтруктураПараметров.Вставить("ОтгружатьОднойДатой",                "");
	
	// Имя гиперссылки, отображающей текущие правила оплаты документа и открывающей форму Правила оплаты.
	ЭлементыФормы.Вставить("НадписьЭтапы",                     "");
	// Путь к реквизиту формы отображаемому в поле надписи -гиперссылке
	СтруктураПараметров.Вставить("НадписьЭтапыОплаты",                  "");
	// Поле ввода порядка оплаты
	ЭлементыФормы.Вставить("ПорядокРасчетов",                  "");
	
	// Если требуется ограничить редактирование плавил оплаты.
	СтруктураПараметров.Вставить("ЭтапыОплатыТолькоПросмотр",            Ложь);
	// Если истина и накладная по заказам то будет отображена расширенная форма графика оплаты, несмотря на функциональную опцию "Упрощенная форма оплаты".
	СтруктураПараметров.Вставить("ВозможнаНакладнаяПоНесколькимЗаказам", Ложь);
	// Скрывает Банковский счет, кассу, оплату в валюте и УИП в форме плавил оплаты, используется в самообслуживании.
	СтруктураПараметров.Вставить("НеУказыватьИсточникиОплаты", Ложь);
	// Позволяет указывать график оплаты при отсутствии движений по плану оплат.
	СтруктураПараметров.Вставить("ЗаказКакСчет", Ложь);
	
	#КонецОбласти
	
	#Область СостояниеВзаиморасчетов
	
	ЭлементыФормы.Вставить("НадписьРасчеты",                   ""); // Имя гиперссылки, отображающей состояние расчетов и открывающей соответствующий отчет,
	
	#КонецОбласти
	
	#Область ОграниченияЗадолженностиПоДоговору
	
	ЭлементыФормы.Вставить("ОграничениеЗадолженностиТекст",    ""); // Гиперссылка отображающая состояние ограничения задолженности
	ЭлементыФормы.Вставить("ОграничениеЗадолженностиКартинка", ""); // Картинка отображающая запрет отгрузки
	
	#КонецОбласти
	
	СтруктураПараметров.Вставить("ИзменяетРасчетыСтрокой", "ИСТИНА");
	СтруктураПараметров.Вставить("ТолькоОстатки", Ложь);
	СтруктураПараметров.Вставить("ЭлементыФормы", ЭлементыФормы);
	СтруктураПараметров.Вставить("ОрганизацияДоговора", Справочники.Организации.ПустаяСсылка());
	СтруктураПараметров.Вставить("КонтрагентДоговора", Справочники.Контрагенты.ПустаяСсылка());
	СтруктураПараметров.Вставить("ДатаКурсаВалютыДокумента", "");
	СтруктураПараметров.Вставить("УдержатьВознаграждение", Ложь);
	СтруктураПараметров.Вставить("ВернутьМногооборотнуюТару", Ложь);
	СтруктураПараметров.Вставить("ТребуетсяЗалогЗаТару", Ложь);
	СтруктураПараметров.Вставить("ОперацияССамозанятым", Ложь);
	
	Возврат СтруктураПараметров;
	
КонецФункции

// Дополняет структуру/ массив структур данными настроек ИБ, задает соответствие элементов формы индексам элементов массива параметров.
// 
// Параметры:
// 	Объект - ДокументОбъект, СправочникОбъект, ФормаКлиентскогоПриложения - Объект, по которому требуется дополнить параметры.
// 	ПараметрыМеханизма - Массив из см. ВзаиморасчетыСервер.ПараметрыМеханизма, см. ВзаиморасчетыСервер.ПараметрыМеханизма - Параметры для дополнения.
//
// Возвращаемое значение:
// 	Структура - Описание:
// * МассивПараметров - Массив из см. ВзаиморасчетыСервер.ПараметрыМеханизма - Включает массив структур параметров и общие данные.
//
Функция ДополненныеПараметрыМеханизма(Объект, ПараметрыМеханизма = Неопределено) Экспорт
	
	Если ТипЗнч(Объект) <> Тип("ФормаКлиентскогоПриложения") И ПараметрыМеханизма = Неопределено Тогда
		МенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоСсылке(Объект.Ссылка);
		ПараметрыМеханизма = МенеджерОбъекта.ПараметрыВзаиморасчеты(Объект);
	КонецЕсли;
	
	Если ТипЗнч(ПараметрыМеханизма) = Тип("Массив") Тогда
		МассивПараметров = ПараметрыМеханизма;
	Иначе
		МассивПараметров = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(ПараметрыМеханизма);
	КонецЕсли;
	
	Для Каждого СтруктураПараметров Из МассивПараметров Цикл
		
		СтруктураПараметров.Вставить("ЗаданГрафикИсполнения", Ложь);
		СтруктураПараметров.Вставить("ГрафикИсполненияДоговора", Неопределено);
		СтруктураПараметров.Вставить("ВариантКурсаДоговора", Перечисления.ВариантыКурсаДоговора.Переменный);
		
		// Флаг взводится для заказов с несколькими датами отгрузки при изменении дат отгрузок
		СтруктураПараметров.Вставить("ИзменилосьНесколькоДатОтгрузки", Ложь);
		//Флаг указывает, что график оплат заполнен по умолчанию и не изменялся
		СтруктураПараметров.Вставить("ЕстьРучныеИзмененияГрафикаОплат", Ложь);
		// Параметры используются для пересчета графика оплаты
		СтруктураПараметров.Вставить("Календарь", Справочники.ПроизводственныеКалендари.ПустаяСсылка());
		СтруктураПараметров.Вставить("СрокПереходаПраваСобственности", 0);
		// Используется для пересчета даты платежа при изменении даты документа для документов с одной датой платежа
		СтруктураПараметров.Вставить("СдвигДатыПлатежа", 0);
		
		Если ЗначениеЗаполнено(СтруктураПараметров.Договор) Тогда
			Договор = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Договор);
			Если ЗначениеЗаполнено(Договор) Тогда
				УстановитьПривилегированныйРежим(Истина);
				Если ТипЗнч(Договор) = Тип("СправочникСсылка.ДоговорыКонтрагентов") Тогда
					РеквизитыДоговора = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Договор, "ЗаданГрафикИсполнения, ГрафикИсполненияДоговора, Организация, ВариантКурсаДоговора, Контрагент");
					СтруктураПараметров.ЗаданГрафикИсполнения    = РеквизитыДоговора.ЗаданГрафикИсполнения;
					СтруктураПараметров.ГрафикИсполненияДоговора = РеквизитыДоговора.ГрафикИсполненияДоговора;
					СтруктураПараметров.ОрганизацияДоговора      = РеквизитыДоговора.Организация;
					СтруктураПараметров.КонтрагентДоговора       = РеквизитыДоговора.Контрагент;
					СтруктураПараметров.ВариантКурсаДоговора     = РеквизитыДоговора.ВариантКурсаДоговора;
				Иначе
					СтруктураПараметров.ВариантКурсаДоговора     = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Договор, "ВариантКурсаДоговора");
				КонецЕсли;
				УстановитьПривилегированныйРежим(Ложь);
			КонецЕсли;
		КонецЕсли;
		Если ЗначениеЗаполнено(СтруктураПараметров.Соглашение) Тогда
			Соглашение = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Соглашение);
			Если ЗначениеЗаполнено(Соглашение) Тогда
				УстановитьПривилегированныйРежим(Истина);
				РеквизитыСоглашения = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Соглашение, "Календарь, СрокПереходаПраваСобственности");
				СтруктураПараметров.Календарь                      = РеквизитыСоглашения.Календарь;
				СтруктураПараметров.СрокПереходаПраваСобственности = РеквизитыСоглашения.СрокПереходаПраваСобственности;
				УстановитьПривилегированныйРежим(Ложь);
			КонецЕсли;
		КонецЕсли;
		Если ЗначениеЗаполнено(СтруктураПараметров.ДатаПлатежа) Тогда
			ПараметрыРасчетаДатыПлатежа = ЭтапыОплатыКлиентСервер.ПараметрыРасчетаДатыПлатежа();
			ПараметрыРасчетаДатыПлатежа.ВариантОтсчета = ПредопределенноеЗначение("Перечисление.ВариантыОтсчетаДатыПлатежа.ОтДатыОтгрузки");
			ПараметрыРасчетаДатыПлатежа.ДатаПлатежа    = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ДатаПлатежа);
			ПараметрыРасчетаДатыПлатежа.ДатаОтгрузки   = НачалоДня(ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Дата));
			ПараметрыРасчетаДатыПлатежа.Календарь      = СтруктураПараметров.Календарь;
			Если ЗначениеЗаполнено(СтруктураПараметров.Календарь) Тогда
				СтруктураПараметров.СдвигДатыПлатежа = ЭтапыОплатыВызовСервера.СдвигПоКалендарю(ПараметрыРасчетаДатыПлатежа);
			Иначе
				СтруктураПараметров.СдвигДатыПлатежа = ЭтапыОплатыКлиентСервер.СдвигБезКалендаря(ПараметрыРасчетаДатыПлатежа);
			КонецЕсли;
		КонецЕсли;
		
		Если ТипЗнч(Объект) = Тип("ФормаКлиентскогоПриложения") Тогда
		
			МассивИспользуемыхЭлементовФормы = Новый Массив;
			Для Каждого Элемент Из СтруктураПараметров.ЭлементыФормы Цикл
				Если ЗначениеЗаполнено(Элемент.Значение) Тогда
					МассивИспользуемыхЭлементовФормы.Добавить(Элемент.Значение);
				КонецЕсли;
			КонецЦикла;
			СтруктураПараметров.Вставить("ИспользуемыеЭлементыФормы", МассивИспользуемыхЭлементовФормы);
			
			Если ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧЭтапыОплаты) Тогда
				ОбъектФормы = Объект.Объект; //ДокументОбъект
				МетаданныеОбъекта = ОбъектФормы.Ссылка.Метаданные();
				СтруктураПараметров.Вставить("ПараметрыВыбораРеквизитов", ЭтапыОплатыСервер.ПараметрыВыбораРеквизитовОплаты(МетаданныеОбъекта));
			КонецЕсли;
			
			СоответствиеИспользуемыхРеквизитов = Новый Соответствие;
			Для Каждого Элемент Из СтруктураПараметров Цикл
				Если ЗначениеЗаполнено(Элемент.Значение) Тогда
					Если СоответствиеИспользуемыхРеквизитов.Получить(Элемент.Значение) = Неопределено Тогда
						СоответствиеИспользуемыхРеквизитов.Вставить(Элемент.Значение, ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Элемент.Ключ));
					Иначе
						СоответствиеИспользуемыхРеквизитов[Элемент.Значение].Добавить(Элемент.Ключ);
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;
			СтруктураПараметров.Вставить("ИспользуемыеРеквизиты", СоответствиеИспользуемыхРеквизитов);
		
		КонецЕсли;
		
		СтруктураПараметров.Вставить("ИзменяетРасчеты", СтруктураПараметров.ИзменяетПланОплаты ИЛИ СтруктураПараметров.ИзменяетПланОтгрузкиПоставки);
		
		СтруктураПараметров.Вставить("ДокументРасчетовСКлиентами", СтруктураПараметров.ТипРасчетов = ПредопределенноеЗначение("Перечисление.ТипыРасчетовСПартнерами.РасчетыСКлиентом"));
		СтруктураПараметров.Вставить("ДокументРасчетовСПоставщиками", СтруктураПараметров.ТипРасчетов = ПредопределенноеЗначение("Перечисление.ТипыРасчетовСПартнерами.РасчетыСПоставщиком"));
		
		СтруктураПараметров.Вставить("ЭтоПлатежИлиПрочийДокумент", НЕ СтруктураПараметров.ЭтоЗаказ И НЕ СтруктураПараметров.ЭтоСправочник И НЕ СтруктураПараметров.ЭтоПродажаЗакупка);
		
		СтруктураПараметров.Вставить("АдресЭтапыОплаты", "");
		СтруктураПараметров.Вставить("АдресСуммПоЗаказам", "");
		СтруктураПараметров.Вставить("АдресРасшифровкаПлатежа", "");
		СтруктураПараметров.Вставить("СуммаРасшифровкиПлатежа", 0);
		
		Если НЕ СтруктураПараметров.ЭтоПлатежИлиПрочийДокумент Тогда
			ОбъектМетаданных = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, "Объект.Ссылка").Метаданные();
			СтруктураПараметров.Вставить("ПараметрыВыбораРеквизитов", ЭтапыОплатыСервер.ПараметрыВыбораРеквизитовОплаты(ОбъектМетаданных))
		КонецЕсли;
		
		СтруктураПараметров.Вставить("ОрганизацияВСтроках", СтрЧислоВхождений(СтруктураПараметров.Организация, ".") > 1
			И ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа)
			И СтрРазделить(СтруктураПараметров.Организация, ".")[1] = СтрРазделить(СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа, ".")[1]);
		СтруктураПараметров.Вставить("КонтрагентВСтроках", СтрЧислоВхождений(СтруктураПараметров.Контрагент, ".") > 1
			И ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа)
			И СтрРазделить(СтруктураПараметров.Контрагент, ".")[1] = СтрРазделить(СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа, ".")[1]);
		СтруктураПараметров.Вставить("ПартнерВСтроках", СтрЧислоВхождений(СтруктураПараметров.Партнер, ".") > 1
			И ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа)
			И СтрРазделить(СтруктураПараметров.Партнер, ".")[1] = СтрРазделить(СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа, ".")[1]);
		СтруктураПараметров.Вставить("ВалютаВзаиморасчетовВСтроках", СтрЧислоВхождений(СтруктураПараметров.ВалютаВзаиморасчетов, ".") > 1
			И ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа)
			И СтрРазделить(СтруктураПараметров.ВалютаВзаиморасчетов, ".")[1] = СтрРазделить(СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа, ".")[1]);
			
		Если НЕ ЗначениеЗаполнено(СтруктураПараметров.ВалютаВзаиморасчетов) И ЗначениеЗаполнено(СтруктураПараметров.ВалютаДокумента) Тогда
			СтруктураПараметров.ВалютаВзаиморасчетов = СтруктураПараметров.ВалютаДокумента;
		КонецЕсли;
			
	КонецЦикла;
	
	СистемныеНастройки = Новый Структура();
	СистемныеНастройки.Вставить("ИспользоватьГрафикиОплаты",                                    ПолучитьФункциональнуюОпцию("ИспользоватьГрафикиОплаты"));
	СистемныеНастройки.Вставить("ИспользоватьСоглашенияСКлиентами",                             ПолучитьФункциональнуюОпцию("ИспользоватьСоглашенияСКлиентами"));
	СистемныеНастройки.Вставить("ИспользоватьСоглашенияСПоставщиками",                          ПолучитьФункциональнуюОпцию("ИспользоватьСоглашенияСПоставщиками"));
	СистемныеНастройки.Вставить("ИспользоватьДоговорыСКлиентами",                               ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСКлиентами"));
	СистемныеНастройки.Вставить("ИспользоватьДоговорыСПоставщиками",                            ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСПоставщиками"));
	СистемныеНастройки.Вставить("ИспользоватьДоговорыМеждуОрганизациями",                       ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыМеждуОрганизациями"));
	СистемныеНастройки.Вставить("ИспользоватьДопустимоеОтклонениеОтгрузкиПриемкиМерныхТоваров", ПолучитьФункциональнуюОпцию("ИспользоватьДопустимоеОтклонениеОтгрузкиПриемкиМерныхТоваров"));
	СистемныеНастройки.Вставить("ИспользоватьУпрощеннуюСхемуОплатыВЗакупках",                   ПолучитьФункциональнуюОпцию("ИспользоватьУпрощеннуюСхемуОплатыВЗакупках"));
	СистемныеНастройки.Вставить("ИспользоватьУпрощеннуюСхемуОплатыВПродажах",                   ПолучитьФункциональнуюОпцию("ИспользоватьУпрощеннуюСхемуОплатыВПродажах"));
	СистемныеНастройки.Вставить("ИспользоватьРеализациюПоНесколькимЗаказам",                    ПолучитьФункциональнуюОпцию("ИспользоватьРеализациюПоНесколькимЗаказам"));
	
	СистемныеНастройки.Вставить("НоваяАрхитектураВзаиморасчетов", ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов"));
	
	СистемныеНастройки.Вставить("ВалютаУправленческогоУчета", Константы.ВалютаУправленческогоУчета.Получить());
	
	ДополненныеПараметрыМеханизма = Новый Структура();
	ДополненныеПараметрыМеханизма.Вставить("МассивПараметров", МассивПараметров);
	ДополненныеПараметрыМеханизма.Вставить("СистемныеНастройки", СистемныеНастройки);
	ДополненныеПараметрыМеханизма.Вставить("ОповеститьОЗаполненииЭтапов", Ложь);
	ДополненныеПараметрыМеханизма.Вставить("ОповеститьОбИзмененииОбъектаРасчетов", Ложь);
	ДополненныеПараметрыМеханизма.Вставить("ИзмененныйОбъектРасчетов", Справочники.ОбъектыРасчетов.ПустаяСсылка());
	
	
	Возврат ДополненныеПараметрыМеханизма;
	
КонецФункции

#Область МодульОбъекта

//Выполняет первоначальное заполнение валют, порядка расчетов, оплата в валюте, этапов графика оплат, курса и кратности
//значениями по умолчанию, если значения еще не заполнены.
//
// Параметры:
// 	Объект - ДокументОбъект, СправочникОбъект - обрабатываемый объект.
// 	ДанныеЗаполнения - Структура, ДокументОбъект - ДанныеЗаполнения из обработки заполнения документа.
// 
Процедура ОбработкаЗаполнения(Объект, ДанныеЗаполнения) Экспорт
	
	МенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоСсылке(Объект.Ссылка);
	ПараметрыМеханизма = МенеджерОбъекта.ПараметрыВзаиморасчеты(Объект);
	
	ДополненныеПараметрыМеханизма = ДополненныеПараметрыМеханизма(Объект, ПараметрыМеханизма);
	
	Для Каждого СтруктураПараметров Из ДополненныеПараметрыМеханизма.МассивПараметров Цикл
		
		Организация = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Организация);
		Если ЗначениеЗаполнено(Организация) Тогда
			ВалютаРегламентированногоУчета = ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(Организация);
		ИначеЕсли ТипЗнч(ДанныеЗаполнения) = Тип("Структура")
			И ДанныеЗаполнения.Свойство("Организация")
			И ЗначениеЗаполнено(ДанныеЗаполнения.Организация)
			И ТипЗнч(ДанныеЗаполнения.Организация) = Тип("СправочникСсылка.Организации") Тогда
			ВалютаРегламентированногоУчета = ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(ДанныеЗаполнения.Организация);
		Иначе
			ВалютаРегламентированногоУчета = Неопределено;
		КонецЕсли;
		
		ОбработатьЗаполнить(Объект, СтруктураПараметров, ДанныеЗаполнения, "ВалютаДокумента", ВалютаРегламентированногоУчета);
		ОбработатьЗаполнить(Объект, СтруктураПараметров, ДанныеЗаполнения, "ВалютаВзаиморасчетов", ВалютаРегламентированногоУчета);
		ОбработатьЗаполнить(Объект, СтруктураПараметров, ДанныеЗаполнения, "ПорядокРасчетов", ПорядокРасчетовПоПараметрам(Объект, СтруктураПараметров));
		// Оплата в валюте:
		ОплатаВВалютеПоУмолчанию = ОплатаВВалютеПоУмолчанию(Объект, СтруктураПараметров);
		ОплатаВВалюте = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Объект, СтруктураПараметров.ОплатаВВалюте);
		Если ОплатаВВалюте <> Неопределено Тогда
			ОплатаВВалюте.Данные[ОплатаВВалюте.Имя] = ОплатаВВалютеПоУмолчанию
		КонецЕсли;
		
		Если ДанныеЗаполнения <> Неопределено
			И ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ДанныеЗаполнения, "ГруппаФинансовогоУчета")
			И Не ЗначениеЗаполнено(ДанныеЗаполнения.ГруппаФинансовогоУчета)
			И ЗначениеЗаполнено(СтруктураПараметров.ГруппаФинансовогоУчета) Тогда
			
			ГФУПоУмолчанию = ГФУПоУмолчанию(Объект, СтруктураПараметров, ДополненныеПараметрыМеханизма.СистемныеНастройки);
			ГФУДляПрисвоения = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Объект, СтруктураПараметров.ГруппаФинансовогоУчета);
			
			Если ГФУДляПрисвоения <> Неопределено Тогда
				ГФУДляПрисвоения.Данные[ГФУДляПрисвоения.Имя] = ГФУПоУмолчанию;
			КонецЕсли;
		
		КонецЕсли;
		
	КонецЦикла;
	
	Если ДополненныеПараметрыМеханизма.МассивПараметров.Количество() > 0
		И ЗначениеЗаполнено(ДополненныеПараметрыМеханизма.МассивПараметров[0].КурсЧислитель)
		И ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, ДополненныеПараметрыМеханизма.МассивПараметров[0].КурсЧислитель) = 0 Тогда
		ЗаполнитьКурсКратностьПоУмолчанию(Объект, ДополненныеПараметрыМеханизма);
	КонецЕсли;
	
КонецПроцедуры

//Выполняет очистку реквизитов при копировании документов.
//В продажах и закупках чистится расшифровка платежа, этапы графика оплат, суммы взаиморасчетов.
//
// Параметры:
// 	Объект - ДокументОбъект, СправочникОбъект - обрабатываемый объект.
// 
Процедура ПриКопировании(Объект) Экспорт
	
	МенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоСсылке(Объект.Ссылка);
	ПараметрыМеханизма = МенеджерОбъекта.ПараметрыВзаиморасчеты(Объект);
	
	ДополненныеПараметрыМеханизма = ДополненныеПараметрыМеханизма(Объект, ПараметрыМеханизма);
	Для Каждого СтруктураПараметров Из ДополненныеПараметрыМеханизма.МассивПараметров Цикл
		
		Если ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа) Тогда
			РасшифровкаПлатежа = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа);
			Если СтруктураПараметров.ЭтоПродажаЗакупка Тогда
				РасшифровкаПлатежа.Очистить();
			Иначе
				МассивОбъектовРасчетов = РасшифровкаПлатежа.ВыгрузитьКолонку("ОбъектРасчетов");
				РеквизитыОбъектовРасчетов = ОбщегоНазначения.ЗначениеРеквизитаОбъектов(МассивОбъектовРасчетов,"Объект");
				Для Каждого Стр Из РасшифровкаПлатежа Цикл
					Если ТипЗнч(РеквизитыОбъектовРасчетов[Стр.ОбъектРасчетов]) = ТипЗнч(Объект.Ссылка) Тогда
						Стр.ОбъектРасчетов = Справочники.ОбъектыРасчетов.ПустаяСсылка();
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		КонецЕсли;
		
		ОчиститьЭтапыГрафикаОплаты(Объект, СтруктураПараметров);
		ОчиститьСуммыВзаиморасчетовТЧ(Объект, СтруктураПараметров);
		ОчиститьОбъектРасчетов(Объект, СтруктураПараметров);
	КонецЦикла;
	
КонецПроцедуры

//Проверяет и заполняет необходимые данные механизма и документа:
//	Сумму взаиморасчетов документа;
//	Сумму взаиморасчетов в основных табличных частях документа;
//	Порядок расчетов;
//	Оплату в валюте;
//	Расшифровку платежа;
//	Этапы графика оплат.
//
// Параметры:
// 	Объект - ДокументОбъект, СправочникОбъект - обрабатываемый объект.
// 	Отказ - Булево - Флаг отказ из обработчика документа ПередЗаписью.
// 	РежимЗаписи - РежимЗаписиДокумента - Режим записи документа.
// 
Процедура ПередЗаписью(Объект, Отказ, ЗНАЧ РежимЗаписи = Неопределено) Экспорт
	
	Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(Объект,"ДополнительныеСвойства")
		И Объект.ДополнительныеСвойства.Свойство("ДополненныеПараметрыВзаиморасчетов") Тогда
		ДополненныеПараметрыМеханизма = Объект.ДополнительныеСвойства.ДополненныеПараметрыВзаиморасчетов;
	Иначе
		МенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоСсылке(Объект.Ссылка);
		ПараметрыМеханизма = МенеджерОбъекта.ПараметрыВзаиморасчеты(Объект);
		ДополненныеПараметрыМеханизма = ДополненныеПараметрыМеханизма(Объект, ПараметрыМеханизма);
	КонецЕсли;
	
	СистемныеНастройки = ДополненныеПараметрыМеханизма.СистемныеНастройки;
	
	Ссылка = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, "Объект.Ссылка");
	
	Если Объект.ЭтоНовый() Тогда
		СсылкаНового = Объект.ПолучитьСсылкуНового();
		Если Не ЗначениеЗаполнено(СсылкаНового) Тогда
			СсылкаНового = ОбщегоНазначения.МенеджерОбъектаПоСсылке(Ссылка).ПолучитьСсылку();
			Объект.УстановитьСсылкуНового(СсылкаНового);
		КонецЕсли;
	ИначеЕсли Метаданные.ПодпискиНаСобытия.ПроверитьНомерДокументаПоДатеИОрганизации.Источник.СодержитТип(ТипЗнч(Объект)) Тогда
		ПрефиксацияОбъектовСобытия.ПроверитьНомерДокументаПоДатеИОрганизации(Объект, Отказ, РежимЗаписи, Неопределено);
		Если Не ЗначениеЗаполнено(Объект.Номер) Тогда
			Объект.УстановитьНовыйНомер()
		КонецЕсли;
		Объект.ДополнительныеСвойства.Вставить("ПроверенНомерДокументаПоДатеИОрганизации", Истина);
	КонецЕсли;
	
	Для Каждого СтруктураПараметров Из ДополненныеПараметрыМеханизма.МассивПараметров Цикл
		
		Если Объект.ЭтоНовый() Тогда
			СтруктураПараметров.Вставить("СсылкаНового", СсылкаНового);
		КонецЕсли;
		
		ПроверитьЗаполнитьРеквизит(Объект, СтруктураПараметров, "ПорядокРасчетов", ПорядокРасчетовПоПараметрам(Объект, СтруктураПараметров));
		ПроверитьЗаполнитьРеквизит(Объект, СтруктураПараметров, "ОплатаВВалюте", ОплатаВВалютеПоУмолчанию(Объект, СтруктураПараметров));
		
		Если РежимЗаписи = РежимЗаписиДокумента.Проведение Тогда
			ПроверитьЗаполнитьСуммуВзаиморасчетов(Объект, СтруктураПараметров, СистемныеНастройки);
			ПроверитьЗаполнитьСуммыВзаиморасчетовВТабличнойЧасти(Объект, СтруктураПараметров);
		КонецЕсли;
		
		Если СтруктураПараметров.ЭтоСправочник И СтруктураПараметров.Ссылка = СтруктураПараметров.Договор Тогда
			ПроверитьЗаполнитьВариантКурсаВалютыДоговора(Объект);
		КонецЕсли;
		
		Если НЕ СтруктураПараметров.Свойство("СуммыДокумента") И РежимЗаписи <> РежимЗаписиДокумента.ОтменаПроведения Тогда
			Если СтруктураПараметров.Свойство("ИсточникСуммТабличнаяЧасть") И СтруктураПараметров.ИсточникСуммТабличнаяЧасть Тогда
				СтруктураПараметров.Вставить("СуммыДокумента", СуммыДокумента(Объект,СтруктураПараметров));
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	Если РежимЗаписи = РежимЗаписиДокумента.Проведение Тогда
		ПроверитьЗаполнитьЭтапыГрафикаОплаты(Объект, ДополненныеПараметрыМеханизма);
		ПроверитьЗаполнениеЭтаповГрафикаОплаты(Объект, Отказ, ДополненныеПараметрыМеханизма);
	КонецЕсли;
	
	ОбъектыРасчетовСервер.ПроверитьОбъектыРасчетовПередЗаписью(Объект, ДополненныеПараметрыМеханизма.МассивПараметров, РежимЗаписи, Отказ);
	ЗаписатьКурсыИВалютыДокумента(Объект, ДополненныеПараметрыМеханизма.МассивПараметров, Отказ);
	
	Для Каждого СтруктураПараметров Из ДополненныеПараметрыМеханизма.МассивПараметров Цикл
		Если РежимЗаписи = РежимЗаписиДокумента.Проведение И НЕ Объект.Проведен Тогда
			ЗаполнитьВозможныеАвансыВНакладной(Объект, СтруктураПараметров);
		КонецЕсли;
		
		//Очистка кэша сумм
		Если СтруктураПараметров.Свойство("СуммыДокумента") Тогда
			СтруктураПараметров.Удалить("СуммыДокумента");
		КонецЕсли;
		
	КонецЦикла
	
КонецПроцедуры

// Перед записью на сервере.
// 
// Параметры:
//  Форма Форма
//  ТекущийОбъект Текущий объект
Процедура ПередЗаписьюНаСервере(Форма, ТекущийОбъект) Экспорт
	ТекущийОбъект.ДополнительныеСвойства.Вставить("ДополненныеПараметрыВзаиморасчетов", ОбщегоНазначенияУТКлиентСервер.ПолучитьДанныеМеханизмаИзКэшаФормы(Форма, "Взаиморасчеты"));
КонецПроцедуры

// При изменении даты согласования очищает этапы графика оплаты.
// 
// Параметры:
//  Объект - ДокументОбъект, СправочникОбъект - обрабатываемый объект.
Процедура ПриИзмененииДатыСогласования(Объект) Экспорт
	
	МенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоСсылке(Объект.Ссылка);
	ПараметрыМеханизма = МенеджерОбъекта.ПараметрыВзаиморасчеты(Объект);
	ДополненныеПараметрыМеханизма = ДополненныеПараметрыМеханизма(Объект, ПараметрыМеханизма);
	
	Для Каждого СтруктураПараметров Из ДополненныеПараметрыМеханизма.МассивПараметров Цикл
		
		ЭтапыГрафика = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ПутьКДаннымТЧЭтапыОплаты);
		
		ДатаСогласования = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ДатаСогласования);
		ДатаЗаказа = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Дата);
		
		Для Каждого СтрокаЭтапа Из ЭтапыГрафика Цикл
			Если СтрокаЭтапа.ВариантОтсчета = Перечисления.ВариантыОтсчетаДатыПлатежа.ОтДатыСогласования Тогда
				СтруктураПараметров = ЭтапыОплатыКлиентСервер.ПараметрыРасчетаДатыПлатежа();
				СтруктураПараметров.ВариантОтсчета                 = СтрокаЭтапа.ВариантОтсчета;
				СтруктураПараметров.Сдвиг                          = СтрокаЭтапа.Сдвиг;
				СтруктураПараметров.ДатаЗаказа                     = ДатаЗаказа;
				СтруктураПараметров.ДатаСогласования               = ДатаСогласования;
				СтруктураПараметров.ДатаОтгрузки                   = Дата(1,1,1);
				СтруктураПараметров.ДатаПереходаПраваСобственности = Дата(1,1,1);
				
				Если ЗначениеЗаполнено(СтруктураПараметров.Календарь)  Тогда
					СтрокаЭтапа.ДатаПлатежа = ЭтапыОплатыВызовСервера.ДатаПлатежаПоКалендарю(СтруктураПараметров);
				Иначе
					СтрокаЭтапа.ДатаПлатежа = ЭтапыОплатыКлиентСервер.ДатаПлатежаБезКалендаря(СтруктураПараметров);
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
		ЭтапыОплатыКлиентСервер.СортироватьТаблицуЭтапов(ЭтапыГрафика);
		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область МодульФормы

//Выполняет дополнение и кэширование параметров механизма в реквизит формы, обновляет тексты гиперссылок
//и устанавливает видимость команды "Зачет оплаты" для новых документов.
//
// Параметры:
// 	Форма - РасширениеУправляемойФормыДляДокумента - Форма документа/справочника.
// 
Процедура ФормаПриСозданииНаСервере(Форма) Экспорт
	
	Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(Форма,"КэшДанныхМеханизмов")
		И Форма.КэшДанныхМеханизмов.Свойство("Взаиморасчеты") Тогда
		ПараметрыМеханизма = Форма.КэшДанныхМеханизмов.Взаиморасчеты.МассивПараметров;
	Иначе
		МенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоПолномуИмени(Форма.ИмяФормы);
		ПараметрыМеханизма = МенеджерОбъекта.ПараметрыВзаиморасчеты(Форма.Объект);
	
		ДополнитьИЗакэшироватьПараметры(Форма, ПараметрыМеханизма);
	КонецЕсли;
	
	УстановитьУсловноеОформление(Форма);
	
	Объект = Форма.Объект; //ДанныеФормыСтруктура
	
	Если ЗначениеЗаполнено(Объект.Ссылка) Тогда
		Если Форма.ТолькоПросмотр Тогда
			Возврат;
		КонецЕсли;
		Если ТипЗнч(ПараметрыМеханизма) = Тип("Массив") Тогда
			МассивПараметров = ПараметрыМеханизма;
		Иначе
			МассивПараметров = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(ПараметрыМеханизма);
		КонецЕсли;
		Для Каждого СтруктураПараметров Из МассивПараметров Цикл
			Если ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧЭтапыОплаты)
				И СтруктураПараметров.ЭтоЗаказ
				И НЕ ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.ОтгружатьОднойДатой) Тогда
				ТабличнаяЧасть = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.ПутьКДаннымТЧЭтапыОплаты);
				ТаблицаЭтаповОплаты = ТабличнаяЧасть.Выгрузить();
				ТаблицаЭтаповОплаты.Очистить();
				ПроверитьЗаполнитьЭтапыГрафикаОплаты(Форма, СтруктураПараметров, ТаблицаЭтаповОплаты);
				СтруктураПараметров.ЕстьРучныеИзмененияГрафикаОплат = Не ТаблицыРавны(ТаблицаЭтаповОплаты, ТабличнаяЧасть.Выгрузить());
			КонецЕсли;
		КонецЦикла;
		Возврат;
	Иначе
		ФормаПриЧтенииСозданииНаСервере(Форма, ПараметрыМеханизма)
	КонецЕсли;
	
	ЗаблокироватьОбъектыРасчетов(Форма);
	
КонецПроцедуры

//Выполняет кэширование параметров механизма в реквизит формы, обновляет тексты гиперссылок
//и устанавливает видимость команды "Зачет оплаты" для существующих документов.
//
// Параметры:
// 	Форма - ФормаКлиентскогоПриложения - Форма документа/справочника.
// 
Процедура ФормаПриЧтенииНаСервере(Форма) Экспорт
	
	МенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоПолномуИмени(Форма.ИмяФормы);
	ПараметрыМеханизма = МенеджерОбъекта.ПараметрыВзаиморасчеты(Форма.Объект);
	
	ДополнитьИЗакэшироватьПараметры(Форма, ПараметрыМеханизма);
	
	ФормаПриЧтенииСозданииНаСервере(Форма, ПараметрыМеханизма)
	
КонецПроцедуры

//Обновляет тексты гиперссылок после записи и устанавливает значения параметров механизма Взаиморасчеты по оповещению
//
// Параметры:
// 	Форма - ФормаКлиентскогоПриложения - Форма документа/справочника.
// 	ДополнительныеСвойства - Структура - Дополнительные свойства записаннного объекта
// 
Процедура ФормаПослеЗаписиНаСервере(Форма, ДополнительныеСвойства = Неопределено) Экспорт
	
	ВзаиморасчетыВызовСервера.ОбновитьТекстГиперссылкиОграничениеЗадолженности(Форма);
	ОбновитьТекстГиперссылкиСостояниеРасчетов(Форма);
	ВзаиморасчетыКлиентСервер.ОбновитьТекстГиперссылкиВалюты(Форма);
	ОбновитьТекстГиперссылкиЭтапыОплаты(Форма);
	ОбновитьРаспределеннуюСуммаРасшифровки(Форма);
	Если ДополнительныеСвойства <> Неопределено Тогда
		ДополненныеПараметрыМеханизма = ОбщегоНазначенияУТКлиентСервер.ПолучитьДанныеМеханизмаИзКэшаФормы(Форма, "Взаиморасчеты");
		Если ДополнительныеСвойства.Свойство("ОповеститьОЗаполненииЭтапов") Тогда
			ДополненныеПараметрыМеханизма.ОповеститьОЗаполненииЭтапов = ДополнительныеСвойства.ОповеститьОЗаполненииЭтапов;
		КонецЕсли;
		Если ДополнительныеСвойства.Свойство("ОповеститьОбИзмененииОбъектаРасчетов") Тогда 
			ДополненныеПараметрыМеханизма.ОповеститьОбИзмененииОбъектаРасчетов = ДополнительныеСвойства.ОповеститьОбИзмененииОбъектаРасчетов;
			ДополненныеПараметрыМеханизма.ИзмененныйОбъектРасчетов = ДополнительныеСвойства.ИзмененныйОбъектРасчетов;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

//Выполняет необходимые действия при изменении ключевых реквизитов документа/справочника.
//
// Параметры:
// 	Форма - ФормаКлиентскогоПриложения - Форма документа/справочника.
// 	ИзмененныеРеквизиты - Массив из Строка, Структура, Строка - Перечень имен измененных реквизитов в терминах документа.
// 	ЭтоИзмененияМеханизма - Булево - Флаг того, что вызов производит сам механизм.
// 
// Возвращаемое значение:
// 	Структура - Структура измененных реквизитов документа после обработки, где:
// 		* Ключ - Строка - Имя реквизита.
// 		* Значение - Произвольный - значение реквизита до изменения.
//
Функция ФормаПриИзмененииРеквизитов(Форма, ИзмененныеРеквизиты, ЭтоИзмененияМеханизма = Ложь) Экспорт
	
	Если ТипЗнч(ИзмененныеРеквизиты) = Тип("Массив") Тогда
		МассивРеквизитов = ИзмененныеРеквизиты;
	ИначеЕсли ТипЗнч(ИзмененныеРеквизиты) = Тип("Структура") Тогда
		МассивРеквизитов = Новый Массив;
		Для Каждого Элемент Из ИзмененныеРеквизиты Цикл
			МассивРеквизитов.Добавить(Элемент.Ключ);
		КонецЦикла;
	Иначе //строка
		МассивРеквизитов = Новый Массив;
		Реквизиты = СтрРазделить(ИзмененныеРеквизиты, ",");
		Для Каждого Реквизит Из Реквизиты Цикл
			МассивРеквизитов.Добавить(СокрЛП(Реквизит));
		КонецЦикла;
	КонецЕсли;
	
	СтарыеЗначенияИзмененныхРеквизитов = Новый Структура;
	ЕстьИзмененияВалют = Ложь;
	ИзмененКурсВалюты = Ложь;
	
	ДополненныеПараметрыМеханизма = ОбщегоНазначенияУТКлиентСервер.ПолучитьДанныеМеханизмаИзКэшаФормы(Форма, "Взаиморасчеты");
	
	//Если изменился параметр, влияющий на параметры механизма конкретного объекта, то их нужно перекэшировать.
	НужноПерекэшироватьПараметры = Ложь;
	Для Каждого СтруктураПараметров Из ДополненныеПараметрыМеханизма.МассивПараметров Цикл
		МассивВлияющихРеквизитов = СтрРазделить(СтруктураПараметров.ВлияющиеРеквизиты,",");
		Для Каждого ВлияющийРеквизит Из МассивВлияющихРеквизитов Цикл
			Если МассивРеквизитов.Найти(ВлияющийРеквизит) <> Неопределено Тогда
				НужноПерекэшироватьПараметры = Истина;
				Прервать;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	Если НужноПерекэшироватьПараметры Тогда
		ПриИзмененииПараметровМеханизма(Форма);
		ДополненныеПараметрыМеханизма = ОбщегоНазначенияУТКлиентСервер.ПолучитьДанныеМеханизмаИзКэшаФормы(Форма, "Взаиморасчеты");
	КонецЕсли;
	
	СистемныеНастройки = ДополненныеПараметрыМеханизма.СистемныеНастройки;
	
	//Возвращает какие из измененных реквизитов используются в структурах параметров.
	Результаты = МассивСтруктурПараметровПоРеквизитам(ДополненныеПараметрыМеханизма.МассивПараметров, МассивРеквизитов);
	
	Для Каждого Результат Из Результаты Цикл
		
		СтруктураПараметров = Результат.СтруктураПараметров;
		МассивИспользуемыхРеквизитов = Результат.ИспользуемыеРеквизиты;
		
		ОбновитьТекстГиперссылкиОграничениеЗадолженности = Ложь;
		ОбновитьТекстГиперссылкиСостояниеРасчетов = Ложь;
		ОбновитьТекстГиперссылкиЭтапыОплаты = Ложь;
		УстановитьВидимостьЗачетОплаты = Ложь;
		УстановитьВидимостьГФУНД = Ложь;
		ИзменилсяГрафикИсполнения = Ложь;
		
		//График исполнения договора
		Если МассивИспользуемыхРеквизитов.Найти("Договор") <> Неопределено Тогда
			
			ОбновитьТекстГиперссылкиОграничениеЗадолженности = Истина;
			
			Договор = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма.Объект, СтруктураПараметров.Договор);
			Если ЗначениеЗаполнено(Договор) Тогда
				Если ТипЗнч(Договор) = Тип("СправочникСсылка.ДоговорыКонтрагентов") Тогда
					УстановитьПривилегированныйРежим(Истина);
					РеквизитыДоговора = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Договор, "ЗаданГрафикИсполнения, ГрафикИсполненияДоговора, ВариантКурсаДоговора, Организация, Контрагент");
					УстановитьПривилегированныйРежим(Ложь);
					ЗаданГрафикИсполнения = РеквизитыДоговора.ЗаданГрафикИсполнения;
					СтруктураПараметров.ГрафикИсполненияДоговора = РеквизитыДоговора.ГрафикИсполненияДоговора;
					СтруктураПараметров.ОрганизацияДоговора      = РеквизитыДоговора.Организация;
					СтруктураПараметров.КонтрагентДоговора       = РеквизитыДоговора.Контрагент;
					СтруктураПараметров.ВариантКурсаДоговора     = РеквизитыДоговора.ВариантКурсаДоговора;
				Иначе
					ЗаданГрафикИсполнения = Ложь;
					СтруктураПараметров.ГрафикИсполненияДоговора = Неопределено;
					УстановитьПривилегированныйРежим(Истина);
					СтруктураПараметров.ВариантКурсаДоговора = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Договор, "ВариантКурсаДоговора");
					УстановитьПривилегированныйРежим(Ложь);
					СтруктураПараметров.ОрганизацияДоговора  = Справочники.Организации.ПустаяСсылка();
					СтруктураПараметров.КонтрагентДоговора   = Справочники.Контрагенты.ПустаяСсылка();
				КонецЕсли;
			Иначе
				ЗаданГрафикИсполнения = Ложь;
				СтруктураПараметров.ГрафикИсполненияДоговора = Неопределено;
				СтруктураПараметров.ВариантКурсаДоговора = Перечисления.ВариантыКурсаДоговора.Переменный;
				СтруктураПараметров.ОрганизацияДоговора  = Справочники.Организации.ПустаяСсылка();
				СтруктураПараметров.КонтрагентДоговора   = Справочники.Контрагенты.ПустаяСсылка();
			КонецЕсли;
			
			Если СтруктураПараметров.ЗаданГрафикИсполнения <> ЗаданГрафикИсполнения Тогда
				ИзменилсяГрафикИсполнения = Истина;
			КонецЕсли;
			
			СтруктураПараметров.ЗаданГрафикИсполнения = ЗаданГрафикИсполнения;
			
		КонецЕсли;
		Если МассивИспользуемыхРеквизитов.Найти("Соглашение") <> Неопределено Тогда
			Соглашение = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.Соглашение);
			Если ЗначениеЗаполнено(Соглашение) Тогда
				МассивРеквизитовСоглашения = Новый Массив;
				МассивРеквизитовСоглашения.Добавить("Календарь");
				МассивРеквизитовСоглашения.Добавить("СрокПереходаПраваСобственности");
				Если СтруктураПараметров.ТипРасчетов = Перечисления.ТипыРасчетовСПартнерами.РасчетыСКлиентом Тогда
					МассивРеквизитовСоглашения.Добавить("ГрафикОплаты");
				КонецЕсли;
				УстановитьПривилегированныйРежим(Истина);
				РеквизитыСоглашения = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Соглашение, СтрСоединить(МассивРеквизитовСоглашения, ","));
				УстановитьПривилегированныйРежим(Ложь);
				СтруктураПараметров.Календарь                      = РеквизитыСоглашения.Календарь;
				СтруктураПараметров.СрокПереходаПраваСобственности = РеквизитыСоглашения.СрокПереходаПраваСобственности;
				Если СтруктураПараметров.ТипРасчетов = Перечисления.ТипыРасчетовСПартнерами.РасчетыСКлиентом Тогда
					ГрафикОплаты = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Форма, СтруктураПараметров.ГрафикОплаты);
					Если ГрафикОплаты <> Неопределено И ГрафикОплаты.Данные[ГрафикОплаты.Имя] <> РеквизитыСоглашения.ГрафикОплаты Тогда
						СтарыеЗначенияИзмененныхРеквизитов.Вставить(ГрафикОплаты.Имя, ГрафикОплаты.Данные[ГрафикОплаты.Имя]);
						ГрафикОплаты.Данные[ГрафикОплаты.Имя] = РеквизитыСоглашения.ГрафикОплаты;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		//Порядок расчетов
		Если (МассивИспользуемыхРеквизитов.Найти("Соглашение") <> Неопределено
			ИЛИ МассивИспользуемыхРеквизитов.Найти("Договор") <> Неопределено
			ИЛИ МассивИспользуемыхРеквизитов.Найти("ДоговорКомиссионера") <> Неопределено
			ИЛИ МассивИспользуемыхРеквизитов.Найти("НакладнаяПоЗаказам") <> Неопределено)
			И ЗначениеЗаполнено(СтруктураПараметров.ПорядокРасчетов)
			И ТипЗнч(СтруктураПараметров.ПорядокРасчетов) = Тип("Строка") 
			И СтрЧислоВхождений(СтруктураПараметров.ПорядокРасчетов, ".") = 1 Тогда
			
			ПорядокРасчетовПоУмолчанию = ПорядокРасчетовПоПараметрам(Форма, СтруктураПараметров);
			ПорядокРасчетов = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Форма, СтруктураПараметров.ПорядокРасчетов);
			
			Если ПорядокРасчетов.Данные[ПорядокРасчетов.Имя]<> ПорядокРасчетовПоУмолчанию 
				ИЛИ ИзменилсяГрафикИсполнения Тогда
				СтарыеЗначенияИзмененныхРеквизитов.Вставить(ПорядокРасчетов.Имя, ПорядокРасчетов.Данные[ПорядокРасчетов.Имя]);
				ПорядокРасчетов.Данные[ПорядокРасчетов.Имя] = ПорядокРасчетовПоУмолчанию;
				
				Если МассивИспользуемыхРеквизитов.Найти("ПорядокРасчетов") = Неопределено Тогда
					МассивИспользуемыхРеквизитов.Добавить("ПорядокРасчетов");
				КонецЕсли;
				
				ОбновитьТекстГиперссылкиСостояниеРасчетов = Истина;
				ОбновитьТекстГиперссылкиЭтапыОплаты = Истина;
				УстановитьВидимостьЗачетОплаты = Истина;
			КонецЕсли;
			
			УстановитьВидимостьГФУНД = Истина;
			
		КонецЕсли;
		
		// Курс валюты договора и дата курса валюты документа
		Если МассивИспользуемыхРеквизитов.Найти("Договор") <> Неопределено Тогда
			Если СтруктураПараметров.ВариантКурсаДоговора = Перечисления.ВариантыКурсаДоговора.УстановленныйВДоговоре Тогда
				ИзмененКурсВалюты = Истина;
			КонецЕсли;
			Если СтруктураПараметров.ВариантКурсаДоговора <> Перечисления.ВариантыКурсаДоговора.Переменный 
				И ЗначениеЗаполнено(СтруктураПараметров.ДатаКурсаВалютыДокумента) Тогда
				ДатаКурсаВалютыДокумента = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Форма, СтруктураПараметров.ДатаКурсаВалютыДокумента);
				Если ЗначениеЗаполнено(ДатаКурсаВалютыДокумента.Данные[ДатаКурсаВалютыДокумента.Имя]) Тогда
					ДатаКурсаВалютыДокумента.Данные[ДатаКурсаВалютыДокумента.Имя] = Дата(1, 1, 1);
					ИзмененКурсВалюты = Истина;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		//ГФУ
		Если (МассивИспользуемыхРеквизитов.Найти("Договор") <> Неопределено
				ИЛИ МассивИспользуемыхРеквизитов.Найти("ДоговорКомиссионера") <> Неопределено
				ИЛИ МассивИспользуемыхРеквизитов.Найти("Соглашение") <> Неопределено)
			И ЗначениеЗаполнено(СтруктураПараметров.ГруппаФинансовогоУчета) Тогда
			
			ГФУПоУмолчанию = ГФУПоУмолчанию(Форма, СтруктураПараметров, СистемныеНастройки);
			
			ГФУРеквизит = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Форма,СтруктураПараметров.ГруппаФинансовогоУчета);
			Если ГФУРеквизит <> Неопределено И НЕ ОбщегоНазначения.ЭтоСсылка(ТипЗнч(ГФУРеквизит.Данные)) Тогда
				ГФУРеквизит.Данные[ГФУРеквизит.Имя] = ГФУПоУмолчанию;
			КонецЕсли;
			
		КонецЕсли;
		
		Если МассивИспользуемыхРеквизитов.Найти("НакладнаяПоЗаказам") <> Неопределено Тогда
			УстановитьВидимостьЗачетОплаты = Истина;
			УстановитьВидимостьГФУНД = Истина;
			ОчиститьРасшифровкуПлатежа(Форма, СтруктураПараметров);
		КонецЕсли;
		
		//Оплата в валюте
		Если МассивИспользуемыхРеквизитов.Найти("Договор") <> Неопределено
			ИЛИ МассивИспользуемыхРеквизитов.Найти("ДоговорКомиссионера") <> Неопределено Тогда
			
			ОплатаВВалютеПоУмолчанию = ОплатаВВалютеПоУмолчанию(Форма, СтруктураПараметров);
			ОплатаВВалюте = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Форма, СтруктураПараметров.ОплатаВВалюте);
			
			Если ОплатаВВалюте <> Неопределено И ОплатаВВалюте.Данные[ОплатаВВалюте.Имя]<> ОплатаВВалютеПоУмолчанию Тогда
				СтарыеЗначенияИзмененныхРеквизитов.Вставить(ОплатаВВалюте.Имя, ОплатаВВалюте.Данные);
				ОплатаВВалюте.Данные[ОплатаВВалюте.Имя] = ОплатаВВалютеПоУмолчанию;
			КонецЕсли;
		КонецЕсли;
		
		//График оплаты
		Если МассивИспользуемыхРеквизитов.Найти("Соглашение") <> Неопределено Или ИзменилсяГрафикИсполнения Тогда
			//Очистка графика этапов оплаты
			Если ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧЭтапыОплаты) Тогда
				ОчиститьЭтапыГрафикаОплаты(Форма, СтруктураПараметров);
			ИначеЕсли ЗначениеЗаполнено(СтруктураПараметров.ДатаПлатежа) Тогда
				Реквизит = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Форма, СтруктураПараметров.ДатаПлатежа);
				Реквизит.Данные[Реквизит.Имя] = Дата(1,1,1);
			КонецЕсли;
			ОбновитьТекстГиперссылкиЭтапыОплаты = Истина;
		ИначеЕсли МассивИспользуемыхРеквизитов.Найти("Дата") <> Неопределено 
			И ЗначениеЗаполнено(СтруктураПараметров.ДатаПлатежа) 
			И ЗначениеЗаполнено(ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.ДатаПлатежа))Тогда
			ПараметрыРасчетаДатыПлатежа = ЭтапыОплатыКлиентСервер.ПараметрыРасчетаДатыПлатежа();
			ПараметрыРасчетаДатыПлатежа.ВариантОтсчета = ПредопределенноеЗначение("Перечисление.ВариантыОтсчетаДатыПлатежа.ОтДатыОтгрузки");
			ПараметрыРасчетаДатыПлатежа.ДатаОтгрузки   = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.Дата);
			ПараметрыРасчетаДатыПлатежа.Сдвиг          = СтруктураПараметров.СдвигДатыПлатежа;
			ПараметрыРасчетаДатыПлатежа.Календарь      = СтруктураПараметров.Календарь;
			Если ЗначениеЗаполнено(СтруктураПараметров.Календарь) Тогда
				ДатаПлатежа = ЭтапыОплатыВызовСервера.ДатаПлатежаПоКалендарю(ПараметрыРасчетаДатыПлатежа);
			Иначе
				ДатаПлатежа = ЭтапыОплатыКлиентСервер.ДатаПлатежаБезКалендаря(ПараметрыРасчетаДатыПлатежа);
			КонецЕсли;
			Реквизит = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Форма, СтруктураПараметров.ДатаПлатежа);
			Реквизит.Данные[Реквизит.Имя] = ДатаПлатежа;
			ОбновитьТекстГиперссылкиЭтапыОплаты = Истина;
		ИначеЕсли ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧЭтапыОплаты)
			И (МассивИспользуемыхРеквизитов.Найти("Дата") <> Неопределено
				ИЛИ МассивИспользуемыхРеквизитов.Найти("ДатаОтгрузки") <> Неопределено
				ИЛИ МассивИспользуемыхРеквизитов.Найти("ДатаСогласования") <> Неопределено
				ИЛИ МассивИспользуемыхРеквизитов.Найти("ОтгружатьОднойДатой") <> Неопределено) Тогда
				
				ОбновитьТекстГиперссылкиЭтапыОплаты = ОбновитьТекстГиперссылкиЭтапыОплаты 
					ИЛИ ЭтапыОплатыСервер.ПересчитатьДатыПлатежаЭтаповОплаты(Форма, СтруктураПараметров, МассивИспользуемыхРеквизитов);
				
		КонецЕсли;
		
		Если МассивИспользуемыхРеквизитов.Найти("Организация") <> Неопределено
			И СтруктураПараметров.ЭтоПлатежИлиПрочийДокумент Тогда
			
			МассивОбъектовРасчетов = ДоступныеПоОрганизацииОбъектыРасчетов(Форма, СтруктураПараметров);
			ОчиститьОбъектИСуммуРасшифровкиПлатежа(Форма, СтруктураПараметров, МассивОбъектовРасчетов);
			
		ИначеЕсли МассивИспользуемыхРеквизитов.Найти("Организация") <> Неопределено
			ИЛИ МассивИспользуемыхРеквизитов.Найти("Соглашение") <> Неопределено
			ИЛИ МассивИспользуемыхРеквизитов.Найти("Партнер") <> Неопределено
			ИЛИ МассивИспользуемыхРеквизитов.Найти("Контрагент") <> Неопределено
			ИЛИ МассивИспользуемыхРеквизитов.Найти("НаправлениеДеятельности") <> Неопределено
			ИЛИ МассивИспользуемыхРеквизитов.Найти("Договор") <> Неопределено
			ИЛИ МассивИспользуемыхРеквизитов.Найти("ВалютаВзаиморасчетов") <> Неопределено Тогда
			
			ОчиститьОбъектИСуммуРасшифровкиПлатежа(Форма, СтруктураПараметров);
			
		КонецЕсли;
		
		Если МассивИспользуемыхРеквизитов.Найти("Организация") <> Неопределено Тогда
			
			Организация = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма.Объект, СтруктураПараметров.Организация);
			ВалютаРегламентированногоУчета = ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(Организация);
			
			Если ЗначениеЗаполнено(СтруктураПараметров.ВалютаДокумента) 
				И Не ЗначениеЗаполнено(ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма.Объект, СтруктураПараметров.ВалютаДокумента)) Тогда
				Реквизит = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Форма, СтруктураПараметров.ВалютаДокумента);
				Реквизит.Данные[Реквизит.Имя] = ВалютаРегламентированногоУчета;
				ЕстьИзмененияВалют = Истина;
			КонецЕсли;
			
			Если ЗначениеЗаполнено(СтруктураПараметров.ВалютаВзаиморасчетов)
				И Не СтруктураПараметров.ВалютаВзаиморасчетовВСтроках
				И Не ЗначениеЗаполнено(ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма.Объект, СтруктураПараметров.ВалютаВзаиморасчетов)) Тогда
				Реквизит = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Форма, СтруктураПараметров.ВалютаВзаиморасчетов);
				Реквизит.Данные[Реквизит.Имя] = ВалютаРегламентированногоУчета;
				ЕстьИзмененияВалют = Истина;
			КонецЕсли;
			
		КонецЕсли;
		
		Если (МассивИспользуемыхРеквизитов.Найти("Организация") <> Неопределено
			ИЛИ МассивИспользуемыхРеквизитов.Найти("Контрагент") <> Неопределено)
			И СтруктураПараметров.ЭтоПлатежИлиПрочийДокумент
			И ЗначениеЗаполнено(СтруктураПараметров.Договор) 
			И (ТипЗнч(ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма.Объект, СтруктураПараметров.Договор)) <> Тип("СправочникСсылка.ДоговорыКонтрагентов")
				ИЛИ СтруктураПараметров.ОрганизацияДоговора <> ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма.Объект, СтруктураПараметров.Организация)
				ИЛИ СтруктураПараметров.КонтрагентДоговора <> ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма.Объект, СтруктураПараметров.Контрагент)) Тогда
			
			Реквизит = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Форма, СтруктураПараметров.Договор);
			Реквизит.Данные[Реквизит.Имя] = Неопределено;
			
			Если МассивИспользуемыхРеквизитов.Найти("Договор") = Неопределено Тогда
				МассивИспользуемыхРеквизитов.Добавить("Договор");
			КонецЕсли;
			
		КонецЕсли;
		
		Если МассивИспользуемыхРеквизитов.Найти("ВалютаДокумента") <> Неопределено 
			ИЛИ МассивИспользуемыхРеквизитов.Найти("ВалютаВзаиморасчетов") <> Неопределено 
			ИЛИ МассивИспользуемыхРеквизитов.Найти("СуммаДокумента") <> Неопределено 
			ИЛИ МассивИспользуемыхРеквизитов.Найти("СуммаВзаиморасчетов") <> Неопределено
			ИЛИ МассивИспользуемыхРеквизитов.Найти("ДатаКурсаВалютыДокумента") <> Неопределено Тогда
			
			МассивОчищаемыхПолейЭтапов = Новый Массив;
			Если МассивИспользуемыхРеквизитов.Найти("ВалютаДокумента") <> Неопределено
				ИЛИ МассивИспользуемыхРеквизитов.Найти("СуммаДокумента") <> Неопределено Тогда
				МассивОчищаемыхПолейЭтапов.Добавить("СуммаПлатежа");
				МассивОчищаемыхПолейЭтапов.Добавить("СуммаЗалогаЗаТару");
				МассивОчищаемыхПолейЭтапов.Добавить("СуммаВзаиморасчетов");
				МассивОчищаемыхПолейЭтапов.Добавить("СуммаВзаиморасчетовПоТаре");
			ИначеЕсли МассивИспользуемыхРеквизитов.Найти("ВалютаВзаиморасчетов") <> Неопределено 
				ИЛИ МассивИспользуемыхРеквизитов.Найти("СуммаВзаиморасчетов") <> Неопределено Тогда
				МассивОчищаемыхПолейЭтапов.Добавить("СуммаВзаиморасчетов");
				МассивОчищаемыхПолейЭтапов.Добавить("СуммаВзаиморасчетовПоТаре");
			КонецЕсли;
			
			ОчиститьПоляЭтаповГрафикаОплаты(Форма, СтруктураПараметров, МассивОчищаемыхПолейЭтапов);
			ОчиститьСуммыВзаиморасчетовТЧ(Форма, СтруктураПараметров);
			
			Если НЕ ЭтоИзмененияМеханизма И ЗначениеЗаполнено(СтруктураПараметров.СуммаВзаиморасчетов) Тогда
				Реквизит = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Форма, СтруктураПараметров.СуммаВзаиморасчетов);
				Реквизит.Данные[Реквизит.Имя] = 0;
			КонецЕсли;
			
			ПроверитьЗаполнитьСуммыВзаиморасчетовВТабличнойЧасти(Форма, СтруктураПараметров);
			ВзаиморасчетыКлиентСервер.ОбновитьТекстГиперссылкиВалюты(Форма,СтруктураПараметров);
			
		КонецЕсли;
		
		Если МассивИспользуемыхРеквизитов.Найти("ДатаПлатежа") <> Неопределено Тогда
			ОбновитьТекстГиперссылкиЭтапыОплаты = Истина;
		КонецЕсли;
		
		Если МассивИспользуемыхРеквизитов.Найти("ВалютаДокумента") <> Неопределено
			ИЛИ МассивИспользуемыхРеквизитов.Найти("ВалютаВзаиморасчетов") <> Неопределено Тогда
			ЕстьИзмененияВалют = Истина;
		КонецЕсли;
		
		Если МассивИспользуемыхРеквизитов.Найти("ПорядокРасчетов") <> Неопределено Тогда
			// Необходимо очистить объекты расчетов для корректного определения состояния расчетов
			ОчиститьОбъектРасчетов(Форма, СтруктураПараметров);
			ОчиститьЭтапыГрафикаОплаты(Форма, СтруктураПараметров);
			ОбновитьТекстГиперссылкиЭтапыОплаты = Истина;
		КонецЕсли;
		
		Если МассивИспользуемыхРеквизитов.Найти("ПорядокРасчетов") <> Неопределено 
			ИЛИ МассивИспользуемыхРеквизитов.Найти("ВалютаВзаиморасчетов") <> Неопределено Тогда
			ОчиститьРасшифровкуПлатежа(Форма, СтруктураПараметров);
			УстановитьВидимостьЗачетОплаты = Истина;
			ОбновитьТекстГиперссылкиСостояниеРасчетов = Истина;
		КонецЕсли;
		
		Если МассивИспользуемыхРеквизитов.Найти("КурсЧислитель") <> Неопределено 
			ИЛИ МассивИспользуемыхРеквизитов.Найти("КурсЗнаменатель") <> Неопределено Тогда
			ИзмененКурсВалюты = Истина;
		КонецЕсли;
		
		Если ОбновитьТекстГиперссылкиОграничениеЗадолженности Тогда
			ВзаиморасчетыВызовСервера.ОбновитьТекстГиперссылкиОграничениеЗадолженности(Форма);
		КонецЕсли;
		
		Если ОбновитьТекстГиперссылкиСостояниеРасчетов Тогда
			ОбновитьТекстГиперссылкиСостояниеРасчетов(Форма);
		КонецЕсли;
		
		Если ОбновитьТекстГиперссылкиЭтапыОплаты Тогда
			ОбновитьТекстГиперссылкиЭтапыОплаты(Форма, СтруктураПараметров, СистемныеНастройки);
		КонецЕсли;
		
		Если УстановитьВидимостьЗачетОплаты Тогда
			УстановитьВидимостьЗачетОплаты(Форма, СтруктураПараметров);
		КонецЕсли;
		
		Если УстановитьВидимостьГФУНД Тогда
			УстановитьВидимостьГФУНД(Форма, СтруктураПараметров);
		КонецЕсли;
		
		//При изменении порядка расчетов проверить видимость ЗачетОплаты
		//При изменении суммы документа на форме, переформировывать надпись валюты, все гиперссылки
		//При изменении даты, даты банка, проведено банком, очистить суммы взаиморасчетов расшифровки
	КонецЦикла;
	
	Если НЕ ЭтоИзмененияМеханизма И ЕстьИзмененияВалют И ЗначениеЗаполнено(СтруктураПараметров.КурсЧислитель) Тогда
		СтарыеЗначенияИзмененныхРеквизитов.Вставить("КурсЧислитель", ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.КурсЧислитель));
		СтарыеЗначенияИзмененныхРеквизитов.Вставить("КурсЗнаменатель", ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.КурсЗнаменатель));
		ЗаполнитьКурсКратностьПоУмолчанию(Форма, ДополненныеПараметрыМеханизма);
		ВзаиморасчетыКлиентСервер.ОбновитьТекстГиперссылкиВалюты(Форма,СтруктураПараметров);
	ИначеЕсли ИзмененКурсВалюты Тогда
		ВзаиморасчетыКлиентСервер.ОбновитьТекстГиперссылкиВалюты(Форма,СтруктураПараметров);
	КонецЕсли;
	
	ОбщегоНазначенияУТ.СохранитьДанныеМеханизмаВКэшФормы(Форма, "Взаиморасчеты", ДополненныеПараметрыМеханизма);
	
	Возврат СтарыеЗначенияИзмененныхРеквизитов;
	
КонецФункции

//Обновляет тексты гиперссылок, видимость команды "Зачет оплаты".
//Очищает все реквизиты взаиморасчетов, если документ более не изменяет взаиморасчеты.
//
// Параметры:
// 	Форма - ФормаКлиентскогоПриложения - Форма документа/справочника.
// 
Процедура ПриИзмененииПараметровМеханизма(Форма) Экспорт
	
	МенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоПолномуИмени(Форма.ИмяФормы);
	ПараметрыМеханизмаНовые = МенеджерОбъекта.ПараметрыВзаиморасчеты(Форма.Объект);
	ДанныеНастройки = ДополненныеПараметрыМеханизма(Форма, ПараметрыМеханизмаНовые);
	
	МассивПараметров = Форма.КэшДанныхМеханизмов["Взаиморасчеты"].МассивПараметров;
	Для Каждого СтруктураПараметров Из МассивПараметров Цикл
		Если МассивПараметров.Количество() <> ДанныеНастройки.МассивПараметров.Количество()
			ИЛИ СтруктураПараметров.ТипРасчетов <> ДанныеНастройки.МассивПараметров[МассивПараметров.Найти(СтруктураПараметров)].ТипРасчетов Тогда
			ОчиститьРасшифровкуПлатежа(Форма, СтруктураПараметров);
			ОчиститьОбъектРасчетов(Форма,СтруктураПараметров);
		КонецЕсли;
	КонецЦикла;
	
	Для Каждого СтруктураПараметров Из ДанныеНастройки.МассивПараметров Цикл
		
		// Очищаем все сущности механизма, если нет расчетов с клиентами или поставщиками.
		Если НЕ СтруктураПараметров.ИзменяетРасчеты Тогда
			
			СуммаВзаиморасчетов = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Форма, СтруктураПараметров.СуммаВзаиморасчетов);
			Если ЗначениеЗаполнено(СуммаВзаиморасчетов) Тогда
				СуммаВзаиморасчетов.Данные[СуммаВзаиморасчетов.Имя] = 0;
			КонецЕсли;
			
			СуммаВзаиморасчетовПоТаре = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Форма, СтруктураПараметров.СуммаВзаиморасчетовПоТаре);
			Если ЗначениеЗаполнено(СуммаВзаиморасчетовПоТаре) Тогда
				СуммаВзаиморасчетовПоТаре.Данные[СуммаВзаиморасчетовПоТаре.Имя] = 0;
			КонецЕсли;
			
			ОчиститьСуммыВзаиморасчетовТЧ(Форма, СтруктураПараметров);
			
		КонецЕсли;
		
		Если НЕ СтруктураПараметров.ИзменяетПланОплаты
			// Возвраты товаров.
			ИЛИ ЗначениеЗаполнено(СтруктураПараметров.ЭлементыФормы.ГиперссылкаРасшифровкаПлатежа)
			ИЛИ СтруктураПараметров.УдержатьВознаграждение Тогда
			Если НЕ СтруктураПараметров.ЗаказКакСчет
				ИЛИ СтруктураПараметров.УдержатьВознаграждение Тогда
				ОчиститьЭтапыГрафикаОплаты(Форма, СтруктураПараметров);
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	ОбщегоНазначенияУТ.СохранитьДанныеМеханизмаВКэшФормы(Форма, "Взаиморасчеты", ДанныеНастройки);
	
	УстановитьВидимостьЗачетОплаты(Форма);
	УстановитьВидимостьГФУНД(Форма);
	ВзаиморасчетыВызовСервера.ОбновитьТекстГиперссылкиОграничениеЗадолженности(Форма);
	ОбновитьТекстГиперссылкиЭтапыОплаты(Форма);
	ОбновитьТекстГиперссылкиСостояниеРасчетов(Форма);
	ВзаиморасчетыКлиентСервер.ОбновитьТекстГиперссылкиВалюты(Форма);
	
КонецПроцедуры

// Используется для обработке оповещений, связанных с механизмами взаиморасчетов.
// 
// Параметры:
// 	Форма - ФормаКлиентскогоПриложения
// 	 * Объект - ДанныеФормы
// 	  ** Ссылка - ДокументСсылка, СправочникСсылка
// 	ИмяСобытия - Строка - Имя события.
// 	Параметр - Произвольный - Параметр события.
Процедура ОбработкаОповещения(Форма, ИмяСобытия, Параметр) Экспорт
	
	ОбъектФормы = Форма.Объект; //ДокументОбъект
	
	Если (ИмяСобытия = "ЗачтенаОплата" И Параметр = ОбъектФормы.Ссылка) 
		Или ИзменилисьДокументыОплатыКлиентам(ИмяСобытия)
		Или ИзменилисьДокументыОплатыПоставщиком(ИмяСобытия) Тогда
		ВзаиморасчетыВызовСервера.ОбновитьТекстГиперссылкиОграничениеЗадолженности(Форма);
		ВзаиморасчетыСервер.ОбновитьТекстГиперссылкиСостояниеРасчетов(Форма);
		
		Параметры = ОбщегоНазначенияУТКлиентСервер.ПолучитьДанныеМеханизмаИзКэшаФормы(Форма, "Взаиморасчеты");
		Для Каждого Структура Из Параметры.МассивПараметров Цикл
			Структура.АдресРасшифровкаПлатежа = "";
		КонецЦикла;
		Если НЕ Форма.Модифицированность Тогда
			Форма.Прочитать();
		КонецЕсли;
		
	КонецЕсли;
	
	//Обновить ограничение задолженности
	
КонецПроцедуры

// Функция - Курсы валют для пересчета
//
// Параметры:
//  Форма			 - ФормаКлиентскогоПриложения	 - Форма документа/справочника.
//  СтараяВалюта	 - СправочникСсылка.Валюты	 - валюта из которой нужно пересчитать
//  НоваяВалюта		 - СправочникСсылка.Валюты	 - валюта в которую нужно пересчитать
//  БазоваяВалюта	 - СправочникСсылка.Валюты	 - базовая валюта курсов
//  ДатаДокумента	 - Дата	 - дата получения курсов
// 
// Возвращаемое значение:
//  Структура:
//   *СтруктураКурсовСтаройВалюты - см. РаботаСКурсамиВалютУТ.ПолучитьКурсВалюты
//   *СтруктураКурсовНовойВалюты - см. РаботаСКурсамиВалютУТ.ПолучитьКурсВалюты
//
Функция КурсыВалютДляПересчета(Форма, СтараяВалюта, НоваяВалюта, БазоваяВалюта, ДатаДокумента) Экспорт
	
	ПараметрыМеханизма = ОбщегоНазначенияУТКлиентСервер.ПолучитьДанныеМеханизмаИзКэшаФормы(Форма, "Взаиморасчеты");
	Если ПараметрыМеханизма <> Неопределено Тогда
		СтруктураПараметров = ПараметрыМеханизма.МассивПараметров[0];
		Если ЗначениеЗаполнено(СтруктураПараметров.ВариантКурсаДоговора) 
			И СтруктураПараметров.ВариантКурсаДоговора = Перечисления.ВариантыКурсаДоговора.УстановленныйВДоговоре 
			И СтараяВалюта = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.ВалютаВзаиморасчетов) Тогда
			СтруктураКурсовСтаройВалюты = РегистрыСведений.КурсыВалютРасчетовПоДоговорам.ПолучитьЗначенияКурсаВалютыДоговора(
				ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.Договор),
				ДатаДокумента);
			СтруктураКурсовСтаройВалюты.Вставить("Валюта", СтараяВалюта);
			СтруктураКурсовСтаройВалюты.Вставить("БазоваяВалюта", БазоваяВалюта);
		Иначе
			СтруктураКурсовСтаройВалюты = РаботаСКурсамиВалютУТ.ПолучитьКурсВалюты(СтараяВалюта, ДатаДокумента, БазоваяВалюта);
		КонецЕсли;
		Если ЗначениеЗаполнено(СтруктураПараметров.ВариантКурсаДоговора) 
			И СтруктураПараметров.ВариантКурсаДоговора = Перечисления.ВариантыКурсаДоговора.УстановленныйВДоговоре 
			И НоваяВалюта = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.ВалютаВзаиморасчетов) Тогда
			СтруктураКурсовНовойВалюты = РегистрыСведений.КурсыВалютРасчетовПоДоговорам.ПолучитьЗначенияКурсаВалютыДоговора(
				ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.Договор),
				ДатаДокумента);
			СтруктураКурсовНовойВалюты.Вставить("Валюта", НоваяВалюта);
			СтруктураКурсовНовойВалюты.Вставить("БазоваяВалюта", БазоваяВалюта);
		Иначе
			СтруктураКурсовНовойВалюты  = РаботаСКурсамиВалютУТ.ПолучитьКурсВалюты(НоваяВалюта, ДатаДокумента, БазоваяВалюта);
		КонецЕсли;
	Иначе
		СтруктураКурсовСтаройВалюты = РаботаСКурсамиВалютУТ.ПолучитьКурсВалюты(СтараяВалюта, ДатаДокумента, БазоваяВалюта);
		СтруктураКурсовНовойВалюты  = РаботаСКурсамиВалютУТ.ПолучитьКурсВалюты(НоваяВалюта, ДатаДокумента, БазоваяВалюта);
	КонецЕсли;
	
	Результат = Новый Структура;
	Результат.Вставить("СтруктураКурсовСтаройВалюты", СтруктураКурсовСтаройВалюты);
	Результат.Вставить("СтруктураКурсовНовойВалюты", СтруктураКурсовНовойВалюты);
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#КонецОбласти

#Область ЭтапыОплаты

//Выполняет заполнение/очистку/перераспределение этапов графика оплат
//
// Параметры:
// 	Объект - ДокументОбъект, СправочникОбъект, ФормаКлиентскогоПриложения - обрабатываемый объект.
// 	ДополненныеПараметрыМеханизма - см. ВзаиморасчетыСервер.ДополненныеПараметрыМеханизма
// 	ТаблицаЭтаповГрафикаОплаты - ТаблицаЗначений - Выгрузка табличной части ЭтапыГрафикаОплаты
// 
Процедура ПроверитьЗаполнитьЭтапыГрафикаОплаты(Объект, ЗНАЧ ДополненныеПараметрыМеханизма = Неопределено, ТаблицаЭтаповГрафикаОплаты = Неопределено) Экспорт
	
	Если ТипЗнч(Объект) <> Тип("ФормаКлиентскогоПриложения") И ДополненныеПараметрыМеханизма = Неопределено Тогда
		МенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоСсылке(Объект.Ссылка);
		ПараметрыМеханизма = МенеджерОбъекта.ПараметрыВзаиморасчеты(Объект);
		ДополненныеПараметрыМеханизма = ДополненныеПараметрыМеханизма(Объект, ПараметрыМеханизма);
	КонецЕсли;
	
	Если ТипЗнч(Объект) = Тип("ФормаКлиентскогоПриложения") Тогда
		ДополненныеПараметрыМеханизма = ОбщегоНазначенияУТКлиентСервер.ПолучитьДанныеМеханизмаИзКэшаФормы(Объект, "Взаиморасчеты");
	КонецЕсли;
	
	СистемныеНастройки = ДополненныеПараметрыМеханизма.СистемныеНастройки;
	
	Для Каждого СтруктураПараметров Из ДополненныеПараметрыМеханизма.МассивПараметров Цикл
		
		Если Не ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧЭтапыОплаты) И Не ЗначениеЗаполнено(СтруктураПараметров.ДатаПлатежа) Тогда
			Продолжить;
		КонецЕсли;
		
		СуммыДокумента = СуммыДокумента(Объект, СтруктураПараметров);
		
		ИзменяетПланОплаты            = СтруктураПараметров.ИзменяетПланОплаты ИЛИ СтруктураПараметров.ЗаказКакСчет;
		ЗаданГрафикИсполнения         = СтруктураПараметров.ЗаданГрафикИсполнения;
		ГрафикИсполненияДоговора      = СтруктураПараметров.ГрафикИсполненияДоговора;
		ЭтоПродажаЗакупка             = СтруктураПараметров.ЭтоПродажаЗакупка;
		ЭтоЗаказ                      = СтруктураПараметров.ЭтоЗаказ;
		
		ПорядокРасчетов           = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ПорядокРасчетов);
		Соглашение                = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Соглашение);
		Если СистемныеНастройки.ИспользоватьГрафикиОплаты Тогда
			ГрафикОплаты          = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ГрафикОплаты);
		Иначе
			ГрафикОплаты          = Справочники.ГрафикиОплаты.ПустаяСсылка();
		КонецЕсли;
		НакладнаяПоЗаказам        = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.НакладнаяПоЗаказам, , Ложь);
		
		ДатаДокумента             = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Дата);
		ДатаОтгрузки              = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ДатаОтгрузки);
		ДатаСогласования          = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ДатаСогласования);
		Если ЭтоЗаказ Тогда
			ДатаЗаказа            = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Дата);
		КонецЕсли;
		ДатаПереходаПраваСобственности = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ДатаПереходаПраваСобственности);
		
		Если НЕ ЗначениеЗаполнено(ДатаДокумента) Тогда
			ДатаДокумента = ТекущаяДатаСеанса();
		КонецЕсли;
		
		ГрафикСоглашенияЗаполнен = ЭтапыОплатыВызовСервера.ГрафикСоглашенияЗаполнен(Соглашение);
		
		//Одна дата платежа
		Если НЕ ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧЭтапыОплаты) Тогда
			
			ДатаПлатежаПоУмолчанию = Дата(1,1,1);
			
			Если ЗаданГрафикИсполнения И НЕ СтруктураПараметров.ЭтоЗаказ Тогда
				ДатаПлатежаПоУмолчанию = ЭтапыОплатыСервер.ДатаПервогоНеоплаченногоЭтапаГрафика(ГрафикИсполненияДоговора, ДатаДокумента, СтруктураПараметров.ТипРасчетов);
			ИначеЕсли (ГрафикСоглашенияЗаполнен ИЛИ ЗначениеЗаполнено(ГрафикОплаты)) И НЕ СтруктураПараметров.ЭтоЗаказ Тогда
				ДатаПлатежаПоУмолчанию = ЭтапыОплатыСервер.ПолучитьПоследнююДатуПоГрафику(
					ДатаОтгрузки,Соглашение,ГрафикОплаты,ДатаЗаказа,ДатаСогласования,ДатаПереходаПраваСобственности);
			КонецЕсли;
			
			Если ДатаПлатежаПоУмолчанию < ДатаДокумента Тогда
				ДатаПлатежаПоУмолчанию = ДатаДокумента;
			КонецЕсли;
			
			Реквизит = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Объект, СтруктураПараметров.ДатаПлатежа);
			
			Если НЕ ЗначениеЗаполнено(Реквизит.Данные[Реквизит.Имя]) Тогда
				Реквизит.Данные[Реквизит.Имя] = ДатаПлатежаПоУмолчанию;
			КонецЕсли;
			
			Возврат;
		КонецЕсли;
		
		//График оплаты
		Если ТаблицаЭтаповГрафикаОплаты = Неопределено Тогда
			ЭтапыОплатыРеквизит = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Объект, СтруктураПараметров.ПутьКДаннымТЧЭтапыОплаты);
			ЭтапыГрафикаОплаты = ЭтапыОплатыРеквизит.Данные[ЭтапыОплатыРеквизит.Имя];
		Иначе
			ЭтапыГрафикаОплаты = ТаблицаЭтаповГрафикаОплаты;
		КонецЕсли;
		
		//Отклонения мерных товаров
		ЕстьОтклоненияМерныхТоваров = Ложь;
		Если ЭтапыГрафикаОплаты.Количество() > 0 Тогда
			ЕстьОтклоненияМерныхТоваров = ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ЭтапыГрафикаОплаты[0],"СуммаОтклоненияМерныхТоваров");
		КонецЕсли;
		
		Если ИзменяетПланОплаты
			И НЕ (ПорядокРасчетов = ПредопределенноеЗначение("Перечисление.ПорядокРасчетов.ПоНакладным") И ЭтоЗаказ И НЕ ЭтоПродажаЗакупка)
			И НЕ (ЗаданГрафикИсполнения И ЭтоЗаказ
					И (ПорядокРасчетов = ПредопределенноеЗначение("Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов")
						ИЛИ ПорядокРасчетов = ПредопределенноеЗначение("Перечисление.ПорядокРасчетов.ПоДоговорамНакладным"))) Тогда
			
			СуммаЭтаповОплаты       = ЭтапыГрафикаОплаты.Итог("СуммаПлатежа");
			Если ЭтапыГрафикаОплаты.Количество() > 0 И ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ЭтапыГрафикаОплаты[0], "СуммаЗалогаЗаТару") Тогда
				СуммаЗалогаПоЭтапам     = ЭтапыГрафикаОплаты.Итог("СуммаЗалогаЗаТару");
			Иначе
				СуммаЗалогаПоЭтапам = 0;
			КонецЕсли;
			
			Если ЭтоПродажаЗакупка 
				И ЭтапыГрафикаОплаты.Количество() > 0 
				И ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ЭтапыГрафикаОплаты[0], "СуммаВзаиморасчетов")Тогда
				СуммаВзаиморасчетовЭтапы = ЭтапыГрафикаОплаты.Итог("СуммаВзаиморасчетов");
			Иначе
				СуммаВзаиморасчетовЭтапы = 0;
			КонецЕсли;
			
			Если ЭтоПродажаЗакупка И ЗначениеЗаполнено(СтруктураПараметров.СуммаВзаиморасчетовПоТаре) Тогда
				СуммаВзаиморасчетовПоТареЭтапы = ЭтапыГрафикаОплаты.Итог("СуммаВзаиморасчетовПоТаре");
			Иначе
				СуммаВзаиморасчетовПоТареЭтапы = 0;
			КонецЕсли;
			
			Если ЕстьОтклоненияМерныхТоваров Тогда
				СуммаОтклоненияПоЭтапам = ЭтапыГрафикаОплаты.Итог("СуммаОтклоненияМерныхТоваров");
			Иначе
				СуммаОтклоненияПоЭтапам = 0;
			КонецЕсли;
			
			СуммаОтклоненияПоОплате = ?(СуммаЭтаповОплаты+СуммаЗалогаПоЭтапам = 0,0,
										Окр(СуммаОтклоненияПоЭтапам * СуммаЭтаповОплаты /(СуммаЭтаповОплаты+СуммаЗалогаПоЭтапам),2));
			
			КоличествоЭтапов = ЭтапыГрафикаОплаты.Количество();
			
			Если СуммыДокумента.СуммаДокументаБезЗалога = 0 И СуммыДокумента.СуммаЗалогаЗаТару = 0 И КоличествоЭтапов > 0 Тогда
				ЭтапыГрафикаОплаты.Очистить();
			ИначеЕсли СуммыДокумента.СуммаДокументаБезЗалога - СуммаОтклоненияПоОплате <> СуммаЭтаповОплаты
				ИЛИ СуммыДокумента.СуммаЗалогаЗаТару-(СуммаОтклоненияПоЭтапам - СуммаОтклоненияПоОплате) <> СуммаЗалогаПоЭтапам 
				ИЛИ СуммыДокумента.СуммаВзаиморасчетовБезЗалога <> СуммаВзаиморасчетовЭтапы 
				ИЛИ СуммыДокумента.СуммаВзаиморасчетовПоТаре <> СуммаВзаиморасчетовПоТареЭтапы Тогда
				
				//Заполнение
				Если КоличествоЭтапов = 0 Тогда
					
					//Накладная по заказам
					Если НЕ ЭтоЗаказ 
						И НакладнаяПоЗаказам И ПорядокРасчетов <> Перечисления.ПорядокРасчетов.ПоНакладным
						И НЕ (ЗаданГрафикИсполнения И (ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоДоговорамКонтрагентов
														ИЛИ ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоДоговорамНакладным)) Тогда
						
						ЗаполнитьЭтапыОплатыДокументаПоЗаказам(Объект, СтруктураПараметров);
						
					//Заказ или накладная не по заказам
					Иначе
						
						ПараметрыЗаполнения = ЭтапыОплатыСервер.ПараметрыЗаполненияЭтаповОплаты();
						ПараметрыЗаполнения.ЭтоРасчетыСКлиентами   = СтруктураПараметров.ТипРасчетов = Перечисления.ТипыРасчетовСПартнерами.РасчетыСКлиентом;
						ПараметрыЗаполнения.НакладнаяПоЗаказам     = НакладнаяПоЗаказам;
						ПараметрыЗаполнения.ЭтоЗаказ               = СтруктураПараметров.ЭтоЗаказ;
						ПараметрыЗаполнения.НетКонтроляПредоплаты  = СтруктураПараметров.НетКонтроляПредоплаты;
						ПараметрыЗаполнения.ПорядокРасчетов        = ПорядокРасчетов;
						ПараметрыЗаполнения.ДатаЗаказа             = ДатаЗаказа;
						ПараметрыЗаполнения.ДатаСогласования       = ДатаСогласования;
						Если СтрЧислоВхождений(СтруктураПараметров.ДатаОтгрузки, ".") > 1 Тогда
							ТаблицаТовары = ТаблицаСуммПоЗаказам(Объект);
							ПараметрыЗаполнения.ДатаОтгрузки = ТаблицаТовары;
						Иначе
							ПараметрыЗаполнения.ДатаОтгрузки = ДатаОтгрузки;
						КонецЕсли;
						ПараметрыЗаполнения.ГрафикСоглашенияЗаполнен       = ГрафикСоглашенияЗаполнен;
						ПараметрыЗаполнения.ДатаПереходаПраваСобственности = ДатаПереходаПраваСобственности;
						ПараметрыЗаполнения.ЕстьДатаПереходаПраваСобственности = СтруктураПараметров.ЕстьДатаПереходаПраваСобственности;
						ПараметрыЗаполнения.Соглашение                     = Соглашение;
						ПараметрыЗаполнения.ГрафикИсполненияДоговора       = ГрафикИсполненияДоговора;
						ПараметрыЗаполнения.ГрафикОплаты                   = ГрафикОплаты;
						ПараметрыЗаполнения.СуммаОплаты                    = СуммыДокумента.СуммаДокументаБезЗалога;
						ПараметрыЗаполнения.СуммаЗалогаЗаТару              = СуммыДокумента.СуммаЗалогаЗаТару;
						ПараметрыЗаполнения.СуммаВзаиморасчетов            = СуммыДокумента.СуммаВзаиморасчетовБезЗалога;
						ПараметрыЗаполнения.СуммаВзаиморасчетовПоТаре      = СуммыДокумента.СуммаВзаиморасчетовПоТаре;
						
						ЭтапыОплатыСервер.ЗаполнитьЭтапыОплаты(
								ЭтапыГрафикаОплаты,
								ПараметрыЗаполнения);
								
					КонецЕсли;
				//Перераспределение сумм
				Иначе
						
					Если НакладнаяПоЗаказам 
						И ПорядокРасчетов <> Перечисления.ПорядокРасчетов.ПоНакладным
						//Заказ как счет - распределять ничего не нужно, т.к. заказ не делал движений
						И НЕ (СтруктураПараметров.ДокументРасчетовСКлиентами И СтруктураПараметров.ЗаказКакСчет) 
						И НЕ ЗаданГрафикИсполнения Тогда
						
						РаспределитьСуммыЭтаповОплатыДокументаПоЗаказам(Объект, СтруктураПараметров);
						
					Иначе
						
						ЭтапыОплатыКлиентСервер.РаспределитьСуммуПоЭтапамГрафикаОплаты(
							ЭтапыГрафикаОплаты,
							СуммыДокумента.СуммаДокументаБезЗалога,
							СуммыДокумента.СуммаЗалогаЗаТару,
							СуммыДокумента.СуммаВзаиморасчетовБезЗалога,
							СуммыДокумента.СуммаВзаиморасчетовПоТаре);
						
					КонецЕсли;
					
				КонецЕсли;
				
				ЭтапыОплатыСервер.ЗаполнитьПроцентыПоСуммам(ЭтапыГрафикаОплаты);
				
			КонецЕсли;
			
			Если ТаблицаЭтаповГрафикаОплаты = Неопределено Тогда
				ДополненныеПараметрыМеханизма.ОповеститьОЗаполненииЭтапов = ИСТИНА;
				Если Не ТипЗнч(Объект) = Тип("ФормаКлиентскогоПриложения") Тогда
					Объект.ДополнительныеСвойства.Вставить("ОповеститьОЗаполненииЭтапов", Истина);
				КонецЕсли;
			КонецЕсли;
			
		Иначе
			ЭтапыГрафикаОплаты.Очистить();
		КонецЕсли;
		
	КонецЦикла;
	
	Если ТипЗнч(Объект) = Тип("ФормаКлиентскогоПриложения") Тогда
		ОбновитьТекстГиперссылкиЭтапыОплаты(Объект);
	КонецЕсли;
	
КонецПроцедуры

Процедура ПоместитьЭтапыОплатыВоВременноеХранилище(Форма, ИмяЭлемента) Экспорт
	
	ПараметрыМеханизма = ОбщегоНазначенияУТКлиентСервер.ПолучитьДанныеМеханизмаИзКэшаФормы(Форма, "Взаиморасчеты");
	СтруктураПараметров = ВзаиморасчетыКлиентСервер.СтруктураПараметровПоИмениЭлемента(ПараметрыМеханизма.МассивПараметров, ИмяЭлемента);
	
	ЭтапыОплаты = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.ПутьКДаннымТЧЭтапыОплаты);
	ТЗ = ЭтапыОплаты.Выгрузить();
	
	Если ТЗ.Колонки.Найти("ВариантОплаты") = Неопределено Тогда
		Если СтруктураПараметров.ТипРасчетов = Перечисления.ТипыРасчетовСПартнерами.РасчетыСКлиентом Тогда
			ТЗ.Колонки.Добавить("ВариантОплаты", Новый ОписаниеТипов("ПеречислениеСсылка.ВариантыКонтроляОплатыКлиентом"));
			ТЗ.ЗаполнитьЗначения(Перечисления.ВариантыКонтроляОплатыКлиентом.КредитПослеОтгрузки, "ВариантОплаты");
		Иначе
			ТЗ.Колонки.Добавить("ВариантОплаты", Новый ОписаниеТипов("ПеречислениеСсылка.ВариантыКонтроляОплатыПоставщику"));
			ТЗ.ЗаполнитьЗначения(Перечисления.ВариантыКонтроляОплатыПоставщику.КредитПослеПоступления, "ВариантОплаты");
		КонецЕсли;
	КонецЕсли;
	
	СтруктураПараметров.АдресЭтапыОплаты = ПоместитьВоВременноеХранилище(ТЗ, Новый УникальныйИдентификатор());
	
	Если СтруктураПараметров.ИсточникСуммТабличнаяЧасть Тогда
		ДокументОбъект = Форма.РеквизитФормыВЗначение("Объект");
		СтруктураПараметров.АдресСуммПоЗаказам = ПоместитьСуммыПоЗаказамВоВременноеХранилище(ДокументОбъект);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа) Тогда
		СтруктураПараметров.СуммаРасшифровкиПлатежа = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа).Итог("СуммаВзаиморасчетов");
	КонецЕсли;
	
	ОбщегоНазначенияУТ.СохранитьДанныеМеханизмаВКэшФормы(Форма, "Взаиморасчеты", ПараметрыМеханизма);
	
КонецПроцедуры

Процедура ЗагрузитьЭтапыОплатыИзВременногоХранилища(Форма) Экспорт
	
	ПараметрыМеханизма = ОбщегоНазначенияУТКлиентСервер.ПолучитьДанныеМеханизмаИзКэшаФормы(Форма, "Взаиморасчеты");
	МассивПараметров = ПараметрыМеханизма.МассивПараметров;
	Для Каждого СтруктураПараметров Из МассивПараметров Цикл
		Если ЗначениеЗаполнено(СтруктураПараметров.АдресЭтапыОплаты) Тогда
			
			ЭтапыОплаты = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма,СтруктураПараметров.ПутьКДаннымТЧЭтапыОплаты);
			НовыеЭтапыОплаты = ПолучитьИзВременногоХранилища(СтруктураПараметров.АдресЭтапыОплаты);
			СтарыеЭтапыОплаты = ЭтапыОплаты.Выгрузить();
			
			Если НовыеЭтапыОплаты <> Неопределено Тогда 
				
				ТребуетсяПерезаполнение = Истина;
				Если СтруктураПараметров.ЭтоЗаказ Тогда
					Если ТаблицыРавны(СтарыеЭтапыОплаты, НовыеЭтапыОплаты) Тогда
						ТребуетсяПерезаполнение = Ложь
					Иначе
						СтруктураПараметров.ИзменилосьНесколькоДатОтгрузки = Ложь;
					КонецЕсли;
				КонецЕсли;
				Если ТребуетсяПерезаполнение Тогда
					ЭтапыОплаты.Очистить();
					Для Каждого ТекСтрока Из НовыеЭтапыОплаты Цикл
						НоваяСтрока = ЭтапыОплаты.Добавить();
						ЗаполнитьЗначенияСвойств(НоваяСтрока, ТекСтрока);
					КонецЦикла;
					УдалитьИзВременногоХранилища(СтруктураПараметров.АдресЭтапыОплаты);
					СтруктураПараметров.АдресЭтапыОплаты = ""; 
				КонецЕсли;
			КонецЕсли;
			
			ОбновитьТекстГиперссылкиЭтапыОплаты(Форма, СтруктураПараметров, ПараметрыМеханизма.СистемныеНастройки);
			
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры
// Служебная процедура, заполняет текст гиперссылки правил оплаты 
// 
// Параметры:
//	Форма       - ФормаКлиентскогоПриложения - Договор, указанный в документе:
//	 * Элементы - ЭлементыФормы - элементы вызывающей формы
//	СтруктураПараметров - см. ВзаиморасчетыСервер.ПараметрыМеханизма
//	СистемныеНастройки  - Структура - Системные настройки из дополненных параметров, если уже получены.
//
Процедура ОбновитьТекстГиперссылкиЭтапыОплаты(Форма, СтруктураПараметров = Неопределено, СистемныеНастройки = Неопределено) Экспорт
	
	Если СтруктураПараметров <> Неопределено И СистемныеНастройки <> Неопределено Тогда
		МассивПараметров = Новый Массив;
		МассивПараметров.Добавить(СтруктураПараметров);
	Иначе
		ДополненныеПараметрыМеханизма = ОбщегоНазначенияУТКлиентСервер.ПолучитьДанныеМеханизмаИзКэшаФормы(Форма, "Взаиморасчеты");
		МассивПараметров = ДополненныеПараметрыМеханизма.МассивПараметров;
		СистемныеНастройки = ДополненныеПараметрыМеханизма.СистемныеНастройки;
	КонецЕсли;
	
	Для Каждого СтруктураПараметров Из МассивПараметров Цикл
		
		Если Не ЗначениеЗаполнено(СтруктураПараметров.НадписьЭтапыОплаты) Тогда
			Продолжить;
		КонецЕсли;
		
		Если НЕ СтруктураПараметров.ИзменяетПланОплаты И НЕ СтруктураПараметров.ЗаказКакСчет Тогда
			Форма.Элементы[СтруктураПараметров.ЭлементыФормы.НадписьЭтапы].Видимость = Ложь;
		Иначе
			Форма.Элементы[СтруктураПараметров.ЭлементыФормы.НадписьЭтапы].Видимость = Истина;
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧЭтапыОплаты) Тогда
			ВзаиморасчетыКлиентСервер.ПроверитьОбязательныеПараметры(СтруктураПараметров, "ДатаПлатежа");
		КонецЕсли;
		
		Шаблон = ВзаиморасчетыКлиентСервер.ФорматируемаяСтрокаЭтаповОплаты(Форма, СтруктураПараметров, СистемныеНастройки);
		ФорматированнаяСтрока = СтроковыеФункции.ФорматированнаяСтрока(Шаблон);
		
		Реквизит = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Форма, СтруктураПараметров.НадписьЭтапыОплаты);
		Реквизит.Данные[Реквизит.Имя] = ФорматированнаяСтрока;
		
		Если СтруктураПараметров.ДокументРасчетовСКлиентами Тогда
			Форма.Элементы[СтруктураПараметров.ЭлементыФормы.НадписьЭтапы].Доступность = 
				ПравоДоступа("Просмотр", Метаданные.ОбщиеФормы.ЭтапыОплатыКлиентом);
		Иначе
			Форма.Элементы[СтруктураПараметров.ЭлементыФормы.НадписьЭтапы].Доступность = 
				ПравоДоступа("Просмотр", Метаданные.ОбщиеФормы.ЭтапыОплатыПоставщику);
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область Отчеты

// Добавляет команду отчета "Ведомость расчетов с клиентами" в список команд.
// 
// Параметры:
//   КомандыОтчетов - см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
//
// Возвращаемое значение:
// 	- СтрокаТаблицыЗначений: см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
// 	- Неопределено - Если нет прав на просмотр отчета.
//
Функция ВедомостьРасчетовСКлиентами_ДобавитьКомандуОтчета(КомандыОтчетов) Экспорт
	
	КомандаОтчет = Неопределено;
	Если Константы.НоваяАрхитектураВзаиморасчетов.Получить() Тогда
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.ВедомостьРасчетовСКлиентами) Тогда
			
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.ВедомостьРасчетовСКлиентами.ПолноеИмя();
			КомандаОтчет.Представление = Метаданные.Отчеты.ВедомостьРасчетовСКлиентами.Синоним;
			
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Обычное";
			
		КонецЕсли;
	Иначе
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.РасчетыСКлиентами) Тогда
			
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.РасчетыСКлиентами.ПолноеИмя();
			КомандаОтчет.Представление = Метаданные.Отчеты.РасчетыСКлиентами.Синоним;
			
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Обычное";
			
		КонецЕсли;
	КонецЕсли;
	Возврат КомандаОтчет;
	
КонецФункции

// Добавляет команду отчета "Ведомость расчетов между организациями" в список команд.
// 
// Параметры:
//   КомандыОтчетов - см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
//
// Возвращаемое значение:
// 	- СтрокаТаблицыЗначений: см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
// 	- Неопределено - Если нет прав на просмотр отчета.
//
Функция ВедомостьРасчетовМеждуОрганизациями_ДобавитьКомандуОтчета(КомандыОтчетов) Экспорт
	
	КомандаОтчет = Неопределено;
	Если Константы.НоваяАрхитектураВзаиморасчетов.Получить() Тогда
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.ВедомостьРасчетовМеждуОрганизациями) Тогда
			
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.ВедомостьРасчетовМеждуОрганизациями.ПолноеИмя();
			КомандаОтчет.Представление = Метаданные.Отчеты.ВедомостьРасчетовМеждуОрганизациями.Синоним;
			
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Обычное";
			
		КонецЕсли;
	Иначе
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.РасчетыМеждуОрганизациями) Тогда
			
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.РасчетыМеждуОрганизациями.ПолноеИмя();
			КомандаОтчет.Представление = Метаданные.Отчеты.РасчетыМеждуОрганизациями.Синоним;
			
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Обычное";
			
		КонецЕсли;
	КонецЕсли;
	Возврат КомандаОтчет;
	
КонецФункции

// Добавляет команду отчета "Ведомость расчетов с партнерами" в список команд.
// 
// Параметры:
//   КомандыОтчетов - см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
//
// Возвращаемое значение:
// 	- СтрокаТаблицыЗначений: см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
// 	- Неопределено - Если нет прав на просмотр отчета.
//
Функция ВедомостьРасчетовСПартнерами_ДобавитьКомандуОтчета(КомандыОтчетов) Экспорт
	
	НазваниеОтчета = ?(Константы.ИспользоватьПартнеровКакКонтрагентов.Получить(), НСтр("ru = 'Ведомость расчетов с контрагентами'"), НСтр("ru = 'Ведомость расчетов с партнерами'"));
	
	КомандаОтчет = Неопределено;
	Если Константы.НоваяАрхитектураВзаиморасчетов.Получить() Тогда
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.ВедомостьРасчетовСПартнерами) Тогда
			
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.ВедомостьРасчетовСПартнерами.ПолноеИмя();
			КомандаОтчет.Представление = НазваниеОтчета;
			
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Обычное";
			
		КонецЕсли;
	Иначе
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.РасчетыСПартнерами) Тогда
			
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.РасчетыСПартнерами.ПолноеИмя();
			КомандаОтчет.Представление = НазваниеОтчета;
			
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Обычное";
			
		КонецЕсли;
	КонецЕсли;
	Возврат КомандаОтчет;
	
КонецФункции

// Добавляет команду отчета "Ведомость расчетов с поставщиками" в список команд.
// 
// Параметры:
//   КомандыОтчетов - см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
//
// Возвращаемое значение:
// 	- СтрокаТаблицыЗначений: см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
// 	- Неопределено - Если нет прав на просмотр отчета.
//
Функция ВедомостьРасчетовСПоставщиками_ДобавитьКомандуОтчета(КомандыОтчетов) Экспорт
	
	КомандаОтчет = Неопределено;
	Если Константы.НоваяАрхитектураВзаиморасчетов.Получить() Тогда
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.ВедомостьРасчетовСПоставщиками) Тогда
			
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.ВедомостьРасчетовСПоставщиками.ПолноеИмя();
			КомандаОтчет.Представление = Метаданные.Отчеты.ВедомостьРасчетовСПоставщиками.Синоним;
			
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Обычное";
			
		КонецЕсли;
	Иначе
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.РасчетыСПоставщиками) Тогда
			
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.РасчетыСПоставщиками.ПолноеИмя();
			КомандаОтчет.Представление = Метаданные.Отчеты.РасчетыСПоставщиками.Синоним;
			
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Обычное";
			
		КонецЕсли;
	КонецЕсли;
	Возврат КомандаОтчет;
	
КонецФункции

// Добавляет команду отчета "Задолженность клиентов" в стандартном виде в список команд.
// Отчет группируется по партнерам.
// 
// Параметры:
//   КомандыОтчетов - см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
//
// Возвращаемое значение:
// 	- СтрокаТаблицыЗначений: см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
// 	- Неопределено - Если нет прав на просмотр отчета.
//
Функция ЗадолженностьКлиентов_ДобавитьКомандуОтчета(КомандыОтчетов) Экспорт
	Если Константы.НоваяАрхитектураВзаиморасчетов.Получить() Тогда
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.ЗадолженностьКлиентов) Тогда
			
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.ЗадолженностьКлиентов.ПолноеИмя();
			КомандаОтчет.Представление = Метаданные.Отчеты.ЗадолженностьКлиентов.Синоним;
			
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Важное";
			КомандаОтчет.ФункциональныеОпции = "ИспользоватьДанныеПартнераКлиентаКонтекст";
			КомандаОтчет.ДополнительныеПараметры.Вставить("ИмяКоманды", "СостояниеРасчетовСКлиентом");
			КомандаОтчет.КлючВарианта = "ЗадолженностьКлиентовКонтекст";
			
			Возврат КомандаОтчет;
			
		КонецЕсли;
	Иначе
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.СостояниеРасчетовСКлиентами) Тогда
			
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.СостояниеРасчетовСКлиентами.ПолноеИмя();
			КомандаОтчет.Представление = Метаданные.Отчеты.СостояниеРасчетовСКлиентами.Синоним;
			
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Важное";
			КомандаОтчет.ФункциональныеОпции = "ИспользоватьДанныеПартнераКлиентаКонтекст";
			КомандаОтчет.ДополнительныеПараметры.Вставить("ИмяКоманды", "СостояниеРасчетовСКлиентом");
			КомандаОтчет.КлючВарианта = "ЗадолженностьКлиентовКонтекст";
			
			Возврат КомандаОтчет;
			
		КонецЕсли;
	КонецЕсли;
	Возврат Неопределено;
КонецФункции

// Добавляет команду отчета "Задолженность клиентов" в список команд. 
// Отчет группируется по объекту расчетов.
// 
// Параметры:
//   КомандыОтчетов - см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
//
// Возвращаемое значение:
// 	- СтрокаТаблицыЗначений: см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
// 	- Неопределено - Если нет прав на просмотр отчета.
//
Функция ЗадолженностьКлиентов_ДобавитьКомандуОтчетаПоДокументам(КомандыОтчетов) Экспорт
	Если Константы.НоваяАрхитектураВзаиморасчетов.Получить() Тогда
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.ЗадолженностьКлиентов) Тогда
		
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.ЗадолженностьКлиентов.ПолноеИмя();
			КомандаОтчет.Представление = Метаданные.Отчеты.ЗадолженностьКлиентов.Синоним;
			
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Важное";
			КомандаОтчет.ДополнительныеПараметры.Вставить("ИмяКоманды", "СостояниеРасчетовСКлиентомПоДокументам");
			КомандаОтчет.КлючВарианта = "ЗадолженностьКлиентовПоОбъектуРасчетовКонтекст";
			
			Возврат КомандаОтчет;
		
		КонецЕсли;
	Иначе
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.СостояниеРасчетовСКлиентами) Тогда
			
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.СостояниеРасчетовСКлиентами.ПолноеИмя();
			КомандаОтчет.Представление = Метаданные.Отчеты.СостояниеРасчетовСКлиентами.Синоним;
			
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Важное";
			КомандаОтчет.ДополнительныеПараметры.Вставить("ИмяКоманды", "СостояниеРасчетовСКлиентомПоДокументам");
			КомандаОтчет.КлючВарианта = "ЗадолженностьКлиентовПоОбъектуРасчетовКонтекст";
			
			Возврат КомандаОтчет;
			
		КонецЕсли;
	КонецЕсли;

	Возврат Неопределено;
КонецФункции

// Добавляет команду отчета "Карточка расчетов с клиентом" в список команд.
// Группировка по партнеру/контрагенту.
// 
// Параметры:
//   КомандыОтчетов - см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
//
// Возвращаемое значение:
// 	- СтрокаТаблицыЗначений: см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
// 	- Неопределено - Если нет прав на просмотр отчета.
//
Функция КарточкаРасчетовСКлиентом_ДобавитьКомандуОтчета(КомандыОтчетов) Экспорт
	Если Константы.НоваяАрхитектураВзаиморасчетов.Получить() Тогда
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.КарточкаРасчетовСКлиентами24) Тогда
			
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.КарточкаРасчетовСКлиентами24.ПолноеИмя();
			КомандаОтчет.Представление = Метаданные.Отчеты.КарточкаРасчетовСКлиентами24.Синоним;
			
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Обычное";
			КомандаОтчет.ФункциональныеОпции = "ИспользоватьДанныеПартнераКлиентаКонтекст";
			КомандаОтчет.ДополнительныеПараметры.Вставить("ИмяКоманды", "Карточка");
			КомандаОтчет.КлючВарианта = "Карточка";
			
			Возврат КомандаОтчет;
			
		КонецЕсли;
	Иначе
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.КарточкаРасчетовСКлиентами) Тогда
			
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.КарточкаРасчетовСКлиентами.ПолноеИмя();
			КомандаОтчет.Представление = Метаданные.Отчеты.КарточкаРасчетовСКлиентами.Синоним;
			
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Обычное";
			КомандаОтчет.ФункциональныеОпции = "ИспользоватьДанныеПартнераКлиентаКонтекст";
			КомандаОтчет.ДополнительныеПараметры.Вставить("ИмяКоманды", "КарточкаРасчетовСКлиентом");
			КомандаОтчет.КлючВарианта = "КарточкаРасчетовСКлиентамиКонтекст";
			
			Возврат КомандаОтчет;
			
		КонецЕсли;
	КонецЕсли;
	
	Возврат Неопределено;
КонецФункции

// Добавляет команду отчета "Карточка расчетов с клиентом" в список команд.
// Группировка по объекту расчетов.
// 
// Параметры:
//   КомандыОтчетов - см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
//
// Возвращаемое значение:
// 	- СтрокаТаблицыЗначений: см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
// 	- Неопределено - Если нет прав на просмотр отчета.
//
Функция КарточкаРасчетовСКлиентом_ДобавитьКомандуОтчетаПоДокументам(КомандыОтчетов) Экспорт
	Если Константы.НоваяАрхитектураВзаиморасчетов.Получить() Тогда
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.КарточкаРасчетовСКлиентами24) Тогда
			
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.КарточкаРасчетовСКлиентами24.ПолноеИмя();
			КомандаОтчет.Представление = Метаданные.Отчеты.КарточкаРасчетовСКлиентами24.Синоним;
			
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Важное";
			КомандаОтчет.ДополнительныеПараметры.Вставить("ИмяКоманды", "Карточка");
			КомандаОтчет.КлючВарианта = "Карточка";
			
			Возврат КомандаОтчет;
			
		КонецЕсли;
	Иначе
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.КарточкаРасчетовСКлиентами) Тогда
			
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.КарточкаРасчетовСКлиентами.ПолноеИмя();
			КомандаОтчет.Представление = Метаданные.Отчеты.КарточкаРасчетовСКлиентами.Синоним;
			
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Важное";
			КомандаОтчет.ДополнительныеПараметры.Вставить("ИмяКоманды", "КарточкаРасчетовСКлиентомПоДокументам");
			КомандаОтчет.КлючВарианта = "КарточкаРасчетовСКлиентамиПоДокументамКонтекст";
			
			Возврат КомандаОтчет;
			
		КонецЕсли;
	КонецЕсли;
	
	Возврат Неопределено;
КонецФункции

// Добавляет команду отчета "Задолженность поставщикам" в стандартном виде в список команд.
// Отчет группируется по партнерам.
// 
// Параметры:
//   КомандыОтчетов - см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
//
// Возвращаемое значение:
// 	- СтрокаТаблицыЗначений: см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
// 	- Неопределено - Если нет прав на просмотр отчета.
//
Функция ЗадолженностьПоставщикам_ДобавитьКомандуОтчета(КомандыОтчетов) Экспорт
	Если Константы.НоваяАрхитектураВзаиморасчетов.Получить() Тогда
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.ЗадолженностьПоставщикам) Тогда
			
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.ЗадолженностьПоставщикам.ПолноеИмя();
			КомандаОтчет.Представление = Метаданные.Отчеты.ЗадолженностьПоставщикам.Синоним;
			
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Важное";
			КомандаОтчет.ФункциональныеОпции = "ИспользоватьДанныеПартнераПоставщикаКонтекст";
			КомандаОтчет.ДополнительныеПараметры.Вставить("ИмяКоманды", "СостояниеРасчетовСПоставщиком");
			КомандаОтчет.КлючВарианта = "ЗадолженностьПоставщикамКонтекст";
			
			Возврат КомандаОтчет;
			
		КонецЕсли;
	Иначе
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.СостояниеРасчетовСПоставщиками) Тогда
			
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.СостояниеРасчетовСПоставщиками.ПолноеИмя();
			КомандаОтчет.Представление = Метаданные.Отчеты.СостояниеРасчетовСПоставщиками.Синоним;
			
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Важное";
			КомандаОтчет.ФункциональныеОпции = "ИспользоватьДанныеПартнераПоставщикаКонтекст";
			КомандаОтчет.ДополнительныеПараметры.Вставить("ИмяКоманды", "СостояниеРасчетовСПоставщиком");
			КомандаОтчет.КлючВарианта = "ЗадолженностьПоставщикамКонтекст";
			
			Возврат КомандаОтчет;
			
		КонецЕсли;
	КонецЕсли;

	Возврат Неопределено;
КонецФункции

// Добавляет команду отчета "Задолженность поставщикам" в список команд. 
// Отчет группируется по объекту расчетов.
// 
// Параметры:
//   КомандыОтчетов - см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
//
// Возвращаемое значение:
// 	- СтрокаТаблицыЗначений: см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
// 	- Неопределено - Если нет прав на просмотр отчета.
//
Функция ЗадолженностьПоставщикам_ДобавитьКомандуОтчетаПоДокументам(КомандыОтчетов) Экспорт
	Если Константы.НоваяАрхитектураВзаиморасчетов.Получить() Тогда
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.ЗадолженностьПоставщикам) Тогда
			
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.ЗадолженностьПоставщикам.ПолноеИмя();
			КомандаОтчет.Представление = Метаданные.Отчеты.ЗадолженностьПоставщикам.Синоним;
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Важное";
			КомандаОтчет.ДополнительныеПараметры.Вставить("ИмяКоманды", "СостояниеРасчетовСПоставщикомПоДокументам");
			КомандаОтчет.КлючВарианта = "ЗадолженностьПоставщикамПоОбъектуРасчетовКонтекст";
			
			Возврат КомандаОтчет;
			
		КонецЕсли;
	Иначе
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.СостояниеРасчетовСПоставщиками) Тогда
			
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.СостояниеРасчетовСПоставщиками.ПолноеИмя();
			КомандаОтчет.Представление = Метаданные.Отчеты.СостояниеРасчетовСПоставщиками.Синоним;
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Важное";
			КомандаОтчет.ДополнительныеПараметры.Вставить("ИмяКоманды", "СостояниеРасчетовСПоставщикомПоДокументам");
			КомандаОтчет.КлючВарианта = "ЗадолженностьПоставщикамПоОбъектуРасчетовКонтекст";
			
			Возврат КомандаОтчет;
			
		КонецЕсли;
	КонецЕсли;

	Возврат Неопределено;
КонецФункции

// Добавляет команду отчета "Карточка расчетов с поставщиком" в список команд.
// Группировка по партнеру/контрагенту.
// 
// Параметры:
//   КомандыОтчетов - см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
//
// Возвращаемое значение:
// 	- СтрокаТаблицыЗначений: см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
// 	- Неопределено - Если нет прав на просмотр отчета.
//
Функция КарточкаРасчетовСПоставщиком_ДобавитьКомандуОтчета(КомандыОтчетов) Экспорт
	Если Константы.НоваяАрхитектураВзаиморасчетов.Получить() Тогда
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.КарточкаРасчетовСПоставщиками24) Тогда
			
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.КарточкаРасчетовСПоставщиками24.ПолноеИмя();
			КомандаОтчет.Представление = Метаданные.Отчеты.КарточкаРасчетовСПоставщиками24.Синоним;
			
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Обычное";
			КомандаОтчет.ФункциональныеОпции = "ИспользоватьДанныеПартнераПоставщикаКонтекст";
			КомандаОтчет.ДополнительныеПараметры.Вставить("ИмяКоманды", "Карточка");
			КомандаОтчет.КлючВарианта = "Карточка";
			
			Возврат КомандаОтчет;
			
		КонецЕсли;
	Иначе
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.КарточкаРасчетовСПоставщиками) Тогда
			
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.КарточкаРасчетовСПоставщиками.ПолноеИмя();
			КомандаОтчет.Представление = Метаданные.Отчеты.КарточкаРасчетовСПоставщиками.Синоним;
			
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Обычное";
			КомандаОтчет.ФункциональныеОпции = "ИспользоватьДанныеПартнераПоставщикаКонтекст";
			КомандаОтчет.ДополнительныеПараметры.Вставить("ИмяКоманды", "КарточкаРасчетовСПоставщиком");
			КомандаОтчет.КлючВарианта = "КарточкаРасчетовСПоставщикамиКонтекст";
			
			Возврат КомандаОтчет;
			
		КонецЕсли;
	КонецЕсли;
	
	Возврат Неопределено;
КонецФункции

// Добавляет команду отчета "Карточка расчетов с поставщиком" в список команд.
// Группировка по объекту расчетов.
// 
// Параметры:
//   КомандыОтчетов - см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
//
// Возвращаемое значение:
// 	- СтрокаТаблицыЗначений: см. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
// 	- Неопределено - Если нет прав на просмотр отчета.
//
Функция КарточкаРасчетовСПоставщиком_ДобавитьКомандуОтчетаПоДокументам(КомандыОтчетов) Экспорт
	Если Константы.НоваяАрхитектураВзаиморасчетов.Получить() Тогда
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.КарточкаРасчетовСПоставщиками24) Тогда
			
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.КарточкаРасчетовСПоставщиками24.ПолноеИмя();
			КомандаОтчет.Представление = Метаданные.Отчеты.КарточкаРасчетовСПоставщиками24.Синоним;
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Важное";
			КомандаОтчет.ДополнительныеПараметры.Вставить("ИмяКоманды", "Карточка");
			КомандаОтчет.КлючВарианта = "Карточка";
			
			Возврат КомандаОтчет;
			
		КонецЕсли;
	Иначе
		Если ПравоДоступа("Просмотр", Метаданные.Отчеты.КарточкаРасчетовСПоставщиками) Тогда
			
			КомандаОтчет = КомандыОтчетов.Добавить();
			
			КомандаОтчет.Менеджер = Метаданные.Отчеты.КарточкаРасчетовСПоставщиками.ПолноеИмя();
			КомандаОтчет.Представление = Метаданные.Отчеты.КарточкаРасчетовСПоставщиками.Синоним;
			КомандаОтчет.МножественныйВыбор = Истина;
			КомандаОтчет.Важность = "Важное";
			КомандаОтчет.ДополнительныеПараметры.Вставить("ИмяКоманды", "КарточкаРасчетовСПоставщикомПоДокументам");
			КомандаОтчет.КлючВарианта = "КарточкаРасчетовСПоставщикамиПоДокументамКонтекст";
			
			Возврат КомандаОтчет;
			
		КонецЕсли;
	КонецЕсли;
	
	Возврат Неопределено;
КонецФункции

#КонецОбласти

#Область ЗачетОплатыРасшифровкаПлатежа

//Заполняет табличные части "Расшифровка платежа" остатками задолженности.
//
// Параметры:
// 	Форма - ФормаКлиентскогоПриложения - Форма документа/справочника.
// 	РасшифровкаПлатежа - ТаблицаЗначений - таблица для заполнения
// 
Процедура ЗаполнитьРасшифровкуПлатежаОстатками(Форма, РасшифровкаПлатежа) Экспорт
	
	ДополненныеПараметрыМеханизма = ОбщегоНазначенияУТКлиентСервер.ПолучитьДанныеМеханизмаИзКэшаФормы(Форма, "Взаиморасчеты");
	
	Для Каждого СтруктураПараметров Из ДополненныеПараметрыМеханизма.МассивПараметров Цикл
		
		Организация = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.Организация);
		Контрагент = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.Контрагент);
		Дата = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.Дата);
		Валюта = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.ВалютаДокумента);
		
		ТипЗадолженности = ?(СтруктураПараметров.ДокументРасчетовСКлиентами, Перечисления.ТипыЗадолженности.Дебиторская, Перечисления.ТипыЗадолженности.Кредиторская);
		
		ЗаполнитьЗадолженностьПоОстаткам(
			Организация, 
			Контрагент,
			ТипЗадолженности,
			Неопределено, //ТипРасчетов
			Дата,
			Валюта,
			РасшифровкаПлатежа);
		Если РасшифровкаПлатежа.Количество() = 0 Тогда
			РасшифровкаПлатежа.Добавить();
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

//Помещает табличную часть Расшифровка платежа во временное хранилище и записывает ссылку на него в структуру параметров взаиморасчетов.
//
// Параметры:
// 	Форма - ФормаКлиентскогоПриложения - Форма документа/справочника.
// 	ИмяЭлемента - Строка - Имя элемента, по которому можно определить для какой структуры параметров взаиморасчетов помещается расшифровка.
//
Процедура ПоместитьРасшифровкуПлатежаВоВременноеХранилище(Форма, ИмяЭлемента = Неопределено) Экспорт
	
	ПараметрыМеханизма = ОбщегоНазначенияУТКлиентСервер.ПолучитьДанныеМеханизмаИзКэшаФормы(Форма, "Взаиморасчеты");
	Если ИмяЭлемента <> Неопределено Тогда
		СтруктураПараметров = ВзаиморасчетыКлиентСервер.СтруктураПараметровПоИмениЭлемента(ПараметрыМеханизма.МассивПараметров, ИмяЭлемента);
	Иначе
		СтруктураПараметров = ПараметрыМеханизма.МассивПараметров[0];
	КонецЕсли;
	
	РасшифровкаПлатежа = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа);
	ТЗ = РасшифровкаПлатежа.Выгрузить();
	СтруктураПараметров.АдресРасшифровкаПлатежа = ПоместитьВоВременноеХранилище(ТЗ, Новый УникальныйИдентификатор());
	
	ОбщегоНазначенияУТ.СохранитьДанныеМеханизмаВКэшФормы(Форма, "Взаиморасчеты", ПараметрыМеханизма);
	
КонецПроцедуры

Процедура ЗагрузитьРасшифровкуПлатежаИзВременногоХранилища(Форма) Экспорт
	
	ПараметрыМеханизма = ОбщегоНазначенияУТКлиентСервер.ПолучитьДанныеМеханизмаИзКэшаФормы(Форма, "Взаиморасчеты");
	МассивПараметров = ПараметрыМеханизма.МассивПараметров;
	Для Каждого СтруктураПараметров Из МассивПараметров Цикл
		Если ЗначениеЗаполнено(СтруктураПараметров.АдресРасшифровкаПлатежа) Тогда
			
			РасшифровкаПлатежа = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа);
			НоваяРасшифровкаПлатежа = ПолучитьИзВременногоХранилища(СтруктураПараметров.АдресРасшифровкаПлатежа);
			Копия = РасшифровкаПлатежа.Выгрузить();
			
			РасшифровкаПлатежа.Очистить();
			Для Каждого ТекСтрока Из НоваяРасшифровкаПлатежа Цикл
				НоваяСтрока = РасшифровкаПлатежа.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, ТекСтрока);
				Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(НоваяСтрока, "Поставщик") 
					И ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ТекСтрока, "Партнер") Тогда
					НоваяСтрока.Поставщик = ТекСтрока.Партнер;
				КонецЕсли;
				Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(НоваяСтрока, "СтатьяДвиженияДенежныхСредств") Тогда
					СтрокиКопии = Копия.НайтиСтроки(Новый Структура("ОбъектРасчетов", НоваяСтрока.ОбъектРасчетов));
					Если СтрокиКопии.Количество()> 0 Тогда
						НоваяСтрока.СтатьяДвиженияДенежныхСредств = СтрокиКопии[0].СтатьяДвиженияДенежныхСредств;
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;
			
			УдалитьИзВременногоХранилища(СтруктураПараметров.АдресРасшифровкаПлатежа);
			СтруктураПараметров.АдресРасшифровкаПлатежа = "";
			
		КонецЕсли;
	КонецЦикла;
	
	ЗаблокироватьОбъектыРасчетов(Форма);
	
КонецПроцедуры

Процедура ОбновитьРаспределеннуюСуммаРасшифровки(Форма) Экспорт
	
	Если НЕ ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(Форма,"РаспределеннаяСуммаРасшифровки") Тогда
		Возврат;
	КонецЕсли;
	
	ДополненныеПараметрыМеханизма = ОбщегоНазначенияУТКлиентСервер.ПолучитьДанныеМеханизмаИзКэшаФормы(Форма, "Взаиморасчеты");
	МассивПараметров = ДополненныеПараметрыМеханизма.МассивПараметров;
	
	Для Каждого СтруктураПараметров Из МассивПараметров Цикл
		Организация            = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.Организация);
		ТипРасчетов            = СтруктураПараметров.ТипРасчетов;
		
		Если ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа) Тогда
			ТЧ = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа);
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	СуммаРаспределнная = 0;
	
	Если ТЧ <> Неопределено Тогда
		ОбъектРасчетов = Новый Массив;
		ОбъектРасчетов.Добавить(ОбъектыРасчетовСервер.ПолучитьОбъектРасчетовПоСсылке(
			ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.Ссылка), Организация, ТипРасчетов));
		ОбъектРасчетов.Добавить(ОбъектыРасчетовСервер.ПолучитьОбъектРасчетовПоСсылке(
			ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.Договор), Организация, ТипРасчетов));
		Если ЗначениеЗаполнено( СтруктураПараметров.ЗаказОснование) Тогда
			ОбъектРасчетов.Добавить(ОбъектыРасчетовСервер.ПолучитьОбъектРасчетовПоСсылке(
				ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.ЗаказОснование), Организация, ТипРасчетов));
		КонецЕсли;
		
		Запрос = Новый Запрос("
		|ВЫБРАТЬ
		|	Расшифровка.Сумма КАК Сумма,
		|	Расшифровка.ОбъектРасчетов КАК ОбъектРасчетов
		|ПОМЕСТИТЬ ВтРасшифровка 
		|ИЗ &ТЧ КАК Расшифровка
		|;
		|ВЫБРАТЬ
		|	СУММА(Расшифровка.Сумма) КАК Сумма
		|ИЗ
		|	ВтРасшифровка КАК Расшифровка
		|ГДЕ
		|	НЕ Расшифровка.ОбъектРасчетов В (&ОбъектРасчетов)
		|	И Расшифровка.ОбъектРасчетов <> ЗНАЧЕНИЕ(Справочник.ОбъектыРасчетов.ПустаяСсылка)");
		Запрос.УстановитьПараметр("ТЧ", ТЧ.Выгрузить());
		Запрос.УстановитьПараметр("ОбъектРасчетов", ОбъектРасчетов);
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			СуммаРаспределнная =  Выборка.Сумма;
		КонецЕсли;
	КонецЕсли;
	
	Форма.РаспределеннаяСуммаРасшифровки = СуммаРаспределнная;
	
КонецПроцедуры

Процедура ЗаблокироватьОбъектыРасчетов(Форма) Экспорт
	
	РазблокироватьДанныеДляРедактирования(,Форма.УникальныйИдентификатор);
	
	ПараметрыМеханизма = ОбщегоНазначенияУТКлиентСервер.ПолучитьДанныеМеханизмаИзКэшаФормы(Форма, "Взаиморасчеты");
	МассивПараметров = ПараметрыМеханизма.МассивПараметров;
	Для Каждого СтруктураПараметров Из МассивПараметров Цикл
		Если ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа) Тогда
			РасшифровкаПлатежа = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа);
			Для Каждого Стр Из РасшифровкаПлатежа Цикл
				Если ЗначениеЗаполнено(Стр.ОбъектРасчетов) Тогда
					//@skip-warning
					Попытка
						ЗаблокироватьДанныеДляРедактирования(Стр.ОбъектРасчетов,,Форма.УникальныйИдентификатор);
					Исключение
					КонецПопытки;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область ГиперссылкаРасчеты

// Описание
// 
// Параметры:
// 	Форма - ФормаКлиентскогоПриложения - 
Процедура ОбновитьТекстГиперссылкиСостояниеРасчетов(Форма) Экспорт
	
	ДополненныеПараметрыМеханизма = ОбщегоНазначенияУТКлиентСервер.ПолучитьДанныеМеханизмаИзКэшаФормы(Форма, "Взаиморасчеты");
	НоваяАрхитектураВзаиморасчетов = ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов");
	Для Каждого СтруктураПараметров Из ДополненныеПараметрыМеханизма.МассивПараметров Цикл
		
		Если Не ЗначениеЗаполнено(СтруктураПараметров.ЭлементыФормы.НадписьРасчеты) Тогда
			Продолжить;
		КонецЕсли;
		
		ПорядокРасчетов       = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.ПорядокРасчетов);
		ВалютаВзаиморасчетов  = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.ВалютаВзаиморасчетов);
		НакладнаяПоЗаказам    = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.НакладнаяПоЗаказам, , Ложь);
		ЗаказОснование        = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.ЗаказОснование);
		ИзменяетРасчеты       = СтруктураПараметров.ИзменяетПланОплаты;
		ЭлементНадписьРасчеты = СтруктураПараметров.ЭлементыФормы.НадписьРасчеты;
		ЭтоЗаказ              = СтруктураПараметров.ЭтоЗаказ;
		ЭтоСправочник         = СтруктураПараметров.ЭтоСправочник;
		
		СписокЗаказов = ПолучитьМассивЗаказовИзТЧ(Форма, СтруктураПараметров);
		
		Если ЗначениеЗаполнено(ЭлементНадписьРасчеты) Тогда
			
			Элемент = Форма.Элементы[ЭлементНадписьРасчеты]; // ПолеФормы
			
			Если ИзменяетРасчеты 
				//Не заказ с расчетами по накладным
				И НЕ (ЭтоЗаказ И ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоНакладным)
				//Не договор без графика
				И НЕ (ЭтоСправочник И НЕ ЗначениеЗаполнено(СтруктураПараметров.ГрафикИсполненияДоговора)) Тогда
					
				Если ЭтоСправочник Тогда
					
					ТекстПредупреждения = "";
					Если НЕ ОтложенноеОбновлениеРегистровВзаиморасчетовЗавершено() Тогда
						ТекстПредупреждения = НСтр("ru = 'Данные могут быть неточными, выполняется обновление ИБ.'");
					КонецЕсли;
					
					Если СтруктураПараметров.ДокументРасчетовСКлиентами Тогда
						СтрокаОтгружено = НСтр("ru = 'Отгружено'");
					Иначе
						СтрокаОтгружено = НСтр("ru = 'Поступило'");
					КонецЕсли;
					
					СостояниеВзаиморасчетов = ВзаиморасчетыСервер.СостояниеВзаиморасчетов(Форма, СтруктураПараметров);
					СуммаОплат   = СостояниеВзаиморасчетов.СуммаОплат;
					ПроцентОплат = ОкруглитьПроценты(СостояниеВзаиморасчетов.ПроцентОплат);
					СуммаОтгрузокПоставок = СостояниеВзаиморасчетов.СуммаОтгрузок + СостояниеВзаиморасчетов.СуммаПоставок;
					ПроцентОтгрузкиПоставки = ОкруглитьПроценты(СостояниеВзаиморасчетов.ПроцентОтгрузок + СостояниеВзаиморасчетов.ПроцентПоставок);
				
					Расчеты = НСтр("ru = 'Оплачено'") + ": " + Формат(СуммаОплат, "ЧДЦ=2; ЧН=") 
						+ " " + ВалютаВзаиморасчетов + "  " + ПроцентОплат + "%";
					Элемент.Заголовок = Расчеты + ", " + СтрокаОтгружено + ": " + Формат(СуммаОтгрузокПоставок, "ЧДЦ=2; ЧН=") 
						+ " " + ВалютаВзаиморасчетов + "  " + ПроцентОтгрузкиПоставки + "%"
						+ ?(ПустаяСтрока(ТекстПредупреждения), "", " ") + ТекстПредупреждения;
					
				ИначеЕсли ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоДоговорамКонтрагентов Тогда
					
					ТекстПредупреждения = "";
					Если НЕ ОтложенноеОбновлениеРегистровВзаиморасчетовЗавершено() Тогда
						ТекстПредупреждения = НСтр("ru = 'Данные могут быть неточными, выполняется обновление ИБ.'");
					КонецЕсли;
					
					СостояниеВзаиморасчетов = ВзаиморасчетыСервер.СостояниеВзаиморасчетов(Форма, СтруктураПараметров);
					ТипРасчетов = СтруктураПараметров.ТипРасчетов;
					КонечноеСальдо = СостояниеВзаиморасчетов.СуммаЗадолженности;
					Если КонечноеСальдо < 0  Тогда
						ТекстСальдо = НСтр("ru = 'оплачено'");
						КонечноеСальдо = - КонечноеСальдо;
					ИначеЕсли ТипРасчетов = Перечисления.ТипыРасчетовСПартнерами.РасчетыСКлиентом Тогда 
						ТекстСальдо = НСтр("ru = 'долг клиента'");
					Иначе
						ТекстСальдо = НСтр("ru = 'долг поставщику'");
					КонецЕсли;
					Элемент.Заголовок = НСтр("ru = 'Расчеты по договору'") + ": " + ТекстСальдо 
						+ " " + Формат(КонечноеСальдо, "ЧДЦ=2; ЧН=0,00;") + " " + ВалютаВзаиморасчетов
						+ ?(ПустаяСтрока(ТекстПредупреждения), "", " ") + ТекстПредупреждения;
				ИначеЕсли ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоДоговорамНакладным И ЭтоЗаказ Тогда
					Элемент.Заголовок = НСтр("ru = 'Расчеты по договору и накладным'");
				Иначе
					
					ТекстПредупреждения = "";
					Если НЕ ОтложенноеОбновлениеРегистровВзаиморасчетовЗавершено() Тогда
						ТекстПредупреждения = НСтр("ru = 'Данные могут быть неточными, выполняется обновление ИБ.'");
					КонецЕсли;
					
					СостояниеВзаиморасчетов = ВзаиморасчетыСервер.СостояниеВзаиморасчетов(Форма, СтруктураПараметров);
					СуммаОплат   = Макс(0, СостояниеВзаиморасчетов.СуммаОплат);
					ПроцентОплат = Макс(0, ОкруглитьПроценты(СостояниеВзаиморасчетов.ПроцентОплат));
					
					Если ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоЗаказам И НакладнаяПоЗаказам И ЗначениеЗаполнено(ЗаказОснование)
						ИЛИ ЭтоЗаказ Тогда
						Элемент.Заголовок = НСтр("ru = 'Оплачено по заказу:'") + " " + Формат(СуммаОплат, "ЧДЦ=2; ЧН=") + " " + ВалютаВзаиморасчетов + " " + ПроцентОплат + "%"
							+ ?(ПустаяСтрока(ТекстПредупреждения), "", " ") + ТекстПредупреждения;
					ИначеЕсли СписокЗаказов.Количество() > 1 И ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоЗаказам Тогда
						Элемент.Заголовок = НСтр("ru = 'Расчеты по заказам ('")+ Строка(СписокЗаказов.Количество()) + ")";
					Иначе
						Элемент.Заголовок = НСтр("ru = 'Оплачено'") + ": " + Формат(СуммаОплат, "ЧДЦ=2; ЧН=") + " " + ВалютаВзаиморасчетов + " " + ПроцентОплат + "%"
							+ ?(ПустаяСтрока(ТекстПредупреждения), "", " ") + ТекстПредупреждения;
					КонецЕсли;
				
				КонецЕсли;
				ОбщегоНазначенияУТКлиентСервер.УстановитьСвойствоЭлементаФормы(Форма.Элементы, ЭлементНадписьРасчеты, "Видимость", Истина);
			ИначеЕсли ЭтоСправочник И ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоДоговорамНакладным И НоваяАрхитектураВзаиморасчетов Тогда
				
				ТекстПредупреждения = "";
				Если НЕ ОтложенноеОбновлениеРегистровВзаиморасчетовЗавершено() Тогда
					ТекстПредупреждения = НСтр("ru = 'Данные могут быть неточными, выполняется обновление ИБ.'");
				КонецЕсли;
				
				Если СтруктураПараметров.ДокументРасчетовСКлиентами Тогда
					СтрокаОтгружено = НСтр("ru = 'Отгружено'");
				Иначе
					СтрокаОтгружено = НСтр("ru = 'Поступило'");
				КонецЕсли;
				
				СостояниеВзаиморасчетов = ВзаиморасчетыСервер.СостояниеВзаиморасчетов(Форма, СтруктураПараметров);
				СуммаОплат   = СостояниеВзаиморасчетов.СуммаОплат;
				ПроцентОплат = ОкруглитьПроценты(СостояниеВзаиморасчетов.ПроцентОплат);
				СуммаОтгрузокПоставок = СостояниеВзаиморасчетов.СуммаОтгрузок + СостояниеВзаиморасчетов.СуммаПоставок;
				ПроцентОтгрузкиПоставки = ОкруглитьПроценты(СостояниеВзаиморасчетов.ПроцентОтгрузок + СостояниеВзаиморасчетов.ПроцентПоставок);
			
				Расчеты = НСтр("ru = 'Оплачено'") + ": " + Формат(СуммаОплат, "ЧДЦ=2; ЧН=") 
					+ " " + ВалютаВзаиморасчетов + ?(ИзменяетРасчеты, "  " + ПроцентОплат + "%", "");
				Элемент.Заголовок = Расчеты + ", " + СтрокаОтгружено + ": " + Формат(СуммаОтгрузокПоставок, "ЧДЦ=2; ЧН=") 
					+ " " + ВалютаВзаиморасчетов + ?(ИзменяетРасчеты, "  " + ПроцентОтгрузкиПоставки + "%", "")
					+ ?(ПустаяСтрока(ТекстПредупреждения), "", " ") + ТекстПредупреждения;
				ОбщегоНазначенияУТКлиентСервер.УстановитьСвойствоЭлементаФормы(Форма.Элементы, ЭлементНадписьРасчеты, "Видимость", Истина);
			Иначе
				ОбщегоНазначенияУТКлиентСервер.УстановитьСвойствоЭлементаФормы(Форма.Элементы, ЭлементНадписьРасчеты, "Видимость", Ложь);
			КонецЕсли;
		
			Если СтруктураПараметров.ДокументРасчетовСКлиентами Тогда
				Элемент.Доступность = ПравоДоступа("Использование", Метаданные.Отчеты.КарточкаРасчетовСКлиентами24);
			ИначеЕсли СтруктураПараметров.ДокументРасчетовСПоставщиками Тогда
				Элемент.Доступность = ПравоДоступа("Использование", Метаданные.Отчеты.КарточкаРасчетовСПоставщиками24);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

#Область СуммыВзаиморасчетов

// Процедура проверяет и заполняет суммы взаиморасчетов в табличной части объекта
// 
// Параметры:
//  Объект - ДокументОбъект, СправочникОбъект, ФормаКлиентскогоПриложения - Проверяемый объект
//  СтруктураПараметров - см. ПараметрыМеханизма
Процедура ПроверитьЗаполнитьСуммыВзаиморасчетовВТабличнойЧасти(Объект, СтруктураПараметров) Экспорт
	
	Если Не ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧ) ИЛИ Не ЗначениеЗаполнено(СтруктураПараметров.СуммаВзаиморасчетов) Тогда
		Возврат;
	КонецЕсли;
	
	ВзаиморасчетыКлиентСервер.ПроверитьОбязательныеПараметры(СтруктураПараметров,
		"ПутьКДаннымТЧ, КурсЧислитель, КурсЗнаменатель, СуммаВзаиморасчетов,
		| ВалютаДокумента, ВалютаВзаиморасчетов, ИмяРеквизитаТЧСуммаСНДС, Организация");
	
	ДанныеТЧ             = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ПутьКДаннымТЧ); // ТабличнаяЧасть
	КурсЧислитель        = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.КурсЧислитель);
	КурсЗнаменатель      = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.КурсЗнаменатель);
	СуммаВзаиморасчетов  = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.СуммаВзаиморасчетов);
	ВалютаДокумента      = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ВалютаДокумента);
	ВалютаВзаиморасчетов = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ВалютаВзаиморасчетов);
	Организация          = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Организация);
	ИмяСуммаСНДС         = СтруктураПараметров.ИмяРеквизитаТЧСуммаСНДС;
	ВернутьМногооборотнуюТару = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ВернутьМногооборотнуюТару,,Ложь);
	ТребуетсяЗалогЗаТару      = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ТребуетсяЗалогЗаТару,,Ложь);
	ЕстьНезалоговаяТара = ВернутьМногооборотнуюТару И НЕ ТребуетсяЗалогЗаТару;
	
	ВалютаРегламентированногоУчета = ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(Организация);
	
	Если ДанныеТЧ = Неопределено Тогда 
		Возврат;
	КонецЕсли;
	
	ТЗ = ДанныеТЧ.Выгрузить();
	ЕстьСуммаВзаиморасчетов = ТЗ.Колонки.Найти("СуммаВзаиморасчетов") <> Неопределено;
	
	Если НЕ ЕстьСуммаВзаиморасчетов Тогда
		Возврат;
	КонецЕсли;
	
	ЕстьСуммаНДСВзаиморасчетов = ТЗ.Колонки.Найти("СуммаНДСВзаиморасчетов") <> Неопределено;
	
	//Если в документе есть незалоговая тара, то сумму взаиморасчетов не распределяем на строки с тарой.
	МассивПропускаемойНоменклатуры = Новый Массив;
	Если ЕстьНезалоговаяТара Тогда
		МассивНоменклатуры = ТЗ.ВыгрузитьКолонку("Номенклатура");
		МассивНоменклатуры = ОбщегоНазначенияКлиентСервер.СвернутьМассив(МассивНоменклатуры);
		МассивРеквизитов = ОбщегоНазначения.ЗначениеРеквизитаОбъектов(МассивНоменклатуры,"ТипНоменклатуры");
		Для Каждого Номенклатура Из МассивНоменклатуры Цикл
			Если МассивРеквизитов[Номенклатура] = Перечисления.ТипыНоменклатуры.МногооборотнаяТара Тогда
				МассивПропускаемойНоменклатуры.Добавить(Номенклатура);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	СтруктураПоиска = Новый Структура("СуммаВзаиморасчетов", 0);
	
	СуммаВзаиморасчетовТЧПлюс  = 0;
	СуммаВзаиморасчетовТЧМинус = 0;
	СуммаПлюс                  = 0;
	СуммаМинус                 = 0;
	
	Для Каждого Стр Из ДанныеТЧ Цикл
		Если ЕстьНезалоговаяТара И МассивПропускаемойНоменклатуры.Найти(Стр.Номенклатура) <> Неопределено Тогда
			Продолжить;
		КонецЕсли;
		Если Стр[ИмяСуммаСНДС] > 0 Тогда
			СуммаПлюс = СуммаПлюс + Стр[ИмяСуммаСНДС];
			Если ЗначениеЗаполнено(Стр.СуммаВзаиморасчетов) Тогда
				СуммаВзаиморасчетовТЧПлюс = СуммаВзаиморасчетовТЧПлюс + Стр.СуммаВзаиморасчетов;
			КонецЕсли;
		Иначе
			СуммаМинус = СуммаМинус + Стр[ИмяСуммаСНДС];
			Если ЗначениеЗаполнено(Стр.СуммаВзаиморасчетов) Тогда
				СуммаВзаиморасчетовТЧМинус = СуммаВзаиморасчетовТЧМинус + Стр.СуммаВзаиморасчетов;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	СуммаВзаиморасчетовПоТЧ = ДанныеТЧ.Итог("СуммаВзаиморасчетов");
	
	Если ДанныеТЧ.НайтиСтроки(СтруктураПоиска).Количество() = 0
		И СуммаВзаиморасчетов = СуммаВзаиморасчетовПоТЧ 
		И (НЕ ЕстьСуммаНДСВзаиморасчетов ИЛИ ДанныеТЧ.НайтиСтроки(Новый Структура("СуммаНДСВзаиморасчетов",0)).Количество() = 0) Тогда
		Возврат;
	ИначеЕсли СуммаПлюс = 0 
			И СуммаМинус = 0 Тогда
		ОчиститьСуммыВзаиморасчетовТЧ(Объект, СтруктураПараметров);
		Возврат;
	КонецЕсли;
	
	Если ВалютаДокумента = ВалютаВзаиморасчетов Тогда
		
		Для Индекс = 0 По ДанныеТЧ.Количество()-1 Цикл
			Если ЕстьНезалоговаяТара И МассивПропускаемойНоменклатуры.Найти(ДанныеТЧ[Индекс].Номенклатура) <> Неопределено Тогда
				Продолжить;
			КонецЕсли;
			Если Не ЗначениеЗаполнено(ДанныеТЧ[Индекс].СуммаВзаиморасчетов)
			 ИЛИ ДанныеТЧ[Индекс].СуммаВзаиморасчетов <> ДанныеТЧ[Индекс][ИмяСуммаСНДС] Тогда
				ДанныеТЧ[Индекс].СуммаВзаиморасчетов = ДанныеТЧ[Индекс][ИмяСуммаСНДС];
				Если ЕстьСуммаНДСВзаиморасчетов Тогда
					ДанныеТЧ[Индекс].СуммаНДСВзаиморасчетов = ДанныеТЧ[Индекс].СуммаНДС;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
	Иначе
		
		КоэффициентПересчета = КоэффициентПересчетаПоКурсу(ВалютаРегламентированногоУчета,
																		ВалютаДокумента,
																		ВалютаВзаиморасчетов,
																		КурсЧислитель,
																		КурсЗнаменатель); 
		
		// Сумму, которая должна быть распределена по табличной части,
		// 		получим из разности общей суммы взаиморасчетов
		// 		и итога по заполненным значениям колонки "СуммаВзаиморасчетов".
		Если СуммаМинус = 0 Тогда
			СуммаВзаиморасчетовКРаспределениюПлюс = СуммаВзаиморасчетов;
			СуммаВзаиморасчетовКРаспределениюМинус = 0;
		Иначе
			СуммаВзаиморасчетовКРаспределениюПлюс = Окр(СуммаПлюс*КоэффициентПересчета, 2) - СуммаВзаиморасчетовТЧПлюс;
			СуммаВзаиморасчетовКРаспределениюМинус = Окр(СуммаМинус*КоэффициентПересчета, 2) - СуммаВзаиморасчетовТЧМинус;
		КонецЕсли;
		
		//Распределяем положительное отклонение.
		МассивСумм = Новый Массив;
		Для Индекс = 0 По ДанныеТЧ.Количество()-1 Цикл
			Если ЕстьНезалоговаяТара И МассивПропускаемойНоменклатуры.Найти(ДанныеТЧ[Индекс].Номенклатура) <> Неопределено Тогда
				Продолжить;
			КонецЕсли;
			Если ДанныеТЧ[Индекс][ИмяСуммаСНДС] > 0 Тогда
				Если Не ЗначениеЗаполнено(ДанныеТЧ[Индекс].СуммаВзаиморасчетов) Тогда
					МассивСумм.Добавить(Окр(ДанныеТЧ[Индекс][ИмяСуммаСНДС] * КоэффициентПересчета, 2));
				Иначе
					СуммаВзаиморасчетовКРаспределениюПлюс = СуммаВзаиморасчетовКРаспределениюПлюс - ДанныеТЧ[Индекс].СуммаВзаиморасчетов;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
		МассивСумм = ОбщегоНазначенияКлиентСервер.РаспределитьСуммуПропорциональноКоэффициентам(СуммаВзаиморасчетовКРаспределениюПлюс, МассивСумм);
		
		ИндексМассиваСумм = 0;
		Если МассивСумм <> Неопределено Тогда
			Для Индекс=0 По ДанныеТЧ.Количество()-1 Цикл
				Если ЕстьНезалоговаяТара И МассивПропускаемойНоменклатуры.Найти(ДанныеТЧ[Индекс].Номенклатура) <> Неопределено Тогда
					Продолжить;
				КонецЕсли;
				Если Не ЗначениеЗаполнено(ДанныеТЧ[Индекс].СуммаВзаиморасчетов) И ДанныеТЧ[Индекс][ИмяСуммаСНДС] > 0 Тогда
					ДанныеТЧ[Индекс].СуммаВзаиморасчетов = МассивСумм[ИндексМассиваСумм];
					ИндексМассиваСумм = ИндексМассиваСумм + 1;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
		//Распределяем отрицательное отклонение.
		МассивСумм = Новый Массив;
		Для Индекс = 0 По ДанныеТЧ.Количество()-1 Цикл
			Если ЕстьНезалоговаяТара И МассивПропускаемойНоменклатуры.Найти(ДанныеТЧ[Индекс].Номенклатура) <> Неопределено Тогда
				Продолжить;
			КонецЕсли;
			Если ДанныеТЧ[Индекс][ИмяСуммаСНДС] < 0 Тогда
				Если Не ЗначениеЗаполнено(ДанныеТЧ[Индекс].СуммаВзаиморасчетов) Тогда
					МассивСумм.Добавить(Окр(ДанныеТЧ[Индекс][ИмяСуммаСНДС] * КоэффициентПересчета, 2));
				Иначе
					СуммаВзаиморасчетовКРаспределениюМинус = СуммаВзаиморасчетовКРаспределениюМинус - ДанныеТЧ[Индекс].СуммаВзаиморасчетов;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
		МассивСумм = ОбщегоНазначенияКлиентСервер.РаспределитьСуммуПропорциональноКоэффициентам(СуммаВзаиморасчетовКРаспределениюМинус, МассивСумм);
		
		ИндексМассиваСумм = 0;
		Если МассивСумм <> Неопределено Тогда
			Для Индекс=0 По ДанныеТЧ.Количество()-1 Цикл
				Если ЕстьНезалоговаяТара И МассивПропускаемойНоменклатуры.Найти(ДанныеТЧ[Индекс].Номенклатура) <> Неопределено Тогда
					Продолжить;
				КонецЕсли;
				Если Не ЗначениеЗаполнено(ДанныеТЧ[Индекс].СуммаВзаиморасчетов) И ДанныеТЧ[Индекс][ИмяСуммаСНДС] < 0 Тогда
					ДанныеТЧ[Индекс].СуммаВзаиморасчетов = МассивСумм[ИндексМассиваСумм];
					ИндексМассиваСумм = ИндексМассиваСумм + 1;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
		Если ЕстьСуммаНДСВзаиморасчетов Тогда
			Для Индекс=0 По ДанныеТЧ.Количество()-1 Цикл
				Если ЕстьНезалоговаяТара И МассивПропускаемойНоменклатуры.Найти(ДанныеТЧ[Индекс].Номенклатура) <> Неопределено Тогда
					Продолжить;
				КонецЕсли;
				ДанныеТЧ[Индекс].СуммаНДСВзаиморасчетов = ЦенообразованиеКлиентСервер.РассчитатьСуммуНДС(ДанныеТЧ[Индекс].СуммаВзаиморасчетов, ДанныеТЧ[Индекс].СтавкаНДС);
			КонецЦикла;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область Проведение

#Область РасчетыСКлиентами

// Дополняет тексты запроса проведения документа текстами проведения графика исполнения договора  с клиентом по регистру Расчеты с клиентами.
//
// Параметры:
// 	Запрос - Запрос - Запрос отражения документа.
// 	ТекстыЗапроса - СписокЗначений - Список текстов запроса отражения документа.
// 	Регистры - Неопределено, Структура, Строка - Список регистров для отражения.
// 	ТекстПланыОплат - Строка - Текст запроса получения данных плановой оплаты документа.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов - договор.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов документа.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     [Реквизиты документа]
// 	     * ДатаПлатежа - Дата - Плановая дата оплаты.
// 	     * ВариантОплаты - ПеречислениеСсылка.ВариантыКонтроляОплатыКлиентом - Вариант оплаты.
// 	     * КОплате - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма плановой оплаты.
// 	     * ИсключатьПриКонтроле - Булево - Флаг контроля суммы плановой оплаты при проведении.
// 	ТекстПланыОтгрузок - Строка - Текст запроса получения данных плановой отгрузки документа.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов - договор.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов документа.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     [Реквизиты документа]
// 	     * ДатаОтгрузки - Дата - Плановая дата оплаты.
// 	     * УвеличитьКОтгрузке - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма плановой отгрузки.
// 
Процедура ПроведениеГрафикаИсполненияДоговораСКлиентом(Запрос, ТекстыЗапроса, Регистры, ТекстПланыОплат, ТекстПланыОтгрузок) Экспорт
	
	Если НЕ ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСКлиентами", Регистры) Тогда
		Возврат;
	КонецЕсли;
	
	Операция = "ГрафикИсполненияКлиент";
	
	#Область ВременныеТаблицы
	
	ТекстыШаблоновВТ = Новый Структура();
	
	#КонецОбласти
	
	#Область Проведение
	
	МассивТекстов = Новый Массив;
	ТекстыЗапросовДанныхДокумента = Новый Структура();
	
	ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеПланаОплатыКлиентом", ТекстПланыОплат);
	МассивТекстов.Добавить(УвеличитьПланОплатыОтКлиента(Запрос, Операция));
	
	ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеПланаОтгрузкиКлиенту", ТекстПланыОтгрузок);
	ТекстыШаблоновВТ.Вставить("ВтУвеличениеПланаОтгрузкиКлиенту", ТекстЗапросаВТУвеличениеПланаОтгрузки());
	МассивТекстов.Добавить(УвеличитьПланОтгрузкиКлиенту(Запрос, Операция));
	
	ТекстРасчетыСКлиентами = СтрСоединить(МассивТекстов, ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении());
	
	ТекстыШаблоновОтражения = Новый Структура();
	Если ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСКлиентами", Регистры) Тогда
		ТекстыШаблоновОтражения.Вставить("РасчетыСКлиентами", ТекстРасчетыСКлиентами);
	КонецЕсли;
	
	#КонецОбласти
	
	Запрос.УстановитьПараметр("ИдентификаторНеиспользуемойФинЗаписи", ПроведениеДокументов.ИдентификаторНеиспользуемойФинЗаписи());
	
	ПроведениеДокументов.ДополнитьЗапросОтраженияДокумента(Запрос, ТекстыЗапроса, ТекстыШаблоновОтражения, ТекстыЗапросовДанныхДокумента, ТекстыШаблоновВТ);
	
КонецПроцедуры

// Дополняет тексты запроса проведения документа текстами проведения заказа клиента по регистру Расчеты с клиентами.
//
// Параметры:
// 	Запрос - Запрос - Запрос отражения документа.
// 	ТекстыЗапроса - СписокЗначений - Список текстов запроса отражения документа.
// 	Регистры - Неопределено, Структура, Строка - Список регистров для отражения.
// 	ТекстПланыОплат - Строка - Текст запроса получения данных для отражения плана оплат.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов документа.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     [Реквизиты механизма]
// 	     * ПорядокРасчетов - ПеречислениеСсылка.ПорядокРасчетов - Порядок/детализация расчетов документа.
// 	     * ФормаОплаты - ПеречислениеСсылка.ФормыОплаты - Форма оплаты документа.
// 	     * ДатаПлатежа - Дата - Плановая дата оплаты всего документа/этапа оплаты.
// 	     * ИсключатьПриКонтроле - Булево - Исключить ли проверку на наличие оплаты по данной строке движений.
// 	     * ВариантОплаты - ПеречислениеСсылка.ВариантыКонтроляОплатыКлиентом - Вариант оплаты этапа графика.
// 	     * КОплате - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма к оплате в валюте взаиморасчетов (с учетом залога за тару).
// 	     * СуммаОтклоненияМерныхТоваров - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма отклонения мерных товаров в валюте взаиморасчетов к оплате.
// 	ТекстПланыОтгрузок - Строка - Текст запроса получения данных документа для отражения плана отгрузки.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов документа.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     [Реквизиты документа]
// 	     * ФормаОплаты - ПеречислениеСсылка.ФормыОплаты - Форма оплаты документа.
// 	     * ПорядокРасчетов - ПеречислениеСсылка.ПорядокРасчетов - Порядок/детализация расчетов документа.
// 	     * ДатаОтгрузки - Дата - Плановая дата отгрузки строки/документа.
// 	     * УвеличитьКОтгрузке - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма к отгрузке в валюте взаиморасчетов (с учетом залога за тару).
// 	     * УвеличитьОтгружается - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма увеличения Отгружается.
// 
Процедура ПроведениеЗаказаКлиента(Запрос, ТекстыЗапроса, Регистры, ТекстПланыОплат = "", ТекстПланыОтгрузок = "") Экспорт
	
	Если НЕ ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСКлиентами", Регистры) Тогда
		Возврат;
	КонецЕсли;
	
	Если ТекстПланыОплат = "" И ТекстПланыОтгрузок = "" Тогда
		Возврат;
	КонецЕсли;
	
	Операция = "ЗаказКлиента";
	
	#Область ВременныеТаблицы
	
	ТекстыШаблоновВТ = Новый Структура();
	
	#КонецОбласти
	
	#Область Проведение
	
	МассивТекстов = Новый Массив;
	ТекстыЗапросовДанныхДокумента = Новый Структура();
	
	Если ЗначениеЗаполнено(ТекстПланыОплат) Тогда
		ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеПланаОплатыКлиентом", ТекстПланыОплат);
		МассивТекстов.Добавить(УвеличитьПланОплатыОтКлиента(Запрос, Операция));
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ТекстПланыОтгрузок) Тогда
		ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеПланаОтгрузкиКлиенту", ТекстПланыОтгрузок);
		ТекстыШаблоновВТ.Вставить("ВтУвеличениеПланаОтгрузкиКлиенту", ТекстЗапросаВТУвеличениеПланаОтгрузки());
		МассивТекстов.Добавить(УвеличитьПланОтгрузкиКлиенту(Запрос, Операция));
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ТекстПланыОтгрузок) Тогда
		ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеОтгружается", ТекстПланыОтгрузок);
		МассивТекстов.Добавить(УвеличитьОтгружается(Операция));
	КонецЕсли;
	
	ТекстРасчетыСКлиентами = СтрСоединить(МассивТекстов, ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении());
	
	ТекстыШаблоновОтражения = Новый Структура();
	Если ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСКлиентами", Регистры) Тогда
		ТекстыШаблоновОтражения.Вставить("РасчетыСКлиентами", ТекстРасчетыСКлиентами);
	КонецЕсли;
	
	#КонецОбласти
	
	Запрос.УстановитьПараметр("ИдентификаторНеиспользуемойФинЗаписи", ПроведениеДокументов.ИдентификаторНеиспользуемойФинЗаписи());
	
	ПроведениеДокументов.ДополнитьЗапросОтраженияДокумента(Запрос, ТекстыЗапроса, ТекстыШаблоновОтражения, ТекстыЗапросовДанныхДокумента, ТекстыШаблоновВТ);
	
КонецПроцедуры

// Дополняет тексты запроса проведения документа текстами проведения продажи и переноса расчетов по регистру Расчеты с клиентами.
//
// Параметры:
// 	Запрос - Запрос - Запрос отражения документа.
// 	ТекстыЗапроса - СписокЗначений - Список текстов запроса отражения документа.
// 	Регистры - Неопределено, Структура, Строка - Список регистров для отражения.
// 	ТекстПродажа - Строка - Текст запроса получения данных продажи и плановых дат ее погашения.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов документа.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     [Реквизиты документа]
// 	     * ДатаПлатежа - Дата - Плановая дата оплаты продажи.
// 	     * ВариантОплаты - ПеречислениеСсылка.ВариантыКонтроляОплатыКлиентом - Вариант оплаты продажи.
// 	     * ПорядокРасчетов - ПеречислениеСсылка.ПорядокРасчетов - Порядок/детализация расчетов документа.
// 	     * НакладнаяПоЗаказам - Булево - Накладная введена по заказу(ам).
// 	     * СверхЗаказа - Булево - Это отгрузка сверх заказа.
// 	     * ЗаказПродажи - ДокументСсылка, Неопределено - Заказ, по которому происходит продажа.
// 	     * ДатаКурса - Дата - Дата, на которую следует взять курсы валют для расчета сумм в управленческом и регламентированном учете.
// 	     * Сумма - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма расчетов в валюте документа.
// 	     * СуммаВзаиморасчетов - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма расчетов в валюте взаиморасчетов.
// 	     * СуммаВзаиморасчетовПоТаре - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма залога за тару в валюте взаиморасчетов.
// 	     * СвязанныйДокумент - ДокументСсылка.РеализацияТоваровУслуг,
// 	                           ДокументСсылка.РеализацияУслугПрочихАктивов - Связанный документ корректировки для определения курса отражения.
// 	ТекстПланОплат - Строка - Текст запроса получения данных увеличения планов оплат.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов документа.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     [Реквизиты документа]
// 	     * ПорядокРасчетов - ПеречислениеСсылка.ПорядокРасчетов - Порядок/детализация расчетов документа.
// 	     * ФормаОплаты - ПеречислениеСсылка.ФормыОплаты - Форма оплаты документа.
// 	     * ДатаПлатежа - Дата - Плановая дата оплаты.
// 	     * ВариантОплаты - ПеречислениеСсылка.ВариантыКонтроляОплатыКлиентом - Вариант оплаты плана оплаты.
// 	     * ИсключатьПриКонтроле - Булево - Исключить ли проверку на наличие оплаты по данной строке движений.
// 	     * НакладнаяПоЗаказам - Булево - Накладная введена по заказу(ам).
// 	     * СверхЗаказа - Булево - Это отгрузка сверх заказа.
// 	     * ЗаказПродажи - ДокументСсылка, Неопределено - Заказ, по которому происходит продажа.
// 	     * ДатаКурса - Дата - Дата, на которую следует взять курсы валют для расчета сумм в управленческом и регламентированном учете.
// 	     * КОплате - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма к оплате в валюте взаиморасчетов.
// 	ТекстПереносАванса - Строка - Необязательный. Текст запроса получения данных зачтенных авансов.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     * ОбъектРасчетовИсточник - СправочникСсылка.ОбъектыРасчетов - Объект расчетов аванса.
// 	     * ОбъектРасчетовПриемник - СправочникСсылка.ОбъектыРасчетов - Объект расчетов документа.
// 	     [Общие]
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция переноса или резервирования аванса.
// 	     [Реквизиты документа]
// 	     * Сумма - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма расчетов в валюте документа.
// 	     * СуммаВзаиморасчетов - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма расчетов в валюте взаиморасчетов.
// 	     * ДатаКурса - Дата - Дата, на которую следует взять курсы валют для расчета сумм в управленческом и регламентированном учете.
// 	ТекстТовары - Строка - Текст запроса получения данных табличной части Товары - изменяет планы отгрузки и "отгружается".
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов документа.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     [Реквизиты документа]
// 	     * ПорядокРасчетов - ПеречислениеСсылка.ПорядокРасчетов - Порядок/детализация расчетов документа.
// 	     * НакладнаяПоЗаказам - Булево - Накладная введена по заказу(ам).
// 	     * ЗаказПродажи - ДокументСсылка, Неопределено - Заказ, по которому происходит продажа.
// 	     * СверхЗаказа - Булево - Это отгрузка сверх заказа.
// 	     * ДатаОтгрузки - Дата - Плановая дата отгрузки.
// 	     * УвеличитьКОтгрузке - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма увеличения плана к отгрузке в валюте взаиморасчетов.
// 	     * УменьшитьКОтгрузке - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма уменьшения плана к отгрузке в валюте взаиморасчетов.
// 	     * УвеличитьОтгружается - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма увеличения "Отгружается".
// 	     * УменьшитьОтгружается - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма, на которую следует уменьшить ресурс "Отгружается". 
// 	     Ресурс используется для контроля максимальной допустимой суммы задолженности. Т.е. если заказ уже увеличил Отгружается, то это значит, что отгрузка в процессе и сумма заказа войдет в сумму контролируемой задолженности.
// 	     * СуммаВзаиморасчетов - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма взаиморасчетов по строке товаров, по не будет уменьшен план отгрузки.
// 	     * ЗалогЗаТару - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма залога за тару.
//
Процедура ПроведениеПродажи(Запрос, ТекстыЗапроса, Регистры, ТекстПродажа = "", ТекстПланОплат = "", ТекстПереносАванса = "", ТекстТовары = "", ТекстОплата = "") Экспорт
	
	Если НЕ ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСКлиентами", Регистры) Тогда
		Возврат;
	КонецЕсли;
	
	Если ТекстПродажа = "" И ТекстПланОплат = "" И ТекстПереносАванса = "" И ТекстТовары = "" И ТекстОплата = "" Тогда
		Возврат;
	КонецЕсли;
	
	Операция = "Продажа";
	
	#Область ВременныеТаблицы
	
	ТекстыШаблоновВТ = Новый Структура();

	#КонецОбласти
	
	#Область Проведение
	
	МассивТекстов = Новый Массив;
	ТекстыЗапросовДанныхДокумента = Новый Структура();
	
	// Зачет аванса
	Если ЗначениеЗаполнено(ТекстПереносАванса) Тогда
		ТекстыЗапросовДанныхДокумента.Вставить("ТаблицаРасшифровкаПлатежа", ТекстПереносАванса);
		МассивТекстов.Добавить(ОтразитьПереносРасчетовСКлиентом(Запрос, Операция)); //Перенос авансов по накладным
	КонецЕсли;
	
	// Перенос задолженности по центральному договору
	Если ЗначениеЗаполнено(ТекстПродажа) Тогда
		МассивТекстов.Добавить(ТекстПереносЗадолженностиКлиентаМеждуФилиалами());
	КонецЕсли;
	
	// Увеличение плана оплат
	Если ЗначениеЗаполнено(ТекстПланОплат) Тогда 
		ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеПланаОплатыКлиентом", ТекстПланОплат);
		МассивТекстов.Добавить(УвеличитьПланОплатыОтКлиента(Запрос, Операция));
		// Уменьшение плана оплаты по заказам
		ТекстыЗапросовДанныхДокумента.Вставить("УменьшениеПланаОплатыОтКлиента", ТекстПланОплат);
		МассивТекстов.Добавить(УменьшитьПланОплатыОтКлиента(Операция, ЗначениеЗаполнено(ТекстТовары)));
	КонецЕсли;
		
	// Увеличение задолженности клиента
	Если ЗначениеЗаполнено(ТекстПродажа) Тогда 
		ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеЗадолженностиКлиента", ТекстПродажа);
		МассивТекстов.Добавить(УвеличитьЗадолженностьКлиента(Операция));
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ТекстТовары) Тогда
		
		// Уменьшение Отгружается
		ТекстыЗапросовДанныхДокумента.Вставить("УменьшениеОтгружается", ТекстТовары);
		МассивТекстов.Добавить(УменьшитьОтгружается(Запрос));
		
		// Уменьшение плана отгрузки
		ТекстыЗапросовДанныхДокумента.Вставить("УменьшениеПланаОтгрузкиКлиенту", ТекстТовары);
		ТекстыШаблоновВТ.Вставить("ВтУменьшениеПланаОтгрузкиКлиенту", ТекстЗапросаВТУменьшениеПланаОтгрузки());
		МассивТекстов.Добавить(УменьшитьПланОтгрузкиКлиенту(Запрос));
		
		// Увеличение плана отгрузки - сверх заказа
		ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеПланаОтгрузкиКлиенту", ТекстТовары);
		ТекстыШаблоновВТ.Вставить("ВтУвеличениеПланаОтгрузкиКлиенту", ТекстЗапросаВТУвеличениеПланаОтгрузки(Истина));
		МассивТекстов.Добавить(УвеличитьПланОтгрузкиКлиенту(Запрос, Операция));
		
		// Увеличение Отгружается - сверх заказа
		ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеОтгружается", ТекстТовары);
		МассивТекстов.Добавить(УвеличитьОтгружается(Операция));
		
	КонецЕсли;
	
	ТекстРасчетыСКлиентами = СтрСоединить(МассивТекстов, ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении());
	
	ТекстыШаблоновОтражения = Новый Структура();
	Если ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСКлиентами", Регистры) Тогда
		ТекстыШаблоновОтражения.Вставить("РасчетыСКлиентами", ТекстРасчетыСКлиентами);
	КонецЕсли;
	
	#КонецОбласти
	
	Запрос.УстановитьПараметр("ИдентификаторНеиспользуемойФинЗаписи", ПроведениеДокументов.ИдентификаторНеиспользуемойФинЗаписи());
	
	ПроведениеДокументов.ДополнитьЗапросОтраженияДокумента(Запрос, ТекстыЗапроса, ТекстыШаблоновОтражения, ТекстыЗапросовДанныхДокумента, ТекстыШаблоновВТ);
	
КонецПроцедуры

// Дополняет тексты запроса проведения документа текстами проведения оплаты от клиента по регистру Расчеты с клиентами.
//
// Параметры:
// 	Запрос - Запрос - Запрос отражения документа.
// 	ТекстыЗапроса - СписокЗначений - Список текстов запроса отражения документа.
// 	Регистры - Неопределено, Структура, Строка - Список регистров для отражения.
// 	ТекстОплата - Строка - Текст запроса получения данных оплаты.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     * Организация - 
// 	     * Партнер -
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов, по которому производится платеж.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     [Реквизиты документа]
// 	     * ДатаПогашения - Дата - Плановая дата погашения аванса
// 	     * СуммаВзаиморасчетов - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма оплаты в валюте взаиморасчетов.
// 	     * Сумма - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма расчетов в валюте документа.
// 	     * УвеличениеОплачивается - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма увеличения "Оплачивается".
// 	     * УменьшениеОплачивается - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма уменьшения "Оплачивается".
// 	     * ДатаКурса - Дата - Дата, на которую следует взять курсы валют для расчета сумм в управленческом и регламентированном учете.
// 	     * ФормаОплаты - ПеречислениеСсылка.ФормыОплаты - Форма оплаты документа.
// 	     * СтатьяДвиженияДенежныхСредств - СправочникСсылка.СтатьиДвиженияДенежныхСредств - Статья ДДС.
// 	     * СчетНаОплату - ДокументСсылка.СчетНаОплатуКлиенту - Счет, по которому производится оплата.
// 	     * СвязанныйДокумент - ДокументСсылка.РеализацияТоваровУслуг,
// 	                           ДокументСсылка.РеализацияУслугПрочихАктивов - Связанный документ корректировки для определения курса отражения.
// 	     * ИдентификаторФинЗаписи - Строка - Строка со значением уникального идентификатора шапки или строки документа.
// 	     * НастройкаХозяйственнойОперации - СправочникСсылка.НастройкиХозяйственныхОпераций - Настройка хозяйственной операции документа.
//
Процедура ПроведениеОплатыОтКлиента(Запрос, ТекстыЗапроса, Регистры, ТекстОплата) Экспорт
	
	Если НЕ ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСКлиентами", Регистры) Тогда
		Возврат;
	КонецЕсли; 
	
	Если НЕ ЗначениеЗаполнено(ТекстОплата) Тогда
		Возврат;
	КонецЕсли;
	
	Операция = "ОплатаОтКлиента";
	
	#Область ВременныеТаблицы
	
	ТекстыШаблоновВТ = Новый Структура();
	
	// Перенос платежа по центральному договору
	ТекстыШаблоновВТ.Вставить("втПереносРасчетовКлиент", ТекстВтПереносаРасчетов("ТаблицаОплатаОтКлиента"));
	
	#КонецОбласти
	
	#Область Проведение
	
	МассивТекстов = Новый Массив;
	ТекстыЗапросовДанныхДокумента = Новый Структура();
	
	// Перенос платежа по центральному договору
	МассивТекстов.Добавить(ОтразитьПереносРасчетовСКлиентом(Запрос, "ПереносПлатежа"));
	
	ТекстыЗапросовДанныхДокумента.Вставить("УменьшениеПланаОплатыОтКлиента", ТекстОплата);
	МассивТекстов.Добавить(УменьшитьПланОплатыОтКлиента(Операция));
	
	ТекстыЗапросовДанныхДокумента.Вставить("ТаблицаОплатаОтКлиента", ТекстОплата);
	МассивТекстов.Добавить(УвеличитьНашуЗадолженностьКлиенту(Операция));
	
	ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеОплачиваетсяКлиентом", ТекстОплата);
	МассивТекстов.Добавить(УвеличитьОплачиваетсяКлиентом(Операция));
	
	ТекстыЗапросовДанныхДокумента.Вставить("УменьшениеОплачиваетсяКлиентом", ТекстОплата);
	МассивТекстов.Добавить(УменьшитьОплачиваетсяКлиентом(Операция));
	
	ТекстРасчетыСКлиентами = СтрСоединить(МассивТекстов, ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении());
	
	ТекстыШаблоновОтражения = Новый Структура();
	Если ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСКлиентами", Регистры) Тогда
		ТекстыШаблоновОтражения.Вставить("РасчетыСКлиентами", ТекстРасчетыСКлиентами);
	КонецЕсли;
	
	#КонецОбласти
	
	Запрос.УстановитьПараметр("ИдентификаторНеиспользуемойФинЗаписи", ПроведениеДокументов.ИдентификаторНеиспользуемойФинЗаписи());
	
	ПроведениеДокументов.ДополнитьЗапросОтраженияДокумента(Запрос, ТекстыЗапроса, ТекстыШаблоновОтражения, ТекстыЗапросовДанныхДокумента, ТекстыШаблоновВТ);
	
КонецПроцедуры

// Дополняет тексты запроса проведения документа текстами проведения заявки на возврат ДС клиенту по регистру Расчеты с клиентами.
//
// Параметры:
// 	Запрос - Запрос - Запрос отражения документа.
// 	ТекстыЗапроса - СписокЗначений - Список текстов запроса отражения документа.
// 	Регистры - Неопределено, Структура, Строка - Список регистров для отражения.
// 	ТекстВзаиморасчеты - Строка - Текст запроса получения данных документа.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов, по которому планируется платеж.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     [Реквизиты документа]
// 	     * Оплачивается - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма уменьшения "Оплачивается" (планирование возврата).
// 	     * ФормаОплаты - ПеречислениеСсылка.ФормыОплаты - Форма оплаты документа.
// 	     * СтатьяДвиженияДенежныхСредств - СправочникСсылка.СтатьиДвиженияДенежныхСредств - Статья ДДС
// 
Процедура ПроведениеЗаявкиНаВозвратОплатыКлиенту(Запрос, ТекстыЗапроса, Регистры, ТекстВзаиморасчеты) Экспорт
	
	Если НЕ ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСКлиентами", Регистры) Тогда
		Возврат;
	КонецЕсли;
	
	Если ТекстВзаиморасчеты = "" Тогда
		Возврат;
	КонецЕсли;
	
	Операция = "ЗаявкаНаВозвратОплатыКлиенту";
	
	#Область ВременныеТаблицы
	
	ТекстыШаблоновВТ = Новый Структура();
	
	#КонецОбласти
	
	#Область Проведение
	
	ТекстыЗапросовДанныхДокумента = Новый Структура();
	
	ТекстыЗапросовДанныхДокумента.Вставить("УменьшениеОплачиваетсяКлиентом", ТекстВзаиморасчеты);
	ТекстРасчетыСКлиентами = УменьшитьОплачиваетсяКлиентом(Операция);
	
	ТекстыШаблоновОтражения = Новый Структура();
	Если ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСКлиентами", Регистры) Тогда
		ТекстыШаблоновОтражения.Вставить("РасчетыСКлиентами", ТекстРасчетыСКлиентами);
	КонецЕсли;
	
	#КонецОбласти
	
	Запрос.УстановитьПараметр("ИдентификаторНеиспользуемойФинЗаписи", ПроведениеДокументов.ИдентификаторНеиспользуемойФинЗаписи());
	
	ПроведениеДокументов.ДополнитьЗапросОтраженияДокумента(Запрос, ТекстыЗапроса, ТекстыШаблоновОтражения, ТекстыЗапросовДанныхДокумента, ТекстыШаблоновВТ);
	
КонецПроцедуры

// Дополняет тексты запроса проведения документа текстами проведения возврата оплаты клиенту по регистру Расчеты с клиентами.
//
// Параметры:
// 	Запрос - Запрос - Запрос отражения документа.
// 	ТекстыЗапроса - СписокЗначений - Список текстов запроса отражения документа.
// 	Регистры - Неопределено, Структура, Строка - Список регистров для отражения.
// 	ТекстЗадолженность - Строка - Текст запроса получения данных платежа.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов возврата.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     [Реквизиты документа]
// 	     * ФормаОплаты - ПеречислениеСсылка.ФормыОплаты - Форма оплаты документа.
// 	     * СтатьяДвиженияДенежныхСредств - СправочникСсылка.СтатьиДвиженияДенежныхСредств - Статья ДДС.
// 	     * ДатаКурса - Дата - Дата, на которую следует взять курсы валют для расчета сумм в управленческом и регламентированном учете.
// 	     * Сумма - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма возврата в валюте документа.
// 	     * СуммаВзаиморасчетов - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма возврата в валюте взаиморасчетов.
// 	     * СуммаУвеличениеОплачивается - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма оплачивается.
// 	     * ИдентификаторФинЗаписи - Строка - Строка со значением уникального идентификатора шапки или строки документа.
// 	     * НастройкаХозяйственнойОперации - СправочникСсылка.НастройкиХозяйственныхОпераций - Настройка хозяйственной операции документа.
// 	ТекстПереносРасчетов - Строка - Текст запроса получения данных зачета возврата ДС клиенту на объекты расчетов расшифровки.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     * ОбъектРасчетовИсточник - СправочникСсылка.ОбъектыРасчетов - Объект расчетов, по которому возвращаются денежные средства.
// 	     * ОбъектРасчетовПриемник - СправочникСсылка.ОбъектыРасчетов - Объект расчетов возврата.
// 	     [Общие]
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     [Реквизиты документа]
// 	     * ФормаОплаты - ПеречислениеСсылка.ФормыОплаты - Форма оплаты документа.
// 	     * Сумма - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма расчетов в валюте документа.
// 	     * СуммаВзаиморасчетов - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма расчетов в валюте взаиморасчетов.
// 	     * ДатаКурса - Дата - Дата, на которую следует взять курсы валют для расчета сумм в управленческом и регламентированном учете.
// 	ТекстОплачивается - Строка - Текст запроса получения данных возврата, по которым необходимо уменьшить "Оплачивается".
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов, по которому следует уменьшить "Оплачивается", обычно объект расчетов расшифровки.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     [Реквизиты документа]
// 	     * Оплачивается - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма уменьшения "Оплачивается".
// 	     * ФормаОплаты - ПеречислениеСсылка.ФормыОплаты - Форма оплаты документа.
// 	     * СтатьяДвиженияДенежныхСредств - СправочникСсылка.СтатьиДвиженияДенежныхСредств - Статья ДДС.
// 	     * ЗаявкаНаРасходованиеДенежныхСредств - ДокументСсылка.ЗаявкаНаРасходованиеДенежныхСредств - Если возврат происходит по заявке.
// 
Процедура ПроведениеВозвратаОплатыКлиенту(Запрос, ТекстыЗапроса, Регистры, ТекстЗадолженность = "", ТекстПереносРасчетов = "", ТекстОплачивается = "") Экспорт
	
	Если НЕ ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСКлиентами", Регистры) Тогда
		Возврат;
	КонецЕсли;
	
	Если ТекстЗадолженность = "" И ТекстПереносРасчетов = "" И ТекстОплачивается = "" Тогда
		Возврат;
	КонецЕсли;
	
	Операция = "ВозвратОплатыКлиенту";
	
	#Область ВременныеТаблицы
	
	ТекстыШаблоновВТ = Новый Структура();
	
	#КонецОбласти
	
	#Область Проведение
	
	МассивТекстов = Новый Массив;
	ТекстыЗапросовДанныхДокумента = Новый Структура();
	
	Если ЗначениеЗаполнено(ТекстЗадолженность) Тогда
	
		ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеЗадолженностиКлиента", ТекстЗадолженность);
		МассивТекстов.Добавить(УвеличитьЗадолженностьКлиента(Операция));
		
		ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеПланаОплатыКлиентом", ТекстЗадолженность);
		МассивТекстов.Добавить(УвеличитьПланОплатыОтКлиента(Запрос, Операция));
		
		ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеОплачиваетсяКлиентом", ТекстЗадолженность);
		МассивТекстов.Добавить(УвеличитьОплачиваетсяКлиентом(Операция));
	
	КонецЕсли;
	
	// Перенос аванса
	Если ЗначениеЗаполнено(ТекстПереносРасчетов) Тогда
		ТекстыЗапросовДанныхДокумента.Вставить("ТаблицаРасшифровкаПлатежа", ТекстПереносРасчетов);
		МассивТекстов.Добавить(ОтразитьПереносРасчетовСКлиентом(Запрос, Операция));
	КонецЕсли;
	
	// Уменьшить оплачивается
	Если ЗначениеЗаполнено(ТекстОплачивается) Тогда
		ТекстыЗапросовДанныхДокумента.Вставить("УменьшениеОплачиваетсяКлиентом", ТекстОплачивается);
		МассивТекстов.Добавить(УменьшитьОплачиваетсяКлиентом(Операция));
	КонецЕсли;
	
	ТекстРасчетыСКлиентами = СтрСоединить(МассивТекстов, ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении());
	
	ТекстыШаблоновОтражения = Новый Структура();
	Если ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСКлиентами", Регистры) Тогда
		ТекстыШаблоновОтражения.Вставить("РасчетыСКлиентами", ТекстРасчетыСКлиентами);
	КонецЕсли;
	
	#КонецОбласти
	
	Запрос.УстановитьПараметр("ИдентификаторНеиспользуемойФинЗаписи", ПроведениеДокументов.ИдентификаторНеиспользуемойФинЗаписи());
	
	ПроведениеДокументов.ДополнитьЗапросОтраженияДокумента(Запрос, ТекстыЗапроса, ТекстыШаблоновОтражения, ТекстыЗапросовДанныхДокумента, ТекстыШаблоновВТ);
	
КонецПроцедуры

// Дополняет тексты запроса проведения документа текстами проведения возврата товаров(ценностей) от клиента по регистру Расчеты с клиентами.
//
// Параметры:
// 	Запрос - Запрос - Запрос отражения документа.
// 	ТекстыЗапроса - СписокЗначений - Список текстов запроса отражения документа.
// 	Регистры - Неопределено, Структура, Строка - Список регистров для отражения.
// 	ТекстВозврат - Строка - Текст запроса получения данных документа возврата. Отражает сам возврат товаров.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * Организация - СправочникСсылка.Организации - Организация возврата товаров.
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов возврата товаров.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хоз операция документа.
// 	     * СтатьяДвиженияДенежныхСредств - СправочникСсылка.СтатьиДвиженияДенежныхСредств - Статья ДДС.
// 	     [Реквизиты документа]
// 	     * ДатаКурса - Дата - Дата, на которую следует взять курсы валют для расчета сумм в управленческом и регламентированном учете.
// 	     * Сумма - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма возврата в валюте документа.
// 	     * СуммаВзаиморасчетов - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма возврата в валюте взаиморасчетов.
// 	     * КОплате - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма возврата в валюте взаиморасчетов, на которую следует уменьшить план оплаты клиента.
// 	ТекстПереносРасчетов - Строка - Текст запроса получения данных расшифровки платежа. Отражает зачет возврата на другие объекты расчетов.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетовИсточник - СправочникСсылка.ОбъектыРасчетов - Объект расчетов возврата товаров.
// 	     * ОбъектРасчетовПриемник - СправочникСсылка.ОбъектыРасчетов - Объект расчетов, на который делается зачет.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов объекта расчетов, на который производится перенос.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хоз операция документа.
// 	     [Реквизиты табличной части]
// 	     * ДатаКурса - Дата - Дата, на которую следует взять курсы валют для расчета сумм в управленческом и регламентированном учете.
// 	     * Сумма - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма переноса в валюте документа.
// 	     * СуммаВзаиморасчетов - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма переноса в валюте взаиморасчетов.
// 	     * ДатаКурса - Дата - Дата, на которую следует взять курсы валют для расчета сумм в управленческом и регламентированном учете.
//
Процедура ПроведениеВозвратаОтКлиента(Запрос, ТекстыЗапроса, Регистры, ТекстВозврат, ТекстПереносРасчетов = "") Экспорт
	
	Если НЕ ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСКлиентами", Регистры) Тогда
		Возврат;
	КонецЕсли;
	
	Операция = "ВозвратТоваров";
	
	#Область ВременныеТаблицы
	
	ТекстыШаблоновВТ = Новый Структура();
	
	// Перенос задолженности по центральному договору
	ТекстыШаблоновВТ.Вставить("втПереносРасчетовКлиент", ТекстВтПереносаРасчетов("ТаблицаОплатаОтКлиента"));
	
	#КонецОбласти
	
	#Область Проведение
	
	МассивТекстов = Новый Массив;
	УстановитьПараметрыЗапроса(Запрос);
	ТекстыЗапросовДанныхДокумента = Новый Структура();
	
	// Перенос задолженности по центральному договору
	МассивТекстов.Добавить(ОтразитьПереносРасчетовСКлиентом(Запрос, "ПереносВозврата"));
	
	ТекстыЗапросовДанныхДокумента.Вставить("УменьшениеПланаОплатыОтКлиента", ТекстВозврат);
	МассивТекстов.Добавить(УменьшитьПланОплатыОтКлиента(Операция));
	
	ТекстыЗапросовДанныхДокумента.Вставить("ТаблицаОплатаОтКлиента", ТекстВозврат);
	МассивТекстов.Добавить(УвеличитьНашуЗадолженностьКлиенту(Операция));
	Если ЗначениеЗаполнено(ТекстПереносРасчетов) Тогда
		ТекстыЗапросовДанныхДокумента.Вставить("ТаблицаРасшифровкаПлатежа", ТекстПереносРасчетов);
		МассивТекстов.Добавить(ОтразитьПереносРасчетовСКлиентом(Запрос, Операция));
	КонецЕсли;
	
	ТекстРасчетыСКлиентами = СтрСоединить(МассивТекстов, ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении());
	
	ТекстыШаблоновОтражения = Новый Структура();
	Если ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСКлиентами", Регистры) Тогда
		ТекстыШаблоновОтражения.Вставить("РасчетыСКлиентами", ТекстРасчетыСКлиентами);
	КонецЕсли;
	
	#КонецОбласти
	
	Запрос.УстановитьПараметр("ИдентификаторНеиспользуемойФинЗаписи", ПроведениеДокументов.ИдентификаторНеиспользуемойФинЗаписи());
	
	ПроведениеДокументов.ДополнитьЗапросОтраженияДокумента(Запрос, ТекстыЗапроса, ТекстыШаблоновОтражения, ТекстыЗапросовДанныхДокумента, ТекстыШаблоновВТ);
	
КонецПроцедуры

// Дополняет тексты запроса проведения документа текстами проведения заказа клиента по регистру Плановые оплаты клиентов.
//
// Параметры:
// 	Запрос - Запрос - Запрос отражения документа.
// 	ТекстыЗапроса - СписокЗначений - Список текстов запроса отражения документа.
// 	Регистры - Неопределено, Структура, Строка - Список регистров для отражения.
// 	ТекстПланыОплат - Строка - Текст запроса получения данных для отражения плана оплат.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов документа.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     [Реквизиты механизма]
// 	     * ПорядокРасчетов - ПеречислениеСсылка.ПорядокРасчетов - Порядок/детализация расчетов документа.
// 	     * ДатаПлатежа - Дата - Плановая дата оплаты всего документа/этапа оплаты.
// 	     * ВариантОплаты - ПеречислениеСсылка.ВариантыКонтроляОплатыКлиентом - Вариант оплаты этапа графика.
// 	     * КОплате - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма к оплате в валюте взаиморасчетов (с учетом залога за тару).
// 
Процедура ПроведениеРасчетыСКлиентамиПланОплат(Запрос, ТекстыЗапроса, Регистры, ТекстПланыОплат) Экспорт
	
	Если НЕ ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСКлиентамиПланОплат", Регистры) Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ТекстПланыОплат) Тогда
		Возврат;
	КонецЕсли;
	
	ТекстыШаблоновОтражения = Новый Структура();
	
	#Область ВременныеТаблицы
	
	ТекстыШаблоновВТ = Новый Структура();
	
	#КонецОбласти
	
	#Область ПроведениеРасчетыСКлиентамиПланОплат
	
	ТекстыЗапросовДанныхДокумента = Новый Структура();
	ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеПланаОплатыКлиентом", ТекстПланыОплат);
	
	Если ТипЗнч(Запрос.Параметры.Ссылка) = Тип("ДокументСсылка.ГрафикИсполненияДоговора")
		ИЛИ ТипЗнч(Запрос.Параметры.Ссылка) = Тип("ДокументСсылка.РеализацияТоваровУслуг")
		ИЛИ ТипЗнч(Запрос.Параметры.Ссылка) = Тип("ДокументСсылка.РеализацияУслугПрочихАктивов") Тогда
		
		СуммаОтклоненияМерныхТоваров = "0";
		
	Иначе
		
		СуммаОтклоненияМерныхТоваров = "УвеличениеПланаОплатыКлиентом.СуммаОтклоненияМерныхТоваров";
		
	КонецЕсли;
	
	ТекстЗапроса = "ВЫБРАТЬ
		|	УвеличениеПланаОплатыКлиентом.ДатаРегистратора                   КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)                           КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)                  КАК АналитикаУчетаПоПартнерам,
		|	УвеличениеПланаОплатыКлиентом.ОбъектРасчетов                     КАК ОбъектРасчетов,
		|	УвеличениеПланаОплатыКлиентом.ВалютаВзаиморасчетов               КАК Валюта,
		|	УвеличениеПланаОплатыКлиентом.Ссылка                             КАК ДокументПлан,
		|	УвеличениеПланаОплатыКлиентом.ДатаПлатежа                        КАК ДатаПлановогоПогашения,
		|	УвеличениеПланаОплатыКлиентом.ДатаПлатежа                        КАК ДатаПлатежа,
		|	УвеличениеПланаОплатыКлиентом.ДатаРегистратора                   КАК ДатаВозникновения,
		|	УвеличениеПланаОплатыКлиентом.ДатаРегистратора                   КАК ДатаРегистратора,
		|	УвеличениеПланаОплатыКлиентом.НомерРегистратора                  КАК НомерРегистратора,
		|	УвеличениеПланаОплатыКлиентом.ВариантОплаты                      КАК ВариантОплаты,
		|	ЛОЖЬ                                                             КАК НераспределенныйАванс,
		|	1                                                                КАК Вид,
		|	
		|	УвеличениеПланаОплатыКлиентом.КОплате + &СуммаОтклоненияМерныхТоваров КАК КОплате,
		|	
		|	УвеличениеПланаОплатыКлиентом.Ссылка                             КАК ДокументРегистратор,
		|	
		|	УвеличениеПланаОплатыКлиентом.ОбъектРасчетов.Организация         КАК Организация,
		|	УвеличениеПланаОплатыКлиентом.Партнер                            КАК Партнер,
		|	УвеличениеПланаОплатыКлиентом.ОбъектРасчетов.Контрагент          КАК Контрагент,
		|	УвеличениеПланаОплатыКлиентом.ОбъектРасчетов.Договор             КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики                     КАК НаправлениеДеятельности
		|ИЗ
		|	#УвеличениеПланаОплатыКлиентом КАК УвеличениеПланаОплатыКлиентом
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО УвеличениеПланаОплатыКлиентом.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|			ПО УвеличениеПланаОплатыКлиентом.ОбъектРасчетов.Организация = Аналитика.Организация
		|				И УвеличениеПланаОплатыКлиентом.ОбъектРасчетов.Контрагент = Аналитика.Контрагент
		|				И УвеличениеПланаОплатыКлиентом.Партнер = Аналитика.Партнер
		|				И УвеличениеПланаОплатыКлиентом.ОбъектРасчетов.Договор = Аналитика.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СуммаОтклоненияМерныхТоваров", СуммаОтклоненияМерныхТоваров);
	
	Если ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСКлиентамиПланОплат", Регистры) Тогда
		ТекстыШаблоновОтражения.Вставить("РасчетыСКлиентамиПланОплат", ТекстЗапроса);
	КонецЕсли;
	
	#КонецОбласти
	
	ПроведениеДокументов.ДополнитьЗапросОтраженияДокумента(Запрос, ТекстыЗапроса, ТекстыШаблоновОтражения, ТекстыЗапросовДанныхДокумента, ТекстыШаблоновВТ);
	
КонецПроцедуры

// Дополняет тексты запроса проведения документа текстами проведения заказа клиента по регистру Плановые оплаты клиентов.
//
// Параметры:
// 	Запрос - Запрос - Запрос отражения документа.
// 	ТекстыЗапроса - СписокЗначений - Список текстов запроса отражения документа.
// 	Регистры - Неопределено, Структура, Строка - Список регистров для отражения.
// 	ТекстПланыОтгрузок - Строка - Текст запроса получения данных для отражения плана отгрузок.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов документа.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     [Реквизиты механизма]
// 	     * ПорядокРасчетов - ПеречислениеСсылка.ПорядокРасчетов - Порядок/детализация расчетов документа.
// 	     * ДатаПлатежа - Дата - Плановая дата оплаты всего документа/этапа оплаты.
// 	     * ВариантОплаты - ПеречислениеСсылка.ВариантыКонтроляОплатыКлиентом - Вариант оплаты этапа графика.
// 	     * КОплате - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма к оплате в валюте взаиморасчетов (с учетом залога за тару).
// 	ЭтоГрафикДоговора - Булево - Проводится график исполнения договора, иначе заказ
// 
Процедура ПроведениеРасчетыСКлиентамиПланОтгрузок(Запрос, ТекстыЗапроса, Регистры, ТекстПланыОтгрузок, ЭтоГрафикДоговора = Ложь) Экспорт
	
	Если НЕ ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСКлиентамиПланОтгрузок", Регистры) Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ТекстПланыОтгрузок) Тогда
		Возврат;
	КонецЕсли;
	
	ТекстыШаблоновОтражения = Новый Структура();
	
	#Область ПроведениеРасчетыСКлиентамиПланОтгрузок
	
	ТекстыЗапросовДанныхДокумента = Новый Структура();
	ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеПланаОтгрузкиКлиенту", ТекстПланыОтгрузок);
	
	Запрос.УстановитьПараметр("ЭтоГрафикДоговора",ЭтоГрафикДоговора);
	
	ТекстЗапроса = 
		"ВЫБРАТЬ
		|	УвеличениеПланаОтгрузкиКлиенту.ДатаРегистратора                  КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)                           КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)                  КАК АналитикаУчетаПоПартнерам,
		|	УвеличениеПланаОтгрузкиКлиенту.ОбъектРасчетов                    КАК ОбъектРасчетов,
		|	УвеличениеПланаОтгрузкиКлиенту.ВалютаВзаиморасчетов              КАК Валюта,
		|	&Ссылка                                                          КАК ДокументПлан,
		|	УвеличениеПланаОтгрузкиКлиенту.ДатаОтгрузки                      КАК ДатаПлановогоПогашения,
		|	УвеличениеПланаОтгрузкиКлиенту.ДатаРегистратора                  КАК ДатаВозникновения,
		|	ЛОЖЬ                                                             КАК НераспределенныйАванс,
		|	
		|	УвеличениеПланаОтгрузкиКлиенту.УвеличитьКОтгрузке                КАК Сумма,
		|
		|	&Ссылка                                                          КАК ДокументРегистратор,
		|
		|	ВЫБОР КОГДА ЕСТЬNULL(ДанныеДоговора.ЦентрализованныйДоговор, Ложь)
		|		ТОГДА УвеличениеПланаОтгрузкиКлиенту.Организация
		|		ИНАЧЕ УвеличениеПланаОтгрузкиКлиенту.ОбъектРасчетов.Организация
		|	КОНЕЦ                                                            КАК Организация,
		|	УвеличениеПланаОтгрузкиКлиенту.Партнер                           КАК Партнер,
		|	УвеличениеПланаОтгрузкиКлиенту.ОбъектРасчетов.Контрагент         КАК Контрагент,
		|	УвеличениеПланаОтгрузкиКлиенту.ОбъектРасчетов.Договор            КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики                     КАК НаправлениеДеятельности,
		|	УвеличениеПланаОтгрузкиКлиенту.НомерРегистратора                 КАК НомерРегистратора,
		|	УвеличениеПланаОтгрузкиКлиенту.ДатаРегистратора                  КАК ДатаРегистратора,
		|	1                                                                КАК Вид
		|ИЗ
		|	#УвеличениеПланаОтгрузкиКлиенту КАК УвеличениеПланаОтгрузкиКлиенту
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО УвеличениеПланаОтгрузкиКлиенту.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка = УвеличениеПланаОтгрузкиКлиенту.ОбъектРасчетов.Договор
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|			ПО ВЫБОР КОГДА ЕСТЬNULL(ДанныеДоговора.ЦентрализованныйДоговор, Ложь)
		|					ТОГДА УвеличениеПланаОтгрузкиКлиенту.Организация
		|					ИНАЧЕ УвеличениеПланаОтгрузкиКлиенту.ОбъектРасчетов.Организация
		|				КОНЕЦ = Аналитика.Организация
		|				И УвеличениеПланаОтгрузкиКлиенту.ОбъектРасчетов.Контрагент = Аналитика.Контрагент
		|				И УвеличениеПланаОтгрузкиКлиенту.Партнер = Аналитика.Партнер
		|				И УвеличениеПланаОтгрузкиКлиенту.ОбъектРасчетов.Договор = Аналитика.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|ГДЕ
		|	УвеличениеПланаОтгрузкиКлиенту.УвеличитьКОтгрузке <> 0
		|	И УвеличениеПланаОтгрузкиКлиенту.ПорядокРасчетов <> ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоНакладным)
		|	И (&ЭтоГрафикДоговора ИЛИ НЕ ЕСТЬNULL(ДанныеДоговора.ЗаданГрафикИсполнения, ЛОЖЬ))
		|";
	
	Если ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСКлиентамиПланОтгрузок", Регистры) Тогда
		ТекстыШаблоновОтражения.Вставить("РасчетыСКлиентамиПланОтгрузок", ТекстЗапроса);
	КонецЕсли;
	
	#КонецОбласти
	
	ПроведениеДокументов.ДополнитьЗапросОтраженияДокумента(Запрос, ТекстыЗапроса, ТекстыШаблоновОтражения, ТекстыЗапросовДанныхДокумента);
	
КонецПроцедуры

#КонецОбласти

#Область ЗачетВстречнойЗадолженности

// Дополняет тексты запроса проведения документа текстами проведения оплаты от клиента по регистру Расчеты с клиентами
// и регистру Расчеты с поставщиками. Расход по регистру расчеты с клиентами и приход по регистру расчеты с поставщиками
//
// Параметры:
// 	Запрос - Запрос - Запрос отражения документа.
// 	ТекстыЗапроса - СписокЗначений - Список текстов запроса отражения документа.
// 	Регистры - Неопределено, Структура, Строка - Список регистров для отражения.
// 	ТекстОбязательстваКлиента - Строка - Текст запроса получения данных оплаты.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов, по которому производится платеж.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     [Реквизиты документа]
// 	     * СуммаВзаиморасчетов - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма оплаты в валюте взаиморасчетов.
// 	     * Сумма - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма расчетов в валюте документа.
// 	     * Оплачивается - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма увеличения "Оплачивается".
// 	     * ДатаКурса - Дата - Дата, на которую следует взять курсы валют для расчета сумм в управленческом и регламентированном учете.
// 	     * ФормаОплаты - ПеречислениеСсылка.ФормыОплаты - Форма оплаты документа.
// 	     * СтатьяДвиженияДенежныхСредств - СправочникСсылка.СтатьиДвиженияДенежныхСредств - Статья ДДС.
// 	     * СчетНаОплату - ДокументСсылка.СчетНаОплатуКлиенту - Счет, по которому производится оплата.
// 	     * СвязанныйДокумент - ДокументСсылка.РеализацияТоваровУслуг,
// 	                           ДокументСсылка.РеализацияУслугПрочихАктивов - Связанный документ корректировки для определения курса отражения.
// 	     * ИдентификаторФинЗаписи - Строка - Строка со значением уникального идентификатора шапки или строки документа.
// 	     * НастройкаХозяйственнойОперации - СправочникСсылка.НастройкиХозяйственныхОпераций - Настройка хозяйственной операции документа.
// 	ТекстОбязательстваПоставщику - Строка - Текст запроса получения данных оплаты.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов, по которому производится платеж.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов документа.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     * ИдентификаторФинЗаписи - Строка - Идентификатор финансового движения для организации двойной записи.
// 	     * НастройкаХозяйственнойОперации - СправочникСсылка.НастройкиХозяйственныхОпераций - Настройка отражения хозяйственной операции в фин. учете.
// 	     [Реквизиты документа]
// 	     * Сумма - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма платежа в валюте документа.
// 	     * СуммаВзаиморасчетов - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма платежа в валюте взаиморасчетов.
// 	     * УменьшениеОплачивается - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма к уменьшению "Оплачивается", например, при оплате по заявке.
// 	     * УвеличениеОплачивается - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма к увеличению "Оплачивается", например, когда платежка проведена в системе, но не подтверждена банком.
// 	     * СтатьяДвиженияДенежныхСредств - СправочникСсылка.СтатьиДвиженияДенежныхСредств - Статья ДДС.
// 	     * ЗаявкаНаРасходованиеДенежныхСредств - ДокументСсылка.ЗаявкаНаРасходованиеДенежныхСредств - Заявка, по которой происходит оплата.
// 	     * ФормаОплаты - ПеречислениеСсылка.ФормыОплаты - Форма оплаты документа.
// 	     * ДатаКурса - Дата - Дата, на которую следует взять курсы валют для расчета сумм в управленческом и регламентированном учете.
// 	     * ИдентификаторФинЗаписи - Строка - Строка со значением уникального идентификатора шапки или строки документа.
// 	     * НастройкаХозяйственнойОперации - СправочникСсылка.НастройкиХозяйственныхОпераций - Настройка хозяйственной операции документа.
//
Процедура ПроведениеЗачетаВстречнойЗадолженности(Запрос, ТекстыЗапроса, Регистры, ТекстОбязательстваКлиента, ТекстОбязательстваПоставщику) Экспорт
	
	Если НЕ ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСКлиентами", Регистры)
			И НЕ ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщиками", Регистры) Тогда
		Возврат;
	КонецЕсли;

	#Область РасчетыСКлиентами
	// Проведение по клиентам
	Операция = "ЗачетОбязательствКлиента";
	
	#Область ВременныеТаблицы
	
	ТекстыШаблоновВТ = Новый Структура();
	
	// Перенос платежа по центральному договору
	ТекстыШаблоновВТ.Вставить("втПереносРасчетовКлиент", ТекстВтПереносаРасчетов("ТаблицаОплатаОтКлиента"));

	#КонецОбласти
	
	#Область Проведение
	
	МассивТекстов = Новый Массив;
	ТекстыЗапросовДанныхДокумента = Новый Структура();
	
	ТекстыЗапросовДанныхДокумента.Вставить("УменьшениеПланаОплатыОтКлиента", ТекстОбязательстваКлиента);
	МассивТекстов.Добавить(УменьшитьПланОплатыОтКлиента(Операция));
	
	ТекстыЗапросовДанныхДокумента.Вставить("ТаблицаОплатаОтКлиента", ТекстОбязательстваКлиента);
	МассивТекстов.Добавить(УвеличитьНашуЗадолженностьКлиенту(Операция));
	
	ТекстРасчетыСКлиентами = СтрСоединить(МассивТекстов, ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении());
	
	ТекстыШаблоновОтражения = Новый Структура();
	Если ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСКлиентами", Регистры) Тогда
		ТекстыШаблоновОтражения.Вставить("РасчетыСКлиентами", ТекстРасчетыСКлиентами);
	КонецЕсли;
	
	#КонецОбласти
	
	ПроведениеДокументов.ДополнитьЗапросОтраженияДокумента(Запрос, ТекстыЗапроса, ТекстыШаблоновОтражения, ТекстыЗапросовДанныхДокумента, ТекстыШаблоновВТ);
	
	#КонецОбласти
	
	
	#Область РасчетыСПоставщиками
	// Проведение по поставщикам
	Операция = "ЗачетОбязательствПоставщика";
	
	#Область ВременныеТаблицы
	
	ТекстыШаблоновВТ = Новый Структура();
	
	//Перенос платежа по центральному договору
	ТекстыШаблоновВТ.Вставить("втПереносРасчетовПоставщик", ТекстВтПереносаРасчетов("УвеличениеЗадолженностиПоставщика"));

	#КонецОбласти
	
	#Область Проведение
	
	МассивТекстов = Новый Массив;
	ТекстыЗапросовДанныхДокумента = Новый Структура();
	
	ТекстыЗапросовДанныхДокумента.Вставить("УменьшениеПланаОплатыПоставщику", ТекстОбязательстваПоставщику);
	МассивТекстов.Добавить(УменьшитьПланОплатыПоставщику(Операция));
	
	ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеЗадолженностиПоставщика", ТекстОбязательстваПоставщику);
	МассивТекстов.Добавить(УвеличитьЗадолженностьПоставщика(Операция));
	
	ТекстРасчетыСПоставщиками = СтрСоединить(МассивТекстов, ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении());
	
	ТекстыШаблоновОтражения = Новый Структура();
	Если ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщиками", Регистры) Тогда
		ТекстыШаблоновОтражения.Вставить("РасчетыСПоставщиками", ТекстРасчетыСПоставщиками);
	КонецЕсли;
	
	#КонецОбласти
	
	ПроведениеДокументов.ДополнитьЗапросОтраженияДокумента(Запрос, ТекстыЗапроса, ТекстыШаблоновОтражения, ТекстыЗапросовДанныхДокумента, ТекстыШаблоновВТ);
	
	#КонецОбласти
	
	Запрос.УстановитьПараметр("ИдентификаторНеиспользуемойФинЗаписи", ПроведениеДокументов.ИдентификаторНеиспользуемойФинЗаписи());
	
	КонецПроцедуры

#КонецОбласти

#Область РасчетыСПоставщиками

// Дополняет тексты запроса проведения документа текстами проведения графика исполнения договора с поставщиком
// по регистру Расчеты с поставщиками.
//
// Параметры:
// 	Запрос - Запрос - Запрос отражения документа.
// 	ТекстыЗапроса - СписокЗначений - Список текстов запроса отражения документа.
// 	Регистры - Неопределено, Структура, Строка - Список регистров для отражения.
// 	ТекстПланыОплат - Строка - Текст запроса получения данных для отражения плана оплат поставщику.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов договор.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     [Реквизиты механизма]
// 	     * ДатаПлатежа - Дата - Плановая дата оплаты этапа.
// 	     * Сумма - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма к оплате в валюте взаиморасчетов. 
// 	     * ВариантОплаты - ПеречислениеСсылка.ВариантыКонтроляОплатыПоставщику - Вариант оплаты этапа графика.
// 	ТекстПланыПоставок - Строка - Текст запроса получения данных документа для отражения плана поставки.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     [Реквизиты документа]
// 	     * ДатаПоступления - Дата - Плановая дата поставки строки/документа.
// 	     * УвеличитьКПоступлению - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма к поступлению в валюте взаиморасчетов.
//
Процедура ПроведениеГрафикаИсполненияДоговораСПоставщиком(Запрос, ТекстыЗапроса, Регистры, ТекстПланыОплат, ТекстПланыПоставок) Экспорт
	
	Если НЕ ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщиками", Регистры) Тогда
		Возврат;
	КонецЕсли;
	
	Операция = "ГрафикИсполненияПоставщик";
	
	#Область ВременныеТаблицы
	
	ТекстыШаблоновВТ = Новый Структура();
	
	#КонецОбласти
	
	#Область Проведение
	
	МассивТекстов = Новый Массив;
	ТекстыЗапросовДанныхДокумента = Новый Структура();
	
	ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеПланаОплатыПоставщику", ТекстПланыОплат);
	МассивТекстов.Добавить(УвеличитьПланОплатыПоставщику(Операция));
	
	ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеПланаПоставки", ТекстПланыПоставок);
	ТекстыШаблоновВТ.Вставить("ВтУвеличениеПланаПоставки", ТекстЗапросаВТУвеличениеПланаПоставки());
	МассивТекстов.Добавить(УвеличитьПланПоставкиОтПоставщика(Операция));
	
	ТекстРасчетыСПоставщиками = СтрСоединить(МассивТекстов, ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении());
	
	ТекстыШаблоновОтражения = Новый Структура();
	Если ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщиками", Регистры) Тогда
		ТекстыШаблоновОтражения.Вставить("РасчетыСПоставщиками", ТекстРасчетыСПоставщиками);
	КонецЕсли;
	
	#КонецОбласти
	
	Запрос.УстановитьПараметр("ИдентификаторНеиспользуемойФинЗаписи", ПроведениеДокументов.ИдентификаторНеиспользуемойФинЗаписи());
	
	ПроведениеДокументов.ДополнитьЗапросОтраженияДокумента(Запрос, ТекстыЗапроса, ТекстыШаблоновОтражения, ТекстыЗапросовДанныхДокумента, ТекстыШаблоновВТ);
	
КонецПроцедуры

// Дополняет тексты запроса проведения документа текстами проведения заказа поставщику по регистру Расчеты с поставщиками.
//
// Параметры:
// 	Запрос - Запрос - Запрос отражения документа.
// 	ТекстыЗапроса - СписокЗначений - Список текстов запроса отражения документа.
// 	Регистры - Неопределено, Структура, Строка - Список регистров для отражения.
// 	ТекстПланыОплат - Строка - Текст запроса получения данных для отражения плана оплат поставщику.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов документа.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     [Реквизиты механизма]
// 	     * ПорядокРасчетов - ПеречислениеСсылка.ПорядокРасчетов - Порядок/детализация расчетов документа.
// 	     * ФормаОплаты - ПеречислениеСсылка.ФормыОплаты - Форма оплаты документа.
// 	     * ДатаПлатежа - Дата - Плановая дата оплаты всего документа/этапа оплаты.
// 	     * ВариантОплаты - ПеречислениеСсылка.ВариантыКонтроляОплатыПоставщику - Вариант оплаты этапа графика.
// 	     * КОплате - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма к оплате в валюте взаиморасчетов (с учетом залога за тару).
// 	ТекстПланыПоставок - Строка - Текст запроса получения данных документа для отражения плана отгрузки.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов документа.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     [Реквизиты документа]
// 	     * ПорядокРасчетов - ПеречислениеСсылка.ПорядокРасчетов - Порядок/детализация расчетов документа.
// 	     * ДатаПоступления - Дата - Плановая дата поставки строки/документа.
// 	     * УвеличитьКПоступлению - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма к поступлению в валюте документа (с учетом залога за тару).
// 
Процедура ПроведениеЗаказаПоставщику(Запрос, ТекстыЗапроса, Регистры, ТекстПланыОплат = "", ТекстПланыПоставок = "") Экспорт
	
	Если НЕ ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщиками", Регистры) Тогда
		Возврат;
	КонецЕсли;
	
	Если ТекстПланыОплат = "" И ТекстПланыПоставок = "" Тогда
		Возврат;
	КонецЕсли;
	
	Операция = "ЗаказПоставщику";
	
	#Область ВременныеТаблицы
	
	ТекстыШаблоновВТ = Новый Структура();
	
	#КонецОбласти
	
	#Область Проведение
	
	МассивТекстов = Новый Массив;
	ТекстыЗапросовДанныхДокумента = Новый Структура();
	
	Если ЗначениеЗаполнено(ТекстПланыОплат) Тогда
		ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеПланаОплатыПоставщику", ТекстПланыОплат);
		МассивТекстов.Добавить(УвеличитьПланОплатыПоставщику(Операция));
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ТекстПланыПоставок) Тогда
		ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеПланаПоставки", ТекстПланыПоставок);
		ТекстыШаблоновВТ.Вставить("ВтУвеличениеПланаПоставки", ТекстЗапросаВТУвеличениеПланаПоставки());
		МассивТекстов.Добавить(УвеличитьПланПоставкиОтПоставщика(Операция));
	КонецЕсли;
	
	ТекстРасчетыСПоставщиками = СтрСоединить(МассивТекстов, ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении());
	
	ТекстыШаблоновОтражения = Новый Структура();
	Если ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщиками", Регистры) Тогда
		ТекстыШаблоновОтражения.Вставить("РасчетыСПоставщиками", ТекстРасчетыСПоставщиками);
	КонецЕсли;
	
	#КонецОбласти
	
	Запрос.УстановитьПараметр("ИдентификаторНеиспользуемойФинЗаписи", ПроведениеДокументов.ИдентификаторНеиспользуемойФинЗаписи());
	
	ПроведениеДокументов.ДополнитьЗапросОтраженияДокумента(Запрос, ТекстыЗапроса, ТекстыШаблоновОтражения, ТекстыЗапросовДанныхДокумента, ТекстыШаблоновВТ);
	
КонецПроцедуры

// Дополняет тексты запроса проведения документа текстами проведения оплаты поставщику по регистру Расчеты с поставщиками.
//
// Параметры:
// 	Запрос - Запрос - Запрос отражения документа.
// 	ТекстыЗапроса - СписокЗначений - Список текстов запроса отражения документа.
// 	Регистры - Неопределено, Структура, Строка - Список регистров для отражения.
// 	ТекстОплата - Строка - Текст запроса получения данных оплаты.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов, по которому производится платеж.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов документа.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     [Реквизиты документа]
// 	     * ДатаПогашения - Дата - Плановая дата погашения аванса
// 	     * Сумма - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма платежа в валюте документа.
// 	     * СуммаВзаиморасчетов - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма платежа в валюте взаиморасчетов.
// 	     * УменьшениеОплачивается - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма к уменьшению "Оплачивается", например, при оплате по заявке.
// 	     * УвеличениеОплачивается - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма к увеличению "Оплачивается", например, когда платежка проведена в системе, но не подтверждена банком.
// 	     * СуммаУпр - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма платежа в валюте управленческого учета
// 	     * СуммаРегл - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма платежа в валюте регламентированного учета
// 	     * СтатьяДвиженияДенежныхСредств - СправочникСсылка.СтатьиДвиженияДенежныхСредств - Статья ДДС.
// 	     * ЗаявкаНаРасходованиеДенежныхСредств - ДокументСсылка.ЗаявкаНаРасходованиеДенежныхСредств - Заявка, по которой происходит оплата.
// 	     * ФормаОплаты - ПеречислениеСсылка.ФормыОплаты - Форма оплаты документа.
// 	     * ДатаКурса - Дата - Дата, на которую следует взять курсы валют для расчета сумм в управленческом и регламентированном учете.
// 	     * ИдентификаторФинЗаписи - Строка - Строка со значением уникального идентификатора шапки или строки документа.
// 	     * НастройкаХозяйственнойОперации - СправочникСсылка.НастройкиХозяйственныхОпераций - Настройка хозяйственной операции документа.
//
Процедура ПроведениеОплатыПоставщику(Запрос, ТекстыЗапроса, Регистры, ТекстОплата) Экспорт
	
	Если НЕ ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщиками", Регистры) Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ТекстОплата) Тогда
		Возврат;
	КонецЕсли;
	
	Операция = "ОплатаПоставщику";
	
	#Область ВременныеТаблицы
	
	ТекстыШаблоновВТ = Новый Структура();
	
	//Перенос платежа по центральному договору
	ТекстыШаблоновВТ.Вставить("втПереносРасчетовПоставщик", ТекстВтПереносаРасчетов("УвеличениеЗадолженностиПоставщика"));
	
	#КонецОбласти
	
	#Область Проведение
	
	МассивТекстов = Новый Массив;
	ТекстыЗапросовДанныхДокумента = Новый Структура();

	//Перенос платежа по центральному договору
	МассивТекстов.Добавить(ОтразитьПереносРасчетовСПоставщиком(Запрос, "ПереносПлатежа"));
	
	ТекстыЗапросовДанныхДокумента.Вставить("УменьшениеПланаОплатыПоставщику", ТекстОплата);
	МассивТекстов.Добавить(УменьшитьПланОплатыПоставщику(Операция));
	
	ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеЗадолженностиПоставщика", ТекстОплата);
	МассивТекстов.Добавить(УвеличитьЗадолженностьПоставщика(Операция));
	
	ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеОплачиваетсяПоставщику", ТекстОплата);
	МассивТекстов.Добавить(УвеличитьОплачиваетсяПоставщику(Операция));
	
	ТекстыЗапросовДанныхДокумента.Вставить("УменьшениеОплачиваетсяПоставщику", ТекстОплата);
	МассивТекстов.Добавить(УменьшитьОплачиваетсяПоставщику());
	
	ТекстРасчетыСПоставщиками = СтрСоединить(МассивТекстов, ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении());
	
	ТекстыШаблоновОтражения = Новый Структура();
	Если ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщиками", Регистры) Тогда
		ТекстыШаблоновОтражения.Вставить("РасчетыСПоставщиками", ТекстРасчетыСПоставщиками);
	КонецЕсли;
	
	#КонецОбласти
	
	Запрос.УстановитьПараметр("ИдентификаторНеиспользуемойФинЗаписи", ПроведениеДокументов.ИдентификаторНеиспользуемойФинЗаписи());
	
	ПроведениеДокументов.ДополнитьЗапросОтраженияДокумента(Запрос, ТекстыЗапроса, ТекстыШаблоновОтражения, ТекстыЗапросовДанныхДокумента, ТекстыШаблоновВТ);
	
КонецПроцедуры

// Дополняет тексты запроса проведения документа текстами проведения закупки по регистру Расчеты с поставщиками.
//
// Параметры:
// 	Запрос - Запрос - Запрос отражения документа.
// 	ТекстыЗапроса - СписокЗначений - Список текстов запроса отражения документа.
// 	Регистры - Неопределено, Структура, Строка - Список регистров для отражения.
// 	ТекстЗакупка - Строка - Текст запроса получения данных документа. Отражает саму закупку.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов документа.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов документа.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     [Реквизиты документа]
// 	     * ДатаПлатежа - Дата - Плановая дата оплаты всего документа/этапа оплаты.
// 	     * ЗаказЗакупки - ДокументСсылка - Заказ, по которому происходит закупка.
// 	     * Сумма - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма закупки в валюте документа (включая залог за тару).
// 	     * СуммаВзаиморасчетов - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма закупки в валюте взаиморасчетов (включая залог за тару).
// 	     * ЗалогЗаТару - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма залога за тару в валюте взаиморасчетов.
// 	     * ДатаКурса - Дата - Дата, на которую следует взять курсы валют для расчета сумм в управленческом и регламентированном учете.
// 	     * ПорядокРасчетов - ПеречислениеСсылка.ПорядокРасчетов - Порядок/детализация расчетов документа.
// 	     * НакладнаяПоЗаказам - Булево - Накладная введена по заказу(ам).
// 	     * ФормаОплаты - ПеречислениеСсылка.ФормыОплаты - Форма оплаты документа.
// 	ТекстПланОплат - Строка - Текст запроса получения данных документа плановой оплаты поставщику. Отражает увеличение плана оплаты поставщику.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов документа.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов документа.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     [Реквизиты документа]
// 	     * ПорядокРасчетов - ПеречислениеСсылка.ПорядокРасчетов - Порядок/детализация расчетов документа.
// 	     * ДатаПлатежа - Дата - Плановая дата оплаты всего документа/этапа оплаты.
// 	     * НакладнаяПоЗаказам - Булево - Накладная введена по заказу(ам).
// 	     * СверхЗаказа - Булево - Это приобретение сверх заказа.
// 	     * ЗаказЗакупки - ДокументСсылка - Заказ, по которому происходит закупка.
// 	     * КОплате - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма к оплате в валюте взаиморасчетов.
// 	     * ФормаОплаты - ПеречислениеСсылка.ФормыОплаты - Форма оплаты документа.
// 	     * ВариантОплаты - ПеречислениеСсылка.ВариантыКонтроляОплатыПоставщику - Вариант оплаты этапа графика.
// 	ТекстПереносАванса - Строка - Текст запроса получения данных документа по зачтенным авансам.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     * ОбъектРасчетовИсточник - СправочникСсылка.ОбъектыРасчетов - Объект расчетов аванса.
// 	     * ОбъектРасчетовПриемник - СправочникСсылка.ОбъектыРасчетов - Объект расчетов документа.
// 	     [Общие]
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов документа.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция переноса или резервирования аванса.
// 	     [Реквизиты документа]
// 	     * Сумма - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма расчетов в валюте документа.
// 	     * СуммаВзаиморасчетов - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма расчетов в валюте взаиморасчетов.
// 	     * ДатаКурса - Дата - Дата, на которую следует взять курсы валют для расчета сумм в управленческом и регламентированном учете.
// 	ТекстТовары - Строка - Текст запроса получения данных документа плановой поставки от поставщика. Отражает увеличение плана поставки поставщиком.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов документа.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов документа.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     [Реквизиты документа]
// 	     * ПорядокРасчетов - ПеречислениеСсылка.ПорядокРасчетов - Порядок/детализация расчетов документа.
// 	     * НакладнаяПоЗаказам - Булево - Накладная введена по заказу(ам).
// 	     * СверхЗаказа - Булево - Это приобретение сверх заказа.
// 	     * ЗаказЗакупки - ДокументСсылка - Заказ, по которому происходит закупка.
// 	     * СуммаВзаиморасчетов - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма взаиморасчетов строки товаров, уменьшает план поставки.
// 	     * УвеличитьКПоступлению - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма увеличения плана поставки.
// 	     * УменьшитьКПоступлению - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма уменьшения плана поставки.
//
Процедура ПроведениеЗакупки(Запрос, ТекстыЗапроса, Регистры, ТекстЗакупка, ТекстПланОплат, ТекстПереносАванса = "", ТекстТовары = "") Экспорт
	
	Если НЕ ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщиками", Регистры) Тогда
		Возврат;
	КонецЕсли;
	
	Если ТекстЗакупка = "" И ТекстПланОплат = "" И ТекстПереносАванса = "" И ТекстТовары = "" Тогда
		Возврат;
	КонецЕсли;
	
	Операция = "Закупка";
	
	#Область ВременныеТаблицы
	
	ТекстыШаблоновВТ = Новый Структура();
	
	#КонецОбласти
	
	#Область Проведение
	
	МассивТекстов = Новый Массив;
	ТекстыЗапросовДанныхДокумента = Новый Структура();
	
	// Зачет аванса
	Если ЗначениеЗаполнено(ТекстПереносАванса) Тогда
		ТекстыЗапросовДанныхДокумента.Вставить("ТаблицаРасшифровкаПлатежаПоставщик", ТекстПереносАванса);
		МассивТекстов.Добавить(ОтразитьПереносРасчетовСПоставщиком(Запрос, Операция)); //Перенос авансов по накладным
	КонецЕсли;
	
	// Перенос задолженности по центральному договору
	Если ЗначениеЗаполнено(ТекстЗакупка) Тогда
		МассивТекстов.Добавить(ТекстПереносЗадолженностиПоставщикаМеждуФилиалами());
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ТекстПланОплат) Тогда
		
		// Увеличение плана оплат
		ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеПланаОплатыПоставщику", ТекстПланОплат);
		МассивТекстов.Добавить(УвеличитьПланОплатыПоставщику(Операция));
		
		// Уменьшение плана оплаты по заказам
		ТекстыЗапросовДанныхДокумента.Вставить("УменьшениеПланаОплатыПоставщику", ТекстПланОплат);
		МассивТекстов.Добавить(УменьшитьПланОплатыПоставщику(Операция, ЗначениеЗаполнено(ТекстТовары)));
		
	КонецЕсли;
	
	// Увеличение задолженности поставщику
	Если ЗначениеЗаполнено(ТекстЗакупка) Тогда
		ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеНашейЗадолженностиПоставщику", ТекстЗакупка);
		МассивТекстов.Добавить(УвеличитьНашуЗадолженностьПоставщику(Операция));
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ТекстТовары) Тогда
		
		// Уменьшение плана поставки
		ТекстыЗапросовДанныхДокумента.Вставить("УменьшениеПланаПоставки", ТекстТовары);
		ТекстыШаблоновВТ.Вставить("ВтУменьшениеПланаПоставки", ТекстЗапросаВТУменьшениеПланаПоставки());
		МассивТекстов.Добавить(УменьшитьПланПоставкиОтПоставщика());
	
		// Увеличение плана поставки - сверх заказа
		ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеПланаПоставки", ТекстТовары);
		ТекстыШаблоновВТ.Вставить("ВтУвеличениеПланаПоставки", ТекстЗапросаВТУвеличениеПланаПоставки(Истина));
		МассивТекстов.Добавить(УвеличитьПланПоставкиОтПоставщика(Операция));
		
	КонецЕсли;
	
	ТекстРасчетыСПоставщиками = СтрСоединить(МассивТекстов, ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении());
	
	ТекстыШаблоновОтражения = Новый Структура();
	Если ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщиками", Регистры) Тогда
		ТекстыШаблоновОтражения.Вставить("РасчетыСПоставщиками", ТекстРасчетыСПоставщиками);
	КонецЕсли;
	
	#КонецОбласти
	
	Запрос.УстановитьПараметр("ИдентификаторНеиспользуемойФинЗаписи", ПроведениеДокументов.ИдентификаторНеиспользуемойФинЗаписи());
	
	ПроведениеДокументов.ДополнитьЗапросОтраженияДокумента(Запрос, ТекстыЗапроса, ТекстыШаблоновОтражения, ТекстыЗапросовДанныхДокумента, ТекстыШаблоновВТ);
	
КонецПроцедуры

// Дополняет тексты запроса проведения документа текстами проведения заявки на оплату поставщику по регистру Расчеты с поставщиками.
//
// Параметры:
// 	Запрос - Запрос - Запрос отражения документа.
// 	ТекстыЗапроса - СписокЗначений - Список текстов запроса отражения документа.
// 	Регистры - Неопределено, Структура, Строка - Список регистров для отражения.
// 	ТекстВзаиморасчеты - Строка - Текст запроса получения данных заявки.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов, по которому планируется платеж.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     [Реквизиты документа]
// 	     * УвеличениеОплачивается - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма заявки в валюте взаиморасчетов к оплате.
// 	     * СтатьяДвиженияДенежныхСредств - СправочникСсылка.СтатьиДвиженияДенежныхСредств - Статья ДДС.
// 	     * ФормаОплаты - ПеречислениеСсылка.ФормыОплаты - Форма оплаты документа.
//
Процедура ПроведениеЗаявкиНаОплатуПоставщику(Запрос, ТекстыЗапроса, Регистры, ТекстВзаиморасчеты) Экспорт
	
	Если НЕ ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщиками", Регистры) Тогда
		Возврат;
	КонецЕсли;
	
	Если ТекстВзаиморасчеты = "" Тогда
		Возврат;
	КонецЕсли;
	
	Операция = "ЗаявкаНаОплатуПоставщику";
	
	#Область ВременныеТаблицы
	
	ТекстыШаблоновВТ = Новый Структура();
	
	#КонецОбласти
	
	#Область Проведение
	
	ТекстыЗапросовДанныхДокумента = Новый Структура();
	
	ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеОплачиваетсяПоставщику", ТекстВзаиморасчеты);
	ТекстУвеличенияПланаОплаты = УвеличитьОплачиваетсяПоставщику(Операция);
	
	ТекстРасчетыСПоставщиками = ТекстУвеличенияПланаОплаты;
	
	ТекстыШаблоновОтражения = Новый Структура();
	Если ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщиками", Регистры) Тогда
		ТекстыШаблоновОтражения.Вставить("РасчетыСПоставщиками", ТекстРасчетыСПоставщиками);
	КонецЕсли;
	
	#КонецОбласти
	
	Запрос.УстановитьПараметр("ИдентификаторНеиспользуемойФинЗаписи", ПроведениеДокументов.ИдентификаторНеиспользуемойФинЗаписи());
	
	ПроведениеДокументов.ДополнитьЗапросОтраженияДокумента(Запрос, ТекстыЗапроса, ТекстыШаблоновОтражения, ТекстыЗапросовДанныхДокумента, ТекстыШаблоновВТ);
	
КонецПроцедуры

// Дополняет тексты запроса проведения документа текстами проведения возврата оплаты от поставщика по регистру Расчеты с поставщиками.
//
// Параметры:
// 	Запрос - Запрос - Запрос отражения документа.
// 	ТекстыЗапроса - СписокЗначений - Список текстов запроса отражения документа.
// 	Регистры - Неопределено, Структура, Строка - Список регистров для отражения.
// 	ТекстЗадолженность - Строка - Текст запроса получения данных возврата. Отражает сам возврат ДС.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов возврата.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     * ИдентификаторФинЗаписи - Строка - Идентификатор финансового движения для организации двойной записи.
// 	     * НастройкаХозяйственнойОперации - СправочникСсылка.НастройкиХозяйственныхОпераций - Настройка отражения хозяйственной операции в фин. учете.
// 	     [Реквизиты документа]
// 	     * Сумма - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма возврата в валюте документа.
// 	     * СуммаВзаиморасчетов - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма возврата в валюте взаиморасчетов.
// 	     * ДатаКурса - Дата - Дата, на которую следует взять курсы валют для расчета сумм в управленческом и регламентированном учете.
// 	     * ФормаОплаты - ПеречислениеСсылка.ФормыОплаты - Форма оплаты документа.
// 	     * СтатьяДвиженияДенежныхСредств - СправочникСсылка.СтатьиДвиженияДенежныхСредств - Статья ДДС.
// 	     * ИдентификаторФинЗаписи - Строка - Строка со значением уникального идентификатора шапки или строки документа.
// 	     * НастройкаХозяйственнойОперации - СправочникСсылка.НастройкиХозяйственныхОпераций - Настройка хозяйственной операции документа.
// 	ТекстПереносРасчетов - Строка - Необязательный, текст запроса получения данных расшифровки платежа, на которую необходимо перенести возврат ДС.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     * ОбъектРасчетовИсточник - СправочникСсылка.ОбъектыРасчетов - Объект расчетов, на который зачитывается возврат ДС.
// 	     * ОбъектРасчетовПриемник - СправочникСсылка.ОбъектыРасчетов - Объект расчетов, по которому планируется платеж.
// 	     [Общие]
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция переноса расчетов.
// 	     [Реквизиты табличной части]
// 	     * Сумма - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма зачета в валюте документа.
// 	     * СуммаВзаиморасчетов - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма зачета в валюте взаиморасчетов.
// 	     * ФормаОплаты - ПеречислениеСсылка.ФормыОплаты - Форма оплаты документа.
// 	     * ДатаКурса - Дата - Дата, на которую следует взять курсы валют для расчета сумм в управленческом и регламентированном учете.
//
Процедура ПроведениеВозвратаОплатыОтПоставщика(Запрос, ТекстыЗапроса, Регистры, ТекстЗадолженность, ТекстПереносРасчетов = "") Экспорт
	
	Если НЕ ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщиками", Регистры) Тогда
		Возврат;
	КонецЕсли;
	
	Если ТекстЗадолженность = "" И ТекстПереносРасчетов = "" Тогда
		Возврат;
	КонецЕсли;
	
	Операция = "ВозвратОплатыОтПоставщика";
	
	#Область ВременныеТаблицы
	
	ТекстыШаблоновВТ = Новый Структура();
	
	#КонецОбласти
	
	#Область Проведение
	
	МассивТекстов = Новый Массив;
	ТекстыЗапросовДанныхДокумента = Новый Структура();
	
	Если ЗначениеЗаполнено(ТекстЗадолженность) Тогда
	
		ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеНашейЗадолженностиПоставщику", ТекстЗадолженность);
		МассивТекстов.Добавить(УвеличитьНашуЗадолженностьПоставщику(Операция));
		
		ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеПланаОплатыПоставщику", ТекстЗадолженность);
		МассивТекстов.Добавить(УвеличитьПланОплатыПоставщику(Операция));
	
	КонецЕсли;
	
	// Перенос аванса
	Если ЗначениеЗаполнено(ТекстПереносРасчетов) Тогда
		ТекстыЗапросовДанныхДокумента.Вставить("ТаблицаРасшифровкаПлатежаПоставщик", ТекстПереносРасчетов);
		МассивТекстов.Добавить(ОтразитьПереносРасчетовСПоставщиком(Запрос, Операция));
	КонецЕсли;
	
	ТекстРасчетыСПоставщиками = СтрСоединить(МассивТекстов, ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении());
	
	ТекстыШаблоновОтражения = Новый Структура();
	Если ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщиками", Регистры) Тогда
		ТекстыШаблоновОтражения.Вставить("РасчетыСПоставщиками", ТекстРасчетыСПоставщиками);
	КонецЕсли;
	
	#КонецОбласти
	
	Запрос.УстановитьПараметр("ИдентификаторНеиспользуемойФинЗаписи", ПроведениеДокументов.ИдентификаторНеиспользуемойФинЗаписи());
	
	ПроведениеДокументов.ДополнитьЗапросОтраженияДокумента(Запрос, ТекстыЗапроса, ТекстыШаблоновОтражения, ТекстыЗапросовДанныхДокумента, ТекстыШаблоновВТ);
	
КонецПроцедуры

// Дополняет тексты запроса проведения документа текстами проведения возврата товаров поставщику по регистру Расчеты с поставщиками.
//
// Параметры:
// 	Запрос - Запрос - Запрос отражения документа.
// 	ТекстыЗапроса - СписокЗначений - Список текстов запроса отражения документа.
// 	Регистры - Неопределено, Структура, Строка - Список регистров для отражения.
// 	ТекстВозврат - Строка - Текст запроса получения данных документа.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * Организация - СправочникСсылка.Организации - Организация возврата товаров.
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов возврата.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     * СтатьяДвиженияДенежныхСредств - СправочникСсылка.СтатьиДвиженияДенежныхСредств - Статья ДДС.
// 	     * ИдентификаторФинЗаписи - Строка - Идентификатор финансового движения для организации двойной записи.
// 	       В большинстве случаев поле определяется как ОбъектРасчетов.УникальныйИдентификатор, в особых случаях может иметь значение не связанное с объектом расчетов.
// 	     * НастройкаХозяйственнойОперации - Неопределено, СправочникСсылка.НастройкиХозяйственныхОпераций - Настройка отражения хозяйственной операции в фин. учете.
// 	       В большинстве случаев поле имеет значение Неопределено, в особых случаях может быть указана ссылка на элемент справочника.
// 	     [Реквизиты документа]
// 	     * Сумма - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма возврата в валюте документа.
// 	     * СуммаВзаиморасчетов - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма возврата в валюте взаиморасчетов.
// 	     * ДатаКурса - Дата - Дата, на которую следует взять курсы валют для расчета сумм в управленческом и регламентированном учете.
// 	ТекстПереносРасчетов - Строка - Текст запроса получения данных расшифровки платежа возврата, на которую происходит зачет возврата.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     * ОбъектРасчетовИсточник - СправочникСсылка.ОбъектыРасчетов - Объект расчетов возврата.
// 	     * ОбъектРасчетовПриемник - СправочникСсылка.ОбъектыРасчетов - Объект расчетов, на который происходит зачет возврата.
// 	     [Общие]
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов объекта расчетов, на который происходит зачет возврата.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     [Реквизиты табличной части]
// 	     * Сумма - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма расчетов в валюте документа.
// 	     * СуммаВзаиморасчетов - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма расчетов в валюте взаиморасчетов.
// 	     * ДатаКурса - Дата - Дата, на которую следует взять курсы валют для расчета сумм в управленческом и регламентированном учете.
//
Процедура ПроведениеВозвратаПоставщику(Запрос, ТекстыЗапроса, Регистры, ТекстВозврат, ТекстПереносРасчетов = "") Экспорт
	
	Если НЕ ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщиками", Регистры) Тогда
		Возврат;
	КонецЕсли;
	
	Операция = "ВозвратТоваровПоставщику";
	
	#Область ВременныеТаблицы
	
	ТекстыШаблоновВТ = Новый Структура();
	
	// Перенос задолженности по центральному договору
	ТекстыШаблоновВТ.Вставить("втПереносРасчетовПоставщик", ТекстВтПереносаРасчетов("УвеличениеЗадолженностиПоставщика"));
	
	#КонецОбласти
	
	#Область Проведение
	
	МассивТекстов = Новый Массив;
	ТекстыЗапросовДанныхДокумента = Новый Структура();
	
	// Перенос задолженности по центральному договору
	МассивТекстов.Добавить(ОтразитьПереносРасчетовСПоставщиком(Запрос, "ПереносВозврата"));
	
	ТекстыЗапросовДанныхДокумента.Вставить("УменьшениеПланаОплатыПоставщику", ТекстВозврат);
	МассивТекстов.Добавить(УменьшитьПланОплатыПоставщику(Операция));
	
	ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеЗадолженностиПоставщика", ТекстВозврат);
	МассивТекстов.Добавить(УвеличитьЗадолженностьПоставщика(Операция));
	
	Если ЗначениеЗаполнено(ТекстПереносРасчетов) Тогда
		ТекстыЗапросовДанныхДокумента.Вставить("ТаблицаРасшифровкаПлатежаПоставщик", ТекстПереносРасчетов);
		МассивТекстов.Добавить(ОтразитьПереносРасчетовСПоставщиком(Запрос, Операция));
	КонецЕсли;
	
	ТекстРасчетыСПоставщиками = СтрСоединить(МассивТекстов, ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении());
	
	ТекстыШаблоновОтражения = Новый Структура();
	Если ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщиками", Регистры) Тогда
		ТекстыШаблоновОтражения.Вставить("РасчетыСПоставщиками", ТекстРасчетыСПоставщиками);
	КонецЕсли;
	
	#КонецОбласти
	
	Запрос.УстановитьПараметр("ИдентификаторНеиспользуемойФинЗаписи", ПроведениеДокументов.ИдентификаторНеиспользуемойФинЗаписи());
	
	ПроведениеДокументов.ДополнитьЗапросОтраженияДокумента(Запрос, ТекстыЗапроса, ТекстыШаблоновОтражения, ТекстыЗапросовДанныхДокумента, ТекстыШаблоновВТ);
	
КонецПроцедуры

// Дополняет тексты запроса проведения документа текстами проведения заказа клиента по регистру Расчеты с клиентами.
//
// Параметры:
// 	Запрос - Запрос - Запрос отражения документа.
// 	ТекстыЗапроса - СписокЗначений - Список текстов запроса отражения документа.
// 	Регистры - Неопределено, Структура, Строка - Список регистров для отражения.
// 	ТекстПланыОплат - Строка - Текст запроса получения данных для отражения плана оплат.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов документа.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     [Реквизиты механизма]
// 	     * ПорядокРасчетов - ПеречислениеСсылка.ПорядокРасчетов - Порядок/детализация расчетов документа.
// 	     * ДатаПлатежа - Дата - Плановая дата оплаты всего документа/этапа оплаты.
// 	     * ВариантОплаты - ПеречислениеСсылка.ВариантыКонтроляОплатыКлиентом - Вариант оплаты этапа графика.
// 	     * КОплате - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма к оплате в валюте взаиморасчетов (с учетом залога за тару).
// 
Процедура ПроведениеРасчетыСПоставщикамиПланОплат(Запрос, ТекстыЗапроса, Регистры, ТекстПланыОплат) Экспорт
	
	Если НЕ ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщикамиПланОплат", Регистры) Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ТекстПланыОплат) Тогда
		Возврат;
	КонецЕсли;
	
	ТекстыШаблоновОтражения = Новый Структура();
	
	#Область ВременныеТаблицы
	
	ТекстыШаблоновВТ = Новый Структура();
	
	#КонецОбласти
	
	#Область ПроведениеРасчетыСПоставщикамиПланОплат
	
	ТекстыЗапросовДанныхДокумента = Новый Структура();
	ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеПланаОплатыПоставщику", ТекстПланыОплат);
	
	ТекстЗапроса ="ВЫБРАТЬ
		|	УвеличениеПланаОплатыПоставщику.ДатаРегистратора                    КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)                              КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)                     КАК АналитикаУчетаПоПартнерам,
		|	УвеличениеПланаОплатыПоставщику.ОбъектРасчетов                      КАК ОбъектРасчетов,
		|	УвеличениеПланаОплатыПоставщику.ВалютаВзаиморасчетов                КАК Валюта,
		|	
		|	УвеличениеПланаОплатыПоставщику.КОплате                             КАК КОплате,
		|	
		|	УвеличениеПланаОплатыПоставщику.Ссылка                              КАК ДокументПлан,
		|	УвеличениеПланаОплатыПоставщику.ДатаПлатежа                         КАК ДатаПлановогоПогашения,
		|	УвеличениеПланаОплатыПоставщику.ДатаРегистратора                    КАК ДатаВозникновения,
		|	УвеличениеПланаОплатыПоставщику.ДатаРегистратора                    КАК ДатаРегистратора,
		|	УвеличениеПланаОплатыПоставщику.НомерРегистратора                   КАК НомерРегистратора,
		|	УвеличениеПланаОплатыПоставщику.ВариантОплаты                       КАК ВариантОплаты,
		|	ЛОЖЬ                                                                КАК НераспределенныйАванс,
		|	1                                                                   КАК Вид,
		|	УвеличениеПланаОплатыПоставщику.Ссылка                              КАК ДокументРегистратор,
		|	
		|	УвеличениеПланаОплатыПоставщику.ОбъектРасчетов.Организация          КАК Организация,
		|	УвеличениеПланаОплатыПоставщику.Партнер                             КАК Партнер,
		|	УвеличениеПланаОплатыПоставщику.ОбъектРасчетов.Контрагент           КАК Контрагент,
		|	УвеличениеПланаОплатыПоставщику.ОбъектРасчетов.Договор              КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики                        КАК НаправлениеДеятельности
		|ИЗ
		|	#УвеличениеПланаОплатыПоставщику КАК УвеличениеПланаОплатыПоставщику
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО УвеличениеПланаОплатыПоставщику.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|			ПО УвеличениеПланаОплатыПоставщику.ОбъектРасчетов.Организация = Аналитика.Организация
		|				И УвеличениеПланаОплатыПоставщику.ОбъектРасчетов.Контрагент = Аналитика.Контрагент
		|				И УвеличениеПланаОплатыПоставщику.Партнер = Аналитика.Партнер
		|				И УвеличениеПланаОплатыПоставщику.ОбъектРасчетов.Договор = Аналитика.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|";
	
	Если ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщикамиПланОплат", Регистры) Тогда
		ТекстыШаблоновОтражения.Вставить("РасчетыСПоставщикамиПланОплат", ТекстЗапроса);
	КонецЕсли;
	
	#КонецОбласти
	
	ПроведениеДокументов.ДополнитьЗапросОтраженияДокумента(Запрос, ТекстыЗапроса, ТекстыШаблоновОтражения, ТекстыЗапросовДанныхДокумента, ТекстыШаблоновВТ);
	
КонецПроцедуры

// Дополняет тексты запроса проведения документа текстами проведения заказа клиента по регистру Расчеты с клиентами.
//
// Параметры:
// 	Запрос - Запрос - Запрос отражения документа.
// 	ТекстыЗапроса - СписокЗначений - Список текстов запроса отражения документа.
// 	Регистры - Неопределено, Структура, Строка - Список регистров для отражения.
// 	ТекстПланыПоставок - Строка - Текст запроса получения данных для отражения плана оплат.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов документа.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     [Реквизиты механизма]
// 	     * ПорядокРасчетов - ПеречислениеСсылка.ПорядокРасчетов - Порядок/детализация расчетов документа.
// 	     * ДатаПогашения - Дата - Плановая дата поставки
// 	     * Сумма - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма к оплате в валюте взаиморасчетов (с учетом залога за тару).
// 	ЭтоГрафикДоговора - Булево - Проводится график исполнения договора, иначе заказ
//
Процедура ПроведениеРасчетыСПоставщикамиПланПоставок(Запрос, ТекстыЗапроса, Регистры, ТекстПланыПоставок, ЭтоГрафикДоговора = Ложь) Экспорт
	
	Если НЕ ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщикамиПланПоставок", Регистры) Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ТекстПланыПоставок) Тогда
		Возврат;
	КонецЕсли;
	
	ТекстыШаблоновОтражения = Новый Структура();
	
	#Область ПроведениеРасчетыСПоставщикамиПланПоставок
	
	ТекстыЗапросовДанныхДокумента = Новый Структура();
	ТекстыЗапросовДанныхДокумента.Вставить("УвеличениеПланаПоставки", ТекстПланыПоставок);
	
	Запрос.УстановитьПараметр("ЭтоГрафикДоговора",ЭтоГрафикДоговора);
	
	ТекстЗапроса ="ВЫБРАТЬ
		|	УвеличениеПланаПоставки.ДатаРегистратора                    КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)                      КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)             КАК АналитикаУчетаПоПартнерам,
		|	УвеличениеПланаПоставки.ОбъектРасчетов                      КАК ОбъектРасчетов,
		|	УвеличениеПланаПоставки.ВалютаВзаиморасчетов                КАК Валюта,
		|	
		|	УвеличениеПланаПоставки.УвеличитьКПоступлению               КАК Сумма,
		|	
		|	УвеличениеПланаПоставки.Ссылка                              КАК ДокументПлан,
		|	УвеличениеПланаПоставки.ДатаПоступления                     КАК ДатаПлановогоПогашения,
		|	УвеличениеПланаПоставки.ДатаРегистратора                    КАК ДатаВозникновения,
		|	УвеличениеПланаПоставки.ДатаРегистратора                    КАК ДатаРегистратора,
		|	УвеличениеПланаПоставки.НомерРегистратора                   КАК НомерРегистратора,
		|	ЛОЖЬ                                                        КАК НераспределенныйАванс,
		|	1                                                           КАК Вид,
		|	УвеличениеПланаПоставки.Ссылка                              КАК ДокументРегистратор,
		|	
		|	ВЫБОР КОГДА ЕСТЬNULL(ДанныеДоговора.ЦентрализованныйДоговор, Ложь)
		|					ТОГДА УвеличениеПланаПоставки.Организация
		|					ИНАЧЕ УвеличениеПланаПоставки.ОбъектРасчетов.Организация
		|	КОНЕЦ                                                       КАК Организация,
		|	УвеличениеПланаПоставки.Партнер                             КАК Партнер,
		|	УвеличениеПланаПоставки.ОбъектРасчетов.Контрагент           КАК Контрагент,
		|	УвеличениеПланаПоставки.ОбъектРасчетов.Договор              КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики                КАК НаправлениеДеятельности
		|ИЗ
		|	#УвеличениеПланаПоставки КАК УвеличениеПланаПоставки
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО УвеличениеПланаПоставки.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка = УвеличениеПланаПоставки.ОбъектРасчетов.Договор
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|			ПО ВЫБОР КОГДА ЕСТЬNULL(ДанныеДоговора.ЦентрализованныйДоговор, Ложь)
		|					ТОГДА УвеличениеПланаПоставки.Организация
		|					ИНАЧЕ УвеличениеПланаПоставки.ОбъектРасчетов.Организация
		|				КОНЕЦ = Аналитика.Организация
		|				И УвеличениеПланаПоставки.ОбъектРасчетов.Контрагент = Аналитика.Контрагент
		|				И УвеличениеПланаПоставки.Партнер = Аналитика.Партнер
		|				И УвеличениеПланаПоставки.ОбъектРасчетов.Договор = Аналитика.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|ГДЕ
		|	УвеличениеПланаПоставки.УвеличитьКПоступлению <> 0
		|	И УвеличениеПланаПоставки.ПорядокРасчетов <> ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоНакладным)
		|	И (&ЭтоГрафикДоговора ИЛИ НЕ ЕСТЬNULL(ДанныеДоговора.ЗаданГрафикИсполнения, ЛОЖЬ))
		|";
	
	Если ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщикамиПланПоставок", Регистры) Тогда
		ТекстыШаблоновОтражения.Вставить("РасчетыСПоставщикамиПланПоставок", ТекстЗапроса);
	КонецЕсли;
	
	#КонецОбласти
	
	ПроведениеДокументов.ДополнитьЗапросОтраженияДокумента(Запрос, ТекстыЗапроса, ТекстыШаблоновОтражения, ТекстыЗапросовДанныхДокумента);
	
КонецПроцедуры

// Дополняет тексты запроса проведения документа текстами проведения возврата товаров поставщику по регистру Расчеты с поставщиками.
//
// Параметры:
// 	Запрос - Запрос - Запрос отражения документа.
// 	ТекстыЗапроса - СписокЗначений - Список текстов запроса отражения документа.
// 	Регистры - Неопределено, Структура, Строка - Список регистров для отражения.
// 	ТекстВозврат - Строка - Текст запроса получения данных документа.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * Организация - СправочникСсылка.Организации - Организация возврата товаров.
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов возврата.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     * СтатьяДвиженияДенежныхСредств - СправочникСсылка.СтатьиДвиженияДенежныхСредств - Статья ДДС.
// 	     * ИдентификаторФинЗаписи - Строка - Идентификатор финансового движения для организации двойной записи.
// 	       В большинстве случаев поле определяется как ОбъектРасчетов.УникальныйИдентификатор, в особых случаях может иметь значение не связанное с объектом расчетов.
// 	     * НастройкаХозяйственнойОперации - Неопределено, СправочникСсылка.НастройкиХозяйственныхОпераций - Настройка отражения хозяйственной операции в фин. учете.
// 	       В большинстве случаев поле имеет значение Неопределено, в особых случаях может быть указана ссылка на элемент справочника.
// 	     [Реквизиты документа]
// 	     * Сумма - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма возврата в валюте документа.
// 	     * СуммаВзаиморасчетов - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма возврата в валюте взаиморасчетов.
// 	     * ДатаКурса - Дата - Дата, на которую следует взять курсы валют для расчета сумм в управленческом и регламентированном учете.
// 	ТекстПереносРасчетов - Строка - Текст запроса получения данных расшифровки платежа возврата, на которую происходит зачет возврата.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     * ОбъектРасчетовИсточник - СправочникСсылка.ОбъектыРасчетов - Объект расчетов возврата.
// 	     * ОбъектРасчетовПриемник - СправочникСсылка.ОбъектыРасчетов - Объект расчетов, на который происходит зачет возврата.
// 	     [Общие]
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов объекта расчетов, на который происходит зачет возврата.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     [Реквизиты табличной части]
// 	     * Сумма - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма расчетов в валюте документа.
// 	     * СуммаВзаиморасчетов - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма расчетов в валюте взаиморасчетов.
// 	     * ДатаКурса - Дата - Дата, на которую следует взять курсы валют для расчета сумм в управленческом и регламентированном учете.
//
Процедура ПроведениеПереносаАвансаПоставщику(Запрос, ТекстыЗапроса, Регистры, ТекстПереносРасчетов = "") Экспорт
	
	Если НЕ ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщиками", Регистры) Тогда
		Возврат;
	КонецЕсли;
	
	Операция = "ПереносАвансаПоставщику";
	
	#Область Проведение
	
	МассивТекстов = Новый Массив;
	ТекстыЗапросовДанныхДокумента = Новый Структура();
	ТекстыЗапросовДанныхДокумента.Вставить("ТаблицаРасшифровкаПлатежаПоставщик", ТекстПереносРасчетов);
	МассивТекстов.Добавить(ОтразитьПереносРасчетовСПоставщиком(Запрос, Операция));
	
	ТекстРасчетыСПоставщиками = СтрСоединить(МассивТекстов, ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении());
	
	ТекстыШаблоновОтражения = Новый Структура();
	Если ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщиками", Регистры) Тогда
		ТекстыШаблоновОтражения.Вставить("РасчетыСПоставщиками", ТекстРасчетыСПоставщиками);
	КонецЕсли;
	
	#КонецОбласти
	
	ПроведениеДокументов.ДополнитьЗапросОтраженияДокумента(Запрос, ТекстыЗапроса, ТекстыШаблоновОтражения, ТекстыЗапросовДанныхДокумента);
	
КонецПроцедуры

// Дополняет тексты запроса проведения документа текстами проведения возврата товаров поставщику по регистру Расчеты с поставщиками.
//
// Параметры:
// 	Запрос - Запрос - Запрос отражения документа.
// 	ТекстыЗапроса - СписокЗначений - Список текстов запроса отражения документа.
// 	Регистры - Неопределено, Структура, Строка - Список регистров для отражения.
// 	ТекстВозврат - Строка - Текст запроса получения данных документа.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     [Общие]
// 	     * Организация - СправочникСсылка.Организации - Организация возврата товаров.
// 	     * ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов возврата.
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     * СтатьяДвиженияДенежныхСредств - СправочникСсылка.СтатьиДвиженияДенежныхСредств - Статья ДДС.
// 	     * ИдентификаторФинЗаписи - Строка - Идентификатор финансового движения для организации двойной записи.
// 	       В большинстве случаев поле определяется как ОбъектРасчетов.УникальныйИдентификатор, в особых случаях может иметь значение не связанное с объектом расчетов.
// 	     * НастройкаХозяйственнойОперации - Неопределено, СправочникСсылка.НастройкиХозяйственныхОпераций - Настройка отражения хозяйственной операции в фин. учете.
// 	       В большинстве случаев поле имеет значение Неопределено, в особых случаях может быть указана ссылка на элемент справочника.
// 	     [Реквизиты документа]
// 	     * Сумма - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма возврата в валюте документа.
// 	     * СуммаВзаиморасчетов - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма возврата в валюте взаиморасчетов.
// 	     * ДатаКурса - Дата - Дата, на которую следует взять курсы валют для расчета сумм в управленческом и регламентированном учете.
// 	ТекстПереносРасчетов - Строка - Текст запроса получения данных расшифровки платежа возврата, на которую происходит зачет возврата.
// 	     Запрос должен возвращать выборку полей:
// 	     * Ссылка - ДокументСсылка - Документ-регистратор операции.
// 	     * ОбъектРасчетовИсточник - СправочникСсылка.ОбъектыРасчетов - Объект расчетов возврата.
// 	     * ОбъектРасчетовПриемник - СправочникСсылка.ОбъектыРасчетов - Объект расчетов, на который происходит зачет возврата.
// 	     [Общие]
// 	     * ДатаРегистратора - Дата - Дата и время документа регистратора.
// 	     * НомерРегистратора - Строка - Номер документа регистратора.
// 	     * ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов объекта расчетов, на который происходит зачет возврата.
// 	     * ВалютаДокумента - СправочникСсылка.Валюты - Валюта документа.
// 	     * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
// 	     [Реквизиты табличной части]
// 	     * Сумма - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма расчетов в валюте документа.
// 	     * СуммаВзаиморасчетов - ОпределяемыйТип.ДенежнаяСуммаЛюбогоЗнака - Сумма расчетов в валюте взаиморасчетов.
// 	     * ДатаКурса - Дата - Дата, на которую следует взять курсы валют для расчета сумм в управленческом и регламентированном учете.
//
Процедура ПроведениеВозвратаПереносаАвансаПоставщику(Запрос, ТекстыЗапроса, Регистры, ТекстПереносРасчетов = "") Экспорт
	
	Если НЕ ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщиками", Регистры) Тогда
		Возврат;
	КонецЕсли;
	
	Операция = "ВозвратПереносаАвансаПоставщику";
	
	#Область Проведение
	
	МассивТекстов = Новый Массив;
	ТекстыЗапросовДанныхДокумента = Новый Структура();
	ТекстыЗапросовДанныхДокумента.Вставить("ТаблицаРасшифровкаПлатежаПоставщик", ТекстПереносРасчетов);
	МассивТекстов.Добавить(ОтразитьПереносРасчетовСПоставщиком(Запрос, Операция));
	
	ТекстРасчетыСПоставщиками = СтрСоединить(МассивТекстов, ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении());
	
	ТекстыШаблоновОтражения = Новый Структура();
	Если ПроведениеДокументов.ТребуетсяТаблицаДляДвижений("РасчетыСПоставщиками", Регистры) Тогда
		ТекстыШаблоновОтражения.Вставить("РасчетыСПоставщиками", ТекстРасчетыСПоставщиками);
	КонецЕсли;
	
	#КонецОбласти
	
	ПроведениеДокументов.ДополнитьЗапросОтраженияДокумента(Запрос, ТекстыЗапроса, ТекстыШаблоновОтражения, ТекстыЗапросовДанныхДокумента);
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#КонецОбласти

#Область ПоискОснованийИДокументовОплаты

// Создает структуру параметров поиска оснований оплаты и документов оплаты
// 
// Параметры:
// 	РежимПоиска - Число - соответствие коду режима поиска:
// 		1 - Поиск документов оплаты; 
// 		2 - Поиск оснований (объектов) платежа.
// 
// Возвращаемое значение:
// 	Структура - содержит:
// 	* РежимПоиска - Число - соответствие коду режима поиска:
// 		1 - Поиск документов оплаты; 
// 		2 - Поиск оснований (объектов) платежа.
// 	* Организации - СправочникСсылка.Организации, Массив Из СправочникСсылка.Организации -
// 	* Документы   - Массив Из ДокументСсылка - документы, по которым производится поиск платежей.
// 	* НаДату      - Дата - для среза найденных документов на дату
// 	* ТолькоАвансы - Булево - Если "Истина", будут возвращены только авансовые платежи
// 	* ОграничитьТипыДокументовОплаты - Булево - Если "Истина", платежные документы будут ограничены возможными типами
// 	                                                входящих и исходящих документов оплат.
// 	* ОграничитьТипыОснованийОплаты  - Булево - Если "Истина", основания платежа будут ограничены возможными типами
// 	                                                входящих и исходящих документов.
// 	* ПараметрыОтбораПоТаблицеДокументов - Структура - Для отбора по временной таблице с документами, где:
//  	** ИмяПоля - Строка - Имя поля, в котором содержится документ
//  	** ИмяТаблицыОтбора - Строка - имя временной таблицы, где содержится документ
//
Функция ИнициализироватьПараметрыПоискаОснованийИДокументовОплаты(РежимПоиска = 1) Экспорт
	
	ПараметрыПоиска = Новый Структура;
	
	ПараметрыПоиска.Вставить("РежимПоиска",  РежимПоиска);
	ПараметрыПоиска.Вставить("Организации",  Неопределено);
	ПараметрыПоиска.Вставить("Документы",    Новый Массив);
	ПараметрыПоиска.Вставить("НаДату",       Дата(1,1,1));
	ПараметрыПоиска.Вставить("ТолькоАвансы", Ложь);
	ПараметрыПоиска.Вставить("ОграничитьТипыДокументовОплаты", Ложь);
	ПараметрыПоиска.Вставить("ОграничитьТипыОснованийОплаты", Ложь);
	
	// Документы, по которым необходимо найти платежные документы
	ПараметрыОтбораПоТаблицеДокументов = Новый Структура;
	ПараметрыОтбораПоТаблицеДокументов.Вставить("ИмяПоля",          "");
	ПараметрыОтбораПоТаблицеДокументов.Вставить("ИмяТаблицыОтбора", "");
	
	ПараметрыПоиска.Вставить("ПараметрыОтбораПоТаблицеДокументов", ПараметрыОтбораПоТаблицеДокументов);
	
	Возврат ПараметрыПоиска;
	
КонецФункции

// Подготовить временную таблицу "РасчетыСКлиентами_ОснованияИДокументыОплаты"
// Создает временную таблицу с колонками:
// 	  Организация;
// 	  ДокументОплаты - платежный документ;
// 	  ОснованиеОплаты - оплачиваемый документ;
// 	  АналитикаУчетаПоПартнерам;
// 	  ОбъектРасчетов;
// 	  НаправлениеДеятельности;
// 	  Контрагент;
// 	  Договор;
// 	  СуммаОплаты;
// 	  СуммаОплатыУпр;
// 	  СуммаОплатыРегл.
// 
// Параметры:
// 	МенеджерВременныхТаблиц - МенеджерВременныхТаблиц - 
// 	ПараметрыПоиска         - см. ИнициализироватьПараметрыПоискаОснованийИДокументовОплаты
Процедура ПодготовитьВТ_РасчетыСКлиентами_ОснованияИДокументыОплаты(МенеджерВременныхТаблиц, ПараметрыПоиска) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Расчеты.Организация                            КАК Организация,
	|	Расчеты.ДокументОплаты                         КАК ДокументОплаты,
	|	Расчеты.ОснованиеОплаты                        КАК ОснованиеОплаты,
	|	Расчеты.АналитикаУчетаПоПартнерам              КАК АналитикаУчетаПоПартнерам,
	|	Расчеты.ОбъектРасчетов                         КАК ОбъектРасчетов,
	|	Расчеты.ОбъектРасчетов.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Расчеты.ОбъектРасчетов.Контрагент              КАК Контрагент,
	|	Расчеты.ОбъектРасчетов.Договор                 КАК Договор,
	|	СУММА(Расчеты.СуммаОплаты)                     КАК СуммаОплаты,
	|	СУММА(Расчеты.СуммаОплатыУпр)                  КАК СуммаОплатыУпр,
	|	СУММА(Расчеты.СуммаОплатыРегл)                 КАК СуммаОплатыРегл
	|ПОМЕСТИТЬ РасчетыСКлиентами_ОснованияИДокументыОплаты
	|ИЗ
	|	(ВЫБРАТЬ
	|		Расчеты.ОбъектРасчетов.Организация КАК Организация,
	|		Расчеты.АналитикаУчетаПоПартнерам  КАК АналитикаУчетаПоПартнерам,
	|		Расчеты.ОбъектРасчетов             КАК ОбъектРасчетов,
	|		Расчеты.РасчетныйДокумент          КАК ДокументОплаты,
	|		Расчеты.ДокументРегистратор        КАК ОснованиеОплаты,
	|		Расчеты.Предоплата                 КАК СуммаОплаты,
	|		Расчеты.ПредоплатаУпр              КАК СуммаОплатыУпр,
	|		Расчеты.ПредоплатаРегл             КАК СуммаОплатыРегл
	|	ИЗ
	|		РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК Расчеты
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаОтбораОснованийИДокументовОплаты КАК ТаблицаОтбораОснованийИДокументовОплаты
	|				ПО &РежимПоиска1_ДокументРегистратор_РежимПоиска2_РасчетныйДокумент
	|	ГДЕ
	|		Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Расчеты.Период <= &ДатаОкончания
	|		И Расчеты.Предоплата <> 0
	|		И &НоваяАрхитектураВзаиморасчетов
	|		И Расчеты.ХозяйственнаяОперация В
	|			(ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаКлиента),
	|			 ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РезервированиеАвансаКлиента))
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Расчеты.ОбъектРасчетов.Организация,
	|		Расчеты.АналитикаУчетаПоПартнерам,
	|		Расчеты.ОбъектРасчетов,
	|		Расчеты.ДокументРегистратор,
	|		&ПолеОснованиеОплаты_ОбъектРасчетов,
	|		Расчеты.Долг,
	|		Расчеты.ДолгУпр,
	|		Расчеты.ДолгРегл
	|	ИЗ
	|		РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК Расчеты
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаОтбораОснованийИДокументовОплаты КАК ТаблицаОтбораОснованийИДокументовОплаты
	|				ПО &РежимПоиска1_ОбъектРасчетов_РежимПоиска2_ДокументРегистратор
	|	ГДЕ
	|		Расчеты.РасчетныйДокумент <> Расчеты.ДокументРегистратор
	|		И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Расчеты.Период <= &ДатаОкончания
	|		И Расчеты.Долг <> 0
	|		И &НоваяАрхитектураВзаиморасчетов
	|		И НЕ &ТолькоАвансы
	|		И Расчеты.ХозяйственнаяОперация <>
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеКредиторскойЗадолженности)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Расчеты.ОбъектРасчетов.Организация,
	|		Расчеты.АналитикаУчетаПоПартнерам,
	|		Расчеты.ОбъектРасчетов,
	|		Расчеты.ДокументРегистратор,
	|		Расчеты.РасчетныйДокумент,
	|		Расчеты.Долг,
	|		Расчеты.ДолгУпр,
	|		Расчеты.ДолгРегл
	|	ИЗ
	|		РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК Расчеты
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаОтбораОснованийИДокументовОплаты КАК ТаблицаОтбораОснованийИДокументовОплаты
	|				ПО &РежимПоиска1_РасчетныйДокумент_РежимПоиска2_ДокументРегистратор
	|	ГДЕ
	|		Расчеты.РасчетныйДокумент <> Расчеты.ОбъектРасчетов.Объект
	|		И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Расчеты.Период <= &ДатаОкончания
	|		И Расчеты.Долг <> 0
	|		И &НоваяАрхитектураВзаиморасчетов
	|		И НЕ &ТолькоАвансы
	|		И Расчеты.ХозяйственнаяОперация <>
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеКредиторскойЗадолженности)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Расчеты.АналитикаУчетаПоПартнерам.Организация КАК Организация,
	|		Расчеты.АналитикаУчетаПоПартнерам             КАК АналитикаУчетаПоПартнерам,
	|		Расчеты.ЗаказКлиента                          КАК ОбъектРасчетов,
	|		Расчеты.РасчетныйДокумент                     КАК ДокументОплаты,
	|		Расчеты.Регистратор                           КАК ОснованиеОплаты,
	|		Расчеты.Предоплата                            КАК СуммаОплаты,
	|		Расчеты.ПредоплатаУпр                         КАК СуммаОплатыУпр,
	|		Расчеты.ПредоплатаРегл                        КАК СуммаОплатыРегл
	|	ИЗ
	|		РегистрНакопления.РасчетыСКлиентамиПоДокументам КАК Расчеты
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаОтбораОснованийИДокументовОплаты КАК ТаблицаОтбораОснованийИДокументовОплаты
	|				ПО &РежимПоиска1_Регистратор_РежимПоиска2_РасчетныйДокумент
	|	ГДЕ
	|		Расчеты.Регистратор <> Расчеты.ЗаказКлиента.Объект
	|		И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		И Расчеты.Период <= &ДатаОкончания
	|		И Расчеты.Предоплата <> 0
	|		И НЕ &НоваяАрхитектураВзаиморасчетов
	|		И Расчеты.ХозяйственнаяОперация <>
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеКредиторскойЗадолженности)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Расчеты.АналитикаУчетаПоПартнерам.Организация,
	|		Расчеты.АналитикаУчетаПоПартнерам,
	|		Расчеты.ЗаказКлиента,
	|		Расчеты.Регистратор,
	|		&ПолеОснованиеОплаты_ЗаказКлиента,
	|		Расчеты.Предоплата,
	|		Расчеты.ПредоплатаУпр,
	|		Расчеты.ПредоплатаРегл
	|	ИЗ
	|		РегистрНакопления.РасчетыСКлиентамиПоДокументам КАК Расчеты
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаОтбораОснованийИДокументовОплаты КАК ТаблицаОтбораОснованийИДокументовОплаты
	|				ПО &РежимПоиска1_ЗаказКлиента_РежимПоиска2_Регистратор
	|	ГДЕ
	|		Расчеты.Регистратор = Расчеты.РасчетныйДокумент
	|		И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Расчеты.Период <= &ДатаОкончания
	|		И Расчеты.Предоплата <> 0
	|		И НЕ &НоваяАрхитектураВзаиморасчетов
	|		И Расчеты.ХозяйственнаяОперация <>
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеКредиторскойЗадолженности)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Расчеты.АналитикаУчетаПоПартнерам.Организация,
	|		Расчеты.АналитикаУчетаПоПартнерам,
	|		Расчеты.ЗаказКлиента,
	|		Расчеты.Регистратор,
	|		&ПолеОснованиеОплаты_ЗаказКлиента,
	|		Расчеты.Долг,
	|		Расчеты.ДолгУпр,
	|		Расчеты.ДолгРегл
	|	ИЗ
	|		РегистрНакопления.РасчетыСКлиентамиПоДокументам КАК Расчеты
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаОтбораОснованийИДокументовОплаты КАК ТаблицаОтбораОснованийИДокументовОплаты
	|				ПО &РежимПоиска1_ЗаказКлиента_РежимПоиска2_Регистратор
	|	ГДЕ
	|		Расчеты.РасчетныйДокумент <> Расчеты.Регистратор
	|		И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		И Расчеты.Период <= &ДатаОкончания
	|		И Расчеты.Долг <> 0
	|		И НЕ &НоваяАрхитектураВзаиморасчетов
	|		И НЕ &ТолькоАвансы
	|		И Расчеты.ХозяйственнаяОперация <>
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеКредиторскойЗадолженности)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Расчеты.АналитикаУчетаПоПартнерам.Организация,
	|		Расчеты.АналитикаУчетаПоПартнерам,
	|		Расчеты.ЗаказКлиента,
	|		Расчеты.Регистратор,
	|		Расчеты.РасчетныйДокумент,
	|		Расчеты.Долг,
	|		Расчеты.ДолгУпр,
	|		Расчеты.ДолгРегл
	|	ИЗ
	|		РегистрНакопления.РасчетыСКлиентамиПоДокументам КАК Расчеты
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаОтбораОснованийИДокументовОплаты КАК ТаблицаОтбораОснованийИДокументовОплаты
	|				ПО &РежимПоиска1_РасчетныйДокумент_РежимПоиска2_Регистратор
	|	ГДЕ
	|		Расчеты.РасчетныйДокумент <> Расчеты.ЗаказКлиента.Объект
	|		И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Расчеты.Период <= &ДатаОкончания
	|		И Расчеты.Долг <> 0
	|		И НЕ &НоваяАрхитектураВзаиморасчетов
	|		И НЕ &ТолькоАвансы
	|		И Расчеты.ХозяйственнаяОперация <>
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеКредиторскойЗадолженности)
	|	
	|	) КАК Расчеты
	|
	|ГДЕ
	|	(НЕ &ВключитьОтборПоОрганизациям
	|			ИЛИ Расчеты.Организация В (&Организации))
	|	И (НЕ &ОграничитьТипыДокументовОплаты
	|		ИЛИ ТИПЗНАЧЕНИЯ(Расчеты.ДокументОплаты) В (&мТиповДокументовОплатыВходящие))
	|	И (НЕ &ОграничитьТипыОснованийОплаты
	|		ИЛИ ТИПЗНАЧЕНИЯ(Расчеты.ОснованиеОплаты) В (&мТиповОснованийОплатыИсходящие))
	|
	|СГРУППИРОВАТЬ ПО
	|	Расчеты.Организация,
	|	Расчеты.ДокументОплаты,
	|	Расчеты.ОснованиеОплаты,
	|	Расчеты.АналитикаУчетаПоПартнерам,
	|	Расчеты.ОбъектРасчетов,
	|	Расчеты.ОбъектРасчетов.НаправлениеДеятельности,
	|	Расчеты.ОбъектРасчетов.Контрагент,
	|	Расчеты.ОбъектРасчетов.Договор
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументОплаты
	|
	|";
	
	ПостобработкаЗапроса_ПоискОснованийИДокументовОплаты(Запрос, ПараметрыПоиска);
	
	Запрос.Выполнить();
	
КонецПроцедуры

// Подготовить временную таблицу "РасчетыСПоставщиками_ОснованияИДокументыОплаты"
// Создает временную таблицу с колонками:
// 	  Организация;
// 	  ДокументОплаты - платежный документ;
// 	  ОснованиеОплаты - оплачиваемый документ;
// 	  АналитикаУчетаПоПартнерам;
// 	  ОбъектРасчетов;
// 	  НаправлениеДеятельности;
// 	  Контрагент;
// 	  Договор;
// 	  СуммаОплаты;
// 	  СуммаОплатыУпр;
// 	  СуммаОплатыРегл.
// 
// Параметры:
// 	МенеджерВременныхТаблиц - МенеджерВременныхТаблиц - 
// 	ПараметрыПоиска         - см. ИнициализироватьПараметрыПоискаОснованийИДокументовОплаты
Процедура ПодготовитьВТ_РасчетыСПоставщиками_ОснованияИДокументыОплаты(МенеджерВременныхТаблиц, ПараметрыПоиска) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Расчеты.Организация                            КАК Организация,
	|	Расчеты.ДокументОплаты                         КАК ДокументОплаты,
	|	Расчеты.ОснованиеОплаты                        КАК ОснованиеОплаты,
	|	Расчеты.АналитикаУчетаПоПартнерам              КАК АналитикаУчетаПоПартнерам,
	|	Расчеты.ОбъектРасчетов                         КАК ОбъектРасчетов,
	|	Расчеты.ОбъектРасчетов.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Расчеты.ОбъектРасчетов.Контрагент              КАК Контрагент,
	|	Расчеты.ОбъектРасчетов.Договор                 КАК Договор,
	|	СУММА(Расчеты.СуммаОплаты)                     КАК СуммаОплаты,
	|	СУММА(Расчеты.СуммаОплатыУпр)                  КАК СуммаОплатыУпр,
	|	СУММА(Расчеты.СуммаОплатыРегл)                 КАК СуммаОплатыРегл
	|ПОМЕСТИТЬ РасчетыСПоставщиками_ОснованияИДокументыОплаты
	|ИЗ
	|	(ВЫБРАТЬ
	|		Расчеты.ОбъектРасчетов.Организация КАК Организация,
	|		Расчеты.АналитикаУчетаПоПартнерам  КАК АналитикаУчетаПоПартнерам,
	|		Расчеты.ОбъектРасчетов             КАК ОбъектРасчетов,
	|		Расчеты.РасчетныйДокумент          КАК ДокументОплаты,
	|		Расчеты.ДокументРегистратор        КАК ОснованиеОплаты,
	|		Расчеты.Предоплата                 КАК СуммаОплаты,
	|		Расчеты.ПредоплатаУпр              КАК СуммаОплатыУпр,
	|		Расчеты.ПредоплатаРегл             КАК СуммаОплатыРегл
	|	ИЗ
	|		РегистрНакопления.РасчетыСПоставщикамиПоСрокам КАК Расчеты
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаОтбораОснованийИДокументовОплаты КАК ТаблицаОтбораОснованийИДокументовОплаты
	|				ПО &РежимПоиска1_ДокументРегистратор_РежимПоиска2_РасчетныйДокумент
	|	ГДЕ
	|		Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Расчеты.Период <= &ДатаОкончания
	|		И Расчеты.Предоплата <> 0
	|		И &НоваяАрхитектураВзаиморасчетов
	|		И Расчеты.ХозяйственнаяОперация =
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаПоставщику)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Расчеты.ОбъектРасчетов.Организация,
	|		Расчеты.АналитикаУчетаПоПартнерам,
	|		Расчеты.ОбъектРасчетов,
	|		Расчеты.ДокументРегистратор,
	|		&ПолеОснованиеОплаты_ОбъектРасчетов,
	|		Расчеты.Долг,
	|		Расчеты.ДолгУпр,
	|		Расчеты.ДолгРегл
	|	ИЗ
	|		РегистрНакопления.РасчетыСПоставщикамиПоСрокам КАК Расчеты
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаОтбораОснованийИДокументовОплаты КАК ТаблицаОтбораОснованийИДокументовОплаты
	|				ПО &РежимПоиска1_ОбъектРасчетов_РежимПоиска2_ДокументРегистратор
	|	ГДЕ
	|		Расчеты.РасчетныйДокумент <> Расчеты.ДокументРегистратор
	|		И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Расчеты.Период <= &ДатаОкончания
	|		И Расчеты.Долг <> 0
	|		И &НоваяАрхитектураВзаиморасчетов
	|		И НЕ &ТолькоАвансы
	|		И Расчеты.ХозяйственнаяОперация <>
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеКредиторскойЗадолженности)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Расчеты.ОбъектРасчетов.Организация,
	|		Расчеты.АналитикаУчетаПоПартнерам,
	|		Расчеты.ОбъектРасчетов,
	|		Расчеты.ДокументРегистратор,
	|		Расчеты.РасчетныйДокумент,
	|		Расчеты.Долг,
	|		Расчеты.ДолгУпр,
	|		Расчеты.ДолгРегл
	|	ИЗ
	|		РегистрНакопления.РасчетыСПоставщикамиПоСрокам КАК Расчеты
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаОтбораОснованийИДокументовОплаты КАК ТаблицаОтбораОснованийИДокументовОплаты
	|				ПО &РежимПоиска1_РасчетныйДокумент_РежимПоиска2_ДокументРегистратор
	|	ГДЕ
	|		Расчеты.РасчетныйДокумент <> Расчеты.ОбъектРасчетов.Объект
	|		И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Расчеты.Период <= &ДатаОкончания
	|		И Расчеты.Долг <> 0
	|		И &НоваяАрхитектураВзаиморасчетов
	|		И НЕ &ТолькоАвансы
	|		И Расчеты.ХозяйственнаяОперация <>
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеКредиторскойЗадолженности)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Расчеты.АналитикаУчетаПоПартнерам.Организация КАК Организация,
	|		Расчеты.АналитикаУчетаПоПартнерам             КАК АналитикаУчетаПоПартнерам,
	|		Расчеты.ЗаказПоставщику                       КАК ОбъектРасчетов,
	|		Расчеты.РасчетныйДокумент                     КАК ДокументОплаты,
	|		Расчеты.Регистратор                           КАК ОснованиеОплаты,
	|		Расчеты.Предоплата                            КАК СуммаОплаты,
	|		Расчеты.ПредоплатаУпр                         КАК СуммаОплатыУпр,
	|		Расчеты.ПредоплатаРегл                        КАК СуммаОплатыРегл
	|	ИЗ
	|		РегистрНакопления.РасчетыСПоставщикамиПоДокументам КАК Расчеты
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаОтбораОснованийИДокументовОплаты КАК ТаблицаОтбораОснованийИДокументовОплаты
	|				ПО &РежимПоиска1_Регистратор_РежимПоиска2_РасчетныйДокумент
	|	ГДЕ
	|		Расчеты.Регистратор <> Расчеты.ЗаказПоставщику.Объект
	|		И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Расчеты.Период <= &ДатаОкончания
	|		И Расчеты.Предоплата <> 0
	|		И НЕ &НоваяАрхитектураВзаиморасчетов
	|		И Расчеты.ХозяйственнаяОперация <>
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеКредиторскойЗадолженности)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Расчеты.АналитикаУчетаПоПартнерам.Организация,
	|		Расчеты.АналитикаУчетаПоПартнерам,
	|		Расчеты.ЗаказПоставщику,
	|		Расчеты.Регистратор,
	|		&ПолеОснованиеОплаты_ЗаказПоставщику,
	|		Расчеты.Предоплата,
	|		Расчеты.ПредоплатаУпр,
	|		Расчеты.ПредоплатаРегл
	|	ИЗ
	|		РегистрНакопления.РасчетыСПоставщикамиПоДокументам КАК Расчеты
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаОтбораОснованийИДокументовОплаты КАК ТаблицаОтбораОснованийИДокументовОплаты
	|				ПО &РежимПоиска1_ЗаказПоставщику_РежимПоиска2_Регистратор
	|	ГДЕ
	|		Расчеты.Регистратор = Расчеты.РасчетныйДокумент
	|		И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		И Расчеты.Период <= &ДатаОкончания
	|		И Расчеты.Предоплата <> 0
	|		И НЕ &НоваяАрхитектураВзаиморасчетов
	|		И Расчеты.ХозяйственнаяОперация <>
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеКредиторскойЗадолженности)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Расчеты.АналитикаУчетаПоПартнерам.Организация,
	|		Расчеты.АналитикаУчетаПоПартнерам,
	|		Расчеты.ЗаказПоставщику,
	|		Расчеты.Регистратор,
	|		&ПолеОснованиеОплаты_ЗаказПоставщику,
	|		Расчеты.Долг,
	|		Расчеты.ДолгУпр,
	|		Расчеты.ДолгРегл
	|	ИЗ
	|		РегистрНакопления.РасчетыСПоставщикамиПоДокументам КАК Расчеты
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаОтбораОснованийИДокументовОплаты КАК ТаблицаОтбораОснованийИДокументовОплаты
	|				ПО &РежимПоиска1_ЗаказПоставщику_РежимПоиска2_Регистратор
	|	ГДЕ
	|		Расчеты.РасчетныйДокумент <> Расчеты.Регистратор
	|		И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		И Расчеты.Период <= &ДатаОкончания
	|		И Расчеты.Долг <> 0
	|		И НЕ &НоваяАрхитектураВзаиморасчетов
	|		И НЕ &ТолькоАвансы
	|		И Расчеты.ХозяйственнаяОперация <>
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеКредиторскойЗадолженности)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Расчеты.АналитикаУчетаПоПартнерам.Организация,
	|		Расчеты.АналитикаУчетаПоПартнерам,
	|		Расчеты.ЗаказПоставщику,
	|		Расчеты.Регистратор,
	|		Расчеты.РасчетныйДокумент,
	|		Расчеты.Долг,
	|		Расчеты.ДолгУпр,
	|		Расчеты.ДолгРегл
	|	ИЗ
	|		РегистрНакопления.РасчетыСПоставщикамиПоДокументам КАК Расчеты
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаОтбораОснованийИДокументовОплаты КАК ТаблицаОтбораОснованийИДокументовОплаты
	|				ПО &РежимПоиска1_РасчетныйДокумент_РежимПоиска2_Регистратор
	|	ГДЕ
	|		Расчеты.РасчетныйДокумент <> Расчеты.ЗаказПоставщику.Объект
	|		И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		И Расчеты.Период <= &ДатаОкончания
	|		И Расчеты.Долг <> 0
	|		И НЕ &НоваяАрхитектураВзаиморасчетов
	|		И НЕ &ТолькоАвансы
	|		И Расчеты.ХозяйственнаяОперация <>
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеКредиторскойЗадолженности)
	|	
	|	) КАК Расчеты
	|
	|ГДЕ
	|	(НЕ &ВключитьОтборПоОрганизациям
	|			ИЛИ Расчеты.Организация В (&Организации))
	|	И (НЕ &ОграничитьТипыДокументовОплаты
	|		ИЛИ ТИПЗНАЧЕНИЯ(Расчеты.ДокументОплаты) В (&мТиповДокументовОплатыИсходящие))
	|	И (НЕ &ОграничитьТипыОснованийОплаты
	|		ИЛИ ТИПЗНАЧЕНИЯ(Расчеты.ОснованиеОплаты) В (&мТиповОснованийОплатыВходящие))
	|
	|СГРУППИРОВАТЬ ПО
	|	Расчеты.Организация,
	|	Расчеты.ДокументОплаты,
	|	Расчеты.ОснованиеОплаты,
	|	Расчеты.АналитикаУчетаПоПартнерам,
	|	Расчеты.ОбъектРасчетов,
	|	Расчеты.ОбъектРасчетов.НаправлениеДеятельности,
	|	Расчеты.ОбъектРасчетов.Контрагент,
	|	Расчеты.ОбъектРасчетов.Договор
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументОплаты
	|
	|";
	
	ПостобработкаЗапроса_ПоискОснованийИДокументовОплаты(Запрос, ПараметрыПоиска);
	
	Запрос.Выполнить();
	
КонецПроцедуры

#КонецОбласти

#Область АвансыПоДаннымВзаиморасчетов

// Создает структуру параметров для подготовки временных таблиц с расчетами
// 
// Параметры:
//  ИсходныеПараметры - Неопределено, Структура - произвольная структура с заполненными значениями
// 
// Возвращаемое значение:
// 	Структура - Описание:
//   * ДатаНачала                    - Дата -
//   * ДатаОкончания                 - Дата -
//   * Организации                   - Неопределено, СправочникСсылка.Организации, Массив из СправочникСсылка.Организации -
//   * РасчетныйДокумент             - Неопределено, ДокументСсылка - дополнительный фильтр по расчетному документу
//   * СоздатьПустуюТаблицу          - Булево - позволяет создать каркас временной таблицы без данных
//   * НоваяАрхитектураВзаиморасчетов - Булево - взаиморасчеты "онлайн"/"офлайн"
//   * ВключитьОтборПоОрганизациям - Булево - применять отбор по организации
//   * ПоляИндексовВручную           - Массив из Строка - возможность переопределения полей индексов результата
//   * УчестьРезервированиеАвансов   - Булево - если "Истина", зачтенные авансы,
//                                     которые ранее были зарезервированы, не попадут в выборку.
//   * ПараметрыОтбораПоРасчетномуДокументу - Структура - Для отбора по временной таблице с расчетными документами, где:
//   	** ИмяПоля - Строка - Имя поля, в котором содержится документ
//   	** ИмяТаблицыОтбора - Строка - имя временной таблицы, где содержится документ
//   * ПравилоОтбораАвансов          - ПеречислениеСсылка.ПорядокРегистрацииСчетовФактурНаАванс - правило отбора авансов.
//
Функция ИнициализироватьПараметрыПодготовкиРасчетовАвансов(ИсходныеПараметры = Неопределено) Экспорт
	
	ПараметрыРасчетов = Новый Структура;
	
	ПустаяДата = '00010101';
	
	ПараметрыРасчетов.Вставить("ДатаНачала",           ПустаяДата);
	ПараметрыРасчетов.Вставить("ДатаОкончания",        ПустаяДата);
	ПараметрыРасчетов.Вставить("Организации",          Неопределено);
	ПараметрыРасчетов.Вставить("РасчетныйДокумент",    Неопределено);
	ПараметрыРасчетов.Вставить("СоздатьПустуюТаблицу", Ложь);
	ПараметрыРасчетов.Вставить("НоваяАрхитектураВзаиморасчетов",
		ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов"));
	ПараметрыРасчетов.Вставить("ВключитьОтборПоОрганизациям", Ложь);
	
	// Для отбора по временной таблице с расчетными документами
	ПараметрыОтбораПоРасчетномуДокументу = Новый Структура;
	ПараметрыОтбораПоРасчетномуДокументу.Вставить("ИмяПоля",          "РасчетныйДокумент");
	ПараметрыОтбораПоРасчетномуДокументу.Вставить("ИмяТаблицыОтбора", "");
	
	ПараметрыРасчетов.Вставить("ПараметрыОтбораПоРасчетномуДокументу", ПараметрыОтбораПоРасчетномуДокументу);
	
	ПараметрыРасчетов.Вставить("ПоляИндексовВручную",         Новый Массив);
	ПараметрыРасчетов.Вставить("УчестьРезервированиеАвансов", Ложь);
	ПараметрыРасчетов.Вставить("ПравилоОтбораАвансов", Перечисления.ПорядокРегистрацииСчетовФактурНаАванс.ВсеОплаты);
	
	ЗаполнитьСвойстваПараметров(ПараметрыРасчетов, ИсходныеПараметры);
	
	Возврат ПараметрыРасчетов;
	
КонецФункции

#Область АвансыПолученные

// Подготовить временную таблицу "РасчетыСКлиентами_Авансы"
// Создает временную таблицу с колонками:
// 	  РасчетныйДокумент;
// 	  ДокументРегистратор;
// 	  Организация;
// 	  АналитикаУчетаПоПартнерам;
// 	  ОбъектРасчетов;
// 	  НаправлениеДеятельности;
// 	  Контрагент;
// 	  Договор;
// 	  ДатаАванса;
// 	  ВалютаДокумента;
// 	  СуммаАвансаВал - сумма в валюте документа;
// 	  СуммаАванса;
// 	  СуммаАвансаУпр;
// 	  СуммаАвансаРегл.
//
// Параметры:
//  МенеджерВременныхТаблиц - МенеджерВременныхТаблиц - 
//  ПараметрыРасчета        - см. ИнициализироватьПараметрыПодготовкиРасчетовАвансов
Процедура ПодготовитьВТ_РасчетыСКлиентами_Авансы(МенеджерВременныхТаблиц, ПараметрыРасчета) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	УстановитьПараметрыЗапросаПодготовкиРасчетовАвансов(Запрос, ПараметрыРасчета);
	
	Запрос.Текст =
	"// Новая архитектура взаиморасчетов 
	|	ВЫБРАТЬ
	|	Расчеты.РасчетныйДокумент КАК РасчетныйДокумент,
	|	Расчеты.ДокументРегистратор КАК ДокументРегистратор,
	|	Расчеты.ОбъектРасчетов.Организация КАК Организация,
	|	Расчеты.ОбъектРасчетов.Организация.ВалютаРегламентированногоУчета КАК ВалютаРегламентированногоУчета,
	|	МИНИМУМ(Расчеты.ДатаВозникновения) КАК ДатаАванса,
	|	ЛОЖЬ КАК Взаимозачет
	|ПОМЕСТИТЬ ОтборАвансов
	|ИЗ
	|	РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК Расчеты
	|ГДЕ
	|	&НоваяАрхитектураВзаиморасчетов
	|	И НЕ &СоздатьПустуюТаблицу
	|	И Расчеты.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
	|	И (НЕ &ВключитьОтборПоОрганизациям
	|			ИЛИ Расчеты.ОбъектРасчетов.Организация В (&Организации))
	|	И &ТекстОтборПоПараметрам
	|	И Расчеты.ДатаВозникновения МЕЖДУ &ДатаНачала И &ДатаОкончания
	|	И Расчеты.Активность = ИСТИНА
	|	И ВЫБОР
	|		КОГДА ВЫРАЗИТЬ(Расчеты.ДокументРегистратор КАК Документ.ВзаимозачетЗадолженности).ВидОперации В (
	|				ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаОрганизацияКонтрагент),
	|				ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаМеждуКонтрагентами),
	|				ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуОрганизацияКонтрагент),
	|				ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуМеждуКонтрагентами),
	|				ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаМеждуДвумяОрганизациями),
	|				ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуМеждуДвумяОрганизациями))
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ
	|
	|СГРУППИРОВАТЬ ПО
	|	Расчеты.РасчетныйДокумент,
	|	Расчеты.ДокументРегистратор,
	|	Расчеты.ОбъектРасчетов.Организация,
	|	Расчеты.ОбъектРасчетов.Организация.ВалютаРегламентированногоУчета
	|
	|ИМЕЮЩИЕ
	|	СУММА(Расчеты.Предоплата * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ) > 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|	ВложенныйЗапрос.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ВложенныйЗапрос.ДокументРегистратор КАК ДокументРегистратор,
	|	ВложенныйЗапрос.Организация КАК Организация,
	|	ВложенныйЗапрос.ВалютаРегламентированногоУчета КАК ВалютаРегламентированногоУчета,
	|	МИНИМУМ(ВложенныйЗапрос.ДатаВозникновения) КАК ДатаАванса,
	|	ИСТИНА КАК Взаимозачет
	|ИЗ
	|	(ВЫБРАТЬ
	|		Расчеты.РасчетныйДокумент КАК РасчетныйДокумент,
	|		Расчеты.ДокументРегистратор КАК ДокументРегистратор,
	|		Расчеты.ОбъектРасчетов.Организация КАК Организация,
	|		Расчеты.ОбъектРасчетов.Организация.ВалютаРегламентированногоУчета КАК ВалютаРегламентированногоУчета,
	|		МИНИМУМ(Расчеты.ДатаВозникновения) КАК ДатаВозникновения
	|	ИЗ
	|		РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК Расчеты
	|	ГДЕ
	|		&НоваяАрхитектураВзаиморасчетов
	|		И НЕ &СоздатьПустуюТаблицу
	|		И Расчеты.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
	|		И (НЕ &ВключитьОтборПоОрганизациям
	|				ИЛИ Расчеты.ОбъектРасчетов.Организация В (&Организации))
	|		И (НЕ &ВключитьОтборПоРасчетномуДокументу
	|				ИЛИ Расчеты.РасчетныйДокумент В (&РасчетныйДокумент))
	|		И ВЫРАЗИТЬ(Расчеты.ДокументРегистратор КАК Документ.ВзаимозачетЗадолженности).ВидОперации В (ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаОрганизацияКонтрагент), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаМеждуКонтрагентами), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуОрганизацияКонтрагент), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуМеждуКонтрагентами), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаМеждуДвумяОрганизациями), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуМеждуДвумяОрганизациями))
	|		И Расчеты.ДатаВозникновения МЕЖДУ &ДатаНачала И &ДатаОкончания
	|		И Расчеты.Активность = ИСТИНА
	|		И ВЫБОР
	|				КОГДА &ПравилоОтбораАвансов = ЗНАЧЕНИЕ(Перечисление.ПорядокРегистрацииСчетовФактурНаАванс.КромеЗачтенныхВТечениеДня)
	|					ТОГДА РАЗНОСТЬДАТ(Расчеты.ДатаВозникновения, Расчеты.Период, ДЕНЬ) < 1
	|				КОГДА &ПравилоОтбораАвансов = ЗНАЧЕНИЕ(Перечисление.ПорядокРегистрацииСчетовФактурНаАванс.КромеЗачтенныхВТечениеПятиДней)
	|					ТОГДА РАЗНОСТЬДАТ(Расчеты.ДатаВозникновения, Расчеты.Период, ДЕНЬ) < 5
	|				КОГДА &ПравилоОтбораАвансов = ЗНАЧЕНИЕ(Перечисление.ПорядокРегистрацииСчетовФактурНаАванс.КромеЗачтенныхВТечениеМесяца)
	|					ТОГДА Расчеты.Период <= КОНЕЦПЕРИОДА(Расчеты.ДатаВозникновения, МЕСЯЦ)
	|				КОГДА &ПравилоОтбораАвансов = ЗНАЧЕНИЕ(Перечисление.ПорядокРегистрацииСчетовФактурНаАванс.КромеЗачтенныхВТечениеКвартала)
	|					ТОГДА Расчеты.Период <= КОНЕЦПЕРИОДА(Расчеты.ДатаВозникновения, КВАРТАЛ)
	|				ИНАЧЕ ИСТИНА
	|			КОНЕЦ
	|	
	|	СГРУППИРОВАТЬ ПО
	|		Расчеты.РасчетныйДокумент,
	|		Расчеты.ДокументРегистратор,
	|		Расчеты.ОбъектРасчетов,
	|		Расчеты.ОбъектРасчетов.Организация,
	|		Расчеты.ОбъектРасчетов.Организация.ВалютаРегламентированногоУчета
	|	
	|	ИМЕЮЩИЕ
	|		СУММА(Расчеты.Предоплата * ВЫБОР
	|				КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|					ТОГДА -1
	|				ИНАЧЕ 1
	|			КОНЕЦ) > 0) КАК ВложенныйЗапрос
	|
	|СГРУППИРОВАТЬ ПО
	|	ВложенныйЗапрос.РасчетныйДокумент,
	|	ВложенныйЗапрос.ДокументРегистратор,
	|	ВложенныйЗапрос.Организация,
	|	ВложенныйЗапрос.ВалютаРегламентированногоУчета
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|// Старая архитектура взаиморасчетов
	|ВЫБРАТЬ
	|	Расчеты.РасчетныйДокумент,
	|	Расчеты.Регистратор,
	|	Расчеты.АналитикаУчетаПоПартнерам.Организация,
	|	Расчеты.АналитикаУчетаПоПартнерам.Организация.ВалютаРегламентированногоУчета,
	|	NULL,
	|	ЛОЖЬ
	|ИЗ
	|	РегистрНакопления.РасчетыСКлиентамиПоДокументам КАК Расчеты
	|ГДЕ
	|	НЕ &НоваяАрхитектураВзаиморасчетов
	|	И НЕ &СоздатьПустуюТаблицу
	|	И Расчеты.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
	|	И (НЕ &ВключитьОтборПоОрганизациям
	|			ИЛИ Расчеты.АналитикаУчетаПоПартнерам.Организация В (&Организации))
	|	И &ТекстОтборПоПараметрам
	|	И Расчеты.Активность = ИСТИНА
	|	И (Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				И Расчеты.ПредоплатаРегл > 0
	|			ИЛИ Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				И Расчеты.ПредоплатаРегл < 0)
	|
	|СГРУППИРОВАТЬ ПО
	|	Расчеты.АналитикаУчетаПоПартнерам.Организация,
	|	Расчеты.АналитикаУчетаПоПартнерам.Организация.ВалютаРегламентированногоУчета,
	|	Расчеты.Регистратор,
	|	Расчеты.РасчетныйДокумент
	|
	|ИМЕЮЩИЕ
	|	СУММА(ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА Расчеты.ПредоплатаРегл
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА -Расчеты.ПредоплатаРегл
	|		КОНЕЦ) > 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументРегистратор,
	|	РасчетныйДокумент,
	|	Организация
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Расчеты.РасчетныйДокумент КАК РасчетныйДокумент,
	|	Расчеты.ДокументРегистратор КАК ДокументРегистратор,
	|	Расчеты.ОбъектРасчетов.Организация КАК Организация,
	|	Расчеты.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Расчеты.ОбъектРасчетов КАК ОбъектРасчетов,
	|	Расчеты.ОбъектРасчетов.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Расчеты.ОбъектРасчетов.Контрагент КАК Контрагент,
	|	Расчеты.ОбъектРасчетов.Договор КАК Договор,
	|	МИНИМУМ(ОтборАвансов.ДатаАванса) КАК ДатаАванса,
	|	МАКСИМУМ(ВЫБОР
	|				КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПриходныйКассовыйОрдер
	|					ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПриходныйКассовыйОрдер).Валюта
	|				КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПоступлениеБезналичныхДенежныхСредств
	|					ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПоступлениеБезналичныхДенежныхСредств).Валюта
	|				КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПервичныйДокумент
	|					ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПервичныйДокумент).Валюта
	|				ИНАЧЕ Расчеты.Валюта
	|		КОНЕЦ) КАК ВалютаДокумента,
	|	СУММА(ВЫБОР
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПриходныйКассовыйОрдер
	|					И ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПриходныйКассовыйОрдер).Валюта = ОтборАвансов.ВалютаРегламентированногоУчета
	|				ТОГДА Расчеты.ПредоплатаРегл
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПоступлениеБезналичныхДенежныхСредств
	|					И ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПоступлениеБезналичныхДенежныхСредств).Валюта = ОтборАвансов.ВалютаРегламентированногоУчета
	|				ТОГДА Расчеты.ПредоплатаРегл
	|			ИНАЧЕ
	|				Расчеты.Предоплата
	|		КОНЕЦ
	|		* ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ) КАК СуммаАвансаВал,
	|	СУММА(Расчеты.Предоплата * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ) КАК СуммаАванса,
	|	СУММА(Расчеты.ПредоплатаУпр * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ) КАК СуммаАвансаУпр,
	|	СУММА(Расчеты.ПредоплатаРегл * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ) КАК СуммаАвансаРегл
	|ПОМЕСТИТЬ РасчетыСКлиентами_Авансы_Предварительная
	|ИЗ
	|	ОтборАвансов КАК ОтборАвансов
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
	|		РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК Расчеты
	|	ПО
	|		ОтборАвансов.ДокументРегистратор    = Расчеты.ДокументРегистратор
	|		И  ОтборАвансов.РасчетныйДокумент   = Расчеты.РасчетныйДокумент
	|		И  ОтборАвансов.Организация         = Расчеты.ОбъектРасчетов.Организация
	|		И  Расчеты.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
	|		И  Расчеты.ДатаВозникновения МЕЖДУ &ДатаНачала И &ДатаОкончания
	|		И  Расчеты.Активность  = ИСТИНА
	|
	|СГРУППИРОВАТЬ ПО
	|	Расчеты.РасчетныйДокумент,
	|	Расчеты.ДокументРегистратор,
	|	Расчеты.ОбъектРасчетов.Организация,
	|	Расчеты.АналитикаУчетаПоПартнерам,
	|	Расчеты.ОбъектРасчетов
	|
	|ИМЕЮЩИЕ
	|	СУММА(Расчеты.Предоплата * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ) > 0
	|
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|// Старая архитектура взаиморасчетов
	|ВЫБРАТЬ
	|	Расчеты.РасчетныйДокумент КАК РасчетныйДокумент,
	|	Расчеты.Регистратор КАК ДокументРегистратор,
	|	Расчеты.АналитикаУчетаПоПартнерам.Организация КАК Организация,
	|	Расчеты.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Расчеты.ЗаказКлиента КАК ОбъектРасчетов,
	|	Расчеты.АналитикаУчетаПоПартнерам.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Расчеты.АналитикаУчетаПоПартнерам.Контрагент КАК Контрагент,
	|	Расчеты.АналитикаУчетаПоПартнерам.Договор КАК Договор,
	|	МИНИМУМ(НАЧАЛОПЕРИОДА(Расчеты.Период, ДЕНЬ)) КАК ДатаАванса,
	|	МАКСИМУМ(ВЫБОР
	|		КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПриходныйКассовыйОрдер
	|			ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПриходныйКассовыйОрдер).Валюта
	|		КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПоступлениеБезналичныхДенежныхСредств
	|			ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПоступлениеБезналичныхДенежныхСредств).Валюта
	|		КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПервичныйДокумент
	|			ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПервичныйДокумент).Валюта
	|		ИНАЧЕ Расчеты.Валюта
	|	КОНЕЦ) КАК ВалютаДокумента,
	|	СУММА(ВЫБОР
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПриходныйКассовыйОрдер
	|					И ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПриходныйКассовыйОрдер).Валюта = ОтборАвансов.ВалютаРегламентированногоУчета
	|				ТОГДА Расчеты.ПредоплатаРегл
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПоступлениеБезналичныхДенежныхСредств
	|					И ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПоступлениеБезналичныхДенежныхСредств).Валюта = ОтборАвансов.ВалютаРегламентированногоУчета
	|				ТОГДА Расчеты.ПредоплатаРегл
	|			ИНАЧЕ
	|				Расчеты.Предоплата
	|		КОНЕЦ
	|		* ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА 1
	|			ИНАЧЕ -1
	|		КОНЕЦ) КАК СуммаАвансаВал,
	|	СУММА(ВЫБОР 
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА Расчеты.Предоплата
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА -Расчеты.Предоплата
	|		КОНЕЦ) КАК СуммаАванса,
	|	СУММА(ВЫБОР 
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА Расчеты.ПредоплатаУпр
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА -Расчеты.ПредоплатаУпр
	|		КОНЕЦ) КАК СуммаАвансаУпр,
	|	СУММА(ВЫБОР 
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА Расчеты.ПредоплатаРегл
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА -Расчеты.ПредоплатаРегл
	|		КОНЕЦ) КАК СуммаАвансаРегл
	|ИЗ
	|	ОтборАвансов КАК ОтборАвансов
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
	|		РегистрНакопления.РасчетыСКлиентамиПоДокументам КАК Расчеты
	|	ПО
	|		ОтборАвансов.ДокументРегистратор    = Расчеты.Регистратор
	|		И  ОтборАвансов.РасчетныйДокумент   = Расчеты.РасчетныйДокумент
	|		И  ОтборАвансов.Организация         = Расчеты.АналитикаУчетаПоПартнерам.Организация
	|		И  Расчеты.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
	|		И  Расчеты.Активность  = ИСТИНА
	|
	|СГРУППИРОВАТЬ ПО
	|	Расчеты.РасчетныйДокумент,
	|	Расчеты.Регистратор,
	|	Расчеты.АналитикаУчетаПоПартнерам.Организация,
	|	Расчеты.АналитикаУчетаПоПартнерам,
	|	Расчеты.ЗаказКлиента,
	|	Расчеты.АналитикаУчетаПоПартнерам.НаправлениеДеятельности,
	|	Расчеты.АналитикаУчетаПоПартнерам.Контрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(ВЫБОР 
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА Расчеты.Предоплата
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА -Расчеты.Предоплата
	|		КОНЕЦ) > 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|ВЫБРАТЬ
	|	Расчеты.РасчетныйДокумент КАК РасчетныйДокумент,
	|	Расчеты.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Расчеты.ОбъектРасчетов КАК ОбъектРасчетов,
	|	МИНИМУМ(ОтборАвансов.ДатаАванса) КАК ДатаАванса,
	|	МАКСИМУМ(ВЫБОР
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПриходныйКассовыйОрдер
	|				ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПриходныйКассовыйОрдер).Валюта
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПоступлениеБезналичныхДенежныхСредств
	|				ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПоступлениеБезналичныхДенежныхСредств).Валюта
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПервичныйДокумент
	|				ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПервичныйДокумент).Валюта
	|			ИНАЧЕ Расчеты.Валюта
	|		КОНЕЦ) КАК ВалютаДокумента,
	|	СУММА(ВЫБОР
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПриходныйКассовыйОрдер
	|					И ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПриходныйКассовыйОрдер).Валюта = ОтборАвансов.ВалютаРегламентированногоУчета
	|				ТОГДА Расчеты.ПредоплатаРегл
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПоступлениеБезналичныхДенежныхСредств
	|					И ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПоступлениеБезналичныхДенежныхСредств).Валюта = ОтборАвансов.ВалютаРегламентированногоУчета
	|				ТОГДА Расчеты.ПредоплатаРегл
	|			ИНАЧЕ Расчеты.Предоплата
	|		КОНЕЦ * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ) КАК СуммаАвансаВал,
	|	СУММА(Расчеты.Предоплата * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ) КАК СуммаАванса,
	|	СУММА(Расчеты.ПредоплатаУпр * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ) КАК СуммаАвансаУпр,
	|	СУММА(Расчеты.ПредоплатаРегл * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ) КАК СуммаАвансаРегл
	|ПОМЕСТИТЬ ПереносАванса
	|
	|ИЗ
	|	ОтборАвансов КАК ОтборАвансов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК Расчеты
	|		ПО (ОтборАвансов.ДокументРегистратор = Расчеты.ДокументРегистратор)
	|			И (ОтборАвансов.РасчетныйДокумент = Расчеты.РасчетныйДокумент)
	|			И (ОтборАвансов.Организация = Расчеты.ОбъектРасчетов.Организация)
	|			И (Расчеты.Период МЕЖДУ &ДатаНачала И &ДатаОкончания)
	|			И (Расчеты.ДатаВозникновения МЕЖДУ &ДатаНачала И &ДатаОкончания)
	|			И (Расчеты.Активность = ИСТИНА)
	|			И (Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход))
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК Расчеты_Приход
	|		ПО (ОтборАвансов.ДокументРегистратор = Расчеты_Приход.ДокументРегистратор)
	|			И (ОтборАвансов.РасчетныйДокумент = Расчеты_Приход.РасчетныйДокумент)
	|			И (ОтборАвансов.Организация = Расчеты_Приход.ОбъектРасчетов.Организация)
	|			И (Расчеты_Приход.Период МЕЖДУ &ДатаНачала И &ДатаОкончания)
	|			И (Расчеты_Приход.ДатаВозникновения МЕЖДУ &ДатаНачала И &ДатаОкончания)
	|			И (Расчеты_Приход.Активность = ИСТИНА)
	|			И (Расчеты_Приход.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			И (Расчеты_Приход.ОбъектРасчетов = Расчеты.ОбъектРасчетовПриемник)
	|			И (Расчеты_Приход.АналитикаУчетаПоПартнерам = Расчеты.АналитикаУчетаПоПартнерамПриемник))
	|			
	|ГДЕ
	|	ОтборАвансов.Взаимозачет = ИСТИНА
	|
	|СГРУППИРОВАТЬ ПО
	|	Расчеты.РасчетныйДокумент,
	|	Расчеты.АналитикаУчетаПоПартнерам,
	|	Расчеты.ОбъектРасчетов
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент,
	|	АналитикаУчетаПоПартнерам,
	|	ОбъектРасчетов,
	|	ДатаАванса,
	|	ВалютаДокумента
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Расчеты.РасчетныйДокумент КАК РасчетныйДокумент,
	|	Расчеты.ДокументРегистратор КАК ДокументРегистратор,
	|	Расчеты.Организация КАК Организация,
	|	Расчеты.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Расчеты.ОбъектРасчетов КАК ОбъектРасчетов,
	|	Расчеты.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Расчеты.Контрагент КАК Контрагент,
	|	Расчеты.Договор КАК Договор,
	|	Расчеты.ДатаАванса КАК ДатаАванса,
	|	Расчеты.ВалютаДокумента КАК ВалютаДокумента,
	|	Расчеты.СуммаАвансаВал + ЕСТЬNULL(ПереносАванса.СуммаАвансаВал,0) КАК СуммаАвансаВал,
	|	Расчеты.СуммаАванса + ЕСТЬNULL(ПереносАванса.СуммаАванса,0) КАК СуммаАванса,
	|	Расчеты.СуммаАвансаУпр + ЕСТЬNULL(ПереносАванса.СуммаАвансаУпр,0) КАК СуммаАвансаУпр,
	|	Расчеты.СуммаАвансаРегл + ЕСТЬNULL(ПереносАванса.СуммаАвансаРегл,0) КАК СуммаАвансаРегл
	|ПОМЕСТИТЬ РасчетыСКлиентами_Авансы
	|ИЗ
	|	РасчетыСКлиентами_Авансы_Предварительная КАК Расчеты
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		ПереносАванса КАК ПереносАванса
	|	ПО
	|		Расчеты.РасчетныйДокумент = ПереносАванса.РасчетныйДокумент
	|		И Расчеты.АналитикаУчетаПоПартнерам = ПереносАванса.АналитикаУчетаПоПартнерам
	|		И Расчеты.ОбъектРасчетов = ПереносАванса.ОбъектРасчетов
	|		И Расчеты.ДатаАванса = ПереносАванса.ДатаАванса
	|		И Расчеты.ВалютаДокумента = ПереносАванса.ВалютаДокумента
	|;
	|
	|УНИЧТОЖИТЬ ОтборАвансов
	|
	|;
	|
	|УНИЧТОЖИТЬ РасчетыСКлиентами_Авансы_Предварительная
	|
	|;
	|
	|УНИЧТОЖИТЬ ПереносАванса
	|";
	
	УстановитьПоляИндексов(Запрос, ПараметрыРасчета, "РасчетыСКлиентами_Авансы");
	
	ПараметрыПутей = ИнициализироватьПараметрыДляОтбораАвансов_ПутиКПолямИТекстуЗамены();
	ОбработатьТекстЗапросаДляОтбораАвансовПоПараметрам(Запрос, ПараметрыРасчета, ПараметрыПутей);
	
	Запрос.Выполнить();
	
	
КонецПроцедуры

// Подготовить временную таблицу "РасчетыСКлиентами_ПогашенияАвансов"
// Создает временную таблицу с колонками:
// 	  РасчетныйДокумент;
// 	  Организация;
// 	  АналитикаУчетаПоПартнерам;
// 	  ОбъектРасчетов;
// 	  ДокументРегистратор;
// 	  Контрагент;
// 	  Договор;
// 	  НаправлениеДеятельности;
// 	  ИсхКонтрагент - контрагент, по которому возник аванс;
// 	  ИсхДоговор    - договор, по которому возник аванс;
// 	  ИсхНаправлениеДеятельности - направление, по которому возник аванс;
// 	  КорАналитикаУчетаПоПартнерам;
// 	  ИсходнаяАналитикаУчетаПоПартнерам - аналитика, по которой образовался аванс;
// 	  КорОбъектРасчетов;
// 	  ИсходныйОбъектРасчетов - объект расчетов, по которому образовался аванс;
// 	  ДатаАванса;
// 	  ДатаПогашения;
// 	  СобытиеЗнак - Если погашение произошло по причине зачета аванса, тогда СобытиеЗнак >= 0,
// 	                Если погашение произошло по причине возврата/списания задолженности, тогда СобытиеЗнак < 0;
// 	  ВидСобытия - событие, в связи с которым произошло погашение аванса. Возможные события:
// 	         - Перечисление.ХозяйственныеОперации.СписаниеКредиторскойЗадолженности,
// 	         - Перечисление.ХозяйственныеОперации.ВозвратОплатыКлиенту,
// 	         - Перечисление.ХозяйственныеОперации.ЗачетАвансаКлиенту;
// 	  ВалютаДокумента;
// 	  СуммаПогашения;
// 	  СуммаПогашенияВал - сумма в валюте документа;
// 	  СуммаПогашенияУпр;
// 	  СуммаПогашенияРегл.
//
// Параметры:
//  МенеджерВременныхТаблиц - МенеджерВременныхТаблиц - 
//  ПараметрыРасчета        - см. ИнициализироватьПараметрыПодготовкиРасчетовАвансов
Процедура ПодготовитьВТ_РасчетыСКлиентами_ПогашенияАвансов(МенеджерВременныхТаблиц, ПараметрыРасчета) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	УстановитьПараметрыЗапросаПодготовкиРасчетовАвансов(Запрос, ПараметрыРасчета);
	
	Запрос.Текст =
	"// Новая архитектура взаиморасчетов
	|ВЫБРАТЬ
	|	Расчеты.РасчетныйДокумент КАК РасчетныйДокумент,
	|	Расчеты.ДокументРегистратор КАК ДокументРегистратор,
	|	Расчеты.ОбъектРасчетов.Организация КАК Организация,
	|	Расчеты.ОбъектРасчетов.Организация.ВалютаРегламентированногоУчета КАК ВалютаРегламентированногоУчета,
	|	МИНИМУМ(Расчеты.ДатаВозникновения) КАК ДатаАванса,
	|	МАКСИМУМ(Расчеты.Период) КАК ДатаПогашения,
	|	СУММА(ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА 0
	|			КОГДА Расчеты.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносАванса)
	|				ТОГДА ВЫБОР
	|						КОГДА ТИПЗНАЧЕНИЯ(Расчеты.ДокументРегистратор) В (&ТипыДокументовВозврата_ПолученныеАвансы)
	|							ТОГДА -Расчеты.Предоплата
	|						ИНАЧЕ 0
	|					КОНЕЦ
	|			КОГДА Расчеты.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаКлиента), ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РезервированиеАвансаКлиента))
	|				ТОГДА Расчеты.Предоплата
	|			ИНАЧЕ -Расчеты.Предоплата
	|		КОНЕЦ) КАК СобытиеЗнак,
	|	СУММА(Расчеты.Предоплата * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ) КАК СуммаПогашения,
	|	НЕ ВзаимозачетЗадолженностиПеренос.Ссылка ЕСТЬ NULL КАК ПереносАванса
	|	
	|ПОМЕСТИТЬ ОтборПогашенийАвансов
	|ИЗ
	|	РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК Расчеты
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВзаимозачетЗадолженности КАК ВзаимозачетЗадолженностиПеренос
	|		ПО (Расчеты.ДокументРегистратор = ВзаимозачетЗадолженностиПеренос.Ссылка)
	|			И (ВзаимозачетЗадолженностиПеренос.ВидОперации В (ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаОрганизацияКонтрагент),
	|			ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаМеждуКонтрагентами),
	|			ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуОрганизацияКонтрагент),
	|			ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуМеждуКонтрагентами),
	|			ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаМеждуДвумяОрганизациями),
	|			ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуМеждуДвумяОрганизациями)))
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВзаимозачетЗадолженности КАК ВзаимозачетЗадолженности
	|		ПО (Расчеты.ДокументРегистратор = ВзаимозачетЗадолженности.Ссылка)
	|ГДЕ
	|	&НоваяАрхитектураВзаиморасчетов
	|	И НЕ &СоздатьПустуюТаблицу
	|	И (НЕ &ВключитьОтборПоОрганизациям
	|			ИЛИ Расчеты.ОбъектРасчетов.Организация В (&Организации))
	|	И &ТекстОтборПоПараметрам
	|	И Расчеты.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
	|	И Расчеты.Активность = ИСТИНА
	|	И Расчеты.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РезервированиеАвансаКлиента)
	|	И ВЫБОР
	|			КОГДА &ПравилоОтбораАвансов = ЗНАЧЕНИЕ(Перечисление.ПорядокРегистрацииСчетовФактурНаАванс.КромеЗачтенныхВТечениеДня)
	|				ТОГДА РАЗНОСТЬДАТ(Расчеты.ДатаВозникновения, Расчеты.Период, ДЕНЬ) < 1
	|			КОГДА &ПравилоОтбораАвансов = ЗНАЧЕНИЕ(Перечисление.ПорядокРегистрацииСчетовФактурНаАванс.КромеЗачтенныхВТечениеПятиДней)
	|				ТОГДА РАЗНОСТЬДАТ(Расчеты.ДатаВозникновения, Расчеты.Период, ДЕНЬ) < 5
	|			КОГДА &ПравилоОтбораАвансов = ЗНАЧЕНИЕ(Перечисление.ПорядокРегистрацииСчетовФактурНаАванс.КромеЗачтенныхВТечениеМесяца)
	|				ТОГДА Расчеты.Период <= КОНЕЦПЕРИОДА(Расчеты.ДатаВозникновения, МЕСЯЦ)
	|			КОГДА &ПравилоОтбораАвансов = ЗНАЧЕНИЕ(Перечисление.ПорядокРегистрацииСчетовФактурНаАванс.КромеЗачтенныхВТечениеКвартала)
	|				ТОГДА Расчеты.Период <= КОНЕЦПЕРИОДА(Расчеты.ДатаВозникновения, КВАРТАЛ)
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|	И ВЫБОР КОГДА НЕ ВзаимозачетЗадолженности.Ссылка ЕСТЬ NULL И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) Тогда
	|		ВзаимозачетЗадолженности.ВидОперации В (ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаОрганизацияКонтрагент),
	|			ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаМеждуКонтрагентами),
	|			ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуОрганизацияКонтрагент),
	|			ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуМеждуКонтрагентами),
	|			ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаМеждуДвумяОрганизациями),
	|			ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуМеждуДвумяОрганизациями))
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ
	|		
	|	СГРУППИРОВАТЬ ПО
	|		Расчеты.РасчетныйДокумент,
	|		Расчеты.ДокументРегистратор,
	|		Расчеты.ОбъектРасчетов.Организация,
	|		Расчеты.ОбъектРасчетов.Организация.ВалютаРегламентированногоУчета,
	|		НЕ ВзаимозачетЗадолженностиПеренос.Ссылка ЕСТЬ NULL
	|	
	|	ИМЕЮЩИЕ
	|		СУММА(Расчеты.Предоплата * ВЫБОР
	|				КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|					ТОГДА -1
	|				ИНАЧЕ 1
	|			КОНЕЦ) > 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|//Старая архитектура взаиморасчетов
	|ВЫБРАТЬ
	|	Расчеты.РасчетныйДокумент КАК РасчетныйДокумент,
	|	Расчеты.Регистратор КАК ДокументРегистратор,
	|	Расчеты.АналитикаУчетаПоПартнерам.Организация КАК Организация,
	|	Расчеты.АналитикаУчетаПоПартнерам.Организация.ВалютаРегламентированногоУчета КАК ВалютаРегламентированногоУчета,
	|	NULL КАК ДатаАванса,
	|	Расчеты.Период КАК ДатаПогашения,
	|	СУММА(ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|					И Расчеты.ПредоплатаРегл > 0
	|				ТОГДА Расчеты.ПредоплатаРегл
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|					И Расчеты.ПредоплатаРегл < 0
	|				ТОГДА Расчеты.ПредоплатаРегл
	|			ИНАЧЕ 0
	|		КОНЕЦ) КАК СобытиеЗнак,
	|	СУММА(Расчеты.Предоплата * ВЫБОР
	|		КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА 1
	|		ИНАЧЕ -1
	|		КОНЕЦ) КАК СуммаПогашения,
	|	ЛОЖЬ КАК ПереносАванса
	|ИЗ
	|	РегистрНакопления.РасчетыСКлиентамиПоДокументам КАК Расчеты
	|ГДЕ
	|	НЕ &НоваяАрхитектураВзаиморасчетов
	|	И НЕ &СоздатьПустуюТаблицу
	|	И (НЕ &ВключитьОтборПоОрганизациям
	|			ИЛИ Расчеты.АналитикаУчетаПоПартнерам.Организация В (&Организации))
	|	И &ТекстОтборПоПараметрам
	|	И Расчеты.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
	|	И Расчеты.Активность = ИСТИНА
	|
	|СГРУППИРОВАТЬ ПО
	|	Расчеты.РасчетныйДокумент,
	|	Расчеты.Регистратор,
	|	Расчеты.АналитикаУчетаПоПартнерам.Организация,
	|	Расчеты.АналитикаУчетаПоПартнерам.Организация.ВалютаРегламентированногоУчета,
	|	Расчеты.Период
	|
	|ИМЕЮЩИЕ
	|	СУММА(Расчеты.ПредоплатаРегл * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА 1
	|			ИНАЧЕ -1
	|		КОНЕЦ) > 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент,
	|	ДокументРегистратор,
	|	Организация,
	|	ВалютаРегламентированногоУчета
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Расчеты_Приход.РасчетныйДокумент КАК РасчетныйДокумент,
	|	Расчеты.ОбъектРасчетов.Организация КАК Организация,
	|	Расчеты.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Расчеты.ОбъектРасчетов КАК ОбъектРасчетов,
	|	Расчеты.ДокументРегистратор КАК ДокументРегистратор,
	|	Расчеты.ОбъектРасчетов.Контрагент КАК Контрагент,
	|	Расчеты.ОбъектРасчетов.Договор КАК Договор,
	|	Расчеты.ОбъектРасчетов.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА НЕ Расчеты.КорОбъектРасчетов = &ПустойОбъектРасчетов
	|				И НЕ ЕСТЬNULL(Расчеты.КорОбъектРасчетов.Объект = НЕОПРЕДЕЛЕНО, ИСТИНА)
	|			ТОГДА Расчеты.КорОбъектРасчетов.Контрагент
	|		ИНАЧЕ Расчеты.ОбъектРасчетов.Контрагент
	|	КОНЕЦ КАК ИсхКонтрагент,
	|	ВЫБОР
	|		КОГДА НЕ Расчеты.КорОбъектРасчетов = &ПустойОбъектРасчетов
	|				И НЕ ЕСТЬNULL(Расчеты.КорОбъектРасчетов.Объект = НЕОПРЕДЕЛЕНО, ИСТИНА)
	|			ТОГДА Расчеты.КорОбъектРасчетов.Договор
	|		ИНАЧЕ Расчеты.ОбъектРасчетов.Договор
	|	КОНЕЦ КАК ИсхДоговор,
	|	ВЫБОР
	|		КОГДА НЕ Расчеты.КорОбъектРасчетов = &ПустойОбъектРасчетов
	|				И НЕ ЕСТЬNULL(Расчеты.КорОбъектРасчетов.Объект = НЕОПРЕДЕЛЕНО, ИСТИНА)
	|			ТОГДА Расчеты.КорОбъектРасчетов.НаправлениеДеятельности
	|		ИНАЧЕ Расчеты.ОбъектРасчетов.НаправлениеДеятельности
	|	КОНЕЦ КАК ИсхНаправлениеДеятельности,
	|	Расчеты.КорАналитикаУчетаПоПартнерам КАК КорАналитикаУчетаПоПартнерам,
	|	ВЫБОР
	|		КОГДА Расчеты.КорАналитикаУчетаПоПартнерам <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка)
	|			ТОГДА Расчеты.КорАналитикаУчетаПоПартнерам
	|		ИНАЧЕ Расчеты.АналитикаУчетаПоПартнерам
	|	КОНЕЦ КАК ИсхАналитикаУчетаПоПартнерам,
	|	Расчеты.КорОбъектРасчетов КАК КорОбъектРасчетов,
	|	ВЫБОР
	|		КОГДА НЕ Расчеты.КорОбъектРасчетов = &ПустойОбъектРасчетов
	|				И НЕ ЕСТЬNULL(Расчеты.КорОбъектРасчетов.Объект = НЕОПРЕДЕЛЕНО, ИСТИНА)
	|			ТОГДА Расчеты.КорОбъектРасчетов
	|		ИНАЧЕ Расчеты.ОбъектРасчетов
	|	КОНЕЦ КАК ИсходныйОбъектРасчетов,
	|	ОтборПогашенийАвансов.ДатаАванса КАК ДатаАванса,
	|	ОтборПогашенийАвансов.ДатаПогашения КАК ДатаПогашения,
	|	ОтборПогашенийАвансов.СобытиеЗнак КАК СобытиеЗнак,
	|	ВЫБОР
	|		КОГДА Расчеты.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеКредиторскойЗадолженности)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеКредиторскойЗадолженности)
	|		КОГДА Расчеты.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОплатыКлиенту)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОплатыКлиенту)
	|		КОГДА Расчеты.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаКлиента)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаКлиента)
	|		КОГДА ОтборПогашенийАвансов.СобытиеЗнак < 0
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОплатыКлиенту)
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ВидСобытия,
	|	ВЫБОР
	|		КОГДА Расчеты_Приход.РасчетныйДокумент ССЫЛКА Документ.ПриходныйКассовыйОрдер
	|			ТОГДА ВЫРАЗИТЬ(Расчеты_Приход.РасчетныйДокумент КАК Документ.ПриходныйКассовыйОрдер).Валюта
	|		КОГДА Расчеты_Приход.РасчетныйДокумент ССЫЛКА Документ.ПоступлениеБезналичныхДенежныхСредств
	|			ТОГДА ВЫРАЗИТЬ(Расчеты_Приход.РасчетныйДокумент КАК Документ.ПоступлениеБезналичныхДенежныхСредств).Валюта
	|		КОГДА Расчеты_Приход.РасчетныйДокумент ССЫЛКА Документ.ПервичныйДокумент
	|			ТОГДА ВЫРАЗИТЬ(Расчеты_Приход.РасчетныйДокумент КАК Документ.ПервичныйДокумент).Валюта
	|		ИНАЧЕ Расчеты_Приход.Валюта
	|	КОНЕЦ КАК ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА Расчеты_Приход.РасчетныйДокумент ССЫЛКА Документ.ПриходныйКассовыйОрдер
	|				И ВЫРАЗИТЬ(Расчеты_Приход.РасчетныйДокумент КАК Документ.ПриходныйКассовыйОрдер).Валюта = ОтборПогашенийАвансов.ВалютаРегламентированногоУчета
	|			ТОГДА Расчеты.ДолгРегл
	|		КОГДА Расчеты_Приход.РасчетныйДокумент ССЫЛКА Документ.ПоступлениеБезналичныхДенежныхСредств
	|				И ВЫРАЗИТЬ(Расчеты_Приход.РасчетныйДокумент КАК Документ.ПоступлениеБезналичныхДенежныхСредств).Валюта = ОтборПогашенийАвансов.ВалютаРегламентированногоУчета
	|			ТОГДА Расчеты.ДолгРегл
	|		ИНАЧЕ Расчеты.Долг
	|	КОНЕЦ КАК ДолгВал,
	|	Расчеты.Долг КАК Долг,
	|	Расчеты.ДолгУпр КАК ДолгУпр,
	|	Расчеты.ДолгРегл КАК ДолгРегл
	|ПОМЕСТИТЬ РасчетыСКлиентами_ПогашенияСНеявнымЗачетом
	|ИЗ
	|	ОтборПогашенийАвансов КАК ОтборПогашенийАвансов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК Расчеты
	|		ПО ОтборПогашенийАвансов.ДокументРегистратор = Расчеты.ДокументРегистратор
	|			И ОтборПогашенийАвансов.Организация = Расчеты.ОбъектРасчетов.Организация
	|			И (Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход))
	|			И (Расчеты.Период МЕЖДУ &ДатаНачала И &ДатаОкончания)
	|			И (Расчеты.Активность = ИСТИНА)
	|			И (Расчеты.НастройкаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПереносАванса))
	|			И (НЕ Расчеты.Сторно)
	|			И (Расчеты.Долг > 0)
	|			И (ОтборПогашенийАвансов.ПереносАванса)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК Расчеты_Приход
	|		ПО (Расчеты_Приход.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход))
	|			И ОтборПогашенийАвансов.РасчетныйДокумент = Расчеты_Приход.РасчетныйДокумент
	|			И (Расчеты.ОбъектРасчетов = Расчеты_Приход.ОбъектРасчетов)
	|			И (Расчеты.АналитикаУчетаПоПартнерам = Расчеты_Приход.АналитикаУчетаПоПартнерам)
	|			И (Расчеты.ДокументРегистратор = Расчеты_Приход.ДокументРегистратор) 
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаПоПартнерам,
	|	РасчетныйДокумент,
	|	ВалютаДокумента
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|// Новая архитектура взаиморасчетов
	|ВЫБРАТЬ
	|	ВложенныйЗапрос.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ВложенныйЗапрос.Организация КАК Организация,
	|	ВложенныйЗапрос.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	ВложенныйЗапрос.ОбъектРасчетов КАК ОбъектРасчетов,
	|	ВложенныйЗапрос.ДокументРегистратор КАК ДокументРегистратор,
	|	ВложенныйЗапрос.Контрагент КАК Контрагент,
	|	ВложенныйЗапрос.Договор КАК Договор,
	|	ВложенныйЗапрос.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	МАКСИМУМ(ВложенныйЗапрос.ИсхКонтрагент) КАК ИсхКонтрагент,
	|	МАКСИМУМ(ВложенныйЗапрос.ИсхДоговор) КАК ИсхДоговор,
	|	МАКСИМУМ(ВложенныйЗапрос.ИсхНаправлениеДеятельности) КАК ИсхНаправлениеДеятельности,
	|	МАКСИМУМ(ВложенныйЗапрос.КорАналитикаУчетаПоПартнерам) КАК КорАналитикаУчетаПоПартнерам,
	|	МАКСИМУМ(ВложенныйЗапрос.ИсходнаяАналитикаУчетаПоПартнерам) КАК ИсходнаяАналитикаУчетаПоПартнерам,
	|	МАКСИМУМ(ВложенныйЗапрос.КорОбъектРасчетов) КАК КорОбъектРасчетов,
	|	МАКСИМУМ(ВложенныйЗапрос.ИсходныйОбъектРасчетов) КАК ИсходныйОбъектРасчетов,
	|	МИНИМУМ(ВложенныйЗапрос.ДатаАванса) КАК ДатаАванса,
	|	МАКСИМУМ(ВложенныйЗапрос.ДатаПогашения) КАК ДатаПогашения,
	|	МАКСИМУМ(ВложенныйЗапрос.СобытиеЗнак) КАК СобытиеЗнак,
	|	МАКСИМУМ(ВложенныйЗапрос.ВидСобытия) КАК ВидСобытия,
	|	МАКСИМУМ(ВложенныйЗапрос.ВалютаДокумента) КАК ВалютаДокумента,
	|	СУММА(ВложенныйЗапрос.СуммаПогашенияВал) КАК СуммаПогашенияВал,
	|	СУММА(ВложенныйЗапрос.СуммаПогашения) КАК СуммаПогашения,
	|	СУММА(ВложенныйЗапрос.СуммаПогашенияУпр) КАК СуммаПогашенияУпр,
	|	СУММА(ВложенныйЗапрос.СуммаПогашенияРегл) КАК СуммаПогашенияРегл
	|ПОМЕСТИТЬ РасчетыСКлиентами_ПогашенияАвансов_Предварительная
	|ИЗ
	|	(ВЫБРАТЬ
	|		ВложенныйЗапрос.РасчетныйДокумент КАК РасчетныйДокумент,
	|		ВложенныйЗапрос.ОбъектРасчетов.Организация КАК Организация,
	|		ВложенныйЗапрос.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|		ВложенныйЗапрос.ОбъектРасчетов КАК ОбъектРасчетов,
	|		ВложенныйЗапрос.ДокументРегистратор КАК ДокументРегистратор,
	|		ВложенныйЗапрос.ОбъектРасчетов.Контрагент КАК Контрагент,
	|		ВложенныйЗапрос.ОбъектРасчетов.Договор КАК Договор,
	|		ВложенныйЗапрос.ОбъектРасчетов.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|		МАКСИМУМ(ВЫБОР
	|			КОГДА НЕ ВложенныйЗапрос.КорОбъектРасчетов = &ПустойОбъектРасчетов
	|					И НЕ ЕСТЬNULL(ВложенныйЗапрос.КорОбъектРасчетов.Объект = НЕОПРЕДЕЛЕНО, ИСТИНА)
	|				ТОГДА ВложенныйЗапрос.КорОбъектРасчетов.Контрагент
	|			ИНАЧЕ ВложенныйЗапрос.ОбъектРасчетов.Контрагент
	|		КОНЕЦ) КАК ИсхКонтрагент,
	|		МАКСИМУМ(ВЫБОР
	|			КОГДА НЕ ВложенныйЗапрос.КорОбъектРасчетов = &ПустойОбъектРасчетов
	|					И НЕ ЕСТЬNULL(ВложенныйЗапрос.КорОбъектРасчетов.Объект = НЕОПРЕДЕЛЕНО, ИСТИНА)
	|				ТОГДА ВложенныйЗапрос.КорОбъектРасчетов.Договор
	|			ИНАЧЕ ВложенныйЗапрос.ОбъектРасчетов.Договор
	|		КОНЕЦ) КАК ИсхДоговор,
	|		МАКСИМУМ(ВЫБОР
	|			КОГДА НЕ ВложенныйЗапрос.КорОбъектРасчетов = &ПустойОбъектРасчетов
	|					И НЕ ЕСТЬNULL(ВложенныйЗапрос.КорОбъектРасчетов.Объект = НЕОПРЕДЕЛЕНО, ИСТИНА)
	|				ТОГДА ВложенныйЗапрос.КорОбъектРасчетов.НаправлениеДеятельности
	|			ИНАЧЕ ВложенныйЗапрос.ОбъектРасчетов.НаправлениеДеятельности
	|		КОНЕЦ) КАК ИсхНаправлениеДеятельности,
	|		МАКСИМУМ(ВложенныйЗапрос.КорАналитикаУчетаПоПартнерам) КАК КорАналитикаУчетаПоПартнерам,
	|		ВЫБОР
	|		КОГДА ВложенныйЗапрос.КорАналитикаУчетаПоПартнерам <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка)
	|			ТОГДА ВложенныйЗапрос.КорАналитикаУчетаПоПартнерам
	|		ИНАЧЕ ВложенныйЗапрос.АналитикаУчетаПоПартнерам
	|		КОНЕЦ КАК ИсходнаяАналитикаУчетаПоПартнерам,
	|		МАКСИМУМ(ВложенныйЗапрос.КорОбъектРасчетов) КАК КорОбъектРасчетов,
	|		МАКСИМУМ(ВЫБОР
	|			КОГДА НЕ ВложенныйЗапрос.КорОбъектРасчетов = &ПустойОбъектРасчетов
	|					И НЕ ЕСТЬNULL(ВложенныйЗапрос.КорОбъектРасчетов.Объект = НЕОПРЕДЕЛЕНО, ИСТИНА)
	|				ТОГДА ВложенныйЗапрос.КорОбъектРасчетов
	|			ИНАЧЕ ВложенныйЗапрос.ОбъектРасчетов
	|		КОНЕЦ) КАК ИсходныйОбъектРасчетов,
	|		МИНИМУМ(ВложенныйЗапрос.ДатаАванса) КАК ДатаАванса,
	|		МАКСИМУМ(ВложенныйЗапрос.ДатаПогашения) КАК ДатаПогашения,
	|		МАКСИМУМ(ВложенныйЗапрос.СобытиеЗнак) КАК СобытиеЗнак,
	|		МАКСИМУМ(ВложенныйЗапрос.ВидСобытия) КАК ВидСобытия,
	|		МАКСИМУМ(ВложенныйЗапрос.ВалютаДокумента) КАК ВалютаДокумента,
	|		СУММА(ВложенныйЗапрос.СуммаПогашенияВал) КАК СуммаПогашенияВал,
	|		СУММА(ВложенныйЗапрос.СуммаПогашения) КАК СуммаПогашения,
	|		СУММА(ВложенныйЗапрос.СуммаПогашенияУпр) КАК СуммаПогашенияУпр,
	|		СУММА(ВложенныйЗапрос.СуммаПогашенияРегл) КАК СуммаПогашенияРегл
	|	ИЗ
	|		(ВЫБРАТЬ
	|			Расчеты.РасчетныйДокумент КАК РасчетныйДокумент,
	|			ВЫБОР
	|			КОГДА ОтборПогашенийАвансов.ПереносАванса
	|					И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА ЕСТЬNULL(Резервирование_Приход.КорАналитикаУчетаПоПартнерам, Расчеты.КорАналитикаУчетаПоПартнерам)
	|			ИНАЧЕ Расчеты.АналитикаУчетаПоПартнерам
	|			КОНЕЦ КАК АналитикаУчетаПоПартнерам,
	|			ВЫБОР
	|			КОГДА ОтборПогашенийАвансов.ПереносАванса
	|					И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА ЕСТЬNULL(Резервирование_Приход.КорОбъектРасчетов, Расчеты.КорОбъектРасчетов)
	|			ИНАЧЕ Расчеты.ОбъектРасчетов
	|			КОНЕЦ КАК ОбъектРасчетов,
	|			Расчеты.ДокументРегистратор КАК ДокументРегистратор,
	|			МАКСИМУМ(ВЫБОР
	|				КОГДА ОтборПогашенийАвансов.ПереносАванса
	|						И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|					ТОГДА НЕОПРЕДЕЛЕНО
	|				ИНАЧЕ ЕСТЬNULL(Резервирование_Приход.КорОбъектРасчетов, Расчеты.КорОбъектРасчетов)
	|			КОНЕЦ) КАК КорОбъектРасчетов,
	|			МАКСИМУМ(ВЫБОР
	|				КОГДА ОтборПогашенийАвансов.ПереносАванса
	|						И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|					ТОГДА НЕОПРЕДЕЛЕНО
	|				ИНАЧЕ ЕСТЬNULL(Резервирование_Приход.КорАналитикаУчетаПоПартнерам, Расчеты.КорАналитикаУчетаПоПартнерам)
	|			КОНЕЦ) КАК КорАналитикаУчетаПоПартнерам,
	|			МИНИМУМ(ОтборПогашенийАвансов.ДатаАванса) КАК ДатаАванса,
	|			МАКСИМУМ(ОтборПогашенийАвансов.ДатаПогашения) КАК ДатаПогашения,
	|			МАКСИМУМ(ОтборПогашенийАвансов.СобытиеЗнак) КАК СобытиеЗнак,
	|			МАКСИМУМ(ВЫБОР
	|				КОГДА Расчеты.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеКредиторскойЗадолженности)
	|					ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеКредиторскойЗадолженности)
	|				КОГДА Расчеты.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОплатыКлиенту)
	|					ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОплатыКлиенту)
	|				КОГДА Расчеты.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаКлиента)
	|					ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаКлиента)
	|				КОГДА ОтборПогашенийАвансов.СобытиеЗнак < 0
	|					ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОплатыКлиенту)
	|				ИНАЧЕ НЕОПРЕДЕЛЕНО
	|			КОНЕЦ) КАК ВидСобытия,
	|			МАКСИМУМ(ВЫБОР
	|				КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПриходныйКассовыйОрдер
	|					ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПриходныйКассовыйОрдер).Валюта
	|				КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПоступлениеБезналичныхДенежныхСредств
	|					ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПоступлениеБезналичныхДенежныхСредств).Валюта
	|				КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПервичныйДокумент
	|					ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПервичныйДокумент).Валюта
	|				ИНАЧЕ Расчеты.Валюта
	|			КОНЕЦ) КАК ВалютаДокумента,
	|			СУММА(ВЫБОР
	|				КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПриходныйКассовыйОрдер
	|						И ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПриходныйКассовыйОрдер).Валюта = ОтборПогашенийАвансов.ВалютаРегламентированногоУчета
	|					ТОГДА Расчеты.ПредоплатаРегл
	|				КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПоступлениеБезналичныхДенежныхСредств
	|						И ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПоступлениеБезналичныхДенежныхСредств).Валюта = ОтборПогашенийАвансов.ВалютаРегламентированногоУчета
	|					ТОГДА Расчеты.ПредоплатаРегл
	|				ИНАЧЕ Расчеты.Предоплата
	|			КОНЕЦ * ВЫБОР
	|				КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|					ТОГДА -1
	|				ИНАЧЕ 1
	|			КОНЕЦ) КАК СуммаПогашенияВал,
	|			СУММА(Расчеты.Предоплата * ВЫБОР
	|				КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|					ТОГДА -1
	|				ИНАЧЕ 1
	|			КОНЕЦ) КАК СуммаПогашения,
	|			СУММА(Расчеты.ПредоплатаУпр * ВЫБОР
	|				КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|					ТОГДА -1
	|				ИНАЧЕ 1
	|			КОНЕЦ) КАК СуммаПогашенияУпр,
	|			СУММА(Расчеты.ПредоплатаРегл * ВЫБОР
	|				КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|					ТОГДА -1
	|				ИНАЧЕ 1
	|			КОНЕЦ) КАК СуммаПогашенияРегл
	|		ИЗ
	|			ОтборПогашенийАвансов КАК ОтборПогашенийАвансов
	|				ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК Расчеты
	|				ПО ОтборПогашенийАвансов.ДокументРегистратор = Расчеты.ДокументРегистратор
	|					И ОтборПогашенийАвансов.РасчетныйДокумент = Расчеты.РасчетныйДокумент
	|					И ОтборПогашенийАвансов.Организация = Расчеты.ОбъектРасчетов.Организация
	|					И (Расчеты.Период МЕЖДУ &ДатаНачала И &ДатаОкончания)
	|					И (Расчеты.Активность = ИСТИНА)
	|					И (Расчеты.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РезервированиеАвансаКлиента))
	|				ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК Резервирование_Приход
	|				ПО Расчеты.ДокументРегистратор = Резервирование_Приход.ДокументРегистратор
	|					И Расчеты.РасчетныйДокумент = Резервирование_Приход.РасчетныйДокумент
	|					И Расчеты.ОбъектРасчетов.Организация = Резервирование_Приход.ОбъектРасчетов.Организация
	|					И (Резервирование_Приход.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход))
	|					И (Резервирование_Приход.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РезервированиеАвансаКлиента))
	|					И (Расчеты.Активность = ИСТИНА)
	|		ГДЕ
	|			ВЫБОР КОГДА НЕ ОтборПогашенийАвансов.ПереносАванса
	|					ТОГДА ИСТИНА
	|				ИНАЧЕ НЕ (Расчеты.АналитикаУчетаПоПартнерам, Расчеты.РасчетныйДокумент, Расчеты.Валюта) В
	|							(ВЫБРАТЬ
	|								РасчетыСКлиентами.АналитикаУчетаПоПартнерам,
	|								РасчетыСКлиентами.РасчетныйДокумент,
	|								РасчетыСКлиентами.ВалютаДокумента
	|							ИЗ
	|								РасчетыСКлиентами_ПогашенияСНеявнымЗачетом КАК РасчетыСКлиентами
	|							
	|							ОБЪЕДИНИТЬ ВСЕ
	|
	|							ВЫБРАТЬ
	|								РасчетыСКлиентами.КорАналитикаУчетаПоПартнерам,
	|								РасчетыСКлиентами.РасчетныйДокумент,
	|								РасчетыСКлиентами.ВалютаДокумента
	|							ИЗ
	|								РасчетыСКлиентами_ПогашенияСНеявнымЗачетом КАК РасчетыСКлиентами)
	|			КОНЕЦ
	|	
	|		СГРУППИРОВАТЬ ПО
	|			Расчеты.РасчетныйДокумент,
	|			Расчеты.ДокументРегистратор,
	|			ВЫБОР
	|				КОГДА ОтборПогашенийАвансов.ПереносАванса
	|					И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА ЕСТЬNULL(Резервирование_Приход.КорАналитикаУчетаПоПартнерам, Расчеты.КорАналитикаУчетаПоПартнерам)
	|				ИНАЧЕ Расчеты.АналитикаУчетаПоПартнерам
	|			КОНЕЦ,
	|			ВЫБОР
	|				КОГДА ОтборПогашенийАвансов.ПереносАванса
	|					И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА ЕСТЬNULL(Резервирование_Приход.КорОбъектРасчетов, Расчеты.КорОбъектРасчетов)
	|				ИНАЧЕ Расчеты.ОбъектРасчетов
	|			КОНЕЦ) КАК ВложенныйЗапрос
	|
	|	СГРУППИРОВАТЬ ПО
	|		ВложенныйЗапрос.РасчетныйДокумент,
	|		ВложенныйЗапрос.ОбъектРасчетов.Организация,
	|		ВложенныйЗапрос.АналитикаУчетаПоПартнерам,
	|		ВложенныйЗапрос.ОбъектРасчетов,
	|		ВложенныйЗапрос.ДокументРегистратор,
	|		ВложенныйЗапрос.ОбъектРасчетов.Контрагент,
	|		ВложенныйЗапрос.ОбъектРасчетов.Договор,
	|		ВложенныйЗапрос.ОбъектРасчетов.НаправлениеДеятельности,
	|		ВЫБОР
	|			КОГДА ВложенныйЗапрос.КорАналитикаУчетаПоПартнерам <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка)
	|				ТОГДА ВложенныйЗапрос.КорАналитикаУчетаПоПартнерам
	|			ИНАЧЕ ВложенныйЗапрос.АналитикаУчетаПоПартнерам
	|		КОНЕЦ
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Расчеты.РасчетныйДокумент,
	|		Расчеты.Организация,
	|		Расчеты.АналитикаУчетаПоПартнерам,
	|		Расчеты.ОбъектРасчетов,
	|		Расчеты.ДокументРегистратор,
	|		Расчеты.Контрагент,
	|		Расчеты.Договор,
	|		Расчеты.НаправлениеДеятельности,
	|		Расчеты.ИсхКонтрагент,
	|		Расчеты.ИсхДоговор,
	|		Расчеты.ИсхНаправлениеДеятельности,
	|		Расчеты.КорАналитикаУчетаПоПартнерам,
	|		Расчеты.ИсхАналитикаУчетаПоПартнерам,
	|		Расчеты.КорОбъектРасчетов,
	|		Расчеты.ИсходныйОбъектРасчетов,
	|		Расчеты.ДатаАванса,
	|		Расчеты.ДатаПогашения,
	|		Расчеты.СобытиеЗнак,
	|		Расчеты.ВидСобытия,
	|		Расчеты.ВалютаДокумента,
	|		Расчеты.ДолгВал,
	|		Расчеты.Долг,
	|		Расчеты.ДолгУпр,
	|		Расчеты.ДолгРегл
	|	ИЗ
	|		РасчетыСКлиентами_ПогашенияСНеявнымЗачетом КАК Расчеты) КАК ВложенныйЗапрос
	|ГДЕ
	|	ВложенныйЗапрос.СуммаПогашения > 0
	|
	|СГРУППИРОВАТЬ ПО
	|	ВложенныйЗапрос.РасчетныйДокумент,
	|	ВложенныйЗапрос.Организация,
	|	ВложенныйЗапрос.АналитикаУчетаПоПартнерам,
	|	ВложенныйЗапрос.ОбъектРасчетов,
	|	ВложенныйЗапрос.ДокументРегистратор,
	|	ВложенныйЗапрос.Контрагент,
	|	ВложенныйЗапрос.Договор,
	|	ВложенныйЗапрос.НаправлениеДеятельности
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|// Старая архитектура взаиморасчетов
	|ВЫБРАТЬ
	|	Расчеты.РасчетныйДокумент,
	|	Расчеты.АналитикаУчетаПоПартнерам.Организация,
	|	Расчеты.АналитикаУчетаПоПартнерам,
	|	Расчеты.ЗаказКлиента,
	|	Расчеты.Регистратор,
	|	Расчеты.АналитикаУчетаПоПартнерам.Контрагент,
	|	Расчеты.АналитикаУчетаПоПартнерам.Договор,
	|	Расчеты.АналитикаУчетаПоПартнерам.НаправлениеДеятельности,
	|	Расчеты.АналитикаУчетаПоПартнерам.Контрагент,
	|	Расчеты.АналитикаУчетаПоПартнерам.Договор,
	|	Расчеты.АналитикаУчетаПоПартнерам.НаправлениеДеятельности,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка),
	|	Расчеты.АналитикаУчетаПоПартнерам,
	|	&ПустойОбъектРасчетов,
	|	Расчеты.ЗаказКлиента,
	|	МАКСИМУМ(НАЧАЛОПЕРИОДА(ЕСТЬNULL(ПоступлениеДС.ДатаПроведенияБанком, ДанныеПервичныхДокументов.ДатаРегистратора), ДЕНЬ)),
	|	МАКСИМУМ(ОтборПогашенийАвансов.ДатаПогашения),
	|	МАКСИМУМ(ОтборПогашенийАвансов.СобытиеЗнак),
	|	МАКСИМУМ(ВЫБОР
	|			КОГДА Расчеты.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеКредиторскойЗадолженности)
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеКредиторскойЗадолженности)
	|			КОГДА Расчеты.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РезервированиеАвансаКлиента)
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РезервированиеАвансаКлиента)
	|			КОГДА ОтборПогашенийАвансов.СобытиеЗнак < 0
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОплатыКлиенту)
	|			ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаКлиента)
	|		КОНЕЦ),
	|	МАКСИМУМ(ВЫБОР
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПриходныйКассовыйОрдер
	|				ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПриходныйКассовыйОрдер).Валюта
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПоступлениеБезналичныхДенежныхСредств
	|				ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПоступлениеБезналичныхДенежныхСредств).Валюта
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПервичныйДокумент
	|				ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПервичныйДокумент).Валюта
	|			ИНАЧЕ Расчеты.Валюта
	|		КОНЕЦ),
	|	СУММА(ВЫБОР
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПриходныйКассовыйОрдер
	|					И ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПриходныйКассовыйОрдер).Валюта = ОтборПогашенийАвансов.ВалютаРегламентированногоУчета
	|				ТОГДА Расчеты.ПредоплатаРегл
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПоступлениеБезналичныхДенежныхСредств
	|					И ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПоступлениеБезналичныхДенежныхСредств).Валюта = ОтборПогашенийАвансов.ВалютаРегламентированногоУчета
	|				ТОГДА Расчеты.ПредоплатаРегл
	|			ИНАЧЕ Расчеты.Предоплата
	|		КОНЕЦ * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА 1
	|			ИНАЧЕ -1
	|		КОНЕЦ),
	|		СУММА(Расчеты.Предоплата * ВЫБОР
	|				КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|					ТОГДА 1
	|				ИНАЧЕ -1
	|			КОНЕЦ),
	|		СУММА(Расчеты.ПредоплатаУпр * ВЫБОР
	|				КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|					ТОГДА 1
	|				ИНАЧЕ -1
	|			КОНЕЦ),
	|		СУММА(Расчеты.ПредоплатаРегл * ВЫБОР
	|				КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|					ТОГДА 1
	|				ИНАЧЕ -1
	|			КОНЕЦ)
	|	ИЗ
	|		ОтборПогашенийАвансов КАК ОтборПогашенийАвансов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентамиПоДокументам КАК Расчеты
	|		ПО ОтборПогашенийАвансов.ДокументРегистратор = Расчеты.Регистратор
	|			И ОтборПогашенийАвансов.РасчетныйДокумент = Расчеты.РасчетныйДокумент
	|			И ОтборПогашенийАвансов.Организация = Расчеты.АналитикаУчетаПоПартнерам.Организация
	|			И (Расчеты.Период МЕЖДУ &ДатаНачала И &ДатаОкончания)
	|			И (Расчеты.Активность = ИСТИНА)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПоступлениеБезналичныхДенежныхСредств КАК ПоступлениеДС
	|		ПО ОтборПогашенийАвансов.РасчетныйДокумент = ПоступлениеДС.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|		ПО ОтборПогашенийАвансов.РасчетныйДокумент = ДанныеПервичныхДокументов.Документ
	|			И ОтборПогашенийАвансов.Организация = ДанныеПервичныхДокументов.Организация
	|
	|	СГРУППИРОВАТЬ ПО
	|		Расчеты.РасчетныйДокумент,
	|		Расчеты.АналитикаУчетаПоПартнерам.Организация,
	|		Расчеты.АналитикаУчетаПоПартнерам,
	|		Расчеты.ЗаказКлиента,
	|		Расчеты.Регистратор,
	|		Расчеты.АналитикаУчетаПоПартнерам.Контрагент,
	|		Расчеты.АналитикаУчетаПоПартнерам.Договор,
	|		Расчеты.АналитикаУчетаПоПартнерам.НаправлениеДеятельности,
	|		Расчеты.АналитикаУчетаПоПартнерам.Контрагент,
	|		Расчеты.АналитикаУчетаПоПартнерам.Договор,
	|		Расчеты.АналитикаУчетаПоПартнерам.НаправлениеДеятельности,
	|		Расчеты.АналитикаУчетаПоПартнерам,
	|		Расчеты.ЗаказКлиента
	|
	|ИМЕЮЩИЕ
	|	СУММА(Расчеты.Предоплата * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА 1
	|			ИНАЧЕ -1
	|		КОНЕЦ) > 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент,
	|	Организация,
	|	ДокументРегистратор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Погашения.РасчетныйДокумент КАК РасчетныйДокумент,
	|	Погашения.Организация КАК Организация,
	|	Погашения.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Погашения.ОбъектРасчетов КАК ОбъектРасчетов,
	|	Погашения.ДокументРегистратор КАК ДокументРегистратор,
	|	Погашения.Контрагент КАК Контрагент,
	|	Погашения.Договор КАК Договор,
	|	Погашения.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Погашения.ИсхКонтрагент КАК ИсхКонтрагент,
	|	Погашения.ИсхДоговор КАК ИсхДоговор,
	|	Погашения.ИсхНаправлениеДеятельности КАК ИсхНаправлениеДеятельности,
	|	Погашения.КорАналитикаУчетаПоПартнерам КАК КорАналитикаУчетаПоПартнерам,
	|	Погашения.ИсходнаяАналитикаУчетаПоПартнерам КАК ИсходнаяАналитикаУчетаПоПартнерам,
	|	Погашения.КорОбъектРасчетов КАК КорОбъектРасчетов,
	|	Погашения.ИсходныйОбъектРасчетов КАК ИсходныйОбъектРасчетов,
	|	Погашения.ДатаАванса КАК ДатаАванса,
	|	Погашения.ДатаПогашения КАК ДатаПогашения,
	|	МАКСИМУМ(Погашения.СобытиеЗнак) КАК СобытиеЗнак,
	|	МАКСИМУМ(ВЫБОР
	|			КОГДА Погашения.ВидСобытия = НЕОПРЕДЕЛЕНО
	|			// Если вид события не удалось идентифицировать сразу, смотрим вторичные признаки
	|				ТОГДА ВЫБОР
	|						КОГДА ЕСТЬNULL(ВидыСобытий.ХозяйственнаяОперация, НЕОПРЕДЕЛЕНО) = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОплатыКлиенту)
	|							ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОплатыКлиенту)
	|						КОГДА ЕСТЬNULL(ВидыСобытий.ХозяйственнаяОперация, НЕОПРЕДЕЛЕНО) = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаКлиента)
	|							ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаКлиента)
	|						КОГДА Погашения.СобытиеЗнак < 0
	|							ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОплатыКлиенту)
	|						ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаКлиента)
	|					КОНЕЦ
	|			ИНАЧЕ Погашения.ВидСобытия
	|		КОНЕЦ) КАК ВидСобытия,
	|	МАКСИМУМ(Погашения.ВалютаДокумента) КАК ВалютаДокумента,
	|	МАКСИМУМ(Погашения.СуммаПогашения) КАК СуммаПогашения,
	|	МАКСИМУМ(Погашения.СуммаПогашенияВал) КАК СуммаПогашенияВал,
	|	МАКСИМУМ(Погашения.СуммаПогашенияУпр) КАК СуммаПогашенияУпр,
	|	МАКСИМУМ(Погашения.СуммаПогашенияРегл) КАК СуммаПогашенияРегл
	|ПОМЕСТИТЬ РасчетыСКлиентами_ПогашенияАвансов
	|ИЗ
	|РасчетыСКлиентами_ПогашенияАвансов_Предварительная КАК Погашения
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		// Соединяемся с регистром, а не с готовой временной таблицой в связи с тем, чтобы учесть резервирования,
	|		// которые были вне периода зачета
	|		РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК Резервирование
	|	ПО
	|		&НоваяАрхитектураВзаиморасчетов
	|		И &УчестьРезервированиеАвансов
	|		И Погашения.ДокументРегистратор    = Резервирование.ДокументРегистратор
	|		И Погашения.РасчетныйДокумент      = Резервирование.РасчетныйДокумент
	|		И Погашения.ИсходныйОбъектРасчетов = Резервирование.ОбъектРасчетов
	|		И Резервирование.Период            <= &ДатаОкончания
	|		И Погашения.Организация            = Резервирование.ОбъектРасчетов.Организация
	|		И Резервирование.ВидДвижения       = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Резервирование.ХозяйственнаяОперация
	|			= ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РезервированиеАвансаКлиента)
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		// Находим вид события, если изначально не удалось идентифицировать
	|		РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК ВидыСобытий
	|	ПО
	|		&НоваяАрхитектураВзаиморасчетов
	|		И Погашения.ВидСобытия          = НЕОПРЕДЕЛЕНО
	|		И Погашения.ДокументРегистратор = ВидыСобытий.ДокументРегистратор
	|		И ВидыСобытий.Период            <= &ДатаОкончания
	|		И ВидыСобытий.ВидДвижения       = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И ВидыСобытий.ХозяйственнаяОперация В
	|			(ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОплатыКлиенту),
	|			 ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаКлиента))
	|
	|ГДЕ
	|	Резервирование.РасчетныйДокумент ЕСТЬ NULL
	|
	|СГРУППИРОВАТЬ ПО
	|	Погашения.РасчетныйДокумент,
	|	Погашения.Организация,
	|	Погашения.АналитикаУчетаПоПартнерам,
	|	Погашения.ОбъектРасчетов,
	|	Погашения.ДокументРегистратор,
	|	Погашения.Контрагент,
	|	Погашения.Договор,
	|	Погашения.НаправлениеДеятельности,
	|	Погашения.ИсхКонтрагент,
	|	Погашения.ИсхДоговор,
	|	Погашения.ИсхНаправлениеДеятельности,
	|	Погашения.КорАналитикаУчетаПоПартнерам,
	|	Погашения.ИсходнаяАналитикаУчетаПоПартнерам,
	|	Погашения.КорОбъектРасчетов,
	|	Погашения.ИсходныйОбъектРасчетов,
	|	Погашения.ДатаАванса,
	|	Погашения.ДатаПогашения
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	РезервированиеПриходы.РасчетныйДокумент КАК РасчетныйДокумент,
	|	РезервированиеПриходы.ОбъектРасчетов.Организация КАК Организация,
	|	РезервированиеПриходы.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	РезервированиеПриходы.ОбъектРасчетов КАК ОбъектРасчетов,
	|	РезервированиеПриходы.ДокументРегистратор КАК ДокументРегистратор,
	|	РезервированиеПриходы.ОбъектРасчетов.Контрагент КАК Контрагент,
	|	РезервированиеПриходы.ОбъектРасчетов.Договор КАК Договор,
	|	РезервированиеПриходы.ОбъектРасчетов.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	МАКСИМУМ(РезервированиеРасходы.ОбъектРасчетов.Контрагент) КАК ИсхКонтрагент,
	|	МАКСИМУМ(РезервированиеРасходы.ОбъектРасчетов.Договор) КАК ИсхДоговор,
	|	МАКСИМУМ(РезервированиеРасходы.ОбъектРасчетов.НаправлениеДеятельности) КАК ИсхНаправлениеДеятельности,
	|	МАКСИМУМ(РезервированиеРасходы.КорАналитикаУчетаПоПартнерам) КАК КорАналитикаУчетаПоПартнерам,
	|	МАКСИМУМ(РезервированиеРасходы.АналитикаУчетаПоПартнерам) КАК ИсходнаяАналитикаУчетаПоПартнерам,
	|	МАКСИМУМ(РезервированиеРасходы.КорОбъектРасчетов) КАК КорОбъектРасчетов,
	|	МАКСИМУМ(РезервированиеРасходы.ОбъектРасчетов) КАК ИсходныйОбъектРасчетов, // объект, с которого зарезервировались средства
	|	МИНИМУМ(РезервированиеРасходы.ДатаВозникновения) КАК ДатаАванса,
	|	МАКСИМУМ(РезервированиеРасходы.Период) КАК ДатаПогашения,
	|	МАКСИМУМ(РезервированиеПриходы.СуммаРезервированияВал) КАК СобытиеЗнак,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РезервированиеАвансаКлиента) КАК ВидСобытия,
	|	МАКСИМУМ(РезервированиеПриходы.ВалютаДокумента) КАК ВалютаДокумента,
	|	МАКСИМУМ(РезервированиеПриходы.СуммаРезервирования) КАК СуммаПогашения,
	|	МАКСИМУМ(РезервированиеПриходы.СуммаРезервированияВал) КАК СуммаПогашенияВал,
	|	МАКСИМУМ(РезервированиеПриходы.СуммаРезервированияУпр) КАК СуммаПогашенияУпр,
	|	МАКСИМУМ(РезервированиеПриходы.СуммаРезервированияРегл) КАК СуммаПогашенияРегл
	|ИЗ
	|	(ВЫБРАТЬ
	|		Расчеты.РасчетныйДокумент,
	|		Расчеты.ОбъектРасчетов.Организация КАК Организация,
	|		Расчеты.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|		Расчеты.ОбъектРасчетов КАК ОбъектРасчетов,
	|		Расчеты.ДокументРегистратор КАК ДокументРегистратор,
	|		МАКСИМУМ(ВЫБОР
	|				КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПриходныйКассовыйОрдер
	|					ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПриходныйКассовыйОрдер).Валюта
	|				КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПоступлениеБезналичныхДенежныхСредств
	|					ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент
	|									КАК Документ.ПоступлениеБезналичныхДенежныхСредств).Валюта
	|				КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПервичныйДокумент
	|					ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.ПервичныйДокумент).Валюта
	|				ИНАЧЕ Расчеты.Валюта
	|		КОНЕЦ) КАК ВалютаДокумента,
	|		СУММА(ВЫБОР
	|				КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПриходныйКассовыйОрдер
	|						И ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент
	|									КАК Документ.ПриходныйКассовыйОрдер).Валюта = Расчеты.ОбъектРасчетов.Организация.ВалютаРегламентированногоУчета
	|					ТОГДА Расчеты.ПредоплатаРегл
	|				КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПоступлениеБезналичныхДенежныхСредств
	|						И ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент
	|									КАК Документ.ПоступлениеБезналичныхДенежныхСредств).Валюта = Расчеты.ОбъектРасчетов.Организация.ВалютаРегламентированногоУчета
	|					ТОГДА Расчеты.ПредоплатаРегл
	|				ИНАЧЕ
	|					Расчеты.Предоплата
	|		КОНЕЦ) КАК СуммаРезервированияВал,
	|		СУММА(Расчеты.Предоплата) КАК СуммаРезервирования,
	|		СУММА(Расчеты.ПредоплатаУпр) КАК СуммаРезервированияУпр,
	|		СУММА(Расчеты.ПредоплатаРегл) КАК СуммаРезервированияРегл
	|	ИЗ
	|		РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК Расчеты
	|	ГДЕ
	|		&НоваяАрхитектураВзаиморасчетов
	|		И &УчестьРезервированиеАвансов
	|		И НЕ &СоздатьПустуюТаблицу
	|		И (НЕ &ВключитьОтборПоОрганизациям
	|			ИЛИ Расчеты.ОбъектРасчетов.Организация В (&Организации))
	|		И (&ТекстОтборПоПараметрам)
	|		И Расчеты.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
	|		И Расчеты.Активность  = ИСТИНА
	|		И Расчеты.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РезервированиеАвансаКлиента)
	|		И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		И Расчеты.Предоплата > 0
	|	
	|	СГРУППИРОВАТЬ ПО
	|		Расчеты.РасчетныйДокумент,
	|		Расчеты.ОбъектРасчетов.Организация,
	|		Расчеты.ОбъектРасчетов.Организация.ВалютаРегламентированногоУчета,
	|		Расчеты.АналитикаУчетаПоПартнерам,
	|		Расчеты.ОбъектРасчетов,
	|		Расчеты.ДокументРегистратор
	|
	|	) КАК РезервированиеПриходы
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		// В расходах содержатся данные по авансу, с которого зарезервировались средства
	|		РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК РезервированиеРасходы
	|	ПО
	|		РезервированиеПриходы.ДокументРегистратор    = РезервированиеРасходы.ДокументРегистратор
	|		И  РезервированиеПриходы.РасчетныйДокумент   = РезервированиеРасходы.РасчетныйДокумент
	|		И  РезервированиеПриходы.Организация         = РезервированиеРасходы.ОбъектРасчетов.Организация
	|		И  РезервированиеРасходы.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
	|		И  РезервированиеРасходы.Активность  = ИСТИНА
	|		И  РезервированиеРасходы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И  РезервированиеРасходы.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РезервированиеАвансаКлиента)
	|
	|СГРУППИРОВАТЬ ПО
	|	РезервированиеПриходы.РасчетныйДокумент,
	|	РезервированиеПриходы.ОбъектРасчетов.Организация,
	|	РезервированиеПриходы.АналитикаУчетаПоПартнерам,
	|	РезервированиеПриходы.ОбъектРасчетов,
	|	РезервированиеПриходы.ДокументРегистратор
	|
	|ИМЕЮЩИЕ
	|	СУММА(РезервированиеПриходы.СуммаРезервирования) > 0
	|
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент,
	|	ИсходныйОбъектРасчетов,
	|	ИсходнаяАналитикаУчетаПоПартнерам,
	|	ДатаАванса
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ОтборПогашенийАвансов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ РасчетыСКлиентами_ПогашенияАвансов_Предварительная
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ РасчетыСКлиентами_ПогашенияСНеявнымЗачетом
	|;
	|";
	
	УстановитьПоляИндексов(Запрос, ПараметрыРасчета, "РасчетыСКлиентами_ПогашенияАвансов");
	
	ПараметрыПутей = ИнициализироватьПараметрыДляОтбораАвансов_ПутиКПолямИТекстуЗамены();
	ОбработатьТекстЗапросаДляОтбораАвансовПоПараметрам(Запрос, ПараметрыРасчета, ПараметрыПутей);
	
	Запрос.Выполнить();
	
КонецПроцедуры

// Подготовить временную таблицу "РасчетыСКлиентами_Переносы"
// Создает временную таблицу с колонками:
// 	  Организация;
// 	  ДокументОплаты;
// 	  ДокументПереноса;
// 	  АналитикаУчетаПоПартнерам;
// 	  ОбъектРасчетов;
// 	  Контрагент;
// 	  НаправлениеДеятельности;  
// 	  Подразделение;
// 	  КорАналитикаУчетаПоПартнерам;
// 	  КорОбъектРасчетов;
// 	  КорКонтрагент;
// 	  КорНаправлениеДеятельности;  
// 	  КорПодразделение;
// 	  Период;
// 	  НастройкаХозяйственнойОперации
// 	  ИдентификаторФинЗаписи;
// 	  Валюта;
// 	  Предоплата;
// 	  ПредоплатаРегл;
// 	  ПредоплатаУпр.
//
// Параметры:
//  МенеджерВременныхТаблиц - МенеджерВременныхТаблиц - 
//  ПараметрыРасчета        - см. ИнициализироватьПараметрыПодготовкиРасчетовАвансов
Процедура ПодготовитьВТ_РасчетыСКлиентами_ПереносыАвансов(МенеджерВременныхТаблиц, ПараметрыРасчета) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	УстановитьПараметрыЗапросаПодготовкиРасчетовАвансов(Запрос, ПараметрыРасчета);

	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВложенныйЗапрос.Организация КАК Организация,
	|	ВложенныйЗапрос.ДокументПереноса КАК ДокументЗачетаАванса,
	|	ВложенныйЗапрос.ДокументОплаты КАК ДокументОплаты,
	|	ВложенныйЗапрос.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	ВложенныйЗапрос.ОбъектРасчетов КАК ОбъектРасчетов,
	|	ВложенныйЗапрос.Контрагент КАК Контрагент,
	|	ВложенныйЗапрос.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ВложенныйЗапрос.Подразделение КАК Подразделение,
	|	ВложенныйЗапрос.КорАналитикаУчетаПоПартнерам КАК КорАналитикаУчетаПоПартнерам,
	|	ВложенныйЗапрос.КорОбъектРасчетов КАК КорОбъектРасчетов,
	|	ВложенныйЗапрос.КорКонтрагент КАК КорКонтрагент,
	|	ВложенныйЗапрос.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	ВложенныйЗапрос.КорПодразделение КАК КорПодразделение,
	|	ВложенныйЗапрос.Период КАК Период,
	|	ВложенныйЗапрос.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	ВложенныйЗапрос.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи,
	|	ВложенныйЗапрос.Валюта КАК Валюта,
	|	СУММА(ВложенныйЗапрос.Предоплата) КАК Предоплата,
	|	СУММА(ВложенныйЗапрос.ПредоплатаРегл) КАК ПредоплатаРегл,
	|	СУММА(ВложенныйЗапрос.ПредоплатаУпр) КАК ПредоплатаУпр
	|ПОМЕСТИТЬ РасчетыСКлиентами_ПереносыАвансов
	|ИЗ
	|	(ВЫБРАТЬ
	|		РасчетыСКлиентамиПоСрокам.ОбъектРасчетов.Организация КАК Организация,
	|		РасчетыСКлиентамиПоСрокам.ДокументРегистратор КАК ДокументПереноса,
	|		РасчетыСКлиентамиПоСрокам.РасчетныйДокумент КАК ДокументОплаты,
	|		РасчетыСКлиентамиПоСрокам.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|		РасчетыСКлиентамиПоСрокам.ОбъектРасчетов КАК ОбъектРасчетов,
	|		РасчетыСКлиентамиПоСрокам.АналитикаУчетаПоПартнерам.Контрагент КАК Контрагент,
	|		РасчетыСКлиентамиПоСрокам.ОбъектРасчетов.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|		РасчетыСКлиентамиПоСрокам.ОбъектРасчетов.Подразделение КАК Подразделение,
	|		РасчетыСКлиентамиПоСрокам.КорАналитикаУчетаПоПартнерам КАК КорАналитикаУчетаПоПартнерам,
	|		РасчетыСКлиентамиПоСрокам.КорОбъектРасчетов КАК КорОбъектРасчетов,
	|		РасчетыСКлиентамиПоСрокам.КорАналитикаУчетаПоПартнерам.Контрагент КАК КорКонтрагент,
	|		РасчетыСКлиентамиПоСрокам.КорОбъектРасчетов.НаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|		РасчетыСКлиентамиПоСрокам.КорОбъектРасчетов.Подразделение КАК КорПодразделение,
	|		РасчетыСКлиентамиПоСрокам.Период КАК Период,
	|		РасчетыСКлиентамиПоСрокам.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|		РасчетыСКлиентамиПоСрокам.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи,
	|		РасчетыСКлиентамиПоСрокам.Валюта КАК Валюта,
	|		РасчетыСКлиентамиПоСрокам.Предоплата КАК Предоплата,
	|		РасчетыСКлиентамиПоСрокам.ПредоплатаРегл КАК ПредоплатаРегл,
	|		РасчетыСКлиентамиПоСрокам.ПредоплатаУпр КАК ПредоплатаУпр
	|	ИЗ
	|		РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК РасчетыСКлиентамиПоСрокам
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВзаимозачетЗадолженности КАК ВзаимозачетЗадолженности
	|			ПО РасчетыСКлиентамиПоСрокам.ДокументРегистратор = ВзаимозачетЗадолженности.Ссылка
	|				И (ВзаимозачетЗадолженности.ВидОперации В (ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаОрганизацияКонтрагент), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаМеждуКонтрагентами), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуОрганизацияКонтрагент), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуМеждуКонтрагентами), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаМеждуДвумяОрганизациями), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуМеждуДвумяОрганизациями)))
	|	ГДЕ
	|		РасчетыСКлиентамиПоСрокам.НастройкаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПереносАванса)
	|		И РасчетыСКлиентамиПоСрокам.Активность
	|		И НЕ РасчетыСКлиентамиПоСрокам.Сторно
	|		И РасчетыСКлиентамиПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		И РасчетыСКлиентамиПоСрокам.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
	|		И РасчетыСКлиентамиПоСрокам.АналитикаУчетаПоПартнерам.Организация В(&Организации)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		РасчетыСКлиентамиПоСрокам.ОбъектРасчетов.Организация,
	|		РасчетыСКлиентамиПоСрокам.ДокументРегистратор,
	|		РасчетыСКлиентамиПоСрокам_Приход.РасчетныйДокумент,
	|		РасчетыСКлиентамиПоСрокам.АналитикаУчетаПоПартнерам,
	|		РасчетыСКлиентамиПоСрокам.ОбъектРасчетов,
	|		РасчетыСКлиентамиПоСрокам.АналитикаУчетаПоПартнерам.Контрагент,
	|		РасчетыСКлиентамиПоСрокам.ОбъектРасчетов.НаправлениеДеятельности,
	|		РасчетыСКлиентамиПоСрокам.ОбъектРасчетов.Подразделение,
	|		РасчетыСКлиентамиПоСрокам.КорАналитикаУчетаПоПартнерам,
	|		РасчетыСКлиентамиПоСрокам.КорОбъектРасчетов,
	|		РасчетыСКлиентамиПоСрокам.КорАналитикаУчетаПоПартнерам.Контрагент,
	|		РасчетыСКлиентамиПоСрокам.КорОбъектРасчетов.НаправлениеДеятельности,
	|		РасчетыСКлиентамиПоСрокам.КорОбъектРасчетов.Подразделение,
	|		РасчетыСКлиентамиПоСрокам.Период,
	|		РасчетыСКлиентамиПоСрокам.НастройкаХозяйственнойОперации,
	|		РасчетыСКлиентамиПоСрокам.ИдентификаторФинЗаписи,
	|		РасчетыСКлиентамиПоСрокам.Валюта,
	|		РасчетыСКлиентамиПоСрокам.Долг,
	|		РасчетыСКлиентамиПоСрокам.ДолгРегл,
	|		РасчетыСКлиентамиПоСрокам.ДолгУпр
	|	ИЗ
	|		РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК РасчетыСКлиентамиПоСрокам
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВзаимозачетЗадолженности КАК ВзаимозачетЗадолженности
	|			ПО РасчетыСКлиентамиПоСрокам.ДокументРегистратор = ВзаимозачетЗадолженности.Ссылка
	|				И (ВзаимозачетЗадолженности.ВидОперации В (ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаОрганизацияКонтрагент), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаМеждуКонтрагентами), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуОрганизацияКонтрагент), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуМеждуКонтрагентами), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаМеждуДвумяОрганизациями), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуМеждуДвумяОрганизациями)))
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК РасчетыСКлиентамиПоСрокам_Приход
	|			ПО (РасчетыСКлиентамиПоСрокам_Приход.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход))
	|				И РасчетыСКлиентамиПоСрокам.ОбъектРасчетов = РасчетыСКлиентамиПоСрокам_Приход.ОбъектРасчетов
	|				И РасчетыСКлиентамиПоСрокам.АналитикаУчетаПоПартнерам = РасчетыСКлиентамиПоСрокам_Приход.АналитикаУчетаПоПартнерам
	|				И РасчетыСКлиентамиПоСрокам.ДокументРегистратор = РасчетыСКлиентамиПоСрокам_Приход.ДокументРегистратор
	|	ГДЕ
	|		РасчетыСКлиентамиПоСрокам.НастройкаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПереносАванса)
	|		И РасчетыСКлиентамиПоСрокам.Активность
	|		И НЕ РасчетыСКлиентамиПоСрокам.Сторно
	|		И РасчетыСКлиентамиПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И РасчетыСКлиентамиПоСрокам.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
	|		И РасчетыСКлиентамиПоСрокам.АналитикаУчетаПоПартнерам.Организация В(&Организации)
	|		И РасчетыСКлиентамиПоСрокам.Долг > 0) КАК ВложенныйЗапрос
	|
	|СГРУППИРОВАТЬ ПО
	|	ВложенныйЗапрос.АналитикаУчетаПоПартнерам,
	|	ВложенныйЗапрос.Валюта,
	|	ВложенныйЗапрос.КорАналитикаУчетаПоПартнерам,
	|	ВложенныйЗапрос.Подразделение,
	|	ВложенныйЗапрос.КорПодразделение,
	|	ВложенныйЗапрос.ДокументОплаты,
	|	ВложенныйЗапрос.КорНаправлениеДеятельности,
	|	ВложенныйЗапрос.ИдентификаторФинЗаписи,
	|	ВложенныйЗапрос.Период,
	|	ВложенныйЗапрос.Организация,
	|	ВложенныйЗапрос.КорОбъектРасчетов,
	|	ВложенныйЗапрос.КорКонтрагент,
	|	ВложенныйЗапрос.НаправлениеДеятельности,
	|	ВложенныйЗапрос.Контрагент,
	|	ВложенныйЗапрос.НастройкаХозяйственнойОперации,
	|	ВложенныйЗапрос.ОбъектРасчетов,
	|	ВложенныйЗапрос.ДокументПереноса";
	
	УстановитьПоляИндексов(Запрос, ПараметрыРасчета, "РасчетыСКлиентами_ПереносыАвансов");
	
	Запрос.Выполнить();
	
КонецПроцедуры

// Подготовить временную таблицу "ПолученныеАвансыВРазрезеПогашенийИОстатков"
// Создает временную таблицу с колонками:
//   Организация;
//   НаправлениеДеятельности;
//   Контрагент;
//   Договор;
//   ИсхНаправлениеДеятельности - направление, по которому возник аванс;
//   ИсхКонтрагент - контрагент, по которому возник аванс;
//   ИсхДоговор    - договор, по которому возник аванс;
//   РасчетныйДокумент;
//   ИсходнаяАналитикаУчетаПоПартнерам - аналитика, по которой образовался аванс;
//   ИсходныйОбъектРасчетов - объект расчетов, по которому образовался аванс;
//   ДатаАванса;
//   ДатаПогашения - если пустая, значит это остаток;
//   ВалютаДокумента;
//   ДокументРегистратор;
//   СуммаВал - сумма в валюте документа;
//   СуммаУпр;
//   СуммаРегл;
//   Сумма.
//
// Параметры:
//  МенеджерВременныхТаблиц - МенеджерВременныхТаблиц - 
//  ПараметрыРасчета        - см. ИнициализироватьПараметрыПодготовкиРасчетовАвансов
Процедура ПодготовитьВТ_ПолученныеАвансыВРазрезеПогашенийИОстатков(МенеджерВременныхТаблиц, ПараметрыРасчета) Экспорт
	
	ПараметрыРасчетаПоступленийПогашений = ИнициализироватьПараметрыПодготовкиРасчетовАвансов(ПараметрыРасчета);
	ПараметрыРасчетаПоступленийПогашений.ПоляИндексовВручную.Очистить();
	Если ЗначениеЗаполнено(ПараметрыРасчета.Организации) Тогда
		ПараметрыРасчетаПоступленийПогашений.ВключитьОтборПоОрганизациям = Истина;
	КонецЕсли;
	
	Если НЕ РасчетСебестоимостиПрикладныеАлгоритмы.ВременнаяТаблицаСуществует(МенеджерВременныхТаблиц,
		"РасчетыСКлиентами_Авансы") Тогда
		ПодготовитьВТ_РасчетыСКлиентами_Авансы(
			МенеджерВременныхТаблиц,
			ПараметрыРасчетаПоступленийПогашений);
	КонецЕсли;
	
	Если НЕ РасчетСебестоимостиПрикладныеАлгоритмы.ВременнаяТаблицаСуществует(МенеджерВременныхТаблиц,
		"РасчетыСКлиентами_ПогашенияАвансов") Тогда
		ПодготовитьВТ_РасчетыСКлиентами_ПогашенияАвансов(
			МенеджерВременныхТаблиц,
			ПараметрыРасчетаПоступленийПогашений);
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	УстановитьПараметрыЗапросаПодготовкиРасчетовАвансов(Запрос, ПараметрыРасчета);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ПогашенияАвансов.Организация КАК Организация,
	|	ПогашенияАвансов.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ПогашенияАвансов.ИсходнаяАналитикаУчетаПоПартнерам КАК ИсходнаяАналитикаУчетаПоПартнерам,
	|	ПогашенияАвансов.ИсходныйОбъектРасчетов КАК ИсходныйОбъектРасчетов,
	|	ПогашенияАвансов.ДатаАванса КАК ДатаАванса,
	|	СУММА(ПогашенияАвансов.СуммаПогашенияВал) КАК СуммаПогашенияВал,
	|	СУММА(ПогашенияАвансов.СуммаПогашенияУпр) КАК СуммаПогашенияУпр,
	|	СУММА(ПогашенияАвансов.СуммаПогашенияРегл) КАК СуммаПогашенияРегл,
	|	СУММА(ПогашенияАвансов.СуммаПогашения) КАК СуммаПогашения
	|ПОМЕСТИТЬ ПогашенияАвансов_Свернуто
	|ИЗ
	|	РасчетыСКлиентами_ПогашенияАвансов КАК ПогашенияАвансов
	|
	|СГРУППИРОВАТЬ ПО
	|	ПогашенияАвансов.Организация,
	|	ПогашенияАвансов.РасчетныйДокумент,
	|	ПогашенияАвансов.ДатаАванса,
	|	ПогашенияАвансов.ИсходнаяАналитикаУчетаПоПартнерам,
	|	ПогашенияАвансов.ИсходныйОбъектРасчетов
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент,
	|	ИсходныйОбъектРасчетов,
	|	ИсходнаяАналитикаУчетаПоПартнерам,
	|	ДатаАванса
	|; 
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПоступленияАвансов.Организация КАК Организация,
	|	ПоступленияАвансов.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ПоступленияАвансов.Контрагент КАК Контрагент,
	|	ПоступленияАвансов.Договор КАК Договор,
	|	ПоступленияАвансов.ОбъектРасчетов КАК ОбъектРасчетов,
	|	ПоступленияАвансов.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ПоступленияАвансов.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	ПоступленияАвансов.ДатаАванса КАК ДатаАванса,
	|	МАКСИМУМ(ПоступленияАвансов.ВалютаДокумента) КАК ВалютаДокумента,
	|	СУММА(ПоступленияАвансов.СуммаАвансаВал) КАК СуммаАвансаВал,
	|	СУММА(ПоступленияАвансов.СуммаАвансаУпр) КАК СуммаАвансаУпр,
	|	СУММА(ПоступленияАвансов.СуммаАвансаРегл) КАК СуммаАвансаРегл,
	|	СУММА(ПоступленияАвансов.СуммаАванса) КАК СуммаАванса
	|ПОМЕСТИТЬ ПоступленияАвансов_Свернуто
	|ИЗ
	|	РасчетыСКлиентами_Авансы КАК ПоступленияАвансов
	|СГРУППИРОВАТЬ ПО
	|	ПоступленияАвансов.Организация,
	|	ПоступленияАвансов.НаправлениеДеятельности,
	|	ПоступленияАвансов.Контрагент,
	|	ПоступленияАвансов.Договор,
	|	ПоступленияАвансов.ОбъектРасчетов,
	|	ПоступленияАвансов.РасчетныйДокумент,
	|	ПоступленияАвансов.ДатаАванса,
	|	ПоступленияАвансов.АналитикаУчетаПоПартнерам
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент,
	|	ОбъектРасчетов,
	|	АналитикаУчетаПоПартнерам,
	|	ДатаАванса
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДанныеАвансов.Организация КАК Организация,
	|	ДанныеАвансов.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	ДанныеАвансов.ОбъектРасчетов КАК ОбъектРасчетов,
	|	ДанныеАвансов.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДанныеАвансов.ДатаАванса КАК ДатаАванса,
	|	ДанныеАвансов.ИсходнаяАналитикаУчетаПоПартнерам КАК ИсходнаяАналитикаУчетаПоПартнерам,
	|	ДанныеАвансов.ИсходныйОбъектРасчетов КАК ИсходныйОбъектРасчетов,
	|	ДанныеАвансов.ВалютаДокумента КАК ВалютаДокумента,
	|	ДанныеАвансов.Контрагент КАК Контрагент,
	|	ДанныеАвансов.Договор КАК Договор,
	|	ДанныеАвансов.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ДанныеАвансов.ИсхКонтрагент КАК ИсхКонтрагент,
	|	ДанныеАвансов.ИсхДоговор КАК ИсхДоговор,
	|	ДанныеАвансов.ИсхНаправлениеДеятельности КАК ИсхНаправлениеДеятельности
	|ПОМЕСТИТЬ ДанныеАвансовПолученных
	|ИЗ
	|	(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		ПоступленияАвансов.Организация КАК Организация,
	|		ПоступленияАвансов.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|		ПоступленияАвансов.ОбъектРасчетов КАК ОбъектРасчетов,
	|		ПоступленияАвансов.АналитикаУчетаПоПартнерам КАК ИсходнаяАналитикаУчетаПоПартнерам,
	|		ПоступленияАвансов.ОбъектРасчетов КАК ИсходныйОбъектРасчетов,
	|		ПоступленияАвансов.РасчетныйДокумент КАК РасчетныйДокумент,
	|		ПоступленияАвансов.ДатаАванса КАК ДатаАванса,
	|		ПоступленияАвансов.ВалютаДокумента КАК ВалютаДокумента,
	|		ПоступленияАвансов.Контрагент КАК Контрагент,
	|		ПоступленияАвансов.Договор КАК Договор,
	|		ПоступленияАвансов.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|		ПоступленияАвансов.Контрагент КАК ИсхКонтрагент,
	|		ПоступленияАвансов.Договор КАК ИсхДоговор,
	|		ПоступленияАвансов.НаправлениеДеятельности КАК ИсхНаправлениеДеятельности
	|	ИЗ
	|		РасчетыСКлиентами_Авансы КАК ПоступленияАвансов
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		ПогашенияАвансов.Организация КАК Организация,
	|		ПогашенияАвансов.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|		ВЫБОР
	|			КОГДА ПогашенияАвансов.ВидСобытия = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РезервированиеАвансаКлиента)
	|				ТОГДА ПогашенияАвансов.ИсходныйОбъектРасчетов
	|			ИНАЧЕ ПогашенияАвансов.ОбъектРасчетов
	|		КОНЕЦ КАК ОбъектРасчетов,
	|		ПогашенияАвансов.ИсходнаяАналитикаУчетаПоПартнерам КАК ИсходнаяАналитикаУчетаПоПартнерам,
	|		ПогашенияАвансов.ИсходныйОбъектРасчетов КАК ИсходныйОбъектРасчетов,
	|		ПогашенияАвансов.РасчетныйДокумент КАК РасчетныйДокумент,
	|		ПогашенияАвансов.ДатаАванса КАК ДатаАванса,
	|		ПогашенияАвансов.ВалютаДокумента КАК ВалютаДокумента,
	|		ПогашенияАвансов.Контрагент КАК Контрагент,
	|		ПогашенияАвансов.Договор КАК Договор,
	|		ПогашенияАвансов.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|		ПогашенияАвансов.ИсхКонтрагент КАК ИсхКонтрагент,
	|		ПогашенияАвансов.ИсхДоговор КАК ИсхДоговор,
	|		ПогашенияАвансов.ИсхНаправлениеДеятельности КАК ИсхНаправлениеДеятельности
	|	ИЗ
	|		РасчетыСКлиентами_ПогашенияАвансов КАК ПогашенияАвансов) КАК ДанныеАвансов
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаПоПартнерам,
	|	ОбъектРасчетов,
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Авансы.Организация КАК Организация,
	|	Авансы.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Авансы.Контрагент КАК Контрагент,
	|	Авансы.Договор КАК Договор,
	|	Авансы.ОбъектРасчетов КАК ОбъектРасчетов,
	|	Авансы.ИсхНаправлениеДеятельности КАК ИсхНаправлениеДеятельности,
	|	Авансы.ИсхКонтрагент КАК ИсхКонтрагент,
	|	Авансы.ИсхДоговор КАК ИсхДоговор,
	|	Авансы.РасчетныйДокумент КАК РасчетныйДокумент,
	|	Авансы.ИсходнаяАналитикаУчетаПоПартнерам КАК ИсходнаяАналитикаУчетаПоПартнерам,
	|	Авансы.ИсходныйОбъектРасчетов КАК ИсходныйОбъектРасчетов,
	|	Авансы.ДатаАванса КАК ДатаАванса,
	|	Авансы.ДатаПогашения КАК ДатаПогашения,
	|	Авансы.ВалютаДокумента КАК ВалютаДокумента,
	|	Авансы.ДокументРегистратор КАК ДокументРегистратор,
	|	Авансы.СуммаВал КАК СуммаВал,
	|	Авансы.СуммаУпр КАК СуммаУпр,
	|	Авансы.СуммаРегл КАК СуммаРегл,
	|	Авансы.Сумма КАК Сумма
	|ПОМЕСТИТЬ ПолученныеАвансыВРазрезеПогашенийИОстатков
	|ИЗ
	|	(ВЫБРАТЬ
	|		ПогашенияАвансов.Организация КАК Организация,
	|		ПогашенияАвансов.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|		ПогашенияАвансов.Контрагент КАК Контрагент,
	|		ПогашенияАвансов.Договор КАК Договор,
	|		ПогашенияАвансов.ОбъектРасчетов КАК ОбъектРасчетов,
	|		ПогашенияАвансов.ИсхНаправлениеДеятельности КАК ИсхНаправлениеДеятельности,
	|		ПогашенияАвансов.ИсхКонтрагент КАК ИсхКонтрагент,
	|		ПогашенияАвансов.ИсхДоговор КАК ИсхДоговор,
	|		ПогашенияАвансов.РасчетныйДокумент КАК РасчетныйДокумент,
	|		ПогашенияАвансов.ИсходнаяАналитикаУчетаПоПартнерам КАК ИсходнаяАналитикаУчетаПоПартнерам,
	|		ПогашенияАвансов.ИсходныйОбъектРасчетов КАК ИсходныйОбъектРасчетов,
	|		ПогашенияАвансов.ДатаАванса КАК ДатаАванса,
	|		ПогашенияАвансов.ДатаПогашения КАК ДатаПогашения,
	|		МАКСИМУМ(ПогашенияАвансов.ВалютаДокумента) КАК ВалютаДокумента,
	|		ПогашенияАвансов.ДокументРегистратор КАК ДокументРегистратор,
	|		СУММА(ПогашенияАвансов.СуммаПогашенияВал) КАК СуммаВал,
	|		СУММА(ПогашенияАвансов.СуммаПогашенияУпр) КАК СуммаУпр,
	|		СУММА(ПогашенияАвансов.СуммаПогашенияРегл) КАК СуммаРегл,
	|		СУММА(ПогашенияАвансов.СуммаПогашения) КАК Сумма
	|	ИЗ
	|		РасчетыСКлиентами_ПогашенияАвансов КАК ПогашенияАвансов
	|	СГРУППИРОВАТЬ ПО
	|		ПогашенияАвансов.Организация,
	|		ПогашенияАвансов.НаправлениеДеятельности,
	|		ПогашенияАвансов.Контрагент,
	|		ПогашенияАвансов.Договор,
	|		ПогашенияАвансов.ОбъектРасчетов,
	|		ПогашенияАвансов.ИсхНаправлениеДеятельности,
	|		ПогашенияАвансов.ИсхКонтрагент,
	|		ПогашенияАвансов.ИсхДоговор,
	|		ПогашенияАвансов.РасчетныйДокумент,
	|		ПогашенияАвансов.ДокументРегистратор,
	|		ПогашенияАвансов.ДатаАванса,
	|		ПогашенияАвансов.ДатаПогашения,
	|		ПогашенияАвансов.ИсходнаяАналитикаУчетаПоПартнерам,
	|		ПогашенияАвансов.ИсходныйОбъектРасчетов
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		ПоступленияАвансов.Организация КАК Организация,
	|		ПоступленияАвансов.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|		ПоступленияАвансов.Контрагент КАК Контрагент,
	|		ПоступленияАвансов.Договор КАК Договор,
	|		ПоступленияАвансов.ОбъектРасчетов КАК ОбъектРасчетов,
	|		ПоступленияАвансов.НаправлениеДеятельности КАК ИсхНаправлениеДеятельности,
	|		ПоступленияАвансов.Контрагент КАК ИсхКонтрагент,
	|		ПоступленияАвансов.Договор КАК ИсхДоговор,
	|		ПоступленияАвансов.РасчетныйДокумент КАК РасчетныйДокумент,
	|		ПоступленияАвансов.АналитикаУчетаПоПартнерам КАК ИсходнаяАналитикаУчетаПоПартнерам,
	|		ПоступленияАвансов.ОбъектРасчетов КАК ИсходныйОбъектРасчетов,
	|		ПоступленияАвансов.ДатаАванса КАК ДатаАванса,
	|		ДАТАВРЕМЯ(1, 1, 1) КАК ДатаПогашения,
	|		МАКСИМУМ(ПоступленияАвансов.ВалютаДокумента) КАК ВалютаДокумента,
	|		НЕОПРЕДЕЛЕНО КАК ДокументРегистратор,
	|		СУММА(ПоступленияАвансов.СуммаАвансаВал - ЕСТЬNULL(ПогашенияАвансов.СуммаПогашенияВал, 0)) КАК СуммаВал,
	|		СУММА(ПоступленияАвансов.СуммаАвансаУпр - ЕСТЬNULL(ПогашенияАвансов.СуммаПогашенияУпр, 0)) КАК СуммаУпр,
	|		СУММА(ПоступленияАвансов.СуммаАвансаРегл - ЕСТЬNULL(ПогашенияАвансов.СуммаПогашенияРегл, 0)) КАК СуммаРегл,
	|		СУММА(ПоступленияАвансов.СуммаАванса - ЕСТЬNULL(ПогашенияАвансов.СуммаПогашения, 0)) КАК Сумма
	|	ИЗ
	|		ПоступленияАвансов_Свернуто КАК ПоступленияАвансов
	|			ЛЕВОЕ СОЕДИНЕНИЕ ПогашенияАвансов_Свернуто КАК ПогашенияАвансов
	|			ПО ПоступленияАвансов.РасчетныйДокумент = ПогашенияАвансов.РасчетныйДокумент
	|			И ПоступленияАвансов.ОбъектРасчетов = ПогашенияАвансов.ИсходныйОбъектРасчетов
	|			И ПоступленияАвансов.АналитикаУчетаПоПартнерам = ПогашенияАвансов.ИсходнаяАналитикаУчетаПоПартнерам
	|			И ПоступленияАвансов.ДатаАванса = ПогашенияАвансов.ДатаАванса
	|	ГДЕ
	|		&НоваяАрхитектураВзаиморасчетов = ИСТИНА
	|
	|	СГРУППИРОВАТЬ ПО
	|		ПоступленияАвансов.Организация,
	|		ПоступленияАвансов.НаправлениеДеятельности,
	|		ПоступленияАвансов.Контрагент,
	|		ПоступленияАвансов.Договор,
	|		ПоступленияАвансов.ОбъектРасчетов,
	|		ПоступленияАвансов.НаправлениеДеятельности,
	|		ПоступленияАвансов.Контрагент,
	|		ПоступленияАвансов.Договор,
	|		ПоступленияАвансов.РасчетныйДокумент,
	|		ПоступленияАвансов.ДатаАванса,
	|		ПоступленияАвансов.АналитикаУчетаПоПартнерам,
	|		ПоступленияАвансов.ОбъектРасчетов
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		ДанныеАвансов.Организация,
	|		ДанныеАвансов.НаправлениеДеятельности,
	|		ДанныеАвансов.Контрагент,
	|		ДанныеАвансов.Договор,
	|		ДанныеАвансов.ОбъектРасчетов,
	|		ДанныеАвансов.ИсхНаправлениеДеятельности,
	|		ДанныеАвансов.ИсхКонтрагент,
	|		ДанныеАвансов.ИсхДоговор,
	|		ДанныеАвансов.РасчетныйДокумент,
	|		ДанныеАвансов.ИсходнаяАналитикаУчетаПоПартнерам,
	|		ДанныеАвансов.ИсходныйОбъектРасчетов,
	|		ДанныеАвансов.ДатаАванса,
	|		ДАТАВРЕМЯ(1, 1, 1) КАК ДатаПогашения,
	|		МАКСИМУМ(ДанныеАвансов.ВалютаДокумента) КАК ВалютаДокумента,
	|		НЕОПРЕДЕЛЕНО КАК ДокументРегистратор,
	|		-СУММА(ВЫБОР
	|			КОГДА ОстаткиПоАвансам.РасчетныйДокумент ССЫЛКА Документ.ПриходныйКассовыйОрдер
	|			И ВЫРАЗИТЬ(ОстаткиПоАвансам.РасчетныйДокумент КАК
	|				Документ.ПриходныйКассовыйОрдер).Валюта = ДанныеАвансов.Организация.ВалютаРегламентированногоУчета
	|				ТОГДА ОстаткиПоАвансам.ПредоплатаРеглОстаток
	|			КОГДА ОстаткиПоАвансам.РасчетныйДокумент ССЫЛКА Документ.ПоступлениеБезналичныхДенежныхСредств
	|			И ВЫРАЗИТЬ(ОстаткиПоАвансам.РасчетныйДокумент КАК
	|				Документ.ПоступлениеБезналичныхДенежныхСредств).Валюта = ДанныеАвансов.Организация.ВалютаРегламентированногоУчета
	|				ТОГДА ОстаткиПоАвансам.ПредоплатаРеглОстаток
	|			ИНАЧЕ ОстаткиПоАвансам.ПредоплатаОстаток + ОстаткиПоАвансам.КВозвратуОстаток
	|		КОНЕЦ) КАК СуммаВал,
	|		-СУММА(ОстаткиПоАвансам.ПредоплатаУпрОстаток) КАК СуммаУпр,
	|		-СУММА(ОстаткиПоАвансам.ПредоплатаРеглОстаток) КАК СуммаРегл,
	|		-СУММА(ОстаткиПоАвансам.ПредоплатаОстаток + ОстаткиПоАвансам.КВозвратуОстаток) КАК Сумма
	|	ИЗ
	|		РегистрНакопления.РасчетыСКлиентамиПоДокументам.Остатки(&ДатаОкончанияВключая,
	|		НЕ &НоваяАрхитектураВзаиморасчетов
	|		И (АналитикаУчетаПоПартнерам, ЗаказКлиента, РасчетныйДокумент) В
	|			(ВЫБРАТЬ
	|				ДанныеАвансов.АналитикаУчетаПоПартнерам,
	|				ДанныеАвансов.ОбъектРасчетов,
	|				ДанныеАвансов.РасчетныйДокумент
	|			ИЗ
	|				ДанныеАвансовПолученных КАК ДанныеАвансов)) КАК ОстаткиПоАвансам
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДанныеАвансовПолученных КАК ДанныеАвансов
	|			ПО ОстаткиПоАвансам.АналитикаУчетаПоПартнерам = ДанныеАвансов.АналитикаУчетаПоПартнерам
	|			И ОстаткиПоАвансам.ЗаказКлиента = ДанныеАвансов.ОбъектРасчетов
	|			И ОстаткиПоАвансам.РасчетныйДокумент = ДанныеАвансов.РасчетныйДокумент
	|	СГРУППИРОВАТЬ ПО
	|		ДанныеАвансов.Организация,
	|		ДанныеАвансов.НаправлениеДеятельности,
	|		ДанныеАвансов.Контрагент,
	|		ДанныеАвансов.Договор,
	|		ДанныеАвансов.ОбъектРасчетов,
	|		ДанныеАвансов.ИсхНаправлениеДеятельности,
	|		ДанныеАвансов.ИсхКонтрагент,
	|		ДанныеАвансов.ИсхДоговор,
	|		ДанныеАвансов.РасчетныйДокумент,
	|		ДанныеАвансов.ИсходнаяАналитикаУчетаПоПартнерам,
	|		ДанныеАвансов.ИсходныйОбъектРасчетов,
	|		ДанныеАвансов.ДатаАванса) КАК Авансы
	|ГДЕ
	|	ИСТИНА
	|	И (Авансы.ДатаАванса МЕЖДУ &ДатаНачала И &ДатаОкончания)
	|	И Авансы.СуммаВал <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДанныеАвансовПолученных
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ РасчетыСКлиентами_Авансы
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ РасчетыСКлиентами_ПогашенияАвансов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ПогашенияАвансов_Свернуто
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ПоступленияАвансов_Свернуто
	|";
	
	УстановитьПоляИндексов(Запрос, ПараметрыРасчета, "ПолученныеАвансыВРазрезеПогашенийИОстатков");
	
	ПараметрыПутей = ИнициализироватьПараметрыДляОтбораАвансов_ПутиКПолямИТекстуЗамены();
	ОбработатьТекстЗапросаДляОтбораАвансовПоПараметрам(Запрос, ПараметрыРасчета, ПараметрыПутей);
	
	Запрос.Выполнить();
	
КонецПроцедуры

#КонецОбласти

#Область АвансыВыданные

// Подготовить временную таблицу "РасчетыСПоставщиками_Авансы"
// Создает временную таблицу с колонками:
// 	  РасчетныйДокумент;
// 	  ДокументРегистратор;
// 	  Организация;
// 	  АналитикаУчетаПоПартнерам;
// 	  ОбъектРасчетов;
// 	  НаправлениеДеятельности;
// 	  Контрагент;
// 	  Договор;
// 	  ДатаАванса;
// 	  ВалютаДокумента;
// 	  СуммаАвансаВал - сумма в валюте документа;
// 	  СуммаАванса;
// 	  СуммаАвансаУпр;
// 	  СуммаАвансаРегл.
//
// Параметры:
//  МенеджерВременныхТаблиц - МенеджерВременныхТаблиц - 
//  ПараметрыРасчета        - см. ИнициализироватьПараметрыПодготовкиРасчетовАвансов
Процедура ПодготовитьВТ_РасчетыСПоставщиками_Авансы(МенеджерВременныхТаблиц, ПараметрыРасчета) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	УстановитьПараметрыЗапросаПодготовкиРасчетовАвансов(Запрос, ПараметрыРасчета);
	
	Запрос.Текст =
	"// Новая архитектура взаиморасчетов
	|ВЫБРАТЬ
	|	Расчеты.РасчетныйДокумент КАК РасчетныйДокумент,
	|	Расчеты.ДокументРегистратор КАК ДокументРегистратор,
	|	Расчеты.ОбъектРасчетов.Организация КАК Организация,
	|	Расчеты.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Расчеты.ОбъектРасчетов КАК ОбъектРасчетов,
	|	Расчеты.ОбъектРасчетов.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Расчеты.ОбъектРасчетов.Контрагент КАК Контрагент,
	|	Расчеты.ОбъектРасчетов.Договор КАК Договор,
	|	МИНИМУМ(ОтборАвансов.ДатаАванса) КАК ДатаАванса,
	|	МАКСИМУМ(ВЫБОР
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.РасходныйКассовыйОрдер
	|				ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.РасходныйКассовыйОрдер).Валюта
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.СписаниеБезналичныхДенежныхСредств
	|				ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.СписаниеБезналичныхДенежныхСредств).Валюта
	|			ИНАЧЕ Расчеты.Валюта
	|		КОНЕЦ) КАК ВалютаДокумента,
	|	СУММА(ВЫБОР
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.РасходныйКассовыйОрдер
	|					И ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.РасходныйКассовыйОрдер).Валюта
	|						= ОтборАвансов.ВалютаРегламентированногоУчета
	|					И Расчеты.ПредоплатаРегл > 0
	|				ТОГДА Расчеты.ПредоплатаРегл
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.СписаниеБезналичныхДенежныхСредств
	|					И ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.СписаниеБезналичныхДенежныхСредств).Валюта
	|						= ОтборАвансов.ВалютаРегламентированногоУчета
	|					И Расчеты.ПредоплатаРегл > 0
	|				ТОГДА Расчеты.ПредоплатаРегл
	|			ИНАЧЕ Расчеты.Предоплата
	|		КОНЕЦ
	|		* ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ) КАК СуммаАвансаВал,
	|	СУММА(Расчеты.Предоплата * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ) КАК СуммаАванса,
	|	СУММА(Расчеты.ПредоплатаУпр * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ) КАК СуммаАвансаУпр,
	|	СУММА(Расчеты.ПредоплатаРегл * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ) КАК СуммаАвансаРегл
	|ПОМЕСТИТЬ РасчетыСПоставщиками_Авансы
	|ИЗ
	|	(ВЫБРАТЬ
	|		Расчеты.РасчетныйДокумент,
	|		Расчеты.ДокументРегистратор,
	|		Расчеты.ОбъектРасчетов.Организация КАК Организация,
	|		Расчеты.ОбъектРасчетов.Организация.ВалютаРегламентированногоУчета КАК ВалютаРегламентированногоУчета,
	|		МИНИМУМ(Расчеты.ДатаВозникновения) КАК ДатаАванса
	|	ИЗ
	|		РегистрНакопления.РасчетыСПоставщикамиПоСрокам КАК Расчеты
	|	ГДЕ
	|		&НоваяАрхитектураВзаиморасчетов
	|		И НЕ &СоздатьПустуюТаблицу
	|		И Расчеты.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
	|		И (НЕ &ВключитьОтборПоОрганизациям
	|			ИЛИ Расчеты.ОбъектРасчетов.Организация В (&Организации))
	|		И (&ТекстОтборПоПараметрам)
	|		И Расчеты.ДатаВозникновения МЕЖДУ &ДатаНачала И &ДатаОкончания
	|		И Расчеты.Активность  = ИСТИНА
	|		
	|	СГРУППИРОВАТЬ ПО
	|		Расчеты.РасчетныйДокумент,
	|		Расчеты.ДокументРегистратор,
	|		Расчеты.ОбъектРасчетов.Организация,
	|		Расчеты.ОбъектРасчетов.Организация.ВалютаРегламентированногоУчета
	|	
	|	ИМЕЮЩИЕ
	|		СУММА(Расчеты.Предоплата * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ) > 0
	|	
	|	) КАК ОтборАвансов
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
	|		РегистрНакопления.РасчетыСПоставщикамиПоСрокам КАК Расчеты
	|	ПО
	|		ОтборАвансов.ДокументРегистратор    = Расчеты.ДокументРегистратор
	|		И  ОтборАвансов.РасчетныйДокумент   = Расчеты.РасчетныйДокумент
	|		И  ОтборАвансов.Организация         = Расчеты.ОбъектРасчетов.Организация
	|		И  Расчеты.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
	|		И  Расчеты.ДатаВозникновения МЕЖДУ &ДатаНачала И &ДатаОкончания
	|		И  Расчеты.Активность  = ИСТИНА
	|
	|ГДЕ
	|	ИСТИНА
	|	И (ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.СписаниеБезналичныхДенежныхСредств).ПроведеноБанком
	|			ИЛИ НЕ Расчеты.РасчетныйДокумент ССЫЛКА Документ.СписаниеБезналичныхДенежныхСредств)
	|	
	|СГРУППИРОВАТЬ ПО
	|	Расчеты.РасчетныйДокумент,
	|	Расчеты.ДокументРегистратор,
	|	Расчеты.ОбъектРасчетов.Организация,
	|	Расчеты.АналитикаУчетаПоПартнерам,
	|	Расчеты.ОбъектРасчетов
	|
	|ИМЕЮЩИЕ
	|	СУММА(Расчеты.Предоплата * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ) > 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|// Старая архитектура взаиморасчетов
	|ВЫБРАТЬ
	|	Расчеты.РасчетныйДокумент КАК РасчетныйДокумент,
	|	Расчеты.Регистратор КАК ДокументРегистратор,
	|	Расчеты.АналитикаУчетаПоПартнерам.Организация КАК Организация,
	|	Расчеты.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Расчеты.ЗаказПоставщику КАК ОбъектРасчетов,
	|	Расчеты.АналитикаУчетаПоПартнерам.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Расчеты.АналитикаУчетаПоПартнерам.Контрагент КАК Контрагент,
	|	Расчеты.АналитикаУчетаПоПартнерам.Договор КАК Договор,
	|	МИНИМУМ(Расчеты.Период) КАК ДатаАванса,
	|	МАКСИМУМ(ВЫБОР
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.РасходныйКассовыйОрдер
	|				ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.РасходныйКассовыйОрдер).Валюта
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.СписаниеБезналичныхДенежныхСредств
	|				ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.СписаниеБезналичныхДенежныхСредств).Валюта
	|			ИНАЧЕ Расчеты.Валюта
	|		КОНЕЦ) КАК ВалютаДокумента,
	|	СУММА(ВЫБОР
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.РасходныйКассовыйОрдер
	|					И ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.РасходныйКассовыйОрдер).Валюта
	|						= ОтборАвансов.ВалютаРегламентированногоУчета
	|					И Расчеты.ПредоплатаРегл > 0
	|				ТОГДА Расчеты.ПредоплатаРегл
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.СписаниеБезналичныхДенежныхСредств
	|					И ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.СписаниеБезналичныхДенежныхСредств).Валюта
	|						= ОтборАвансов.ВалютаРегламентированногоУчета
	|					И Расчеты.ПредоплатаРегл > 0
	|				ТОГДА Расчеты.ПредоплатаРегл
	|			ИНАЧЕ (Расчеты.Предоплата + Расчеты.КВозврату)
	|		КОНЕЦ
	|		* ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ) КАК СуммаАвансаВал,
	|	СУММА((Расчеты.Предоплата + Расчеты.КВозврату) * ВЫБОР 
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА -1
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА 1
	|		КОНЕЦ) КАК СуммаАванса,
	|	СУММА(Расчеты.ПредоплатаУпр * ВЫБОР 
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА -1
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА 1
	|		КОНЕЦ) КАК СуммаАвансаУпр,
	|	СУММА(Расчеты.ПредоплатаРегл * ВЫБОР 
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА -1
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА 1
	|		КОНЕЦ) КАК СуммаАвансаРегл
	|ИЗ
	|	(ВЫБРАТЬ
	|		Расчеты.РасчетныйДокумент КАК РасчетныйДокумент,
	|		Расчеты.Регистратор КАК ДокументРегистратор,
	|		Расчеты.АналитикаУчетаПоПартнерам.Организация КАК Организация,
	|		Расчеты.АналитикаУчетаПоПартнерам.Организация.ВалютаРегламентированногоУчета КАК ВалютаРегламентированногоУчета
	|	ИЗ
	|		РегистрНакопления.РасчетыСПоставщикамиПоДокументам КАК Расчеты
	|	ГДЕ
	|		НЕ &НоваяАрхитектураВзаиморасчетов
	|		И НЕ &СоздатьПустуюТаблицу
	|		И Расчеты.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
	|		И (НЕ &ВключитьОтборПоОрганизациям
	|			ИЛИ Расчеты.АналитикаУчетаПоПартнерам.Организация В (&Организации))
	|		И (&ТекстОтборПоПараметрам)
	|		И Расчеты.Активность = ИСТИНА
	|
	|	СГРУППИРОВАТЬ ПО
	|		Расчеты.АналитикаУчетаПоПартнерам.Организация,
	|		Расчеты.Регистратор,
	|		Расчеты.РасчетныйДокумент,
	|		Расчеты.АналитикаУчетаПоПартнерам.Организация.ВалютаРегламентированногоУчета
	|
	|	ИМЕЮЩИЕ
	|		СУММА((Расчеты.Предоплата + Расчеты.КВозврату) *
	|			ВЫБОР
	|				КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|					ТОГДА -1
	|				КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|					ТОГДА 1
	|			КОНЕЦ) > 0
	|
	|	) КАК ОтборАвансов
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
	|		РегистрНакопления.РасчетыСПоставщикамиПоДокументам КАК Расчеты
	|	ПО
	|		ОтборАвансов.ДокументРегистратор    = Расчеты.Регистратор
	|		И  ОтборАвансов.РасчетныйДокумент   = Расчеты.РасчетныйДокумент
	|		И  ОтборАвансов.Организация         = Расчеты.АналитикаУчетаПоПартнерам.Организация
	|		И  Расчеты.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
	|		И  Расчеты.Активность  = ИСТИНА
	|
	|ГДЕ
	|	ИСТИНА
	|	И (ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.СписаниеБезналичныхДенежныхСредств).ПроведеноБанком
	|			ИЛИ НЕ Расчеты.РасчетныйДокумент ССЫЛКА Документ.СписаниеБезналичныхДенежныхСредств)
	|	
	|СГРУППИРОВАТЬ ПО
	|	Расчеты.РасчетныйДокумент,
	|	Расчеты.Регистратор,
	|	Расчеты.АналитикаУчетаПоПартнерам.Организация,
	|	Расчеты.АналитикаУчетаПоПартнерам,
	|	Расчеты.ЗаказПоставщику,
	|	Расчеты.АналитикаУчетаПоПартнерам.НаправлениеДеятельности,
	|	Расчеты.АналитикаУчетаПоПартнерам.Контрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА((Расчеты.Предоплата + Расчеты.КВозврату) * ВЫБОР 
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА -1
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА 1
	|		КОНЕЦ) > 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|";
	
	УстановитьПоляИндексов(Запрос, ПараметрыРасчета, "РасчетыСПоставщиками_Авансы");
	
	ПараметрыПутей = ИнициализироватьПараметрыДляОтбораАвансов_ПутиКПолямИТекстуЗамены();
	ОбработатьТекстЗапросаДляОтбораАвансовПоПараметрам(Запрос, ПараметрыРасчета, ПараметрыПутей);
	
	Запрос.Выполнить();
	
	
КонецПроцедуры

// Подготовить временную таблицу "РасчетыСПоставщиками_ПогашенияАвансов"
// Создает временную таблицу с колонками:
// 	  РасчетныйДокумент;
// 	  Организация;
// 	  АналитикаУчетаПоПартнерам;
// 	  ОбъектРасчетов;
// 	  ДокументРегистратор;
// 	  Контрагент;
// 	  Договор;
// 	  НаправлениеДеятельности;
// 	  ИсхКонтрагент - контрагент, по которому возник аванс;
// 	  ИсхДоговор    - договор, по которому возник аванс;
// 	  ИсхНаправлениеДеятельности - направление, по которому возник аванс;
// 	  КорАналитикаУчетаПоПартнерам;
// 	  ИсходнаяАналитикаУчетаПоПартнерам - аналитика, по которой образовался аванс;
// 	  КорОбъектРасчетов;
// 	  ИсходныйОбъектРасчетов - объект расчетов, по которому образовался аванс;
// 	  ДатаАванса;
// 	  ДатаПогашения;
// 	  СобытиеЗнак - Если погашение произошло по причине зачета аванса, тогда СобытиеЗнак >= 0,
// 	                Если погашение произошло по причине возврата/списания задолженности, тогда СобытиеЗнак < 0;
// 	  ВидСобытия - событие, в связи с которым произошло погашение аванса. Возможные события:
// 	         - Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствОтПоставщика,
// 	         - Перечисление.ХозяйственныеОперации.ЗачетАвансаПоставщику;
// 	  ВалютаДокумента;
// 	  СуммаПогашения;
// 	  СуммаПогашенияВал - сумма в валюте документа;
// 	  СуммаПогашенияУпр;
// 	  СуммаПогашенияРегл.
//
// Параметры:
//  МенеджерВременныхТаблиц - МенеджерВременныхТаблиц - 
//  ПараметрыРасчета        - см. ИнициализироватьПараметрыПодготовкиРасчетовАвансов
Процедура ПодготовитьВТ_РасчетыСПоставщиками_ПогашенияАвансов(МенеджерВременныхТаблиц, ПараметрыРасчета) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	УстановитьПараметрыЗапросаПодготовкиРасчетовАвансов(Запрос, ПараметрыРасчета);
	
	Запрос.Текст =
	"// Новая архитектура взаиморасчетов
	|ВЫБРАТЬ
	|	Расчеты.РасчетныйДокумент КАК РасчетныйДокумент,
	|	Расчеты.ДокументРегистратор КАК ДокументРегистратор,
	|	Расчеты.ОбъектРасчетов.Организация КАК Организация,
	|	Расчеты.ОбъектРасчетов.Организация.ВалютаРегламентированногоУчета КАК ВалютаРегламентированногоУчета,
	|	МИНИМУМ(Расчеты.ДатаВозникновения) КАК ДатаАванса,
	|	МАКСИМУМ(Расчеты.Период) КАК ДатаПогашения,
	|		СУММА(ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА 0
	|			КОГДА Расчеты.ХозяйственнаяОперация В
	|					(ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаПоставщику),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносАванса))
	|				ТОГДА Расчеты.Предоплата
	|			ИНАЧЕ
	|				-Расчеты.Предоплата
	|		КОНЕЦ) КАК СобытиеЗнак,
	|	СУММА(Расчеты.Предоплата * ВЫБОР
	|		КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА -1
	|		ИНАЧЕ 1
	|	КОНЕЦ) КАК СуммаПогашения,
	|	НЕ ВзаимозачетЗадолженности.Ссылка ЕСТЬ NULL КАК ПереносАванса
	|
	|ПОМЕСТИТЬ ОтборПогашенийАвансов
	|
	|ИЗ
	|	РегистрНакопления.РасчетыСПоставщикамиПоСрокам КАК Расчеты
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВзаимозачетЗадолженности КАК ВзаимозачетЗадолженности
	|		ПО Расчеты.ДокументРегистратор = ВзаимозачетЗадолженности.Ссылка
	|			И (ВзаимозачетЗадолженности.ВидОперации В (ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаОрганизацияКонтрагент), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаМеждуКонтрагентами), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуОрганизацияКонтрагент), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуМеждуКонтрагентами), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаМеждуДвумяОрганизациями), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуМеждуДвумяОрганизациями)))
	|ГДЕ
	|	&НоваяАрхитектураВзаиморасчетов
	|	И НЕ &СоздатьПустуюТаблицу
	|	И (НЕ &ВключитьОтборПоОрганизациям
	|			ИЛИ Расчеты.ОбъектРасчетов.Организация В (&Организации))
	|	И &ТекстОтборПоПараметрам
	|	И Расчеты.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
	|	И Расчеты.Активность = ИСТИНА
	|
	|СГРУППИРОВАТЬ ПО
	|	Расчеты.РасчетныйДокумент,
	|	Расчеты.ДокументРегистратор,
	|	Расчеты.ОбъектРасчетов.Организация,
	|	Расчеты.ОбъектРасчетов.Организация.ВалютаРегламентированногоУчета,
	|	НЕ ВзаимозачетЗадолженности.Ссылка ЕСТЬ NULL
	|
	|ИМЕЮЩИЕ
	|	СУММА(Расчеты.Предоплата * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ) > 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|//Старая архитектура взаиморасчетов
	|ВЫБРАТЬ
	|	Расчеты.РасчетныйДокумент КАК РасчетныйДокумент,
	|	Расчеты.Регистратор КАК ДокументРегистратор,
	|	Расчеты.АналитикаУчетаПоПартнерам.Организация КАК Организация,
	|	Расчеты.АналитикаУчетаПоПартнерам.Организация.ВалютаРегламентированногоУчета КАК ВалютаРегламентированногоУчета,
	|	NULL КАК ДатаАванса,
	|	Расчеты.Период КАК ДатаПогашения,
	|	СУММА(ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА 0
	|			КОГДА Расчеты.ХозяйственнаяОперация В (
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаПоставщику),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносАванса)
	|					)
	|				ТОГДА Расчеты.ПредоплатаРегл
	|			ИНАЧЕ
	|				-Расчеты.ПредоплатаРегл
	|		КОНЕЦ) КАК СобытиеЗнак,
	|	СУММА(Расчеты.ПредоплатаРегл * ВЫБОР
	|		КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА -1
	|		ИНАЧЕ 1
	|		КОНЕЦ) КАК СуммаПогашения,
	|	ЛОЖЬ КАК ПереносАванса
	|ИЗ
	|	РегистрНакопления.РасчетыСПоставщикамиПоДокументам КАК Расчеты
	|ГДЕ
	|	НЕ &НоваяАрхитектураВзаиморасчетов
	|	И НЕ &СоздатьПустуюТаблицу
	|	И (НЕ &ВключитьОтборПоОрганизациям
	|			ИЛИ Расчеты.АналитикаУчетаПоПартнерам.Организация В (&Организации))
	|	И &ТекстОтборПоПараметрам
	|	И Расчеты.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
	|	И Расчеты.Активность = ИСТИНА
	|
	|СГРУППИРОВАТЬ ПО
	|	Расчеты.РасчетныйДокумент,
	|	Расчеты.Регистратор,
	|	Расчеты.АналитикаУчетаПоПартнерам.Организация,
	|	Расчеты.АналитикаУчетаПоПартнерам.Организация.ВалютаРегламентированногоУчета,
	|	Расчеты.Период
	|
	|ИМЕЮЩИЕ
	|	СУММА(Расчеты.ПредоплатаРегл * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ) > 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент,
	|	ДокументРегистратор,
	|	Организация,
	|	ВалютаРегламентированногоУчета
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Расчеты_Приход.РасчетныйДокумент КАК РасчетныйДокумент,
	|	Расчеты.ОбъектРасчетов.Организация КАК Организация,
	|	Расчеты.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Расчеты.ОбъектРасчетов КАК ОбъектРасчетов,
	|	Расчеты.ДокументРегистратор КАК ДокументРегистратор,
	|	Расчеты.ОбъектРасчетов.Контрагент КАК Контрагент,
	|	Расчеты.ОбъектРасчетов.Договор КАК Договор,
	|	Расчеты.ОбъектРасчетов.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА НЕ Расчеты.КорОбъектРасчетов = &ПустойОбъектРасчетов
	|		И НЕ ЕСТЬNULL(Расчеты.КорОбъектРасчетов.Объект = НЕОПРЕДЕЛЕНО, ИСТИНА)
	|			ТОГДА Расчеты.КорОбъектРасчетов.Контрагент
	|		ИНАЧЕ Расчеты.ОбъектРасчетов.Контрагент
	|	КОНЕЦ КАК ИсхКонтрагент,
	|	ВЫБОР
	|		КОГДА НЕ Расчеты.КорОбъектРасчетов = &ПустойОбъектРасчетов
	|		И НЕ ЕСТЬNULL(Расчеты.КорОбъектРасчетов.Объект = НЕОПРЕДЕЛЕНО, ИСТИНА)
	|			ТОГДА Расчеты.КорОбъектРасчетов.Договор
	|		ИНАЧЕ Расчеты.ОбъектРасчетов.Договор
	|	КОНЕЦ КАК ИсхДоговор,
	|	ВЫБОР
	|		КОГДА НЕ Расчеты.КорОбъектРасчетов = &ПустойОбъектРасчетов
	|		И НЕ ЕСТЬNULL(Расчеты.КорОбъектРасчетов.Объект = НЕОПРЕДЕЛЕНО, ИСТИНА)
	|			ТОГДА Расчеты.КорОбъектРасчетов.НаправлениеДеятельности
	|		ИНАЧЕ Расчеты.ОбъектРасчетов.НаправлениеДеятельности
	|	КОНЕЦ КАК ИсхНаправлениеДеятельности,
	|	Расчеты.КорАналитикаУчетаПоПартнерам КАК КорАналитикаУчетаПоПартнерам,
	|	ВЫБОР
	|		КОГДА Расчеты.КорАналитикаУчетаПоПартнерам <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка)
	|			ТОГДА Расчеты.КорАналитикаУчетаПоПартнерам
	|		ИНАЧЕ Расчеты.АналитикаУчетаПоПартнерам
	|	КОНЕЦ КАК ИсхАналитикаУчетаПоПартнерам,
	|	Расчеты.КорОбъектРасчетов КАК КорОбъектРасчетов,
	|	ВЫБОР
	|		КОГДА НЕ Расчеты.КорОбъектРасчетов = &ПустойОбъектРасчетов
	|		И НЕ ЕСТЬNULL(Расчеты.КорОбъектРасчетов.Объект = НЕОПРЕДЕЛЕНО, ИСТИНА)
	|			ТОГДА Расчеты.КорОбъектРасчетов
	|		ИНАЧЕ Расчеты.ОбъектРасчетов
	|	КОНЕЦ КАК ИсходныйОбъектРасчетов,
	|	ОтборПогашенийАвансов.ДатаАванса КАК ДатаАванса,
	|	ОтборПогашенийАвансов.ДатаПогашения КАК ДатаПогашения,
	|	ОтборПогашенийАвансов.СобытиеЗнак КАК СобытиеЗнак,
	|	ВЫБОР
	|		КОГДА
	|			Расчеты.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствОтПоставщика)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствОтПоставщика)
	|		КОГДА Расчеты.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаПоставщику)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаПоставщику)
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ВидСобытия,
	|	ВЫБОР
	|		КОГДА Расчеты_Приход.РасчетныйДокумент ССЫЛКА Документ.РасходныйКассовыйОрдер
	|			ТОГДА ВЫРАЗИТЬ(Расчеты_Приход.РасчетныйДокумент КАК Документ.РасходныйКассовыйОрдер).Валюта
	|		КОГДА Расчеты_Приход.РасчетныйДокумент ССЫЛКА Документ.СписаниеБезналичныхДенежныхСредств
	|			ТОГДА ВЫРАЗИТЬ(Расчеты_Приход.РасчетныйДокумент КАК Документ.СписаниеБезналичныхДенежныхСредств).Валюта
	|		ИНАЧЕ Расчеты.Валюта
	|	КОНЕЦ КАК ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА Расчеты_Приход.РасчетныйДокумент ССЫЛКА Документ.РасходныйКассовыйОрдер
	|		И ВЫРАЗИТЬ(Расчеты_Приход.РасчетныйДокумент КАК
	|			Документ.РасходныйКассовыйОрдер).Валюта = ОтборПогашенийАвансов.ВалютаРегламентированногоУчета
	|		И Расчеты.ДолгРегл > 0
	|			ТОГДА Расчеты.ДолгРегл
	|		КОГДА Расчеты_Приход.РасчетныйДокумент ССЫЛКА Документ.СписаниеБезналичныхДенежныхСредств
	|		И ВЫРАЗИТЬ(Расчеты_Приход.РасчетныйДокумент КАК
	|			Документ.СписаниеБезналичныхДенежныхСредств).Валюта = ОтборПогашенийАвансов.ВалютаРегламентированногоУчета
	|		И Расчеты.ДолгРегл > 0
	|			ТОГДА Расчеты.ДолгРегл
	|		ИНАЧЕ Расчеты.Долг
	|	КОНЕЦ КАК СуммаПогашенияВал,
	|	Расчеты.Долг КАК СуммаПогашения,
	|	Расчеты.ДолгУпр КАК СуммаПогашенияУпр,
	|	Расчеты.ДолгРегл КАК СуммаПогашенияРегл
	|ПОМЕСТИТЬ РасчетыСПоставщиками_ПогашенияСНеявнымЗачетом
	|ИЗ
	|	ОтборПогашенийАвансов КАК ОтборПогашенийАвансов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСПоставщикамиПоСрокам КАК Расчеты
	|		ПО ОтборПогашенийАвансов.ДокументРегистратор = Расчеты.ДокументРегистратор
	|		И ОтборПогашенийАвансов.Организация = Расчеты.ОбъектРасчетов.Организация
	|		И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Расчеты.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
	|		И Расчеты.Активность = ИСТИНА
	|		И Расчеты.НастройкаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПереносАванса)
	|		И НЕ Расчеты.Сторно
	|		И Расчеты.Долг > 0
	|		И ОтборПогашенийАвансов.ПереносАванса
	|		И &НоваяАрхитектураВзаиморасчетов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСПоставщикамиПоСрокам КАК Расчеты_Приход
	|		ПО Расчеты_Приход.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		И ОтборПогашенийАвансов.РасчетныйДокумент = Расчеты_Приход.РасчетныйДокумент
	|		И Расчеты.ОбъектРасчетов = Расчеты_Приход.ОбъектРасчетов
	|		И Расчеты.АналитикаУчетаПоПартнерам = Расчеты_Приход.АналитикаУчетаПоПартнерам
	|		И Расчеты.ДокументРегистратор = Расчеты_Приход.ДокументРегистратор
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаПоПартнерам,
	|	РасчетныйДокумент,
	|	ВалютаДокумента
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|// Новая архитектура взаиморасчетов
	|ВЫБРАТЬ
	|	ВложенныйЗапрос.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ВложенныйЗапрос.Организация КАК Организация,
	|	ВложенныйЗапрос.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	ВложенныйЗапрос.ОбъектРасчетов КАК ОбъектРасчетов,
	|	ВложенныйЗапрос.ДокументРегистратор КАК ДокументРегистратор,
	|	ВложенныйЗапрос.Контрагент КАК Контрагент,
	|	ВложенныйЗапрос.Договор КАК Договор,
	|	ВложенныйЗапрос.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	МАКСИМУМ(ВложенныйЗапрос.ИсхКонтрагент) КАК ИсхКонтрагент,
	|	МАКСИМУМ(ВложенныйЗапрос.ИсхДоговор) КАК ИсхДоговор,
	|	МАКСИМУМ(ВложенныйЗапрос.ИсхНаправлениеДеятельности) КАК ИсхНаправлениеДеятельности,
	|	МАКСИМУМ(ВложенныйЗапрос.КорАналитикаУчетаПоПартнерам) КАК КорАналитикаУчетаПоПартнерам,
	|	МАКСИМУМ(ВложенныйЗапрос.ИсходнаяАналитикаУчетаПоПартнерам) КАК ИсходнаяАналитикаУчетаПоПартнерам,
	|	МАКСИМУМ(ВложенныйЗапрос.КорОбъектРасчетов) КАК КорОбъектРасчетов,
	|	МАКСИМУМ(ВложенныйЗапрос.ИсходныйОбъектРасчетов) КАК ИсходныйОбъектРасчетов,
	|	МИНИМУМ(ВложенныйЗапрос.ДатаАванса) КАК ДатаАванса,
	|	МАКСИМУМ(ВложенныйЗапрос.ДатаПогашения) КАК ДатаПогашения,
	|	МАКСИМУМ(ВложенныйЗапрос.СобытиеЗнак) КАК СобытиеЗнак,
	|	МАКСИМУМ(ВложенныйЗапрос.ВидСобытия) КАК ВидСобытия,
	|	МАКСИМУМ(ВложенныйЗапрос.ВалютаДокумента) КАК ВалютаДокумента,
	|	СУММА(ВложенныйЗапрос.СуммаПогашенияВал) КАК СуммаПогашенияВал,
	|	СУММА(ВложенныйЗапрос.СуммаПогашения) КАК СуммаПогашения,
	|	СУММА(ВложенныйЗапрос.СуммаПогашенияУпр) КАК СуммаПогашенияУпр,
	|	СУММА(ВложенныйЗапрос.СуммаПогашенияРегл) КАК СуммаПогашенияРегл
	|ПОМЕСТИТЬ РасчетыСПоставщиками_ПогашенияАвансов_Предварительная
	|ИЗ
	|	(ВЫБРАТЬ
	|		ВложенныйЗапрос.РасчетныйДокумент КАК РасчетныйДокумент,
	|		ВложенныйЗапрос.ОбъектРасчетов.Организация КАК Организация,
	|		ВложенныйЗапрос.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|		ВложенныйЗапрос.ОбъектРасчетов КАК ОбъектРасчетов,
	|		ВложенныйЗапрос.ДокументРегистратор КАК ДокументРегистратор,
	|		ВложенныйЗапрос.ОбъектРасчетов.Контрагент КАК Контрагент,
	|		ВложенныйЗапрос.ОбъектРасчетов.Договор КАК Договор,
	|		ВложенныйЗапрос.ОбъектРасчетов.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|		МАКСИМУМ(ВЫБОР
	|			КОГДА НЕ ВложенныйЗапрос.КорОбъектРасчетов = &ПустойОбъектРасчетов
	|					И НЕ ЕСТЬNULL(ВложенныйЗапрос.КорОбъектРасчетов.Объект = НЕОПРЕДЕЛЕНО, ИСТИНА)
	|				ТОГДА ВложенныйЗапрос.КорОбъектРасчетов.Контрагент
	|			ИНАЧЕ ВложенныйЗапрос.ОбъектРасчетов.Контрагент
	|		КОНЕЦ) КАК ИсхКонтрагент,
	|		МАКСИМУМ(ВЫБОР
	|			КОГДА НЕ ВложенныйЗапрос.КорОбъектРасчетов = &ПустойОбъектРасчетов
	|					И НЕ ЕСТЬNULL(ВложенныйЗапрос.КорОбъектРасчетов.Объект = НЕОПРЕДЕЛЕНО, ИСТИНА)
	|				ТОГДА ВложенныйЗапрос.КорОбъектРасчетов.Договор
	|			ИНАЧЕ ВложенныйЗапрос.ОбъектРасчетов.Договор
	|		КОНЕЦ) КАК ИсхДоговор,
	|		МАКСИМУМ(ВЫБОР
	|			КОГДА НЕ ВложенныйЗапрос.КорОбъектРасчетов = &ПустойОбъектРасчетов
	|					И НЕ ЕСТЬNULL(ВложенныйЗапрос.КорОбъектРасчетов.Объект = НЕОПРЕДЕЛЕНО, ИСТИНА)
	|				ТОГДА ВложенныйЗапрос.КорОбъектРасчетов.НаправлениеДеятельности
	|			ИНАЧЕ ВложенныйЗапрос.ОбъектРасчетов.НаправлениеДеятельности
	|		КОНЕЦ) КАК ИсхНаправлениеДеятельности,
	|		МАКСИМУМ(ВложенныйЗапрос.КорАналитикаУчетаПоПартнерам) КАК КорАналитикаУчетаПоПартнерам,
	|		ВЫБОР
	|			КОГДА ВложенныйЗапрос.КорАналитикаУчетаПоПартнерам <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка)
	|				ТОГДА ВложенныйЗапрос.КорАналитикаУчетаПоПартнерам
	|			ИНАЧЕ ВложенныйЗапрос.АналитикаУчетаПоПартнерам
	|		КОНЕЦ КАК ИсходнаяАналитикаУчетаПоПартнерам,
	|		МАКСИМУМ(ВложенныйЗапрос.КорОбъектРасчетов) КАК КорОбъектРасчетов,
	|		МАКСИМУМ(ВЫБОР
	|			КОГДА НЕ ВложенныйЗапрос.КорОбъектРасчетов = &ПустойОбъектРасчетов
	|					И НЕ ЕСТЬNULL(ВложенныйЗапрос.КорОбъектРасчетов.Объект = НЕОПРЕДЕЛЕНО, ИСТИНА)
	|				ТОГДА ВложенныйЗапрос.КорОбъектРасчетов
	|			ИНАЧЕ ВложенныйЗапрос.ОбъектРасчетов
	|		КОНЕЦ) КАК ИсходныйОбъектРасчетов,
	|		МИНИМУМ(ВложенныйЗапрос.ДатаАванса) КАК ДатаАванса,
	|		МАКСИМУМ(ВложенныйЗапрос.ДатаПогашения) КАК ДатаПогашения,
	|		МАКСИМУМ(ВложенныйЗапрос.СобытиеЗнак) КАК СобытиеЗнак,
	|		МАКСИМУМ(ВложенныйЗапрос.ВидСобытия) КАК ВидСобытия,
	|		МАКСИМУМ(ВложенныйЗапрос.ВалютаДокумента) КАК ВалютаДокумента,
	|		СУММА(ВложенныйЗапрос.СуммаПогашенияВал) КАК СуммаПогашенияВал,
	|		СУММА(ВложенныйЗапрос.СуммаПогашения) КАК СуммаПогашения,
	|		СУММА(ВложенныйЗапрос.СуммаПогашенияУпр) КАК СуммаПогашенияУпр,
	|		СУММА(ВложенныйЗапрос.СуммаПогашенияРегл) КАК СуммаПогашенияРегл
	|	ИЗ
	|		(ВЫБРАТЬ
	|			Расчеты.РасчетныйДокумент КАК РасчетныйДокумент,
	|			ВЫБОР
	|				КОГДА ОтборПогашенийАвансов.ПереносАванса
	|						И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|					ТОГДА Расчеты.КорАналитикаУчетаПоПартнерам
	|				ИНАЧЕ Расчеты.АналитикаУчетаПоПартнерам
	|			КОНЕЦ КАК АналитикаУчетаПоПартнерам,
	|			ВЫБОР
	|				КОГДА ОтборПогашенийАвансов.ПереносАванса
	|					И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА Расчеты.КорОбъектРасчетов
	|			ИНАЧЕ Расчеты.ОбъектРасчетов
	|			КОНЕЦ КАК ОбъектРасчетов,
	|			Расчеты.ДокументРегистратор КАК ДокументРегистратор,
	|			МАКСИМУМ(ВЫБОР
	|				КОГДА ОтборПогашенийАвансов.ПереносАванса
	|						И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|					ТОГДА НЕОПРЕДЕЛЕНО
	|				ИНАЧЕ Расчеты.КорОбъектРасчетов
	|			КОНЕЦ) КАК КорОбъектРасчетов,
	|			МАКСИМУМ(ВЫБОР
	|				КОГДА ОтборПогашенийАвансов.ПереносАванса
	|						И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|					ТОГДА НЕОПРЕДЕЛЕНО
	|				ИНАЧЕ Расчеты.КорАналитикаУчетаПоПартнерам
	|			КОНЕЦ) КАК КорАналитикаУчетаПоПартнерам,
	|			МИНИМУМ(ОтборПогашенийАвансов.ДатаАванса) КАК ДатаАванса,
	|			МАКСИМУМ(ОтборПогашенийАвансов.ДатаПогашения) КАК ДатаПогашения,
	|			МАКСИМУМ(ОтборПогашенийАвансов.СобытиеЗнак) КАК СобытиеЗнак,
	|			МАКСИМУМ(
	|			ВЫБОР
	|				КОГДА Расчеты.ХозяйственнаяОперация
	|						= ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствОтПоставщика)
	|					ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствОтПоставщика)
	|				КОГДА Расчеты.ХозяйственнаяОперация
	|						= ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаПоставщику)
	|					ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаПоставщику)
	|				ИНАЧЕ
	|					НЕОПРЕДЕЛЕНО
	|			КОНЕЦ) КАК ВидСобытия,
	|			МАКСИМУМ(ВЫБОР
	|				КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.РасходныйКассовыйОрдер
	|					ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.РасходныйКассовыйОрдер).Валюта
	|				КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.СписаниеБезналичныхДенежныхСредств
	|					ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.СписаниеБезналичныхДенежныхСредств).Валюта
	|				ИНАЧЕ Расчеты.Валюта
	|				КОНЕЦ) КАК ВалютаДокумента,
	|			СУММА(ВЫБОР
	|				КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.РасходныйКассовыйОрдер
	|							И ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.РасходныйКассовыйОрдер).Валюта
	|							= ОтборПогашенийАвансов.ВалютаРегламентированногоУчета
	|						И Расчеты.ПредоплатаРегл > 0
	|					ТОГДА Расчеты.ПредоплатаРегл
	|				КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.СписаниеБезналичныхДенежныхСредств
	|						И ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.СписаниеБезналичныхДенежныхСредств).Валюта
	|							= ОтборПогашенийАвансов.ВалютаРегламентированногоУчета
	|						И Расчеты.ПредоплатаРегл > 0
	|					ТОГДА Расчеты.ПредоплатаРегл
	|				ИНАЧЕ Расчеты.Предоплата
	|				КОНЕЦ
	|				* ВЫБОР
	|				КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|					ТОГДА -1
	|				ИНАЧЕ 1
	|				КОНЕЦ) КАК СуммаПогашенияВал,
	|			СУММА(Расчеты.Предоплата * ВЫБОР
	|				КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|					ТОГДА -1
	|				ИНАЧЕ 1
	|				КОНЕЦ) КАК СуммаПогашения,
	|			СУММА(Расчеты.ПредоплатаУпр * ВЫБОР
	|				КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|					ТОГДА -1
	|				ИНАЧЕ 1
	|				КОНЕЦ) КАК СуммаПогашенияУпр,
	|			СУММА(Расчеты.ПредоплатаРегл * ВЫБОР
	|				КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|					ТОГДА -1
	|				ИНАЧЕ 1
	|				КОНЕЦ) КАК СуммаПогашенияРегл
	|		ИЗ
	|			ОтборПогашенийАвансов КАК ОтборПогашенийАвансов
	|				ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСПоставщикамиПоСрокам КАК Расчеты
	|				ПО ОтборПогашенийАвансов.ДокументРегистратор = Расчеты.ДокументРегистратор
	|					И ОтборПогашенийАвансов.РасчетныйДокумент = Расчеты.РасчетныйДокумент
	|					И ОтборПогашенийАвансов.Организация = Расчеты.ОбъектРасчетов.Организация
	|					И (Расчеты.Период МЕЖДУ &ДатаНачала И &ДатаОкончания)
	|					И (Расчеты.Активность = ИСТИНА)
	|					И &НоваяАрхитектураВзаиморасчетов

	|		ГДЕ
	|			ВЫБОР
	|				КОГДА НЕ ОтборПогашенийАвансов.ПереносАванса
	|					ТОГДА ИСТИНА
	|				ИНАЧЕ НЕ (Расчеты.АналитикаУчетаПоПартнерам, Расчеты.РасчетныйДокумент, Расчеты.Валюта) В
	|						(ВЫБРАТЬ
	|							РасчетыСПоставщиками.АналитикаУчетаПоПартнерам,
	|							РасчетыСПоставщиками.РасчетныйДокумент,
	|							РасчетыСПоставщиками.ВалютаДокумента
	|						ИЗ
	|							РасчетыСПоставщиками_ПогашенияСНеявнымЗачетом КАК РасчетыСПоставщиками
	|						
	|						ОБЪЕДИНИТЬ ВСЕ
	|
	|						ВЫБРАТЬ
	|							РасчетыСПоставщиками.КорАналитикаУчетаПоПартнерам,
	|							РасчетыСПоставщиками.РасчетныйДокумент,
	|							РасчетыСПоставщиками.ВалютаДокумента
	|						ИЗ
	|							РасчетыСПоставщиками_ПогашенияСНеявнымЗачетом КАК РасчетыСПоставщиками)
	|			КОНЕЦ
	|	
	|		СГРУППИРОВАТЬ ПО
	|			Расчеты.РасчетныйДокумент,
	|			Расчеты.ДокументРегистратор,
	|			ВЫБОР
	|				КОГДА ОтборПогашенийАвансов.ПереносАванса
	|					И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|					ТОГДА Расчеты.КорАналитикаУчетаПоПартнерам
	|				ИНАЧЕ Расчеты.АналитикаУчетаПоПартнерам
	|			КОНЕЦ,
	|			ВЫБОР
	|				КОГДА ОтборПогашенийАвансов.ПереносАванса
	|					И Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА Расчеты.КорОбъектРасчетов
	|				ИНАЧЕ Расчеты.ОбъектРасчетов
	|			КОНЕЦ) КАК ВложенныйЗапрос
	|
	|	СГРУППИРОВАТЬ ПО
	|		ВложенныйЗапрос.РасчетныйДокумент,
	|		ВложенныйЗапрос.ОбъектРасчетов.Организация,
	|		ВложенныйЗапрос.АналитикаУчетаПоПартнерам,
	|		ВложенныйЗапрос.ОбъектРасчетов,
	|		ВложенныйЗапрос.ДокументРегистратор,
	|		ВложенныйЗапрос.ОбъектРасчетов.Контрагент,
	|		ВложенныйЗапрос.ОбъектРасчетов.Договор,
	|		ВложенныйЗапрос.ОбъектРасчетов.НаправлениеДеятельности,
	|		ВЫБОР
	|			КОГДА ВложенныйЗапрос.КорАналитикаУчетаПоПартнерам <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка)
	|				ТОГДА ВложенныйЗапрос.КорАналитикаУчетаПоПартнерам
	|			ИНАЧЕ ВложенныйЗапрос.АналитикаУчетаПоПартнерам
	|		КОНЕЦ
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Расчеты.РасчетныйДокумент,
	|		Расчеты.Организация,
	|		Расчеты.АналитикаУчетаПоПартнерам,
	|		Расчеты.ОбъектРасчетов,
	|		Расчеты.ДокументРегистратор,
	|		Расчеты.Контрагент,
	|		Расчеты.Договор,
	|		Расчеты.НаправлениеДеятельности,
	|		Расчеты.ИсхКонтрагент,
	|		Расчеты.ИсхДоговор,
	|		Расчеты.ИсхНаправлениеДеятельности,
	|		Расчеты.КорАналитикаУчетаПоПартнерам,
	|		Расчеты.ИсхАналитикаУчетаПоПартнерам,
	|		Расчеты.КорОбъектРасчетов,
	|		Расчеты.ИсходныйОбъектРасчетов,
	|		Расчеты.ДатаАванса,
	|		Расчеты.ДатаПогашения,
	|		Расчеты.СобытиеЗнак,
	|		Расчеты.ВидСобытия,
	|		Расчеты.ВалютаДокумента,
	|		Расчеты.СуммаПогашенияВал,
	|		Расчеты.СуммаПогашения,
	|		Расчеты.СуммаПогашенияУпр,
	|		Расчеты.СуммаПогашенияРегл
	|	ИЗ
	|		РасчетыСПоставщиками_ПогашенияСНеявнымЗачетом КАК Расчеты) КАК ВложенныйЗапрос
	|ГДЕ
	|	ВложенныйЗапрос.СуммаПогашения > 0
	|
	|СГРУППИРОВАТЬ ПО
	|	ВложенныйЗапрос.РасчетныйДокумент,
	|	ВложенныйЗапрос.Организация,
	|	ВложенныйЗапрос.АналитикаУчетаПоПартнерам,
	|	ВложенныйЗапрос.ОбъектРасчетов,
	|	ВложенныйЗапрос.ДокументРегистратор,
	|	ВложенныйЗапрос.Контрагент,
	|	ВложенныйЗапрос.Договор,
	|	ВложенныйЗапрос.НаправлениеДеятельности
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|// Старая архитектура взаиморасчетов
	|ВЫБРАТЬ
	|	Расчеты.РасчетныйДокумент,
	|	Расчеты.АналитикаУчетаПоПартнерам.Организация,
	|	Расчеты.АналитикаУчетаПоПартнерам,
	|	Расчеты.ЗаказПоставщику,
	|	Расчеты.Регистратор,
	|	Расчеты.АналитикаУчетаПоПартнерам.Контрагент,
	|	Расчеты.АналитикаУчетаПоПартнерам.Договор,
	|	Расчеты.АналитикаУчетаПоПартнерам.НаправлениеДеятельности,
	|	Расчеты.АналитикаУчетаПоПартнерам.Контрагент,
	|	Расчеты.АналитикаУчетаПоПартнерам.Договор,
	|	Расчеты.АналитикаУчетаПоПартнерам.НаправлениеДеятельности,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка),
	|	Расчеты.АналитикаУчетаПоПартнерам,
	|	&ПустойОбъектРасчетов,
	|	Расчеты.ЗаказПоставщику,
	|	МИНИМУМ(Расчеты.ДатаПлатежа) КАК ДатаАванса,
	|	МАКСИМУМ(ОтборПогашенийАвансов.ДатаПогашения),
	|	МАКСИМУМ(ОтборПогашенийАвансов.СобытиеЗнак),
	|	МАКСИМУМ(
	|		ВЫБОР
	|			КОГДА ОтборПогашенийАвансов.СобытиеЗнак < 0
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствОтПоставщика)
	|			ИНАЧЕ
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаПоставщику)
	|		КОНЕЦ) КАК ВидСобытия,
	|	МАКСИМУМ(ВЫБОР
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.РасходныйКассовыйОрдер
	|				ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.РасходныйКассовыйОрдер).Валюта
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.СписаниеБезналичныхДенежныхСредств
	|				ТОГДА ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.СписаниеБезналичныхДенежныхСредств).Валюта
	|			ИНАЧЕ Расчеты.Валюта
	|		КОНЕЦ) КАК ВалютаДокумента,
	|	СУММА(ВЫБОР
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.РасходныйКассовыйОрдер
	|					И ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.РасходныйКассовыйОрдер).Валюта
	|						= ОтборПогашенийАвансов.ВалютаРегламентированногоУчета
	|					И Расчеты.ПредоплатаРегл > 0
	|				ТОГДА Расчеты.ПредоплатаРегл
	|			КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.СписаниеБезналичныхДенежныхСредств
	|					И ВЫРАЗИТЬ(Расчеты.РасчетныйДокумент КАК Документ.СписаниеБезналичныхДенежныхСредств).Валюта
	|						= ОтборПогашенийАвансов.ВалютаРегламентированногоУчета
	|					И Расчеты.ПредоплатаРегл > 0
	|				ТОГДА Расчеты.ПредоплатаРегл
	|			ИНАЧЕ Расчеты.Предоплата
	|		КОНЕЦ
	|		* ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ) КАК СуммаПогашенияВал,
	|	СУММА(Расчеты.Предоплата * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ),
	|	СУММА(Расчеты.ПредоплатаУпр * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ),
	|	СУММА(Расчеты.ПредоплатаРегл * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ)
	|ИЗ
	|	ОтборПогашенийАвансов КАК ОтборПогашенийАвансов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСПоставщикамиПоДокументам КАК Расчеты
	|		ПО ОтборПогашенийАвансов.ДокументРегистратор = Расчеты.Регистратор
	|			И ОтборПогашенийАвансов.РасчетныйДокумент = Расчеты.РасчетныйДокумент
	|			И ОтборПогашенийАвансов.Организация = Расчеты.АналитикаУчетаПоПартнерам.Организация
	|			И (Расчеты.Период МЕЖДУ &ДатаНачала И &ДатаОкончания)
	|			И (Расчеты.Активность = ИСТИНА)
	|			И НЕ &НоваяАрхитектураВзаиморасчетов
	|
	|СГРУППИРОВАТЬ ПО
	|	Расчеты.РасчетныйДокумент,
	|	Расчеты.АналитикаУчетаПоПартнерам.Организация,
	|	Расчеты.АналитикаУчетаПоПартнерам,
	|	Расчеты.ЗаказПоставщику,
	|	Расчеты.Регистратор,
	|	Расчеты.АналитикаУчетаПоПартнерам.Контрагент,
	|	Расчеты.АналитикаУчетаПоПартнерам.Договор,
	|	Расчеты.АналитикаУчетаПоПартнерам.НаправлениеДеятельности,
	|	Расчеты.АналитикаУчетаПоПартнерам.Контрагент,
	|	Расчеты.АналитикаУчетаПоПартнерам.Договор,
	|	Расчеты.АналитикаУчетаПоПартнерам.НаправлениеДеятельности,
	|	Расчеты.АналитикаУчетаПоПартнерам,
	|	Расчеты.ЗаказПоставщику
	|
	|ИМЕЮЩИЕ
	|	СУММА(Расчеты.Предоплата * ВЫБОР
	|			КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ) > 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент,
	|	Организация,
	|	ДокументРегистратор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Погашения.РасчетныйДокумент КАК РасчетныйДокумент,
	|	Погашения.Организация КАК Организация,
	|	Погашения.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Погашения.ОбъектРасчетов КАК ОбъектРасчетов,
	|	Погашения.ДокументРегистратор КАК ДокументРегистратор,
	|	Погашения.Контрагент КАК Контрагент,
	|	Погашения.Договор КАК Договор,
	|	Погашения.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Погашения.ИсхКонтрагент КАК ИсхКонтрагент,
	|	Погашения.ИсхДоговор КАК ИсхДоговор,
	|	Погашения.ИсхНаправлениеДеятельности КАК ИсхНаправлениеДеятельности,
	|	Погашения.КорАналитикаУчетаПоПартнерам КАК КорАналитикаУчетаПоПартнерам,
	|	Погашения.ИсходнаяАналитикаУчетаПоПартнерам КАК ИсходнаяАналитикаУчетаПоПартнерам,
	|	Погашения.КорОбъектРасчетов КАК КорОбъектРасчетов,
	|	Погашения.ИсходныйОбъектРасчетов КАК ИсходныйОбъектРасчетов,
	|	Погашения.ДатаАванса КАК ДатаАванса,
	|	Погашения.ДатаПогашения КАК ДатаПогашения,
	|	МАКСИМУМ(Погашения.СобытиеЗнак) КАК СобытиеЗнак,
	|	МАКСИМУМ(ВЫБОР
	|		КОГДА Погашения.ВидСобытия = НЕОПРЕДЕЛЕНО
	|		// Если вид события не удалось идентифицировать сразу, смотрим вторичные признаки
	|			ТОГДА ВЫБОР
	|				КОГДА ЕСТЬNULL(ВидыСобытий.ХозяйственнаяОперация, НЕОПРЕДЕЛЕНО) =
	|						ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствОтПоставщика)
	|					ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствОтПоставщика)
	|				КОГДА ЕСТЬNULL(ВидыСобытий.ХозяйственнаяОперация, НЕОПРЕДЕЛЕНО) =
	|						ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаПоставщику)
	|					ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаПоставщику)
	|				КОГДА Погашения.СобытиеЗнак < 0
	|					ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствОтПоставщика)
	|				ИНАЧЕ
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаПоставщику)
	|			КОНЕЦ
	|		ИНАЧЕ
	|			Погашения.ВидСобытия
	|	КОНЕЦ) КАК ВидСобытия,
	|	МАКСИМУМ(Погашения.ВалютаДокумента) КАК ВалютаДокумента,
	|	МАКСИМУМ(Погашения.СуммаПогашения) КАК СуммаПогашения,
	|	МАКСИМУМ(Погашения.СуммаПогашенияВал) КАК СуммаПогашенияВал,
	|	МАКСИМУМ(Погашения.СуммаПогашенияУпр) КАК СуммаПогашенияУпр,
	|	МАКСИМУМ(Погашения.СуммаПогашенияРегл) КАК СуммаПогашенияРегл
	|ПОМЕСТИТЬ РасчетыСПоставщиками_ПогашенияАвансов
	|ИЗ
	|	РасчетыСПоставщиками_ПогашенияАвансов_Предварительная КАК Погашения
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		// Находим вид события, если изначально не удалось идентифицировать
	|		РегистрНакопления.РасчетыСПоставщикамиПоСрокам КАК ВидыСобытий
	|	ПО
	|		&НоваяАрхитектураВзаиморасчетов
	|		И Погашения.ВидСобытия          = НЕОПРЕДЕЛЕНО
	|		И Погашения.ДокументРегистратор = ВидыСобытий.ДокументРегистратор
	|		И ВидыСобытий.Период            <= &ДатаОкончания
	|		И ВидыСобытий.ВидДвижения       = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И ВидыСобытий.ХозяйственнаяОперация В
	|			(ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствОтПоставщика),
	|			 ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаПоставщику))
	|
	|СГРУППИРОВАТЬ ПО
	|	Погашения.РасчетныйДокумент,
	|	Погашения.Организация,
	|	Погашения.АналитикаУчетаПоПартнерам,
	|	Погашения.ОбъектРасчетов,
	|	Погашения.ДокументРегистратор,
	|	Погашения.Контрагент,
	|	Погашения.Договор,
	|	Погашения.НаправлениеДеятельности,
	|	Погашения.ИсхКонтрагент,
	|	Погашения.ИсхДоговор,
	|	Погашения.ИсхНаправлениеДеятельности,
	|	Погашения.КорАналитикаУчетаПоПартнерам,
	|	Погашения.ИсходнаяАналитикаУчетаПоПартнерам,
	|	Погашения.КорОбъектРасчетов,
	|	Погашения.ИсходныйОбъектРасчетов,
	|	Погашения.ДатаАванса,
	|	Погашения.ДатаПогашения
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ОтборПогашенийАвансов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ РасчетыСПоставщиками_ПогашенияАвансов_Предварительная
	|; 
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ РасчетыСПоставщиками_ПогашенияСНеявнымЗачетом
	|;
	|";
	
	УстановитьПоляИндексов(Запрос, ПараметрыРасчета, "РасчетыСПоставщиками_ПогашенияАвансов");
	
	ПараметрыПутей = ИнициализироватьПараметрыДляОтбораАвансов_ПутиКПолямИТекстуЗамены();
	ОбработатьТекстЗапросаДляОтбораАвансовПоПараметрам(Запрос, ПараметрыРасчета, ПараметрыПутей);
	
	Запрос.Выполнить();
	
	
КонецПроцедуры

// Подготовить временную таблицу "РасчетыСПоставщиками_ПереносыАвансов"
// Создает временную таблицу с колонками:
// 	  Организация;
// 	  ДокументОплаты;
// 	  ДокументПереноса;
// 	  АналитикаУчетаПоПартнерам;
// 	  ОбъектРасчетов;
// 	  Контрагент;
// 	  НаправлениеДеятельности;  
// 	  Подразделение;
// 	  КорАналитикаУчетаПоПартнерам;
// 	  КорОбъектРасчетов;
// 	  КорКонтрагент;
// 	  КорНаправлениеДеятельности;  
// 	  КорПодразделение;
// 	  Период;
// 	  НастройкаХозяйственнойОперации
// 	  ИдентификаторФинЗаписи;
// 	  Валюта;
// 	  Предоплата;
// 	  ПредоплатаРегл;
// 	  ПредоплатаУпр.
//
// Параметры:
//  МенеджерВременныхТаблиц - МенеджерВременныхТаблиц - 
//  ПараметрыРасчета        - см. ИнициализироватьПараметрыПодготовкиРасчетовАвансов
Процедура ПодготовитьВТ_РасчетыСПоставщиками_ПереносыАвансов(МенеджерВременныхТаблиц, ПараметрыРасчета) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	УстановитьПараметрыЗапросаПодготовкиРасчетовАвансов(Запрос, ПараметрыРасчета);

	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВложенныйЗапрос.Организация КАК Организация,
	|	ВложенныйЗапрос.ДокументПереноса КАК ДокументПереноса,
	|	ВложенныйЗапрос.ДокументОплаты КАК ДокументОплаты,
	|	ВложенныйЗапрос.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	ВложенныйЗапрос.ОбъектРасчетов КАК ОбъектРасчетов,
	|	ВложенныйЗапрос.Контрагент КАК Контрагент,
	|	ВложенныйЗапрос.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ВложенныйЗапрос.Подразделение КАК Подразделение,
	|	ВложенныйЗапрос.КорАналитикаУчетаПоПартнерам КАК КорАналитикаУчетаПоПартнерам,
	|	ВложенныйЗапрос.КорОбъектРасчетов КАК КорОбъектРасчетов,
	|	ВложенныйЗапрос.КорКонтрагент КАК КорКонтрагент,
	|	ВложенныйЗапрос.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	ВложенныйЗапрос.КорПодразделение КАК КорПодразделение,
	|	ВложенныйЗапрос.Период КАК Период,
	|	ВложенныйЗапрос.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	ВложенныйЗапрос.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи,
	|	ВложенныйЗапрос.Валюта КАК Валюта,
	|	СУММА(ВложенныйЗапрос.Предоплата) КАК Предоплата,
	|	СУММА(ВложенныйЗапрос.ПредоплатаРегл) КАК ПредоплатаРегл,
	|	СУММА(ВложенныйЗапрос.ПредоплатаУпр) КАК ПредоплатаУпр
	|ПОМЕСТИТЬ РасчетыСПоставщиками_ПереносыАвансов
	|ИЗ
	|	(ВЫБРАТЬ
	|		РасчетыСПоставщикамиПоСрокам.ОбъектРасчетов.Организация КАК Организация,
	|		РасчетыСПоставщикамиПоСрокам.ДокументРегистратор КАК ДокументПереноса,
	|		РасчетыСПоставщикамиПоСрокам.РасчетныйДокумент КАК ДокументОплаты,
	|		РасчетыСПоставщикамиПоСрокам.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|		РасчетыСПоставщикамиПоСрокам.ОбъектРасчетов КАК ОбъектРасчетов,
	|		РасчетыСПоставщикамиПоСрокам.АналитикаУчетаПоПартнерам.Контрагент КАК Контрагент,
	|		РасчетыСПоставщикамиПоСрокам.ОбъектРасчетов.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|		РасчетыСПоставщикамиПоСрокам.ОбъектРасчетов.Подразделение КАК Подразделение,
	|		РасчетыСПоставщикамиПоСрокам.КорАналитикаУчетаПоПартнерам КАК КорАналитикаУчетаПоПартнерам,
	|		РасчетыСПоставщикамиПоСрокам.КорОбъектРасчетов КАК КорОбъектРасчетов,
	|		РасчетыСПоставщикамиПоСрокам.КорАналитикаУчетаПоПартнерам.Контрагент КАК КорКонтрагент,
	|		РасчетыСПоставщикамиПоСрокам.КорОбъектРасчетов.НаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|		РасчетыСПоставщикамиПоСрокам.КорОбъектРасчетов.Подразделение КАК КорПодразделение,
	|		РасчетыСПоставщикамиПоСрокам.Период КАК Период,
	|		РасчетыСПоставщикамиПоСрокам.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|		РасчетыСПоставщикамиПоСрокам.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи,
	|		РасчетыСПоставщикамиПоСрокам.Валюта КАК Валюта,
	|		РасчетыСПоставщикамиПоСрокам.Предоплата КАК Предоплата,
	|		РасчетыСПоставщикамиПоСрокам.ПредоплатаРегл КАК ПредоплатаРегл,
	|		РасчетыСПоставщикамиПоСрокам.ПредоплатаУпр КАК ПредоплатаУпр
	|	ИЗ
	|		РегистрНакопления.РасчетыСПоставщикамиПоСрокам КАК РасчетыСПоставщикамиПоСрокам
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВзаимозачетЗадолженности КАК ВзаимозачетЗадолженности
	|			ПО РасчетыСПоставщикамиПоСрокам.ДокументРегистратор = ВзаимозачетЗадолженности.Ссылка
	|				И (ВзаимозачетЗадолженности.ВидОперации В (ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаОрганизацияКонтрагент), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаМеждуКонтрагентами), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуОрганизацияКонтрагент), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуМеждуКонтрагентами), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаМеждуДвумяОрганизациями), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуМеждуДвумяОрганизациями)))
	|	ГДЕ
	|		РасчетыСПоставщикамиПоСрокам.НастройкаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПереносАванса)
	|		И РасчетыСПоставщикамиПоСрокам.Активность
	|		И НЕ РасчетыСПоставщикамиПоСрокам.Сторно
	|		И РасчетыСПоставщикамиПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		И РасчетыСПоставщикамиПоСрокам.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
	|		И РасчетыСПоставщикамиПоСрокам.АналитикаУчетаПоПартнерам.Организация В(&Организации)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		РасчетыСПоставщикамиПоСрокам.ОбъектРасчетов.Организация,
	|		РасчетыСПоставщикамиПоСрокам.ДокументРегистратор,
	|		РасчетыСПоставщикамиПоСрокам.РасчетныйДокумент,
	|		РасчетыСПоставщикамиПоСрокам.АналитикаУчетаПоПартнерам,
	|		РасчетыСПоставщикамиПоСрокам.ОбъектРасчетов,
	|		РасчетыСПоставщикамиПоСрокам.АналитикаУчетаПоПартнерам.Контрагент,
	|		РасчетыСПоставщикамиПоСрокам.ОбъектРасчетов.НаправлениеДеятельности,
	|		РасчетыСПоставщикамиПоСрокам.ОбъектРасчетов.Подразделение,
	|		РасчетыСПоставщикамиПоСрокам.КорАналитикаУчетаПоПартнерам,
	|		РасчетыСПоставщикамиПоСрокам.КорОбъектРасчетов,
	|		РасчетыСПоставщикамиПоСрокам.КорАналитикаУчетаПоПартнерам.Контрагент,
	|		РасчетыСПоставщикамиПоСрокам.КорОбъектРасчетов.НаправлениеДеятельности,
	|		РасчетыСПоставщикамиПоСрокам.КорОбъектРасчетов.Подразделение,
	|		РасчетыСПоставщикамиПоСрокам.Период,
	|		РасчетыСПоставщикамиПоСрокам.НастройкаХозяйственнойОперации,
	|		РасчетыСПоставщикамиПоСрокам.ИдентификаторФинЗаписи,
	|		РасчетыСПоставщикамиПоСрокам.Валюта,
	|		РасчетыСПоставщикамиПоСрокам.Долг,
	|		РасчетыСПоставщикамиПоСрокам.ДолгРегл,
	|		РасчетыСПоставщикамиПоСрокам.ДолгУпр
	|	ИЗ
	|		РегистрНакопления.РасчетыСПоставщикамиПоСрокам КАК РасчетыСПоставщикамиПоСрокам
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВзаимозачетЗадолженности КАК ВзаимозачетЗадолженности
	|			ПО РасчетыСПоставщикамиПоСрокам.ДокументРегистратор = ВзаимозачетЗадолженности.Ссылка
	|				И (ВзаимозачетЗадолженности.ВидОперации В (ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаОрганизацияКонтрагент), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаМеждуКонтрагентами), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуОрганизацияКонтрагент), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуМеждуКонтрагентами), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаКлиентаМеждуДвумяОрганизациями), ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВзаимозачетаЗадолженности.ПереносАвансаПоставщикуМеждуДвумяОрганизациями)))
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК РасчетыСКлиентамиПоСрокам_Приход
	|			ПО (РасчетыСПоставщикамиПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход))
	|				И РасчетыСПоставщикамиПоСрокам.ОбъектРасчетов = РасчетыСКлиентамиПоСрокам_Приход.ОбъектРасчетов
	|				И РасчетыСПоставщикамиПоСрокам.АналитикаУчетаПоПартнерам = РасчетыСКлиентамиПоСрокам_Приход.АналитикаУчетаПоПартнерам
	|				И РасчетыСПоставщикамиПоСрокам.ДокументРегистратор = РасчетыСКлиентамиПоСрокам_Приход.ДокументРегистратор
	|	ГДЕ
	|		РасчетыСПоставщикамиПоСрокам.НастройкаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПереносАванса)
	|		И РасчетыСПоставщикамиПоСрокам.Активность
	|		И НЕ РасчетыСПоставщикамиПоСрокам.Сторно
	|		И РасчетыСПоставщикамиПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И РасчетыСПоставщикамиПоСрокам.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
	|		И РасчетыСПоставщикамиПоСрокам.АналитикаУчетаПоПартнерам.Организация В(&Организации)
	|		И РасчетыСПоставщикамиПоСрокам.Долг > 0) КАК ВложенныйЗапрос
	|
	|СГРУППИРОВАТЬ ПО
	|	ВложенныйЗапрос.АналитикаУчетаПоПартнерам,
	|	ВложенныйЗапрос.Валюта,
	|	ВложенныйЗапрос.КорАналитикаУчетаПоПартнерам,
	|	ВложенныйЗапрос.Подразделение,
	|	ВложенныйЗапрос.КорПодразделение,
	|	ВложенныйЗапрос.ДокументОплаты,
	|	ВложенныйЗапрос.КорНаправлениеДеятельности,
	|	ВложенныйЗапрос.ИдентификаторФинЗаписи,
	|	ВложенныйЗапрос.Период,
	|	ВложенныйЗапрос.Организация,
	|	ВложенныйЗапрос.КорОбъектРасчетов,
	|	ВложенныйЗапрос.КорКонтрагент,
	|	ВложенныйЗапрос.НаправлениеДеятельности,
	|	ВложенныйЗапрос.Контрагент,
	|	ВложенныйЗапрос.НастройкаХозяйственнойОперации,
	|	ВложенныйЗапрос.ОбъектРасчетов,
	|	ВложенныйЗапрос.ДокументПереноса";
	
	УстановитьПоляИндексов(Запрос, ПараметрыРасчета, "РасчетыСПоставщиками_ПереносыАвансов");
	
	Запрос.Выполнить();
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс

#Область ОбработчикиЭтаповЗакрытияМесяца

#Область ФормированиеДвиженийПоРасчетамСПартнерамиИПереоценкаРасчетов

// Добавляет этап в таблицу этапов закрытия месяца.
// Элементы данной таблицы являются элементами второго уровня в дереве этапов в форме закрытия месяца.
// 
// Параметры:
// 	ТаблицаЭтапов - (См. Обработки.ОперацииЗакрытияМесяца.ЗаполнитьОписаниеЭтаповЗакрытияМесяца)
// 	ТекущийРодитель - Строка - идентификатор группы.
Процедура ДобавитьЭтап_ФормированиеДвиженийПоРасчетамСПартнерамиИПереоценкаРасчетов(ТаблицаЭтапов,ТекущийРодитель) Экспорт
	НоваяСтрока = ЗакрытиеМесяцаСервер.ДобавитьЭтапВТаблицу(ТаблицаЭтапов, ТекущийРодитель,
		Перечисления.ОперацииЗакрытияМесяца.ФормированиеДвиженийПоРасчетамСПартнерамиИПереоценкаРасчетов);
	НоваяСтрока.ДействиеИспользование = ЗакрытиеМесяцаСервер.ОписаниеДействия_СервернаяПроцедура(
		"ВзаиморасчетыСервер.Использование_ФормированиеДвиженийПоРасчетамСПартнерамиИПереоценкаРасчетов");
	НоваяСтрока.ДействиеОформление = ЗакрытиеМесяцаСервер.ОписаниеДействия_СервернаяПроцедура(
		"ВзаиморасчетыСервер.Оформление_ФормированиеДвиженийПоРасчетамСПартнерамиИПереоценкаРасчетов");
	НоваяСтрока.ДействиеВыполнить = ЗакрытиеМесяцаСервер.ОписаниеДействия_ВыполнитьРасчет(
		"ВзаиморасчетыСервер.Выполнить_ФормированиеДвиженийПоРасчетамСПартнерамиИПереоценкаРасчетов");
		НоваяСтрока.ВыполняетсяПриПредварительномЗакрытииМесяца = Истина;
КонецПроцедуры

// Обработчики этапа.

// Параметры:
// 	ПараметрыОбработчика - см. Обработки.ОперацииЗакрытияМесяца.ИнициализироватьПараметрыОбработчикаЭтапа
Процедура Использование_ФормированиеДвиженийПоРасчетамСПартнерамиИПереоценкаРасчетов(ПараметрыОбработчика) Экспорт
	
	ПараметрыРасчета = ПараметрыОбработчика.ПараметрыРасчета;
	
	Запрос = Новый Запрос;
	ЗакрытиеМесяцаСервер.ИнициализироватьЗапрос(Запрос, ПараметрыОбработчика);
	
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	Расчеты.АналитикаУчетаПоПартнерам
	|ИЗ
	|	РегистрНакопления.РасчетыСКлиентами КАК Расчеты
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПоПартнерам КАК Аналитики
	|	ПО Расчеты.АналитикаУчетаПоПартнерам = Аналитики.Ссылка
	|ГДЕ
	|	Расчеты.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Аналитики.Организация В (&МассивОрганизаций)
	|	И Расчеты.Активность
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	Расчеты.АналитикаУчетаПоПартнерам
	|ИЗ
	|	РегистрНакопления.РасчетыСПоставщиками КАК Расчеты
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПоПартнерам КАК Аналитики
	|	ПО Расчеты.АналитикаУчетаПоПартнерам = Аналитики.Ссылка
	|ГДЕ
	|	Расчеты.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Аналитики.Организация В (&МассивОрганизаций)
	|	И Расчеты.Активность";
	
	ЗакрытиеМесяцаСервер.УвеличитьКоличествоОбработанныхДанныхДляЗамера(ПараметрыОбработчика, ПараметрыРасчета.МассивОрганизаций.Количество());
	
	ЕстьДвиженияПоРасчетам = НЕ Запрос.Выполнить().Пустой();
	
	Если НЕ ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов") Тогда
		
		АналитикиРасчета = РаспределениеВзаиморасчетовВызовСервера.АналитикиРасчета();
		АналитикиРасчета.Организации = ПараметрыРасчета.МассивОрганизаций;
		
		НачалоРасчета = РаспределениеВзаиморасчетовВызовСервера.НачалоРасчетов(КонецМесяца(ПараметрыРасчета.Период), АналитикиРасчета);
		ПериодВДиапазонеПересчета = (ЗначениеЗаполнено(НачалоРасчета) И НачалоРасчета <= ПараметрыРасчета.ПериодРегистрации);
		
	Иначе
		
		НачалоРасчета = ЗакрытиеМесяцаСервер.НачалоРасчета(
			ПараметрыОбработчика.ДанныеЭтапа.Код,
			ПараметрыОбработчика.ПараметрыРасчета.КонецПериода,
			Неопределено,
			ПараметрыРасчета.МассивОрганизаций);
		
		ПериодВДиапазонеПересчета = ЗакрытиеМесяцаСервер.ПроверитьНаличиеЗаданийКЗакрытиюМесяца(ПараметрыОбработчика, Истина);
		ПараметрыОбработчика.ТаблицаПояснения.Очистить();
		
		Если ПериодВДиапазонеПересчета Тогда
			Запрос.УстановитьПараметр("НачалоМесяца", НачалоМесяца(ПараметрыРасчета.ПериодРегистрации));
		Иначе
			Запрос.УстановитьПараметр("НачалоМесяца", Дата(1,1,1,1,1,2));
		КонецЕсли;
		Запрос.УстановитьПараметр("ПериодВДиапазонеПересчета", ПериодВДиапазонеПересчета);
		
		Запрос.Текст = ОперативныеВзаиморасчетыСервер.ТекстЗапросаНекорректныхОстаткиВзаиморасчетовПоСрокам("ВТНекорректныеОстаткиВзаиморасчетов");
		Запрос.Выполнить();
		
		Запрос.Текст = "УНИЧТОЖИТЬ ВтАналитика; УНИЧТОЖИТЬ ВтОстатки; УНИЧТОЖИТЬ ВтРучныеКорректировки";
		Запрос.Выполнить();
		
		Запрос.Текст = ОперативныеВзаиморасчетыСервер.ТекстЗапросаНекорректныхОстаткиВзаиморасчетовПоСрокам("ВТНекорректныеОстаткиВзаиморасчетовРучныеКорректировки", Ложь);
		Запрос.Выполнить();
		
		Запрос.Текст = "УНИЧТОЖИТЬ ВтАналитика; УНИЧТОЖИТЬ ВтРучныеКорректировки";
		Запрос.Выполнить();
		
		Запрос.УстановитьПараметр("НеЗачетОплатПоДатеПлатежа", 
		                          Константы.ЗачетОплатПоДатеПлатежа.Получить() = 0);
		
		Запрос.Текст = ОперативныеВзаиморасчетыСервер.ТекстЗапросаРазвернутоеСальдо("ВТРазвернутоеСальдоВзаиморасчетов");
		Запрос.Выполнить();
		
		Запрос.Текст = "УНИЧТОЖИТЬ ВтАналитика; УНИЧТОЖИТЬ ВтСальдо; УНИЧТОЖИТЬ ВтРучныеКорректировки";
		Запрос.Выполнить();
		
		Запрос.Текст = ОперативныеВзаиморасчетыСервер.ТекстЗапросаРазвернутоеСальдо("ВТРазвернутоеСальдоВзаиморасчетовРучныеКорректировки", Ложь);
		Запрос.Выполнить();
		
	КонецЕсли;
	
	ЗакрытиеМесяцаСервер.УвеличитьКоличествоОбработанныхДанныхДляЗамера(ПараметрыОбработчика, 1);
	
	РегистрыДляРасчета = Документы.РасчетКурсовыхРазниц.РегистрыРасчета(Перечисления.ХозяйственныеОперации.ПереоценкаРасчетовСПоставщиками);
	РегистрыДляРасчета = Документы.РасчетКурсовыхРазниц.РегистрыРасчета(Перечисления.ХозяйственныеОперации.ПереоценкаРасчетовСКлиентами, РегистрыДляРасчета);
	
	ЗакрытиеМесяцаСервер.УвеличитьКоличествоОбработанныхДанныхДляЗамера(ПараметрыОбработчика, ПараметрыРасчета.МассивОрганизаций.Количество());
	
	ЕстьВалютныеОстатки = Документы.РасчетКурсовыхРазниц.ЕстьВалютныеОстатки(
		ПараметрыРасчета.МассивОрганизаций,
		ПараметрыРасчета.КонецПериода,
		РегистрыДляРасчета);
	
	ЗакрытиеМесяцаСервер.УвеличитьКоличествоОбработанныхДанныхДляЗамера(ПараметрыОбработчика, ПараметрыРасчета.МассивОрганизаций.Количество());
	
	ТребуетсяПереоценка = Документы.РасчетКурсовыхРазниц.ТребуетсяПереоценкаВзаиморасчетов(
		ПараметрыРасчета.МассивОрганизаций,
		ПараметрыРасчета.ПериодРегистрации);
	
	ВтНекорректныхОстатковРучныеКорректировки = Запрос.МенеджерВременныхТаблиц.Таблицы.Найти("ВТНекорректныеОстаткиВзаиморасчетовРучныеКорректировки");
	ВтРазвернутогоСальдоРучныеКорректировки = Запрос.МенеджерВременныхТаблиц.Таблицы.Найти("ВТРазвернутоеСальдоВзаиморасчетовРучныеКорректировки");

	ЕстьНекорректныеРучныеКорректировки = ВтНекорректныхОстатковРучныеКорректировки <> Неопределено 
		И Не ВтНекорректныхОстатковРучныеКорректировки.ПолучитьДанные().Пустой()
		Или ВтРазвернутогоСальдоРучныеКорректировки <> Неопределено
		И Не ВтРазвернутогоСальдоРучныеКорректировки.ПолучитьДанные().Пустой();
	
	Если НЕ ТребуетсяПереоценка И НЕ ПериодВДиапазонеПересчета И Не ЕстьНекорректныеРучныеКорректировки Тогда
		
		Если НЕ ЕстьДвиженияПоРасчетам Тогда
			
			// Расчет не требуется.
			ЗакрытиеМесяцаСервер.УстановитьСостояниеНеТребуется(
				ПараметрыОбработчика,
				НСтр("ru = 'Нет движений по взаиморасчетам с клиентами и поставщиками.'", ОбщегоНазначения.КодОсновногоЯзыка()));
			
			Если НЕ ЕстьВалютныеОстатки Тогда
				ЗакрытиеМесяцаСервер.УстановитьСостояниеНеТребуется(
					ПараметрыОбработчика,
					НСтр("ru = 'Нет валютных остатков по взаиморасчетам с клиентами и поставщиками.'", ОбщегоНазначения.КодОсновногоЯзыка()));
			КонецЕсли;
			
		Иначе
			// Расчет выполнен успешно.
		КонецЕсли;
		
	Иначе
		
		// Требуется перерасчет.
		Если ПериодВДиапазонеПересчета Тогда
			
			ПараметрыОбработчика.ДанныеЭтапа.ДатаНачалаРасчета = НачалоМесяца(НачалоРасчета);
			
			ТекстОперации = НСтр("ru = 'Формирование движений начиная с периода %1'", ОбщегоНазначения.КодОсновногоЯзыка());
			
			ЗакрытиеМесяцаСервер.УстановитьСостояниеНеВыполнен(
				ПараметрыОбработчика,
				СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					ТекстОперации,
					РасчетСебестоимостиПротоколРасчета.ПредставлениеПериодаРасчета(НачалоРасчета)));
			
		КонецЕсли;
		
		Если ТребуетсяПереоценка Тогда
			
			ДействиеПодробнее = ЗакрытиеМесяцаСервер.ОписаниеДействия_ОткрытьФорму(
				Метаданные.Отчеты.СправкаРасчетПереоценкиВалютныхСредств.ПолноеИмя() + ".Форма", Истина);
			ДействиеПодробнее.ПараметрыФормы.Вставить("СформироватьПриОткрытии", Истина);
			ДействиеПодробнее.ПараметрыФормы.Вставить("ВсеОрганизации", НЕ ЗначениеЗаполнено(ПараметрыОбработчика.ПараметрыРасчета.МассивОрганизаций));
			
			Если ПериодВДиапазонеПересчета Тогда
				ЗакрытиеМесяцаСервер.УстановитьСостояниеНеВыполнен(
					ПараметрыОбработчика,
					НСтр("ru = 'Расчет курсовых разниц по взаиморасчетам с клиентами и поставщиками.'", ОбщегоНазначения.КодОсновногоЯзыка()),
					ЗакрытиеМесяцаСервер.ТекстПодробнееПоУмолчанию(),
					ДействиеПодробнее);
			Иначе
				ЗакрытиеМесяцаСервер.УстановитьСостояниеВыполненСОшибками(
					ПараметрыОбработчика,
					НСтр("ru = 'Расчет курсовых разниц по взаиморасчетам с клиентами и поставщиками.'", ОбщегоНазначения.КодОсновногоЯзыка()),
					ЗакрытиеМесяцаСервер.ТекстПодробнееПоУмолчанию(),
					ДействиеПодробнее);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
	ЗакрытиеМесяцаСервер.УстановитьДополнительноеСвойствоОбработчика(ПараметрыОбработчика, "ТребуетсяПереоценка", ТребуетсяПереоценка);
	
КонецПроцедуры

// Параметры:
// 	ПараметрыОбработчика - см. Обработки.ОперацииЗакрытияМесяца.ИнициализироватьПараметрыОбработчикаЭтапа
Процедура Оформление_ФормированиеДвиженийПоРасчетамСПартнерамиИПереоценкаРасчетов(ПараметрыОбработчика) Экспорт
	
	Если ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов") Тогда
		ПараметрыОбработчика.ДанныеЭтапа.Наименование = НСтр("ru = 'Актуализация движений документов по данным взаиморасчетов'");
		ПараметрыОбработчика.ДанныеЭтапа.ТекстВыполнить = НСтр("ru = 'Выполнить'");
	Иначе
		ПараметрыОбработчика.ДанныеЭтапа.Наименование = НСтр("ru = 'Формирование движений по данным взаиморасчетов'");
		ПараметрыОбработчика.ДанныеЭтапа.ТекстВыполнить = НСтр("ru = 'Сформировать'");
	КонецЕсли;
	
	ЗакрытиеМесяцаСервер.УвеличитьКоличествоОбработанныхДанныхДляЗамера(ПараметрыОбработчика);
	
КонецПроцедуры

Процедура ОписаниеПроверок_ФормированиеДвиженийПоРасчетамСПартнерамиИПереоценкаРасчетов(ТаблицаПроверок) Экспорт
	
	// Расхождения остатков оперативных и финансовых регистров взаиморасчетов.
	ОписаниеПроверки = ЗакрытиеМесяцаСервер.ДобавитьОписаниеНовойПроверки(ТаблицаПроверок,
		"ПроверкаОстатковВзаиморасчетов",
		Перечисления.ОперацииЗакрытияМесяца.ФормированиеДвиженийПоРасчетамСПартнерамиИПереоценкаРасчетов,
		Перечисления.МоментЗапускаПроверкиОперацииЗакрытияМесяца.ДоИПослеРасчета,
		"ВзаиморасчетыСервер.ПроверкаОстатковВзаиморасчетов");
	
	ЗакрытиеМесяцаСервер.ЗаполнитьПредставлениеНовойПроверки(ОписаниеПроверки,
		НСтр("ru = 'Расхождения в регистрах взаиморасчетов'"),
		НСтр("ru = 'Существует 2 способа исправления: 
			|1) Закрытие месяца выявит расхождения и скорректирует остатки на начало закрываемого месяца.
			|Задания к переотражению в БУ, МФУ, НДС и к закрытию месяца при этом созданы не будут.
			|2) Для исправления движений документов, приведших к некорректным остаткам необходимо перепровести соответствующие документы.'"));
	
	// Некорректируемые автоматически расхождения остатков оперативных и финансовых регистров взаиморасчетов 
	ОписаниеПроверки = ЗакрытиеМесяцаСервер.ДобавитьОписаниеНовойПроверки(ТаблицаПроверок,
		"ПроверкаОстатковВзаиморасчетовРучнаяКорректировка",
		Перечисления.ОперацииЗакрытияМесяца.ФормированиеДвиженийПоРасчетамСПартнерамиИПереоценкаРасчетов,
		Перечисления.МоментЗапускаПроверкиОперацииЗакрытияМесяца.ДоИПослеРасчета,
		"ВзаиморасчетыСервер.ПроверкаОстатковВзаиморасчетовРучнаяКорректировка");
		
	ЗакрытиеМесяцаСервер.ЗаполнитьПредставлениеНовойПроверки(ОписаниеПроверки,
		НСтр("ru = 'Расхождения в регистрах взаиморасчетов'"),
		НСтр("ru = 'По указанным аналитикам и объектам расчетов обнаружены ручные корректировки регистров.
			|Исправление возможно только ручной корректировкой регистров.'"));
	
	// Развернутое сальдо по взаиморасчетам.
	ОписаниеПроверки = ЗакрытиеМесяцаСервер.ДобавитьОписаниеНовойПроверки(ТаблицаПроверок,
		"ПроверкаРазвернутогоСальдо",
		Перечисления.ОперацииЗакрытияМесяца.ФормированиеДвиженийПоРасчетамСПартнерамиИПереоценкаРасчетов,
		Перечисления.МоментЗапускаПроверкиОперацииЗакрытияМесяца.ДоИПослеРасчета,
		"ВзаиморасчетыСервер.ПроверкаРазвернутогоСальдо");
	
	ЗакрытиеМесяцаСервер.ЗаполнитьПредставлениеНовойПроверки(ОписаниеПроверки,
		НСтр("ru = 'Развернутое сальдо по регистрам взаиморасчетов'"),
		НСтр("ru = 'При наличии развернутого сальдо по взаиморасчетам в рамках одного объекта расчетов и аналитики
			|могут возникать ошибки распределения взаиморасчетов в финансовых регистрах.'"));
		
	// Некорректируемое автоматически развернутое сальдо по взаиморасчетам
	ОписаниеПроверки = ЗакрытиеМесяцаСервер.ДобавитьОписаниеНовойПроверки(ТаблицаПроверок,
		"ПроверкаРазвернутогоСальдоРучнаяКорректировка",
		Перечисления.ОперацииЗакрытияМесяца.ФормированиеДвиженийПоРасчетамСПартнерамиИПереоценкаРасчетов,
		Перечисления.МоментЗапускаПроверкиОперацииЗакрытияМесяца.ДоИПослеРасчета,
		"ВзаиморасчетыСервер.ПроверкаРазвернутогоСальдоРучнаяКорректировка");
		
	ЗакрытиеМесяцаСервер.ЗаполнитьПредставлениеНовойПроверки(ОписаниеПроверки,
		НСтр("ru = 'Развернутое сальдо по регистрам взаиморасчетов'"),
		НСтр("ru = 'При наличии развернутого сальдо по взаиморасчетам в рамках одного объекта расчетов и аналитики
			|могут возникать ошибки распределения взаиморасчетов в финансовых регистрах.'"));
	
КонецПроцедуры

Процедура ПроверкаОстатковВзаиморасчетов(ПараметрыПроверки) Экспорт
	
	Если НЕ ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов") Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗакрытиеМесяцаСервер.ПроверкаВыполняетсяМеханизмомЗакрытияМесяца(ПараметрыПроверки) Тогда
		Возврат;
	КонецЕсли;
	
	СписокПолей = Новый СписокЗначений;
	СписокПолей.Добавить("ТипРасчетов", НСтр("ru = 'Тип расчетов'"));
	СписокПолей.Добавить("Организация");
	СписокПолей.Добавить("АналитикаУчетаПоПартнерам", НСтр("ru = 'Аналитика учета по партнерам'"));
	СписокПолей.Добавить("ОбъектРасчетов",            НСтр("ru = 'Объект расчетов'"));
	
	ПараметрыРегистрации = ЗакрытиеМесяцаСервер.ИнициализироватьПараметрыРегистрацииПроблемПроверки(
		"ВТНекорректныеОстаткиВзаиморасчетов",
		НСтр("ru = 'Исправление некорректных остатков по финансовым регистрам взаиморасчетов на начало периода %2.'"),
		СписокПолей,,);
		
	ЗакрытиеМесяцаСервер.ЗарегистрироватьПроблемыВыполненияПроверки(
		ПараметрыПроверки,
		ПараметрыРегистрации);
	
КонецПроцедуры

Процедура ПроверкаОстатковВзаиморасчетовРучнаяКорректировка(ПараметрыПроверки) Экспорт
	
	Если НЕ ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов") Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗакрытиеМесяцаСервер.ПроверкаВыполняетсяМеханизмомЗакрытияМесяца(ПараметрыПроверки) Тогда
		Возврат;
	КонецЕсли;
	
	СписокПолей = Новый СписокЗначений;
	СписокПолей.Добавить("ТипРасчетов", НСтр("ru = 'Тип расчетов'"));
	СписокПолей.Добавить("Организация");
	СписокПолей.Добавить("АналитикаУчетаПоПартнерам", НСтр("ru = 'Аналитика учета по партнерам'"));
	СписокПолей.Добавить("ОбъектРасчетов",            НСтр("ru = 'Объект расчетов'"));
	СписокПолей.Добавить("РучнаяКорректировка",       НСтр("ru = 'Ручная корректировка регистров'"));
	
	ПараметрыРегистрации = ЗакрытиеМесяцаСервер.ИнициализироватьПараметрыРегистрацииПроблемПроверки(
		"ВТНекорректныеОстаткиВзаиморасчетовРучныеКорректировки",
		НСтр("ru = 'Внимание! Требуется исправление остатков взаиморасчетов. Исправить остатки автоматически невозможно, так как введен некорректный документ ""Корректировка регистров""'"),
		СписокПолей,,);
		
	ЗакрытиеМесяцаСервер.ЗарегистрироватьПроблемыВыполненияПроверки(
		ПараметрыПроверки,
		ПараметрыРегистрации);
	
КонецПроцедуры

Процедура ПроверкаРазвернутогоСальдо(ПараметрыПроверки) Экспорт 
	
	Если НЕ ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов") Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗакрытиеМесяцаСервер.ПроверкаВыполняетсяМеханизмомЗакрытияМесяца(ПараметрыПроверки) Тогда
		Возврат;
	КонецЕсли;
	
	СписокПолей = Новый СписокЗначений;
	СписокПолей.Добавить("ТипРасчетов", НСтр("ru = 'Тип расчетов'"));
	СписокПолей.Добавить("Организация");
	СписокПолей.Добавить("АналитикаУчетаПоПартнерам", НСтр("ru = 'Аналитика учета по партнерам'"));
	СписокПолей.Добавить("ОбъектРасчетов",            НСтр("ru = 'Объект расчетов'"));
	
	ПараметрыРегистрации = ЗакрытиеМесяцаСервер.ИнициализироватьПараметрыРегистрацииПроблемПроверки(
		"ВТРазвернутоеСальдоВзаиморасчетов",
		НСтр("ru = 'Исправление развернутого сальдо по финансовым регистрам взаиморасчетов на начало периода %2.'"),
		СписокПолей,,);
		
	ЗакрытиеМесяцаСервер.ЗарегистрироватьПроблемыВыполненияПроверки(
		ПараметрыПроверки,
		ПараметрыРегистрации);
		
КонецПроцедуры

Процедура ПроверкаРазвернутогоСальдоРучнаяКорректировка(ПараметрыПроверки) Экспорт 
	
	Если НЕ ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов") Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗакрытиеМесяцаСервер.ПроверкаВыполняетсяМеханизмомЗакрытияМесяца(ПараметрыПроверки) Тогда
		Возврат;
	КонецЕсли;
	
	СписокПолей = Новый СписокЗначений;
	СписокПолей.Добавить("ТипРасчетов", НСтр("ru = 'Тип расчетов'"));
	СписокПолей.Добавить("Организация");
	СписокПолей.Добавить("АналитикаУчетаПоПартнерам", НСтр("ru = 'Аналитика учета по партнерам'"));
	СписокПолей.Добавить("ОбъектРасчетов",            НСтр("ru = 'Объект расчетов'"));
	СписокПолей.Добавить("РучнаяКорректировка",       НСтр("ru = 'Ручная корректировка регистров'"));
	
	ПараметрыРегистрации = ЗакрытиеМесяцаСервер.ИнициализироватьПараметрыРегистрацииПроблемПроверки(
		"ВТРазвернутоеСальдоВзаиморасчетовРучныеКорректировки",
		НСтр("ru = 'Внимание! Требуется исправление развернутого сальдо. Исправить автоматически невозможно, так как введен некорректный документ ""Корректировка регистров""'"),
		СписокПолей,,);
		
	ЗакрытиеМесяцаСервер.ЗарегистрироватьПроблемыВыполненияПроверки(
		ПараметрыПроверки,
		ПараметрыРегистрации);
		
КонецПроцедуры

Процедура Выполнить_ФормированиеДвиженийПоРасчетамСПартнерамиИПереоценкаРасчетов(ПараметрыОбработчика) Экспорт
	
	ПараметрыРасчета = ПараметрыОбработчика.ПараметрыРасчета;
	Если НЕ ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов") Тогда
		
		АналитикиРасчета = РаспределениеВзаиморасчетовВызовСервера.АналитикиРасчета();
		АналитикиРасчета.Организации = ПараметрыРасчета.МассивОрганизаций;
		
		РаспределениеВзаиморасчетовВызовСервера.РассчитатьВсе(ПараметрыРасчета.КонецПериода, АналитикиРасчета);
		
		//Переоценка на конец месяца или по дням если не было взаиморасчетов
		Документы.РасчетКурсовыхРазниц.ПереоценитьРасчетыСКлиентами(
			ПараметрыРасчета.МассивОрганизаций,
			ПараметрыРасчета.ПериодРегистрации);
		Документы.РасчетКурсовыхРазниц.ПереоценитьРасчетыСПоставщиками(
			ПараметрыРасчета.МассивОрганизаций,
			ПараметрыРасчета.ПериодРегистрации);
		
	Иначе
		
		ПараметрыРасчета = ПараметрыОбработчика.ПараметрыРасчета;
	
		НачалоРасчета = ЗакрытиеМесяцаСервер.НачалоРасчета(
			ПараметрыОбработчика.ДанныеЭтапа.Код,
			ПараметрыРасчета.КонецПериода,
			,
			ПараметрыРасчета.МассивОрганизаций);
		
		Если Константы.РаспределятьФактическиеРасчетыФоновымЗаданием.Получить() Тогда
			
			ТекстПричины = ТекстПредупрежденияЗагрузкаДокументовВзаиморасчетов();
			ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'При выполнении расчета за период %1 произошла ошибка:
					|%2'", ОбщегоНазначения.КодОсновногоЯзыка()),
				РасчетСебестоимостиПротоколРасчета.ПредставлениеПериодаРасчета(ПараметрыРасчета.ПериодРегистрации),
				ТекстПричины
			);
			
			ЗакрытиеМесяцаСервер.ЗафиксироватьНаличиеПроблемыПриВыполненииРасчета(
				ПараметрыОбработчика,
				ТекстОшибки,
				ПараметрыРасчета.МассивОрганизаций,
				НачалоРасчета);
				
			Возврат;
				
		КонецЕсли;
			
		ИмяКлючевойОперации = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				"ЗакрытиеМесяца.%1",
				СокрЛП(ПараметрыОбработчика.ДанныеЭтапа.Код));
		ОписаниеЗамера 		= ОценкаПроизводительности.НачатьЗамерДлительнойОперации(ИмяКлючевойОперации);
		КоличествоДанных	= 0;
		
		ТребуетсяПереоценка = ЗакрытиеМесяцаСервер.ПолучитьДополнительноеСвойствоОбработчика(ПараметрыОбработчика, "ТребуетсяПереоценка", Ложь);
		ЕстьЗаданиеКРасчету = (НачалоРасчета <= ПараметрыРасчета.КонецПериода);
		Если ТребуетсяПереоценка И НЕ ЕстьЗаданиеКРасчету Тогда
			НачалоРасчета = ПараметрыРасчета.КонецПериода; // пересчитать только указанный месяц
		КонецЕсли;
		
		Пока НачалоРасчета <= ПараметрыОбработчика.ПараметрыРасчета.КонецПериода Цикл
		
			НомерЗадания 	 	= ЗакрытиеМесяцаСервер.УвеличитьНомерЗадания();
			ОкончаниеПериода 	= КонецМесяца(НачалоРасчета);
			ДоступныеОрганизации = ЗакрытиеМесяцаСервер.ДоступныеДляРасчетаОрганизации(НачалоРасчета, ПараметрыРасчета.МассивОрганизаций);
			
			НачатьТранзакцию();
			
			Попытка
				
				ЗакрытиеМесяцаСервер.ЗаблокироватьРегистрЗаданий(
					НомерЗадания,
					ДоступныеОрганизации,
					ПараметрыОбработчика.ДанныеЭтапа.Код);
				
				ДанныеКРасчетуЗаМесяц = ЗакрытиеМесяцаСервер.ЗаданияКРасчетуЗаМесяц(
					НачалоРасчета,
					ОкончаниеПериода,
					НомерЗадания,
					ДоступныеОрганизации,
					ПараметрыОбработчика.ДанныеЭтапа.Код);
				
				ЗафиксироватьТранзакцию();
				
			Исключение
				
				ОтменитьТранзакцию();
				
				ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'При выполнении расчета за период %1 произошла ошибка:
						|%2'", ОбщегоНазначения.КодОсновногоЯзыка()),
					РасчетСебестоимостиПротоколРасчета.ПредставлениеПериодаРасчета(ПараметрыРасчета.ПериодРегистрации),
					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
				
				ЗакрытиеМесяцаСервер.ЗафиксироватьНаличиеПроблемыПриВыполненииРасчета(
					ПараметрыОбработчика,
					ТекстОшибки,
					ДоступныеОрганизации,
					НачалоРасчета);
				
			КонецПопытки;
			
			//Исправления ошибок.
			
			ОперативныеВзаиморасчетыСервер.ИсправитьОстаткиВзаиморасчетов(НачалоРасчета, ДанныеКРасчетуЗаМесяц.Организация);
			ОперативныеВзаиморасчетыСервер.ИсправитьРазвернутоеСальдо(НачалоРасчета, ДанныеКРасчетуЗаМесяц.Организация);
			
			//Актуализация движений.
			
			Для Каждого Организация Из ДанныеКРасчетуЗаМесяц.Организация Цикл
				
				БылиОшибки = Ложь;
				
				Запрос = Новый Запрос;
				Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
				Запрос.УстановитьПараметр("КонецПериодаГраница", Новый Граница(ОкончаниеПериода, ВидГраницы.Включая));
				Запрос.УстановитьПараметр("КонецПериода", ОкончаниеПериода);
				Запрос.УстановитьПараметр("НачалоПериода", НачалоРасчета);
				Запрос.УстановитьПараметр("Организация",   Организация);
				Запрос.УстановитьПараметр("НоваяАрхитектураВзаиморасчетов", Истина);
				Запрос.УстановитьПараметр("ПоВсемДокументам", Ложь);
				Запрос.УстановитьПараметр("ВалютаУпрУчета", Константы.ВалютаУправленческогоУчета.Получить());
				
				#Область СуммыДокументовВВалютахУчета
				//Пересчет построчного распределения валютных сумм документов.
				
				Запрос.Текст = "
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	РасчетыСКлиентами.Регистратор КАК Регистратор,
				|	РасчетыСКлиентами.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
				|	РасчетыСКлиентами.Период КАК Период
				|ПОМЕСТИТЬ ПредварительныеРасчетыКОтражениюВУчете
				|ИЗ
				|	РегистрНакопления.РасчетыСКлиентами КАК РасчетыСКлиентами
				|ГДЕ 
				|	РасчетыСКлиентами.Период <= &КонецПериода И РасчетыСКлиентами.Период >= &НачалоПериода
				|	И РасчетыСКлиентами.АналитикаУчетаПоПартнерам.Организация = &Организация
				|	И РасчетыСКлиентами.Сумма <> 0
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	РасчетыСПоставщиками.Регистратор КАК Регистратор,
				|	РасчетыСПоставщиками.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
				|	РасчетыСПоставщиками.Период КАК Период
				|ИЗ
				|	РегистрНакопления.РасчетыСПоставщиками КАК РасчетыСПоставщиками
				|ГДЕ 
				|	РасчетыСПоставщиками.Период <= &КонецПериода И РасчетыСПоставщиками.Период >= &НачалоПериода
				|	И РасчетыСПоставщиками.АналитикаУчетаПоПартнерам.Организация = &Организация
				|	И РасчетыСПоставщиками.Сумма <> 0
				|;
				|////////////////////////////////////////////////////////////////////////////////
				|
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	Расчеты.Регистратор КАК ДокументРегистратор
				|ИЗ
				|	ПредварительныеРасчетыКОтражениюВУчете КАК Расчеты";
				МассивВсехДокументов = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("ДокументРегистратор");
				МассивИзмененныхДокументов = РегистрыСведений.СуммыДокументовВВалютахУчета.РассчитатьСуммыДокументовВВалютахУчета(МассивВсехДокументов);
				ИзмененыОборотныеРегистры = УправленческийУчетПроведениеСервер.ОбновитьДвиженияПоОборотнымРегистрам(МассивВсехДокументов);
				ОбщегоНазначенияКлиентСервер.ДополнитьМассив(МассивИзмененныхДокументов,ИзмененыОборотныеРегистры);
				Если ПолучитьФункциональнуюОпцию("ФормироватьУправленческийБаланс") Тогда
					Обработки.ДвиженияАктивовПассивов.ОтразитьДокументыВУправленческомБалансе(МассивВсехДокументов);
				КонецЕсли;// Необходимо формировать упр. баланс
				
				Запрос.Текст = "
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	РасчетыКОтражениюВУчете.Регистратор КАК Регистратор,
				|	РасчетыКОтражениюВУчете.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
				|	РасчетыКОтражениюВУчете.Период КАК Период
				|ПОМЕСТИТЬ РасчетыКОтражениюВУчете
				|ИЗ
				|	ПредварительныеРасчетыКОтражениюВУчете КАК РасчетыКОтражениюВУчете
				|ГДЕ
				|	РасчетыКОтражениюВУчете.Регистратор В (&МассивДокументов)";
				Запрос.УстановитьПараметр("МассивДокументов", МассивИзмененныхДокументов);
				Запрос.Выполнить();
				
				
				
				КоличествоДанных = КоличествоДанных + МассивВсехДокументов.Количество();
				
				Запрос = Новый Запрос;
				Запрос.Текст = РегистрыСведений.СуммыДокументовВВалютахУчета.ТекстЗапросаДокументовДляПересчета();
				Запрос.УстановитьПараметр("МассивДокументов", МассивВсехДокументов);
				Запрос.УстановитьПараметр("ЭтоПроверка", Истина);
				Запрос.УстановитьПараметр("ВалютаУпрУчета", Константы.ВалютаУправленческогоУчета.Получить());
				Запрос.УстановитьПараметр("НоваяАрхитектураВзаиморасчетов", Истина);
				Запрос.УстановитьПараметр("ПоВсемДокументам", Ложь);
				
				ТаблицаНерасчитанныхДокументов = Запрос.Выполнить().Выгрузить();
				
				//Попытка перепровести проблемные документы.
				Для Каждого СтрокаДокумента Из ТаблицаНерасчитанныхДокументов Цикл
					Попытка
						Если НЕ ЗначениеЗаполнено(СтрокаДокумента.РасчетныйДокумент) Тогда
							Продолжить;
						КонецЕсли;
						ДокументОбъект = СтрокаДокумента.РасчетныйДокумент.ПолучитьОбъект(); // ДокументОбъект
						ДокументОбъект.Записать(РежимЗаписиДокумента.Проведение);
					Исключение
						ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
							НСтр("ru = 'При формировании движений по данным взаиморасчетов за период %1 
								|при попытке перепроведения документа %2 произошла ошибка:
								|%3'"),
							РасчетСебестоимостиПротоколРасчета.ПредставлениеПериодаРасчета(ПараметрыРасчета.ПериодРегистрации),
							СтрокаДокумента.РасчетныйДокумент,
							ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
						ЗаписьЖурналаРегистрации(
							НСтр("ru = 'Попытка перепроведения документов'", ОбщегоНазначения.КодОсновногоЯзыка()),
							УровеньЖурналаРегистрации.Ошибка,
							Метаданные.ОбщиеМодули.ЗакрытиеМесяцаСервер,
							,
							ТекстОшибки);
					КонецПопытки;
				КонецЦикла;
				
				Если ТаблицаНерасчитанныхДокументов.Количество() > 0 Тогда
					
					Шаблон = НСтр("ru = 'Не удалось выполнить распределение суммы взаиморасчетов на строки документа %1.
						|Итоги движений документа по регистрам взаиморасчетов отличается от движений по регистру сумм документа в валютах учёта.
						|Попробуйте перепровести документ вручную.'", ОбщегоНазначения.КодОсновногоЯзыка());
					
					ПараметрыРегистрации = ЗакрытиеМесяцаСервер.ИнициализироватьПараметрыРегистрацииПроблемыРасчета(
						ПараметрыОбработчика.ДанныеЭтапа.Код,
						Организация,
						ПараметрыРасчета.ПериодРегистрации);
					
					Для Каждого СтрокаДокумента Из ТаблицаНерасчитанныхДокументов Цикл
						
						ГруппаПроблем = НСтр("ru = 'При выполнении операции были диагностированы ошибки'", ОбщегоНазначения.КодОсновногоЯзыка());
						
						ПолныйТекстПроблемы = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(Шаблон, СтрокаДокумента.РасчетныйДокумент);
						
						ЗакрытиеМесяцаСервер.ЗарегистрироватьПроблемуВыполненияРасчета(
							ПараметрыРегистрации,
							ГруппаПроблем,
							Перечисления.ВажностьПроблемыУчета.Ошибка,
							ПолныйТекстПроблемы,
							СтрокаДокумента.РасчетныйДокумент);
					КонецЦикла;
					
					БылиОшибки = Истина;
				КонецЕсли;
				
				Если БылиОшибки Тогда
					Возврат;
				КонецЕсли;
				
				#КонецОбласти
				
				//Переоценка на конец месяца или по дням если не было взаиморасчетов
				Документы.РасчетКурсовыхРазниц.ПереоценитьРасчетыСКлиентами(
					Организация,
					ОкончаниеПериода);
				Документы.РасчетКурсовыхРазниц.ПереоценитьРасчетыСПоставщиками(
					Организация,
					ОкончаниеПериода);
				
			КонецЦикла;
			
			ЗакрытиеМесяцаСервер.УдалитьЗаданияКРасчетуЗаТекущийПериод(ПараметрыОбработчика, ДанныеКРасчетуЗаМесяц);
		
			ТребуетсяПереоценка = Документы.РасчетКурсовыхРазниц.ТребуетсяПереоценкаВзаиморасчетов(
				ДоступныеОрганизации,
				ОкончаниеПериода);
			
			Если ТребуетсяПереоценка Тогда
				Документы.РасчетКурсовыхРазниц.ПереоценитьРасчетыСКлиентами(
					ДоступныеОрганизации,
					ОкончаниеПериода);
				Документы.РасчетКурсовыхРазниц.ПереоценитьРасчетыСПоставщиками(
					ДоступныеОрганизации,
					ОкончаниеПериода);
			КонецЕсли;
			
			НачалоРасчета = ОкончаниеПериода + 1;
			
		КонецЦикла;
		
		ОценкаПроизводительности.ЗакончитьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоДанных);
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область Модульность

// Возвращает структуру состояния взаиморасчетов.
// 
// Параметры:
// 	Объект - ФормаКлиентскогоПриложения - Описание:
// * Объект - СправочникСсылка, ДокументСсылка - Объект формы.
// 	СтруктураПараметров - см. ВзаиморасчетыСервер.ПараметрыМеханизма
// Возвращаемое значение:
// 	см. СтруктураСостоянияРасчетов
//
Функция СостояниеВзаиморасчетов(Объект, СтруктураПараметров) Экспорт
	
	ПутьКДаннымСуммаВзаиморасчетов = ?(СтруктураПараметров.СуммаВзаиморасчетов="",СтруктураПараметров.СуммаДокумента,СтруктураПараметров.СуммаВзаиморасчетов);
	СуммаВзаиморасчетов = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, ПутьКДаннымСуммаВзаиморасчетов,,0);
	Организация         = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Организация);
	ТипРасчетов         = СтруктураПараметров.ТипРасчетов;
	ПорядокРасчетов     = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ПорядокРасчетов);
	
	Если СтруктураПараметров.ЭтоЗаказ 
		И (ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоЗаказам
			Или ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоЗаказамНакладным)Тогда
		СсылкаНаЗаказ = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Ссылка);
		Если Метаданные.РегистрыСведений.СостоянияЗаказовКлиентов.Измерения.Заказ.Тип.СодержитТип(ТипЗнч(СсылкаНаЗаказ))
			Или Метаданные.РегистрыСведений.СостоянияЗаказовПоставщикам.Измерения.Заказ.Тип.СодержитТип(ТипЗнч(СсылкаНаЗаказ)) Тогда
			Результат = СостояниеВзаиморасчетовЗаказа(СсылкаНаЗаказ, ТипРасчетов);
			Если Результат <> Неопределено Тогда
				Возврат Результат;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	ОбъектРасчетов = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ОбъектРасчетов);
	Если ТипЗнч(ОбъектРасчетов) = Тип("Массив") Тогда
		ОбщегоНазначенияКлиентСервер.УдалитьВсеВхожденияЗначенияИзМассива(ОбъектРасчетов, ПредопределенноеЗначение("Справочник.ОбъектыРасчетов.ПустаяСсылка"));
		ОбъектРасчетов = ОбщегоНазначенияКлиентСервер.СвернутьМассив(ОбъектРасчетов);
		Если ОбъектРасчетов.Количество() = 1 Тогда
			ОбъектРасчетов = ОбъектРасчетов[0];
			СуммаВзаиморасчетов = 0;
		Иначе
			ОбъектРасчетов = Неопределено;
		КонецЕсли;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(ОбъектРасчетов) Тогда
		Если ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоДоговорамКонтрагентов Тогда
			Договор = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Договор);
			ОбъектРасчетов = ОбъектыРасчетовСервер.ПолучитьОбъектРасчетовПоСсылке(Договор, Организация, ТипРасчетов);
		ИначеЕсли ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоЗаказам Тогда 
			ЗаказОснование = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ЗаказОснование);
			ОбъектРасчетов = ОбъектыРасчетовСервер.ПолучитьОбъектРасчетовПоСсылке(ЗаказОснование, Организация, ТипРасчетов);
		КонецЕсли;
	КонецЕсли;
	
	ЭтоДоговорСНакладными = СтруктураПараметров.ЭтоСправочник 
	                        И СтруктураПараметров.Ссылка = СтруктураПараметров.Договор
	                        И ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоДоговорамНакладным;
	ЭтоЗаказСНакладными   = СтруктураПараметров.ЭтоЗаказ
	                        И ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоЗаказамНакладным;
	
	Возврат СостояниеВзаиморасчетовОбъектаРасчетов(ОбъектРасчетов, СуммаВзаиморасчетов, ТипРасчетов, Организация, ЭтоЗаказСНакладными, ЭтоДоговорСНакладными);
	
КонецФункции

// Параметры:
// 	ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов.
// 	СуммаВзаиморасчетов - Число - сумма взаиморасчетов для расчета процента платежей и отгрузки.
// 	ТипРасчетов - ПеречислениеСсылка.ТипыРасчетовСПартнерами - определяет по какому регистру смотреть состояние.
// 	Организация - СправочникСсылка.Организации - Организация по которой нужно смотреть состояние расчетов.
// 	ЭтоЗаказСНакладными - Булево - Признак, что объект расчетов - это заказ с детализацией расчетов ПоЗаказамНакладным
// 	ЭтоДоговорСНакладными - Булево - Признак, что объект расчетов - это договор с детализацией расчетов ПоДоговорамНакладным
// 	
// Возвращаемое значение:
// 	см. СтруктураСостоянияРасчетов
//
Функция СостояниеВзаиморасчетовОбъектаРасчетов(ОбъектРасчетов, СуммаВзаиморасчетов, ТипРасчетов, Организация = Неопределено, ЭтоЗаказСНакладными = Ложь, ЭтоДоговорСНакладными = Ложь) Экспорт
	
	СтруктураРасчетов = СтруктураСостоянияРасчетов();
	
	Если НЕ ЗначениеЗаполнено(ОбъектРасчетов)
		Или НЕ ПравоДоступа("Чтение", Метаданные.РегистрыНакопления.РасчетыСКлиентами) 
			И ТипРасчетов = ПредопределенноеЗначение("Перечисление.ТипыРасчетовСПартнерами.РасчетыСКлиентом")
		Или НЕ ПравоДоступа("Чтение", Метаданные.РегистрыНакопления.РасчетыСПоставщиками)
			И ТипРасчетов = ПредопределенноеЗначение("Перечисление.ТипыРасчетовСПартнерами.РасчетыСПоставщиком") Тогда
		Возврат СтруктураРасчетов;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("СуммаПервоначальныхВзаиморасчетов", СуммаВзаиморасчетов);
	Запрос.УстановитьПараметр("ОбъектРасчетов", ОбъектРасчетов);
	Запрос.УстановитьПараметр("ДанныеОтчета", 4);
	
	МассивТекстов = Новый Массив;

	ТекстПервоначальныхВзаиморасчетов = "
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ВЫБОР КОГДА &СуммаПервоначальныхВзаиморасчетов = 0
		|		ТОГДА ВЫБОР КОГДА ОбъектыРасчетов.СуммаВзаиморасчетов = 0
		|						ТОГДА ОбъектыРасчетов.Сумма
		|					ИНАЧЕ ОбъектыРасчетов.СуммаВзаиморасчетов
		|				КОНЕЦ
		|		ИНАЧЕ &СуммаПервоначальныхВзаиморасчетов
		|	КОНЕЦ КАК Сумма
		|ПОМЕСТИТЬ ВтСуммаПервоначальныхВзаиморасчетов
		|ИЗ
		|	Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
		|ГДЕ
		|	ОбъектыРасчетов.Ссылка = &ОбъектРасчетов";
	МассивТекстов.Добавить(ТекстПервоначальныхВзаиморасчетов);
	
	Если ТипРасчетов = ПредопределенноеЗначение("Перечисление.ТипыРасчетовСПартнерами.РасчетыСКлиентом") 
		И ПравоДоступа("Чтение", Метаданные.РегистрыНакопления.РасчетыСКлиентами) Тогда
		
		Если ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов") Тогда
			
			Если ЭтоЗаказСНакладными Тогда
				
				ТекстЗапроса = "
					|ВЫБРАТЬ РАЗРЕШЕННЫЕ
					|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетовНакладная,
					|	ОбъектыРасчетовЗаказ.Ссылка КАК ОбъектРасчетовЗаказ,
					|	ОбъектыРасчетовЗаказ.Объект КАК ЗаказКлиента,
					|	СУММА(ВЫБОР
					|			КОГДА ОбъектыРасчетов.СуммаВзаиморасчетов = 0
					|				ТОГДА ВЫБОР
					|					КОГДА ОбъектыРасчетов.Сумма = 0
					|						ТОГДА 0
					|					ИНАЧЕ РасчетыСКлиентамиОбороты.КОтгрузкеПриход / ОбъектыРасчетов.Сумма
					|				КОНЕЦ
					|			ИНАЧЕ РасчетыСКлиентамиОбороты.КОтгрузкеПриход / ОбъектыРасчетов.СуммаВзаиморасчетов
					|		КОНЕЦ) КАК ДоляЗаказа,
					|	МАКСИМУМ (ОбъектыРасчетовЗаказ.Сумма) КАК СуммаЗаказа
					|ПОМЕСТИТЬ ВтСвязьЗаказовНакладных
					|ИЗ
					|	РегистрНакопления.РасчетыСКлиентами.Обороты( , , Регистратор, ) КАК РасчетыСКлиентамиОбороты
					|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетовЗаказ
					|		ПО РасчетыСКлиентамиОбороты.ОбъектРасчетов = ОбъектыРасчетовЗаказ.Ссылка
					|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
					|		ПО РасчетыСКлиентамиОбороты.Регистратор = ОбъектыРасчетов.Объект
					|			И НЕ ОбъектыРасчетов.ПометкаУдаления
					|ГДЕ
					|	ОбъектыРасчетовЗаказ.Ссылка = &ОбъектРасчетов
					|
					|СГРУППИРОВАТЬ ПО
					|	ОбъектыРасчетов.Ссылка,
					|	ОбъектыРасчетовЗаказ.Ссылка,
					|	ОбъектыРасчетовЗаказ.Объект
					|";
				МассивТекстов.Добавить(ТекстЗапроса); 
				
				ТекстЗапроса = "
					|ВЫБРАТЬ РАЗРЕШЕННЫЕ
					|	ЕСТЬNULL(СУММА(Расчеты.СуммаОплат), 0) КАК СуммаОплат,
					|	ЕСТЬNULL(СУММА(Расчеты.СуммаОтгрузок), 0) КАК СуммаОтгрузок,
					|	ЕСТЬNULL(СУММА(Расчеты.СуммаЗадолженности), 0) КАК СуммаЗадолженности,
					|	0 КАК СуммаКорректировок,
					|	ЕСТЬNULL(МАКСИМУМ(Расчеты.СуммаПервоначальныхВзаиморасчетов), &СуммаПервоначальныхВзаиморасчетов) КАК СуммаПервоначальныхВзаиморасчетов
					|ПОМЕСТИТЬ ВтРасчеты
					|ИЗ (ВЫБРАТЬ
					|		&ШаблонПоляОплачено КАК СуммаОплат,
					|
					|		&ШаблонПоляОтгружено КАК СуммаОтгрузок,
					|
					|		ВЫБОР КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
					|			ТОГДА РасчетыПоСрокам.Долг
					|			ИНАЧЕ 0
					|		КОНЕЦ КАК СуммаЗадолженности,
					|
					|		ВЫБОР КОГДА &СуммаПервоначальныхВзаиморасчетов = 0
					|			ТОГДА ВЫБОР КОГДА ОбъектыРасчетов.СуммаВзаиморасчетов = 0
					|							ТОГДА ОбъектыРасчетов.Сумма
					|							ИНАЧЕ ОбъектыРасчетов.СуммаВзаиморасчетов
					|						КОНЕЦ
					|			ИНАЧЕ &СуммаПервоначальныхВзаиморасчетов
					|		КОНЕЦ КАК СуммаПервоначальныхВзаиморасчетов
					|
					|	ИЗ
					|			РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК РасчетыПоСрокам
					|				ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
					|				ПО РасчетыПоСрокам.ОбъектРасчетов = ОбъектыРасчетов.Ссылка
					|		ГДЕ
					|			ОбъектыРасчетов.Ссылка = &ОбъектРасчетов
					|			И РасчетыПоСрокам.АналитикаУчетаПоПартнерам.Организация = &Организация
					|			И РасчетыПоСрокам.Активность
					|	
					|	ОБЪЕДИНИТЬ ВСЕ
					|	
					|	ВЫБРАТЬ
					|		(&ШаблонПоляОплачено) * ВтСвязьЗаказовНакладных.ДоляЗаказа КАК СуммаОплат,
					|		0 КАК СуммаОтгрузок,
					|		0 КАК СуммаЗадолженности,
					|		ВЫБОР КОГДА &СуммаПервоначальныхВзаиморасчетов = 0
					|			ТОГДА ВтСвязьЗаказовНакладных.СуммаЗаказа
					|			ИНАЧЕ &СуммаПервоначальныхВзаиморасчетов
					|		КОНЕЦ КАК СуммаПервоначальныхВзаиморасчетов
					|	ИЗ
					|		РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК РасчетыПоСрокам
					|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтСвязьЗаказовНакладных КАК ВтСвязьЗаказовНакладных
					|			ПО РасчетыПоСрокам.ОбъектРасчетов = ВтСвязьЗаказовНакладных.ОбъектРасчетовНакладная 
					|	ГДЕ
					|		РасчетыПоСрокам.ОбъектРасчетов В (ВЫБРАТЬ
					|							Т.ОбъектРасчетовНакладная
					|						ИЗ
					|							ВтСвязьЗаказовНакладных КАК Т)
					|		И РасчетыПоСрокам.АналитикаУчетаПоПартнерам.Организация = &Организация
					|		И РасчетыПоСрокам.Активность
					|	) КАК Расчеты
					|";
				
			ИначеЕсли ЭтоДоговорСНакладными Тогда
				
				ТекстЗапроса = "
					|ВЫБРАТЬ РАЗРЕШЕННЫЕ
					|	ЕСТЬNULL(СУММА(&ШаблонПоляОплачено),0) КАК СуммаОплат,
					|
					|	ЕСТЬNULL(СУММА(&ШаблонПоляОтгружено),0) КАК СуммаОтгрузок,
					|
					|	ЕСТЬNULL(СУММА(ВЫБОР КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
					|		ТОГДА ВЫРАЗИТЬ(ЕСТЬNULL(РасчетыПоСрокам.Долг, 0) КАК ЧИСЛО(31,2))
					|		ИНАЧЕ 0
					|	КОНЕЦ),0) КАК СуммаЗадолженности,
					|
					|	0 КАК СуммаКорректировок,
					|
					|	ВЫБОР КОГДА &СуммаПервоначальныхВзаиморасчетов = 0
					|		ТОГДА МАКСИМУМ(ВЫБОР КОГДА РасчетыПоСрокам.ОбъектРасчетов.СуммаВзаиморасчетов = 0
					|							ТОГДА РасчетыПоСрокам.ОбъектРасчетов.Сумма
					|							ИНАЧЕ РасчетыПоСрокам.ОбъектРасчетов.СуммаВзаиморасчетов
					|						КОНЕЦ)
					|		ИНАЧЕ &СуммаПервоначальныхВзаиморасчетов
					|	КОНЕЦ КАК СуммаПервоначальныхВзаиморасчетов
					|
					|ПОМЕСТИТЬ ВтРасчеты
					|ИЗ
					|РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК РасчетыПоСрокам
					|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетовДоговора
					|	ПО РасчетыПоСрокам.ОбъектРасчетов = ОбъектыРасчетовДоговора.Ссылка
					|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
					|	ПО ОбъектыРасчетовДоговора.Договор = ОбъектыРасчетов.Договор
					|	И НЕ ОбъектыРасчетов.ПометкаУдаления
					|ГДЕ
					|	ОбъектыРасчетов.Ссылка = &ОбъектРасчетов
					|	И РасчетыПоСрокам.Активность
					|	И РасчетыПоСрокам.АналитикаУчетаПоПартнерам.Организация = &Организация
					|";
				
			Иначе
				
				ШаблонПоляСуммаКорректировок = "
					|ВЫБОР 
					|	КОГДА РасчетыПоСрокам.ОбъектРасчетов.ТипОбъектаРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыОбъектовРасчетов.Накладная)
					|		И ТИПЗНАЧЕНИЯ(РасчетыПоСрокам.ДокументРегистратор) = ТИП(Документ.КорректировкаРеализации)
					|		И НЕ РасчетыПоСрокам.Сторно
					|		ТОГДА 
					|			ВЫБОР
					|				КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
					|					ТОГДА Предоплата - Долг 
					|				ИНАЧЕ Долг - Предоплата
					|			КОНЕЦ
					|	ИНАЧЕ 0
					|КОНЕЦ
					|";
				
				ТекстЗапроса = "
					|ВЫБРАТЬ РАЗРЕШЕННЫЕ
					|	ЕСТЬNULL(СУММА(&ШаблонПоляОплачено),0) КАК СуммаОплат,
					|
					|	ЕСТЬNULL(СУММА(&ШаблонПоляОтгружено),0) КАК СуммаОтгрузок,
					|
					|	ЕСТЬNULL(СУММА(ВЫБОР КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
					|		ТОГДА РасчетыПоСрокам.Долг - РасчетыПоСрокам.Предоплата
					|		ИНАЧЕ РасчетыПоСрокам.Предоплата - РасчетыПоСрокам.Долг
					|	КОНЕЦ),0) КАК СуммаЗадолженности,
					|
					|	ЕСТЬNULL(СУММА(&ШаблонПоляСуммаКорректировок),0) КАК СуммаКорректировок,
					|
					|	ВЫБОР КОГДА &СуммаПервоначальныхВзаиморасчетов = 0
					|		ТОГДА МАКСИМУМ(ВЫБОР КОГДА РасчетыПоСрокам.ОбъектРасчетов.СуммаВзаиморасчетов = 0
					|							ТОГДА РасчетыПоСрокам.ОбъектРасчетов.Сумма
					|							ИНАЧЕ РасчетыПоСрокам.ОбъектРасчетов.СуммаВзаиморасчетов
					|						КОНЕЦ)
					|		ИНАЧЕ &СуммаПервоначальныхВзаиморасчетов
					|	КОНЕЦ КАК СуммаПервоначальныхВзаиморасчетов
					|
					|ПОМЕСТИТЬ ВтРасчеты
					|ИЗ
					|	РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК РасчетыПоСрокам
					|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
					|		ПО РасчетыПоСрокам.ОбъектРасчетов = ОбъектыРасчетов.Ссылка
					|ГДЕ
					|	ОбъектыРасчетов.Ссылка = &ОбъектРасчетов
					|	И РасчетыПоСрокам.АналитикаУчетаПоПартнерам.Организация = &Организация
					|	И РасчетыПоСрокам.Активность
					|";
				
			КонецЕсли;
			
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ШаблонПоляОплачено", СтрШаблон("%1 + %2", ШаблонПоляОплаченоКлиентом(), ШаблонПоляЗачтеноКлиенту())); 
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ШаблонПоляОтгружено", ШаблонПоляОтгруженоКлиенту());
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ШаблонПоляСуммаКорректировок", ШаблонПоляСуммаКорректировок);
			
			МассивТекстов.Добавить(ТекстЗапроса);
			
		Иначе
			ТекстЗапроса = "
				|ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	ЕСТЬNULL(СУММА(ВЫБОР КОГДА РасчетыОстаткиИОбороты.Регистратор ССЫЛКА Документ.КорректировкаРеализации
				|		ТОГДА 0
				|		ИНАЧЕ РасчетыОстаткиИОбороты.СуммаРасход
				|	КОНЕЦ),0) КАК СуммаОплат,
				|
				|	ЕСТЬNULL(СУММА(ВЫБОР КОГДА ЕСТЬNULL(РасчетыОстаткиИОбороты.СуммаПриход, 0) < 0
				|		ИЛИ РасчетыОстаткиИОбороты.Регистратор ССЫЛКА Документ.КорректировкаРеализации 
				|		ТОГДА 0
				|		ИНАЧЕ ВЫРАЗИТЬ(ЕСТЬNULL(РасчетыОстаткиИОбороты.СуммаПриход, 0) КАК ЧИСЛО(31,2))
				|	КОНЕЦ),0) КАК СуммаОтгрузок,
				|
				|	ЕСТЬNULL(СУММА(ВЫРАЗИТЬ(ЕСТЬNULL(РасчетыОстаткиИОбороты.СуммаПриход - РасчетыОстаткиИОбороты.СуммаРасход, 0) КАК ЧИСЛО(31,2))),0) КАК СуммаЗадолженности,
				|
				|	ЕСТЬNULL(СУММА(ВЫБОР КОГДА РасчетыОстаткиИОбороты.Регистратор ССЫЛКА Документ.КорректировкаРеализации
				|				И РасчетыОстаткиИОбороты.ОбъектРасчетов.ТипОбъектаРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыОбъектовРасчетов.Накладная)
				|		ТОГДА РасчетыОстаткиИОбороты.СуммаОборот
				|		ИНАЧЕ 0
				|	КОНЕЦ), 0) КАК СуммаКорректировок
				|
				|ПОМЕСТИТЬ ВтРасчеты
				|ИЗ
				|	РегистрНакопления.РасчетыСКлиентами.ОстаткиИОбороты(, , Регистратор, , ОбъектРасчетов = &ОбъектРасчетов) КАК РасчетыОстаткиИОбороты
				|ГДЕ
				|	РасчетыОстаткиИОбороты.АналитикаУчетаПоПартнерам.Организация = &Организация
				|";
			МассивТекстов.Добавить(ТекстЗапроса);
		КонецЕсли;
		
		ТекстЗапроса = "
			|ВЫБРАТЬ
			|	Расчеты.СуммаОплат         КАК СуммаОплат,
			|	Расчеты.СуммаОтгрузок      КАК СуммаОтгрузок,
			|	ВЫБОР КОГДА Расчеты.СуммаОплат = 0
			|		ИЛИ ВтСуммаПервоначальныхВзаиморасчетов.Сумма - Расчеты.СуммаКорректировок = 0
			|			ТОГДА 0
			|		ИНАЧЕ ВЫРАЗИТЬ(Расчеты.СуммаОплат * 100 / (ВтСуммаПервоначальныхВзаиморасчетов.Сумма - Расчеты.СуммаКорректировок) КАК ЧИСЛО(20, 2))
			|	КОНЕЦ                      КАК ПроцентОплат,
			|	ВЫБОР КОГДА Расчеты.СуммаОтгрузок = 0
			|		ИЛИ ВтСуммаПервоначальныхВзаиморасчетов.Сумма = 0
			|			ТОГДА 0
			|		ИНАЧЕ ВЫРАЗИТЬ(Расчеты.СуммаОтгрузок * 100 / ВтСуммаПервоначальныхВзаиморасчетов.Сумма КАК ЧИСЛО(20, 2))
			|	КОНЕЦ                      КАК ПроцентОтгрузок,
			|	Расчеты.СуммаЗадолженности КАК СуммаЗадолженности
			|ИЗ
			|	ВтСуммаПервоначальныхВзаиморасчетов КАК ВтСуммаПервоначальныхВзаиморасчетов
			|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтРасчеты КАК Расчеты
			|		ПО (ИСТИНА)";
		МассивТекстов.Добавить(ТекстЗапроса);
		
	ИначеЕсли ПравоДоступа("Чтение", Метаданные.РегистрыНакопления.РасчетыСПоставщиками) Тогда
		
		Если ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов") Тогда
			
			Если ЭтоЗаказСНакладными Тогда
				
				ТекстЗапроса = "
					|ВЫБРАТЬ РАЗРЕШЕННЫЕ
					|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетовНакладная,
					|	ОбъектыРасчетовЗаказ.Ссылка КАК ОбъектРасчетовЗаказ,
					|	ОбъектыРасчетовЗаказ.Объект КАК ЗаказПоставщику,
					|	СУММА(ВЫБОР
					|			КОГДА ОбъектыРасчетов.СуммаВзаиморасчетов = 0
					|				ТОГДА ВЫБОР
					|					КОГДА ОбъектыРасчетов.Сумма = 0
					|						ТОГДА 0
					|					ИНАЧЕ РасчетыСПоставщикамиОбороты.КПоступлениюРасход / ОбъектыРасчетов.Сумма
					|				КОНЕЦ
					|			ИНАЧЕ РасчетыСПоставщикамиОбороты.КПоступлениюРасход / ОбъектыРасчетов.СуммаВзаиморасчетов
					|		КОНЕЦ) КАК ДоляЗаказа,
					|	МАКСИМУМ (ОбъектыРасчетовЗаказ.Сумма) КАК СуммаЗаказа
					|ПОМЕСТИТЬ ВтСвязьЗаказовНакладных
					|ИЗ
					|	РегистрНакопления.РасчетыСПоставщиками.Обороты( , , Регистратор, ) КАК РасчетыСПоставщикамиОбороты
					|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетовЗаказ
					|		ПО РасчетыСПоставщикамиОбороты.ОбъектРасчетов = ОбъектыРасчетовЗаказ.Ссылка
					|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
					|		ПО РасчетыСПоставщикамиОбороты.Регистратор = ОбъектыРасчетов.Объект
					|		И НЕ ОбъектыРасчетов.ПометкаУдаления
					|ГДЕ
					|	ОбъектыРасчетовЗаказ.Ссылка = &ОбъектРасчетов
					|
					|СГРУППИРОВАТЬ ПО
					|	ОбъектыРасчетов.Ссылка,
					|	ОбъектыРасчетовЗаказ.Ссылка,
					|	ОбъектыРасчетовЗаказ.Объект
					|";
				МассивТекстов.Добавить(ТекстЗапроса); 
				
				ТекстЗапроса = "
					|ВЫБРАТЬ РАЗРЕШЕННЫЕ
					|	ЕСТЬNULL(СУММА(Расчеты.СуммаОплат), 0) КАК СуммаОплат,
					|	ЕСТЬNULL(СУММА(Расчеты.СуммаПоставок), 0) КАК СуммаПоставок,
					|	ЕСТЬNULL(СУММА(Расчеты.СуммаЗадолженности), 0) КАК СуммаЗадолженности,
					|	0 КАК СуммаКорректировок,
					|	ЕСТЬNULL(МАКСИМУМ(Расчеты.СуммаПервоначальныхВзаиморасчетов), &СуммаПервоначальныхВзаиморасчетов) КАК СуммаПервоначальныхВзаиморасчетов
					|ПОМЕСТИТЬ ВтРасчеты
					|ИЗ (ВЫБРАТЬ
					|		&ШаблонПоляОплачено КАК СуммаОплат,
					|
					|		&ШаблонПоляПоставлено КАК СуммаПоставок,
					|
					|		ВЫБОР КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
					|			ТОГДА РасчетыПоСрокам.Долг
					|			ИНАЧЕ 0
					|		КОНЕЦ КАК СуммаЗадолженности,
					|
					|		ВЫБОР КОГДА &СуммаПервоначальныхВзаиморасчетов = 0
					|			ТОГДА ВЫБОР КОГДА ОбъектыРасчетов.СуммаВзаиморасчетов = 0
					|							ТОГДА ОбъектыРасчетов.Сумма
					|							ИНАЧЕ ОбъектыРасчетов.СуммаВзаиморасчетов
					|						КОНЕЦ
					|			ИНАЧЕ &СуммаПервоначальныхВзаиморасчетов
					|		КОНЕЦ КАК СуммаПервоначальныхВзаиморасчетов
					|
					|	ИЗ
					|		РегистрНакопления.РасчетыСПоставщикамиПоСрокам КАК РасчетыПоСрокам
					|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
					|			ПО РасчетыПоСрокам.ОбъектРасчетов = ОбъектыРасчетов.Ссылка
					|	ГДЕ
					|		ОбъектыРасчетов.Ссылка = &ОбъектРасчетов
					|		И РасчетыПоСрокам.АналитикаУчетаПоПартнерам.Организация = &Организация
					|		И РасчетыПоСрокам.Активность
					|	
					|	ОБЪЕДИНИТЬ ВСЕ
					|	
					|	ВЫБРАТЬ
					|		(&ШаблонПоляОплачено) * ВтСвязьЗаказовНакладных.ДоляЗаказа КАК СуммаОплат, 
					|		0 КАК СуммаОтгрузок,
					|		0 КАК СуммаЗадолженности,
					|		ВЫБОР КОГДА &СуммаПервоначальныхВзаиморасчетов = 0
					|			ТОГДА ВтСвязьЗаказовНакладных.СуммаЗаказа
					|			ИНАЧЕ &СуммаПервоначальныхВзаиморасчетов
					|		КОНЕЦ КАК СуммаПервоначальныхВзаиморасчетов
					|	ИЗ
					|		РегистрНакопления.РасчетыСПоставщикамиПоСрокам КАК РасчетыПоСрокам
					|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтСвязьЗаказовНакладных КАК ВтСвязьЗаказовНакладных
					|			ПО РасчетыПоСрокам.ОбъектРасчетов = ВтСвязьЗаказовНакладных.ОбъектРасчетовНакладная 
					|	ГДЕ
					|		РасчетыПоСрокам.ОбъектРасчетов В (ВЫБРАТЬ
					|							Т.ОбъектРасчетовНакладная
					|						ИЗ
					|							ВтСвязьЗаказовНакладных КАК Т)
					|		И РасчетыПоСрокам.АналитикаУчетаПоПартнерам.Организация = &Организация
					|		И РасчетыПоСрокам.Активность
					|	) КАК Расчеты
					|";
				
			ИначеЕсли ЭтоДоговорСНакладными Тогда
				
				ТекстЗапроса = "
					|ВЫБРАТЬ РАЗРЕШЕННЫЕ
					|	ЕСТЬNULL(СУММА(&ШаблонПоляОплачено), 0) КАК СуммаОплат,
					|
					|	ЕСТЬNULL(СУММА(&ШаблонПоляПоставлено), 0) КАК СуммаПоставок,
					|
					|	ЕСТЬNULL(СУММА(ВЫБОР КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
					|			ТОГДА РасчетыПоСрокам.Долг
					|		ИНАЧЕ 0
					|	КОНЕЦ), 0) КАК СуммаЗадолженности,
					|
					|	0 КАК СуммаКорректировок,
					|
					|	ВЫБОР КОГДА &СуммаПервоначальныхВзаиморасчетов = 0
					|		ТОГДА МАКСИМУМ(ВЫБОР КОГДА РасчетыПоСрокам.ОбъектРасчетов.СуммаВзаиморасчетов = 0
					|							ТОГДА РасчетыПоСрокам.ОбъектРасчетов.Сумма
					|							ИНАЧЕ РасчетыПоСрокам.ОбъектРасчетов.СуммаВзаиморасчетов
					|						КОНЕЦ)
					|		ИНАЧЕ &СуммаПервоначальныхВзаиморасчетов
					|	КОНЕЦ КАК СуммаПервоначальныхВзаиморасчетов
					|
					|ПОМЕСТИТЬ ВтРасчеты
					|ИЗ
					|РегистрНакопления.РасчетыСПоставщикамиПоСрокам КАК РасчетыПоСрокам
					|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетовДоговора
					|	ПО РасчетыПоСрокам.ОбъектРасчетов = ОбъектыРасчетовДоговора.Ссылка
					|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
					|	ПО ОбъектыРасчетовДоговора.Договор = ОбъектыРасчетов.Договор
					|	И НЕ ОбъектыРасчетов.ПометкаУдаления
					|ГДЕ
					|	ОбъектыРасчетов.Ссылка  	= &ОбъектРасчетов
					|	И РасчетыПоСрокам.Активность
					|	И РасчетыПоСрокам.АналитикаУчетаПоПартнерам.Организация = &Организация
					|";
				
			Иначе
				ШаблонПоляСуммаКорректировок = "
					|ВЫБОР 
					|	КОГДА РасчетыПоСрокам.ОбъектРасчетов.ТипОбъектаРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыОбъектовРасчетов.Накладная)
					|		И ТИПЗНАЧЕНИЯ(РасчетыПоСрокам.ДокументРегистратор) = ТИП(Документ.КорректировкаПриобретения)
					|		И НЕ РасчетыПоСрокам.Сторно
					|		ТОГДА 
					|			ВЫБОР
					|				КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
					|					ТОГДА Предоплата - Долг 
					|				ИНАЧЕ Долг - Предоплата
					|			КОНЕЦ
					|	ИНАЧЕ 0
					|КОНЕЦ
					|";
				
				ТекстЗапроса = "
					|ВЫБРАТЬ РАЗРЕШЕННЫЕ
					|	ЕСТЬNULL(СУММА(&ШаблонПоляОплачено), 0) КАК СуммаОплат,
					|
					|	ЕСТЬNULL(СУММА(&ШаблонПоляПоставлено), 0) КАК СуммаПоставок,
					|
					|	ЕСТЬNULL(СУММА(ВЫБОР КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
					|			ТОГДА РасчетыПоСрокам.Долг - РасчетыПоСрокам.Предоплата
					|		ИНАЧЕ РасчетыПоСрокам.Предоплата - РасчетыПоСрокам.Долг
					|	КОНЕЦ), 0) КАК СуммаЗадолженности,
					|
					|	ЕСТЬNULL(СУММА(&ШаблонПоляСуммаКорректировок), 0) КАК СуммаКорректировок,
					|
					|	ВЫБОР КОГДА &СуммаПервоначальныхВзаиморасчетов = 0
					|		ТОГДА МАКСИМУМ(ВЫБОР КОГДА РасчетыПоСрокам.ОбъектРасчетов.СуммаВзаиморасчетов = 0
					|							ТОГДА РасчетыПоСрокам.ОбъектРасчетов.Сумма
					|							ИНАЧЕ РасчетыПоСрокам.ОбъектРасчетов.СуммаВзаиморасчетов
					|						КОНЕЦ)
					|		ИНАЧЕ &СуммаПервоначальныхВзаиморасчетов
					|	КОНЕЦ КАК СуммаПервоначальныхВзаиморасчетов
					|
					|ПОМЕСТИТЬ ВтРасчеты
					|ИЗ
					|	РегистрНакопления.РасчетыСПоставщикамиПоСрокам КАК РасчетыПоСрокам
					|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
					|		ПО РасчетыПоСрокам.ОбъектРасчетов = ОбъектыРасчетов.Ссылка
					|ГДЕ
					|	ОбъектыРасчетов.Ссылка = &ОбъектРасчетов
					|	И РасчетыПоСрокам.АналитикаУчетаПоПартнерам.Организация = &Организация
					|	И РасчетыПоСрокам.Активность
					|";
				
			КонецЕсли;
			
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ШаблонПоляОплачено", СтрШаблон("%1 + %2", ШаблонПоляОплаченоПоставщику(), ШаблонПоляЗачтеноПоставщиком())); 
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ШаблонПоляПоставлено", ШаблонПоляПоставленоПоставщиком());
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ШаблонПоляСуммаКорректировок", ШаблонПоляСуммаКорректировок);
			МассивТекстов.Добавить(ТекстЗапроса);
			
		Иначе
			ТекстЗапроса = "
				|ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	ЕСТЬNULL(СУММА(ВЫБОР КОГДА РасчетыОстаткиИОбороты.Регистратор ССЫЛКА Документ.КорректировкаПриобретения
				|			ТОГДА 0
				|		ИНАЧЕ РасчетыОстаткиИОбороты.СуммаПриход
				|	КОНЕЦ), 0) КАК СуммаОплат,
				|
				|	ЕСТЬNULL(СУММА(ВЫБОР КОГДА РасчетыОстаткиИОбороты.СуммаРасход < 0
				|					ИЛИ РасчетыОстаткиИОбороты.Регистратор ССЫЛКА Документ.КорректировкаПриобретения
				|			ТОГДА 0
				|		ИНАЧЕ РасчетыОстаткиИОбороты.СуммаРасход
				|	КОНЕЦ), 0) КАК СуммаПоставок,
				|
				|	ЕСТЬNULL(СУММА(РасчетыОстаткиИОбороты.СуммаРасход - РасчетыОстаткиИОбороты.СуммаПриход), 0) КАК СуммаЗадолженности,
				|
				|	ЕСТЬNULL(СУММА(ВЫБОР КОГДА РасчетыОстаткиИОбороты.Регистратор ССЫЛКА Документ.КорректировкаПриобретения
				|				И РасчетыОстаткиИОбороты.ОбъектРасчетов.ТипОбъектаРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыОбъектовРасчетов.Накладная)
				|		ТОГДА РасчетыОстаткиИОбороты.СуммаОборот
				|		ИНАЧЕ 0
				|	КОНЕЦ), 0) КАК СуммаКорректировок
				|
				|ПОМЕСТИТЬ ВтРасчеты
				|ИЗ
				|	РегистрНакопления.РасчетыСПоставщиками.ОстаткиИОбороты(, , Регистратор, , ОбъектРасчетов = &ОбъектРасчетов) КАК РасчетыОстаткиИОбороты
				|ГДЕ
				|	РасчетыОстаткиИОбороты.АналитикаУчетаПоПартнерам.Организация = &Организация
				|";
			МассивТекстов.Добавить(ТекстЗапроса);
		КонецЕсли;
		
		ТекстЗапроса = "
			|ВЫБРАТЬ
			|	Расчеты.СуммаОплат         КАК СуммаОплат,
			|	Расчеты.СуммаПоставок      КАК СуммаПоставок,
			|	ВЫБОР КОГДА Расчеты.СуммаОплат = 0
			|		ИЛИ ВтСуммаПервоначальныхВзаиморасчетов.Сумма - Расчеты.СуммаКорректировок = 0
			|			ТОГДА 0
			|		ИНАЧЕ ВЫРАЗИТЬ(Расчеты.СуммаОплат * 100 / (ВтСуммаПервоначальныхВзаиморасчетов.Сумма - Расчеты.СуммаКорректировок) КАК ЧИСЛО(20, 2))
			|	КОНЕЦ                      КАК ПроцентОплат,
			|	ВЫБОР КОГДА Расчеты.СуммаПоставок = 0
			|		ИЛИ ВтСуммаПервоначальныхВзаиморасчетов.Сумма = 0
			|			ТОГДА 0
			|		ИНАЧЕ ВЫРАЗИТЬ(Расчеты.СуммаПоставок* 100 / ВтСуммаПервоначальныхВзаиморасчетов.Сумма КАК ЧИСЛО(20, 2))
			|	КОНЕЦ                      КАК ПроцентПоставок,
			|	Расчеты.СуммаЗадолженности КАК СуммаЗадолженности
			|ИЗ
			|	ВтСуммаПервоначальныхВзаиморасчетов КАК ВтСуммаПервоначальныхВзаиморасчетов
			|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтРасчеты КАК Расчеты
			|		ПО (ИСТИНА)";
		МассивТекстов.Добавить(ТекстЗапроса);
		
	КонецЕсли;
	
	Запрос.Текст = СтрСоединить(МассивТекстов, ОбщегоНазначения.РазделительПакетаЗапросов());
	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		ЗаполнитьЗначенияСвойств(СтруктураРасчетов, Результат.Выгрузить()[0]);
	КонецЕсли;
	
	Возврат СтруктураРасчетов;
	
КонецФункции

#КонецОбласти

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область СлужебныеПроцедурыИФункцииДляВыбораДокументаРасчетов

// Параметры:
//  ВводПоСтроке - Булево - Флаг, отмечающий, что нужно выбрать первые 10
//  СтруктураОтбора - Структура
//  ЭтоТекстЗапросаДинамическогоСписка - Булево
//  ЭтоРасчетыСКлиентом  - Булево
//  ЭтоУИП - Булево
//  ТипОснования - Число - Возможные значения: 0 Документ
//                                             1 Договор с контрагентом
//                                             2 Договор между организациями.
// 
// Возвращаемое значение:
//  Строка - Текст запроса. 
//
Функция ТекстЗапросаВыбораОснованияПлатежа(ВводПоСтроке, СтруктураОтбора, ЭтоТекстЗапросаДинамическогоСписка, ЭтоРасчетыСКлиентом = Истина, ЭтоУИП = Ложь, ТипОснования = 0) Экспорт
	
	Если ТипОснования = 0 Тогда
		Если ЭтоРасчетыСКлиентом Тогда
			ТекстЗапроса = "
			|ВЫБРАТЬ РАЗЛИЧНЫЕ 
			|	РеестрДокументов.Ссылка                          КАК ОснованиеПлатежа,
			|	РеестрДокументов.ТипСсылки                       КАК ТипОснования,
			|	ЕСТЬNULL(МАКСИМУМ(ОбъектыРасчетов.Ссылка),
			|				ЗНАЧЕНИЕ(Справочник.ОбъектыРасчетов.ПустаяСсылка)) КАК ОбъектРасчетов,
			|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.РасчетыСКлиентом) КАК ТипРасчетов,
			|	ВЫБОР 
			|		КОГДА ТИПЗНАЧЕНИЯ(РеестрДокументов.Ссылка) = ТИП(Документ.СчетНаОплатуКлиенту)
			|			ТОГДА ВЫРАЗИТЬ(РеестрДокументов.Ссылка КАК Документ.СчетНаОплатуКлиенту).ДокументОснование
			//++ Локализация
			|		КОГДА ТИПЗНАЧЕНИЯ(РеестрДокументов.Ссылка) = ТИП(Документ.СчетФактураВыданный)
			|			ТОГДА ВЫРАЗИТЬ(РеестрДокументов.Ссылка КАК Документ.СчетФактураВыданный).ДокументОснование
			//-- Локализация
			|		ИНАЧЕ РеестрДокументов.Ссылка
			|	КОНЕЦ КАК ДокументОснование,
			|	ЕСТЬNULL(КлючиАналитикиУчетаПоПартнерам.Партнер, 
			|	         РеестрДокументов.Партнер)               КАК Партнер,
			|	РеестрДокументов.Организация                     КАК Организация,
			|	ЕСТЬNULL(КлючиАналитикиУчетаПоПартнерам.Контрагент, 
			|	         РеестрДокументов.Контрагент.Ключ)       КАК Контрагент,
			|	РеестрДокументов.Договор                         КАК Договор,
			|	ЕСТЬNULL(Договоры.РазрешенаРаботаСДочернимиПартнерами, ЛОЖЬ) КАК РазрешенаРаботаСДочернимиПартнерами,
			|	МАКСИМУМ(ОбъектыРасчетов.ВалютаВзаиморасчетов)   КАК ВалютаВзаиморасчетов,
			|	РеестрДокументов.НаправлениеДеятельности         КАК НаправлениеДеятельности, 
			|	МАКСИМУМ(&ИдентификаторПлатежа)                  КАК ИдентификаторПлатежа,
			|	РеестрДокументов.НомерДокументаИБ                КАК Номер,
			|	РеестрДокументов.ДатаДокументаИБ                 КАК Дата,
			|	РеестрДокументов.ДатаПервичногоДокумента         КАК ДатаВходящегоДокумента,
			|	РеестрДокументов.НомерПервичногоДокумента        КАК НомерВходящегоДокумента,
			|	РеестрДокументов.НаименованиеПервичногоДокумента КАК НаименованиеПервичногоДокумента,
			|	РеестрДокументов.Сумма                           КАК Сумма,
			|	РеестрДокументов.Валюта                          КАК Валюта,
			|	ВЫБОР
			|		КОГДА РеестрДокументов.Проведен
			|			ТОГДА 1
			|		КОГДА РеестрДокументов.ПометкаУдаления
			|			ТОГДА 2
			|		ИНАЧЕ 0
			|	КОНЕЦ                                            КАК Состояние
			|ИЗ
			|	РегистрСведений.РеестрДокументов КАК РеестрДокументов
			|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентами КАК РасчетыСКлиентами
			|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
			|			ПО РасчетыСКлиентами.ОбъектРасчетов = ОбъектыРасчетов.Ссылка
			|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПоПартнерам КАК КлючиАналитикиУчетаПоПартнерам
			|			ПО РасчетыСКлиентами.АналитикаУчетаПоПартнерам = КлючиАналитикиУчетаПоПартнерам.Ссылка
			|		ПО 
			|			ВЫБОР 
			|				КОГДА ТИПЗНАЧЕНИЯ(РеестрДокументов.Ссылка) = ТИП(Документ.СчетНаОплатуКлиенту)
			|					ТОГДА ВЫРАЗИТЬ(РеестрДокументов.Ссылка КАК Документ.СчетНаОплатуКлиенту).ДокументОснование
			//++ Локализация
			|				КОГДА ТИПЗНАЧЕНИЯ(РеестрДокументов.Ссылка) = ТИП(Документ.СчетФактураВыданный)
			|					ТОГДА ВЫРАЗИТЬ(РеестрДокументов.Ссылка КАК Документ.СчетФактураВыданный).ДокументОснование
			//-- Локализация
			|				ИНАЧЕ РеестрДокументов.Ссылка
			|			КОНЕЦ = РасчетыСКлиентами.Регистратор
			|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК Договоры
			|		ПО РеестрДокументов.Договор = Договоры.Ссылка
			|ГДЕ &ДинамическиеУсловия
			|
			|СГРУППИРОВАТЬ ПО
			|	РеестрДокументов.Ссылка,
			|	РеестрДокументов.ТипСсылки,
			|	РеестрДокументов.Организация,
			|	РеестрДокументов.Договор,
			|	ЕСТЬNULL(Договоры.РазрешенаРаботаСДочернимиПартнерами, ЛОЖЬ),
			|	РеестрДокументов.НаправлениеДеятельности,
			|	РеестрДокументов.НомерДокументаИБ,
			|	РеестрДокументов.ДатаДокументаИБ,
			|	РеестрДокументов.ДатаПервичногоДокумента,
			|	РеестрДокументов.НомерПервичногоДокумента,
			|	РеестрДокументов.НаименованиеПервичногоДокумента,
			|	РеестрДокументов.Сумма,
			|	РеестрДокументов.Валюта,
			|	ЕСТЬNULL(КлючиАналитикиУчетаПоПартнерам.Партнер, РеестрДокументов.Партнер),
			|	ЕСТЬNULL(КлючиАналитикиУчетаПоПартнерам.Контрагент, РеестрДокументов.Контрагент.Ключ),
			|	ВЫБОР
			|		КОГДА РеестрДокументов.Проведен
			|			ТОГДА 1
			|		КОГДА РеестрДокументов.ПометкаУдаления
			|			ТОГДА 2
			|		ИНАЧЕ 0
			|	КОНЕЦ";
		Иначе
			ТекстЗапроса = "
			|ВЫБРАТЬ РАЗЛИЧНЫЕ 
			|	РеестрДокументов.Ссылка                          КАК ОснованиеПлатежа,
			|	РеестрДокументов.ТипСсылки                       КАК ТипОснования,
			|	ЕСТЬNULL(МАКСИМУМ(ОбъектыРасчетов.Ссылка),
			|				ЗНАЧЕНИЕ(Справочник.ОбъектыРасчетов.ПустаяСсылка)) КАК ОбъектРасчетов,
			|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.РасчетыСПоставщиком) КАК ТипРасчетов,
			|	ВЫБОР 
			|		КОГДА ТИПЗНАЧЕНИЯ(РеестрДокументов.Ссылка) = ТИП(Документ.СчетНаОплатуКлиенту)
			|			ТОГДА ВЫРАЗИТЬ(РеестрДокументов.Ссылка КАК Документ.СчетНаОплатуКлиенту).ДокументОснование
			//++ Локализация
			|		КОГДА ТИПЗНАЧЕНИЯ(РеестрДокументов.Ссылка) = ТИП(Документ.СчетФактураВыданный)
			|			ТОГДА ВЫРАЗИТЬ(РеестрДокументов.Ссылка КАК Документ.СчетФактураВыданный).ДокументОснование
			//-- Локализация
			|		ИНАЧЕ РеестрДокументов.Ссылка
			|	КОНЕЦ КАК ДокументОснование,
			|	ЕСТЬNULL(КлючиАналитикиУчетаПоПартнерам.Партнер, 
			|	         РеестрДокументов.Партнер)               КАК Партнер,
			|	РеестрДокументов.Организация                     КАК Организация,
			|	ЕСТЬNULL(КлючиАналитикиУчетаПоПартнерам.Контрагент, 
			|	         РеестрДокументов.Контрагент.Ключ)       КАК Контрагент,
			|	РеестрДокументов.Договор                         КАК Договор,
			|	ЕСТЬNULL(Договоры.РазрешенаРаботаСДочернимиПартнерами, ЛОЖЬ) КАК РазрешенаРаботаСДочернимиПартнерами,
			|	МАКСИМУМ(ОбъектыРасчетов.ВалютаВзаиморасчетов)   КАК ВалютаВзаиморасчетов,
			|	РеестрДокументов.НаправлениеДеятельности         КАК НаправлениеДеятельности,
			|	МАКСИМУМ(&ИдентификаторПлатежа)                  КАК ИдентификаторПлатежа,
			|	РеестрДокументов.НомерДокументаИБ                КАК Номер,
			|	РеестрДокументов.ДатаДокументаИБ                 КАК Дата,
			|	РеестрДокументов.ДатаПервичногоДокумента         КАК ДатаВходящегоДокумента,
			|	РеестрДокументов.НомерПервичногоДокумента        КАК НомерВходящегоДокумента,
			|	РеестрДокументов.НаименованиеПервичногоДокумента КАК НаименованиеПервичногоДокумента,
			|	РеестрДокументов.Сумма                           КАК Сумма,
			|	РеестрДокументов.Валюта                          КАК Валюта,
			|	ВЫБОР
			|		КОГДА РеестрДокументов.Проведен
			|			ТОГДА 1
			|		КОГДА РеестрДокументов.ПометкаУдаления
			|			ТОГДА 2
			|		ИНАЧЕ 0
			|	КОНЕЦ                                            КАК Состояние
			|ИЗ
			|	РегистрСведений.РеестрДокументов КАК РеестрДокументов
			|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСПоставщиками КАК РасчетыСПоставщиками
			|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
			|			ПО РасчетыСПоставщиками.ОбъектРасчетов = ОбъектыРасчетов.Ссылка
			|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПоПартнерам КАК КлючиАналитикиУчетаПоПартнерам
			|			ПО РасчетыСПоставщиками.АналитикаУчетаПоПартнерам = КлючиАналитикиУчетаПоПартнерам.Ссылка
			|		ПО РеестрДокументов.Ссылка = РасчетыСПоставщиками.Регистратор
			|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК Договоры
			|		ПО РеестрДокументов.Договор = Договоры.Ссылка
			|ГДЕ &ДинамическиеУсловия
			|
			|СГРУППИРОВАТЬ ПО
			|	РеестрДокументов.Ссылка,
			|	РеестрДокументов.ТипСсылки,
			|	РеестрДокументов.Организация,
			|	РеестрДокументов.Договор,
			|	ЕСТЬNULL(Договоры.РазрешенаРаботаСДочернимиПартнерами, ЛОЖЬ),
			|	РеестрДокументов.НаправлениеДеятельности,
			|	РеестрДокументов.НомерДокументаИБ,
			|	РеестрДокументов.ДатаДокументаИБ,
			|	РеестрДокументов.ДатаПервичногоДокумента,
			|	РеестрДокументов.НомерПервичногоДокумента,
			|	РеестрДокументов.НаименованиеПервичногоДокумента,
			|	РеестрДокументов.Сумма,
			|	РеестрДокументов.Валюта,
			|	ЕСТЬNULL(КлючиАналитикиУчетаПоПартнерам.Партнер, РеестрДокументов.Партнер),
			|	ЕСТЬNULL(КлючиАналитикиУчетаПоПартнерам.Контрагент, РеестрДокументов.Контрагент.Ключ),
			|	ВЫБОР
			|		КОГДА РеестрДокументов.Проведен
			|			ТОГДА 1
			|		КОГДА РеестрДокументов.ПометкаУдаления
			|			ТОГДА 2
			|		ИНАЧЕ 0
			|	КОНЕЦ";
		КонецЕсли;
	ИначеЕсли ТипОснования = 1 Тогда
		ТекстЗапроса = "
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	Договоры.Ссылка                  КАК ОснованиеПлатежа,
			|	НЕОПРЕДЕЛЕНО                     КАК ТипОснования,
			|	ЕСТЬNULL(ОбъектыРасчетов.Ссылка, ЗНАЧЕНИЕ(Справочник.ОбъектыРасчетов.ПустаяСсылка))                КАК ОбъектРасчетов,
			|	ЕСТЬNULL(ОбъектыРасчетов.ТипРасчетов, ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.ПустаяСсылка)) КАК ТипРасчетов,
			|	НЕОПРЕДЕЛЕНО                     КАК ДокументОснование,
			|	Договоры.Партнер                 КАК Партнер,
			|	Договоры.Организация             КАК Организация,
			|	Договоры.Контрагент              КАК Контрагент,
			|	Договоры.Ссылка                  КАК Договор,
			|	Договоры.РазрешенаРаботаСДочернимиПартнерами КАК РазрешенаРаботаСДочернимиПартнерами,
			|	Договоры.ВалютаВзаиморасчетов    КАК ВалютаВзаиморасчетов,
			|	Договоры.НаправлениеДеятельности КАК НаправлениеДеятельности,
			|	Договоры.ИдентификаторПлатежа    КАК ИдентификаторПлатежа,
			|	Договоры.Номер                   КАК Номер,
			|	Договоры.Дата                    КАК Дата,
			|	Договоры.Дата                    КАК ДатаВходящегоДокумента,
			|	Договоры.Номер                   КАК НомерВходящегоДокумента,
			|	""""                             КАК НаименованиеПервичногоДокумента,
			|	Договоры.Сумма                   КАК Сумма,
			|	Договоры.ВалютаВзаиморасчетов    КАК Валюта,
			|	0                                КАК Состояние
			|ИЗ
			|	Справочник.ДоговорыКонтрагентов КАК Договоры
			|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
			|		ПО Договоры.Ссылка = ОбъектыРасчетов.Объект
			|			И НЕ ОбъектыРасчетов.ПометкаУдаления
			|ГДЕ &ДинамическиеУсловия";
	Иначе
		ТекстЗапроса = "
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	Договоры.Ссылка                               КАК ОснованиеПлатежа,
			|	НЕОПРЕДЕЛЕНО                                  КАК ТипОснования,
			|	ЕСТЬNULL(ОбъектыРасчетов.Ссылка, ЗНАЧЕНИЕ(Справочник.ОбъектыРасчетов.ПустаяСсылка))                КАК ОбъектРасчетов,
			|	ЕСТЬNULL(ОбъектыРасчетов.ТипРасчетов, ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.ПустаяСсылка)) КАК ТипРасчетов,
			|	НЕОПРЕДЕЛЕНО                                  КАК ДокументОснование,
			|	ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие) КАК Партнер,
			|	Договоры.Организация                          КАК Организация,
			|	Договоры.ОрганизацияПолучатель                КАК Контрагент,
			|	Договоры.Ссылка                               КАК Договор,
			|	ЛОЖЬ                                          КАК РазрешенаРаботаСДочернимиПартнерами,
			|	Договоры.ВалютаВзаиморасчетов                 КАК ВалютаВзаиморасчетов,
			|	Договоры.НаправлениеДеятельности              КАК НаправлениеДеятельности,
			|	Договоры.ИдентификаторПлатежа                 КАК ИдентификаторПлатежа,
			|	Договоры.Номер                                КАК Номер,
			|	Договоры.Дата                                 КАК Дата,
			|	Договоры.Дата                                 КАК ДатаВходящегоДокумента,
			|	Договоры.Номер                                КАК НомерВходящегоДокумента,
			|	""""                                          КАК НаименованиеПервичногоДокумента,
			|	Договоры.Сумма                                КАК Сумма,
			|	Договоры.ВалютаВзаиморасчетов                 КАК Валюта,
			|	0                                             КАК Состояние
			|ИЗ
			|	Справочник.ДоговорыМеждуОрганизациями КАК Договоры
			|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
			|		ПО Договоры.Ссылка = ОбъектыРасчетов.Объект
			|			И НЕ ОбъектыРасчетов.ПометкаУдаления
			|ГДЕ &ДинамическиеУсловия";
	КонецЕсли;
	
	Если ВводПоСтроке Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "РАЗЛИЧНЫЕ", "РАЗЛИЧНЫЕ ПЕРВЫЕ 10"); //@Query-part-1 @Query-part-2
	КонецЕсли;
	
	#Область ДинамическиеУсловия
	
	УсловияЗапроса = Новый Массив;
	УсловияЗапроса.Добавить("ИСТИНА");
	
	Если ТипОснования = 0 Тогда
		Если ЭтоТекстЗапросаДинамическогоСписка Тогда
			УсловияЗапроса.Добавить(
				"(РеестрДокументов.Организация В (&Организация)
				|ИЛИ НЕ &ЭтоГоловнаяОрганизация
				|	И РеестрДокументов.Договор В (&ЦентрализованныеДоговоры)
				|	И (РеестрДокументов.Организация = &ГоловнаяОрганизация
				|		ИЛИ ЕСТЬNULL(Договоры.РазрешаетсяПередачаОплатМеждуФилиалами, ЛОЖЬ))
				|ИЛИ &ЭтоГоловнаяОрганизация
				|	И РеестрДокументов.Организация.ГоловнаяОрганизация В (&Организация)
				|	И РеестрДокументов.Организация.ДопускаютсяВзаиморасчетыЧерезГоловнуюОрганизацию)");
		Иначе
			УсловияЗапроса.Добавить(
				"(РеестрДокументов.Организация В (&Организация)
				|ИЛИ НЕ &Организация В (ВЫБРАТЬ Т.ГоловнаяОрганизация ИЗ ВтГоловнаяОрганизация КАК Т)
				|	И РеестрДокументов.Договор В (ВЫБРАТЬ Т.Ссылка ИЗ ВтЦентрализованныеДоговоры КАК Т)
				|	И (РеестрДокументов.Организация В (ВЫБРАТЬ Т.ГоловнаяОрганизация ИЗ ВтГоловнаяОрганизация КАК Т)
				|		ИЛИ ЕСТЬNULL(Договоры.РазрешаетсяПередачаОплатМеждуФилиалами, ЛОЖЬ))
				|ИЛИ РеестрДокументов.Организация.ГоловнаяОрганизация В (&Организация)
				|	И РеестрДокументов.Организация.ДопускаютсяВзаиморасчетыЧерезГоловнуюОрганизацию)");
		КонецЕсли;
	ИначеЕсли ТипОснования = 1 Тогда
		Если ЭтоТекстЗапросаДинамическогоСписка Тогда
			УсловияЗапроса.Добавить(
				"(Договоры.Организация В (&Организация)
				|		ИЛИ НЕ &ЭтоГоловнаяОрганизация
				|			И Договоры.Ссылка В (&ЦентрализованныеДоговоры)
				|			И (Договоры.Организация = &ГоловнаяОрганизация
				|				ИЛИ Договоры.РазрешаетсяПередачаОплатМеждуФилиалами)
				|		ИЛИ &ЭтоГоловнаяОрганизация
				|			И Договоры.Организация.ГоловнаяОрганизация В (&Организация)
				|			И Договоры.Организация.ДопускаютсяВзаиморасчетыЧерезГоловнуюОрганизацию)
				|И Договоры.ТипДоговора В (&ТипыДоговоров)");
		Иначе
			УсловияЗапроса.Добавить(
				"(Договоры.Организация В (&Организация)
				|		ИЛИ НЕ &Организация В (ВЫБРАТЬ Т.ГоловнаяОрганизация ИЗ ВтГоловнаяОрганизация КАК Т)
				|			И Договоры.Ссылка В (ВЫБРАТЬ 
				|			                                 ВтЦентрализованныеДоговоры.Ссылка 
				|			                                 ИЗ ВтЦентрализованныеДоговоры)
				|			И (Договоры.Организация В (ВЫБРАТЬ Т.ГоловнаяОрганизация ИЗ ВтГоловнаяОрганизация КАК Т)
				|				ИЛИ Договоры.РазрешаетсяПередачаОплатМеждуФилиалами)
				|		ИЛИ Договоры.Организация.ГоловнаяОрганизация В (&Организация)
				|			И Договоры.Организация.ДопускаютсяВзаиморасчетыЧерезГоловнуюОрганизацию)
				|И Договоры.ТипДоговора В (&ТипыДоговоров)");
		КонецЕсли;
	ИначеЕсли ЭтоРасчетыСКлиентом Тогда
		УсловияЗапроса.Добавить("(Договоры.Организация = &Организация)");
	Иначе
		УсловияЗапроса.Добавить("(Договоры.ОрганизацияПолучатель = &Организация)");
	КонецЕсли;
	
	Если ТипОснования <> 0 Тогда
		УсловияЗапроса.Добавить("ЕСТЬNULL(ОбъектыРасчетов.ТипРасчетов, ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.ПустаяСсылка)) В (&ТипыРасчетовДоговоров)");
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СтруктураОтбора.Контрагент) Тогда
		Если ТипОснования = 0 Тогда
			УсловияЗапроса.Добавить("(ЕСТЬNULL(КлючиАналитикиУчетаПоПартнерам.Контрагент, РеестрДокументов.Контрагент.Ключ) В (&Контрагент) ИЛИ &ПоВсемКонтрагентам)");
		ИначеЕсли ТипОснования = 1 Тогда
			УсловияЗапроса.Добавить("(Договоры.Контрагент В (&Контрагент) ИЛИ &ПоВсемКонтрагентам)");
		ИначеЕсли ЭтоТекстЗапросаДинамическогоСписка Тогда
			Если ЭтоРасчетыСКлиентом Тогда
				УсловияЗапроса.Добавить("(Договоры.ОрганизацияПолучатель В (&Контрагент) ИЛИ &ПоВсемКонтрагентам)");
			Иначе
				УсловияЗапроса.Добавить("(Договоры.Организация В (&Контрагент) ИЛИ &ПоВсемКонтрагентам)");
			КонецЕсли;
		Иначе
			Если ЭтоРасчетыСКлиентом Тогда
				УсловияЗапроса.Добавить("Договоры.ОрганизацияПолучатель В (ВЫБРАТЬ Т.Ссылка ИЗ ВтОтборМеждуОрганизациями КАК Т)");
			Иначе
				УсловияЗапроса.Добавить("Договоры.Организация В (ВЫБРАТЬ Т.Ссылка ИЗ ВтОтборМеждуОрганизациями КАК Т)");
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если ТипОснования = 0 
		И (СтруктураОтбора.ТипыОснований.Количество() > 0
			Или ЭтоТекстЗапросаДинамическогоСписка) Тогда
		УсловияЗапроса.Добавить("ТИПЗНАЧЕНИЯ(РеестрДокументов.Ссылка) В(&ТипыОснований)");
	КонецЕсли;
	
	Если ТипОснования = 0 Тогда
		УсловияЗапроса.Добавить(?(ЭтоРасчетыСКлиентом,
				"(ТИПЗНАЧЕНИЯ(РеестрДокументов.Ссылка) 
				|	В (ТИП(Документ.СчетНаОплатуКлиенту)
				//++ Локализация
				|		, ТИП(Документ.СчетФактураВыданный)
				//-- Локализация
				|		)
				|		ИЛИ (ЕСТЬNULL(РасчетыСКлиентами.Сумма, РеестрДокументов.Сумма) <> 0
				|			ИЛИ ЕСТЬNULL(РасчетыСКлиентами.КОплате, 0) <> 0)
				|И (РасчетыСКлиентами.ВидДвижения ЕСТЬ NULL
				|	ИЛИ ВЫБОР
				|		КОГДА &ПодборДебиторскойЗадолженности
				|			ТОГДА ЕСТЬNULL(РасчетыСКлиентами.ВидДвижения, ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)) = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
				|		ИНАЧЕ ЕСТЬNULL(РасчетыСКлиентами.ВидДвижения, ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)) = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
				|	КОНЕЦ))"
				,"(ЕСТЬNULL(РасчетыСПоставщиками.Сумма, РеестрДокументов.Сумма) <> 0
				|		ИЛИ ЕСТЬNULL(РасчетыСПоставщиками.КОплате, 0) <> 0)
				|И (РасчетыСПоставщиками.ВидДвижения ЕСТЬ NULL
				|	ИЛИ ВЫБОР
				|		КОГДА &ПодборДебиторскойЗадолженности
				|			ТОГДА ЕСТЬNULL(РасчетыСПоставщиками.ВидДвижения, ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)) = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
				|		ИНАЧЕ ЕСТЬNULL(РасчетыСПоставщиками.ВидДвижения, ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)) = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
				|	КОНЕЦ)"
				));
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СтруктураОтбора.Текст) Тогда
		Если ВводПоСтроке Тогда
			Если ЭтоУИП Тогда
				Если ТипОснования <> 0 Тогда
					УсловияЗапроса.Добавить("Договоры.ИдентификаторПлатежа ПОДОБНО &СтрокаПоиска");
				ИначеЕсли ЭтоРасчетыСКлиентом Тогда
					УсловияЗапроса.Добавить("ВЫБОР 
						|		КОГДА ТИПЗНАЧЕНИЯ(РеестрДокументов.Ссылка) = ТИП(Документ.СчетНаОплатуКлиенту)
						|			ТОГДА ВЫРАЗИТЬ(РеестрДокументов.Ссылка КАК Документ.СчетНаОплатуКлиенту).ИдентификаторПлатежа
						//++ Локализация
						|		КОГДА ТИПЗНАЧЕНИЯ(РеестрДокументов.Ссылка) = ТИП(Документ.СчетФактураВыданный)
						|			ТОГДА ВЫРАЗИТЬ(РеестрДокументов.Ссылка КАК Документ.СчетФактураВыданный).ИдентификаторПлатежа
						//-- Локализация
						|		ИНАЧЕ ОбъектыРасчетов.ИдентификаторПлатежа
						|	КОНЕЦ ПОДОБНО &СтрокаПоиска");
				Иначе
					УсловияЗапроса.Добавить("ОбъектыРасчетов.ИдентификаторПлатежа ПОДОБНО &СтрокаПоиска");
				КонецЕсли;
			ИначеЕсли ТипОснования <> 0 Тогда
				УсловияЗапроса.Добавить("Договоры.Наименование ПОДОБНО &СтрокаПоиска");
			Иначе
				УсловияЗапроса.Добавить("РеестрДокументов.НомерДокументаИБ ПОДОБНО &СтрокаПоиска");
			КонецЕсли;
		Иначе
			Если ЭтоУИП Тогда
				Если ТипОснования <> 0 Тогда
					УсловияЗапроса.Добавить("Договоры.ИдентификаторПлатежа В (&СтрокаПоиска)");
				ИначеЕсли ЭтоРасчетыСКлиентом Тогда
					УсловияЗапроса.Добавить("ВЫБОР 
						|		КОГДА ТИПЗНАЧЕНИЯ(РеестрДокументов.Ссылка) = ТИП(Документ.СчетНаОплатуКлиенту)
						|			ТОГДА ВЫРАЗИТЬ(РеестрДокументов.Ссылка КАК Документ.СчетНаОплатуКлиенту).ИдентификаторПлатежа
						//++ Локализация
						|		КОГДА ТИПЗНАЧЕНИЯ(РеестрДокументов.Ссылка) = ТИП(Документ.СчетФактураВыданный)
						|			ТОГДА ВЫРАЗИТЬ(РеестрДокументов.Ссылка КАК Документ.СчетФактураВыданный).ИдентификаторПлатежа
						//-- Локализация
						|		ИНАЧЕ ОбъектыРасчетов.ИдентификаторПлатежа
						|	КОНЕЦ В (&СтрокаПоиска)");
				Иначе
					УсловияЗапроса.Добавить("ОбъектыРасчетов.ИдентификаторПлатежа В (&СтрокаПоиска)");
				КонецЕсли;
			ИначеЕсли ТипОснования <> 0 Тогда
				УсловияЗапроса.Добавить("Договоры.Номер В (&СтрокаПоиска)");
			Иначе
				УсловияЗапроса.Добавить("РеестрДокументов.НомерДокументаИБ В (&СтрокаПоиска)");
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если ТипОснования = 0 Тогда
		ПутьКИдентификаторуПлатежа = ?(ЭтоРасчетыСКлиентом,
			"ВЫБОР 
			|	КОГДА ТИПЗНАЧЕНИЯ(РеестрДокументов.Ссылка) = ТИП(Документ.СчетНаОплатуКлиенту)
			|		ТОГДА ВЫРАЗИТЬ(РеестрДокументов.Ссылка КАК Документ.СчетНаОплатуКлиенту).ИдентификаторПлатежа
			//++ Локализация
			|	КОГДА ТИПЗНАЧЕНИЯ(РеестрДокументов.Ссылка) = ТИП(Документ.СчетФактураВыданный)
			|		ТОГДА ВЫРАЗИТЬ(РеестрДокументов.Ссылка КАК Документ.СчетФактураВыданный).ИдентификаторПлатежа
			//-- Локализация
			|	ИНАЧЕ ОбъектыРасчетов.ИдентификаторПлатежа
			|КОНЕЦ", 
			"ОбъектыРасчетов.ИдентификаторПлатежа");
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ИдентификаторПлатежа", ПутьКИдентификаторуПлатежа);
	КонецЕсли;
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ДинамическиеУсловия", СтрСоединить(УсловияЗапроса, " И "));
	
	#КонецОбласти
	
	Возврат ТекстЗапроса;
	
КонецФункции

// Возвращаемое значение:
// 	Строка
//
Функция ТекстЗапросаВременныхТаблицДанныхВыбора() Экспорт
	
	ТекстЗапроса = "
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	Филиалы.Ссылка КАК Ссылка
		|ПОМЕСТИТЬ ВтЦентрализованныеДоговоры
		|ИЗ
		|	Справочник.ДоговорыКонтрагентов.Филиалы КАК Филиалы
		|ГДЕ
		|	Филиалы.Организация = &Организация
		|	И &УчитыватьФилиалы
		|;
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Организации.ГоловнаяОрганизация КАК ГоловнаяОрганизация
		|ПОМЕСТИТЬ ВтГоловнаяОрганизация
		|ИЗ 
		|	Справочник.Организации КАК Организации
		|ГДЕ 
		|	Организации.Ссылка = &Организация
		|	И &УчитыватьФилиалы
		|;
		|";
	
	Возврат ТекстЗапроса;
	
КонецФункции

// Возвращаемое значение:
// 	Строка
//
Функция ТекстЗапросаВыбораОбъектаРасчетов(ВводПоСтроке) Экспорт
	
	ТекстЗапроса = "
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ОбъектыРасчетов.Объект                  КАК ОснованиеПлатежа,
	|	ОбъектыРасчетов.Ссылка                  КАК ОбъектРасчетов,
	|	ОбъектыРасчетов.Объект                  КАК Объект,
	|	ОбъектыРасчетов.Партнер                 КАК Партнер,
	|	ОбъектыРасчетов.Организация             КАК Организация,
	|	ОбъектыРасчетов.Контрагент              КАК Контрагент,
	|	ОбъектыРасчетов.Договор                 КАК Договор,
	|	ОбъектыРасчетов.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ОбъектыРасчетов.ВалютаВзаиморасчетов    КАК ВалютаВзаиморасчетов,
	|	ОбъектыРасчетов.ИдентификаторПлатежа    КАК ИдентификаторПлатежа,
	|	ОбъектыРасчетов.Номер                   КАК Номер,
	|	ОбъектыРасчетов.Дата                    КАК Дата,
	|	ОбъектыРасчетов.ДатаВходящегоДокумента  КАК ДатаВходящегоДокумента,
	|	ОбъектыРасчетов.НомерВходящегоДокумента КАК НомерВходящегоДокумента,
	|	ОбъектыРасчетов.Сумма                   КАК СуммаЗаказа,
	|	0                                       КАК СуммаПлатежа,
	|	ОбъектыРасчетов.Валюта                  КАК Валюта,
	|	ОбъектыРасчетов.Состояние               КАК Состояние,
	|	ОбъектыРасчетов.ПометкаУдаления         КАК ПометкаУдаления,
	|	ЕСТЬNULL(Договоры.ЦентрализованныйДоговор, ЛОЖЬ) КАК ЦентрализованныйДоговор, 
	|	ЕСТЬNULL(Договоры.ДоговорСКомиссионером.ВестиРасчетыЧерезКонечныхПокупателей, ЛОЖЬ) КАК КомиссияЧерезКонечныхПокупателей,
	|	ЕСТЬNULL(Договоры.РазрешенаРаботаСДочернимиПартнерами, ЛОЖЬ) КАК РазрешенаРаботаСДочернимиПартнерами,
	|	ОбъектыРасчетов.ТипРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.РасчетыСКлиентом) КАК ЭтоРасчетыСКлиентами
	|ИЗ
	|	Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК Договоры
	|		ПО ОбъектыРасчетов.Договор = Договоры.Ссылка
	|ГДЕ &ДинамическиеУсловия
	|	И НЕ ОбъектыРасчетов.ПометкаУдаления
	|";
	
	Если ВводПоСтроке Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ВЫБРАТЬ РАЗРЕШЕННЫЕ", "ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 10"); //@Query-part-1 @Query-part-2
	КонецЕсли;
	
	Возврат ТекстЗапроса;
	
КонецФункции

// Возвращает параметры, используемые при выборе документа расчетов с клиентами.
// Используется в общей форме "ВыборДокументаРасчетов" и в обработке получения данных выбора основания платежа.
// 
// Возвращаемое значение: 
// Структура :
//	* ВводПоСтроке - Булево - Признак получения данных выбора.
//	* ЭтоУИП - Булево - Поиск документа расчетов осуществляется по УИП.
//	* ОтборПоОрганизацииИКонтрагенту - Булево - Есть отбор по организации и контрагенту.
//	* ИсключитьРедактируемыйДокумент - Булево - Не включать документ из которого вызывается подбор в данные выбора.
//	* ЗапретитьДоговорыПоДокументам - Булево - Запретить договоры с порядком расчетов "по заказам/накладным".
//
Функция ПараметрыОтбораПриВыбореДокументаРасчетовСКлиентами() Экспорт 
	
	ПараметрыОтбора = Новый Структура;
	ПараметрыОтбора.Вставить("ВводПоСтроке",                   Ложь);
	ПараметрыОтбора.Вставить("ЭтоУИП",                         Ложь);
	ПараметрыОтбора.Вставить("ОтборПоОрганизацииИКонтрагенту", Ложь);
	ПараметрыОтбора.Вставить("ИсключитьРедактируемыйДокумент", Ложь);
	ПараметрыОтбора.Вставить("ЗапретитьДоговорыПоДокументам",  Ложь);
	
	Возврат ПараметрыОтбора;
	
КонецФункции


// Структура выбранного значения.
// 
// Возвращаемое значение:
// Структура: 
// 	* ОснованиеПлатежа - ДокументСсылка, Неопределено
// 	* ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов
// 	* ДокументОснование - ДокументСсылка, Неопределено
// 	* Партнер - СправочникСсылка.Партнеры
// 	* Контрагент - СправочникСсылка.Контрагенты
// 	* ИдентификаторПлатежа - Строка
// 	* ВалютаВзаиморасчетов - СправочникСсылка.Валюты
// 	* ЭтоРасчетыСКлиентами - Булево
// 	* СуммаПлатежа - Число
// 	* СуммаЗаказа - Число
// 	* Договор - СправочникСсылка.ДоговорыКонтрагентов, СправочникСсылка.ДоговорыМеждуОрганизациями, Неопределено - Договор выбранного документа
// 	* Организация - СправочникСсылка.Организации
// 	* ДатаПогашения - Дата
// 	* ДатаПлатежа - Дата
// 	* Дата - Дата
// 	* ЦентрализованныйДоговор - Булево
// 	* КомиссияЧерезКонечныхПокупателей - Булево
// 	* РазрешенаРаботаСДочернимиПартнерами - Булево
// 	* Объект - ОпределяемыйТип.ОбъектРасчетов
//  
Функция СтруктураЗначениеВыбора()
	
	ЗначениеВыбора = Новый Структура;
	
	ЗначениеВыбора.Вставить("ОснованиеПлатежа", Неопределено);
	ЗначениеВыбора.Вставить("ОбъектРасчетов", Справочники.ОбъектыРасчетов.ПустаяСсылка());
	ЗначениеВыбора.Вставить("ДокументОснование", Неопределено);
	ЗначениеВыбора.Вставить("Партнер", Справочники.Партнеры.ПустаяСсылка());
	ЗначениеВыбора.Вставить("Контрагент", Справочники.Контрагенты.ПустаяСсылка());
	ЗначениеВыбора.Вставить("ИдентификаторПлатежа", "");
	ЗначениеВыбора.Вставить("ВалютаВзаиморасчетов", Справочники.Валюты.ПустаяСсылка());
	ЗначениеВыбора.Вставить("ЭтоРасчетыСКлиентами", Ложь);
	ЗначениеВыбора.Вставить("СуммаПлатежа", 0);
	ЗначениеВыбора.Вставить("СуммаЗаказа", 0);
	ЗначениеВыбора.Вставить("Договор", Неопределено);
	ЗначениеВыбора.Вставить("Организация", Справочники.Организации.ПустаяСсылка());
	ЗначениеВыбора.Вставить("ДатаПогашения", Дата(1, 1, 1));
	ЗначениеВыбора.Вставить("ДатаПлатежа", Дата(1, 1, 1));
	ЗначениеВыбора.Вставить("Дата", Дата(1, 1, 1));
	ЗначениеВыбора.Вставить("ЦентрализованныйДоговор", Ложь);
	ЗначениеВыбора.Вставить("КомиссияЧерезКонечныхПокупателей", Ложь);
	ЗначениеВыбора.Вставить("РазрешенаРаботаСДочернимиПартнерами", Ложь);
	ЗначениеВыбора.Вставить("Объект", Неопределено);
	
	Возврат ЗначениеВыбора;
	
КонецФункции

// Дополнить структуру объектом расчетов и валютой взаиморасчетов.
// 
// Параметры:
//  РезультатВыбора - см. СтруктураЗначениеВыбора
Процедура ДополнитьСтруктуруОбъектомРасчетовИВалютойВзаиморасчетов(РезультатВыбора) Экспорт
	
	СсылкаДляПоиска = РезультатВыбора.ОснованиеПлатежа;
	Если РезультатВыбора.Свойство("ДокументОснование") И ЗначениеЗаполнено(РезультатВыбора.ДокументОснование) Тогда
		СсылкаДляПоиска = РезультатВыбора.ДокументОснование;
	КонецЕсли;
	ОбъектРасчетов = ВзаиморасчетыСервер.ОбъектРасчетовПоСсылке(СсылкаДляПоиска);
	ОбъектРасчетов = ОбъектыРасчетовСервер.ПолучитьОбъектРасчетовПоСсылке(ОбъектРасчетов);
	ВалютаВзаиморасчетов = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ОбъектРасчетов, "ВалютаВзаиморасчетов");
	
	РезультатВыбора.Вставить("ОбъектРасчетов", ОбъектРасчетов);
	РезультатВыбора.Вставить("ВалютаВзаиморасчетов", ВалютаВзаиморасчетов);
	
КонецПроцедуры

#КонецОбласти

#Область ПрочиеПроцедурыИФункции

// Определяет необходимость запуска прямого пересчета графика платежей по расчетам с клиентами и поставщиками,
//                                                      если включено отложенное распределение взаиморасчетов.
//
Функция ВыполнятьПересчетГрафикаПлатежей(ПараметрыИзменений,
	                                     МенеджерВременныхТаблиц,
	                                     ЕстьИзмененияРасчетовСКлиентами,
	                                     ЕстьИзмененияРасчетовСПоставщиками)
		
	Если Не ПараметрыИзменений.РасчетПлановФоновымЗаданием Тогда
		Возврат Истина;
	КонецЕсли;
		
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
		
	Если ЕстьИзмененияРасчетовСПоставщиками Тогда
		
		Запрос.Текст =
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	Изменения.Документ КАК Документ
		|ИЗ
		|	РасчетыСПоставщикамиИзменения КАК Изменения
		|ГДЕ
		|	Изменения.Оплачивается <> 0
		|	И Изменения.Сумма = 0
		|	И Изменения.СуммаРегл = 0
		|	И Изменения.СуммаУпр = 0
		|	И Изменения.КОплате = 0
		|	И Изменения.КПоступлению = 0";
		
		Результат = Запрос.Выполнить();
		ЕстьИзмененияРасчетовСПоставщиками = Не Результат.Пустой();
		
	КонецЕсли;
	
	Если ЕстьИзмененияРасчетовСКлиентами Тогда
		
		Запрос.Текст =
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	Изменения.Документ КАК Документ
		|ИЗ
		|	РасчетыСКлиентамиИзменения КАК Изменения
		|ГДЕ
		|	Изменения.Оплачивается <> 0
		|	И Изменения.Сумма = 0
		|	И Изменения.СуммаРегл = 0
		|	И Изменения.СуммаУпр = 0
		|	И Изменения.КОплате = 0
		|	И Изменения.КОтгрузке = 0";
		
		Результат = Запрос.Выполнить();
		ЕстьИзмененияРасчетовСКлиентами = Не Результат.Пустой();
		
	КонецЕсли;
	
	Возврат ЕстьИзмененияРасчетовСПоставщиками ИЛИ ЕстьИзмененияРасчетовСКлиентами;
	
КонецФункции

// Возвращаемое значение:
// 	Строка - Текст предупреждения
Функция ТекстПредупрежденияЗагрузкаДокументовВзаиморасчетов() Экспорт
	
	Если ОбновлениеИнформационнойБазы.ОтложенноеОбновлениеЗавершено() Тогда
	
		ТекстПричины =  СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Выполняется загрузка документов взаиморасчетов (включена константа ""%1"")
					|Необходимо дождаться завершения загрузки документов и повторить операцию.'", ОбщегоНазначения.КодОсновногоЯзыка()),
					Метаданные.Константы.РаспределятьФактическиеРасчетыФоновымЗаданием.Синоним);
		
	Иначе
		
		ТекстПричины =  СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Выполняется отложенное обновление взаиморасчетов (включена константа ""%1"")
					|Необходимо дождаться завершения обновления и повторить операцию.'", ОбщегоНазначения.КодОсновногоЯзыка()),
					Метаданные.Константы.РаспределятьФактическиеРасчетыФоновымЗаданием.Синоним);
		
	КонецЕсли;
	
	Возврат ТекстПричины;
	
КонецФункции

Функция ТекстЗапросаПоОстаткамРасчетовСПоставщиками(ПоДатамПлатежей)
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.РасчетыСПоставщиком) КАК ТипРасчетов,
		|	ЛОЖЬ                                    КАК Выбран,
		|	0                                       КАК Сумма,
		|	ДАТАВРЕМЯ(1, 1, 1)                      КАК ДатаПогашения,
		|	&ВалютаДокумента                        КАК ВалютаДокумента,
		|	ОбъектыРасчетов.Дата                    КАК Дата,
		|	ОбъектыРасчетов.Номер                   КАК Номер,
		|	ОбъектыРасчетов.Ссылка                  КАК ОбъектРасчетов,
		|	ОбъектыРасчетов.ИдентификаторПлатежа    КАК ИдентификаторПлатежа,
		|	ДанныеРасчетов.ВалютаВзаиморасчетов    КАК ВалютаВзаиморасчетов,
		|	ДанныеРасчетов.Организация              КАК Организация,
		|	ДанныеРасчетов.Партнер                  КАК Партнер,
		|	ОбъектыРасчетов.Контрагент              КАК Контрагент,
		|	ОбъектыРасчетов.Договор                 КАК Договор,
		|	ОбъектыРасчетов.Объект                  КАК Объект,
		|	ОбъектыРасчетов.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	ОбъектыРасчетов.Подразделение           КАК Подразделение,
		|	ЕСТЬNULL(ЕСТЬNULL(ДоговорыКонтрагентов.ВариантКурсаДоговора, ДоговорыМеждуОрганизациями.ВариантКурсаДоговора), ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.Переменный)) КАК ВариантКурсаДоговора,
		|	ВЫБОР
		|		КОГДА ЕСТЬNULL(ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств, ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
		|			ТОГДА ВЫБОР
		|					КОГДА ЕСТЬNULL(ОбъектыРасчетов.Соглашение.СтатьяДвиженияДенежныхСредств, ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
		|						ТОГДА &СтатьяДвиженияДенежныхСредств
		|					ИНАЧЕ ОбъектыРасчетов.Соглашение.СтатьяДвиженияДенежныхСредств
		|				КОНЕЦ
		|		ИНАЧЕ ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств
		|	КОНЕЦ                                   КАК СтатьяДвиженияДенежныхСредств,
		|	ЕСТЬNULL(ОбъектыРасчетов.Договор.ПлатежиПо275ФЗ, ЛОЖЬ) КАК ПлатежиПо275ФЗ,
		|	СУММА(ДанныеРасчетов.ДолгПартнера)      КАК ДолгПартнера,
		|	СУММА(ДанныеРасчетов.КОплате)           КАК КОплате,
		|	0                                       КАК Оплачивается,
		|	СУММА(ДанныеРасчетов.НашДолг)           КАК НашДолг,
		|	&ДатаПлатежа                            КАК ДатаПлатежа,
		|	ОбъектыРасчетов.ОперацияССамозанятым    КАК ОперацияССамозанятым
		|ИЗ
		|	(ВЫБРАТЬ
		|		РасчетыСПоставщиками.ОбъектРасчетов                        КАК ОбъектРасчетов,
		|		РасчетыСПоставщиками.Валюта                                КАК ВалютаВзаиморасчетов,
		|		РасчетыСПоставщиками.АналитикаУчетаПоПартнерам.Организация КАК Организация,
		|		РасчетыСПоставщиками.АналитикаУчетаПоПартнерам.Партнер     КАК Партнер,
		|		РасчетыСПоставщиками.ПредоплатаОстаток                     КАК ДолгПартнера,
		|		РасчетыСПоставщиками.КОплате                               КАК КОплате,
		|		0                                                          КАК Оплачивается,
		|		РасчетыСПоставщиками.ДолгОстаток                           КАК НашДолг,
		|		РасчетыСПоставщиками.ДатаПлановогоПогашения                КАК ДатаПлатежа
		|	ИЗ
		|		РасчетыСПоставщикамиПоСрокамОстатки КАК РасчетыСПоставщиками
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		РасчетыСПоставщиками.ОбъектРасчетов                        КАК ОбъектРасчетов,
		|		РасчетыСПоставщиками.Валюта                                КАК ВалютаВзаиморасчетов,
		|		РасчетыСПоставщиками.АналитикаУчетаПоПартнерам.Организация КАК Организация,
		|		РасчетыСПоставщиками.АналитикаУчетаПоПартнерам.Партнер     КАК Партнер,
		|		0                                                          КАК ДолгПартнера,
		|		РасчетыСПоставщиками.КОплатеОстаток                        КАК КОплате,
		|		0                                                          КАК Оплачивается,
		|		0                                                          КАК НашДолг,
		|		РасчетыСПоставщиками.ДатаПлановогоПогашения                КАК ДатаПлатежа
		|	ИЗ
		|		РасчетыСПоставщикамиПланОплатОстатки КАК РасчетыСПоставщиками
		|		) КАК ДанныеРасчетов
		| 			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
		|				ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
		|				ПО ОбъектыРасчетов.Договор = ДоговорыКонтрагентов.Ссылка
		|				ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыМеждуОрганизациями КАК ДоговорыМеждуОрганизациями
		|				ПО ОбъектыРасчетов.Договор = ДоговорыМеждуОрганизациями.Ссылка
		|			ПО ДанныеРасчетов.ОбъектРасчетов = ОбъектыРасчетов.Ссылка
		|ГДЕ
		|	НЕ ОбъектыРасчетов.Объект ССЫЛКА Справочник.ПодарочныеСертификаты
		|
		|СГРУППИРОВАТЬ ПО
		|	ОбъектыРасчетов.Дата,
		|	ОбъектыРасчетов.Номер,
		|	ОбъектыРасчетов.Ссылка,
		|	ОбъектыРасчетов.ИдентификаторПлатежа,
		|	ДанныеРасчетов.ВалютаВзаиморасчетов,
		|	ДанныеРасчетов.Организация,
		|	ДанныеРасчетов.Партнер,
		|	ОбъектыРасчетов.Контрагент,
		|	ОбъектыРасчетов.Договор,
		|	ОбъектыРасчетов.Объект,
		|	ОбъектыРасчетов.НаправлениеДеятельности,
		|	ОбъектыРасчетов.Подразделение,
		|	ДанныеРасчетов.ДатаПлатежа,
		|	ЕСТЬNULL(ЕСТЬNULL(ДоговорыКонтрагентов.ВариантКурсаДоговора, ДоговорыМеждуОрганизациями.ВариантКурсаДоговора), ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.Переменный)),
		|	ВЫБОР
		|		КОГДА ЕСТЬNULL(ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств, ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
		|			ТОГДА ВЫБОР
		|					КОГДА ЕСТЬNULL(ОбъектыРасчетов.Соглашение.СтатьяДвиженияДенежныхСредств, ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
		|						ТОГДА &СтатьяДвиженияДенежныхСредств
		|					ИНАЧЕ ОбъектыРасчетов.Соглашение.СтатьяДвиженияДенежныхСредств
		|				КОНЕЦ
		|		ИНАЧЕ ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств
		|	КОНЕЦ,
		|	ЕСТЬNULL(ОбъектыРасчетов.Договор.ПлатежиПо275ФЗ, ЛОЖЬ),
		|	ОбъектыРасчетов.ОперацияССамозанятым
		|
		|УПОРЯДОЧИТЬ ПО
		|	Организация,
		|	Контрагент,
		|	&ДатаПлатежа,
		|	Дата,
		|	Номер
		|;
		|
		|ВЫБРАТЬ
		|	РасчетыСПоставщиками.ОбъектРасчетов КАК ОбъектРасчетов,
		|	РасчетыСПоставщиками.Валюта КАК ВалютаВзаиморасчетов,
		|	РасчетыСПоставщиками.АналитикаУчетаПоПартнерам.Организация КАК Организация,
		|	РасчетыСПоставщиками.АналитикаУчетаПоПартнерам.Контрагент КАК Контрагент,
		|	РасчетыСПоставщиками.АналитикаУчетаПоПартнерам.Партнер КАК Партнер,
		|	-РасчетыСПоставщиками.ОплачиваетсяОстаток КАК Сумма
		|ИЗ
		|	РегистрНакопления.РасчетыСПоставщиками.Остатки(
		|			,
		|			НЕ &ДебиторскаяЗадолженность
		|			И НЕ &ТолькоБезусловнаяЗадолженность
		|			И ОбъектРасчетов В
		|				(ВЫБРАТЬ
		|					ОбъектыРасчетов.ОбъектРасчетов
		|				ИЗ
		|					ОбъектыРасчетов КАК ОбъектыРасчетов)) КАК РасчетыСПоставщиками
		|ГДЕ
		|	РасчетыСПоставщиками.ОплачиваетсяОстаток < 0
		|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ДанныеРасчетов.ДатаПлатежа,", ?(ПоДатамПлатежей, "ДанныеРасчетов.ДатаПлатежа,", ""));
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ДатаПлатежа", ?(ПоДатамПлатежей, "ДанныеРасчетов.ДатаПлатежа", "МИНИМУМ(ДанныеРасчетов.ДатаПлатежа)"));
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаПоОстаткамРасчетовСКлиентами(ПоДатамПлатежей)
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.РасчетыСКлиентом) КАК ТипРасчетов,
		|	ЛОЖЬ                                    КАК Выбран,
		|	0                                       КАК Сумма,
		|	ДАТАВРЕМЯ(1, 1, 1)                      КАК ДатаПогашения,
		|	&ВалютаДокумента                        КАК ВалютаДокумента,
		|	ОбъектыРасчетов.Дата                    КАК Дата,
		|	ОбъектыРасчетов.Номер                   КАК Номер,
		|	ОбъектыРасчетов.Ссылка                  КАК ОбъектРасчетов,
		|	ОбъектыРасчетов.ИдентификаторПлатежа    КАК ИдентификаторПлатежа,
		|	ОбъектыРасчетов.ВалютаВзаиморасчетов    КАК ВалютаВзаиморасчетов,
		|	ДанныеРасчетов.Организация              КАК Организация,
		|	ДанныеРасчетов.Партнер                  КАК Партнер,
		|	ОбъектыРасчетов.Контрагент              КАК Контрагент,
		|	ОбъектыРасчетов.Договор                 КАК Договор,
		|	ОбъектыРасчетов.Объект                  КАК Объект,
		|	ОбъектыРасчетов.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	ОбъектыРасчетов.Подразделение           КАК Подразделение,
		|	ЕСТЬNULL(ЕСТЬNULL(ДоговорыКонтрагентов.ВариантКурсаДоговора, ДоговорыМеждуОрганизациями.ВариантКурсаДоговора), ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.Переменный)) КАК ВариантКурсаДоговора,
		|	ВЫБОР
		|		КОГДА ЕСТЬNULL(ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств, ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
		|			ТОГДА ВЫБОР
		|					КОГДА ЕСТЬNULL(ОбъектыРасчетов.Соглашение.СтатьяДвиженияДенежныхСредств, ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
		|						ТОГДА &СтатьяДвиженияДенежныхСредств
		|					ИНАЧЕ ОбъектыРасчетов.Соглашение.СтатьяДвиженияДенежныхСредств
		|				КОНЕЦ
		|		ИНАЧЕ ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств
		|	КОНЕЦ                                   КАК СтатьяДвиженияДенежныхСредств,
		|	СУММА(ДанныеРасчетов.ДолгПартнера)      КАК ДолгПартнера,
		|	СУММА(ДанныеРасчетов.КОплате)           КАК КОплате,
		|	0                                       КАК Оплачивается,
		|	СУММА(ДанныеРасчетов.НашДолг)           КАК НашДолг,
		|	&ДатаПлатежа                            КАК ДатаПлатежа,
		|	ОбъектыРасчетов.ОперацияССамозанятым    КАК ОперацияССамозанятым
		|ИЗ
		|	(ВЫБРАТЬ
		|		РасчетыСКлиентами.ОбъектРасчетов                        КАК ОбъектРасчетов,
		|		РасчетыСКлиентами.АналитикаУчетаПоПартнерам.Организация КАК Организация,
		|		РасчетыСКлиентами.АналитикаУчетаПоПартнерам.Партнер     КАК Партнер,
		|		РасчетыСКлиентами.ДолгОстаток                           КАК ДолгПартнера,
		|		РасчетыСКлиентами.КОплате                               КАК КОплате,
		|		0                                                       КАК Оплачивается,
		|		РасчетыСКлиентами.ПредоплатаОстаток                     КАК НашДолг,
		|		РасчетыСКлиентами.ДатаПлановогоПогашения                КАК ДатаПлатежа
		|	ИЗ
		|		РасчетыСКлиентамиПоСрокамОстатки КАК РасчетыСКлиентами
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		РасчетыСКлиентами.ОбъектРасчетов                        КАК ОбъектРасчетов,
		|		РасчетыСКлиентами.АналитикаУчетаПоПартнерам.Организация КАК Организация,
		|		РасчетыСКлиентами.АналитикаУчетаПоПартнерам.Партнер     КАК Партнер,
		|		0                                                       КАК ДолгПартнера,
		|		РасчетыСКлиентами.КОплатеОстаток                        КАК КОплате,
		|		0                                                       КАК Оплачивается,
		|		0                                                       КАК НашДолг,
		|		РасчетыСКлиентами.ДатаПлановогоПогашения                КАК ДатаПлатежа
		|	ИЗ
		|		РасчетыСКлиентамиПланОплатОстатки КАК РасчетыСКлиентами
		|		) КАК ДанныеРасчетов
		| 			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
		|				ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
		|				ПО ОбъектыРасчетов.Договор = ДоговорыКонтрагентов.Ссылка
		|				ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыМеждуОрганизациями КАК ДоговорыМеждуОрганизациями
		|				ПО ОбъектыРасчетов.Договор = ДоговорыМеждуОрганизациями.Ссылка
		|			ПО ДанныеРасчетов.ОбъектРасчетов = ОбъектыРасчетов.Ссылка
		|ГДЕ
		|	НЕ ОбъектыРасчетов.Объект ССЫЛКА Справочник.ПодарочныеСертификаты
		|
		|СГРУППИРОВАТЬ ПО
		|	ОбъектыРасчетов.Дата,
		|	ОбъектыРасчетов.Номер,
		|	ОбъектыРасчетов.Ссылка,
		|	ОбъектыРасчетов.ИдентификаторПлатежа,
		|	ОбъектыРасчетов.ВалютаВзаиморасчетов,
		|	ДанныеРасчетов.Организация,
		|	ДанныеРасчетов.Партнер,
		|	ОбъектыРасчетов.Контрагент,
		|	ОбъектыРасчетов.Договор,
		|	ОбъектыРасчетов.Объект,
		|	ОбъектыРасчетов.НаправлениеДеятельности,
		|	ОбъектыРасчетов.Подразделение,
		|	ДанныеРасчетов.ДатаПлатежа,
		|	ЕСТЬNULL(ЕСТЬNULL(ДоговорыКонтрагентов.ВариантКурсаДоговора, ДоговорыМеждуОрганизациями.ВариантКурсаДоговора), ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.Переменный)),
		|	ВЫБОР
		|		КОГДА ЕСТЬNULL(ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств, ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
		|			ТОГДА ВЫБОР
		|					КОГДА ЕСТЬNULL(ОбъектыРасчетов.Соглашение.СтатьяДвиженияДенежныхСредств, ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
		|						ТОГДА &СтатьяДвиженияДенежныхСредств
		|					ИНАЧЕ ОбъектыРасчетов.Соглашение.СтатьяДвиженияДенежныхСредств
		|				КОНЕЦ
		|		ИНАЧЕ ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств
		|	КОНЕЦ,
		|	ОбъектыРасчетов.ОперацияССамозанятым
		|
		|УПОРЯДОЧИТЬ ПО
		|	Организация,
		|	Контрагент,
		|	&ДатаПлатежа,
		|	Дата,
		|	Номер
		|;
		|
		|ВЫБРАТЬ
		|	РасчетыСКлиентами.ОбъектРасчетов КАК ОбъектРасчетов,
		|	РасчетыСКлиентами.Валюта КАК ВалютаВзаиморасчетов,
		|	РасчетыСКлиентами.АналитикаУчетаПоПартнерам.Организация КАК Организация,
		|	РасчетыСКлиентами.АналитикаУчетаПоПартнерам.Контрагент КАК Контрагент,
		|	РасчетыСКлиентами.АналитикаУчетаПоПартнерам.Партнер КАК Партнер,
		|	РасчетыСКлиентами.ОплачиваетсяОстаток КАК Сумма
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентами.Остатки(
		|			,
		|			&ДебиторскаяЗадолженность
		|			И НЕ &ТолькоБезусловнаяЗадолженность
		|			И ОбъектРасчетов В
		|				(ВЫБРАТЬ
		|					ОбъектыРасчетов.ОбъектРасчетов
		|				ИЗ
		|					ОбъектыРасчетов КАК ОбъектыРасчетов)) КАК РасчетыСКлиентами
		|ГДЕ
		|	РасчетыСКлиентами.ОплачиваетсяОстаток > 0
		|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ДанныеРасчетов.ДатаПлатежа,", ?(ПоДатамПлатежей, "ДанныеРасчетов.ДатаПлатежа,", ""));
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ДатаПлатежа", ?(ПоДатамПлатежей, "ДанныеРасчетов.ДатаПлатежа", "МИНИМУМ(ДанныеРасчетов.ДатаПлатежа)"));
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаПоОстаткамРасчетовСПоставщикамиОфлайн()
	
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.РасчетыСПоставщиком) КАК ТипРасчетов,
	|	ВЫБОР КОГДА ТаблицаПлатежей.Сумма ЕСТЬ NULL ТОГДА
	|		ЛОЖЬ
	|	ИНАЧЕ
	|		ИСТИНА
	|	КОНЕЦ КАК Выбран,
	|	ЕСТЬNULL(ТаблицаПлатежей.Сумма, 0) КАК Сумма,
	|	ЕСТЬNULL(ТаблицаПлатежей.ДатаПогашения, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаПогашения,
	|	ВЫБОР КОГДА &ВалютаДокумента <> ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка)
	|		ТОГДА &ВалютаДокумента
	|		ИНАЧЕ ОбъектыРасчетов.ВалютаВзаиморасчетов
	|	КОНЕЦ КАК ВалютаДокумента,
	|
	|	ОбъектыРасчетов.Дата КАК Дата,
	|	ОбъектыРасчетов.Номер КАК Номер,
	|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетов,
	|	"""" КАК ИдентификаторПлатежа,
	|	РасчетыСПоставщиками.Валюта КАК ВалютаВзаиморасчетов,
	|	РасчетыСПоставщиками.АналитикаУчетаПоПартнерам.Организация КАК Организация,
	|	РасчетыСПоставщиками.АналитикаУчетаПоПартнерам.Партнер КАК Партнер,
	|	ОбъектыРасчетов.Контрагент КАК Контрагент,
	|	ОбъектыРасчетов.Договор КАК Договор,
	|	ОбъектыРасчетов.Объект КАК Объект,
	|	ОбъектыРасчетов.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ОбъектыРасчетов.Подразделение КАК Подразделение,
	|	ЕСТЬNULL(
	|		ЕСТЬNULL(
	|			ДоговорыКонтрагентов.ВариантКурсаДоговора, 
	|			ДоговорыМеждуОрганизациями.ВариантКурсаДоговора), 
	|		ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.Переменный)) КАК ВариантКурсаДоговора,
	|
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств, 
	|			ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
	|		ТОГДА
	|			ВЫБОР
	|				КОГДА ЕСТЬNULL(ОбъектыРасчетов.Соглашение.СтатьяДвиженияДенежныхСредств,
	|					ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
	|					ТОГДА &СтатьяДвиженияДенежныхСредств
	|				ИНАЧЕ ОбъектыРасчетов.Соглашение.СтатьяДвиженияДенежныхСредств
	|			КОНЕЦ
	|		ИНАЧЕ ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств
	|	КОНЕЦ КАК СтатьяДвиженияДенежныхСредств,
	|
	|	ЕСТЬNULL(ОбъектыРасчетов.Договор.ПлатежиПо275ФЗ, ЛОЖЬ) КАК ПлатежиПо275ФЗ,
	|	
	|	ВЫБОР КОГДА РасчетыСПоставщиками.СуммаОстаток > 0 ТОГДА
	|		РасчетыСПоставщиками.СуммаОстаток
	|	ИНАЧЕ
	|		0
	|	КОНЕЦ КАК ДолгПартнера,
	|
	|	ВЫБОР КОГДА РасчетыСПоставщиками.ОплачиваетсяОстаток - РасчетыСПоставщиками.КОплатеОстаток > 0
	|		И НЕ &ТолькоБезусловнаяЗадолженность
	|	ТОГДА
	|		РасчетыСПоставщиками.ОплачиваетсяОстаток - РасчетыСПоставщиками.КОплатеОстаток
	|	ИНАЧЕ
	|		0
	|	КОНЕЦ КАК КОплате,
	|
	|	0 КАК Оплачивается,
	|
	|	ВЫБОР КОГДА РасчетыСПоставщиками.СуммаОстаток < 0 ТОГДА
	|		-РасчетыСПоставщиками.СуммаОстаток
	|	ИНАЧЕ
	|		0
	|	КОНЕЦ КАК НашДолг,
	|
	|	ОбъектыРасчетов.ОперацияССамозанятым КАК ОперацияССамозанятым
	|
	|ИЗ
	|	РегистрНакопления.РасчетыСПоставщиками.Остатки(, 
	|		ОбъектРасчетов В (
	|			ВЫБРАТЬ
	|				ОбъектыРасчетов.ОбъектРасчетов
	|			ИЗ
	|				ОбъектыРасчетов КАК ОбъектыРасчетов)
	|	) КАК РасчетыСПоставщиками
	|		
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
	|		Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
	|		ПО ОбъектыРасчетов.Договор = ДоговорыКонтрагентов.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыМеждуОрганизациями КАК ДоговорыМеждуОрганизациями
	|		ПО ОбъектыРасчетов.Договор = ДоговорыМеждуОрганизациями.Ссылка
	|	ПО 
	|		РасчетыСПоставщиками.ОбъектРасчетов = ОбъектыРасчетов.Ссылка
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ТаблицаПлатежей КАК ТаблицаПлатежей
	|	ПО
	|		РасчетыСПоставщиками.ОбъектРасчетов = ТаблицаПлатежей.ОбъектРасчетов
	|		И (РасчетыСПоставщиками.АналитикаУчетаПоПартнерам.Партнер = ТаблицаПлатежей.Партнер
	|			ИЛИ ТаблицаПлатежей.Партнер = ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка))
	|		И РасчетыСПоставщиками.Валюта = ТаблицаПлатежей.Валюта
	|
	|ГДЕ
	|	(&ДебиторскаяЗадолженность
	|	И РасчетыСПоставщиками.СуммаОстаток > 0)
	|	ИЛИ 
	|	(Не &ДебиторскаяЗадолженность
	|	И РасчетыСПоставщиками.ОплачиваетсяОстаток - РасчетыСПоставщиками.КОплатеОстаток > 0
	|	И НЕ &ТолькоБезусловнаяЗадолженность
	|	)
	|	ИЛИ 
	|	(Не &ДебиторскаяЗадолженность
	|	И РасчетыСПоставщиками.ОплачиваетсяОстаток - РасчетыСПоставщиками.СуммаОстаток > 0
	|	)
	|УПОРЯДОЧИТЬ ПО
	|	Организация,
	|	Контрагент,
	|	Дата,
	|	Номер
	|";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаПоОстаткамРасчетовСКлиентамиОфлайн()
	
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.РасчетыСКлиентом) КАК ТипРасчетов,
	|	ВЫБОР КОГДА ТаблицаПлатежей.Сумма ЕСТЬ NULL ТОГДА
	|		ЛОЖЬ
	|	ИНАЧЕ
	|		ИСТИНА
	|	КОНЕЦ КАК Выбран,
	|	ЕСТЬNULL(ТаблицаПлатежей.Сумма, 0) КАК Сумма,
	|	ЕСТЬNULL(ТаблицаПлатежей.ДатаПогашения, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаПогашения,
	|	ВЫБОР КОГДА &ВалютаДокумента <> ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка)
	|		ТОГДА &ВалютаДокумента
	|		ИНАЧЕ ОбъектыРасчетов.ВалютаВзаиморасчетов
	|	КОНЕЦ КАК ВалютаДокумента,
	|
	|	ОбъектыРасчетов.Дата КАК Дата,
	|	ОбъектыРасчетов.Номер КАК Номер,
	|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетов,
	|	ОбъектыРасчетов.ИдентификаторПлатежа КАК ИдентификаторПлатежа,
	|	ОбъектыРасчетов.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
	|	РасчетыСКлиентами.АналитикаУчетаПоПартнерам.Организация КАК Организация,
	|	РасчетыСКлиентами.АналитикаУчетаПоПартнерам.Партнер КАК Партнер,
	|	ОбъектыРасчетов.Контрагент КАК Контрагент,
	|	ОбъектыРасчетов.Договор КАК Договор,
	|	ОбъектыРасчетов.Объект КАК Объект,
	|	ОбъектыРасчетов.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ОбъектыРасчетов.Подразделение КАК Подразделение,
	|	ЕСТЬNULL(
	|		ЕСТЬNULL(
	|			ДоговорыКонтрагентов.ВариантКурсаДоговора, 
	|			ДоговорыМеждуОрганизациями.ВариантКурсаДоговора), 
	|		ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.Переменный)) КАК ВариантКурсаДоговора,
	|	
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств, 
	|			ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
	|		ТОГДА
	|			ВЫБОР
	|				КОГДА ЕСТЬNULL(ОбъектыРасчетов.Соглашение.СтатьяДвиженияДенежныхСредств,
	|					ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ПустаяСсылка)
	|					ТОГДА &СтатьяДвиженияДенежныхСредств
	|				ИНАЧЕ ОбъектыРасчетов.Соглашение.СтатьяДвиженияДенежныхСредств
	|			КОНЕЦ
	|		ИНАЧЕ ОбъектыРасчетов.Договор.СтатьяДвиженияДенежныхСредств
	|	КОНЕЦ КАК СтатьяДвиженияДенежныхСредств,
	|
	|	ВЫБОР КОГДА РасчетыСКлиентами.СуммаОстаток > 0 ТОГДА
	|		РасчетыСКлиентами.СуммаОстаток
	|	ИНАЧЕ
	|		0
	|	КОНЕЦ КАК ДолгПартнера,
	|	
	|	ВЫБОР КОГДА РасчетыСКлиентами.КОплатеОстаток - РасчетыСКлиентами.ОплачиваетсяОстаток > 0
	|		И НЕ &ТолькоБезусловнаяЗадолженность
	|	ТОГДА
	|		РасчетыСКлиентами.КОплатеОстаток - РасчетыСКлиентами.ОплачиваетсяОстаток
	|	ИНАЧЕ
	|		0
	|	КОНЕЦ КАК КОплате,
	|	
	|	0 КАК Оплачивается,
	|
	|	ВЫБОР КОГДА РасчетыСКлиентами.СуммаОстаток < 0 ТОГДА
	|		-РасчетыСКлиентами.СуммаОстаток
	|	ИНАЧЕ
	|		0
	|	КОНЕЦ КАК НашДолг,
	|
	|	ОбъектыРасчетов.ОперацияССамозанятым КАК ОперацияССамозанятым
	|
	|ИЗ
	|	РегистрНакопления.РасчетыСКлиентами.Остатки(, 
	|		ОбъектРасчетов В (
	|			ВЫБРАТЬ
	|				ОбъектыРасчетов.ОбъектРасчетов
	|			ИЗ
	|				ОбъектыРасчетов КАК ОбъектыРасчетов)
	|	) КАК РасчетыСКлиентами
	|		
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
	|		Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
	|		ПО ОбъектыРасчетов.Договор = ДоговорыКонтрагентов.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыМеждуОрганизациями КАК ДоговорыМеждуОрганизациями
	|		ПО ОбъектыРасчетов.Договор = ДоговорыМеждуОрганизациями.Ссылка
	|	ПО 
	|		РасчетыСКлиентами.ОбъектРасчетов = ОбъектыРасчетов.Ссылка
	|		
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ТаблицаПлатежей КАК ТаблицаПлатежей
	|	ПО
	|		РасчетыСКлиентами.ОбъектРасчетов = ТаблицаПлатежей.ОбъектРасчетов
	|		И (РасчетыСКлиентами.АналитикаУчетаПоПартнерам.Партнер = ТаблицаПлатежей.Партнер
	|			ИЛИ ТаблицаПлатежей.Партнер = ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка))
	|		И РасчетыСКлиентами.Валюта = ТаблицаПлатежей.Валюта
	|
	|ГДЕ
	|	НЕ (ОбъектыРасчетов.Объект ССЫЛКА Справочник.ПодарочныеСертификаты)
	|	И ((Не &ДебиторскаяЗадолженность
	|		И РасчетыСКлиентами.СуммаОстаток < 0)
	|		ИЛИ 
	|		(&ДебиторскаяЗадолженность
	|		И РасчетыСКлиентами.КОплатеОстаток - РасчетыСКлиентами.ОплачиваетсяОстаток > 0
	|		И НЕ &ТолькоБезусловнаяЗадолженность
	|		)
	|		ИЛИ 
	|		(&ДебиторскаяЗадолженность
	|		И РасчетыСКлиентами.СуммаОстаток > 0
	|		))
	|УПОРЯДОЧИТЬ ПО
	|	Организация,
	|	Контрагент,
	|	Дата,
	|	Номер
	|";
	
	Возврат ТекстЗапроса;
	
КонецФункции

// Процедура заполняет таблицу остатков расчетов с партнером.
//
// Параметры:
//	Реквизиты - Структура:
//	 * Дата - Дата
//	 * Организация - СправочникСсылка.Организации
//	 * СуммаДокумента - Число
//	 * Валюта - СправочникСсылка.Валюты
//	 * Контрагент - СправочникСсылка.Контрагенты
//	 * Партнер - СправочникСсылка.Партнеры
//	 * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации
//	 * ПартнерПрочиеОтношения - Булево
//	 * УчитыватьФилиалы - Булево
//	 * ПодборДебиторскойЗадолженности - Булево
//	 * ПодборТолькоБезусловнойЗадолженности - Булево
//	 * ТипРасчетов - ПеречислениеСсылка.ТипыРасчетовСПартнерами
//	 * ПоДатамПлатежей - Булево
//	АдресПлатежейВХранилище - Строка - Адрес во временном хранилище, в которое помещена табличная часть документа.
//	ТаблицаОстатковРасчетов - ТаблицаЗначений - Таблица с остатками расчетов.
//	ДополнительныеОтборы - Соответствие из КлючИЗначение:
//	 * Ключ - Строка - имя поля
//	 * Значение - Произвольный - значение отбора.
//
Процедура ЗаполнитьТаблицуОстатковРасчетов(Реквизиты, АдресПлатежейВХранилище, ТаблицаОстатковРасчетов, ДополнительныеОтборы = Неопределено) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ВалютаДокумента", Реквизиты.Валюта);
	Запрос.УстановитьПараметр("Период", ?(Реквизиты.Дата <> '00010101',Реквизиты.Дата, ТекущаяДатаСеанса()));
	
	УчитыватьФилиалы = ?(Реквизиты.Свойство("УчитыватьФилиалы"), Реквизиты.УчитыватьФилиалы, Истина);
	НоваяАрхитектураВзаиморасчетов = ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов");
	
	Если УчитыватьФилиалы И ТипЗнч(Реквизиты.Организация) <> Тип("Массив") Тогда
		ГоловнаяОрганизация = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Реквизиты.Организация,"ГоловнаяОрганизация");
		Если ГоловнаяОрганизация = Реквизиты.Организация Тогда
			ГоловнаяОрганизация = Неопределено;
			ЭтоГоловнаяОрганизация = Истина;
		Иначе
			ЭтоГоловнаяОрганизация = Ложь;
		КонецЕсли;
	Иначе
		ЭтоГоловнаяОрганизация = Ложь;
		ГоловнаяОрганизация = Неопределено;
	КонецЕсли;
	
	Запрос.УстановитьПараметр("ДебиторскаяЗадолженность", Реквизиты.ПодборДебиторскойЗадолженности);
	Запрос.УстановитьПараметр("ТолькоБезусловнаяЗадолженность", Реквизиты.ПодборТолькоБезусловнойЗадолженности);
	
	Если Реквизиты.Свойство("ХозяйственнаяОперация") Тогда
		СтатьяДвиженияДенежныхСредств =
			Справочники.СтатьиДвиженияДенежныхСредств.СтатьяДвиженияДенежныхСредствПоХозяйственнойОперации(
			Реквизиты.ХозяйственнаяОперация);
	Иначе
		СтатьяДвиженияДенежныхСредств = Справочники.СтатьиДвиженияДенежныхСредств.ПустаяСсылка();
	КонецЕсли;
	Запрос.УстановитьПараметр("СтатьяДвиженияДенежныхСредств", СтатьяДвиженияДенежныхСредств);
	
	ЗапросОбъектовРасчетов = Новый Запрос;
	ЗапросОбъектовРасчетов.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
	ЗапросОбъектовРасчетов.УстановитьПараметр("Организация", Реквизиты.Организация);
	ЗапросОбъектовРасчетов.УстановитьПараметр("ЭтоГоловнаяОрганизация", ЭтоГоловнаяОрганизация);
	ЗапросОбъектовРасчетов.УстановитьПараметр("ГоловнаяОрганизация", ГоловнаяОрганизация);
	ЗапросОбъектовРасчетов.УстановитьПараметр("ПоВсемКонтрагентам", Не ЗначениеЗаполнено(Реквизиты.Контрагент));
	ЗапросОбъектовРасчетов.УстановитьПараметр("Контрагент", Реквизиты.Контрагент);
	ЗапросОбъектовРасчетов.УстановитьПараметр("ПоВсемПартнерам", Не ЗначениеЗаполнено(Реквизиты.Партнер));
	ЗапросОбъектовРасчетов.УстановитьПараметр("Партнер", Реквизиты.Партнер);
	ЗапросОбъектовРасчетов.УстановитьПараметр("ПартнерПрочиеОтношения", Реквизиты.ПартнерПрочиеОтношения);
	
	ЗапросОбъектовРасчетов.Текст = ТекстЗапросаОбъектовРасчетов();
	
	УстановитьПривилегированныйРежим(Истина);
	
	ЗапросОбъектовРасчетов.Выполнить();
	МенеджерВременныхТаблиц = ЗапросОбъектовРасчетов.МенеджерВременныхТаблиц;
	
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	РасшифровкаПлатежа.ОбъектРасчетов КАК ОбъектРасчетов,
	|	РасшифровкаПлатежа.Партнер КАК Партнер,
	|	РасшифровкаПлатежа.ВалютаВзаиморасчетов КАК Валюта,
	|	РасшифровкаПлатежа.ДатаПогашения КАК ДатаПогашения,
	|	РасшифровкаПлатежа.Сумма КАК Сумма
	|
	|ПОМЕСТИТЬ ТаблицаПлатежей
	|ИЗ
	|	&РасшифровкаПлатежа КАК РасшифровкаПлатежа
	|;
	|///////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	ОбъектыРасчетов.ОбъектРасчетов                                   КАК ОбъектРасчетов,
	|	ВалютыИКурсыДокументов.КурсЧислительВалютыВзаиморасчетов         КАК КурсЧислительВалютыВзаиморасчетов,
	|	ВалютыИКурсыДокументов.КурсЗнаменательВалютыВзаиморасчетов       КАК КурсЗнаменательВалютыВзаиморасчетов,
	|	ВалютыИКурсыДокументов.КурсЧислительВалютыУправленческогоУчета   КАК КурсЧислительВалютыУправленческогоУчета,
	|	ВалютыИКурсыДокументов.КурсЗнаменательВалютыУправленческогоУчета КАК КурсЗнаменательВалютыУправленческогоУчета,
	|	ВалютыИКурсыДокументов.КурсЧислительВалютыДокумента              КАК КурсЧислительВалютыДокумента,
	|	ВалютыИКурсыДокументов.КурсЗнаменательВалютыДокумента            КАК КурсЗнаменательВалютыДокумента,
	|	ВалютыИКурсыДокументов.ВалютаДокумента                           КАК ВалютаДокумента,
	|	ВалютыИКурсыДокументов.ВалютаВзаиморасчетов                      КАК ВалютаВзаиморасчетов,
	|	ОтносительныеКурсыВалютСрезПоследних.КурсЧислитель               КАК КурсЧислительПеременный,
	|	ОтносительныеКурсыВалютСрезПоследних.КурсЗнаменатель             КАК КурсЗнаменательПеременный
	|ИЗ
	|	ОбъектыРасчетов КАК ОбъектыРасчетов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ВалютыИКурсыДокументов КАК ВалютыИКурсыДокументов
	|		ПО ОбъектыРасчетов.Объект = ВалютыИКурсыДокументов.Документ,
	|	РегистрСведений.ОтносительныеКурсыВалют.СрезПоследних(
	|			&Период,
	|			Валюта = &ВалютаДокумента
	|				И БазоваяВалюта В
	|					(ВЫБРАТЬ
	|						Т.ВалютаРегламентированногоУчета
	|					ИЗ
	|						ОбъектыРасчетов КАК Т)) КАК ОтносительныеКурсыВалютСрезПоследних
	|
	|;
	|///////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ &ТекстЗапросаРасчеты
	|
	|";
	ПоДатамПлатежей = Ложь;
	Если Реквизиты.Свойство("ПоДатамПлатежей") Тогда
		ПоДатамПлатежей = Реквизиты.ПоДатамПлатежей;
	КонецЕсли;
	
	Если Реквизиты.ТипРасчетов = Перечисления.ТипыРасчетовСПартнерами.РасчетыСКлиентом Тогда
		
		Если НоваяАрхитектураВзаиморасчетов Тогда
			
			ЗапросОстатков = Новый Запрос;
			ЗапросОстатков.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
			ЗапросОстатков.Текст = ТекстЗапросаОстаткиПоРегистрамРасчетовСКлиентами();
			
			Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(Реквизиты, "НаДатуВозникновения") Тогда
				
				ЗапросОстатков.Текст = СтрЗаменить(
					ЗапросОстатков.Текст,
					"&ИсключитьПоДатеВозникновения",
					"РасчетыСКлиентамиПоСрокам.ДатаВозникновения > &ДатаВозникновения");
				ЗапросОстатков.Текст = СтрЗаменить(
					ЗапросОстатков.Текст,
					"&ОтборПоДатеВозникновения",
					"ДатаВозникновения <= &ДатаВозникновения");
				ЗапросОстатков.УстановитьПараметр("ДатаВозникновения", Реквизиты.НаДатуВозникновения);
				
			Иначе
				
				ЗапросОстатков.Текст = СтрЗаменить(
					ЗапросОстатков.Текст,
					"&ИсключитьПоДатеВозникновения",
					"РасчетыСКлиентамиПоСрокам.ДатаВозникновения = Неопределено");
				ЗапросОстатков.Текст = СтрЗаменить(ЗапросОстатков.Текст, "И &ОтборПоДатеВозникновения", "");
				
			КонецЕсли;
			
			ЗапросОстатков.УстановитьПараметр("ДебиторскаяЗадолженность", Реквизиты.ПодборДебиторскойЗадолженности);
			ЗапросОстатков.УстановитьПараметр("ТолькоБезусловнаяЗадолженность", Реквизиты.ПодборТолькоБезусловнойЗадолженности);
			
			ЗапросОстатков.Выполнить();
			МенеджерВременныхТаблиц = ЗапросОстатков.МенеджерВременныхТаблиц;
			
			ТекстЗапроса = СтрЗаменить(
				ТекстЗапроса,
				"ВЫБРАТЬ &ТекстЗапросаРасчеты",
				ТекстЗапросаПоОстаткамРасчетовСКлиентами(ПоДатамПлатежей));
			
		Иначе
			ТекстЗапроса = СтрЗаменить(
				ТекстЗапроса,
				"ВЫБРАТЬ &ТекстЗапросаРасчеты",
				ТекстЗапросаПоОстаткамРасчетовСКлиентамиОфлайн());
		КонецЕсли;
		
	Иначе
		
		Если НоваяАрхитектураВзаиморасчетов Тогда
			
			ЗапросОстатков = Новый Запрос;
			ЗапросОстатков.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
			ЗапросОстатков.Текст = ТекстЗапросаОстаткиПоРегистрамРасчетовСПоставщиками();
			
			Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(Реквизиты, "НаДатуВозникновения") Тогда
				
				ЗапросОстатков.Текст = СтрЗаменить(
					ЗапросОстатков.Текст,
					"&ИсключитьПоДатеВозникновения",
					"РасчетыСПоставщикамиПоСрокам.ДатаВозникновения > &ДатаВозникновения");
				ЗапросОстатков.Текст = СтрЗаменить(
					ЗапросОстатков.Текст,
					"&ОтборПоДатеВозникновения",
					"ДатаВозникновения <= &ДатаВозникновения");
				ЗапросОстатков.УстановитьПараметр("ДатаВозникновения", Реквизиты.НаДатуВозникновения);
				
			Иначе
				
				ЗапросОстатков.Текст = СтрЗаменить(
					ЗапросОстатков.Текст,
					"&ИсключитьПоДатеВозникновения",
					"РасчетыСПоставщикамиПоСрокам.ДатаВозникновения = Неопределено");
				ЗапросОстатков.Текст = СтрЗаменить(ЗапросОстатков.Текст, "И &ОтборПоДатеВозникновения", "");
				
			КонецЕсли;
			
			ЗапросОстатков.УстановитьПараметр("ДебиторскаяЗадолженность", Реквизиты.ПодборДебиторскойЗадолженности);
			ЗапросОстатков.УстановитьПараметр("ТолькоБезусловнаяЗадолженность", Реквизиты.ПодборТолькоБезусловнойЗадолженности);
			
			ЗапросОстатков.Выполнить();
			МенеджерВременныхТаблиц = ЗапросОстатков.МенеджерВременныхТаблиц;
			
			ТекстЗапроса = СтрЗаменить(
				ТекстЗапроса,
				"ВЫБРАТЬ &ТекстЗапросаРасчеты",
				ТекстЗапросаПоОстаткамРасчетовСПоставщиками(ПоДатамПлатежей));
			
		Иначе
			ТекстЗапроса = СтрЗаменить(
				ТекстЗапроса,
				"ВЫБРАТЬ &ТекстЗапросаРасчеты",
				ТекстЗапросаПоОстаткамРасчетовСПоставщикамиОфлайн());
		КонецЕсли;
		
	КонецЕсли;
	
	
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст = ТекстЗапроса;
	
	Если ЗначениеЗаполнено(АдресПлатежейВХранилище) Тогда
		РасшифровкаПлатежа = ПолучитьИзВременногоХранилища(АдресПлатежейВХранилище);
		Если РасшифровкаПлатежа.Колонки.Найти("Партнер") = Неопределено Тогда
			РасшифровкаПлатежа.Колонки.Добавить("Партнер", Новый ОписаниеТипов("СправочникСсылка.Партнеры"));
			РасшифровкаПлатежа.ЗаполнитьЗначения(Реквизиты.Партнер, "Партнер");
			Если РасшифровкаПлатежа.Колонки.Найти("Поставщик") <> Неопределено Тогда
				Для Каждого СтрокаТаблицы Из РасшифровкаПлатежа Цикл
					СтрокаТаблицы.Партнер = СтрокаТаблицы.Поставщик;
				КонецЦикла;
			КонецЕсли;
		КонецЕсли;
		Если РасшифровкаПлатежа.Колонки.Найти("ДатаПогашения") = Неопределено Тогда
			РасшифровкаПлатежа.Колонки.Добавить("ДатаПогашения", Новый ОписаниеТипов("Дата"));
		КонецЕсли;
		Если РасшифровкаПлатежа.Колонки.Найти("СуммаВзаиморасчетов") = Неопределено Тогда
			РасшифровкаПлатежа.Колонки.Добавить("СуммаВзаиморасчетов", Новый ОписаниеТипов("Число"));
			Для Каждого СтрокаТаблицы Из РасшифровкаПлатежа Цикл
				СтрокаТаблицы.СуммаВзаиморасчетов = СтрокаТаблицы.Сумма;
			КонецЦикла;
		КонецЕсли;
	Иначе
		Если ТаблицаОстатковРасчетов = Неопределено Тогда
			РасшифровкаПлатежа = Новый ТаблицаЗначений;
			РасшифровкаПлатежа.Колонки.Добавить("ОбъектРасчетов", Новый ОписаниеТипов("СправочникСсылка.ОбъектыРасчетов"));
			РасшифровкаПлатежа.Колонки.Добавить("Партнер", Новый ОписаниеТипов("СправочникСсылка.Партнеры"));
			РасшифровкаПлатежа.Колонки.Добавить("ВалютаВзаиморасчетов", Новый ОписаниеТипов("СправочникСсылка.Валюты"));
			РасшифровкаПлатежа.Колонки.Добавить("ДатаПогашения", Новый ОписаниеТипов("Дата"));
			РасшифровкаПлатежа.Колонки.Добавить("Сумма", Новый ОписаниеТипов("Число"));
			РасшифровкаПлатежа.Колонки.Добавить("СуммаВзаиморасчетов", Новый ОписаниеТипов("Число"));
		Иначе
			РасшифровкаПлатежа = ТаблицаОстатковРасчетов.Выгрузить(,).СкопироватьКолонки();
		КонецЕсли;
	КонецЕсли;
	РасшифровкаПлатежа.Свернуть("ОбъектРасчетов, Партнер, ВалютаВзаиморасчетов, ДатаПогашения", "Сумма, СуммаВзаиморасчетов");
	
	Если РасшифровкаПлатежа.Количество() = 1 И Не ЗначениеЗаполнено(РасшифровкаПлатежа[0].ОбъектРасчетов) Тогда
		РасшифровкаПлатежа.Очистить();
	КонецЕсли;
	
	Запрос.УстановитьПараметр("РасшифровкаПлатежа", РасшифровкаПлатежа);
	
	Если ДополнительныеОтборы <> Неопределено Тогда
		
		СхемаЗапросаОстатков = Новый СхемаЗапроса;
		СхемаЗапросаОстатков.УстановитьТекстЗапроса(Запрос.Текст);
		Оператор = СхемаЗапросаОстатков.ПакетЗапросов[2].Операторы[0];
		
		сч = 0;
		Для Каждого КлючИЗначение Из ДополнительныеОтборы Цикл
			Если ТипЗнч(КлючИЗначение.Значение) = Тип("Массив") Тогда
				Отбор = СтрШаблон("ЕСТЬNULL(ОбъектыРасчетов.%1, Неопределено) В (&Параметр%2)", КлючИЗначение.Ключ, Строка(сч));
			Иначе
				Отбор = "ЕСТЬNULL(ОбъектыРасчетов."+КлючИЗначение.Ключ+", Неопределено) = &Параметр"+Строка(сч);
			КонецЕсли;
			Запрос.УстановитьПараметр("Параметр"+Строка(сч), КлючИЗначение.Значение);
			Оператор.Отбор.Добавить(Отбор);
			сч= сч + 1;
		КонецЦикла;
		
		Запрос.Текст = СхемаЗапросаОстатков.ПолучитьТекстЗапроса();
		
	КонецЕсли;
	
	РезультатЗапроса = Запрос.ВыполнитьПакет();
	ТаблицаОстатковРасчетовПредварительно = РезультатЗапроса[2].Выгрузить();
	
	Если НоваяАрхитектураВзаиморасчетов Тогда
		ТаблицаОстатковРасчетовПредварительно.Индексы.Добавить("ОбъектРасчетов, Партнер, ВалютаВзаиморасчетов");
		СтруктураОтбора = Новый Структура("ОбъектРасчетов, Партнер, ВалютаВзаиморасчетов");
		Если Не Реквизиты.ПодборТолькоБезусловнойЗадолженности Тогда
			// Распределим Оплачивается. Так как в движениях по расчетам Оплачивается записывается без указания 
			// реквизита ДатаПлатежа - в запросе это сделать невозможно 
			ОстаткиОплачивается = РезультатЗапроса[3].Выгрузить();
			Для Каждого ОстатокОплачивается Из ОстаткиОплачивается Цикл
				ЗаполнитьЗначенияСвойств(СтруктураОтбора, ОстатокОплачивается);
				СтрокиОстатков = ОбщегоНазначенияУТ.НайтиСтрокиССохранениемПорядка(ТаблицаОстатковРасчетовПредварительно, СтруктураОтбора);
				Для Каждого СтрокаОстатка Из СтрокиОстатков Цикл
					Если ОстатокОплачивается.Сумма <= 0 Тогда
						Прервать;
					Иначе
						СуммаРаспределено = Мин(ОстатокОплачивается.Сумма, СтрокаОстатка.КОплате);
						СтрокаОстатка.Оплачивается = СуммаРаспределено;
						ОстатокОплачивается.Сумма = ОстатокОплачивается.Сумма - СуммаРаспределено;
					КонецЕсли;
				КонецЦикла;
			КонецЦикла;
		КонецЕсли;
		// Отметим Объекты расчетов которые уже есть в расшифровке платежа. 
		// Так как в расшифровке нет поля ДатаПлатежа - в запросе это сделать невозможно
		Для Каждого СтрокаРасшифровки Из РасшифровкаПлатежа Цикл
			ЗаполнитьЗначенияСвойств(СтруктураОтбора, СтрокаРасшифровки);
			СтрокиОстатков = ОбщегоНазначенияУТ.НайтиСтрокиССохранениемПорядка(ТаблицаОстатковРасчетовПредварительно, СтруктураОтбора);
			ОстатокСуммыВзаиморасчетов = СтрокаРасшифровки.СуммаВзаиморасчетов;
			Если ОстатокСуммыВзаиморасчетов = 0 Тогда
				Если СтрокаРасшифровки.ВалютаВзаиморасчетов = Реквизиты.Валюта Тогда
					ОстатокСуммыВзаиморасчетов = СтрокаРасшифровки.Сумма;
				Иначе
					ОстатокСуммыВзаиморасчетов = РаботаСКурсамиВалютУТ.ПересчитатьВВалюту(
						СтрокаРасшифровки.Сумма,
						,
						Реквизиты.Валюта,
						СтрокаРасшифровки.ВалютаВзаиморасчетов,
						Реквизиты.Дата,
						СтрокаРасшифровки.ОбъектРасчетов);
				КонецЕсли;
			КонецЕсли;
			СуммыВзаиморасчетов = Новый Массив;
			Для Каждого СтрокаОстатка Из СтрокиОстатков Цикл
				ТекущаяСуммаВзаиморасчетов = 0;
				Если СтрокаОстатка.ДолгПартнера <> 0 И Реквизиты.ПодборДебиторскойЗадолженности Тогда
					ТекущаяСуммаВзаиморасчетов = Мин(СтрокаОстатка.ДолгПартнера, СтрокаОстатка.КОплате - СтрокаОстатка.Оплачивается, ОстатокСуммыВзаиморасчетов);
					СуммыВзаиморасчетов.Добавить(ТекущаяСуммаВзаиморасчетов);
				ИначеЕсли СтрокаОстатка.НашДолг <> 0  И НЕ Реквизиты.ПодборДебиторскойЗадолженности Тогда
					ТекущаяСуммаВзаиморасчетов = Мин(СтрокаОстатка.НашДолг,СтрокаОстатка.КОплате - СтрокаОстатка.Оплачивается, ОстатокСуммыВзаиморасчетов);
					СуммыВзаиморасчетов.Добавить(ТекущаяСуммаВзаиморасчетов);
				ИначеЕсли СтрокаОстатка.КОплате <> 0 Тогда
					ТекущаяСуммаВзаиморасчетов = Мин(СтрокаОстатка.КОплате - СтрокаОстатка.Оплачивается, ОстатокСуммыВзаиморасчетов);
					СуммыВзаиморасчетов.Добавить(ТекущаяСуммаВзаиморасчетов);
				КонецЕсли;
				ОстатокСуммыВзаиморасчетов = ОстатокСуммыВзаиморасчетов - ТекущаяСуммаВзаиморасчетов;
			КонецЦикла;
			РаспределеннаяСумма = ОбщегоНазначенияУТКлиентСервер.РаспределитьПропорционально(СтрокаРасшифровки.Сумма, СуммыВзаиморасчетов);
			Если РаспределеннаяСумма <> Неопределено Тогда
				Для Счетчик = 0 По СтрокиОстатков.Количество() - 1 Цикл
					СтрокиОстатков[Счетчик].Сумма = РаспределеннаяСумма[Счетчик];
					Если РаспределеннаяСумма[Счетчик] > 0 Тогда
						СтрокиОстатков[Счетчик].ДатаПогашения = СтрокаРасшифровки.ДатаПогашения;
						СтрокиОстатков[Счетчик].Выбран = Истина;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Если ТаблицаОстатковРасчетов = Неопределено Тогда
		ТаблицаОстатковРасчетов = ТаблицаОстатковРасчетовПредварительно;
	Иначе
		ТаблицаОстатковРасчетов.Загрузить(ТаблицаОстатковРасчетовПредварительно);
	КонецЕсли;
	
	Если РасшифровкаПлатежа.Количество() = 0 Тогда
		СуммаКРаспределению = Реквизиты.СуммаДокумента;
	Иначе
		СуммаКРаспределению = 0;
	КонецЕсли;
	
	СоответствиеКурсовВалют = Новый Соответствие;
	
	ВыборкаФиксКурса = РезультатЗапроса[1].Выбрать();
	ВалютаУправленческогоУчета = ЗначениеНастроекПовтИсп.ВалютаУправленческогоУчета();
	Пока ВыборкаФиксКурса.Следующий() Цикл
		Если Реквизиты.Валюта = ВыборкаФиксКурса.ВалютаВзаиморасчетов Тогда
			КоэффициентПересчета = 1;
		ИначеЕсли Реквизиты.Валюта = ВыборкаФиксКурса.ВалютаДокумента Тогда
			КоэффициентПересчета = ВыборкаФиксКурса.КурсЧислительВалютыВзаиморасчетов * ВыборкаФиксКурса.КурсЗнаменательВалютыДокумента 
			                       / (ВыборкаФиксКурса.КурсЗнаменательВалютыВзаиморасчетов * ВыборкаФиксКурса.КурсЧислительВалютыДокумента)
		ИначеЕсли Реквизиты.Валюта = ВалютаУправленческогоУчета Тогда
			КоэффициентПересчета = ВыборкаФиксКурса.КурсЧислительВалютыВзаиморасчетов * ВыборкаФиксКурса.КурсЗнаменательВалютыУправленческогоУчета 
			                       / (ВыборкаФиксКурса.КурсЗнаменательВалютыВзаиморасчетов * ВыборкаФиксКурса.КурсЧислительВалютыУправленческогоУчета)
		Иначе
			КоэффициентПересчета = ВыборкаФиксКурса.КурсЧислительВалютыВзаиморасчетов * ВыборкаФиксКурса.КурсЗнаменательПеременный 
			                       / (ВыборкаФиксКурса.КурсЗнаменательВалютыВзаиморасчетов * ВыборкаФиксКурса.КурсЧислительПеременный)
		КонецЕсли;
		СоответствиеКурсовВалют.Вставить(ВыборкаФиксКурса.ОбъектРасчетов, КоэффициентПересчета);
	КонецЦикла;
	
	Для Каждого СтрокаТаблицы Из ТаблицаОстатковРасчетов Цикл
		
		Если Не СтрокаТаблицы.Выбран Тогда
				
			Если СтрокаТаблицы.ДолгПартнера <> 0 И Реквизиты.ПодборДебиторскойЗадолженности Тогда
				Если Реквизиты.ТипРасчетов = Перечисления.ТипыРасчетовСПартнерами.РасчетыСКлиентом Тогда
					СтрокаТаблицы.Сумма = Мин(СтрокаТаблицы.ДолгПартнера, СтрокаТаблицы.КОплате - СтрокаТаблицы.Оплачивается);
				Иначе
					СтрокаТаблицы.Сумма = СтрокаТаблицы.ДолгПартнера;
				КонецЕсли;
			ИначеЕсли СтрокаТаблицы.НашДолг <> 0  И НЕ Реквизиты.ПодборДебиторскойЗадолженности Тогда
				Если Реквизиты.ТипРасчетов = Перечисления.ТипыРасчетовСПартнерами.РасчетыСКлиентом Тогда
					СтрокаТаблицы.Сумма = СтрокаТаблицы.НашДолг;
				Иначе
					СтрокаТаблицы.Сумма = Мин(СтрокаТаблицы.НашДолг,СтрокаТаблицы.КОплате - СтрокаТаблицы.Оплачивается);
				КонецЕсли;
			ИначеЕсли СтрокаТаблицы.КОплате <> 0 Тогда
				СтрокаТаблицы.Сумма = СтрокаТаблицы.КОплате - СтрокаТаблицы.Оплачивается;
			КонецЕсли;
			
			Если ЗначениеЗаполнено(Реквизиты.Валюта) И Реквизиты.Валюта <> СтрокаТаблицы.ВалютаВзаиморасчетов Тогда
				
				Если СтрокаТаблицы.ВариантКурсаДоговора = Перечисления.ВариантыКурсаДоговора.УстановленныйВДоговоре Тогда
					Коэффициент = СоответствиеКурсовВалют.Получить(СтрокаТаблицы.Договор);
				ИначеЕсли СтрокаТаблицы.ВариантКурсаДоговора = Перечисления.ВариантыКурсаДоговора.ФиксированныйНаДатуОтгрузки Тогда
					Коэффициент = СоответствиеКурсовВалют.Получить(СтрокаТаблицы.ОбъектРасчетов);
				Иначе
					Коэффициент = СоответствиеКурсовВалют.Получить(СтрокаТаблицы.ВалютаВзаиморасчетов);
				КонецЕсли;
				Если Коэффициент = Неопределено Тогда
					ПараметрыКурса = РаботаСКурсамиВалютУТ.ПараметрыВариантаКурсаДоговора();
					ЗаполнитьЗначенияСвойств(ПараметрыКурса, СтрокаТаблицы);
					Коэффициент = РаботаСКурсамиВалютУТ.ПолучитьКоэффициентПересчетаИзВалютыВВалюту(
					              	СтрокаТаблицы.ВалютаВзаиморасчетов,
					              	Реквизиты.Валюта,
					              	?(Реквизиты.Дата <> '00010101',Реквизиты.Дата, ТекущаяДатаСеанса()),
					              	ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(СтрокаТаблицы.Организация),
					              	ПараметрыКурса);
					Если СтрокаТаблицы.ВариантКурсаДоговора = Перечисления.ВариантыКурсаДоговора.УстановленныйВДоговоре Тогда
						СоответствиеКурсовВалют.Вставить(СтрокаТаблицы.Договор, Коэффициент);
					ИначеЕсли СтрокаТаблицы.ВариантКурсаДоговора = Перечисления.ВариантыКурсаДоговора.ФиксированныйНаДатуОтгрузки Тогда
						СоответствиеКурсовВалют.Вставить(СтрокаТаблицы.ОбъектРасчетов, Коэффициент);
					Иначе
						СоответствиеКурсовВалют.Вставить(СтрокаТаблицы.ВалютаВзаиморасчетов, Коэффициент);
					КонецЕсли;
				КонецЕсли;
				
				СтрокаТаблицы.Сумма = СтрокаТаблицы.Сумма * Коэффициент;
				
			КонецЕсли;
			
		КонецЕсли;
		
		Если СуммаКРаспределению > 0 
			И СтрокаТаблицы.Сумма - СтрокаТаблицы.Оплачивается > 0 Тогда
			
			СтрокаТаблицы.Выбран = Истина;
			Если СтрокаТаблицы.Оплачивается > 0 Тогда
				СтрокаТаблицы.Сумма = СтрокаТаблицы.Сумма - СтрокаТаблицы.Оплачивается;
			КонецЕсли;
			Если СтрокаТаблицы.Сумма > СуммаКРаспределению Тогда
				СтрокаТаблицы.Сумма = СуммаКРаспределению;
			КонецЕсли;
			СуммаКРаспределению = СуммаКРаспределению - СтрокаТаблицы.Сумма;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

// Функция формирует массив допустимых хозяйственных операций договора с контрагентом.
//
// Параметры:
//	ОперацияДокумента - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа.
//
// Возвращаемое значение:
//	Массив из ПеречислениеСсылка.ХозяйственныеОперации - Массив хозяйственных операций.
//
Функция ХозяйственнаяОперацияДоговора(ОперацияДокумента) Экспорт
	
	ХозяйственнаяОперацияДоговора = Новый Массив;
	Если ОперацияДокумента = Перечисления.ХозяйственныеОперации.ПоступлениеОплатыОтКлиента
	 ИЛИ ОперацияДокумента = Перечисления.ХозяйственныеОперации.ВозвратОплатыКлиенту Тогда
		
		ХозяйственнаяОперацияДоговора.Добавить(Перечисления.ХозяйственныеОперации.РеализацияКлиенту);
		ХозяйственнаяОперацияДоговора.Добавить(Перечисления.ХозяйственныеОперации.ПередачаНаКомиссию);
		
	ИначеЕсли ОперацияДокумента = Перечисления.ХозяйственныеОперации.ОплатаПоставщику
	 ИЛИ ОперацияДокумента = Перечисления.ХозяйственныеОперации.ВозвратДенежныхСредствОтПоставщика Тогда
		
		ХозяйственнаяОперацияДоговора.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаУПоставщика);
		ХозяйственнаяОперацияДоговора.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаПоИмпорту);
		ХозяйственнаяОперацияДоговора.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭС);
		ХозяйственнаяОперацияДоговора.Добавить(Перечисления.ХозяйственныеОперации.ПриемНаКомиссию);
		
	КонецЕсли;
	
	Возврат ХозяйственнаяОперацияДоговора;
	
КонецФункции

// Параметры:
//  ТаблицаРасчеты - ТаблицаЗначений - таблица движений по регистру расчетов с обязательными колонками:
//   * ВидДвижения - ВидДвиженияНакопления,
//   * Период - Дата,
//   * ДатаРегистратора - Дата,
//   * НомерРегистратора - Строка,
//   * Вид - Число
//  ТипДокумента - Тип - Тип документа регистратора
Процедура ДобавитьЗаполнитьПорядокРасчетовСКлиентами(ТаблицаРасчеты, ТипДокумента) Экспорт
	
	ТаблицаРасчеты.Колонки.Добавить("ПорядокОперации",            Новый ОписаниеТипов("Строка"));
	ТаблицаРасчеты.Колонки.Добавить("ПорядокЗачетаПоДатеПлатежа", Новый ОписаниеТипов("Строка"));
	
	Тип = ОперативныеВзаиморасчетыСервер.НомерТипа(ТипДокумента);
	
	ЕстьДатаПлатежа = ТаблицаРасчеты.Колонки.Найти("ДатаПлатежа") <> Неопределено;
	ЕстьСумма = ТаблицаРасчеты.Колонки.Найти("Сумма") <> Неопределено;
	ЕстьКОплате = ТаблицаРасчеты.Колонки.Найти("КОплате") <> Неопределено;
	ЕстьКОтгрузке = ТаблицаРасчеты.Колонки.Найти("КОтгрузке") <> Неопределено;
	ЕстьСторно = ТаблицаРасчеты.Колонки.Найти("Сторно") <> Неопределено;
	
	Для Каждого Стр Из ТаблицаРасчеты Цикл
		
		ДатаПлатежа = ?(ЕстьДатаПлатежа И ЗначениеЗаполнено(Стр.ДатаПлатежа), Стр.ДатаПлатежа, НачалоДня(Стр.ДатаРегистратора));
		
		//План оплаты
		Если (НЕ ЕстьСумма ИЛИ Стр.Сумма = 0) И (НЕ ЕстьКОплате ИЛИ Стр.КОплате <> 0) Тогда
			Стр.ПорядокОперации = ОперативныеВзаиморасчетыСервер.Порядок(Стр.ДатаРегистратора, Стр.НомерРегистратора, ТипДокумента, Стр.Вид, Тип);
			Если ЕстьСторно И Стр.Сторно = ИСТИНА  Тогда
				Стр.ПорядокЗачетаПоДатеПлатежа = Стр.ПорядокОперации;
			Иначе
				Стр.ПорядокЗачетаПоДатеПлатежа = ОперативныеВзаиморасчетыСервер.Порядок(ДатаПлатежа, Стр.НомерРегистратора, ТипДокумента, Стр.Вид, Тип);
			КонецЕсли;
		//Платежные документы и сторно отгрузки.
		ИначеЕсли Стр.ВидДвижения = ВидДвиженияНакопления.Расход И ЕстьСумма И  Стр.Сумма > 0
			Или Стр.ВидДвижения = ВидДвиженияНакопления.Приход И ЕстьСумма И Стр.Сумма < 0 Тогда
			Стр.ПорядокОперации = ОперативныеВзаиморасчетыСервер.Порядок(Стр.Период, Стр.НомерРегистратора, ТипДокумента, Стр.Вид, Тип);
			Стр.ПорядокЗачетаПоДатеПлатежа = ОперативныеВзаиморасчетыСервер.Порядок(ДатаПлатежа, Стр.НомерРегистратора, ТипДокумента, Стр.Вид, Тип);
		//Накладные и пр.
		ИначеЕсли ЕстьСумма И Стр.Сумма <> 0 ИЛИ ЕстьКОплате И Стр.КОплате <> 0 ИЛИ ЕстьКОтгрузке И Стр.КОтгрузке <> 0 Тогда
			Стр.ПорядокОперации = ОперативныеВзаиморасчетыСервер.Порядок(Стр.ДатаРегистратора, Стр.НомерРегистратора, ТипДокумента, Стр.Вид, Тип);
			Стр.ПорядокЗачетаПоДатеПлатежа = ОперативныеВзаиморасчетыСервер.Порядок(ДатаПлатежа, Стр.НомерРегистратора, ТипДокумента, Стр.Вид, Тип);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Параметры:
//  ТаблицаРасчеты - ТаблицаЗначений - таблица движений по регистру расчетов с обязательными колонками:
//   * ВидДвижения - ВидДвиженияНакопления,
//   * Период - Дата,
//   * ДатаРегистратора - Дата,
//   * НомерРегистратора - Строка,
//   * Вид - Число
//  ТипДокумента - Тип - Тип документа регистратора
Процедура ДобавитьЗаполнитьПорядокРасчетовСПоставщиками(ТаблицаРасчеты, ТипДокумента) Экспорт
	
	ТаблицаРасчеты.Колонки.Добавить("ПорядокОперации",            Новый ОписаниеТипов("Строка"));
	ТаблицаРасчеты.Колонки.Добавить("ПорядокЗачетаПоДатеПлатежа", Новый ОписаниеТипов("Строка"));
	
	Тип = ОперативныеВзаиморасчетыСервер.НомерТипа(ТипДокумента);
	
	ЕстьДатаПлатежа = ТаблицаРасчеты.Колонки.Найти("ДатаПлатежа") <> Неопределено;
	ЕстьСумма = ТаблицаРасчеты.Колонки.Найти("Сумма") <> Неопределено;
	ЕстьКОплате = ТаблицаРасчеты.Колонки.Найти("КОплате") <> Неопределено;
	ЕстьКПоступлению = ТаблицаРасчеты.Колонки.Найти("КПоступлению") <> Неопределено;
	ЕстьСторно = ТаблицаРасчеты.Колонки.Найти("Сторно") <> Неопределено;
	
	Для Каждого Стр Из ТаблицаРасчеты Цикл
		
		ДатаПлатежа = ?(ЕстьДатаПлатежа И ЗначениеЗаполнено(Стр.ДатаПлатежа), Стр.ДатаПлатежа, НачалоДня(Стр.ДатаРегистратора));
		
		Если (НЕ ЕстьСумма ИЛИ Стр.Сумма = 0) И (НЕ ЕстьКОплате ИЛИ Стр.КОплате <> 0) Тогда
			Стр.ПорядокОперации = ОперативныеВзаиморасчетыСервер.Порядок(Стр.ДатаРегистратора, Стр.НомерРегистратора, ТипДокумента, Стр.Вид, Тип);
			Если ЕстьСторно И Стр.Сторно = ИСТИНА  Тогда
				Стр.ПорядокЗачетаПоДатеПлатежа = Стр.ПорядокОперации;
			Иначе
				Стр.ПорядокЗачетаПоДатеПлатежа = ОперативныеВзаиморасчетыСервер.Порядок(ДатаПлатежа, Стр.НомерРегистратора, ТипДокумента, Стр.Вид, Тип);
			КонецЕсли;
		ИначеЕсли Стр.ВидДвижения = ВидДвиженияНакопления.Приход И ЕстьСумма И Стр.Сумма > 0
			Или Стр.ВидДвижения = ВидДвиженияНакопления.Расход И ЕстьСумма И Стр.Сумма < 0 Тогда
			Стр.ПорядокОперации = ОперативныеВзаиморасчетыСервер.Порядок(Стр.Период, Стр.НомерРегистратора, ТипДокумента, Стр.Вид, Тип);
			Стр.ПорядокЗачетаПоДатеПлатежа = ОперативныеВзаиморасчетыСервер.Порядок(ДатаПлатежа, Стр.НомерРегистратора, ТипДокумента, Стр.Вид, Тип);
		ИначеЕсли ЕстьСумма И Стр.Сумма <> 0 ИЛИ ЕстьКОплате И Стр.КОплате <> 0 ИЛИ ЕстьКПоступлению И Стр.КПоступлению <> 0 Тогда
			Стр.ПорядокОперации = ОперативныеВзаиморасчетыСервер.Порядок(Стр.ДатаРегистратора, Стр.НомерРегистратора, ТипДокумента, Стр.Вид, Тип);
			Стр.ПорядокЗачетаПоДатеПлатежа = ОперативныеВзаиморасчетыСервер.Порядок(ДатаПлатежа, Стр.НомерРегистратора, ТипДокумента, Стр.Вид, Тип);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Функция ТестЗапросаРаспределениеРасчетовСКлиентами()
	
	ТекстЗапроса = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Таблица.Месяц КАК Месяц,
	|	Таблица.АналитикаУчетаПоПартнерам    КАК АналитикаУчетаПоПартнерам,
	|	Таблица.ОбъектРасчетов               КАК ОбъектРасчетов,
	|	ВЫБОР КОГДА &НовыеРасчеты
	|		ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ Таблица.Документ
	|	КОНЕЦ								 КАК Документ,
	|	Таблица.Организация КАК Организация,
	|	ЗНАЧЕНИЕ(Перечисление.ОперацииЗакрытияМесяца.ФормированиеДвиженийПоРасчетамСПартнерамиИПереоценкаРасчетов) КАК Операция
	|ИЗ РасчетыСКлиентамиИзменения КАК Таблица
	|ГДЕ
	|	Таблица.Сумма <> 0 ИЛИ Таблица.СуммаРегл <> 0 ИЛИ Таблица.СуммаУпр <> 0
	|";
	Возврат ТекстЗапроса
КонецФункции

Функция ТестЗапросаРаспределениеРасчетовСПоставщиками()
	
	ТекстЗапроса = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Таблица.Месяц КАК Месяц,
	|	Таблица.АналитикаУчетаПоПартнерам    КАК АналитикаУчетаПоПартнерам,
	|	Таблица.ОбъектРасчетов               КАК ОбъектРасчетов,
	|	ВЫБОР КОГДА &НовыеРасчеты
	|		ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ Таблица.Документ
	|	КОНЕЦ								 КАК Документ,
	|	Таблица.Организация КАК Организация,
	|	ЗНАЧЕНИЕ(Перечисление.ОперацииЗакрытияМесяца.ФормированиеДвиженийПоРасчетамСПартнерамиИПереоценкаРасчетов) КАК Операция
	|ИЗ РасчетыСПоставщикамиИзменения КАК Таблица
	|ГДЕ
	|	Таблица.Сумма <> 0 ИЛИ Таблица.СуммаРегл <> 0 ИЛИ Таблица.СуммаУпр <> 0
	|";
	Возврат ТекстЗапроса
КонецФункции

Процедура ПроверитьЗаполнитьАналитикуУчетаПоПартнерам(ТаблицаДвижений) Экспорт
	
	Если ТаблицаДвижений.Колонки.Найти("Партнер") = Неопределено 
		ИЛИ ТаблицаДвижений.Колонки.Найти("Организация") = Неопределено 
		ИЛИ ТаблицаДвижений.Колонки.Найти("Контрагент") = Неопределено 
		ИЛИ ТаблицаДвижений.Колонки.Найти("Договор") = Неопределено 
		ИЛИ ТаблицаДвижений.Колонки.Найти("НаправлениеДеятельности") = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ПоляАналитики = "Партнер, Организация, Контрагент, Договор, НаправлениеДеятельности";
	ТаблицаНайденнойАналитики = ТаблицаДвижений.Скопировать(,ПоляАналитики); // ТаблицаЗначений
	ТаблицаНайденнойАналитики.Очистить();
	ТаблицаНайденнойАналитики.Колонки.Добавить("АналитикаУчетаПоПартнерам", Новый ОписаниеТипов("СправочникСсылка.КлючиАналитикиУчетаПоПартнерам"));
	ПараметрыАналитики = Новый Структура(ПоляАналитики);
	
	Для Каждого Запись Из ТаблицаДвижений Цикл
		
		Если НЕ ЗначениеЗаполнено(Запись.АналитикаУчетаПоПартнерам) Тогда
			
			ЗаполнитьЗначенияСвойств(ПараметрыАналитики, Запись);
			Если НЕ ЗначениеЗаполнено(ПараметрыАналитики.Договор) Тогда
				Если ТипЗнч(ПараметрыАналитики.Контрагент) = Тип("СправочникСсылка.Контрагенты") Тогда
					ПараметрыАналитики.Договор = Справочники.ДоговорыКонтрагентов.ПустаяСсылка();
				ИначеЕсли ТипЗнч(ПараметрыАналитики.Контрагент) = Тип("СправочникСсылка.Организации") Тогда
					ПараметрыАналитики.Договор = Справочники.ДоговорыМеждуОрганизациями.ПустаяСсылка();
				КонецЕсли;
			КонецЕсли;
			
			СтрокиАналитики = ТаблицаНайденнойАналитики.НайтиСтроки(ПараметрыАналитики);
			Если СтрокиАналитики.Количество() > 0 Тогда
				Запись.АналитикаУчетаПоПартнерам = СтрокиАналитики[0].АналитикаУчетаПоПартнерам;
			Иначе
				Запись.АналитикаУчетаПоПартнерам = РегистрыСведений.АналитикаУчетаПоПартнерам.ЗначениеКлючаАналитики(ПараметрыАналитики);
				НовСтр = ТаблицаНайденнойАналитики.Добавить();
				ЗаполнитьЗначенияСвойств(НовСтр, Запись);
			КонецЕсли;
		КонецЕсли;
		
		Если ТаблицаДвижений.Колонки.Найти("КорАналитикаУчетаПоПартнерам") <> Неопределено
			И ТаблицаДвижений.Колонки.Найти("КорОрганизация") <> Неопределено
			И НЕ ЗначениеЗаполнено(Запись.КорАналитикаУчетаПоПартнерам) 
			И ЗначениеЗаполнено(Запись.КорОрганизация)
			И ЗначениеЗаполнено(Запись.КорКонтрагент) Тогда
			ПараметрыАналитики.Партнер = Запись.КорПартнер;
			ПараметрыАналитики.Организация = Запись.КорОрганизация;
			ПараметрыАналитики.Контрагент = Запись.КорКонтрагент;
			ПараметрыАналитики.Договор = Запись.КорДоговор;
			ПараметрыАналитики.НаправлениеДеятельности = Запись.КорНаправлениеДеятельности;
			
			Если НЕ ЗначениеЗаполнено(ПараметрыАналитики.Договор) Тогда
				Если ТипЗнч(ПараметрыАналитики.Контрагент) = Тип("СправочникСсылка.Контрагенты") Тогда
					ПараметрыАналитики.Договор = Справочники.ДоговорыКонтрагентов.ПустаяСсылка();
				ИначеЕсли ТипЗнч(ПараметрыАналитики.Контрагент) = Тип("СправочникСсылка.Организации") Тогда
					ПараметрыАналитики.Договор = Справочники.ДоговорыМеждуОрганизациями.ПустаяСсылка();
				КонецЕсли;
			КонецЕсли;
			
			СтрокиАналитики = ТаблицаНайденнойАналитики.НайтиСтроки(ПараметрыАналитики);
			Если СтрокиАналитики.Количество() > 0 Тогда
				Запись.КорАналитикаУчетаПоПартнерам = СтрокиАналитики[0].АналитикаУчетаПоПартнерам;
			Иначе
				Запись.КорАналитикаУчетаПоПартнерам = РегистрыСведений.АналитикаУчетаПоПартнерам.ЗначениеКлючаАналитики(ПараметрыАналитики);
				НовСтр = ТаблицаНайденнойАналитики.Добавить();
				ЗаполнитьЗначенияСвойств(НовСтр, ПараметрыАналитики);
				НовСтр.АналитикаУчетаПоПартнерам = Запись.КорАналитикаУчетаПоПартнерам;
			КонецЕсли;
			
		КонецЕсли;
		
		Если ТаблицаДвижений.Колонки.Найти("АналитикаУчетаПоПартнерамПриемник") <> Неопределено
			И ТаблицаДвижений.Колонки.Найти("ОрганизацияПриемник") <> Неопределено
			И НЕ ЗначениеЗаполнено(Запись.АналитикаУчетаПоПартнерамПриемник) 
			И ЗначениеЗаполнено(Запись.ОрганизацияПриемник)
			И ЗначениеЗаполнено(Запись.КонтрагентПриемник) Тогда
			ПараметрыАналитики.Партнер = Запись.ПартнерПриемник;
			ПараметрыАналитики.Организация = Запись.ОрганизацияПриемник;
			ПараметрыАналитики.Контрагент = Запись.КонтрагентПриемник;
			ПараметрыАналитики.Договор = Запись.ДоговорПриемник;
			ПараметрыАналитики.НаправлениеДеятельности = Запись.НаправлениеДеятельностиПриемник;
			
			Если НЕ ЗначениеЗаполнено(ПараметрыАналитики.Договор) Тогда
				Если ТипЗнч(ПараметрыАналитики.Контрагент) = Тип("СправочникСсылка.Контрагенты") Тогда
					ПараметрыАналитики.Договор = Справочники.ДоговорыКонтрагентов.ПустаяСсылка();
				ИначеЕсли ТипЗнч(ПараметрыАналитики.Контрагент) = Тип("СправочникСсылка.Организации") Тогда
					ПараметрыАналитики.Договор = Справочники.ДоговорыМеждуОрганизациями.ПустаяСсылка();
				КонецЕсли;
			КонецЕсли;
			
			СтрокиАналитики = ТаблицаНайденнойАналитики.НайтиСтроки(ПараметрыАналитики);
			Если СтрокиАналитики.Количество() > 0 Тогда
				Запись.АналитикаУчетаПоПартнерамПриемник = СтрокиАналитики[0].АналитикаУчетаПоПартнерам;
			Иначе
				Запись.АналитикаУчетаПоПартнерамПриемник = РегистрыСведений.АналитикаУчетаПоПартнерам.ЗначениеКлючаАналитики(ПараметрыАналитики);
				НовСтр = ТаблицаНайденнойАналитики.Добавить();
				ЗаполнитьЗначенияСвойств(НовСтр, ПараметрыАналитики);
				НовСтр.АналитикаУчетаПоПартнерам = Запись.АналитикаУчетаПоПартнерамПриемник;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ВывестиПредупреждениеОбОбновлении(Макет) Экспорт
	
	Если Константы.РаспределятьФактическиеРасчетыФоновымЗаданием.Получить() Тогда
		
		ТаблицаПредупреждение = Новый ТабличныйДокумент;
		ОбластьГиперссылка = ТаблицаПредупреждение.Область(1,1,1,1);
		ОбластьПредупреждение = ТаблицаПредупреждение.Область(1,2,1,2);
		
		Если ОбновлениеИнформационнойБазы.ОтложенноеОбновлениеЗавершено() 
			И НЕ ОперативныеВзаиморасчетыСервер.МенеджерОтложенногоРаспределенияВзаиморасчетовАктивен() Тогда
			ТекстПредупреждения = НСтр("ru = 'Требуется запустить отложенное проведение документов по взаиморасчетам, данные в отчетах могут быть некорректными.'");
			ОбластьГиперссылка.Текст = "Запустить";
			ОбластьГиперссылка.ЦветТекста = ЦветаСтиля.ГиперссылкаЦвет;
			ОбластьГиперссылка.Шрифт = Новый Шрифт(ОбластьГиперссылка.Шрифт,,,,,Истина);
		ИначеЕсли ОперативныеВзаиморасчетыСервер.МенеджерОтложенногоРаспределенияВзаиморасчетовАктивен() Тогда
			ТекстПредупреждения = НСтр("ru = 'Происходит отложенное проведение документов по взаиморасчетам, данные в отчетах могут быть некорректными.'");
		Иначе
			ТекстПредупреждения = НСтр("ru = 'Не завершено отложенное обновление информационной базы, данные в отчетах могут быть некорректными.'");
		КонецЕсли;
		
		ОбластьПредупреждение.Текст = ТекстПредупреждения;
		ОбластьПредупреждение.ЦветТекста = ЦветаСтиля.ЦветОтрицательногоЧисла;
		
		Макет.ВставитьОбласть(ТаблицаПредупреждение.Область(1,1,1,2), Макет.Область(1,1,1,2), ТипСмещенияТабличногоДокумента.ПоВертикали);
		
	ИначеЕсли НЕ ОбновлениеИнформационнойБазы.ОтложенноеОбновлениеЗавершено() Тогда
		
		ТаблицаПредупреждение = Новый ТабличныйДокумент;
		ОбластьПредупреждение = ТаблицаПредупреждение.Область(1,1,1,1);
		
		ТекстПредупреждения = НСтр("ru = 'Не завершено отложенное обновление информационной базы, данные в отчетах могут быть некорректными.'");
		ОбластьПредупреждение.Текст = ТекстПредупреждения;
		ОбластьПредупреждение.ЦветТекста = ЦветаСтиля.ЦветОтрицательногоЧисла;
		
		Макет.ВставитьОбласть(ТаблицаПредупреждение.Область(1,1,1,1), Макет.Область(1,1,1,1), ТипСмещенияТабличногоДокумента.ПоВертикали);
		
	КонецЕсли;
	
КонецПроцедуры

// Соответствие объектов расчетов и курса валюта договора.
// 
// Параметры:
//  ОбъектыРасчетов - Массив из СправочникСсылка.ОбъектыРасчетов - Объекты расчетов для получения данных.
// 
// Возвращаемое значение:
// 	Соответствие Из КлючИЗначение - Содержит тексты запросов сторнирования, где:
// 		* Ключ - СправочникСсылка.ОбъектыРасчетов - объект расчетов, для которого получены данные.
// 		* Значение - Структура:
//      ** ВалютаВзаиморасчетов - СправочникСсылка.Валюты - Валюта взаиморасчетов данного объекта расчетов
//      ** ВариантКурсаДоговора - ПеречислениеСсылка.ВариантыКурсаДоговора - вариант курса договора для определения источника курса
//      ** ТипОбъектаРасчетов - ПеречислениеСсылка.ТипыОбъектовРасчетов - тип объекта расчетов 
//
Функция СоответствиеОбъектовРасчетовИПараметровДоговора(ОбъектыРасчетов) Экспорт 
	
	Результат = Новый Соответствие;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ОбъектыРасчетов", ОбъектыРасчетов);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетов,
	|	ЕСТЬNULL(ОбъектыРасчетов.Договор.ВариантКурсаДоговора, ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.Переменный)) КАК ВариантКурсаДоговора,
	|	ЕСТЬNULL(ДоговорыКонтрагентов.РазрешенаРаботаСДочернимиПартнерами, ЛОЖЬ) КАК РазрешенаРаботаСДочернимиПартнерами,
	|	ОбъектыРасчетов.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
	|	ОбъектыРасчетов.Объект КАК Объект,
	|	ОбъектыРасчетов.ТипОбъектаРасчетов КАК ТипОбъектаРасчетов
	|ИЗ
	|	Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
	|		ПО ОбъектыРасчетов.Договор = ДоговорыКонтрагентов.Ссылка
	|ГДЕ
	|	ОбъектыРасчетов.Ссылка В(&ОбъектыРасчетов)";
	УстановитьПривилегированныйРежим(Истина);
	Выборка = Запрос.Выполнить().Выбрать();
	УстановитьПривилегированныйРежим(Ложь);
	Пока Выборка.Следующий() Цикл
		СтруктураВариантаКурсаВалюты = Новый Структура("ВалютаВзаиморасчетов, ВариантКурсаДоговора, ТипОбъектаРасчетов");
		СтруктураВариантаКурсаВалюты.Вставить("РазрешенаРаботаСДочернимиПартнерами");
		СтруктураВариантаКурсаВалюты.Вставить("Объект");
		ЗаполнитьЗначенияСвойств(СтруктураВариантаКурсаВалюты, Выборка);
		Результат[Выборка.ОбъектРасчетов] = СтруктураВариантаКурсаВалюты;
	КонецЦикла;
	Если ОбъектыРасчетов.Найти(Справочники.ОбъектыРасчетов.ПустаяСсылка()) <> Неопределено Тогда
		СтруктураВариантаКурсаВалюты = Новый Структура(
			"ВалютаВзаиморасчетов, ВариантКурсаДоговора, ТипОбъектаРасчетов, Объект, РазрешенаРаботаСДочернимиПартнерами",
			Справочники.Валюты.ПустаяСсылка(),
			Перечисления.ВариантыКурсаДоговора.Переменный,
			Перечисления.ТипыОбъектовРасчетов.ПустаяСсылка(),
			Неопределено,
			Ложь);
		Результат[Справочники.ОбъектыРасчетов.ПустаяСсылка()] = СтруктураВариантаКурсаВалюты;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Процедура ЗаписатьКурсыИВалютыДокумента(Объект, МассивПараметров, Отказ)
	
	Если Отказ Тогда 
		Возврат;
	КонецЕсли;
	
	Для Каждого СтруктураПараметров Из МассивПараметров Цикл
		Если СтруктураПараметров.ЭтоПродажаЗакупка И СтруктураПараметров.ВариантКурсаДоговора = Перечисления.ВариантыКурсаДоговора.ФиксированныйНаДатуОтгрузки Тогда
			
			Организация = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Организация);
			ВалютаРегламентированногоУчета = ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(Организация);
			ВалютаУправленческогоУчета = ЗначениеНастроекПовтИсп.ВалютаУправленческогоУчета();
			
			ВалютыДляЗапросаКурсов = Новый Массив;
			
			ДатаКурса = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Дата);
			Если ЗначениеЗаполнено(СтруктураПараметров.ДатаКурсаВалютыДокумента) 
				И ЗначениеЗаполнено(ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ДатаКурсаВалютыДокумента)) Тогда
				ДатаКурса = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ДатаКурсаВалютыДокумента);
			ИначеЕсли СтруктураПараметров.ЕстьДатаПереходаПраваСобственности
				И ЗначениеЗаполнено(ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ДатаПереходаПраваСобственности)) Тогда
				ДатаКурса = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ДатаПереходаПраваСобственности);
			КонецЕсли;
			
			УстановитьПривилегированныйРежим(Истина);
			МенеджерЗаписи = РегистрыСведений.ВалютыИКурсыДокументов.СоздатьМенеджерЗаписи();
			Если СтруктураПараметров.Свойство("СсылкаНового") Тогда
				МенеджерЗаписи.Документ                   = СтруктураПараметров.СсылкаНового;
			Иначе
				МенеджерЗаписи.Документ                   = Объект.Ссылка;
			КонецЕсли;
			МенеджерЗаписи.ВалютаВзаиморасчетов           = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ВалютаВзаиморасчетов);
			МенеджерЗаписи.ВалютаДокумента                = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ВалютаДокумента);
			МенеджерЗаписи.ВалютаРегламентированногоУчета = ВалютаРегламентированногоУчета;
			
			Если МенеджерЗаписи.ВалютаДокумента = ВалютаРегламентированногоУчета Тогда
				МенеджерЗаписи.КурсЧислительВалютыВзаиморасчетов = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.КурсЧислитель);
				МенеджерЗаписи.КурсЗнаменательВалютыВзаиморасчетов = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.КурсЗнаменатель);
				МенеджерЗаписи.КурсЧислительВалютыДокумента = 1;
				МенеджерЗаписи.КурсЗнаменательВалютыДокумента = 1;
			ИначеЕсли МенеджерЗаписи.ВалютаВзаиморасчетов = ВалютаРегламентированногоУчета Тогда
				МенеджерЗаписи.КурсЧислительВалютыВзаиморасчетов = 1;
				МенеджерЗаписи.КурсЗнаменательВалютыВзаиморасчетов = 1;
				МенеджерЗаписи.КурсЧислительВалютыДокумента = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.КурсЧислитель);
				МенеджерЗаписи.КурсЗнаменательВалютыДокумента = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.КурсЗнаменатель);
			Иначе
				ВалютыДляЗапросаКурсов.Добавить(МенеджерЗаписи.ВалютаДокумента);
				ВалютыДляЗапросаКурсов.Добавить(МенеджерЗаписи.ВалютаВзаиморасчетов);
			КонецЕсли;
			
			Если ВалютаУправленческогоУчета = МенеджерЗаписи.ВалютаДокумента Тогда
				МенеджерЗаписи.КурсЧислительВалютыУправленческогоУчета = МенеджерЗаписи.КурсЧислительВалютыДокумента;
				МенеджерЗаписи.КурсЗнаменательВалютыУправленческогоУчета = МенеджерЗаписи.КурсЗнаменательВалютыДокумента;
			ИначеЕсли ВалютаУправленческогоУчета = МенеджерЗаписи.ВалютаВзаиморасчетов Тогда
				МенеджерЗаписи.КурсЧислительВалютыУправленческогоУчета = МенеджерЗаписи.КурсЧислительВалютыВзаиморасчетов;
				МенеджерЗаписи.КурсЗнаменательВалютыУправленческогоУчета = МенеджерЗаписи.КурсЗнаменательВалютыВзаиморасчетов;
			Иначе
				ВалютыДляЗапросаКурсов.Добавить(ВалютаУправленческогоУчета);
			КонецЕсли;
			
			Запрос = Новый Запрос;
			Запрос.УстановитьПараметр("МассивВалют", ВалютыДляЗапросаКурсов);
			Запрос.УстановитьПараметр("БазоваяВалюта", ВалютаРегламентированногоУчета);
			Запрос.УстановитьПараметр("Период", ДатаКурса);
			Запрос.Текст = 
				"ВЫБРАТЬ
				|	ОтносительныеКурсыВалютСрезПоследних.Валюта КАК Валюта,
				|	ОтносительныеКурсыВалютСрезПоследних.КурсЧислитель КАК КурсЧислитель,
				|	ОтносительныеКурсыВалютСрезПоследних.КурсЗнаменатель КАК КурсЗнаменатель
				|ИЗ
				|	РегистрСведений.ОтносительныеКурсыВалют.СрезПоследних(
				|			&Период,
				|			БазоваяВалюта = &БазоваяВалюта
				|				И Валюта В (&МассивВалют)) КАК ОтносительныеКурсыВалютСрезПоследних";
			Выборка = Запрос.Выполнить().Выбрать();
			Пока Выборка.Следующий() Цикл
				Если Выборка.Валюта = ВалютаУправленческогоУчета Тогда
					МенеджерЗаписи.КурсЧислительВалютыУправленческогоУчета = Выборка.КурсЧислитель;
					МенеджерЗаписи.КурсЗнаменательВалютыУправленческогоУчета = Выборка.КурсЗнаменатель;
				КонецЕсли;
				Если Выборка.Валюта = МенеджерЗаписи.ВалютаВзаиморасчетов Тогда
					МенеджерЗаписи.КурсЧислительВалютыВзаиморасчетов = Выборка.КурсЧислитель;
					МенеджерЗаписи.КурсЗнаменательВалютыВзаиморасчетов = Выборка.КурсЗнаменатель;
				КонецЕсли;
				Если Выборка.Валюта = МенеджерЗаписи.ВалютаДокумента Тогда
					МенеджерЗаписи.КурсЧислительВалютыДокумента = Выборка.КурсЧислитель;
					МенеджерЗаписи.КурсЗнаменательВалютыДокумента = Выборка.КурсЗнаменатель;
				КонецЕсли;
			КонецЦикла;
			
			МенеджерЗаписи.Записать(Истина);
			УстановитьПривилегированныйРежим(Ложь);
			Прервать;
			
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Параметры:
//  Объект - СправочникОбъект.ДоговорыКонтрагентов, СправочникОбъект.ДоговорыМеждуОрганизациями - Объект для проверки заполнения
Процедура ПроверитьЗаполнитьВариантКурсаВалютыДоговора(Объект) Экспорт
	Если Не ЗначениеЗаполнено(Объект.ВариантКурсаДоговора) Тогда
		Объект.ВариантКурсаДоговора = Перечисления.ВариантыКурсаДоговора.Переменный;
	КонецЕсли;
КонецПроцедуры

// Для накладной по нескольким заказам возвращает массив этих заказов
//
// Параметры:
//  Объект - ДокументОбъект, СправочникОбъект, ФормаКлиентскогоПриложения - объект для поиска заказов
//  СтруктураПараметров - см. ВзаиморасчетыСервер.ПараметрыМеханизма
// 
// Возвращаемое значение:
//  Массив из ДокументСсылка
Функция ПолучитьМассивЗаказовИзТЧ(Объект, СтруктураПараметров)
	
	МассивЗаказов = Новый Массив;
	ТЧ = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ПутьКДаннымТЧ);
	Если ЗначениеЗаполнено(ТЧ) И ЗначениеЗаполнено(СтруктураПараметров.ИмяРеквизитаТЧЗаказ) Тогда
		Заказы = ТЧ.Выгрузить(, СтруктураПараметров.ИмяРеквизитаТЧЗаказ);
		Заказы.Свернуть(СтруктураПараметров.ИмяРеквизитаТЧЗаказ,);
		МассивЗаказов = Заказы.ВыгрузитьКолонку(СтруктураПараметров.ИмяРеквизитаТЧЗаказ);
		
		сч = 0;
		Пока сч < МассивЗаказов.Количество() Цикл
			Если Не ЗначениеЗаполнено(МассивЗаказов[сч]) Тогда
				МассивЗаказов.Удалить(сч);
			Иначе
				сч= сч + 1;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Возврат МассивЗаказов;
	
Конецфункции

// Находит Объекты расчетов накладных и заказа по ссылке на заказ
// 
// Параметры:
//  ОбъектРасчетов - СправочникСсылка.ОбъектыРасчетов - Объект расчетов накладная
//  ЭтоРасчетыСКлиентом - Булево - В каких расчетах искать
// 
// Возвращаемое значение:
//  Массив из СправочникСсылка.ОбъектыРасчетов - Найденные объекты расчетов заказы
Функция ОбъектыРасчетовЗаказыПоНакладной(ОбъектРасчетов, ЭтоРасчетыСКлиентом) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ОбъектРасчетов", ОбъектРасчетов);
	Если ЭтоРасчетыСКлиентом Тогда
		Запрос.Текст = 
			"ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетовЗаказ
			|ИЗ
			|	РегистрНакопления.РасчетыСКлиентами КАК РасчетыСКлиентами
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
			|		ПО РасчетыСКлиентами.ПродажаПоЗаказу = ОбъектыРасчетов.Объект
			|			И НЕ ОбъектыРасчетов.ПометкаУдаления
			|ГДЕ
			|	РасчетыСКлиентами.ОбъектРасчетов В (&ОбъектРасчетов)
			|	И РасчетыСКлиентами.Активность";
	Иначе
		Запрос.Текст = 
			"ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетовЗаказ
			|ИЗ
			|	РегистрНакопления.РасчетыСПоставщиками КАК РасчетыСПоставщиками
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
			|		ПО РасчетыСПоставщиками.ЗакупкаПоЗаказу = ОбъектыРасчетов.Объект
			|			И НЕ ОбъектыРасчетов.ПометкаУдаления
			|ГДЕ
			|	РасчетыСПоставщиками.ОбъектРасчетов В (&ОбъектРасчетов)
			|	И РасчетыСПоставщиками.Активность";
	КонецЕсли;
	
	Результат = Новый Массив;
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Если ЗначениеЗаполнено(Выборка.ОбъектРасчетовЗаказ) Тогда
			Результат.Добавить(Выборка.ОбъектРасчетовЗаказ);
		КонецЕсли;
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

// Находит Объекты расчетов для отображения в отчете по переданным документам
// 
// Параметры:
//  ПараметрОтчета - ДокументСсылка, Массив из ДокументСсылка - Документ, из которого открывается контекстный отчет
// 
// Возвращаемое значение:
//  Массив из СправочникСсылка.ОбъектыРасчетов, СправочникСсылка.ОбъектыРасчетов - Найденные объекты расчетов
Функция ПолучитьОбъектыРасчетовДляОтбораОтчета(ПараметрОтчета) Экспорт
	
	Результат = Справочники.ОбъектыРасчетов.ПустаяСсылка();
	
	Если ТипЗнч(ПараметрОтчета) = Тип("Массив") Тогда
		Если ПараметрОтчета.Количество() > 0 Тогда
			ПервыйЭлемент = ПараметрОтчета[0];
		Иначе
			Возврат Результат;
		КонецЕсли;
	Иначе
		ПервыйЭлемент = ПараметрОтчета;
	КонецЕсли;
	
	МетаданныеПоСсылке = ПервыйЭлемент.Метаданные();
	Менеджер = ОбщегоНазначения.МенеджерОбъектаПоСсылке(ПервыйЭлемент);
	ПараметрыВзаиморасчеты = Менеджер.ПараметрыВзаиморасчеты();
	
	Если ТипЗнч(ПараметрыВзаиморасчеты) = Тип("Массив") Тогда
		МассивПараметров = ПараметрыВзаиморасчеты;
	Иначе
		МассивПараметров = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(ПараметрыВзаиморасчеты);
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Ссылка", ПараметрОтчета);
	
	Для Каждого СтруктураПараметров Из МассивПараметров Цикл
		Если ЗначениеЗаполнено(СтруктураПараметров.ОбъектРасчетов) Тогда
			
			// Сформируем запрос по получению ОбъектаРасчетов и Порядка расчетов во временную таблицу
			ЧастиПути = СтрРазделить(СтруктураПараметров.ОбъектРасчетов, ".");
			Если ЧастиПути.Количество() = 2 Тогда
				ТекстЗапросаОбъектаРасчетов = "
					|ВЫБРАТЬ
					|	Таблица.Ссылка КАК Ссылка,
					|	Таблица.ИмяРеквизита КАК ОбъектРасчетов,
					|	&ПорядокРасчетов КАК ПорядокРасчетов
					|ПОМЕСТИТЬ ВтОбъектРасчетов
					|ИЗ
					|	&Таблица КАК Таблица
					|ГДЕ
					|	Таблица.Ссылка В (&Ссылка)";
				ТекстЗапросаОбъектаРасчетов = СтрЗаменить(ТекстЗапросаОбъектаРасчетов, "&Таблица", МетаданныеПоСсылке.ПолноеИмя());
				ТекстЗапросаОбъектаРасчетов = СтрЗаменить(ТекстЗапросаОбъектаРасчетов, "ИмяРеквизита", ЧастиПути[1]);
				ЗапросКТЧ = Ложь;
			Иначе
				ТекстЗапросаОбъектаРасчетов = "
					|ВЫБРАТЬ РАЗЛИЧНЫЕ
					|	ТабличнаяЧасть.Ссылка КАК Ссылка,
					|	ТабличнаяЧасть.ИмяРеквизита КАК ОбъектРасчетов,
					|	&ПорядокРасчетов КАК ПорядокРасчетов
					|ПОМЕСТИТЬ ВтОбъектРасчетов
					|ИЗ
					|	&ТабличнаяЧасть КАК ТабличнаяЧасть
					|ГДЕ
					|	ТабличнаяЧасть.Ссылка В (&Ссылка)";
				ТекстЗапросаОбъектаРасчетов = СтрЗаменить(ТекстЗапросаОбъектаРасчетов, "&ТабличнаяЧасть", МетаданныеПоСсылке.ПолноеИмя() + "." + ЧастиПути[1]);
				ТекстЗапросаОбъектаРасчетов = СтрЗаменить(ТекстЗапросаОбъектаРасчетов, "ИмяРеквизита", ЧастиПути[2]);
				ЗапросКТЧ = Истина;
			КонецЕсли;
			
			Если ТипЗнч(СтруктураПараметров.ПорядокРасчетов) = Тип("ПеречислениеСсылка.ПорядокРасчетов") Тогда
				Запрос.УстановитьПараметр("ПорядокРасчетов", СтруктураПараметров.ПорядокРасчетов);
			Иначе
				ЧастиПути = СтрРазделить(СтруктураПараметров.ПорядокРасчетов, ".");
				ЧастиПути.Удалить(0);
				Если ЗапросКТЧ Тогда
					ЧастиПути.Вставить(0, "ТабличнаяЧасть.Ссылка");
				Иначе
					ЧастиПути.Вставить(0, "Таблица");
				КонецЕсли;
				ТекстЗапросаОбъектаРасчетов = СтрЗаменить(ТекстЗапросаОбъектаРасчетов, "&ПорядокРасчетов", СтрСоединить(ЧастиПути, "."));
			КонецЕсли;
			
			// Получаем объекты расчетов из временной таблицы и добавляем связанные объекты расчетов в зависимости от порядка расчетов
			ТекстЗапроса = "
				|ВЫБРАТЬ
				|	ВтОбъектРасчетов.ОбъектРасчетов КАК ОбъектРасчетов
				|ИЗ
				|	ВтОбъектРасчетов КАК ВтОбъектРасчетов 
				|ГДЕ
				|	ВтОбъектРасчетов.ОбъектРасчетов <> ЗНАЧЕНИЕ(Справочник.ОбъектыРасчетов.ПустаяСсылка)
				|";
				
			Если СтруктураПараметров.ЭтоПродажаЗакупка Тогда
				ТекстЗапроса = ТекстЗапроса + ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + "
					|ВЫБРАТЬ
					|	ОбъектыРасчетовДоговор.Ссылка
					|ИЗ
					|	ВтОбъектРасчетов КАК ВтОбъектРасчетов
					|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
					|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетовДоговор
					|			ПО ОбъектыРасчетов.Договор = ОбъектыРасчетовДоговор.Объект
					|				И НЕ ОбъектыРасчетов.ПометкаУдаления
					|		ПО ВтОбъектРасчетов.ОбъектРасчетов = ОбъектыРасчетов.Ссылка
					|ГДЕ
					|	ВтОбъектРасчетов.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
					|
					|ОБЪЕДИНИТЬ ВСЕ
					|
					|ВЫБРАТЬ
					|	ОбъектыРасчетов.Ссылка
					|ИЗ
					|	ВтОбъектРасчетов КАК ВтОбъектРасчетов
					|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентами КАК Расчеты
					|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
					|			ПО (Расчеты.ПродажаПоЗаказу = ОбъектыРасчетов.Объект)
					|				И НЕ ОбъектыРасчетов.ПометкаУдаления
					|		ПО (ВтОбъектРасчетов.ОбъектРасчетов = Расчеты.ОбъектРасчетов)
					|ГДЕ
					|	ВтОбъектРасчетов.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
					|";
			ИначеЕсли СтруктураПараметров.ЭтоЗаказ Тогда
				ТекстЗапроса = ТекстЗапроса + ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + "
					|ВЫБРАТЬ
					|	ОбъектыРасчетов.Ссылка
					|ИЗ
					|	ВтОбъектРасчетов КАК ВтОбъектРасчетов
					|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РаспоряженияНаОтгрузку.Обороты(
					|				,
					|				,
					|				Регистратор,
					|				Распоряжение В
					|					(ВЫБРАТЬ
					|						Т.Ссылка
					|					ИЗ
					|						ВтОбъектРасчетов КАК Т)) КАК РаспоряженияОбороты
					|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
					|			ПО РаспоряженияОбороты.Регистратор = ОбъектыРасчетов.Объект
					|				И НЕ ОбъектыРасчетов.ПометкаУдаления
					|		ПО ВтОбъектРасчетов.Ссылка = РаспоряженияОбороты.Распоряжение
					|			И ВтОбъектРасчетов.Ссылка <> РаспоряженияОбороты.Регистратор
					|ГДЕ
					|	ВтОбъектРасчетов.ПорядокРасчетов В (ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным),
					|	                                    ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным),
					|	                                    ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоНакладным))
					|";
			КонецЕсли;
			
			Если СтруктураПараметров.ТипРасчетов = Перечисления.ТипыРасчетовСПартнерами.РасчетыСПоставщиком Тогда
				ТекстЗапроса = СтрЗаменить(ТекстЗапроса, Метаданные.РегистрыНакопления.РасчетыСКлиентами.Имя, Метаданные.РегистрыНакопления.РасчетыСПоставщиками.Имя);
				ТекстЗапроса = СтрЗаменить(ТекстЗапроса, Метаданные.РегистрыНакопления.РасчетыСКлиентами.Реквизиты.ПродажаПоЗаказу.Имя, Метаданные.РегистрыНакопления.РасчетыСПоставщиками.Реквизиты.ЗакупкаПоЗаказу.Имя);
				ТекстЗапроса = СтрЗаменить(ТекстЗапроса, Метаданные.РегистрыНакопления.РаспоряженияНаОтгрузку.Измерения.Распоряжение.Имя, Метаданные.РегистрыНакопления.ЗаказыПоставщикам.Измерения.ЗаказПоставщику.Имя);
				ТекстЗапроса = СтрЗаменить(ТекстЗапроса, Метаданные.РегистрыНакопления.РаспоряженияНаОтгрузку.Имя, Метаданные.РегистрыНакопления.ЗаказыПоставщикам.Имя);
			КонецЕсли;
			
			Запрос.Текст = ТекстЗапросаОбъектаРасчетов + ОбщегоНазначения.РазделительПакетаЗапросов() + ТекстЗапроса;
			
			Прервать;
			
		КонецЕсли;
	КонецЦикла;
	
	Если НЕ ПустаяСтрока(Запрос.Текст) Тогда
		Результат = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("ОбъектРасчетов");
		Результат = ОбщегоНазначенияКлиентСервер.СвернутьМассив(Результат);
		Если Результат.Количество() = 0 Тогда
			Результат = Справочники.ОбъектыРасчетов.ПустаяСсылка();
		ИначеЕсли Результат.Количество() = 1 Тогда
			Результат = Результат[0];
		КонецЕсли;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Параметры:
//  Заказ		 - ДокументСсылка - ссылка на заказ
//  ТипРасчетов	 - ПеречислениеСсылка.ТипыРасчетовСПартнерами - Расчеты с клиентом или поставщиком
// 
// Возвращаемое значение: 
//  - Неопределено - если не найдена запись о состоянии заказа
//  - см. СтруктураСостоянияРасчетов
//
Функция СостояниеВзаиморасчетовЗаказа(Заказ, ТипРасчетов)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Заказ", Заказ);
	Если ТипРасчетов = Перечисления.ТипыРасчетовСПартнерами.РасчетыСКлиентом Тогда
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	СостоянияЗаказовКлиентов.СуммаОплаты     КАК СуммаОплат,
			|	СостоянияЗаказовКлиентов.ПроцентОплаты   КАК ПроцентОплат,
			|	СостоянияЗаказовКлиентов.СуммаОтгрузки   КАК СуммаОтгрузок,
			|	СостоянияЗаказовКлиентов.ПроцентОтгрузки КАК ПроцентОтгрузок,
			|	СостоянияЗаказовКлиентов.СуммаДолга      КАК СуммаЗадолженности
			|ИЗ
			|	РегистрСведений.СостоянияЗаказовКлиентов КАК СостоянияЗаказовКлиентов
			|ГДЕ
			|	СостоянияЗаказовКлиентов.Заказ = &Заказ";
	Иначе
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	СостоянияЗаказовПоставщикам.СуммаОплаты        КАК СуммаОплат,
			|	СостоянияЗаказовПоставщикам.ПроцентОплаты      КАК ПроцентОплат,
			|	СостоянияЗаказовПоставщикам.СуммаПоступления   КАК СуммаПоставок,
			|	СостоянияЗаказовПоставщикам.ПроцентПоступления КАК ПроцентПоставок,
			|	СостоянияЗаказовПоставщикам.СуммаДолга         КАК СуммаЗадолженности
			|ИЗ
			|	РегистрСведений.СостоянияЗаказовПоставщикам КАК СостоянияЗаказовПоставщикам
			|ГДЕ
			|	СостоянияЗаказовПоставщикам.Заказ = &Заказ";
	КонецЕсли;
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Результат = СтруктураСостоянияРасчетов();
		ЗаполнитьЗначенияСвойств(Результат, Выборка);
		Возврат Результат;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

// Возвращаемое значение:
//   Структура:
//      * СуммаОплат - Число.
//      * ПроцентОплат - Число.
//      * СуммаОтгрузок - Число.
//      * ПроцентОтгрузок - Число.
//      * СуммаПоставок - Число.
//      * ПроцентПоставок - Число.
//      * СуммаЗадолженности - Число.
//
Функция СтруктураСостоянияРасчетов()
	
	СтруктураСостоянияРасчетов = Новый Структура;
	СтруктураСостоянияРасчетов.Вставить("СуммаОплат", 0 );
	СтруктураСостоянияРасчетов.Вставить("ПроцентОплат", 0 );
	СтруктураСостоянияРасчетов.Вставить("СуммаОтгрузок", 0 );
	СтруктураСостоянияРасчетов.Вставить("ПроцентОтгрузок", 0 );
	СтруктураСостоянияРасчетов.Вставить("СуммаПоставок", 0 );
	СтруктураСостоянияРасчетов.Вставить("ПроцентПоставок", 0 );
	СтруктураСостоянияРасчетов.Вставить("СуммаЗадолженности", 0 );
	
	Возврат СтруктураСостоянияРасчетов;
	
КонецФункции

Процедура ПроверитьОбъектыРасчетовНаПометкуУдаления(ТаблицаДвижений, Отказ, ЭтоРасчетыСКлиентами)
	
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	ОбъектыРасчетов = ТаблицаДвижений.Скопировать(,"ОбъектРасчетов");
	ОбъектыРасчетов.Свернуть("ОбъектРасчетов");
	ОбъектыРасчетов = ОбъектыРасчетов.ВыгрузитьКолонку("ОбъектРасчетов");
	
	ПометкиУдаления = ОбщегоНазначения.ЗначениеРеквизитаОбъектов(ОбъектыРасчетов,"ПометкаУдаления");
	Для Каждого КлючИЗначение Из ПометкиУдаления Цикл
		Если КлючИЗначение.Значение Тогда
			Отказ = Истина;
			ВызватьИсключение(СтрШаблон(НСтр("ru = 'Объект расчетов %1 не может быть выбран в документах, т.к. исходный объект больше не является объектом расчетов или помечен на удаление.'"),
													КлючИЗначение.Ключ));
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Округляет проценты оплаты, отгрузки
//
// Параметры:
//	ОкругляемоеЧисло - Число - округляемое число.
//
// Возвращаемое значение:
//  Число - целое число процентов
//
Функция ОкруглитьПроценты(ОкругляемоеЧисло)
	
	Если ОкругляемоеЧисло > 99
		И ОкругляемоеЧисло < 100 Тогда
		Результат = 99;
	ИначеЕсли ОкругляемоеЧисло > 0
		И ОкругляемоеЧисло < 1 Тогда
		Результат = 1;
	Иначе
		Результат = Окр(ОкругляемоеЧисло);
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Функция ТекстЗапросаОбъектовРасчетов()

	Возврат 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	Филиалы.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ ЦентрализованныеДоговоры
	|ИЗ
	|	Справочник.ДоговорыКонтрагентов.Филиалы КАК Филиалы
	|ГДЕ
	|	Филиалы.Организация = &Организация
	|;
	|///////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетов,
	|	ОбъектыРасчетов.Объект КАК Объект,
	|	ОбъектыРасчетов.Организация.ВалютаРегламентированногоУчета КАК ВалютаРегламентированногоУчета
	|ПОМЕСТИТЬ ОбъектыРасчетов
	|ИЗ
	|	Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
	|ГДЕ
	|	НЕ ОбъектыРасчетов.ПометкаУдаления
	|	И (ОбъектыРасчетов.Организация В (&Организация) 
	|	ИЛИ НЕ &ЭтоГоловнаяОрганизация 
	|		И ОбъектыРасчетов.Договор В (ВЫБРАТЬ Ссылка ИЗ ЦентрализованныеДоговоры)
	|		И (ОбъектыРасчетов.Организация = &ГоловнаяОрганизация
	|			ИЛИ ОбъектыРасчетов.Договор.РазрешаетсяПередачаОплатМеждуФилиалами)
	|	ИЛИ &ЭтоГоловнаяОрганизация
	|		И ОбъектыРасчетов.Организация.ГоловнаяОрганизация В (&Организация)
	|		И ОбъектыРасчетов.Организация.ДопускаютсяВзаиморасчетыЧерезГоловнуюОрганизацию)
	|	И (ОбъектыРасчетов.Партнер = &Партнер ИЛИ &ПоВсемПартнерам)
	|	И (ОбъектыРасчетов.Контрагент = &Контрагент ИЛИ &ПоВсемКонтрагентам)
	|	И (&ПартнерПрочиеОтношения И ОбъектыРасчетов.Партнер.ПрочиеОтношения
	|		ИЛИ НЕ &ПартнерПрочиеОтношения)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ОбъектРасчетов
	|";

КонецФункции

Функция ТекстЗапросаОстаткиПоРегистрамРасчетовСКлиентами()

	Возврат 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	РасчетыСКлиентамиПоСрокам.ДокументРегистратор КАК ДокументРегистратор
	|ПОМЕСТИТЬ ИсключаемыеДокументыПоДатеВозникновения
	|ИЗ
	|	РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК РасчетыСКлиентамиПоСрокам
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОбъектыРасчетов КАК ОбъектыРасчетов
	|		ПО РасчетыСКлиентамиПоСрокам.ОбъектРасчетов = ОбъектыРасчетов.ОбъектРасчетов
	|ГДЕ
	|	РасчетыСКлиентамиПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И &ИсключитьПоДатеВозникновения
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РасчетыСКлиентамиПланОплатОбороты.ОбъектРасчетов КАК ОбъектРасчетов,
	|	РасчетыСКлиентамиПланОплатОбороты.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	РасчетыСКлиентамиПланОплатОбороты.ДатаПлановогоПогашения КАК ДатаПлановогоПогашения,
	|	РасчетыСКлиентамиПланОплатОбороты.КОплатеПриход КАК КОплатеПриход
	|ПОМЕСТИТЬ ЗапланированнаяОплата
	|ИЗ
	|	РегистрНакопления.РасчетыСКлиентамиПланОплат.Обороты(
	|			,
	|			,
	|			,
	|			&ДебиторскаяЗадолженность
	|				И НЕ &ТолькоБезусловнаяЗадолженность
	|				И ОбъектРасчетов В
	|					(ВЫБРАТЬ
	|						ОбъектыРасчетов.ОбъектРасчетов
	|					ИЗ
	|						ОбъектыРасчетов КАК ОбъектыРасчетов)
	|				И &ОтборПоДатеВозникновения) КАК РасчетыСКлиентамиПланОплатОбороты
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РасчетыСКлиентамиПланОплат.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	РасчетыСКлиентамиПланОплат.ОбъектРасчетов КАК ОбъектРасчетов,
	|	РасчетыСКлиентамиПланОплат.ДатаПлановогоПогашения КАК ДатаПлановогоПогашения,
	|	СУММА(РасчетыСКлиентамиПланОплат.КОплате) КАК КОплатеРасход
	|ПОМЕСТИТЬ ПоступившаяОплатаПоПлануОплат
	|ИЗ
	|	РегистрНакопления.РасчетыСКлиентамиПланОплат КАК РасчетыСКлиентамиПланОплат
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОбъектыРасчетов КАК ОбъектыРасчетов
	|		ПО (РасчетыСКлиентамиПланОплат.ОбъектРасчетов = ОбъектыРасчетов.ОбъектРасчетов)
	|ГДЕ
	|	РасчетыСКлиентамиПланОплат.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И &ДебиторскаяЗадолженность
	|	И НЕ &ТолькоБезусловнаяЗадолженность
	|	И НЕ РасчетыСКлиентамиПланОплат.ДокументРегистратор В
	|				(ВЫБРАТЬ
	|					ИсключаемыеДокументыПоДатеВозникновения.ДокументРегистратор
	|				ИЗ
	|					ИсключаемыеДокументыПоДатеВозникновения)
	|
	|СГРУППИРОВАТЬ ПО
	|	РасчетыСКлиентамиПланОплат.АналитикаУчетаПоПартнерам,
	|	РасчетыСКлиентамиПланОплат.ОбъектРасчетов,
	|	РасчетыСКлиентамиПланОплат.ДатаПлановогоПогашения
	|;
	|
	|///////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗапланированнаяОплата.ОбъектРасчетов КАК ОбъектРасчетов,
	|	ЗапланированнаяОплата.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	ЗапланированнаяОплата.ДатаПлановогоПогашения КАК ДатаПлановогоПогашения,
	|	ЗапланированнаяОплата.КОплатеПриход - ЕСТЬNULL(ПоступившаяОплатаПоПлануОплат.КОплатеРасход, 0) КАК КОплатеОстаток
	|ПОМЕСТИТЬ РасчетыСКлиентамиПланОплатОстатки
	|ИЗ
	|	ЗапланированнаяОплата КАК ЗапланированнаяОплата
	|		ЛЕВОЕ СОЕДИНЕНИЕ ПоступившаяОплатаПоПлануОплат КАК ПоступившаяОплатаПоПлануОплат
	|		ПО ЗапланированнаяОплата.ОбъектРасчетов = ПоступившаяОплатаПоПлануОплат.ОбъектРасчетов
	|			И ЗапланированнаяОплата.АналитикаУчетаПоПартнерам = ПоступившаяОплатаПоПлануОплат.АналитикаУчетаПоПартнерам
	|			И ЗапланированнаяОплата.ДатаПлановогоПогашения = ПоступившаяОплатаПоПлануОплат.ДатаПлановогоПогашения
	|ГДЕ
	|	ЗапланированнаяОплата.КОплатеПриход - ЕСТЬNULL(ПоступившаяОплатаПоПлануОплат.КОплатеРасход, 0) > 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РасчетыСКлиентами.ОбъектРасчетов КАК ОбъектРасчетов,
	|	РасчетыСКлиентами.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	РасчетыСКлиентами.ДолгОстаток КАК ДолгОстаток,
	|	ВЫБОР
	|		КОГДА &ТолькоБезусловнаяЗадолженность
	|			ТОГДА 0
	|		ИНАЧЕ РасчетыСКлиентами.ДолгОстаток
	|	КОНЕЦ КАК КОплате,
	|	РасчетыСКлиентами.ПредоплатаОстаток КАК ПредоплатаОстаток,
	|	РасчетыСКлиентами.ДатаПлановогоПогашения КАК ДатаПлановогоПогашения
	|ПОМЕСТИТЬ РасчетыСКлиентамиПоСрокамОстатки
	|ИЗ
	|	РегистрНакопления.РасчетыСКлиентамиПоСрокам.Остатки(
	|			,
	|			ОбъектРасчетов В
	|					(ВЫБРАТЬ
	|						ОбъектыРасчетов.ОбъектРасчетов
	|					ИЗ
	|						ОбъектыРасчетов КАК ОбъектыРасчетов)
	|				И &ОтборПоДатеВозникновения) КАК РасчетыСКлиентами
	|ГДЕ
	|	(НЕ &ДебиторскаяЗадолженность
	|				И РасчетыСКлиентами.ПредоплатаОстаток > 0
	|			ИЛИ &ДебиторскаяЗадолженность
	|				И РасчетыСКлиентами.ДолгОстаток > 0)
	|";

КонецФункции

Функция ТекстЗапросаОстаткиПоРегистрамРасчетовСПоставщиками()

	Возврат 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	РасчетыСПоставщикамиПоСрокам.ДокументРегистратор КАК ДокументРегистратор
	|ПОМЕСТИТЬ ИсключаемыеДокументыПоДатеВозникновения
	|ИЗ
	|	РегистрНакопления.РасчетыСПоставщикамиПоСрокам КАК РасчетыСПоставщикамиПоСрокам
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОбъектыРасчетов КАК ОбъектыРасчетов
	|		ПО РасчетыСПоставщикамиПоСрокам.ОбъектРасчетов = ОбъектыРасчетов.ОбъектРасчетов
	|ГДЕ
	|	РасчетыСПоставщикамиПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И &ИсключитьПоДатеВозникновения
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РасчетыСПоставщикамиПланОплатОбороты.ОбъектРасчетов КАК ОбъектРасчетов,
	|	РасчетыСПоставщикамиПланОплатОбороты.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	РасчетыСПоставщикамиПланОплатОбороты.ДатаПлановогоПогашения КАК ДатаПлановогоПогашения,
	|	РасчетыСПоставщикамиПланОплатОбороты.КОплатеПриход КАК КОплатеПриход,
	|	РасчетыСПоставщикамиПланОплатОбороты.Валюта КАК Валюта
	|ПОМЕСТИТЬ ЗапланированнаяОплата
	|ИЗ
	|	РегистрНакопления.РасчетыСПоставщикамиПланОплат.Обороты(
	|			,
	|			,
	|			,
	|			НЕ &ДебиторскаяЗадолженность
	|				И НЕ &ТолькоБезусловнаяЗадолженность
	|				И ОбъектРасчетов В
	|					(ВЫБРАТЬ
	|						ОбъектыРасчетов.ОбъектРасчетов
	|					ИЗ
	|						ОбъектыРасчетов КАК ОбъектыРасчетов)
	|				И &ОтборПоДатеВозникновения) КАК РасчетыСПоставщикамиПланОплатОбороты
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РасчетыСПоставщикамиПланОплат.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	РасчетыСПоставщикамиПланОплат.ОбъектРасчетов КАК ОбъектРасчетов,
	|	РасчетыСПоставщикамиПланОплат.ДатаПлановогоПогашения КАК ДатаПлановогоПогашения,
	|	РасчетыСПоставщикамиПланОплат.Валюта КАК Валюта,
	|	СУММА(РасчетыСПоставщикамиПланОплат.КОплате) КАК КОплатеРасход
	|ПОМЕСТИТЬ ИсполненнаяОплатаПоПлануОплат
	|ИЗ
	|	РегистрНакопления.РасчетыСПоставщикамиПланОплат КАК РасчетыСПоставщикамиПланОплат
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОбъектыРасчетов КАК ОбъектыРасчетов
	|		ПО (РасчетыСПоставщикамиПланОплат.ОбъектРасчетов = ОбъектыРасчетов.ОбъектРасчетов)
	|ГДЕ
	|	РасчетыСПоставщикамиПланОплат.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И НЕ &ДебиторскаяЗадолженность
	|	И НЕ &ТолькоБезусловнаяЗадолженность
	|	И НЕ РасчетыСПоставщикамиПланОплат.ДокументРегистратор В
	|				(ВЫБРАТЬ
	|					ИсключаемыеДокументыПоДатеВозникновения.ДокументРегистратор
	|				ИЗ
	|					ИсключаемыеДокументыПоДатеВозникновения)
	|
	|СГРУППИРОВАТЬ ПО
	|	РасчетыСПоставщикамиПланОплат.АналитикаУчетаПоПартнерам,
	|	РасчетыСПоставщикамиПланОплат.ОбъектРасчетов,
	|	РасчетыСПоставщикамиПланОплат.Валюта,
	|	РасчетыСПоставщикамиПланОплат.ДатаПлановогоПогашения
	|;
	|
	|///////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗапланированнаяОплата.ОбъектРасчетов КАК ОбъектРасчетов,
	|	ЗапланированнаяОплата.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	ЗапланированнаяОплата.ДатаПлановогоПогашения КАК ДатаПлановогоПогашения,
	|	ЗапланированнаяОплата.Валюта КАК Валюта,
	|	ЗапланированнаяОплата.КОплатеПриход - ЕСТЬNULL(ИсполненнаяОплатаПоПлануОплат.КОплатеРасход, 0) КАК КОплатеОстаток
	|ПОМЕСТИТЬ РасчетыСПоставщикамиПланОплатОстатки
	|ИЗ
	|	ЗапланированнаяОплата КАК ЗапланированнаяОплата
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИсполненнаяОплатаПоПлануОплат КАК ИсполненнаяОплатаПоПлануОплат
	|		ПО ЗапланированнаяОплата.ОбъектРасчетов = ИсполненнаяОплатаПоПлануОплат.ОбъектРасчетов
	|			И ЗапланированнаяОплата.АналитикаУчетаПоПартнерам = ИсполненнаяОплатаПоПлануОплат.АналитикаУчетаПоПартнерам
	|			И ЗапланированнаяОплата.Валюта = ИсполненнаяОплатаПоПлануОплат.Валюта
	|			И ЗапланированнаяОплата.ДатаПлановогоПогашения = ИсполненнаяОплатаПоПлануОплат.ДатаПлановогоПогашения
	|ГДЕ
	|	ЗапланированнаяОплата.КОплатеПриход - ЕСТЬNULL(ИсполненнаяОплатаПоПлануОплат.КОплатеРасход, 0) > 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РасчетыСПоставщиками.ОбъектРасчетов КАК ОбъектРасчетов,
	|	РасчетыСПоставщиками.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	РасчетыСПоставщиками.ДолгОстаток КАК ДолгОстаток,
	|	ВЫБОР
	|		КОГДА &ТолькоБезусловнаяЗадолженность
	|			ТОГДА 0
	|		ИНАЧЕ РасчетыСПоставщиками.ДолгОстаток
	|	КОНЕЦ КАК КОплате,
	|	РасчетыСПоставщиками.ПредоплатаОстаток КАК ПредоплатаОстаток,
	|	РасчетыСПоставщиками.Валюта КАК Валюта,
	|	РасчетыСПоставщиками.ДатаПлановогоПогашения КАК ДатаПлановогоПогашения
	|ПОМЕСТИТЬ РасчетыСПоставщикамиПоСрокамОстатки
	|ИЗ
	|	РегистрНакопления.РасчетыСПоставщикамиПоСрокам.Остатки(
	|			,
	|			ОбъектРасчетов В
	|					(ВЫБРАТЬ
	|						ОбъектыРасчетов.ОбъектРасчетов
	|					ИЗ
	|						ОбъектыРасчетов КАК ОбъектыРасчетов)
	|				И &ОтборПоДатеВозникновения) КАК РасчетыСПоставщиками
	|ГДЕ
	|	(&ДебиторскаяЗадолженность
	|				И РасчетыСПоставщиками.ПредоплатаОстаток > 0
	|			ИЛИ НЕ &ДебиторскаяЗадолженность
	|				И РасчетыСПоставщиками.ДолгОстаток > 0)
	|";

КонецФункции

#КонецОбласти

#Область ШаблоныПолейДляОтчетов

// Возвращаемое значение:
// 	Строка
//
Функция ШаблонПоляОтгруженоКлиенту() Экспорт
	
	Возврат "ВЫБОР
	|		//Корректировка задолженности всегда отображается только по отгружено.
	|		//Возврат оплаты клиенту отражаем как отгрузку
	|		КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И НЕ РасчетыПоСрокам.Сторно
	|			И (РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаЗадолженности)
	|				ИЛИ РасчетыПоСрокам.ДокументРегистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
	|					И РасчетыПоСрокам.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВзаимозачетЗадолженности))
	|			ТОГДА
	|				- ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА Долг
	|					КОГДА 2
	|						ТОГДА ДолгУпр
	|					ИНАЧЕ ДолгРегл
	|				КОНЕЦ
	|				+ ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА Предоплата
	|					КОГДА 2
	|						ТОГДА ПредоплатаУпр
	|					ИНАЧЕ ПредоплатаРегл
	|				КОНЕЦ
	|		КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И НЕ РасчетыПоСрокам.Сторно
	|			И (РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаЗадолженности)
	|				ИЛИ РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровОтКлиента)
	|				ИЛИ РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтРозничногоПокупателя)
	|				ИЛИ РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровЧерезКомиссионера))
	|			ТОГДА
	|				ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА Долг
	|					КОГДА 2
	|						ТОГДА ДолгУпр
	|					ИНАЧЕ ДолгРегл
	|				КОНЕЦ
	|				- ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА Предоплата
	|					КОГДА 2
	|						ТОГДА ПредоплатаУпр
	|					ИНАЧЕ ПредоплатаРегл
	|				КОНЕЦ
	|		//Обычная отгрузка, долг всегда есть
	|		КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И НЕ РасчетыПоСрокам.Сторно
	|			И НЕ РасчетыПоСрокам.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносАванса),
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОПерации.ВзаимозачетЗадолженности),
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОПерации.ОтражениеОплатыЧерезКомиссионера),
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОПерации.ОтражениеВозвратаОплатыЧерезКомиссионера),
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОПерации.ВозвратОплатыКлиенту),
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОплатыКлиентуНаПлатежнуюКарту),
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОплатыНаПлатежнуюКарту),
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствВДругуюОрганизацию))
	|			И НЕ ТИПЗНАЧЕНИЯ(РасчетыПоСрокам.ДокументРегистратор) В (ТИП(Документ.РасчетКурсовыхРазниц),
	|			                                                         ТИП(Документ.КорректировкаЗадолженности),
	|			                                                         ТИП(Документ.ВзаимозачетЗадолженности))
	|			ТОГДА
	|				ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Долг
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ДолгУпр
	|					ИНАЧЕ РасчетыПоСрокам.ДолгРегл
	|				КОНЕЦ
	|		// По корректировке реализации берем конечное сальдо 
	|		//(долг в плюс по хоз операции КорректировкаЗадолженности а по ПогашениеЗадолженностиКлиента в минус)
	|		КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				И НЕ РасчетыПоСрокам.Сторно
	|				И РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПогашениеЗадолженностиКлиента)
	|				И ТИПЗНАЧЕНИЯ(РасчетыПоСрокам.ДокументРегистратор) = ТИП(Документ.КорректировкаРеализации)
	|			ТОГДА -ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Долг
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ДолгУпр
	|					ИНАЧЕ РасчетыПоСрокам.ДолгРегл
	|				КОНЕЦ
	|		КОГДА РасчетыПоСрокам.Сторно И РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|			И НЕ РасчетыПоСрокам.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаКлиента))
	|			ТОГДА
	|				- ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Долг
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ДолгУпр
	|					ИНАЧЕ РасчетыПоСрокам.ДолгРегл
	|				КОНЕЦ
	|		КОГДА РасчетыПоСрокам.Сторно И РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА
	|				- ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Предоплата
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ПредоплатаУпр
	|					ИНАЧЕ РасчетыПоСрокам.ПредоплатаРегл
	|				КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ";
	
КонецФункции

// Возвращаемое значение:
// 	Строка
//
Функция ШаблонПоляЗачтеноКлиенту() Экспорт
	
	Возврат "ВЫБОР
	|		//Перенос аванса с объекта расчетов платежки и взаимозачет
	|		КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|			И (РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносАванса)
	|				ИЛИ РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВзаимозачетЗадолженности)
	|				ИЛИ РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносПлатежаМеждуФилиалами)
	|				ИЛИ РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносЗадолженностиМеждуФилиалами)
	|				ИЛИ РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РезервированиеАвансаКлиента)
	|				ИЛИ ТИПЗНАЧЕНИЯ(РасчетыПоСрокам.ДокументРегистратор) = ТИП(Документ.ВзаимозачетЗадолженности))
	|			ТОГДА
	|				- ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Предоплата
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ПредоплатаУпр
	|					ИНАЧЕ РасчетыПоСрокам.ПредоплатаРегл
	|				КОНЕЦ
	|				+ ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Долг
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ДолгУпр
	|					ИНАЧЕ РасчетыПоСрокам.ДолгРегл
	|				КОНЕЦ
	|		КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			И (РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносАванса)
	|				ИЛИ РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РезервированиеАвансаКлиента)
	|				ИЛИ РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносПлатежаМеждуФилиалами)
	|				ИЛИ РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносЗадолженностиМеждуФилиалами)
	|				ИЛИ РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВзаимозачетЗадолженности)
	|				ИЛИ РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносПлатежаМеждуФилиалами)
	|				ИЛИ ТИПЗНАЧЕНИЯ(РасчетыПоСрокам.ДокументРегистратор) = ТИП(Документ.ВзаимозачетЗадолженности))
	|			ТОГДА
	|				ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Предоплата
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ПредоплатаУпр
	|					ИНАЧЕ РасчетыПоСрокам.ПредоплатаРегл
	|				КОНЕЦ
	|				- ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Долг
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ДолгУпр
	|					ИНАЧЕ РасчетыПоСрокам.ДолгРегл
	|				КОНЕЦ
	|		//Обычный зачет аванса
	|		КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|			И РасчетыПоСрокам.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаКлиента),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетВознагражденияОплатойКомиссионера),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетВознагражденияОплатойКомитенту))
	|			ТОГДА
	|				- ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Предоплата
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ПредоплатаУпр
	|					ИНАЧЕ РасчетыПоСрокам.ПредоплатаРегл
	|				КОНЕЦ
	|				+ ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Долг
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ДолгУпр
	|					ИНАЧЕ РасчетыПоСрокам.ДолгРегл
	|				КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ";
	
КонецФункции

// Возвращаемое значение:
// 	Строка
//
Функция ШаблонПоляОплаченоКлиентом() Экспорт
	
	Возврат "ВЫБОР
	|		//Обычная оплата
	|		КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И НЕ РасчетыПоСрокам.Сторно
	|			И НЕ РасчетыПоСрокам.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносАванса),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносПлатежаМеждуФилиалами),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносЗадолженностиМеждуФилиалами),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РезервированиеАвансаКлиента),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаЗадолженности),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОплатыКлиенту),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОплатыКлиентуНаПлатежнуюКарту),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОплатыНаПлатежнуюКарту),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствВДругуюОрганизацию),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВзаимозачетЗадолженности),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровОтКлиента),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтражениеПремииКлиентаРетроБонус))
	|			И НЕ ТИПЗНАЧЕНИЯ(РасчетыПоСрокам.ДокументРегистратор) В (ТИП(Документ.РасчетКурсовыхРазниц),ТИП(Документ.КорректировкаЗадолженности), ТИП(Документ.ВзаимозачетЗадолженности),ТИП(Документ.ВозвратТоваровОтКлиента))
	|			ТОГДА
	|				ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Предоплата
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ПредоплатаУпр
	|					ИНАЧЕ РасчетыПоСрокам.ПредоплатаРегл
	|				КОНЕЦ
	|		КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И НЕ РасчетыПоСрокам.Сторно
	|			И РасчетыПоСрокам.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОплатыКлиенту),
	|																ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОплатыКлиентуНаПлатежнуюКарту),
	|																ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОплатыНаПлатежнуюКарту),
	|																ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствВДругуюОрганизацию))
	|			ТОГДА
	|				- ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Долг
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ДолгУпр
	|					ИНАЧЕ РасчетыПоСрокам.ДолгРегл
	|				КОНЕЦ
	|		// Возврат через ЮКассу (без табличной части РасшифровкаПлатежа)
	|		КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И НЕ РасчетыПоСрокам.Сторно
	|			И РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОплатыКлиенту)
	|			ТОГДА
	|				- ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Предоплата
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ПредоплатаУпр
	|					ИНАЧЕ РасчетыПоСрокам.ПредоплатаРегл
	|				КОНЕЦ
	|		КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И НЕ РасчетыПоСрокам.Сторно
	|			И НЕ РасчетыПоСрокам.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносАванса),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносЗадолженностиМеждуФилиалами),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносПлатежаМеждуФилиалами),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РезервированиеАвансаКлиента),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаЗадолженности),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВзаимозачетЗадолженности),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровОтКлиента),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаКлиента),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетВознагражденияОплатойКомиссионера),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетВознагражденияОплатойКомитенту))
	|			И НЕ ТИПЗНАЧЕНИЯ(РасчетыПоСрокам.ДокументРегистратор) В (ТИП(Документ.РасчетКурсовыхРазниц),
	|																	ТИП(Документ.КорректировкаЗадолженности),
	|																	ТИП(Документ.ВзаимозачетЗадолженности),
	|																	ТИП(Документ.КорректировкаРеализации),ТИП(Документ.ВозвратТоваровОтКлиента))
	|			ТОГДА
	|				ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Долг
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ДолгУпр
	|					ИНАЧЕ РасчетыПоСрокам.ДолгРегл
	|				КОНЕЦ
	|		КОГДА РасчетыПоСрокам.Сторно И РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА
	|				- ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Долг
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ДолгУпр
	|					ИНАЧЕ РасчетыПоСрокам.ДолгРегл
	|				КОНЕЦ
	|		КОГДА РасчетыПоСрокам.Сторно 
	|				И РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				И НЕ РасчетыПоСрокам.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаКлиента))
	|			ТОГДА
	|				- ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Предоплата
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ПредоплатаУпр
	|					ИНАЧЕ РасчетыПоСрокам.ПредоплатаРегл
	|				КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ";
	
КонецФункции

// Возвращаемое значение:
// 	Строка
//
Функция ШаблонПоляПоставленоПоставщиком() Экспорт
	
	Возврат "ВЫБОР
	|		//Корректировка задолженности всегда отображается только по отгружено
	|		КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И НЕ РасчетыПоСрокам.Сторно
	|			И (РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаЗадолженности)
	|					ИЛИ РасчетыПоСрокам.ДокументРегистратор ССЫЛКА Документ.ВозвратТоваровПоставщику
	|						И РасчетыПоСрокам.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВзаимозачетЗадолженности))
	|			ТОГДА
	|				- ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА Долг
	|					КОГДА 2
	|						ТОГДА ДолгУпр
	|					ИНАЧЕ ДолгРегл
	|				КОНЕЦ
	|				+ ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА Предоплата
	|					КОГДА 2
	|						ТОГДА ПредоплатаУпр
	|					ИНАЧЕ ПредоплатаРегл
	|				КОНЕЦ
	|		КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И НЕ РасчетыПоСрокам.Сторно
	|			И (РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаЗадолженности)
	|				ИЛИ РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровПоставщику))
	|			ТОГДА
	|				ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА Долг
	|					КОГДА 2
	|						ТОГДА ДолгУпр
	|					ИНАЧЕ ДолгРегл
	|				КОНЕЦ
	|				- ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА Предоплата
	|					КОГДА 2
	|						ТОГДА ПредоплатаУпр
	|					ИНАЧЕ ПредоплатаРегл
	|				КОНЕЦ
	|		//Обычная отгрузка, долг всегда есть
	|		КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И НЕ РасчетыПоСрокам.Сторно
	|			И НЕ РасчетыПоСрокам.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносАванса),
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствОтПоставщика),
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствОтДругойОрганизации),
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОПерации.ВзаимозачетЗадолженности))
	|			И НЕ ТИПЗНАЧЕНИЯ(РасчетыПоСрокам.ДокументРегистратор) В (ТИП(Документ.РасчетКурсовыхРазниц),
	|			                                                         ТИП(Документ.КорректировкаЗадолженности),
	|			                                                         ТИП(Документ.ВзаимозачетЗадолженности))
	|			ТОГДА
	|				ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Долг
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ДолгУпр
	|					ИНАЧЕ РасчетыПоСрокам.ДолгРегл
	|				КОНЕЦ
	|		// По корректировке приобретения берем конечное сальдо 
	|		// (долг в плюс по хоз операции КорректировкаЗадолженности а по ПогашениеЗадолженностиПоставщику в минус)
	|		КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				И НЕ РасчетыПоСрокам.Сторно
	|				И РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПогашениеЗадолженностиПоставщику)
	|				И ТИПЗНАЧЕНИЯ(РасчетыПоСрокам.ДокументРегистратор) = ТИП(Документ.КорректировкаПриобретения)
	|			ТОГДА -ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Долг
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ДолгУпр
	|					ИНАЧЕ РасчетыПоСрокам.ДолгРегл
	|				КОНЕЦ
	|		КОГДА РасчетыПоСрокам.Сторно 
	|				И РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				И НЕ РасчетыПоСрокам.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаПоставщику))
	|			ТОГДА
	|				- ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Долг
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ДолгУпр
	|					ИНАЧЕ РасчетыПоСрокам.ДолгРегл
	|				КОНЕЦ
	|		КОГДА РасчетыПоСрокам.Сторно И РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА
	|				- ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Предоплата
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ПредоплатаУпр
	|					ИНАЧЕ РасчетыПоСрокам.ПредоплатаРегл
	|				КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ";
	
КонецФункции

// Возвращаемое значение:
// 	Строка
//
Функция ШаблонПоляЗачтеноПоставщиком() Экспорт
	
	Возврат "ВЫБОР
	|		//Перенос аванса с объекта расчетов платежки и взаимозачет
	|		КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|			И (РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносАванса)
	|				ИЛИ РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносПлатежаМеждуФилиалами)
	|				ИЛИ РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносЗадолженностиМеждуФилиалами)
	|				ИЛИ РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВзаимозачетЗадолженности)
	|				ИЛИ ТИПЗНАЧЕНИЯ(РасчетыПоСрокам.ДокументРегистратор) = ТИП(Документ.ВзаимозачетЗадолженности))
	|			ТОГДА
	|				- ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Предоплата
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ПредоплатаУпр
	|					ИНАЧЕ РасчетыПоСрокам.ПредоплатаРегл
	|				КОНЕЦ
	|				+ ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Долг
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ДолгУпр
	|					ИНАЧЕ РасчетыПоСрокам.ДолгРегл
	|				КОНЕЦ
	|		КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			И (РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносАванса)
	|				ИЛИ РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносПлатежаМеждуФилиалами)
	|				ИЛИ РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносЗадолженностиМеждуФилиалами)
	|				ИЛИ РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВзаимозачетЗадолженности)
	|				ИЛИ ТИПЗНАЧЕНИЯ(РасчетыПоСрокам.ДокументРегистратор) = ТИП(Документ.ВзаимозачетЗадолженности))
	|			ТОГДА
	|				ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Предоплата
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ПредоплатаУпр
	|					ИНАЧЕ РасчетыПоСрокам.ПредоплатаРегл
	|				КОНЕЦ
	|				- ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Долг
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ДолгУпр
	|					ИНАЧЕ РасчетыПоСрокам.ДолгРегл
	|				КОНЕЦ
	|		//Обычный зачет аванса
	|		КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|			И РасчетыПоСрокам.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаПоставщику),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетВознагражденияОплатойКомиссионера),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетВознагражденияОплатойКомитенту))
	|			ТОГДА
	|				- ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Предоплата
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ПредоплатаУпр
	|					ИНАЧЕ РасчетыПоСрокам.ПредоплатаРегл
	|				КОНЕЦ
	|				+ ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Долг
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ДолгУпр
	|					ИНАЧЕ РасчетыПоСрокам.ДолгРегл
	|				КОНЕЦ
	|		КОГДА РасчетыПоСрокам.Сторно И РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА
	|				- ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Долг
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ДолгУпр
	|					ИНАЧЕ РасчетыПоСрокам.ДолгРегл
	|				КОНЕЦ
	|		КОГДА РасчетыПоСрокам.Сторно И РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|			ТОГДА
	|				- ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Предоплата
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ПредоплатаУпр
	|					ИНАЧЕ РасчетыПоСрокам.ПредоплатаРегл
	|				КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ";
	
КонецФункции

// Возвращаемое значение:
// 	Строка
//
Функция ШаблонПоляОплаченоПоставщику() Экспорт
	
	Возврат "ВЫБОР
	|		//Обычная оплата
	|		КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И НЕ РасчетыПоСрокам.Сторно
	|			И НЕ РасчетыПоСрокам.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносАванса),
	|															ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносПлатежаМеждуФилиалами),
	|															ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносЗадолженностиМеждуФилиалами),
	|															ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаЗадолженности),
	|															ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВзаимозачетЗадолженности),
	|															ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровПоставщику),
	|															ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствОтПоставщика),
	|															ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствОтДругойОрганизации))
	|			И НЕ ТИПЗНАЧЕНИЯ(РасчетыПоСрокам.ДокументРегистратор) В (ТИП(Документ.РасчетКурсовыхРазниц),ТИП(Документ.КорректировкаЗадолженности), ТИП(Документ.ВзаимозачетЗадолженности),ТИП(Документ.ВозвратТоваровПоставщику))
	|			ТОГДА
	|				ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Предоплата
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ПредоплатаУпр
	|					ИНАЧЕ РасчетыПоСрокам.ПредоплатаРегл
	|				КОНЕЦ
	|		КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И НЕ РасчетыПоСрокам.Сторно
	|			И РасчетыПоСрокам.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствОтПоставщика),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратДенежныхСредствОтДругойОрганизации))
	|			ТОГДА 
	|				- ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Долг
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ДолгУпр
	|					ИНАЧЕ РасчетыПоСрокам.ДолгРегл
	|				КОНЕЦ
	|		КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И НЕ РасчетыПоСрокам.Сторно
	|			И НЕ РасчетыПоСрокам.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносАванса),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносЗадолженностиМеждуФилиалами),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносПлатежаМеждуФилиалами),
	|															ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаПоставщику),
	|															ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаЗадолженности),
	|															ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВзаимозачетЗадолженности),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровПоставщику),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетВознагражденияОплатойКомиссионера),
	|														ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетВознагражденияОплатойКомитенту))
	|			И НЕ ТИПЗНАЧЕНИЯ(РасчетыПоСрокам.ДокументРегистратор) В (ТИП(Документ.РасчетКурсовыхРазниц),
	|																	ТИП(Документ.КорректировкаЗадолженности),
	|																	ТИП(Документ.ВзаимозачетЗадолженности),
	|																	ТИП(Документ.КорректировкаПриобретения),ТИП(Документ.ВозвратТоваровПоставщику))
	|			ТОГДА
	|				ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Долг
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ДолгУпр
	|					ИНАЧЕ РасчетыПоСрокам.ДолгРегл
	|				КОНЕЦ
	|		КОГДА РасчетыПоСрокам.Сторно И РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|			ТОГДА 
	|				- ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Долг
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ДолгУпр
	|					ИНАЧЕ РасчетыПоСрокам.ДолгРегл
	|				КОНЕЦ
	|		КОГДА РасчетыПоСрокам.Сторно И РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			И НЕ РасчетыПоСрокам.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗачетАвансаПоставщику))
	|			ТОГДА
	|				- ВЫБОР &ДанныеОтчета
	|					КОГДА 4
	|						ТОГДА РасчетыПоСрокам.Предоплата
	|					КОГДА 2
	|						ТОГДА РасчетыПоСрокам.ПредоплатаУпр
	|					ИНАЧЕ РасчетыПоСрокам.ПредоплатаРегл
	|				КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ";
	
КонецФункции

// Возвращаемое значение:
// 	Строка
//
Функция ШаблонПоляСписаниеПереоценкаЗадолженности() Экспорт
	
	Возврат "ВЫБОР
	|		//Обычная оплата
	|		КОГДА ТИПЗНАЧЕНИЯ(РасчетыПоСрокам.ДокументРегистратор) В (ТИП(Документ.РасчетКурсовыхРазниц),ТИП(Документ.КорректировкаЗадолженности))
	|			ИЛИ РасчетыПоСрокам.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтражениеПремииКлиентаРетроБонус)
	|			ТОГДА ВЫБОР КОГДА РасчетыПоСрокам.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА
	|					- ВЫБОР &ДанныеОтчета
	|						КОГДА 4
	|							ТОГДА РасчетыПоСрокам.Долг
	|						КОГДА 2
	|							ТОГДА РасчетыПоСрокам.ДолгУпр
	|						ИНАЧЕ РасчетыПоСрокам.ДолгРегл
	|					КОНЕЦ
	|					+ ВЫБОР &ДанныеОтчета
	|						КОГДА 4
	|							ТОГДА РасчетыПоСрокам.Предоплата
	|						КОГДА 2
	|							ТОГДА РасчетыПоСрокам.ПредоплатаУпр
	|						ИНАЧЕ РасчетыПоСрокам.ПредоплатаРегл
	|					КОНЕЦ
	|				ИНАЧЕ
	|					ВЫБОР &ДанныеОтчета
	|						КОГДА 4
	|							ТОГДА РасчетыПоСрокам.Долг
	|						КОГДА 2
	|							ТОГДА РасчетыПоСрокам.ДолгУпр
	|						ИНАЧЕ РасчетыПоСрокам.ДолгРегл
	|					КОНЕЦ
	|					- ВЫБОР &ДанныеОтчета
	|						КОГДА 4
	|							ТОГДА РасчетыПоСрокам.Предоплата
	|						КОГДА 2
	|							ТОГДА РасчетыПоСрокам.ПредоплатаУпр
	|						ИНАЧЕ РасчетыПоСрокам.ПредоплатаРегл
	|					КОНЕЦ
	|				КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ";
	
КонецФункции

// Параметры:
// 	ТекстЗапроса - Строка -
// 	НастройкиОтчета - НастройкиКомпоновкиДанных - 
// 	ВычисляемыеПоля - ВычисляемыеПоляСхемыКомпоновкиДанных -
// 	ИмяТаблицы - Строка -
Процедура ДобавитьОтборыВыбранныхПолейВЗапрос(ТекстЗапроса, НастройкиОтчета, ВычисляемыеПоля, ИмяТаблицы) Экспорт
	
	ТекстОтборов = "";
	
	МассивВыбранныхПолей = Новый Массив;
	НайтиВыбранныеПоляРекурсивно(НастройкиОтчета.Выбор.Элементы, МассивВыбранныхПолей);
	
	Для Каждого ВыбранноеПоле Из МассивВыбранныхПолей Цикл
		Если ВычисляемыеПоля.Найти(Строка(ВыбранноеПоле.Поле)) = Неопределено
			И НастройкиОтчета.ДоступныеПоляВыбора.Элементы.Найти(ВыбранноеПоле.Поле) <> Неопределено
			И НастройкиОтчета.ДоступныеПоляВыбора.Элементы.Найти(ВыбранноеПоле.Поле).Тип.Типы().Найти(Тип("Число")) <> Неопределено Тогда
			Если СтрНайти(Строка(ВыбранноеПоле.Поле),"ПользовательскиеПоля") = 0 Тогда
				ТекстОтборов = ТекстОтборов + ?(ТекстОтборов = "","", "ИЛИ") +"
					|	СУММА("+ИмяТаблицы+"." + Строка(ВыбранноеПоле.Поле) + ") <> 0 ";
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ОтборыВыбранныхПолей", ?(ТекстОтборов = "", "ИСТИНА", ТекстОтборов));
	
КонецПроцедуры

Процедура НайтиВыбранныеПоляРекурсивно(КоллекцияЭлементов, МассивЭлементов)

	Для каждого Элемент Из КоллекцияЭлементов Цикл
		
		Если ТипЗнч(Элемент) = Тип("ВыбранноеПолеКомпоновкиДанных") Тогда
			Если Элемент.Использование Тогда
				МассивЭлементов.Добавить(Элемент);
			КонецЕсли;
		Иначе
			НайтиВыбранныеПоляРекурсивно(Элемент.Элементы, МассивЭлементов);
		КонецЕсли;
		
	КонецЦикла;

КонецПроцедуры

#КонецОбласти

#Область ФормированиеЗаданийКЗакрытиюМесяцаСлужебные

Функция СоответствиеЗапросовКонтрольнымРегистрам(Запрос)
	
	СоответствиеТекстовЗапросов = Новый Соответствие();
	Если ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов") Тогда
		СоответствиеТекстовЗапросов.Вставить("РасчетыСКлиентамиИзменения", ТекстЗапросаРасчетыСКлиентами(Запрос));
		СоответствиеТекстовЗапросов.Вставить("РасчетыСПоставщикамиИзменения", ТекстЗапросаРасчетыСПоставщиками(Запрос));
		СоответствиеТекстовЗапросов.Вставить("СуммыДокументовВВалютахУчетаИзменения", ТекстЗапросаСуммыДокументовВВалютахУчета(Запрос));
		СоответствиеТекстовЗапросов.Вставить("ТаблицаИзмененийРасчетыСПоставщикамиПоСрокам", ТекстЗапросаРасчетыСПоставщикамиПоСрокам(Запрос));
	КонецЕсли;
	Возврат СоответствиеТекстовЗапросов;
	
КонецФункции

#Область ТекстыЗапросовЗаданийКЗакрытиюМесяца

// Параметры:
//   Запрос - Запрос.
//
// Возвращаемое значение:
//   см. ЗакрытиеМесяцаСервер.ИнициализироватьСтруктуруТекстовЗапросов
//
Функция ТекстЗапросаРасчетыСКлиентами(Запрос) Экспорт
	
	Если НЕ Запрос.Параметры.Свойство("НовыеРасчеты") Тогда
		Запрос.УстановитьПараметр("НовыеРасчеты", ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов"));
	КонецЕсли;
	
	ТекстЗапроса = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВЫБОР КОГДА Таблица.СоздаватьЗаданияКЗакрытиюСледующегоМесяца
	|		ТОГДА ДОБАВИТЬКДАТЕ(Таблица.Месяц, МЕСЯЦ, 1)
	|		ИНАЧЕ Таблица.Месяц
	|	КОНЕЦ КАК Месяц,
	|	ЗНАЧЕНИЕ(Перечисление.ОперацииЗакрытияМесяца.ФормированиеДвиженийПоРасчетамСПартнерамиИПереоценкаРасчетов) КАК Операция,
	|	Таблица.Организация КАК Организация,
	|	Таблица.Документ Документ
	|ИЗ 
	|	РасчетыСКлиентамиИзменения КАК Таблица
	|ГДЕ
	|	Таблица.Сумма <> 0 ИЛИ Таблица.СуммаРегл <> 0 ИЛИ Таблица.СуммаУпр <> 0
	|";
	
	СтруктураТекстовЗапросов = ЗакрытиеМесяцаСервер.ИнициализироватьСтруктуруТекстовЗапросов(ТекстЗапроса);
	Возврат СтруктураТекстовЗапросов
КонецФункции

// Параметры:
//   Запрос - Запрос.
//
// Возвращаемое значение:
//   см. ЗакрытиеМесяцаСервер.ИнициализироватьСтруктуруТекстовЗапросов
//
Функция ТекстЗапросаРасчетыСПоставщиками(Запрос) Экспорт
	
	Если НЕ Запрос.Параметры.Свойство("НовыеРасчеты") Тогда
		Запрос.УстановитьПараметр("НовыеРасчеты", ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов"));
	КонецЕсли;
	
	ТекстЗапроса = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВЫБОР КОГДА Таблица.СоздаватьЗаданияКЗакрытиюСледующегоМесяца
	|		ТОГДА ДОБАВИТЬКДАТЕ(Таблица.Месяц, МЕСЯЦ, 1)
	|		ИНАЧЕ Таблица.Месяц
	|	КОНЕЦ КАК Месяц,
	|	ЗНАЧЕНИЕ(Перечисление.ОперацииЗакрытияМесяца.ФормированиеДвиженийПоРасчетамСПартнерамиИПереоценкаРасчетов) КАК Операция,
	|	Таблица.Организация КАК Организация,
	|	Таблица.Документ КАК Документ
	|ИЗ
	|	РасчетыСПоставщикамиИзменения КАК Таблица
	|ГДЕ
	|	Таблица.Сумма <> 0 ИЛИ Таблица.СуммаРегл <> 0 ИЛИ Таблица.СуммаУпр <> 0
	|";
	
	СтруктураТекстовЗапросов = ЗакрытиеМесяцаСервер.ИнициализироватьСтруктуруТекстовЗапросов(ТекстЗапроса);
	Возврат СтруктураТекстовЗапросов
КонецФункции

// Параметры:
//   Запрос - Запрос.
//
// Возвращаемое значение:
//   см. ЗакрытиеМесяцаСервер.ИнициализироватьСтруктуруТекстовЗапросов
//
Функция ТекстЗапросаСуммыДокументовВВалютахУчета(Запрос) Экспорт
	
	ТекстЗапроса = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВЫБОР КОГДА Таблица.СоздаватьЗаданияКЗакрытиюСледующегоМесяца
	|		ТОГДА НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(Таблица.Период, МЕСЯЦ, 1), МЕСЯЦ)
	|		ИНАЧЕ НАЧАЛОПЕРИОДА(Таблица.Период, МЕСЯЦ)
	|	КОНЕЦ КАК Месяц,
	|	ЗНАЧЕНИЕ(Перечисление.ОперацииЗакрытияМесяца.ФормированиеДвиженийПоРасчетамСПартнерамиИПереоценкаРасчетов) КАК Операция,
	|	Таблица.ОбъектРасчетов.Организация КАК Организация,
	|	Таблица.Регистратор КАК Документ
	|ИЗ
	|	СуммыДокументовВВалютахУчетаИзменения КАК Таблица
	|ГДЕ
	|	Таблица.ПересчитыватьПоДаннымРасчетов
	|	И НЕ Таблица.ОбъектРасчетов.Организация ЕСТЬ NULL 
	|";
	
	СтруктураТекстовЗапросов = ЗакрытиеМесяцаСервер.ИнициализироватьСтруктуруТекстовЗапросов(ТекстЗапроса);
	Возврат СтруктураТекстовЗапросов
КонецФункции

// Параметры:
//   Запрос - Запрос.
//
// Возвращаемое значение:
//   см. ЗакрытиеМесяцаСервер.ИнициализироватьСтруктуруТекстовЗапросов
//
Функция ТекстЗапросаРасчетыСПоставщикамиПоСрокам(Запрос) Экспорт
	
	ТекстЗапросаВременныхТаблиц = "ВЫБРАТЬ
	|	РасчетыСПоставщикамиПоСрокам.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	РасчетыСПоставщикамиПоСрокам.РасчетныйДокумент КАК РасчетныйДокумент,
	|	РасчетыСПоставщикамиПоСрокам.ДатаВозникновения КАК ДатаВозникновения,
	|	РасчетыСПоставщикамиПоСрокам.Долг КАК Долг,
	|	ВЫБОР
	|		КОГДА РасчетыСПоставщикамиПоСрокам.ДатаВозникновения > РасчетыСПоставщикамиПоСрокам.ДатаПлановогоПогашения
	|			ТОГДА 0
	|		ИНАЧЕ РАЗНОСТЬДАТ(РасчетыСПоставщикамиПоСрокам.ДатаВозникновения, РасчетыСПоставщикамиПоСрокам.ДатаПлановогоПогашения, ДЕНЬ)
	|	КОНЕЦ КАК ОтсрочкаПлатежа,
	|	КлючиАналитикиУчетаПоПартнерам.Договор КАК Договор,
	|	КлючиАналитикиУчетаПоПартнерам.Организация КАК Организация,
	|	Организации.ГоловнаяОрганизация КАК ГоловнаяОрганизация,
	|	НАЧАЛОПЕРИОДА(РасчетыСПоставщикамиПоСрокам.Период, МЕСЯЦ) КАК Месяц,
	|	РасчетыСПоставщикамиПоСрокам.ДокументРегистратор КАК ДокументРегистратор,
	|	РасчетыСПоставщикамиПоСрокам.СоздаватьЗаданияКЗакрытиюСледующегоМесяца КАК СоздаватьЗаданияКЗакрытиюСледующегоМесяца
	|ПОМЕСТИТЬ ВтГрафикОплаты
	|ИЗ
	|	ТаблицаИзмененийРасчетыСПоставщикамиПоСрокам КАК РасчетыСПоставщикамиПоСрокам
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПоПартнерам КАК КлючиАналитикиУчетаПоПартнерам
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Организации КАК Организации
	|			ПО КлючиАналитикиУчетаПоПартнерам.Организация = Организации.Ссылка
	|		ПО РасчетыСПоставщикамиПоСрокам.АналитикаУчетаПоПартнерам = КлючиАналитикиУчетаПоПартнерам.Ссылка
	|ГДЕ
	|	ТИПЗНАЧЕНИЯ(РасчетыСПоставщикамиПоСрокам.РасчетныйДокумент) В (&ТипыДокументовУчаствующихВДисконтировании)
	|	И ТИПЗНАЧЕНИЯ(РасчетыСПоставщикамиПоСрокам.ДокументРегистратор) <> ТИП(Документ.РасчетКурсовыхРазниц)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВтГрафикОплаты.ДатаВозникновения КАК ДатаВозникновения,
	|	МАКСИМУМ(УчетнаяПолитикаФинансовогоУчета.Период) КАК Период,
	|	УчетнаяПолитикаФинансовогоУчета.Организация КАК Организация
	|ПОМЕСТИТЬ ВтПериодыУчетнойПолитики
	|ИЗ
	|	ВтГрафикОплаты КАК ВтГрафикОплаты
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.УчетнаяПолитикаФинансовогоУчета КАК УчетнаяПолитикаФинансовогоУчета
	|		ПО ВтГрафикОплаты.ГоловнаяОрганизация = УчетнаяПолитикаФинансовогоУчета.Организация
	|			И ВтГрафикОплаты.ДатаВозникновения >= УчетнаяПолитикаФинансовогоУчета.Период
	|
	|СГРУППИРОВАТЬ ПО
	|	ВтГрафикОплаты.ДатаВозникновения,
	|	УчетнаяПолитикаФинансовогоУчета.Организация
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВтПериодыУчетнойПолитики.ДатаВозникновения КАК ДатаВозникновения,
	|	ВтПериодыУчетнойПолитики.Период КАК Период,
	|	ВтПериодыУчетнойПолитики.Организация КАК Организация
	|ПОМЕСТИТЬ ВтУчетнаяПолитикаПоОрганизациям
	|ИЗ
	|	ВтПериодыУчетнойПолитики КАК ВтПериодыУчетнойПолитики
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.УчетнаяПолитикаФинансовогоУчета КАК УчетнаяПолитикаФинансовогоУчета
	|		ПО ВтПериодыУчетнойПолитики.Период = УчетнаяПолитикаФинансовогоУчета.Период
	|			И ВтПериодыУчетнойПолитики.Организация = УчетнаяПолитикаФинансовогоУчета.Организация
	|ГДЕ
	|	УчетнаяПолитикаФинансовогоУчета.УчетДисконтированнойКредиторскойЗадолженностиПоставщикам
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|";
	ТекстЗапроса = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВЫБОР КОГДА ВтОтсрочки.СоздаватьЗаданияКЗакрытиюСледующегоМесяца
	|		ТОГДА НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(ВтОтсрочки.Месяц, МЕСЯЦ, 1), МЕСЯЦ)
	|		ИНАЧЕ ВтОтсрочки.Месяц
	|	КОНЕЦ КАК Месяц,
	|	ЗНАЧЕНИЕ(Перечисление.ОперацииЗакрытияМесяца.РасчетПроцентныхРасходовДисконтирования) КАК Операция,
	|	ВтОтсрочки.Организация КАК Организация,
	|	ВтОтсрочки.ДокументРегистратор КАК Документ
	|ИЗ
	|	ВтГрафикОплаты КАК ВтОтсрочки
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
	|		ПО ВтОтсрочки.Договор = ДоговорыКонтрагентов.Ссылка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтУчетнаяПолитикаПоОрганизациям КАК ВтУчетнаяПолитикаПоОрганизациям
	|		ПО ВтОтсрочки.ГоловнаяОрганизация = ВтУчетнаяПолитикаПоОрганизациям.Организация
	|			И ВтОтсрочки.ДатаВозникновения = ВтУчетнаяПолитикаПоОрганизациям.ДатаВозникновения
	|ГДЕ
	|	ДоговорыКонтрагентов.СтавкаДисконтирования > 0
	|	И ДоговорыКонтрагентов.СрокДляПримененияДисконтирования < ВтОтсрочки.ОтсрочкаПлатежа";
	
	ВременныеТаблицы = "ВтГрафикОплаты, ВтПериодыУчетнойПолитики, ВтУчетнаяПолитикаПоОрганизациям";
	
	Запрос.УстановитьПараметр("ТипыДокументовУчаствующихВДисконтировании", РегистрыНакопления.ПроцентныеРасходыДисконтирования.ПолучитьТипыДокументовУчаствующихВДисконтировании());
	
	СтруктураТекстовЗапросов = ЗакрытиеМесяцаСервер.ИнициализироватьСтруктуруТекстовЗапросов(
		ТекстЗапроса,
		ТекстЗапросаВременныхТаблиц,
		ВременныеТаблицы);
	
	Возврат СтруктураТекстовЗапросов
	
КонецФункции

#КонецОбласти

#КонецОбласти

#Область Модульность

#Область Общее

Процедура ДополнитьИЗакэшироватьПараметры(Форма, ПараметрыЗаполнения) 
	
	ДанныеНастройки = ДополненныеПараметрыМеханизма(Форма, ПараметрыЗаполнения);
	ОбщегоНазначенияУТ.СохранитьДанныеМеханизмаВКэшФормы(Форма, "Взаиморасчеты", ДанныеНастройки);
	
КонецПроцедуры

Процедура ПроверитьПараметры(СтруктураПараметров, ОбязательныеПараметры)
	
	Параметры = СтрРазделить(ОбязательныеПараметры, ",");
	Для Каждого Параметр Из Параметры Цикл
		Если НЕ ЗначениеЗаполнено(СтруктураПараметров[СокрЛП(Параметр)]) Тогда
			ВызватьИсключение(СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'В модуле менеджера документа не заполнен путь к необходимому параметру %1'"),
				СокрЛП(Параметр)))
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Процедура УстановитьПараметрыЗапроса(Запрос) 
	
	Если НЕ Запрос.Параметры.Свойство("ВалютаУправленческогоУчета") Тогда
		Запрос.УстановитьПараметр("ВалютаУправленческогоУчета", Константы.ВалютаУправленческогоУчета.Получить());
	КонецЕсли;
	
КонецПроцедуры

//Очищает табличные части этапов графика оплат.
Процедура ОчиститьЭтапыГрафикаОплаты(Объект, СтруктураПараметров)
	
	Если ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧЭтапыОплаты) Тогда
		ЭтапыГрафикаОплаты = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ПутьКДаннымТЧЭтапыОплаты);
		ЭтапыГрафикаОплаты.Очистить();
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СтруктураПараметров.ДатаПлатежа) Тогда
		Реквизит = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Объект, СтруктураПараметров.ДатаПлатежа);
		Реквизит.Данные[Реквизит.Имя] = Дата(1,1,1);
	КонецЕсли;
	
КонецПроцедуры

//Очищает суммы взаиморасчетов в табличной части документа
// 
// Параметры:
// 	Форма - ФормаКлиентскогоПриложения - Форма объекта настройки.
// 	ПутьКДаннымТЧ - Строка - Путь к данным табличной части, в которой требуется очистить сумму взаиморасчетов.
//
Процедура ОчиститьСуммыВзаиморасчетовТЧ(Объект, СтруктураПараметров)
	
	Если НЕ ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧ) Тогда
		Возврат;
	КонецЕсли;
	
	ТЧ = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ПутьКДаннымТЧ);
	
	Если ТЧ.Количество() > 0 И ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ТЧ[0], "СуммаВзаиморасчетов") Тогда
		ЕстьНДС = ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ТЧ[0], "СуммаНДСВзаиморасчетов");
		
		Для Каждого Стр Из ТЧ Цикл
			Стр.СуммаВзаиморасчетов = 0;
			Если ЕстьНДС Тогда
				Стр.СуммаНДСВзаиморасчетов = 0;
			КонецЕсли;
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

//Очищает определенные поля этапов графика оплаты.
Процедура ОчиститьПоляЭтаповГрафикаОплаты(Форма, СтруктураПараметров, МассивПолейОчистки)
	
	ЭтапыГрафикаОплаты = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.ПутьКДаннымТЧЭтапыОплаты);
	
	Если ЭтапыГрафикаОплаты = Неопределено 
		ИЛИ ЭтапыГрафикаОплаты.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	МассивИмеющихсяПолей = Новый Массив;
	Для Каждого Поле Из МассивПолейОчистки Цикл
		Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ЭтапыГрафикаОплаты[0], Поле) Тогда
			МассивИмеющихсяПолей.Добавить(Поле);
		КонецЕсли;
	КонецЦикла;
	
	Для Каждого Стр Из ЭтапыГрафикаОплаты Цикл
		Для Каждого Поле Из МассивИмеющихсяПолей Цикл
			Стр[Поле] = 0;
		КонецЦикла;
	КонецЦикла;
	
КонецПроцедуры

//Очищает расшифровку платежа
Процедура ОчиститьРасшифровкуПлатежа(Объект, СтруктураПараметров)
	
	Если НЕ ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа) Тогда
		Возврат;
	КонецЕсли;
	
	РасшифровкаПлатежа = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа);
	
	Если СтруктураПараметров.ЭтоПродажаЗакупка Тогда
		РасшифровкаПлатежа.Очистить();
	Иначе
		
		ЕстьОснованиеПлатежа = РасшифровкаПлатежа.Количество() > 0 
			И ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(РасшифровкаПлатежа[0],"ОснованиеПлатежа");
		
		Для Каждого Стр Из РасшифровкаПлатежа Цикл
			Стр.ОбъектРасчетов = Справочники.ОбъектыРасчетов.ПустаяСсылка();
			Если ЕстьОснованиеПлатежа Тогда
				Стр.ОснованиеПлатежа = Неопределено;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

Процедура ОчиститьОбъектИСуммуРасшифровкиПлатежа(Объект, СтруктураПараметров, СохраняемыеОбъектыРасчетов = Неопределено)
	
	Если НЕ ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа) Тогда
		Возврат;
	КонецЕсли;
	
	РасшифровкаПлатежа = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа);
	Для Каждого Стр Из РасшифровкаПлатежа Цикл
		Если СохраняемыеОбъектыРасчетов <> Неопределено
			И СохраняемыеОбъектыРасчетов.Найти(Стр.ОбъектРасчетов) <> Неопределено Тогда
			Продолжить;
		КонецЕсли;
		Стр.ОбъектРасчетов = Справочники.ОбъектыРасчетов.ПустаяСсылка();
		Стр.СуммаВзаиморасчетов = 0;
		Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(Стр, "ВалютаВзаиморасчетов") Тогда
			Стр.ВалютаВзаиморасчетов = ПредопределенноеЗначение("Справочник.Валюты.ПустаяСсылка");
		КонецЕсли
	КонецЦикла;
	
	Если ТипЗнч(Объект) = Тип("ФормаКлиентскогоПриложения") Тогда
		ОбновитьРаспределеннуюСуммаРасшифровки(Объект);
	КонецЕсли;
	
КонецПроцедуры

Функция ДоступныеПоОрганизацииОбъектыРасчетов(Объект, СтруктураПараметров)
	
	Если НЕ ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	МассивОбъектовРасчетов = Новый Массив;
	РасшифровкаПлатежа = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа);
	Для Каждого Стр Из РасшифровкаПлатежа Цикл
		МассивОбъектовРасчетов.Добавить(Стр.ОбъектРасчетов);
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ОбъектыРасчетов", МассивОбъектовРасчетов);
	Запрос.УстановитьПараметр("Организация", ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Организация));
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ОбъектыРасчетов.Ссылка КАК Ссылка
		|ИЗ
		|	Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов.Филиалы КАК ДоговорыКонтрагентовФилиалы
		|		ПО ОбъектыРасчетов.Договор = ДоговорыКонтрагентовФилиалы.Ссылка
		|ГДЕ
		|	ОбъектыРасчетов.Ссылка В(&ОбъектыРасчетов)
		|	И ДоговорыКонтрагентовФилиалы.Ссылка.ЦентрализованныйДоговор
		|	И (ОбъектыРасчетов.Организация = &Организация
		|			ИЛИ ДоговорыКонтрагентовФилиалы.Ссылка.Организация = &Организация
		|			ИЛИ ДоговорыКонтрагентовФилиалы.Организация = &Организация
		|				И (ДоговорыКонтрагентовФилиалы.Ссылка.РазрешаетсяПередачаОплатМеждуФилиалами
		|					ИЛИ ОбъектыРасчетов.Организация = ДоговорыКонтрагентовФилиалы.Ссылка.Организация))
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ОбъектыРасчетов.Ссылка КАК Ссылка
		|ИЗ
		|	Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
		|ГДЕ
		|	ОбъектыРасчетов.Ссылка В(&ОбъектыРасчетов)
		|	И ОбъектыРасчетов.Организация.ДопускаютсяВзаиморасчетыЧерезГоловнуюОрганизацию
		|	И (ОбъектыРасчетов.Организация.ГоловнаяОрганизация = &Организация
		|		ИЛИ ОбъектыРасчетов.Организация = &Организация)";
	Выборка = Запрос.Выполнить().Выбрать();
	МассивОбъектовРасчетов.Очистить();
	Пока Выборка.Следующий() Цикл
		МассивОбъектовРасчетов.Добавить(Выборка.Ссылка);
	КонецЦикла; 
	
	Возврат МассивОбъектовРасчетов;
	
КонецФункции

//Очищает ссылки на справочник Объекты расчетов.
Процедура ОчиститьОбъектРасчетов(Объект, СтруктураПараметров)
	
	РеквизитОбъектРасчетов = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Объект, СтруктураПараметров.ОбъектРасчетов);
	ЧислоВхождений = СтрЧислоВхождений(СтруктураПараметров.ОбъектРасчетов, ".");
	
	Если ЧислоВхождений = 0 Тогда
		Возврат;
	ИначеЕсли ЧислоВхождений = 1 Тогда
		РеквизитОбъектРасчетов.Данные[РеквизитОбъектРасчетов.Имя] = Справочники.ОбъектыРасчетов.ПустаяСсылка();
	Иначе 
		Для Каждого СтрокаТЧ Из РеквизитОбъектРасчетов.Данные Цикл
			СтрокаТЧ[РеквизитОбъектРасчетов.Имя] = Справочники.ОбъектыРасчетов.ПустаяСсылка();
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

Функция КоэффициентПересчетаПоКурсу(ВалютаРегламентированногоУчета, Валюта, ВалютаВзаиморасчетов, КурсЧислитель, КурсЗнаменатель)
		
	Если КурсЧислитель = 0 Или КурсЗнаменатель = 0 Тогда
		Возврат 0;
	ИначеЕсли Валюта = ВалютаВзаиморасчетов Тогда
		Возврат 1;
	ИначеЕсли НЕ ВалютаВзаиморасчетов = ВалютаРегламентированногоУчета
			И Валюта = ВалютаРегламентированногоУчета Тогда
		Возврат КурсЗнаменатель / КурсЧислитель;
	Иначе
		Возврат КурсЧислитель / КурсЗнаменатель;
	КонецЕсли;
	
КонецФункции

Функция МассивСтруктурПараметровПоРеквизитам(МассивПараметров, ЗНАЧ ИменаРеквизитов)
	Если ТипЗнч(ИменаРеквизитов) = Тип("Массив") Тогда
		МассивИменРеквизитов = ИменаРеквизитов;
	Иначе
		МассивИменРеквизитов = Новый Массив;
		МассивИменРеквизитов.Добавить(ИменаРеквизитов);
	КонецЕсли;
	Результат = Новый Массив;
	Для Каждого СтруктураПараметров Из МассивПараметров Цикл
		МассивНайденныхРеквизитов = Новый Массив;
		Для Каждого ИмяРеквизита Из МассивИменРеквизитов Цикл
			РеквизитыМеханизма = СтруктураПараметров.ИспользуемыеРеквизиты["Объект."+ИмяРеквизита];
			Если РеквизитыМеханизма <> Неопределено Тогда
				Для Каждого Реквизит из РеквизитыМеханизма Цикл
					МассивНайденныхРеквизитов.Добавить(Реквизит);
				КонецЦикла;
			КонецЕсли;
		КонецЦикла;
		Если МассивНайденныхРеквизитов.Количество() > 0 Тогда
			СтруктураРезультата = Новый Структура;
			СтруктураРезультата.Вставить("СтруктураПараметров", СтруктураПараметров);
			СтруктураРезультата.Вставить("ИспользуемыеРеквизиты", МассивНайденныхРеквизитов);
			Результат.Добавить(СтруктураРезультата);
		КонецЕсли;
	КонецЦикла;
	Возврат Результат;
КонецФункции

// Параметры:
// 	Объект - СправочникОбъект, ДокументОбъект - Описание
// 	СтруктураПараметров - см. ВзаиморасчетыСервер.ПараметрыМеханизма
// 	СистемныеНастройки - Структура - Описание
Процедура ПроверитьЗаполнитьСуммуВзаиморасчетов(Объект, СтруктураПараметров, СистемныеНастройки) Экспорт
	
	Если Не ЗначениеЗаполнено(СтруктураПараметров.СуммаВзаиморасчетов) Тогда
		Возврат;
	КонецЕсли;
	
	СтруктураПоиска = Новый Структура("СуммаВзаиморасчетов", 0);
	
	СуммаВзаиморасчетовРеквизит = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Объект, СтруктураПараметров.СуммаВзаиморасчетов);
	СуммаВзаиморасчетовПоТареРеквизит = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Объект, СтруктураПараметров.СуммаВзаиморасчетовПоТаре);
	
	КурсЧислитель        = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.КурсЧислитель);
	КурсЗнаменатель      = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.КурсЗнаменатель);
	ВалютаДокумента      = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ВалютаДокумента);
	ВалютаВзаиморасчетов = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ВалютаВзаиморасчетов);
	Организация          = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Организация);
	ВернутьМногооборотнуюТару = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ВернутьМногооборотнуюТару,,Ложь);
	ТребуетсяЗалогЗаТару = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ТребуетсяЗалогЗаТару,,Ложь);
	
	ВалютаРегламентированногоУчета = ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(Организация);
	
	КоэффициентПересчета = КоэффициентПересчетаПоКурсу(ВалютаРегламентированногоУчета,
																		ВалютаДокумента,
																		ВалютаВзаиморасчетов,
																		КурсЧислитель,
																		КурсЗнаменатель);
	
	СуммыДокумента = СуммыДокумента(Объект, СтруктураПараметров);
	СуммаДокумента = СуммыДокумента.СуммаДокумента;
	
	Если ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧ) Тогда
		
		ТаблицаТовары = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ПутьКДаннымТЧ).Выгрузить();
		
		Если ТаблицаТовары.Количество() = 0 ИЛИ НЕ ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ТаблицаТовары[0], "СуммаВзаиморасчетов") Тогда
			СуммаВзаиморасчетовПоТаре = 0;
			СуммаВзаиморасчетов = СуммаДокумента;
		Иначе
			Если ВернутьМногооборотнуюТару И НЕ ТребуетсяЗалогЗаТару Тогда
				Запрос = Новый Запрос;
				Запрос.Текст = "
				|ВЫБРАТЬ
				|	Номенклатура КАК Номенклатура,
				|	СуммаВзаиморасчетов КАК СуммаВзаиморасчетов
				|ПОМЕСТИТЬ ВтТовары
				|ИЗ &ТаблицаТовары КАК ТаблицаТовары
				|;
				|ВЫБРАТЬ
				|	*
				|ИЗ ВтТовары КАК ТаблицаТовары
				|ГДЕ
				|	Номенклатура.ТипНоменклатуры <> ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара)
				|";
				Запрос.УстановитьПараметр("ТаблицаТовары",ТаблицаТовары);
				ТаблицаТовары = Запрос.Выполнить().Выгрузить();
			КонецЕсли;
			
			Если ТаблицаТовары.НайтиСтроки(СтруктураПоиска).Количество() = 0 Тогда
				СуммаВзаиморасчетовПоТаре = Окр(СуммыДокумента.СуммаЗалогаЗаТару * КоэффициентПересчета, 2);
				СуммаВзаиморасчетов       = ТаблицаТовары.Итог("СуммаВзаиморасчетов");
			Иначе
				
				Если СтруктураПараметров.ИсточникСуммТабличнаяЧасть Тогда
					СуммаВзаиморасчетовПоТаре   = Окр(СуммыДокумента.СуммаЗалогаЗаТару * КоэффициентПересчета, 2);
				Иначе
					СуммаВзаиморасчетовПоТаре = 0;
				КонецЕсли;
					
				СуммаВзаиморасчетов         = Окр(СуммыДокумента.СуммаДокументаБезЗалога * КоэффициентПересчета, 2) + СуммаВзаиморасчетовПоТаре;
			КонецЕсли;
		КонецЕсли;
		
	Иначе
		
		СуммаВзаиморасчетов = Окр(СуммаДокумента * КоэффициентПересчета, 2);
		СуммаВзаиморасчетовПоТаре = 0;
		
	КонецЕсли;
	
	СуммаВзаиморасчетовРеквизит.Данные[СуммаВзаиморасчетовРеквизит.Имя] = СуммаВзаиморасчетов;
	
	Если ЗначениеЗаполнено(СтруктураПараметров.СуммаНДСВзаиморасчетов) Тогда
		Реквизит = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Объект, СтруктураПараметров.СуммаНДСВзаиморасчетов);
		СтавкаНДС = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, "Объект.СтавкаНДС");
		Реквизит.Данные[Реквизит.Имя] = ЦенообразованиеКлиентСервер.РассчитатьСуммуНДС(СуммаВзаиморасчетов, СтавкаНДС);
	КонецЕсли;
	
	Если СуммаВзаиморасчетовПоТареРеквизит <> Неопределено Тогда
		СуммаВзаиморасчетовПоТареРеквизит.Данные[СуммаВзаиморасчетовПоТареРеквизит.Имя] = СуммаВзаиморасчетовПоТаре;
	КонецЕсли;
	
	Если СтруктураПараметров.Свойство("СуммыДокумента") Тогда
		СтруктураПараметров.СуммыДокумента.СуммаВзаиморасчетов = СуммаВзаиморасчетов;
		СтруктураПараметров.СуммыДокумента.СуммаВзаиморасчетовБезЗалога = СуммаВзаиморасчетов - СуммаВзаиморасчетовПоТаре;
		СтруктураПараметров.СуммыДокумента.СуммаВзаиморасчетовПоТаре = СуммаВзаиморасчетовПоТаре;
	КонецЕсли;
	
КонецПроцедуры


Процедура ФормаПриЧтенииСозданииНаСервере(Форма, ПараметрыМеханизма)
	
	ВзаиморасчетыВызовСервера.ОбновитьТекстГиперссылкиОграничениеЗадолженности(Форма);
	УстановитьВидимостьЗачетОплаты(Форма);
	УстановитьВидимостьГФУНД(Форма);
	ОбновитьТекстГиперссылкиЭтапыОплаты(Форма);
	ОбновитьТекстГиперссылкиСостояниеРасчетов(Форма);
	ВзаиморасчетыКлиентСервер.ОбновитьТекстГиперссылкиВалюты(Форма);
	ОбновитьРаспределеннуюСуммаРасшифровки(Форма);
	
КонецПроцедуры

Процедура ОбработатьЗаполнить(Объект, СтруктураПараметров, ДанныеЗаполнения, ИмяПараметра, ЗначениеПоУмолчанию)
	
	Если ЗначениеЗаполнено(СтруктураПараметров[ИмяПараметра]) 
		И ТипЗнч(СтруктураПараметров[ИмяПараметра]) = Тип("Строка")
		И СтрЧислоВхождений(СтруктураПараметров[ИмяПараметра], ".") = 1 Тогда
		Реквизит = СтрРазделить(СтруктураПараметров[ИмяПараметра],".")[1];
		
		РеквизитВДанных = Неопределено;
		
		Если ТипЗнч(ДанныеЗаполнения) = Тип("Структура")
			И ДанныеЗаполнения.Свойство(Реквизит) Тогда
			Если НЕ ЗначениеЗаполнено(ДанныеЗаполнения[Реквизит]) Тогда
				ДанныеЗаполнения[Реквизит] = ЗначениеПоУмолчанию;
			Иначе
				РеквизитВДанных = ДанныеЗаполнения[Реквизит];
			КонецЕсли;
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(РеквизитВДанных) Тогда
			ПроверитьЗаполнитьРеквизит(Объект, СтруктураПараметров, ИмяПараметра, ЗначениеПоУмолчанию);
		Иначе
			ПроверитьЗаполнитьРеквизит(Объект, СтруктураПараметров, ИмяПараметра, РеквизитВДанных);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ПроверитьЗаполнениеЭтаповГрафикаОплаты(Объект, Отказ, ЗНАЧ ДополненныеПараметрыМеханизма = Неопределено)
	
	Если ТипЗнч(Объект) = Тип("ФормаКлиентскогоПриложения") Тогда
		ДополненныеПараметрыМеханизма = ОбщегоНазначенияУТКлиентСервер.ПолучитьДанныеМеханизмаИзКэшаФормы(Объект, "Взаиморасчеты");
	КонецЕсли;
	
	СистемныеНастройки = ДополненныеПараметрыМеханизма.СистемныеНастройки;
	
	Для Каждого СтруктураПараметров Из ДополненныеПараметрыМеханизма.МассивПараметров Цикл
		
		ЗаданГрафикИсполнения     = СтруктураПараметров.ЗаданГрафикИсполнения;
		ПорядокРасчетов           = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ПорядокРасчетов);
		ДатаПлатежа               = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ДатаПлатежа);
		Дата                      = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Дата);
		ВалютаВзаиморасчетов      = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ВалютаВзаиморасчетов);
		ДатаОтгрузки              = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ДатаОтгрузки);
		ЭтапыОплатыРеквизит       = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Объект, СтруктураПараметров.ПутьКДаннымТЧЭтапыОплаты);
		
		Если Не ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧЭтапыОплаты) И Не ЗначениеЗаполнено(СтруктураПараметров.ДатаПлатежа) 
			ИЛИ НЕ СтруктураПараметров.ИзменяетПланОплаты И НЕ СтруктураПараметров.ЗаказКакСчет
			ИЛИ СтруктураПараметров.ЭтоЗаказ И (ПорядокРасчетов = ПредопределенноеЗначение("Перечисление.ПорядокРасчетов.ПоНакладным")
												ИЛИ ЗаданГрафикИсполнения И (ПорядокРасчетов = ПредопределенноеЗначение("Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов")
																			ИЛИ ПорядокРасчетов = ПредопределенноеЗначение("Перечисление.ПорядокРасчетов.ПоДоговорамНакладным")))
			 Тогда
			Продолжить;
		КонецЕсли;
		
		СуммыДокумента = СуммыДокумента(Объект, СтруктураПараметров);
		
		Если ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧЭтапыОплаты) Тогда
			
			ЭтапыГрафикаОплаты = ЭтапыОплатыРеквизит.Данные[ЭтапыОплатыРеквизит.Имя];
			
			СтруктураПараметровПроверки = ЭтапыОплатыСервер.ПараметрыПроверкиКорректностиЗаполненияЭтапов();
			СтруктураПараметровПроверки.ДатаОтгрузки           = ДатаОтгрузки;
			СтруктураПараметровПроверки.Дата                   = Дата;
			СтруктураПараметровПроверки.Валюта                 = ВалютаВзаиморасчетов;
			СтруктураПараметровПроверки.ЭтоЗаказ               = СтруктураПараметров.ЭтоЗаказ;
			СтруктураПараметровПроверки.НакладнаяИсточникГрафика = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект,СтруктураПараметров.ЭтоПродажаЗакупка)
																			И Не ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект,СтруктураПараметров.НакладнаяПоЗаказам,,Ложь)
																			И Не СтруктураПараметров.ЗаданГрафикИсполнения;
			СтруктураПараметровПроверки.НадписьЭтапыОплаты     = СтруктураПараметров.НадписьЭтапыОплаты;
			СтруктураПараметровПроверки.СуммаОплатыПоДокументу = СуммыДокумента.СуммаДокументаБезЗалога;
			СтруктураПараметровПроверки.СуммаЗалогаПоДокументу = СуммыДокумента.СуммаЗалогаЗаТару;
			Если ТипЗнч(ДатаОтгрузки) <> Тип("Дата") Тогда
				Подстроки = СтрРазделить(СтруктураПараметров.ДатаОтгрузки, ".");
				СтруктураПараметровПроверки.ИмяКолонкиДатаОтгрузки = Подстроки[Подстроки.Количество()-1];
			КонецЕсли;
			
			ЭтапыОплатыСервер.ПроверитьКорректностьЭтаповГрафикаОплаты(
					ЭтапыГрафикаОплаты,
					Отказ,
					СтруктураПараметровПроверки,
					Ложь,
					Истина);
			
		ИначеЕсли ЗначениеЗаполнено(СтруктураПараметров.ДатаПлатежа) Тогда
			
			// Не выполняем проверку, если не требуется оплата
			ВыполнятьПроцерку = Истина;
			Если ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧ) Тогда
				ТабличнаяЧасть = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ПутьКДаннымТЧ);
				ОплатаНеТребуется = Истина;
				Для Каждого СтрокаТаблицы Из ТабличнаяЧасть Цикл
					Если СтрокаТаблицы[СтруктураПараметров.ИмяРеквизитаТЧСуммаСНДС] > 0 Тогда
						ОплатаНеТребуется = Ложь;
						Прервать;
					КонецЕсли;
				КонецЦикла;
				Если ОплатаНеТребуется Тогда
					ВыполнятьПроцерку = Ложь;
				КонецЕсли;
			КонецЕсли;
			
			Если ВыполнятьПроцерку Тогда
				ЭтапыОплатыСервер.ПроверитьЗаполнениеКорректностьДатыПлатежа(ДатаПлатежа, Дата, Отказ);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ПроверитьЗаполнитьРеквизит(Объект, СтруктураПараметров, ИмяРеквизита, ЗначениеПоУмолчанию)
	
	Если СтруктураПараметров[ИмяРеквизита] = "" 
		ИЛИ ТипЗнч(СтруктураПараметров[ИмяРеквизита]) <> Тип("Строка")
		ИЛИ СтрЧислоВхождений(СтруктураПараметров[ИмяРеквизита],".") <> 1 Тогда
		Возврат;
	КонецЕсли;
	
	Реквизит = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Объект, СтруктураПараметров[ИмяРеквизита]);
	Если Не ЗначениеЗаполнено(Реквизит.Данные[Реквизит.Имя]) Тогда
		Реквизит.Данные[Реквизит.Имя] = ЗначениеПоУмолчанию; 
	КонецЕсли;
	
КонецПроцедуры

// Процедура заполняет курс документа по умолчанию
//
// Обязательные параметры:
//	Дата
//	ВалютаДокумента
//	ВалютаВзаиморасчетов
//
Процедура ЗаполнитьКурсКратностьПоУмолчанию(Объект, ДополненныеПараметрыМеханизма)
	
	Для Каждого СтруктураПараметров Из ДополненныеПараметрыМеханизма.МассивПараметров Цикл
		
		Если СтруктураПараметров.КурсЧислитель = "" Или ТипЗнч(СтруктураПараметров.КурсЧислитель)<> Тип("Строка")
			Или СтруктураПараметров.КурсЗнаменатель = "" Или ТипЗнч(СтруктураПараметров.КурсЗнаменатель)<> Тип("Строка") Тогда
			Продолжить;
		КонецЕсли;
		
		ПроверитьПараметры(СтруктураПараметров, "ВалютаДокумента,ВалютаВзаиморасчетов");
		
		Дата                 = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Дата);
		ВалютаДокумента      = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ВалютаДокумента);
		ВалютаВзаиморасчетов = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ВалютаВзаиморасчетов);
		Организация          = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Организация);
		КурсЧислитель        = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Объект, СтруктураПараметров.КурсЧислитель);
		КурсЗнаменатель      = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Объект, СтруктураПараметров.КурсЗнаменатель);
		ВариантКурсаДоговора = СтруктураПараметров.ВариантКурсаДоговора;
		Договор              = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Договор);
		
		ВалютаРеглУчета = ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(Организация);
		
		Если Не ЗначениеЗаполнено(Дата) Тогда
			Дата = ТекущаяДатаСеанса();
		КонецЕсли;
		
		Если ВалютаДокумента = ВалютаВзаиморасчетов 
			ИЛИ НЕ ЗначениеЗаполнено(ВалютаДокумента) 
			ИЛИ НЕ ЗначениеЗаполнено(ВалютаВзаиморасчетов)
			ИЛИ НЕ ЗначениеЗаполнено(ВалютаРеглУчета) Тогда
			
			КурсЧислитель.Данные[КурсЧислитель.Имя]     = 1;
			КурсЗнаменатель.Данные[КурсЗнаменатель.Имя] = 1;
			Возврат;
			
		ИначеЕсли ВалютаДокумента = ВалютаРеглУчета И НЕ ВалютаВзаиморасчетов = ВалютаРеглУчета Тогда
			
			Если ВариантКурсаДоговора = Перечисления.ВариантыКурсаДоговора.УстановленныйВДоговоре Тогда
				СтруктураКурса = РегистрыСведений.КурсыВалютРасчетовПоДоговорам.ПолучитьЗначенияКурсаВалютыДоговора(Договор, Дата);
			Иначе
				СтруктураКурса = РаботаСКурсамиВалютУТ.ПолучитьКурсВалюты(ВалютаВзаиморасчетов, Дата, ВалютаРеглУчета);
			КонецЕсли;
			
		ИначеЕсли НЕ ВалютаДокумента = ВалютаРеглУчета И ВалютаВзаиморасчетов = ВалютаРеглУчета Тогда
			
			СтруктураКурса = РаботаСКурсамиВалютУТ.ПолучитьКурсВалюты(ВалютаДокумента, Дата, ВалютаРеглУчета);
			
		Иначе
			
			Если ВариантКурсаДоговора = Перечисления.ВариантыКурсаДоговора.УстановленныйВДоговоре Тогда
				КурсВалютыВзаиморасчетов = РегистрыСведений.КурсыВалютРасчетовПоДоговорам.ПолучитьЗначенияКурсаВалютыДоговора(Договор, Дата);
			Иначе
				КурсВалютыВзаиморасчетов = РаботаСКурсамиВалютУТ.ПолучитьКурсВалюты(ВалютаВзаиморасчетов, Дата, ВалютаРеглУчета);
			КонецЕсли;
			КурсВалютыДокумента      = РаботаСКурсамиВалютУТ.ПолучитьКурсВалюты(ВалютаДокумента, Дата, ВалютаРеглУчета);
			СтруктураКурса           = РаботаСКурсамиВалютУТ.ПолучитьКроссКурсВалют(КурсВалютыДокумента, КурсВалютыВзаиморасчетов);
			
		КонецЕсли;
		
		КурсЧислитель.Данные[КурсЧислитель.Имя] = СтруктураКурса.КурсЧислитель;
		КурсЗнаменатель.Данные[КурсЗнаменатель.Имя] = СтруктураКурса.КурсЗнаменатель;
	КонецЦикла;
	
КонецПроцедуры

//Возвращает порядок оплаты по умолчанию.
Функция ОплатаВВалютеПоУмолчанию(Объект, СтруктураПараметров)
	
	ФормаОплаты               = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ФормаОплаты);
	БанковскийСчет            = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.БанковскийСчетОрганизации);
	Касса                     = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Касса);
	ЗаказОснование            = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ЗаказОснование);
	Соглашение                = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Соглашение);
	Договор                   = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Договор);
	Организация               = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Организация);
	
	ВалютаРегламентированногоУчета = ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(Организация);
	
	ВалютаОплаты = ДенежныеСредстваСервер.ПолучитьВалютуОплаты(ФормаОплаты, БанковскийСчет, Касса);
	ОплатаВВалюте = ПолучитьОплатуВВалютеПоУмолчанию(ВалютаОплаты, Организация);
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если ЗначениеЗаполнено(ЗаказОснование) Тогда
		ОплатаВВалюте = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ЗаказОснование, "ОплатаВВалюте");
	ИначеЕсли ЗначениеЗаполнено(Соглашение) Тогда
		УстановитьПривилегированныйРежим(Истина);
		РеквизитыСоглашения = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Соглашение, "ИспользуютсяДоговорыКонтрагентов, ОплатаВВалюте");
		УстановитьПривилегированныйРежим(Ложь);
		Если РеквизитыСоглашения.ИспользуютсяДоговорыКонтрагентов И ЗначениеЗаполнено(Договор) Тогда
			ОплатаВВалюте = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Договор, "ОплатаВВалюте");
		ИначеЕсли РеквизитыСоглашения.ИспользуютсяДоговорыКонтрагентов = Ложь Тогда
			ОплатаВВалюте = РеквизитыСоглашения.ОплатаВВалюте;
		КонецЕсли;
	ИначеЕсли ЗначениеЗаполнено(Договор) Тогда
		ОплатаВВалюте = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Договор, "ОплатаВВалюте");
	Иначе 
		ВалютаОплаты = ДенежныеСредстваСервер.ПолучитьВалютуОплаты(ФормаОплаты, БанковскийСчет, Касса);
		Если НЕ ЗначениеЗаполнено(ВалютаОплаты) Тогда
			ВалютаОплаты = ВалютаРегламентированногоУчета;
		КонецЕсли;
		
		Если НЕ ВалютаОплаты = ВалютаРегламентированногоУчета Тогда
			ОплатаВВалюте = Истина;
		Иначе
			ОплатаВВалюте = Ложь;
		КонецЕсли;
		
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Ложь);
	
	Возврат ОплатаВВалюте;
	
КонецФункции

//Возвращает порядок оплаты по умолчанию.
Функция ГФУПоУмолчанию(Объект, СтруктураПараметров, СистемныеНастройки)
	
	ПорядокРасчетов = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект,СтруктураПараметров.ПорядокРасчетов);
	НакладнаяПоЗаказам = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект,СтруктураПараметров.НакладнаяПоЗаказам,,Ложь);
	Соглашение = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект,СтруктураПараметров.Соглашение);
	Договор = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект,СтруктураПараметров.Договор);
	
	ГФУПоУмолчанию = ПредопределенноеЗначение("Справочник.ГруппыФинансовогоУчетаРасчетов.ПустаяСсылка");
	
	Если СтруктураПараметров.ЭтоЗаказ
		Или СтруктураПараметров.ЭтоПлатежИлиПрочийДокумент
		Или СтруктураПараметров.ЭтоПродажаЗакупка
			И (ПорядокРасчетов = ПредопределенноеЗначение("Перечисление.ПорядокРасчетов.ПоЗаказам")
				И Не НакладнаяПоЗаказам
					Или ПорядокРасчетов = ПредопределенноеЗначение("Перечисление.ПорядокРасчетов.ПоЗаказамНакладным")
					Или ПорядокРасчетов = ПредопределенноеЗначение("Перечисление.ПорядокРасчетов.ПоДоговорамНакладным")
					Или ПорядокРасчетов = ПредопределенноеЗначение("Перечисление.ПорядокРасчетов.ПоНакладным")) Тогда
		
		Если ЗначениеЗаполнено(Соглашение) Тогда
			
			УстановитьПривилегированныйРежим(Истина);
			РеквизитыСоглашения = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Соглашение, "ИспользуютсяДоговорыКонтрагентов, ГруппаФинансовогоУчета");
			УстановитьПривилегированныйРежим(Ложь);
			
			Если РеквизитыСоглашения.ИспользуютсяДоговорыКонтрагентов
				И ЗначениеЗаполнено(Договор) Тогда
				ГФУПоУмолчанию = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Договор, "ГруппаФинансовогоУчета");
			Иначе
				ГФУПоУмолчанию = РеквизитыСоглашения.ГруппаФинансовогоУчета;
			КонецЕсли;
			
		ИначеЕсли ЗначениеЗаполнено(Договор) Тогда
			
			ГФУПоУмолчанию = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Договор, "ГруппаФинансовогоУчета");
			
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат ГФУПоУмолчанию;
	
КонецФункции

//Возвращает порядок расчетов по умолчанию.
Функция ПорядокРасчетовПоПараметрам(Объект, СтруктураПараметров)
	
	ЗаказОснование = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ЗаказОснование);
	Если Не ЗначениеЗаполнено(ЗаказОснование) Тогда
		МассивЗаказов = ПолучитьМассивЗаказовИзТЧ(Объект, СтруктураПараметров);
		Если МассивЗаказов.Количество() > 0 Тогда
			ЗаказОснование = МассивЗаказов[0];
		КонецЕсли;
	КонецЕсли;
	Соглашение     = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Соглашение);
	Если ЗначениеЗаполнено(СтруктураПараметров.ДоговорКомиссионера) Тогда
		Договор        = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ДоговорКомиссионера);
	Иначе
		
		Если СтруктураПараметров.Договор = "Объект.ДоговорПродажи"
			Или СтруктураПараметров.Договор = "Объект.ДоговорПокупки" Тогда
			Договор = Неопределено;
		Иначе
			Договор = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Договор);
		КонецЕсли;
		
	КонецЕсли;
	ЭтоЗаказ       = СтруктураПараметров.ЭтоЗаказ;
	
	Возврат ПорядокРасчетов(ЭтоЗаказ, ЗаказОснование, Соглашение, Договор);
	
КонецФункции

// Проверяет является ли оповещение в форме событием изменения документов оплаты.
//
// Параметры:
//   ИмяСобытия - Строка - имя события из процедуры формы "ОбработкаОповещения".
//
// Возвращаемое значение:
//   Булево - Истина, если оповещение является оплатой.
//
Функция ИзменилисьДокументыОплатыКлиентам(ИмяСобытия) Экспорт
	
	Возврат
		ИмяСобытия = "Запись_ОперацияПоПлатежнойКарте"
		Или ИмяСобытия = "Запись_ПоступлениеБезналичныхДенежныхСредств"
		Или ИмяСобытия = "Запись_ПриходныйКассовыйОрдер"
		Или ИмяСобытия = "Запись_ВзаимозачетЗадолженности"
		Или ИмяСобытия = "Запись_СписаниеЗадолженности";
	
КонецФункции

// Проверяет является ли оповещение в форме событием изменения документов оплаты.
//
// Параметры:
//   ИмяСобытия - Строка - имя события из процедуры формы "ОбработкаОповещения".
//
// Возвращаемое значение:
//   Булево - Истина, если оповещение является оплатой.
//
Функция ИзменилисьДокументыОплатыПоставщиком(ИмяСобытия) Экспорт
	
	Возврат
		ИмяСобытия = "Запись_АвансовыйОтчет"
		Или ИмяСобытия = "Запись_СписаниеБезналичныхДенежныхСредств"
		Или ИмяСобытия = "Запись_ПоступлениеБезналичныхДенежныхСредств"
		Или ИмяСобытия = "Запись_РасходныйКассовыйОрдер"
		Или ИмяСобытия = "Запись_ВзаимозачетЗадолженности"
		Или ИмяСобытия = "Запись_СписаниеЗадолженности";
	
КонецФункции

// Возвращаемое значение:
//   Структура:
//      * СуммаВзаиморасчетовБезЗалога - Число.
//      * СуммаДокументаБезЗалога - Число.
//      * СуммаЗалогаЗаТару - Число.
//      * СуммаВзаиморасчетовПоТаре - Число.
//      * СуммаВзаиморасчетов - Число.
//      * СуммаДокумента - Число.
//
Функция СуммыДокумента(Объект, СтруктураПараметров) Экспорт
	
	Если СтруктураПараметров.Свойство("СуммыДокумента") Тогда
		Возврат СтруктураПараметров.СуммыДокумента;
	КонецЕсли;
	
	Результат = Новый Структура;
	
	Если (СтруктураПараметров.ЭтоПродажаЗакупка ИЛИ СтруктураПараметров.ЭтоЗаказ)
		И СтруктураПараметров.ИсточникСуммТабличнаяЧасть Тогда
		ТаблицаТовары                = ТаблицаСуммПоЗаказам(Объект);
		СуммаЗалогаЗаТару            = ТаблицаТовары.Итог("СуммаЗалогаЗаТару");
		СуммаДокументаБезЗалога      = ТаблицаТовары.Итог("СуммаПлатежа");
		СуммаВзаиморасчетовПоТаре    = ТаблицаТовары.Итог("СуммаВзаиморасчетовПоТаре");
		СуммаВзаиморасчетовБезЗалога = ТаблицаТовары.Итог("СуммаВзаиморасчетов");
	ИначеЕсли ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧ) Тогда
		ТЧ = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ПутьКДаннымТЧ);
		СуммаДокументаБезЗалога      = ТЧ.Итог(СтруктураПараметров.ИмяРеквизитаТЧСуммаСНДС);
		СуммаВзаиморасчетовБезЗалога = 0;
		Если ТЧ.Количество() > 0 Тогда
			Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ТЧ[0],"СуммаВзаиморасчетов") Тогда
				СуммаВзаиморасчетовБезЗалога = ТЧ.Итог("СуммаВзаиморасчетов");
			Иначе
				СуммаВзаиморасчетовБезЗалога = ТЧ.Итог(СтруктураПараметров.ИмяРеквизитаТЧСуммаСНДС);
			КонецЕсли;
		КонецЕсли;
		СуммаЗалогаЗаТару = 0;
		СуммаВзаиморасчетовПоТаре = 0;
	Иначе
		СуммаЗалогаЗаТару            = 0;
		СуммаДокументаБезЗалога      = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.СуммаДокумента);
		СуммаВзаиморасчетовБезЗалога = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.СуммаВзаиморасчетов, , 0);
		СуммаВзаиморасчетовПоТаре    = 0;
	КонецЕсли;
	
	Результат.Вставить("СуммаВзаиморасчетовБезЗалога", СуммаВзаиморасчетовБезЗалога);
	Результат.Вставить("СуммаДокументаБезЗалога", СуммаДокументаБезЗалога);
	Результат.Вставить("СуммаЗалогаЗаТару", СуммаЗалогаЗаТару);
	Результат.Вставить("СуммаВзаиморасчетовПоТаре", СуммаВзаиморасчетовПоТаре);
	Результат.Вставить("СуммаВзаиморасчетов", СуммаВзаиморасчетовБезЗалога + СуммаВзаиморасчетовПоТаре);
	Результат.Вставить("СуммаДокумента", ?(СуммаДокументаБезЗалога = Неопределено,0,СуммаДокументаБезЗалога + СуммаЗалогаЗаТару));
	
	Возврат Результат;
	
КонецФункции

// Поместить суммы по заказам во временное хранилище.
// 
// Параметры:
//  ДокументОбъект Документ объект
// 
// Возвращаемое значение:
//  Строка - Адрес во временном хранилище.
Функция ПоместитьСуммыПоЗаказамВоВременноеХранилище(ДокументОбъект) Экспорт
	
	Возврат ПоместитьВоВременноеХранилище(ТаблицаСуммПоЗаказам(ДокументОбъект), Новый УникальныйИдентификатор());
	
КонецФункции

Функция ТаблицаСуммПоЗаказам(Объект)
	
	Если ТипЗнч(Объект) = Тип("ФормаКлиентскогоПриложения") Тогда
		Если Объект.ИмяФормы = Метаданные.Обработки.ПомощникПродаж.Формы.Форма.ПолноеИмя() Тогда
			Менеджер = Обработки.ПомощникПродаж;
			ДокументОбъект = ДанныеФормыВЗначение(Объект.Объект, Тип("ОбработкаОбъект.ПомощникПродаж"));
		Иначе
			Менеджер = ОбщегоНазначения.МенеджерОбъектаПоСсылке(
				ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, Объект.Объект.Ссылка));
			ТипОбъект = СтрЗаменить(Менеджер,"ДокументМенеджер","ДокументОбъект");
			ДокументОбъект = ДанныеФормыВЗначение(Объект.Объект, Тип(ТипОбъект));
		КонецЕсли;
	Иначе
		Менеджер = ОбщегоНазначения.МенеджерОбъектаПоПолномуИмени(Объект.Метаданные().ПолноеИмя());
		ДокументОбъект = Объект;
	КонецЕсли;
	
	Возврат Менеджер.СуммыПоЗаказам(ДокументОбъект); 
	
КонецФункции

#КонецОбласти

#Область ЭтапыОплаты

// Параметры:
// 	Объект - ФормаКлиентскогоПриложения, СправочникОбъект, ДокументОбъект - Описание
// 	СтруктураПараметров - см. ВзаиморасчетыСервер.ПараметрыМеханизма
Процедура РаспределитьСуммыЭтаповОплатыДокументаПоЗаказам(Объект, СтруктураПараметров)
	
	ЭтапыОплатыРеквизит            = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Объект, СтруктураПараметров.ПутьКДаннымТЧЭтапыОплаты);
	Дата                           = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Дата);
	ДатаПереходаПраваСобственности = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ДатаПереходаПраваСобственности);
	Соглашение                     = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Соглашение);
	
	Если НЕ ЗначениеЗаполнено(ЭтапыОплатыРеквизит.Имя) Тогда
		Возврат;
	Иначе
		ЭтапыГрафикаОплаты = ЭтапыОплатыРеквизит.Данные[ЭтапыОплатыРеквизит.Имя];
	КонецЕсли;
	
	Параметры = ЭтапыОплатыСервер.ПараметрыЗаполненияЭтаповОплатыПоЗаказам();
	Параметры.ТабличнаяЧасть                 = ТаблицаСуммПоЗаказам(Объект);
	Параметры.ДатаОтгрузки                   = ?(Дата = Дата(1,1,1), ТекущаяДатаСеанса(), Дата);
	Параметры.ДатаПереходаПраваСобственности = ДатаПереходаПраваСобственности;
	Параметры.Соглашение                     = Соглашение;
	Параметры.ПорядокРасчетов                = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ПорядокРасчетов);
	Параметры.ЭтоРасчетыСКлиентами           = СтруктураПараметров.ДокументРасчетовСКлиентами;
	
	ЭтапыОплатыСервер.РаспределитьСуммыЭтаповОплатыДокументаПоЗаказам(ЭтапыГрафикаОплаты, Параметры);
	
КонецПроцедуры

// Процедура заполняет ТЧ ЭтапыГрафикаОплаты по переданной структуре параметров.
Процедура ЗаполнитьЭтапыОплатыДокументаПоЗаказам(Объект, СтруктураПараметров)
	
	Дата                           = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Дата);
	ДатаПереходаПраваСобственности = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ДатаПереходаПраваСобственности);
	Соглашение                     = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Соглашение);
	ЭтапыОплатыРеквизит            = ОбщегоНазначенияУТКлиентСервер.ДанныеДляПрисвоения(Объект, СтруктураПараметров.ПутьКДаннымТЧЭтапыОплаты);
	Если НЕ ЗначениеЗаполнено(ЭтапыОплатыРеквизит.Имя) Тогда
		Возврат;
	Иначе
		ЭтапыГрафикаОплаты = ЭтапыОплатыРеквизит.Данные[ЭтапыОплатыРеквизит.Имя];
	КонецЕсли;
	
	ПараметрыЗаполнения = ЭтапыОплатыСервер.ПараметрыЗаполненияЭтаповОплатыПоЗаказам();
	ПараметрыЗаполнения.ДатаОтгрузки                   = ?(Дата = Дата(1,1,1), ТекущаяДатаСеанса(), Дата);
	ПараметрыЗаполнения.ДатаПереходаПраваСобственности = ДатаПереходаПраваСобственности;
	ПараметрыЗаполнения.ЕстьДатаПереходаПраваСобственности = СтруктураПараметров.ЕстьДатаПереходаПраваСобственности;
	ПараметрыЗаполнения.ТабличнаяЧасть                 = ТаблицаСуммПоЗаказам(Объект);
	ПараметрыЗаполнения.Соглашение                     = Соглашение;
	ПараметрыЗаполнения.ПорядокРасчетов                = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ПорядокРасчетов);
	ПараметрыЗаполнения.ЭтоРасчетыСКлиентами           = СтруктураПараметров.ДокументРасчетовСКлиентами;
	
	ЭтапыОплатыСервер.ЗаполнитьЭтапыОплатыДокументаПоЗаказам(ЭтапыГрафикаОплаты, ПараметрыЗаполнения);
	
КонецПроцедуры

// Проверяет равенство таблиц по общим колонкам
// 
// Параметры:
//  Таблица1 - ТаблицаЗначений - первая таблица.
//  Таблица2 - ТаблицаЗначений - вторая таблица.
// 
// Возвращаемое значение:
//  Булево - Истина, если таблицы равны
Функция ТаблицыРавны(Таблица1, Таблица2)
	
	МассивКолонок = Новый Массив;
	КолонкаНомерСтроки = Таблица1.Колонки.Найти("НомерСтроки");
	КолонкаИсходныйНомерСтроки = Таблица1.Колонки.Найти("ИсходныйНомерСтроки");
	Если КолонкаНомерСтроки <> Неопределено Тогда
		Таблица1.Колонки.Удалить(КолонкаНомерСтроки);
	КонецЕсли;
	Если КолонкаИсходныйНомерСтроки <> Неопределено Тогда
		Таблица1.Колонки.Удалить(КолонкаИсходныйНомерСтроки);
	КонецЕсли;
	Для Каждого Колонка Из Таблица1.Колонки Цикл
		Если ТипЗнч(Таблица2) = Тип("ТаблицаЗначений") 
			И Таблица2.Колонки.Найти(Колонка.Имя) <> Неопределено Тогда
			МассивКолонок.Добавить(Колонка.Имя);
		КонецЕсли;
	КонецЦикла;
	
	Результат = Истина;
	Если Таблица1.Количество() <> Таблица2.Количество() Тогда
		Результат = Ложь;
	КонецЕсли;
	Если Результат Тогда
		Для Счетчик = 0 По Таблица1.Количество() - 1 Цикл
			Если Не ОбщегоНазначенияУТКлиентСервер.СтруктурыРавны(
						Таблица1[Счетчик],
						Таблица2[Счетчик],
						МассивКолонок) Тогда
				Результат = Ложь;
				Прервать;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли; 
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#Область ЗачетОплатыРасшифровкаПлатежа

Процедура УстановитьВидимостьЗачетОплаты(Форма, СтруктураПараметров = Неопределено)
	
	Если СтруктураПараметров <> Неопределено Тогда
		МассивПараметров = Новый Массив;
		МассивПараметров.Добавить(СтруктураПараметров);
	Иначе
		ДополненныеПараметрыМеханизма = ОбщегоНазначенияУТКлиентСервер.ПолучитьДанныеМеханизмаИзКэшаФормы(Форма, "Взаиморасчеты");
		МассивПараметров = ДополненныеПараметрыМеханизма.МассивПараметров;
	КонецЕсли;
	
	РольДоступна = РольДоступна("ЗачетОплаты") ИЛИ РольДоступна("ПолныеПрава");
	
	Для Каждого СтруктураПараметров Из МассивПараметров Цикл
		
		Если Не ЗначениеЗаполнено(СтруктураПараметров.ЭлементыФормы.ЗачетОплаты) Тогда
			Продолжить;
		КонецЕсли;
		
		ПорядокРасчетов    = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.ПорядокРасчетов);
		НакладнаяПоЗаказу  = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.НакладнаяПоЗаказам, ,Ложь);
		ЭтоЗаказ           = СтруктураПараметров.ЭтоЗаказ;
		ЭтоСправочник         = СтруктураПараметров.ЭтоСправочник;
		ИмяЭлемента        = СтруктураПараметров.ЭлементыФормы.ЗачетОплаты;
		ИзменяетПланОплаты = СтруктураПараметров.ИзменяетПланОплаты;
		УдержатьВознаграждение = СтруктураПараметров.УдержатьВознаграждение;
		
		Если ЭтоЗаказ Тогда
			ВидимостьЭлемента = ПорядокРасчетов <> Перечисления.ПорядокРасчетов.ПоНакладным
								И РольДоступна
								И (ИзменяетПланОплаты ИЛИ ОбъектыРасчетовСервер.СсылкаЯвляетсяОбъектомРасчетов(Форма,СтруктураПараметров));
		ИначеЕсли НакладнаяПоЗаказу Тогда
			ВидимостьЭлемента = ПорядокРасчетов <> Перечисления.ПорядокРасчетов.ПоЗаказам
								И НЕ СтруктураПараметров.ЗаказКакСчет И РольДоступна И ИзменяетПланОплаты;
		ИначеЕсли ЭтоСправочник Тогда
			ВидимостьЭлемента = (ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоДоговорамКонтрагентов
									Или ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоДоговорамНакладным) И РольДоступна;
		ИначеЕсли УдержатьВознаграждение Тогда
			ВидимостьЭлемента = Ложь;
		Иначе
			ВидимостьЭлемента = РольДоступна И ИзменяетПланОплаты;
		КонецЕсли;
		
		ОбщегоНазначенияУТКлиентСервер.УстановитьСвойствоЭлементаФормы(Форма.Элементы, ИмяЭлемента, "Видимость", ВидимостьЭлемента);
		
	КонецЦикла;
	
КонецПроцедуры

Процедура УстановитьВидимостьГФУНД(Форма, СтруктураПараметров = Неопределено)
	
	Если СтруктураПараметров <> Неопределено Тогда
		МассивПараметров = Новый Массив;
		МассивПараметров.Добавить(СтруктураПараметров);
	Иначе
		ДополненныеПараметрыМеханизма = ОбщегоНазначенияУТКлиентСервер.ПолучитьДанныеМеханизмаИзКэшаФормы(Форма, "Взаиморасчеты");
		МассивПараметров = ДополненныеПараметрыМеханизма.МассивПараметров;
	КонецЕсли;
	
	Для Каждого СтруктураПараметров Из МассивПараметров Цикл
		
		Если Не ЗначениеЗаполнено(СтруктураПараметров.ЭлементыФормы.ГруппаФинансовогоУчета) 
			И Не ЗначениеЗаполнено(СтруктураПараметров.ЭлементыФормы.НаправлениеДеятельности) Тогда
			Продолжить;
		КонецЕсли;
		
		ПорядокРасчетов		= ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.ПорядокРасчетов);
		НакладнаяПоЗаказу	= ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Форма, СтруктураПараметров.НакладнаяПоЗаказам,, Ложь);
		ЭтоЗаказ			= СтруктураПараметров.ЭтоЗаказ;
		ЭтоСправочник		= СтруктураПараметров.ЭтоСправочник;
		ИмяЭлементаГФУ		= СтруктураПараметров.ЭлементыФормы.ГруппаФинансовогоУчета;
		ИмяЭлементаНД		= СтруктураПараметров.ЭлементыФормы.НаправлениеДеятельности;
		ИзменяетПланОплаты	= СтруктураПараметров.ИзменяетПланОплаты;
		
		Если ЭтоЗаказ Тогда
			
			ВидимостьЭлемента = (ИзменяетПланОплаты 
					Или СтруктураПараметров.ЗаказКакСчет)
				И (ПорядокРасчетов = ПредопределенноеЗначение("Перечисление.ПорядокРасчетов.ПоЗаказам")
					Или ПорядокРасчетов = ПредопределенноеЗначение("Перечисление.ПорядокРасчетов.ПоЗаказамНакладным"));
					
		ИначеЕсли НакладнаяПоЗаказу Тогда
			
			ВидимостьЭлемента = ИзменяетПланОплаты
				И (ПорядокРасчетов = ПредопределенноеЗначение("Перечисление.ПорядокРасчетов.ПоНакладным")
					Или ПорядокРасчетов = ПредопределенноеЗначение("Перечисление.ПорядокРасчетов.ПоДоговорамНакладным")
					Или ПорядокРасчетов = ПредопределенноеЗначение("Перечисление.ПорядокРасчетов.ПоЗаказамНакладным"));
					
		ИначеЕсли ЭтоСправочник Тогда
			ВидимостьЭлемента = Истина;
		Иначе
			ВидимостьЭлемента = ПорядокРасчетов <> ПредопределенноеЗначение("Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов")
				И ИзменяетПланОплаты;
		КонецЕсли;
		
		ОбщегоНазначенияУТКлиентСервер.УстановитьСвойствоЭлементаФормы(Форма.Элементы, ИмяЭлементаГФУ, "Видимость", ВидимостьЭлемента);
		
		Если ЭтоЗаказ
			И СтруктураПараметров.ЗаказКакСчет Тогда
			ОбщегоНазначенияУТКлиентСервер.УстановитьСвойствоЭлементаФормы(Форма.Элементы, ИмяЭлементаНД, "Видимость", Ложь);
		Иначе
			ОбщегоНазначенияУТКлиентСервер.УстановитьСвойствоЭлементаФормы(Форма.Элементы, ИмяЭлементаНД, "Видимость", ВидимостьЭлемента);
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ЗаполнитьВозможныеАвансыВНакладной(Объект, СтруктураПараметров) Экспорт
	
	Если НЕ ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа)
		ИЛИ НЕ СтруктураПараметров.ИзменяетРасчеты
		ИЛИ НЕ СтруктураПараметров.ЭтоПродажаЗакупка Тогда
		Возврат;
	КонецЕсли;
	
	Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(Объект,"ДополнительныеСвойства")
		И Объект.ДополнительныеСвойства.Свойство("ЗачетОплаты") Тогда
		Возврат;
	КонецЕсли;
	
	ПорядокРасчетов = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ПорядокРасчетов);
	НакладнаяПоЗаказам = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.НакладнаяПоЗаказам,,Ложь);
	Договор = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Договор);
	РасшифровкаПлатежа = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ПутьКДаннымТЧРасшифровкаПлатежа);
	ЭтоРасчетыСКлиентами = СтруктураПараметров.ДокументРасчетовСКлиентами;
	НоваяАрхитектураВзаиморасчетов = ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов");
	ДатаНакладной = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Дата);
	СсылкаНаНакладную = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Ссылка);
	МаксимальнаяСуммаЗачета = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.СуммаВзаиморасчетов, , 0)
	                        + ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.СуммаВзаиморасчетовПоТаре, , 0);
	ОбъектРасчетовНакладная = ОбъектыРасчетовСервер.ПолучитьОбъектРасчетовПоСсылке(
		СсылкаНаНакладную,
		ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.Организация),
		?(ЭтоРасчетыСКлиентами, Перечисления.ТипыРасчетовСПартнерами.РасчетыСКлиентом, Перечисления.ТипыРасчетовСПартнерами.РасчетыСПоставщиком));
	
	Если НакладнаяПоЗаказам И ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоЗаказамНакладным Тогда
		
		Запрос = Новый Запрос;
		ТекстыЗапросов = Новый Массив;
		
		Если СтруктураПараметров.ИсточникСуммТабличнаяЧасть Тогда
			ТаблицаТовары = ТаблицаСуммПоЗаказам(Объект);
			ТекстыЗапросов.Добавить("
			|ВЫБРАТЬ
			|	Товары.Заказ КАК Заказ,
			|	Товары.СуммаВзаиморасчетов + Товары.СуммаВзаиморасчетовПоТаре КАК СуммаВНакладной
			|ПОМЕСТИТЬ ВтТовары
			|ИЗ &ТаблицаТовары КАК Товары
			|;");
			Запрос.УстановитьПараметр("ТаблицаТовары", ТаблицаТовары);
			Заказ = ТаблицаТовары.ВыгрузитьКолонку("Заказ");
			ОбъектОснование = Заказ;
		Иначе
			Заказ = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ЗаказОснование);
			Сумма = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.СуммаВзаиморасчетов);
			ТекстыЗапросов.Добавить("
			|ВЫБРАТЬ
			|	&Заказ КАК Заказ,
			|	&сумма КАК СуммаВНакладной
			|ПОМЕСТИТЬ ВтТовары
			|;");
			Запрос.УстановитьПараметр("Заказ", Заказ);
			Запрос.УстановитьПараметр("Сумма", Сумма);
			ОбъектОснование = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ЗаказОснование,,Неопределено);
		КонецЕсли;
		
		Если ТипЗнч(ОбъектОснование) <> Тип("Массив") Тогда
			ОбъектОснование = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(ОбъектОснование);
		КонецЕсли;
		
		ТекстыЗапросов.Добавить("
		|ВЫБРАТЬ
		|	СУММА(Товары.СуммаВНакладной) КАК СуммаНакладной
		|ПОМЕСТИТЬ ВтСуммаНакладной
		|ИЗ ВтТовары КАК Товары
		|;");
		
		Если Не НоваяАрхитектураВзаиморасчетов Тогда
		ТекстыЗапросов.Добавить("
		|ВЫБРАТЬ
		|	Расчеты.ОбъектРасчетов        КАК ОбъектРасчетов,
		|	Расчеты.ОбъектРасчетов.Объект КАК Объект,
		|	СУММА(ВЫБОР 
		|		КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И &ЭтоРасчетыСКлиентами
		|			ИЛИ Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И НЕ &ЭтоРасчетыСКлиентами
		|			ТОГДА Расчеты.Сумма
		|		ИНАЧЕ -Расчеты.Сумма
		|	КОНЕЦ)                        КАК ОстатокПредоплаты,
		|	СУММА(ВЫБОР 
		|		КОГДА Расчеты.Регистратор В (&МассивОбъектов) 
		|			И (Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И &ЭтоРасчетыСКлиентами
		|				ИЛИ Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И НЕ &ЭтоРасчетыСКлиентами)
		|				ТОГДА КОплате
		|			ИНАЧЕ 0
		|	КОНЕЦ)                         КАК ПланОплатыВсего,
		|	СУММА(ВЫБОР 
		|		КОГДА Расчеты.Регистратор В (&МассивОбъектов)
		|			И (Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И &ЭтоРасчетыСКлиентами
		|				И (Расчеты.ВариантОплаты = ЗНАЧЕНИЕ(Перечисление.ВариантыКонтроляОплатыКлиентом.АвансДоОбеспечения) 
		|					ИЛИ Расчеты.ВариантОплаты = ЗНАЧЕНИЕ(Перечисление.ВариантыКонтроляОплатыКлиентом.ПредоплатаДоОтгрузки))
		|				ИЛИ Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И НЕ &ЭтоРасчетыСКлиентами
		|					И (Расчеты.ВариантОплаты = ЗНАЧЕНИЕ(Перечисление.ВариантыКонтроляОплатыПоставщику.АвансДоПодтверждения)
		|						ИЛИ Расчеты.ВариантОплаты = ЗНАЧЕНИЕ(Перечисление.ВариантыКонтроляОплатыПоставщику.ПредоплатаДоПоступления))) 
		|					ТОГДА КОплате
		|			ИНАЧЕ 0
		|	КОНЕЦ)                         КАК ПланПредоплаты,
		|	СУММА(ВЫБОР 
		|		КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И &ЭтоРасчетыСКлиентами
		|				ИЛИ Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И НЕ &ЭтоРасчетыСКлиентами
		|			ТОГДА Расчеты.Сумма
		|		ИНАЧЕ 0
		|	КОНЕЦ)                         КАК ВсегоОплачено,
		|	0                              КАК ОплатаПоНакладной,
		|	ВтСуммаНакладной.СуммаНакладной КАК СуммаНакладной
		|ПОМЕСТИТЬ ВтРасчеты
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентами КАК Расчеты
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтСуммаНакладной КАК ВтСуммаНакладной
		|			ПО ИСТИНА
		|ГДЕ
		|	ОбъектРасчетов.Объект В (&МассивОбъектов)
		|СГРУППИРОВАТЬ ПО
		|	Расчеты.ОбъектРасчетов,
		|	ВтСуммаНакладной.СуммаНакладной
		|ИМЕЮЩИЕ
		|	СУММА(ВЫБОР 
		|		КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И &ЭтоРасчетыСКлиентами
		|			ИЛИ Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И НЕ &ЭтоРасчетыСКлиентами
		|			ТОГДА Расчеты.Сумма
		|		ИНАЧЕ -Расчеты.Сумма
		|	КОНЕЦ) > 0
		|	И 
		|	СУММА(ВЫБОР 
		|		КОГДА Расчеты.Регистратор В (&МассивОбъектов)
		|			И (Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И &ЭтоРасчетыСКлиентами
		|				И (Расчеты.ВариантОплаты = ЗНАЧЕНИЕ(Перечисление.ВариантыКонтроляОплатыКлиентом.АвансДоОбеспечения) 
		|					ИЛИ Расчеты.ВариантОплаты = ЗНАЧЕНИЕ(Перечисление.ВариантыКонтроляОплатыКлиентом.ПредоплатаДоОтгрузки))
		|				ИЛИ Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И НЕ &ЭтоРасчетыСКлиентами
		|					И (Расчеты.ВариантОплаты = ЗНАЧЕНИЕ(Перечисление.ВариантыКонтроляОплатыПоставщику.АвансДоПодтверждения)
		|						ИЛИ Расчеты.ВариантОплаты = ЗНАЧЕНИЕ(Перечисление.ВариантыКонтроляОплатыПоставщику.ПредоплатаДоПоступления))) 
		|					ТОГДА КОплате
		|			ИНАЧЕ 0
		|	КОНЕЦ) > 0
		|	И 
		|	СУММА(ВЫБОР 
		|		КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И &ЭтоРасчетыСКлиентами
		|				ИЛИ Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И НЕ &ЭтоРасчетыСКлиентами
		|			ТОГДА Расчеты.Сумма
		|		ИНАЧЕ 0
		|	КОНЕЦ) > 0
		|;");
		Иначе
			ТекстыЗапросов.Добавить(ТекстЗапросаОстатковПредоплаты(ЭтоРасчетыСКлиентами));
			Запрос.УстановитьПараметр("ДатаНакладной", ДатаНакладной);
			Запрос.УстановитьПараметр("Объекты", ОбъектОснование);
			Запрос.УстановитьПараметр("ДокументыПлана", ОбъектОснование);
			ВариантыПредоплаты = Новый Массив;
			Если ЭтоРасчетыСКлиентами Тогда
				ВариантыПредоплаты.Добавить(Перечисления.ВариантыКонтроляОплатыКлиентом.АвансДоОбеспечения);
				ВариантыПредоплаты.Добавить(Перечисления.ВариантыКонтроляОплатыКлиентом.ПредоплатаДоОтгрузки);
			Иначе
				ВариантыПредоплаты.Добавить(Перечисления.ВариантыКонтроляОплатыПоставщику.АвансДоПодтверждения);
				ВариантыПредоплаты.Добавить(Перечисления.ВариантыКонтроляОплатыПоставщику.ПредоплатаДоПоступления);
			КонецЕсли;
			Запрос.УстановитьПараметр("ВариантыПредоплаты", ВариантыПредоплаты);
			Запрос.УстановитьПараметр("ДанныеОтчета", 4);
			Запрос.УстановитьПараметр("СсылкаНаНакладную", СсылкаНаНакладную);
		КонецЕсли;
		
		ТекстыЗапросов.Добавить("
		|ВЫБРАТЬ
		|	ВЫБОР 
		|		//На заказ пришло больше предоплаты
		|		КОГДА ВсегоОплачено >= ПланОплатыВсего
		|			ТОГДА Товары.СуммаВНакладной
		|		//На остатке есть достаточная предоплата для текущей накладной
		|		КОГДА ОстатокПредоплаты >= ВЫРАЗИТЬ(Товары.СуммаВНакладной * (ПланПредоплаты / ПланОплатыВсего) КАК ЧИСЛО(31,2))
		|			ТОГДА ВЫРАЗИТЬ(Товары.СуммаВНакладной * (ПланПредоплаты / ПланОплатыВсего) КАК ЧИСЛО(31,2))
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Сумма,
		|	Расчеты.ОплатаПоНакладной КАК ОплатаПоНакладной,
		|	ОбъектРасчетов КАК ОбъектРасчетов,
		|	ОбъектРасчетов.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов
		|ИЗ
		|	ВтРасчеты КАК Расчеты
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтТовары КАК Товары
		|			ПО Расчеты.Объект = Товары.Заказ
		|ГДЕ
		|	ВЫБОР 
		|		//На заказ пришло больше предоплаты
		|		КОГДА ВсегоОплачено >= ПланОплатыВсего
		|			ТОГДА СуммаНакладной
		|		//На остатке есть достаточная предоплата для текущей накладной
		|		КОГДА ОстатокПредоплаты >= ВЫРАЗИТЬ(Товары.СуммаВНакладной * (ПланПредоплаты / ПланОплатыВсего) КАК ЧИСЛО(31,2))
		|			ТОГДА ВЫРАЗИТЬ(Товары.СуммаВНакладной * (ПланПредоплаты / ПланОплатыВсего) КАК ЧИСЛО(31,2))
		|		ИНАЧЕ 0
		|	КОНЕЦ > 0
		|");
		Запрос.УстановитьПараметр("МассивОбъектов", ОбъектОснование);
		Запрос.УстановитьПараметр("ЭтоРасчетыСКлиентами", ЭтоРасчетыСКлиентами);
		Запрос.Текст = СтрСоединить(ТекстыЗапросов);
		Если НЕ ЭтоРасчетыСКлиентами Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст,".РасчетыСКлиентами",".РасчетыСПоставщиками");
		КонецЕсли;
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			МаксимальнаяСуммаЗачета = МаксимальнаяСуммаЗачета - Выборка.ОплатаПоНакладной;
		КонецЕсли;
		Выборка.Сбросить();
		Пока Выборка.Следующий() Цикл
			Если МаксимальнаяСуммаЗачета <= 0 Тогда
				Продолжить;
			КонецЕсли;
			НовСтр = РасшифровкаПлатежа.Добавить();
			НовСтр.ОбъектРасчетов = Выборка.ОбъектРасчетов;
			Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(НовСтр,"ВалютаВзаиморасчетов") Тогда
				НовСтр.ВалютаВзаиморасчетов = Выборка.ВалютаВзаиморасчетов;
			КонецЕсли;
			НовСтр.СуммаВзаиморасчетов = Мин(Выборка.Сумма, МаксимальнаяСуммаЗачета);
			НовСтр.Сумма = Мин(Выборка.Сумма, МаксимальнаяСуммаЗачета);
			Уменьшить = НовСтр.СуммаВзаиморасчетов;
			Для Каждого СтрокаРасшифровки Из РасшифровкаПлатежа Цикл
				Если Уменьшить > 0
					И (Не ЗначениеЗаполнено(СтрокаРасшифровки.ОбъектРасчетов)
						Или СтрокаРасшифровки.ОбъектРасчетов = ОбъектРасчетовНакладная) Тогда
					СтрокаРасшифровки.СуммаВзаиморасчетов = СтрокаРасшифровки.СуммаВзаиморасчетов - Мин(СтрокаРасшифровки.СуммаВзаиморасчетов, Уменьшить);
					СтрокаРасшифровки.Сумма = СтрокаРасшифровки.СуммаВзаиморасчетов;
					Уменьшить = Уменьшить - СтрокаРасшифровки.СуммаВзаиморасчетов;
				КонецЕсли;
			КонецЦикла;
			МаксимальнаяСуммаЗачета = МаксимальнаяСуммаЗачета - НовСтр.Сумма;
		КонецЦикла;
		Индекс = РасшифровкаПлатежа.Количество();
		Пока Индекс > 0 Цикл
			Индекс = Индекс - 1;
			Если РасшифровкаПлатежа[Индекс].СуммаВзаиморасчетов = 0 Тогда
				РасшифровкаПлатежа.Удалить(Индекс);
			КонецЕсли;
		КонецЦикла;
		
	ИначеЕсли НакладнаяПоЗаказам И ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоДоговорамНакладным И НЕ СтруктураПараметров.ЗаданГрафикИсполнения Тогда
			
		Если ТипЗнч(ОбъектОснование) <> Тип("Массив") Тогда
			ОбъектОснование = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(ОбъектОснование);
		КонецЕсли;
		ОбъектОснование.Добавить(Договор);
		
		Запрос = Новый Запрос;
		ТекстыЗапросов = Новый Массив;
		
		Если СтруктураПараметров.ИсточникСуммТабличнаяЧасть Тогда
			ТаблицаТовары = ТаблицаСуммПоЗаказам(Объект);
			ТекстыЗапросов.Добавить("
			|ВЫБРАТЬ
			|	Товары.СуммаВзаиморасчетов + Товары.СуммаВзаиморасчетовПоТаре КАК Сумма
			|ПОМЕСТИТЬ ВтТовары
			|ИЗ &ТаблицаТовары КАК Товары
			|;");
			Запрос.УстановитьПараметр("ТаблицаТовары", ТаблицаТовары);
			Заказ = ТаблицаТовары.ВыгрузитьКолонку("Заказ");
		Иначе
			Заказ = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ЗаказОснование);
			Сумма = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.СуммаВзаиморасчетов);
			ТекстыЗапросов.Добавить("
			|ВЫБРАТЬ
			|	&Сумма КАК Сумма
			|ПОМЕСТИТЬ ВтТовары
			|;");
			Запрос.УстановитьПараметр("Сумма", Сумма);
		КонецЕсли;
		
		ТекстыЗапросов.Добавить("
		|ВЫБРАТЬ
		|	Товары.Сумма КАК СуммаНакладной
		|ПОМЕСТИТЬ ВтСуммаНакладной
		|ИЗ ВтТовары КАК Товары
		|;");
		
		Если Не НоваяАрхитектураВзаиморасчетов Тогда
		ТекстыЗапросов.Добавить("
		|ВЫБРАТЬ
		|	Расчеты.ОбъектРасчетов        КАК ОбъектРасчетов,
		|	СУММА(ВЫБОР 
		|		КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И &ЭтоРасчетыСКлиентами
		|			ИЛИ Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И НЕ &ЭтоРасчетыСКлиентами
		|			ТОГДА Расчеты.Сумма
		|		ИНАЧЕ -Расчеты.Сумма
		|	КОНЕЦ)                        КАК ОстатокПредоплаты,
		|	СУММА(ВЫБОР 
		|		КОГДА Расчеты.Регистратор В (&Заказ) 
		|			И (Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И &ЭтоРасчетыСКлиентами
		|				ИЛИ Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И НЕ &ЭтоРасчетыСКлиентами)
		|				ТОГДА КОплате
		|			ИНАЧЕ 0
		|	КОНЕЦ)                         КАК ПланОплатыВсего,
		|	СУММА(ВЫБОР 
		|		КОГДА Расчеты.Регистратор В (&Заказ)
		|			И (Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И &ЭтоРасчетыСКлиентами
		|				И (Расчеты.ВариантОплаты = ЗНАЧЕНИЕ(Перечисление.ВариантыКонтроляОплатыКлиентом.АвансДоОбеспечения) 
		|					ИЛИ Расчеты.ВариантОплаты = ЗНАЧЕНИЕ(Перечисление.ВариантыКонтроляОплатыКлиентом.ПредоплатаДоОтгрузки))
		|				ИЛИ Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И НЕ &ЭтоРасчетыСКлиентами
		|					И (Расчеты.ВариантОплаты = ЗНАЧЕНИЕ(Перечисление.ВариантыКонтроляОплатыПоставщику.АвансДоПодтверждения)
		|						ИЛИ Расчеты.ВариантОплаты = ЗНАЧЕНИЕ(Перечисление.ВариантыКонтроляОплатыПоставщику.ПредоплатаДоПоступления))) 
		|					ТОГДА КОплате
		|			ИНАЧЕ 0
		|	КОНЕЦ)                         КАК ПланПредоплаты,
		|	СУММА(ВЫБОР 
		|		КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И &ЭтоРасчетыСКлиентами
		|				ИЛИ Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И НЕ &ЭтоРасчетыСКлиентами
		|			ТОГДА Расчеты.Сумма
		|		ИНАЧЕ 0
		|	КОНЕЦ)                         КАК ВсегоОплачено,
		|	0                              КАК ОплатаПоНакладной,
		|	ВтСуммаНакладной.СуммаНакладной КАК СуммаНакладной
		|ПОМЕСТИТЬ ВтРасчеты
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентами КАК Расчеты
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВтСуммаНакладной КАК ВтСуммаНакладной
		|			ПО ИСТИНА
		|ГДЕ
		|	ОбъектРасчетов.Объект В (&МассивОбъектов)
		|СГРУППИРОВАТЬ ПО
		|	Расчеты.ОбъектРасчетов,
		|	ВтСуммаНакладной.СуммаНакладной
		|ИМЕЮЩИЕ
		|	СУММА(ВЫБОР 
		|		КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И &ЭтоРасчетыСКлиентами
		|			ИЛИ Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И НЕ &ЭтоРасчетыСКлиентами
		|			ТОГДА Расчеты.Сумма
		|		ИНАЧЕ -Расчеты.Сумма
		|	КОНЕЦ) > 0
		|	И 
		|	СУММА(ВЫБОР 
		|		КОГДА Расчеты.Регистратор В (&Заказ)
		|			И (Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И &ЭтоРасчетыСКлиентами
		|				И (Расчеты.ВариантОплаты = ЗНАЧЕНИЕ(Перечисление.ВариантыКонтроляОплатыКлиентом.АвансДоОбеспечения) 
		|					ИЛИ Расчеты.ВариантОплаты = ЗНАЧЕНИЕ(Перечисление.ВариантыКонтроляОплатыКлиентом.ПредоплатаДоОтгрузки))
		|				ИЛИ Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И НЕ &ЭтоРасчетыСКлиентами
		|					И (Расчеты.ВариантОплаты = ЗНАЧЕНИЕ(Перечисление.ВариантыКонтроляОплатыПоставщику.АвансДоПодтверждения)
		|						ИЛИ Расчеты.ВариантОплаты = ЗНАЧЕНИЕ(Перечисление.ВариантыКонтроляОплатыПоставщику.ПредоплатаДоПоступления))) 
		|					ТОГДА КОплате
		|			ИНАЧЕ 0
		|	КОНЕЦ) > 0
		|	И 
		|	СУММА(ВЫБОР 
		|		КОГДА Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И &ЭтоРасчетыСКлиентами
		|				ИЛИ Расчеты.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И НЕ &ЭтоРасчетыСКлиентами
		|			ТОГДА Расчеты.Сумма
		|		ИНАЧЕ 0
		|	КОНЕЦ) > 0
		|;");
		Иначе
			ТекстыЗапросов.Добавить(ТекстЗапросаОстатковПредоплаты(ЭтоРасчетыСКлиентами));
			Запрос.УстановитьПараметр("ДатаНакладной", ДатаНакладной);
			Запрос.УстановитьПараметр("Объекты", Договор);
			Запрос.УстановитьПараметр("ДокументыПлана", Заказ);
			ВариантыПредоплаты = Новый Массив;
			Если ЭтоРасчетыСКлиентами Тогда
				ВариантыПредоплаты.Добавить(Перечисления.ВариантыКонтроляОплатыКлиентом.АвансДоОбеспечения);
				ВариантыПредоплаты.Добавить(Перечисления.ВариантыКонтроляОплатыКлиентом.ПредоплатаДоОтгрузки);
			Иначе
				ВариантыПредоплаты.Добавить(Перечисления.ВариантыКонтроляОплатыПоставщику.АвансДоПодтверждения);
				ВариантыПредоплаты.Добавить(Перечисления.ВариантыКонтроляОплатыПоставщику.ПредоплатаДоПоступления);
			КонецЕсли;
			Запрос.УстановитьПараметр("ВариантыПредоплаты", ВариантыПредоплаты);
			Запрос.УстановитьПараметр("ДанныеОтчета", 4);
			Запрос.УстановитьПараметр("СсылкаНаНакладную", СсылкаНаНакладную);
		КонецЕсли;
		
		ТекстыЗапросов.Добавить("
		|ВЫБРАТЬ
		|	ВЫБОР 
		|		//На заказ пришло больше предоплаты
		|		КОГДА ВсегоОплачено >= ПланОплатыВсего
		|			ТОГДА ВЫБОР
		|					КОГДА ВсегоОплачено * СуммаНакладной / ПланОплатыВсего > ПланОплатыВсего
		|						ТОГДА ВЫБОР
		|								КОГДА ПланОплатыВсего > СуммаНакладной
		|									И СуммаНакладной <= ОстатокПредоплаты
		|									ТОГДА СуммаНакладной
		|								КОГДА ПланОплатыВсего <= СуммаНакладной
		|									И ПланОплатыВсего <= ОстатокПредоплаты
		|									ТОГДА ПланОплатыВсего
		|								ИНАЧЕ ОстатокПредоплаты
		|							КОНЕЦ
		|					ИНАЧЕ ВЫБОР
		|								КОГДА ВсегоОплачено * СуммаНакладной / ПланОплатыВсего > СуммаНакладной 
		|									И СуммаНакладной <= ОстатокПредоплаты
		|									ТОГДА СуммаНакладной
		|								КОГДА ВсегоОплачено * СуммаНакладной / ПланОплатыВсего <= СуммаНакладной 
		|									И ПланОплатыВсего <= ОстатокПредоплаты
		|									ТОГДА ПланОплатыВсего
		|								ИНАЧЕ ОстатокПредоплаты
		|							КОНЕЦ
		|				КОНЕЦ 
		|		//На остатке есть достаточная предоплата для текущей накладной
		|		КОГДА ОстатокПредоплаты >= ВЫРАЗИТЬ(СуммаНакладной * (ПланПредоплаты / ПланОплатыВсего) КАК ЧИСЛО(31,2))
		|			ТОГДА ВЫРАЗИТЬ(СуммаНакладной * (ПланПредоплаты / ПланОплатыВсего) КАК ЧИСЛО(31,2))
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Сумма,
		|	Расчеты.ОплатаПоНакладной КАК ОплатаПоНакладной,
		|	ОбъектРасчетов КАК ОбъектРасчетов,
		|	ОбъектРасчетов.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов
		|ИЗ
		|	ВтРасчеты КАК Расчеты
		|ГДЕ
		|	ВЫБОР 
		|		//На заказ пришло больше предоплаты
		|		КОГДА ВсегоОплачено >= ПланОплатыВсего
		|			ТОГДА ВЫБОР
		|					КОГДА ВсегоОплачено * СуммаНакладной / ПланОплатыВсего > ПланОплатыВсего
		|						ТОГДА ВЫБОР
		|								КОГДА ПланОплатыВсего > СуммаНакладной
		|									И СуммаНакладной <= ОстатокПредоплаты
		|									ТОГДА СуммаНакладной
		|								КОГДА ПланОплатыВсего <= СуммаНакладной
		|									И ПланОплатыВсего <= ОстатокПредоплаты
		|									ТОГДА ПланОплатыВсего
		|								ИНАЧЕ ОстатокПредоплаты
		|							КОНЕЦ
		|					ИНАЧЕ ВЫБОР
		|								КОГДА ВсегоОплачено * СуммаНакладной / ПланОплатыВсего > СуммаНакладной 
		|									И СуммаНакладной <= ОстатокПредоплаты
		|									ТОГДА СуммаНакладной
		|								КОГДА ВсегоОплачено * СуммаНакладной / ПланОплатыВсего <= СуммаНакладной 
		|									И ПланОплатыВсего <= ОстатокПредоплаты
		|									ТОГДА ПланОплатыВсего
		|								ИНАЧЕ ОстатокПредоплаты
		|							КОНЕЦ
		|				КОНЕЦ 
		|		//На остатке есть достаточная предоплата для текущей накладной
		|		КОГДА ОстатокПредоплаты >= ВЫРАЗИТЬ(СуммаНакладной * (ПланПредоплаты / ПланОплатыВсего) КАК ЧИСЛО(31,2))
		|			ТОГДА ВЫРАЗИТЬ(СуммаНакладной * (ПланПредоплаты / ПланОплатыВсего) КАК ЧИСЛО(31,2))
		|		ИНАЧЕ 0
		|	КОНЕЦ > 0
		|");
		Запрос.УстановитьПараметр("МассивОбъектов", Договор);
		Запрос.УстановитьПараметр("Заказ", Заказ);
		Запрос.УстановитьПараметр("ЭтоРасчетыСКлиентами", ЭтоРасчетыСКлиентами);
		Запрос.Текст = СтрСоединить(ТекстыЗапросов);
		Если НЕ ЭтоРасчетыСКлиентами Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст,".РасчетыСКлиентами",".РасчетыСПоставщиками");
		КонецЕсли;
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			МаксимальнаяСуммаЗачета = МаксимальнаяСуммаЗачета - Выборка.ОплатаПоНакладной;
		КонецЕсли;
		Выборка.Сбросить();
		Пока Выборка.Следующий() Цикл
			Если МаксимальнаяСуммаЗачета <= 0 Тогда
				Продолжить;
			КонецЕсли;
			НовСтр = РасшифровкаПлатежа.Добавить();
			НовСтр.ОбъектРасчетов = Выборка.ОбъектРасчетов;
			Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(НовСтр,"ВалютаВзаиморасчетов") Тогда
				НовСтр.ВалютаВзаиморасчетов = Выборка.ВалютаВзаиморасчетов;
			КонецЕсли;
			НовСтр.СуммаВзаиморасчетов = Мин(Выборка.Сумма, МаксимальнаяСуммаЗачета);
			НовСтр.Сумма = Мин(Выборка.Сумма, МаксимальнаяСуммаЗачета);
			Уменьшить = НовСтр.СуммаВзаиморасчетов;
			Для Каждого СтрокаРасшифровки Из РасшифровкаПлатежа Цикл
				Если Уменьшить > 0
					И (Не ЗначениеЗаполнено(СтрокаРасшифровки.ОбъектРасчетов)
						Или СтрокаРасшифровки.ОбъектРасчетов = ОбъектРасчетовНакладная) Тогда
					СтрокаРасшифровки.СуммаВзаиморасчетов = СтрокаРасшифровки.СуммаВзаиморасчетов - Мин(СтрокаРасшифровки.СуммаВзаиморасчетов, Уменьшить);
					СтрокаРасшифровки.Сумма = СтрокаРасшифровки.СуммаВзаиморасчетов;
					Уменьшить = Уменьшить - СтрокаРасшифровки.СуммаВзаиморасчетов;
				КонецЕсли;
			КонецЦикла;
			МаксимальнаяСуммаЗачета = МаксимальнаяСуммаЗачета - НовСтр.Сумма;
		КонецЦикла;
		Индекс = РасшифровкаПлатежа.Количество();
		Пока Индекс > 0 Цикл
			Индекс = Индекс - 1;
			Если РасшифровкаПлатежа[Индекс].СуммаВзаиморасчетов = 0 Тогда
				РасшифровкаПлатежа.Удалить(Индекс);
			КонецЕсли;
		КонецЦикла;
		
	ИначеЕсли ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоДоговорамНакладным И ЗначениеЗаполнено(СтруктураПараметров.ПутьКДаннымТЧЭтапыОплаты) Тогда
		
		ТЧЭтапыОплаты = ОбщегоНазначенияУТКлиентСервер.ДанныеПоПути(Объект, СтруктураПараметров.ПутьКДаннымТЧЭтапыОплаты);
		
		СуммаПредоплаты = 0;
		Для Каждого СтрокаЭтапаОплаты Из ТЧЭтапыОплаты Цикл
			Если СтрокаЭтапаОплаты.ВариантОплаты = Перечисления.ВариантыКонтроляОплатыКлиентом.АвансДоОбеспечения
				Или СтрокаЭтапаОплаты.ВариантОплаты = Перечисления.ВариантыКонтроляОплатыКлиентом.ПредоплатаДоОтгрузки
				Или СтрокаЭтапаОплаты.ВариантОплаты = Перечисления.ВариантыКонтроляОплатыПоставщику.АвансДоПодтверждения
				Или СтрокаЭтапаОплаты.ВариантОплаты = Перечисления.ВариантыКонтроляОплатыПоставщику.ПредоплатаДоПоступления Тогда
				СуммаПредоплаты = СуммаПредоплаты + СтрокаЭтапаОплаты.СуммаВзаиморасчетов;
				Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(СтрокаЭтапаОплаты, "СуммаВзаиморасчетовПоТаре") Тогда
					СуммаПредоплаты = СуммаПредоплаты + СтрокаЭтапаОплаты.СуммаВзаиморасчетовПоТаре;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
		Запрос = Новый Запрос;
		Если Не НоваяАрхитектураВзаиморасчетов Тогда
		Запрос.Текст = "
		|ВЫБРАТЬ
		|	Расчеты.ОбъектРасчетов КАК ОбъектРасчетов,
		|	ВЫБОР
		|		КОГДА &ЭтоРасчетыСКлиентами
		|			ТОГДА -Расчеты.СуммаОстаток
		|		ИНАЧЕ Расчеты.СуммаОстаток
		|	КОНЕЦ КАК ОстатокПредоплаты
		|ПОМЕСТИТЬ ВтРасчеты
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентами.Остатки(, ОбъектРасчетов.Объект = &Договор) КАК Расчеты
		|
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА Расчеты.ОстатокПредоплаты >= &СуммаПредоплаты
		|			ТОГДА &СуммаПредоплаты
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Сумма,
		|	0 КАК ОплатаПоНакладной,
		|	Расчеты.ОбъектРасчетов КАК ОбъектРасчетов,
		|	Расчеты.ОбъектРасчетов.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов
		|ИЗ
		|	ВтРасчеты КАК Расчеты
		|ГДЕ
		|	ВЫБОР
		|		КОГДА Расчеты.ОстатокПредоплаты >= &СуммаПредоплаты
		|			ТОГДА &СуммаПредоплаты
		|		ИНАЧЕ 0
		|	КОНЕЦ > 0";
		Иначе
			Запрос.Текст = "
				|ВЫБРАТЬ
				|	Расчеты.ОбъектРасчетов КАК ОбъектРасчетов,
				|	&СуммаПредоплаты КАК Сумма,
				|	ЕСТЬNULL(МАКСИМУМ(РасчетыПоНакладной.ПредоплатаОстаток), 0) КАК ОплатаПоНакладной,
				|	Расчеты.ОбъектРасчетов.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов
				|ИЗ
				|	РегистрНакопления.РасчетыСКлиентамиПоСрокам.Остатки(, ОбъектРасчетов.Объект = &Договор) КАК Расчеты
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентамиПоСрокам.Остатки(, ОбъектРасчетов.Объект = &СсылкаНаНакладную) КАК РасчетыПоНакладной
				|		ПО (ИСТИНА)
				|ГДЕ
				|	Расчеты.ДатаВозникновения <= &ДатаНакладной
				|
				|СГРУППИРОВАТЬ ПО
				|	Расчеты.ОбъектРасчетов,
				|	Расчеты.ОбъектРасчетов.ВалютаВзаиморасчетов
				|
				|ИМЕЮЩИЕ
				|	ВЫБОР
				|		КОГДА СУММА(Расчеты.ПредоплатаОстаток) >= &СуммаПредоплаты
				|			ТОГДА &СуммаПредоплаты
				|		ИНАЧЕ 0
				|	КОНЕЦ > 0
				|";
			Запрос.УстановитьПараметр("ДатаНакладной", ДатаНакладной);
		КонецЕсли;
		Запрос.УстановитьПараметр("Договор", Договор);
		Запрос.УстановитьПараметр("ЭтоРасчетыСКлиентами", ЭтоРасчетыСКлиентами);
		Запрос.УстановитьПараметр("СуммаПредоплаты", СуммаПредоплаты);
		Запрос.УстановитьПараметр("СсылкаНаНакладную", СсылкаНаНакладную);
		Если НЕ ЭтоРасчетыСКлиентами Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст,".РасчетыСКлиентами",".РасчетыСПоставщиками");
		КонецЕсли;
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			МаксимальнаяСуммаЗачета = МаксимальнаяСуммаЗачета - Выборка.ОплатаПоНакладной;
		КонецЕсли;
		Выборка.Сбросить();
		Пока Выборка.Следующий() Цикл
			Если МаксимальнаяСуммаЗачета <= 0 Тогда
				Продолжить;
			КонецЕсли;
			НовСтр = РасшифровкаПлатежа.Добавить();
			НовСтр.ОбъектРасчетов = Выборка.ОбъектРасчетов;
			Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(НовСтр,"ВалютаВзаиморасчетов") Тогда
				НовСтр.ВалютаВзаиморасчетов = Выборка.ВалютаВзаиморасчетов;
			КонецЕсли;
			НовСтр.СуммаВзаиморасчетов = Мин(Выборка.Сумма, МаксимальнаяСуммаЗачета);
			НовСтр.Сумма = Мин(Выборка.Сумма, МаксимальнаяСуммаЗачета);
			Уменьшить = НовСтр.СуммаВзаиморасчетов;
			Для Каждого СтрокаРасшифровки Из РасшифровкаПлатежа Цикл
				Если Уменьшить > 0
					И (Не ЗначениеЗаполнено(СтрокаРасшифровки.ОбъектРасчетов)
						Или СтрокаРасшифровки.ОбъектРасчетов = ОбъектРасчетовНакладная) Тогда
					СтрокаРасшифровки.СуммаВзаиморасчетов = СтрокаРасшифровки.СуммаВзаиморасчетов - Мин(СтрокаРасшифровки.СуммаВзаиморасчетов, Уменьшить);
					СтрокаРасшифровки.Сумма = СтрокаРасшифровки.СуммаВзаиморасчетов;
					Уменьшить = Уменьшить - СтрокаРасшифровки.СуммаВзаиморасчетов;
				КонецЕсли;
			КонецЦикла;
			МаксимальнаяСуммаЗачета = МаксимальнаяСуммаЗачета - НовСтр.Сумма;
		КонецЦикла;
		Индекс = РасшифровкаПлатежа.Количество();
		Пока Индекс > 0 Цикл
			Индекс = Индекс - 1;
			Если РасшифровкаПлатежа[Индекс].СуммаВзаиморасчетов = 0 Тогда
				РасшифровкаПлатежа.Удалить(Индекс);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
		
КонецПроцедуры

Функция ТекстЗапросаОстатковПредоплаты(ЭтоРасчетыСКлиентами)
	
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	Расчеты.ОбъектРасчетов                                      КАК ОбъектРасчетов,
	|	Расчеты.ОбъектРасчетов.Объект                               КАК Объект,
	|	СУММА(Расчеты.ОстатокПредоплаты)                            КАК ОстатокПредоплаты,
	|	СУММА(Расчеты.ПланОплатыВсего)                              КАК ПланОплатыВсего,
	|	СУММА(Расчеты.ПланПредоплаты)                               КАК ПланПредоплаты,
	|	СУММА(Расчеты.ВсегоОплачено)                                КАК ВсегоОплачено,
	|	ЕСТЬNULL(МАКСИМУМ(РасчетыПоНакладной.ПредоплатаОстаток), 0) КАК ОплатаПоНакладной,
	|	ВтСуммаНакладной.СуммаНакладной                             КАК СуммаНакладной
	|ПОМЕСТИТЬ ВтРасчеты
	|ИЗ
	|	(ВЫБРАТЬ
	|		ОстаткиПоСрокам.ОбъектРасчетов    КАК ОбъектРасчетов,
	|		ОстаткиПоСрокам.ПредоплатаОстаток КАК ОстатокПредоплаты,
	|		0                                 КАК ПланОплатыВсего,
	|		0                                 КАК ПланПредоплаты,
	|		0                                 КАК ВсегоОплачено
	|	ИЗ
	|		РегистрНакопления.РасчетыСКлиентамиПоСрокам.Остатки(, ОбъектРасчетов.Объект В (&Объекты)) КАК ОстаткиПоСрокам
	|	ГДЕ
	|		ОстаткиПоСрокам.ДатаВозникновения <= &ДатаНакладной
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ПланОплат.ОбъектРасчетов          КАК ОбъектРасчетов,
	|		0                                 КАК ОстатокПредоплаты,
	|		ПланОплат.КОплате                 КАК ПланОплатыВсего,
	|		ВЫБОР
	|			КОГДА ПланОплат.ВариантОплаты В (&ВариантыПредоплаты)
	|				ТОГДА ПланОплат.КОплате
	|			ИНАЧЕ 0
	|		КОНЕЦ                             КАК ПланПредоплаты,
	|		0                                 КАК ВсегоОплачено
	|	ИЗ
	|		РегистрНакопления.РасчетыСКлиентамиПланОплат КАК ПланОплат
	|	ГДЕ
	|		ПланОплат.Регистратор В(&ДокументыПлана)
	|		И ПланОплат.Активность
	|		И ПланОплат.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		РасчетыПоСрокам.ОбъектРасчетов    КАК ОбъектРасчетов,
	|		0                                 КАК ОстатокПредоплаты,
	|		0                                 КАК ПланОплатыВсего,
	|		0                                 КАК ПланПредоплаты,
	|		&ШаблонПоляОплачено               КАК ВсегоОплачено
	|	ИЗ
	|		РегистрНакопления.РасчетыСКлиентамиПоСрокам КАК РасчетыПоСрокам
	|	ГДЕ
	|		РасчетыПоСрокам.ОбъектРасчетов.Объект В (&Объекты)
	|		И РасчетыПоСрокам.ДатаВозникновения <= &ДатаНакладной
	|		И РасчетыПоСрокам.Активность) КАК Расчеты
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВтСуммаНакладной КАК ВтСуммаНакладной
	|		ПО (ИСТИНА)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентамиПоСрокам.Остатки(, ОбъектРасчетов.Объект = &СсылкаНаНакладную) КАК РасчетыПоНакладной
	|		ПО (ИСТИНА)
	|
	|СГРУППИРОВАТЬ ПО
	|	Расчеты.ОбъектРасчетов,
	|	ВтСуммаНакладной.СуммаНакладной
	|ИМЕЮЩИЕ 
	|	СУММА(Расчеты.ОстатокПредоплаты) > 0
	|	И СУММА(Расчеты.ПланПредоплаты) > 0
	|	И СУММА(Расчеты.ВсегоОплачено) > 0
	|;";
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ШаблонПоляОплачено", ?(ЭтоРасчетыСКлиентами, ШаблонПоляОплаченоКлиентом(), ШаблонПоляОплаченоПоставщику()));
	
	Возврат ТекстЗапроса;
	
КонецФункции

// Параметры:
//  Форма -  ФормаКлиентскогоПриложения 
Процедура УстановитьУсловноеОформление(Форма)
	ДополненныеПараметрыМеханизма = ОбщегоНазначенияУТКлиентСервер.ПолучитьДанныеМеханизмаИзКэшаФормы(Форма, "Взаиморасчеты");
	
	Для Каждого СтруктураПараметров Из ДополненныеПараметрыМеханизма.МассивПараметров Цикл
		
		Если НЕ ЗначениеЗаполнено(СтруктураПараметров.ЭлементыФормы.СуммаВзаиморасчетовТЧ) ИЛИ Не ЗначениеЗаполнено(СтруктураПараметров.ВалютаВзаиморасчетов) Тогда
			Продолжить;
		КонецЕсли;
		
		Элемент = Форма.УсловноеОформление.Элементы.Добавить();
		
		ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
		ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(СтруктураПараметров.ЭлементыФормы.СуммаВзаиморасчетовТЧ);
		
		ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
		ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных(СтруктураПараметров.ВалютаДокумента);
		ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
		ОтборЭлемента.ПравоеЗначение = Новый ПолеКомпоновкиДанных(СтруктураПараметров.ВалютаВзаиморасчетов);
		
		Элемент.Оформление.УстановитьЗначениеПараметра("Видимость", Ложь);
		
	КонецЦикла;
КонецПроцедуры

#КонецОбласти

#Область Проведение

#Область РасчетыСКлиентами

Функция ОтразитьПереносРасчетовСКлиентом(Запрос, Операция)
	
	Если НЕ Запрос.Параметры.Свойство("ОбъектРасчетовАванс") Тогда
		ОбъектРасчетовАванс = Метаданные.ОпределяемыеТипы.ОбъектРасчетовАванс.Тип.Типы();
		Запрос.УстановитьПараметр("ОбъектРасчетовАванс", ОбъектРасчетовАванс);
	КонецЕсли;
	
	Если Операция = "Продажа" Тогда
		
		КредиторскаяЗадолженность = "ИСТИНА"; // что в источнике
		СторноИсточник = "ЛОЖЬ";
		СторноПриемник = "ЛОЖЬ";
		
		ЗаполнятьПриемникВИсточнике = "ИСТИНА";
		
		УсловиеОперации = "
		|	ТаблицаРасшифровкаПлатежа.ОбъектРасчетовИсточник <> ТаблицаРасшифровкаПлатежа.ОбъектРасчетовПриемник";
		
		ХозяйственнаяОперация = "ТаблицаРасшифровкаПлатежа.ХозяйственнаяОперация";
		
		ФормаОплаты = "Неопределено";
		
		ОбъектРасчетовИсточникОрганизация = "ОбъектыРасчетовИсточники.Организация";
		ОбъектРасчетовПриемникОрганизация = "ОбъектыРасчетовПриемники.Организация";
	
		ОбъектРасчетовИсточникПартнер = "ОбъектыРасчетовИсточники.Партнер";
		ОбъектРасчетовПриемникПартнер = "ОбъектыРасчетовПриемники.Партнер";
		
		ВалютаВзаиморасчетовИсточник = "ТаблицаРасшифровкаПлатежа.ВалютаВзаиморасчетов";
		ВалютаВзаиморасчетовПриемник = "ТаблицаРасшифровкаПлатежа.ВалютаВзаиморасчетов";
		
		СуммаВзаиморасчетовИсточник = "ТаблицаРасшифровкаПлатежа.СуммаВзаиморасчетов";
		СуммаВзаиморасчетовПриемник = "ТаблицаРасшифровкаПлатежа.СуммаВзаиморасчетов";
		
		КОплатеИсточник = "ТаблицаРасшифровкаПлатежа.СуммаВзаиморасчетов";
		КОплатеПриемник = "ТаблицаРасшифровкаПлатежа.СуммаВзаиморасчетов";
		
		ОплачиваетсяИсточник = "0";
		ОплачиваетсяПриемник = "0";
		
		ДатаПлатежа = "ТаблицаРасшифровкаПлатежа.ДатаРегистратора";
		ВариантОплаты = "ЗНАЧЕНИЕ(Перечисление.ВариантыКонтроляОплатыКлиентом.ПредоплатаДоОтгрузки)";
		СтатьяДвиженияДенежныхСредств = "Неопределено";
	
		ИдентификаторФинЗаписи = "ТаблицаРасшифровкаПлатежа.ОбъектРасчетовИсточник.УникальныйИдентификатор";
		НастройкаХозяйственнойОперации = "ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПереносАванса)"; 
	
		ВидИсточник = "2";
		ВидПриемник = "2";
		
		ИсключатьПриКонтроле = "ЛОЖЬ";
		
	ИначеЕсли Операция = "ПереносПлатежа" Тогда
		
		КредиторскаяЗадолженность = "ИСТИНА"; // что в источнике
		СторноИсточник = "ЛОЖЬ";
		СторноПриемник = "ЛОЖЬ";
		
		ЗаполнятьПриемникВИсточнике = "ИСТИНА";
		
		УсловиеОперации = "ТаблицаРасшифровкаПлатежа.Организация <> ОбъектыРасчетовПриемники.Организация";
		
		ХозяйственнаяОперация = "ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносПлатежаМеждуФилиалами)";
		
		ФормаОплаты = "Неопределено";
		
		ОбъектРасчетовИсточникОрганизация = "ТаблицаРасшифровкаПлатежа.Организация";
		ОбъектРасчетовПриемникОрганизация = "ОбъектыРасчетовПриемники.Организация";
		
		ОбъектРасчетовИсточникПартнер = "ТаблицаРасшифровкаПлатежа.Партнер";
		ОбъектРасчетовПриемникПартнер = "ТаблицаРасшифровкаПлатежа.Партнер";
		
		ВалютаВзаиморасчетовИсточник = "ТаблицаРасшифровкаПлатежа.ВалютаВзаиморасчетов";
		ВалютаВзаиморасчетовПриемник = "ТаблицаРасшифровкаПлатежа.ВалютаВзаиморасчетов";
		
		СуммаВзаиморасчетовИсточник = "ТаблицаРасшифровкаПлатежа.СуммаВзаиморасчетов";
		СуммаВзаиморасчетовПриемник = "ТаблицаРасшифровкаПлатежа.СуммаВзаиморасчетов";
		
		КОплатеИсточник = "ТаблицаРасшифровкаПлатежа.СуммаВзаиморасчетов";
		КОплатеПриемник = "ТаблицаРасшифровкаПлатежа.СуммаВзаиморасчетов";
		
		ОплачиваетсяИсточник = "0";
		ОплачиваетсяПриемник = "0";
		
		ДатаПлатежа = "ТаблицаРасшифровкаПлатежа.ДатаРегистратора";
		ВариантОплаты = "ЗНАЧЕНИЕ(Перечисление.ВариантыКонтроляОплатыКлиентом.КредитПослеОтгрузки)";
		СтатьяДвиженияДенежныхСредств = "ТаблицаРасшифровкаПлатежа.СтатьяДвиженияДенежныхСредств";
	
		ИдентификаторФинЗаписи = "ТаблицаРасшифровкаПлатежа.ОбъектРасчетовИсточник.УникальныйИдентификатор";
		НастройкаХозяйственнойОперации = "ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПереносПлатежаМеждуФилиалами)";
		
		ВидИсточник = "4";
		ВидПриемник = "4";
		
		ИсключатьПриКонтроле = "ЛОЖЬ";
		
	ИначеЕсли Операция = "ПереносВозврата" Тогда
		
		КредиторскаяЗадолженность = "ИСТИНА"; // что в источнике
		СторноИсточник = "ЛОЖЬ";
		СторноПриемник = "ЛОЖЬ";
		ЗаполнятьПриемникВИсточнике = "ЛОЖЬ";
		
		УсловиеОперации = "ЕСТЬNULL(ДанныеДоговора.ЦентрализованныйДоговор, ЛОЖЬ)
		|	И ТаблицаРасшифровкаПлатежа.Организация <> ОбъектыРасчетовПриемники.Организация";
		
		ХозяйственнаяОперация = "ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносЗадолженностиМеждуФилиалами)";
		
		ФормаОплаты = "Неопределено";
		
		ОбъектРасчетовИсточникОрганизация = "ТаблицаРасшифровкаПлатежа.Организация";
		ОбъектРасчетовПриемникОрганизация = "ОбъектыРасчетовПриемники.Организация";
		
		ОбъектРасчетовИсточникПартнер = "ТаблицаРасшифровкаПлатежа.Партнер";
		ОбъектРасчетовПриемникПартнер = "ТаблицаРасшифровкаПлатежа.Партнер";
		
		ВалютаВзаиморасчетовИсточник = "ТаблицаРасшифровкаПлатежа.ВалютаВзаиморасчетов";
		ВалютаВзаиморасчетовПриемник = "ТаблицаРасшифровкаПлатежа.ВалютаВзаиморасчетов";
		
		СуммаВзаиморасчетовИсточник = "ТаблицаРасшифровкаПлатежа.СуммаВзаиморасчетов";
		СуммаВзаиморасчетовПриемник = "ТаблицаРасшифровкаПлатежа.СуммаВзаиморасчетов";
		
		КОплатеИсточник = "ТаблицаРасшифровкаПлатежа.СуммаВзаиморасчетов";
		КОплатеПриемник = "ТаблицаРасшифровкаПлатежа.СуммаВзаиморасчетов";
		
		ОплачиваетсяИсточник = "0";
		ОплачиваетсяПриемник = "0";
		
		ДатаПлатежа = "ТаблицаРасшифровкаПлатежа.ДатаРегистратора";
		ВариантОплаты = "ЗНАЧЕНИЕ(Перечисление.ВариантыКонтроляОплатыКлиентом.КредитПослеОтгрузки)";
		СтатьяДвиженияДенежныхСредств = "ТаблицаРасшифровкаПлатежа.СтатьяДвиженияДенежныхСредств";
	
		ИдентификаторФинЗаписи = "ТаблицаРасшифровкаПлатежа.ОбъектРасчетовИсточник.УникальныйИдентификатор";
		НастройкаХозяйственнойОперации = "ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПереносЗадолженностиМеждуФилиалами)";
		
		ВидИсточник = "2";
		ВидПриемник = "2";
		
		ИсключатьПриКонтроле = "ИСТИНА";
		
	ИначеЕсли Операция = "ВозвратОплатыКлиенту" Тогда
		
		КредиторскаяЗадолженность = "ИСТИНА";
		СторноИсточник = "ИСТИНА";
		СторноПриемник = "ЛОЖЬ";
		ЗаполнятьПриемникВИсточнике = "ИСТИНА";
		
		УсловиеОперации = "ТаблицаРасшифровкаПлатежа.ОбъектРасчетовИсточник <> ТаблицаРасшифровкаПлатежа.ОбъектРасчетовПриемник";
		
		ХозяйственнаяОперация = "ТаблицаРасшифровкаПлатежа.ХозяйственнаяОперация";
	
		ФормаОплаты = "ТаблицаРасшифровкаПлатежа.ФормаОплаты";
		
		ОбъектРасчетовИсточникОрганизация = "ОбъектыРасчетовИсточники.Организация";
		ОбъектРасчетовПриемникОрганизация = "ОбъектыРасчетовПриемники.Организация";
	
		//Возврат оплаты дочернему партнеру, должен пройти по дочернему партнеру, а не по головному
		ОбъектРасчетовИсточникПартнер = "ТаблицаРасшифровкаПлатежа.Партнер";
		ОбъектРасчетовПриемникПартнер = "ТаблицаРасшифровкаПлатежа.Партнер";
		
		ВалютаВзаиморасчетовИсточник = "ТаблицаРасшифровкаПлатежа.ВалютаВзаиморасчетов";
		ВалютаВзаиморасчетовПриемник = "ТаблицаРасшифровкаПлатежа.ВалютаВзаиморасчетов";
		
		СуммаВзаиморасчетовИсточник = "ТаблицаРасшифровкаПлатежа.СуммаВзаиморасчетов";
		СуммаВзаиморасчетовПриемник = "ТаблицаРасшифровкаПлатежа.СуммаВзаиморасчетов";
		
		КОплатеИсточник = "ТаблицаРасшифровкаПлатежа.СуммаВзаиморасчетов";
		КОплатеПриемник = "ТаблицаРасшифровкаПлатежа.СуммаВзаиморасчетов";
		
		ОплачиваетсяИсточник = "ВЫБОР КОГДА ТаблицаРасшифровкаПлатежа.ОбъектРасчетовИсточник.Объект <> ТаблицаРасшифровкаПлатежа.Ссылка
								|			ТОГДА ТаблицаРасшифровкаПлатежа.СуммаВзаиморасчетов
								|		ИНАЧЕ 0
								|	КОНЕЦ";
		ОплачиваетсяПриемник = "ВЫБОР КОГДА ТаблицаРасшифровкаПлатежа.ОбъектРасчетовПриемник.Объект <> ТаблицаРасшифровкаПлатежа.Ссылка
								|			ТОГДА ТаблицаРасшифровкаПлатежа.СуммаВзаиморасчетов
								|		ИНАЧЕ 0
								|	КОНЕЦ";
		
		ДатаПлатежа = "ТаблицаРасшифровкаПлатежа.ДатаРегистратора";
		ВариантОплаты = "Неопределено";
		СтатьяДвиженияДенежныхСредств = "ТаблицаРасшифровкаПлатежа.СтатьяДвиженияДенежныхСредств";
		
		//Для переноса нужно писать идентификаторы источники из объектов расчетов в расшифровке платежа.
		ИдентификаторФинЗаписи = "ТаблицаРасшифровкаПлатежа.ОбъектРасчетовИсточник.УникальныйИдентификатор";
		НастройкаХозяйственнойОперации = "ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПереносАванса)";
		
		ВидИсточник = "7";
		ВидПриемник = "6";
		
		ИсключатьПриКонтроле = "ИСТИНА";
		
	ИначеЕсли Операция = "ВозвратТоваров" Тогда
		
		КредиторскаяЗадолженность = "ИСТИНА";
		СторноИсточник = "ЛОЖЬ";
		СторноПриемник = "ЛОЖЬ";
		ЗаполнятьПриемникВИсточнике = "ЛОЖЬ";
		
		УсловиеОперации = "ТаблицаРасшифровкаПлатежа.ОбъектРасчетовИсточник <> ТаблицаРасшифровкаПлатежа.ОбъектРасчетовПриемник";
		
		ХозяйственнаяОперация = "ТаблицаРасшифровкаПлатежа.ХозяйственнаяОперация";
		
		ФормаОплаты = "Неопределено";
		
		ОбъектРасчетовИсточникОрганизация = "ОбъектыРасчетовИсточники.Организация";
		ОбъектРасчетовПриемникОрганизация = "ОбъектыРасчетовПриемники.Организация";
	
		ОбъектРасчетовИсточникПартнер = "ОбъектыРасчетовИсточники.Партнер";
		ОбъектРасчетовПриемникПартнер = "ОбъектыРасчетовПриемники.Партнер";
		
		ВалютаВзаиморасчетовИсточник = "ТаблицаРасшифровкаПлатежа.ВалютаДокумента";
		ВалютаВзаиморасчетовПриемник = "ТаблицаРасшифровкаПлатежа.ВалютаВзаиморасчетов";
		
		СуммаВзаиморасчетовИсточник = "ТаблицаРасшифровкаПлатежа.Сумма";
		СуммаВзаиморасчетовПриемник = "ТаблицаРасшифровкаПлатежа.СуммаВзаиморасчетов";
		
		КОплатеИсточник = "ТаблицаРасшифровкаПлатежа.Сумма";
		КОплатеПриемник = "ТаблицаРасшифровкаПлатежа.СуммаВзаиморасчетов";
		
		ОплачиваетсяИсточник = "0";
		ОплачиваетсяПриемник = "0";
		
		ДатаПлатежа = "Неопределено";
		ВариантОплаты = "Неопределено";
		СтатьяДвиженияДенежныхСредств = "Неопределено";
		
		ИдентификаторФинЗаписи = "ТаблицаРасшифровкаПлатежа.ОбъектРасчетовПриемник.УникальныйИдентификатор";
		НастройкаХозяйственнойОперации = "ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВзаимозачетЗадолженности)";
		
		ВидИсточник = "5";
		ВидПриемник = "6";
		
		ИсключатьПриКонтроле = "ИСТИНА";
	КонецЕсли;
	
	#Область ТекстЗапроса
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ТаблицаРасшифровкаПлатежа.ДатаРегистратора              КАК Период,
		|	ВЫБОР
		|		КОГДА НЕ &СторноИсточник И &КредиторскаяЗадолженность
		|			ИЛИ &СторноИсточник И НЕ &КредиторскаяЗадолженность
		|			ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ                                                   КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(АналитикаИсточник.КлючАналитики, Неопределено) КАК АналитикаУчетаПоПартнерам,
		|	ТаблицаРасшифровкаПлатежа.ОбъектРасчетовИсточник        КАК ОбъектРасчетов,
		|	&ВалютаВзаиморасчетовИсточник                           КАК Валюта,
		|	
		|	(&СуммаВзаиморасчетовИсточник *
		|		ВЫБОР КОГДА &СторноИсточник ТОГДА -1 ИНАЧЕ 1 КОНЕЦ) КАК Сумма,
		|	(&КОплатеИсточник *
		|		ВЫБОР КОГДА &СторноИсточник ТОГДА -1 ИНАЧЕ 1 КОНЕЦ) КАК КОплате,
		|	(&ОплачиваетсяИсточник *
		|		ВЫБОР КОГДА &СторноИсточник ТОГДА -1 ИНАЧЕ 1 КОНЕЦ) КАК Оплачивается,
		|	0                                                       КАК КОтгрузке,
		|	0                                                       КАК Отгружается,
		|	
		|	&ХозяйственнаяОперация                                  КАК ХозяйственнаяОперация,
		|	&ФормаОплаты                                            КАК ФормаОплаты,
		|	Неопределено                                            КАК СчетНаОплату,
		|	Неопределено                                            КАК ПродажаПоЗаказу,
		|	ТаблицаРасшифровкаПлатежа.ДатаРегистратора              КАК ДатаРегистратора,
		|	&ДатаПлатежа                                            КАК ДатаПлатежа,
		|	
		|	(ВЫБОР КОГДА &ВалютаВзаиморасчетовИсточник = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА &СуммаВзаиморасчетовИсточник
		|			КОГДА ТаблицаРасшифровкаПлатежа.ВалютаДокумента = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА ТаблицаРасшифровкаПлатежа.Сумма
		|			ИНАЧЕ ВЫРАЗИТЬ(ТаблицаРасшифровкаПлатежа.Сумма * Коэффициенты.КоэффициентРегл КАК ЧИСЛО(31,2))
		|	КОНЕЦ *
		|		ВЫБОР КОГДА &СторноИсточник ТОГДА -1 ИНАЧЕ 1 КОНЕЦ) КАК СуммаРегл,
		|	(ВЫБОР КОГДА &ВалютаВзаиморасчетовИсточник = &ВалютаУправленческогоУчета
		|				ТОГДА &СуммаВзаиморасчетовИсточник
		|			КОГДА ТаблицаРасшифровкаПлатежа.ВалютаДокумента = &ВалютаУправленческогоУчета
		|				ТОГДА ТаблицаРасшифровкаПлатежа.Сумма
		|			ИНАЧЕ ВЫРАЗИТЬ(ТаблицаРасшифровкаПлатежа.Сумма * Коэффициенты.КоэффициентУпр КАК ЧИСЛО(31,2))
		|	КОНЕЦ *
		|		ВЫБОР КОГДА &СторноИсточник ТОГДА -1 ИНАЧЕ 1 КОНЕЦ) КАК СуммаУпр,
		|
		|	&ИсключатьПриКонтроле                                    КАК ИсключатьПриКонтроле,
		|	ЕСТЬNULL(ДанныеДоговора.ДопустимаяСуммаЗадолженности, 0) КАК ДопустимаяСуммаЗадолженности,
		|	0                                                       КАК ЗалогЗаТару,
		|	&СтатьяДвиженияДенежныхСредств                          КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                            КАК РасчетныйДокумент,
		|	Неопределено                                            КАК СвязанныйДокумент,
		|	&ВариантОплаты                                          КАК ВариантОплаты,
		|	ТаблицаРасшифровкаПлатежа.ВалютаДокумента               КАК ВалютаДокумента,
		|	Неопределено                                            КАК КорОбъектРасчетов,
		|	Неопределено                                            КАК КорАналитикаУчетаПоПартнерам,
		|	
		|	&ОбъектРасчетовИсточникОрганизация                      КАК Организация,
		|	&ОбъектРасчетовИсточникПартнер                          КАК Партнер,
		|	ОбъектыРасчетовИсточники.Контрагент                     КАК Контрагент,
		|	ОбъектыРасчетовИсточники.Договор                        КАК Договор,
		|	НаправленияДеятельностиИсточник.НаправлениеАналитики    КАК НаправлениеДеятельности,
		|
		|	Неопределено                                            КАК КорПартнер,
		|	Неопределено                                            КАК КорОрганизация,
		|	Неопределено                                            КАК КорКонтрагент,
		|	Неопределено                                            КАК КорДоговор,
		|	Неопределено                                            КАК КорНаправлениеДеятельности,
		|	ТаблицаРасшифровкаПлатежа.НомерРегистратора             КАК НомерРегистратора,
		|	&ИдентификаторФинЗаписи                                 КАК ИдентификаторФинЗаписи,
		|	Неопределено                                            КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	&ВидИсточник                                            КАК Вид,
		|	&НастройкаХозяйственнойОперации                         КАК НастройкаХозяйственнойОперации,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА ЕСТЬNULL(АналитикаПриемник.КлючАналитики, Неопределено)
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                   КАК АналитикаУчетаПоПартнерамПриемник,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА ОбъектыРасчетовПриемники.Ссылка
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                   КАК ОбъектРасчетовПриемник,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА &ВалютаВзаиморасчетовПриемник
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                   КАК ВалютаПриемник,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА &ОбъектРасчетовПриемникПартнер
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                   КАК ПартнерПриемник,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА &ОбъектРасчетовПриемникОрганизация
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                   КАК ОрганизацияПриемник,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА ОбъектыРасчетовПриемники.Контрагент
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                   КАК КонтрагентПриемник,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА ОбъектыРасчетовПриемники.Договор
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                   КАК ДоговорПриемник,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА НаправленияДеятельностиПриемник.НаправлениеАналитики
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                   КАК НаправлениеДеятельностиПриемник,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА &СуммаВзаиморасчетовПриемник
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                   КАК СуммаПриемник,
		|	ЛОЖЬ                                                    КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#ТаблицаРасшифровкаПлатежа КАК ТаблицаРасшифровкаПлатежа
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетовИсточники
		|			ПО ТаблицаРасшифровкаПлатежа.ОбъектРасчетовИсточник = ОбъектыРасчетовИсточники.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка = ОбъектыРасчетовИсточники.Договор
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетовПриемники
		|			ПО ТаблицаРасшифровкаПлатежа.ОбъектРасчетовПриемник = ОбъектыРасчетовПриемники.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговораПриемник
		|			ПО ДанныеДоговораПриемник.Ссылка = ОбъектыРасчетовПриемники.Договор
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельностиИсточник
		|			ПО ОбъектыРасчетовИсточники.Ссылка = НаправленияДеятельностиИсточник.ОбъектРасчетов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельностиПриемник
		|			ПО ОбъектыРасчетовПриемники.Ссылка = НаправленияДеятельностиПриемник.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаИсточник
		|			ПО &ОбъектРасчетовИсточникОрганизация = АналитикаИсточник.Организация
		|				И ОбъектыРасчетовИсточники.Контрагент = АналитикаИсточник.Контрагент
		|				И &ОбъектРасчетовИсточникПартнер = АналитикаИсточник.Партнер
		|				И ОбъектыРасчетовИсточники.Договор = АналитикаИсточник.Договор
		|				И НаправленияДеятельностиИсточник.НаправлениеАналитики = АналитикаИсточник.НаправлениеДеятельности
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаПриемник
		|			ПО &ОбъектРасчетовПриемникОрганизация = АналитикаПриемник.Организация
		|				И ОбъектыРасчетовПриемники.Контрагент = АналитикаПриемник.Контрагент
		|				И &ОбъектРасчетовПриемникПартнер = АналитикаПриемник.Партнер
		|				И ОбъектыРасчетовПриемники.Договор = АналитикаПриемник.Договор
		|				И НаправленияДеятельностиПриемник.НаправлениеАналитики = АналитикаПриемник.НаправлениеДеятельности
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаиморасчетыВтКоэффициентыПересчетаВалют КАК Коэффициенты
		|			ПО Коэффициенты.Ссылка = ТаблицаРасшифровкаПлатежа.Ссылка
		|				И Коэффициенты.ОбъектРасчетов = ТаблицаРасшифровкаПлатежа.ОбъектРасчетовИсточник
		|				И Коэффициенты.ВалютаВзаиморасчетов = &ВалютаВзаиморасчетовИсточник
		|				И Коэффициенты.ДатаКурса = ТаблицаРасшифровкаПлатежа.ДатаКурса
		|ГДЕ
		|	&СуммаВзаиморасчетовИсточник > 0
		|	И &УсловиеОперации
		|
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ТаблицаРасшифровкаПлатежа.ДатаРегистратора              КАК Период,
		|	ВЫБОР
		|		КОГДА НЕ &СторноПриемник И &КредиторскаяЗадолженность
		|			ИЛИ &СторноПриемник И НЕ &КредиторскаяЗадолженность
		|			ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	КОНЕЦ                                                   КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(АналитикаПриемник.КлючАналитики, Неопределено) КАК АналитикаУчетаПоПартнерам,
		|	ТаблицаРасшифровкаПлатежа.ОбъектРасчетовПриемник        КАК ОбъектРасчетов,
		|	&ВалютаВзаиморасчетовПриемник                           КАК Валюта,
		|	
		|	(&СуммаВзаиморасчетовПриемник *
		|		ВЫБОР КОГДА &СторноПриемник ТОГДА -1 ИНАЧЕ 1 КОНЕЦ) КАК Сумма,
		|	(&КОплатеПриемник *
		|		ВЫБОР КОГДА &СторноПриемник ТОГДА -1 ИНАЧЕ 1 КОНЕЦ) КАК КОплате,
		|	(&ОплачиваетсяПриемник *
		|		ВЫБОР КОГДА &СторноПриемник ТОГДА -1 ИНАЧЕ 1 КОНЕЦ) КАК Оплачивается,
		|	0                                                       КАК КОтгрузке,
		|	0                                                       КАК Отгружается,
		|	
		|	&ХозяйственнаяОперация                                  КАК ХозяйственнаяОперация,
		|	&ФормаОплаты                                            КАК ФормаОплаты,
		|	Неопределено                                            КАК СчетНаОплату,
		|	Неопределено                                            КАК ПродажаПоЗаказу,
		|	ТаблицаРасшифровкаПлатежа.ДатаРегистратора              КАК ДатаРегистратора,
		|	&ДатаПлатежа                                            КАК ДатаПлатежа,
		|	
		|	(ВЫБОР КОГДА &ВалютаВзаиморасчетовПриемник = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА &СуммаВзаиморасчетовПриемник
		|			КОГДА ТаблицаРасшифровкаПлатежа.ВалютаДокумента = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА ТаблицаРасшифровкаПлатежа.Сумма
		|			ИНАЧЕ ВЫРАЗИТЬ(ТаблицаРасшифровкаПлатежа.Сумма * Коэффициенты.КоэффициентРегл КАК ЧИСЛО(31,2))
		|	КОНЕЦ*
		|		ВЫБОР КОГДА &СторноПриемник ТОГДА -1 ИНАЧЕ 1 КОНЕЦ) КАК СуммаРегл,
		|	(ВЫБОР КОГДА &ВалютаВзаиморасчетовПриемник = &ВалютаУправленческогоУчета
		|				ТОГДА &СуммаВзаиморасчетовПриемник
		|			КОГДА ТаблицаРасшифровкаПлатежа.ВалютаДокумента = &ВалютаУправленческогоУчета
		|				ТОГДА ТаблицаРасшифровкаПлатежа.Сумма
		|			ИНАЧЕ ВЫРАЗИТЬ(ТаблицаРасшифровкаПлатежа.Сумма * Коэффициенты.КоэффициентУпр КАК ЧИСЛО(31,2))
		|	КОНЕЦ*
		|		ВЫБОР КОГДА &СторноПриемник ТОГДА -1 ИНАЧЕ 1 КОНЕЦ) КАК СуммаУпр,
		|
		|	&ИсключатьПриКонтроле                                    КАК ИсключатьПриКонтроле,
		|	ЕСТЬNULL(ДанныеДоговора.ДопустимаяСуммаЗадолженности, 0) КАК ДопустимаяСуммаЗадолженности,
		|	0                                                       КАК ЗалогЗаТару,
		|	&СтатьяДвиженияДенежныхСредств                          КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                            КАК РасчетныйДокумент,
		|	Неопределено                                            КАК СвязанныйДокумент,
		|	&ВариантОплаты                                          КАК ВариантОплаты,
		|	ТаблицаРасшифровкаПлатежа.ВалютаДокумента               КАК ВалютаДокумента,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА ОбъектыРасчетовИсточники.Ссылка
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                   КАК КорОбъектРасчетов,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА ЕСТЬNULL(АналитикаИсточник.КлючАналитики, Неопределено)
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                   КАК КорАналитикаУчетаПоПартнерам,
		|	
		|	&ОбъектРасчетовПриемникОрганизация                      КАК Организация,
		|	&ОбъектРасчетовПриемникПартнер                          КАК Партнер,
		|	ОбъектыРасчетовПриемники.Контрагент                     КАК Контрагент,
		|	ОбъектыРасчетовПриемники.Договор                        КАК Договор,
		|	НаправленияДеятельностиПриемник.НаправлениеАналитики    КАК НаправлениеДеятельности,
		|
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА &ОбъектРасчетовИсточникПартнер
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                   КАК КорПартнер,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА &ОбъектРасчетовИсточникОрганизация
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                   КАК КорОрганизация,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА ОбъектыРасчетовИсточники.Контрагент
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                   КАК КорКонтрагент,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА ОбъектыРасчетовИсточники.Договор
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                   КАК КорДоговор,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА НаправленияДеятельностиИсточник.НаправлениеАналитики
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                   КАК КорНаправлениеДеятельности,
		|
		|	ТаблицаРасшифровкаПлатежа.НомерРегистратора             КАК НомерРегистратора,
		|	&ИдентификаторФинЗаписи                                 КАК ИдентификаторФинЗаписи,
		|	Неопределено                                            КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	&ВидПриемник                                            КАК Вид,
		|	&НастройкаХозяйственнойОперации                         КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                            КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                            КАК ОбъектРасчетовПриемник,
		|	Неопределено                                            КАК ВалютаПриемник,
		|	Неопределено                                            КАК ПартнерПриемник,
		|	Неопределено                                            КАК ОрганизацияПриемник,
		|	Неопределено                                            КАК КонтрагентПриемник,
		|	Неопределено                                            КАК ДоговорПриемник,
		|	Неопределено                                            КАК НаправлениеДеятельностиПриемник,
		|	0                                                       КАК СуммаПриемник,
		|	&ЗаполнятьПриемникВИсточнике                            КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#ТаблицаРасшифровкаПлатежа КАК ТаблицаРасшифровкаПлатежа
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетовИсточники
		|			ПО ТаблицаРасшифровкаПлатежа.ОбъектРасчетовИсточник = ОбъектыРасчетовИсточники.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговораИсточник
		|			ПО ДанныеДоговораИсточник.Ссылка = ОбъектыРасчетовИсточники.Договор
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетовПриемники
		|			ПО ТаблицаРасшифровкаПлатежа.ОбъектРасчетовПриемник = ОбъектыРасчетовПриемники.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка = ОбъектыРасчетовПриемники.Договор
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельностиИсточник
		|			ПО ОбъектыРасчетовИсточники.Ссылка = НаправленияДеятельностиИсточник.ОбъектРасчетов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельностиПриемник
		|			ПО ОбъектыРасчетовПриемники.Ссылка = НаправленияДеятельностиПриемник.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаПриемник
		|			ПО &ОбъектРасчетовПриемникОрганизация = АналитикаПриемник.Организация
		|				И ОбъектыРасчетовПриемники.Контрагент = АналитикаПриемник.Контрагент
		|				И &ОбъектРасчетовПриемникПартнер = АналитикаПриемник.Партнер
		|				И ОбъектыРасчетовПриемники.Договор = АналитикаПриемник.Договор
		|				И НаправленияДеятельностиПриемник.НаправлениеАналитики = АналитикаПриемник.НаправлениеДеятельности
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаИсточник
		|			ПО &ОбъектРасчетовИсточникОрганизация = АналитикаИсточник.Организация
		|				И ОбъектыРасчетовИсточники.Контрагент = АналитикаИсточник.Контрагент
		|				И &ОбъектРасчетовИсточникПартнер = АналитикаИсточник.Партнер
		|				И ОбъектыРасчетовИсточники.Договор = АналитикаИсточник.Договор
		|				И НаправленияДеятельностиИсточник.НаправлениеАналитики = АналитикаИсточник.НаправлениеДеятельности
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаиморасчетыВтКоэффициентыПересчетаВалют КАК Коэффициенты
		|			ПО Коэффициенты.Ссылка = ТаблицаРасшифровкаПлатежа.Ссылка
		|				И Коэффициенты.ОбъектРасчетов = ТаблицаРасшифровкаПлатежа.ОбъектРасчетовПриемник
		|				И Коэффициенты.ВалютаВзаиморасчетов = &ВалютаВзаиморасчетовПриемник
		|				И Коэффициенты.ДатаКурса = ТаблицаРасшифровкаПлатежа.ДатаКурса
		|ГДЕ
		|	&СуммаВзаиморасчетовПриемник > 0
		|	И &УсловиеОперации
		|";
	#КонецОбласти
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&УсловиеОперации",УсловиеОперации);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&КредиторскаяЗадолженность", КредиторскаяЗадолженность);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СторноИсточник",            СторноИсточник);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СторноПриемник",СторноПриемник);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&КОплатеИсточник",КОплатеИсточник);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ОплачиваетсяИсточник",ОплачиваетсяИсточник);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ХозяйственнаяОперация", ХозяйственнаяОперация);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ФормаОплаты",ФормаОплаты);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&КОплатеПриемник",КОплатеПриемник);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ОплачиваетсяПриемник",ОплачиваетсяПриемник);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ОбъектРасчетовИсточникОрганизация", ОбъектРасчетовИсточникОрганизация);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ОбъектРасчетовПриемникОрганизация", ОбъектРасчетовПриемникОрганизация);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ОбъектРасчетовИсточникПартнер", ОбъектРасчетовИсточникПартнер);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ОбъектРасчетовПриемникПартнер", ОбъектРасчетовПриемникПартнер);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ВалютаВзаиморасчетовИсточник",ВалютаВзаиморасчетовИсточник);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ВалютаВзаиморасчетовПриемник",ВалютаВзаиморасчетовПриемник);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СуммаВзаиморасчетовИсточник",СуммаВзаиморасчетовИсточник);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СуммаВзаиморасчетовПриемник",СуммаВзаиморасчетовПриемник);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ДатаПлатежа", ДатаПлатежа);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ВариантОплаты", ВариантОплаты);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СтатьяДвиженияДенежныхСредств", СтатьяДвиженияДенежныхСредств);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЗаполнятьПриемникВИсточнике", ЗаполнятьПриемникВИсточнике);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ИдентификаторФинЗаписи",          ИдентификаторФинЗаписи);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&НастройкаХозяйственнойОперации",  НастройкаХозяйственнойОперации);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ВидИсточник", ВидИсточник);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ВидПриемник", ВидПриемник);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ИсключатьПриКонтроле", ИсключатьПриКонтроле);
	
	Если Операция = "ПереносПродажи" ИЛИ Операция = "ПереносПлатежа" ИЛИ Операция = "ПереносВозврата" Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"#ТаблицаРасшифровкаПлатежа",  "втПереносРасчетовКлиент");
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"ТаблицаРасшифровкаПлатежа",  "ПереносРасчетов");
	КонецЕсли;
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстПереносЗадолженностиКлиентаМеждуФилиалами()
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	УвеличениеЗадолженностиКлиента.ДатаРегистратора         КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                  КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(АналитикаИсточник.КлючАналитики, Неопределено) КАК АналитикаУчетаПоПартнерам,
		|	УвеличениеЗадолженностиКлиента.ОбъектРасчетов           КАК ОбъектРасчетов,
		|	УвеличениеЗадолженностиКлиента.ВалютаВзаиморасчетов     КАК Валюта,
		|	
		|	УвеличениеЗадолженностиКлиента.СуммаВзаиморасчетов      КАК Сумма,
		|	0                                                       КАК КОплате,
		|	0                                                       КАК Оплачивается,
		|	0                                                       КАК КОтгрузке,
		|	0                                                       КАК Отгружается,
		|	
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносЗадолженностиМеждуФилиалами) КАК ХозяйственнаяОперация,
		|	Неопределено                                            КАК ФормаОплаты,
		|	Неопределено                                            КАК СчетНаОплату,
		|	УвеличениеЗадолженностиКлиента.ЗаказПродажи             КАК ПродажаПоЗаказу,
		|	УвеличениеЗадолженностиКлиента.ДатаРегистратора         КАК ДатаРегистратора,
		|	УвеличениеЗадолженностиКлиента.ДатаПлатежа              КАК ДатаПлатежа,
		|	
		|	ВЫБОР КОГДА УвеличениеЗадолженностиКлиента.ВалютаВзаиморасчетов = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА УвеличениеЗадолженностиКлиента.СуммаВзаиморасчетов
		|			КОГДА УвеличениеЗадолженностиКлиента.ВалютаДокумента = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА УвеличениеЗадолженностиКлиента.Сумма
		|			ИНАЧЕ ВЫРАЗИТЬ(УвеличениеЗадолженностиКлиента.Сумма * Коэффициенты.КоэффициентРегл КАК ЧИСЛО(31,2))
		|	КОНЕЦ КАК СуммаРегл,
		|	ВЫБОР КОГДА УвеличениеЗадолженностиКлиента.ВалютаВзаиморасчетов = &ВалютаУправленческогоУчета
		|				ТОГДА УвеличениеЗадолженностиКлиента.СуммаВзаиморасчетов
		|			КОГДА УвеличениеЗадолженностиКлиента.ВалютаДокумента = &ВалютаУправленческогоУчета
		|				ТОГДА УвеличениеЗадолженностиКлиента.Сумма
		|			ИНАЧЕ ВЫРАЗИТЬ(УвеличениеЗадолженностиКлиента.Сумма * Коэффициенты.КоэффициентУпр КАК ЧИСЛО(31,2))
		|	КОНЕЦ КАК СуммаУпр,
		|
		|	ЛОЖЬ                                                    КАК ИсключатьПриКонтроле,
		|	ДанныеДоговора.ДопустимаяСуммаЗадолженности             КАК ДопустимаяСуммаЗадолженности,
		|	0                                                       КАК ЗалогЗаТару,
		|	Неопределено                                            КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                            КАК РасчетныйДокумент,
		|	Неопределено                                            КАК СвязанныйДокумент,
		|	УвеличениеЗадолженностиКлиента.ВариантОплаты            КАК ВариантОплаты,
		|	УвеличениеЗадолженностиКлиента.ВалютаДокумента          КАК ВалютаДокумента,
		|	Неопределено                                            КАК КорОбъектРасчетов,
		|	Неопределено                                            КАК КорАналитикаУчетаПоПартнерам,
		|	
		|	УвеличениеЗадолженностиКлиента.Организация              КАК Организация,
		|	УвеличениеЗадолженностиКлиента.Партнер                  КАК Партнер,
		|	ОбъектРасчетовЦД.Контрагент                             КАК Контрагент,
		|	ОбъектРасчетовЦД.Договор                                КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики            КАК НаправлениеДеятельности,
		|
		|	Неопределено                                            КАК КорПартнер,
		|	Неопределено                                            КАК КорОрганизация,
		|	Неопределено                                            КАК КорКонтрагент,
		|	Неопределено                                            КАК КорДоговор,
		|	Неопределено                                            КАК КорНаправлениеДеятельности,
		|	УвеличениеЗадолженностиКлиента.НомерРегистратора        КАК НомерРегистратора,
		|	ОбъектРасчетовЦД.УникальныйИдентификатор                КАК ИдентификаторФинЗаписи,
		|	Неопределено                                            КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	2                                                       КАК Вид,
		|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПереносЗадолженностиМеждуФилиалами) КАК НастройкаХозяйственнойОперации,
		|	ЕСТЬNULL(АналитикаПриемник.КлючАналитики, Неопределено) КАК АналитикаУчетаПоПартнерамПриемник,
		|	ОбъектРасчетовЦД.Ссылка                                 КАК ОбъектРасчетовПриемник,
		|	ОбъектРасчетовЦД.ВалютаВзаиморасчетов                   КАК ВалютаПриемник,
		|	УвеличениеЗадолженностиКлиента.Партнер                  КАК ПартнерПриемник,
		|	ОбъектРасчетовЦД.Организация                            КАК ОрганизацияПриемник,
		|	ОбъектРасчетовЦД.Контрагент                             КАК КонтрагентПриемник,
		|	ОбъектРасчетовЦД.Договор                                КАК ДоговорПриемник,
		|	НаправленияДеятельности.НаправлениеАналитики            КАК НаправлениеДеятельностиПриемник,
		|	УвеличениеЗадолженностиКлиента.СуммаВзаиморасчетов      КАК СуммаПриемник,
		|	ЛОЖЬ                                                    КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#УвеличениеЗадолженностиКлиента КАК УвеличениеЗадолженностиКлиента
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектРасчетовЦД
		|			ПО УвеличениеЗадолженностиКлиента.ОбъектРасчетов = ОбъектРасчетовЦД.Ссылка
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка = ОбъектРасчетовЦД.Договор
		|				И ДанныеДоговора.ЦентрализованныйДоговор
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО ОбъектРасчетовЦД.Ссылка = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаПриемник
		|			ПО ОбъектРасчетовЦД.Организация = АналитикаПриемник.Организация
		|				И ОбъектРасчетовЦД.Контрагент = АналитикаПриемник.Контрагент
		|				И УвеличениеЗадолженностиКлиента.Партнер = АналитикаПриемник.Партнер
		|				И ОбъектРасчетовЦД.Договор = АналитикаПриемник.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = АналитикаПриемник.НаправлениеДеятельности
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаИсточник
		|			ПО УвеличениеЗадолженностиКлиента.Организация = АналитикаИсточник.Организация
		|				И ОбъектРасчетовЦД.Контрагент = АналитикаИсточник.Контрагент
		|				И УвеличениеЗадолженностиКлиента.Партнер = АналитикаИсточник.Партнер
		|				И ОбъектРасчетовЦД.Договор = АналитикаИсточник.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = АналитикаИсточник.НаправлениеДеятельности
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаиморасчетыВтКоэффициентыПересчетаВалют КАК Коэффициенты
		|			ПО Коэффициенты.Ссылка = УвеличениеЗадолженностиКлиента.Ссылка
		|				И Коэффициенты.ОбъектРасчетов = УвеличениеЗадолженностиКлиента.ОбъектРасчетов
		|				И Коэффициенты.ВалютаВзаиморасчетов = УвеличениеЗадолженностиКлиента.ВалютаВзаиморасчетов
		|				И Коэффициенты.ДатаКурса = УвеличениеЗадолженностиКлиента.ДатаКурса
		|ГДЕ
		|	УвеличениеЗадолженностиКлиента.СуммаВзаиморасчетов > 0
		|	И УвеличениеЗадолженностиКлиента.Организация <> ОбъектРасчетовЦД.Организация
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	УвеличениеЗадолженностиКлиента.ДатаРегистратора         КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)                  КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(АналитикаПриемник.КлючАналитики, Неопределено) КАК АналитикаУчетаПоПартнерам,
		|	УвеличениеЗадолженностиКлиента.ОбъектРасчетов           КАК ОбъектРасчетов,
		|	УвеличениеЗадолженностиКлиента.ВалютаВзаиморасчетов     КАК Валюта,
		|	
		|	УвеличениеЗадолженностиКлиента.СуммаВзаиморасчетов      КАК Сумма,
		|	0                                                       КАК КОплате,
		|	0                                                       КАК Оплачивается,
		|	0                                                       КАК КОтгрузке,
		|	0                                                       КАК Отгружается,
		|	
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносЗадолженностиМеждуФилиалами) КАК ХозяйственнаяОперация,
		|	Неопределено                                            КАК ФормаОплаты,
		|	Неопределено                                            КАК СчетНаОплату,
		|	УвеличениеЗадолженностиКлиента.ЗаказПродажи             КАК ПродажаПоЗаказу,
		|	УвеличениеЗадолженностиКлиента.ДатаРегистратора         КАК ДатаРегистратора,
		|	УвеличениеЗадолженностиКлиента.ДатаПлатежа              КАК ДатаПлатежа,
		|	
		|	ВЫБОР КОГДА УвеличениеЗадолженностиКлиента.ВалютаВзаиморасчетов = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА УвеличениеЗадолженностиКлиента.СуммаВзаиморасчетов
		|			КОГДА УвеличениеЗадолженностиКлиента.ВалютаДокумента = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА УвеличениеЗадолженностиКлиента.Сумма
		|			ИНАЧЕ ВЫРАЗИТЬ(УвеличениеЗадолженностиКлиента.Сумма * Коэффициенты.КоэффициентРегл КАК ЧИСЛО(31,2))
		|	КОНЕЦ КАК СуммаРегл,
		|	ВЫБОР КОГДА УвеличениеЗадолженностиКлиента.ВалютаВзаиморасчетов = &ВалютаУправленческогоУчета
		|				ТОГДА УвеличениеЗадолженностиКлиента.СуммаВзаиморасчетов
		|			КОГДА УвеличениеЗадолженностиКлиента.ВалютаДокумента = &ВалютаУправленческогоУчета
		|				ТОГДА УвеличениеЗадолженностиКлиента.Сумма
		|			ИНАЧЕ ВЫРАЗИТЬ(УвеличениеЗадолженностиКлиента.Сумма * Коэффициенты.КоэффициентУпр КАК ЧИСЛО(31,2))
		|	КОНЕЦ КАК СуммаУпр,
		|
		|	ЛОЖЬ                                                    КАК ИсключатьПриКонтроле,
		|	ДанныеДоговора.ДопустимаяСуммаЗадолженности             КАК ДопустимаяСуммаЗадолженности,
		|	0                                                       КАК ЗалогЗаТару,
		|	Неопределено                                            КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                            КАК РасчетныйДокумент,
		|	Неопределено                                            КАК СвязанныйДокумент,
		|	УвеличениеЗадолженностиКлиента.ВариантОплаты            КАК ВариантОплаты,
		|	УвеличениеЗадолженностиКлиента.ВалютаДокумента          КАК ВалютаДокумента,
		|	ОбъектРасчетовЦД.Ссылка                                 КАК КорОбъектРасчетов,
		|	ЕСТЬNULL(АналитикаИсточник.КлючАналитики, Неопределено) КАК КорАналитикаУчетаПоПартнерам,
		|	
		|	ОбъектРасчетовЦД.Организация                            КАК Организация,
		|	УвеличениеЗадолженностиКлиента.Партнер                  КАК Партнер,
		|	ОбъектРасчетовЦД.Контрагент                             КАК Контрагент,
		|	ОбъектРасчетовЦД.Договор                                КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики            КАК НаправлениеДеятельности,
		|
		|	УвеличениеЗадолженностиКлиента.Партнер                  КАК КорПартнер,
		|	УвеличениеЗадолженностиКлиента.Организация              КАК КорОрганизация,
		|	ОбъектРасчетовЦД.Контрагент                             КАК КорКонтрагент,
		|	ОбъектРасчетовЦД.Договор                                КАК КорДоговор,
		|	НаправленияДеятельности.НаправлениеАналитики            КАК КорНаправлениеДеятельности,
		|
		|	УвеличениеЗадолженностиКлиента.НомерРегистратора        КАК НомерРегистратора,
		|	ОбъектРасчетовЦД.УникальныйИдентификатор                КАК ИдентификаторФинЗаписи,
		|	Неопределено                                            КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	2                                                       КАК Вид,
		|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПереносЗадолженностиМеждуФилиалами) КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                            КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                            КАК ОбъектРасчетовПриемник,
		|	Неопределено                                            КАК ВалютаПриемник,
		|	Неопределено                                            КАК ПартнерПриемник,
		|	Неопределено                                            КАК ОрганизацияПриемник,
		|	Неопределено                                            КАК КонтрагентПриемник,
		|	Неопределено                                            КАК ДоговорПриемник,
		|	Неопределено                                            КАК НаправлениеДеятельностиПриемник,
		|	0                                                       КАК СуммаПриемник,
		|	ИСТИНА                                                  КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#УвеличениеЗадолженностиКлиента КАК УвеличениеЗадолженностиКлиента
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектРасчетовЦД
		|			ПО УвеличениеЗадолженностиКлиента.ОбъектРасчетов = ОбъектРасчетовЦД.Ссылка
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка = ОбъектРасчетовЦД.Договор
		|				И ДанныеДоговора.ЦентрализованныйДоговор
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО ОбъектРасчетовЦД.Ссылка = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаПриемник
		|			ПО ОбъектРасчетовЦД.Организация = АналитикаПриемник.Организация
		|				И ОбъектРасчетовЦД.Контрагент = АналитикаПриемник.Контрагент
		|				И УвеличениеЗадолженностиКлиента.Партнер = АналитикаПриемник.Партнер
		|				И ОбъектРасчетовЦД.Договор = АналитикаПриемник.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = АналитикаПриемник.НаправлениеДеятельности
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаИсточник
		|			ПО УвеличениеЗадолженностиКлиента.Организация = АналитикаИсточник.Организация
		|				И ОбъектРасчетовЦД.Контрагент = АналитикаИсточник.Контрагент
		|				И УвеличениеЗадолженностиКлиента.Партнер = АналитикаИсточник.Партнер
		|				И ОбъектРасчетовЦД.Договор = АналитикаИсточник.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = АналитикаИсточник.НаправлениеДеятельности
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаиморасчетыВтКоэффициентыПересчетаВалют КАК Коэффициенты
		|			ПО Коэффициенты.Ссылка = УвеличениеЗадолженностиКлиента.Ссылка
		|				И Коэффициенты.ОбъектРасчетов = УвеличениеЗадолженностиКлиента.ОбъектРасчетов
		|				И Коэффициенты.ВалютаВзаиморасчетов = УвеличениеЗадолженностиКлиента.ВалютаВзаиморасчетов
		|				И Коэффициенты.ДатаКурса = УвеличениеЗадолженностиКлиента.ДатаКурса
		|ГДЕ
		|	УвеличениеЗадолженностиКлиента.СуммаВзаиморасчетов > 0
		|	И УвеличениеЗадолженностиКлиента.Организация <> ОбъектРасчетовЦД.Организация
		|";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция УвеличитьПланОплатыОтКлиента(Запрос, Операция)
	
	Если Операция = "ГрафикИсполненияКлиент" Тогда
		
		ЭтоЗаказ = "ЛОЖЬ";
		ЭтоНакладная = "ЛОЖЬ";
		Период = "КОНЕЦПЕРИОДА(УвеличениеПланаОплатыКлиентом.ДатаПлатежа, ДЕНЬ)";
		
		ПорядокРасчетов = "ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов)";
		НакладнаяПоЗаказам = "ЛОЖЬ";
		СверхЗаказа = "ЛОЖЬ";
		ЗаказПродажи = "Неопределено";
		
		КОплате = "УвеличениеПланаОплатыКлиентом.КОплате";
		
		ФормаОплаты = "Неопределено";
		СтатьяДвиженияДенежныхСредств = "Неопределено";
		ДатаПлатежа = "КОНЕЦПЕРИОДА(УвеличениеПланаОплатыКлиентом.ДатаПлатежа, ДЕНЬ)";
		СуммаОтклоненияМерныхТоваров = "0";
		ВариантОплаты = "УвеличениеПланаОплатыКлиентом.ВариантОплаты";
		ИсключатьПриКонтроле = "УвеличениеПланаОплатыКлиентом.ИсключатьПриКонтроле";
		СвязанныйДокумент = "Неопределено";
		ИдентификаторФинЗаписи = "&ИдентификаторНеиспользуемойФинЗаписи";
		НастройкаХозяйственнойОперации = "Неопределено";
		Вид = "1";
		
	ИначеЕсли Операция = "ЗаказКлиента" Тогда
		
		ЭтоЗаказ = "ИСТИНА";
		ЭтоНакладная = "ЛОЖЬ";
		Период = "КОНЕЦПЕРИОДА(УвеличениеПланаОплатыКлиентом.ДатаПлатежа, ДЕНЬ)";
		
		ПорядокРасчетов = "УвеличениеПланаОплатыКлиентом.ПорядокРасчетов";
		НакладнаяПоЗаказам = "ЛОЖЬ";
		СверхЗаказа = "ЛОЖЬ";
		ЗаказПродажи = "Неопределено";
		
		КОплате = "УвеличениеПланаОплатыКлиентом.КОплате";
		
		ФормаОплаты = "УвеличениеПланаОплатыКлиентом.ФормаОплаты";
		СтатьяДвиженияДенежныхСредств = "Неопределено";
		ДатаПлатежа = "КОНЕЦПЕРИОДА(УвеличениеПланаОплатыКлиентом.ДатаПлатежа, ДЕНЬ)";
		СуммаОтклоненияМерныхТоваров = "УвеличениеПланаОплатыКлиентом.СуммаОтклоненияМерныхТоваров";
		ВариантОплаты = "УвеличениеПланаОплатыКлиентом.ВариантОплаты";
		ИсключатьПриКонтроле = "
		|ВЫБОР 
		|	КОГДА УвеличениеПланаОплатыКлиентом.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
		|		ТОГДА ИСТИНА
		|	ИНАЧЕ УвеличениеПланаОплатыКлиентом.ИсключатьПриКонтроле
		|КОНЕЦ";
		СвязанныйДокумент = "Неопределено";
		ИдентификаторФинЗаписи = "&ИдентификаторНеиспользуемойФинЗаписи";
		НастройкаХозяйственнойОперации = "Неопределено";
		Вид = "1";
		
	ИначеЕсли Операция = "Продажа" Тогда
		
		ЭтоЗаказ = "ЛОЖЬ";
		ЭтоНакладная = "ИСТИНА";
		Период = "ВЫБОР КОГДА УвеличениеПланаОплатыКлиентом.КОплате < 0 ИЛИ УвеличениеПланаОплатыКлиентом.ДатаПлатежа < УвеличениеПланаОплатыКлиентом.ДатаРегистратора
				|		ТОГДА УвеличениеПланаОплатыКлиентом.ДатаРегистратора
				|	ИНАЧЕ КОНЕЦПЕРИОДА(УвеличениеПланаОплатыКлиентом.ДатаПлатежа, ДЕНЬ)
				|КОНЕЦ";
		
		ПорядокРасчетов = "УвеличениеПланаОплатыКлиентом.ПорядокРасчетов";
		НакладнаяПоЗаказам = "УвеличениеПланаОплатыКлиентом.НакладнаяПоЗаказам";
		СверхЗаказа = "УвеличениеПланаОплатыКлиентом.СверхЗаказа";
		ЗаказПродажи = "УвеличениеПланаОплатыКлиентом.ЗаказПродажи";
		
		КОплате = "УвеличениеПланаОплатыКлиентом.КОплате";
		
		ФормаОплаты = "УвеличениеПланаОплатыКлиентом.ФормаОплаты";
		СтатьяДвиженияДенежныхСредств = "Неопределено";
		
		ДатаПлатежа = "ВЫБОР КОГДА УвеличениеПланаОплатыКлиентом.КОплате < 0 
				|		ТОГДА ДАТАВРЕМЯ(1,1,1)
				|	ИНАЧЕ УвеличениеПланаОплатыКлиентом.ДатаПлатежа
				|КОНЕЦ";
		
		СуммаОтклоненияМерныхТоваров = "0";
		ВариантОплаты = "УвеличениеПланаОплатыКлиентом.ВариантОплаты";
		ИсключатьПриКонтроле = "УвеличениеПланаОплатыКлиентом.ИсключатьПриКонтроле";
		СвязанныйДокумент = "УвеличениеПланаОплатыКлиентом.СвязанныйДокумент";
		ИдентификаторФинЗаписи = "УвеличениеПланаОплатыКлиентом.ОбъектРасчетов.УникальныйИдентификатор";
		НастройкаХозяйственнойОперации = "Неопределено";
		Вид = "2";
		
	ИначеЕсли Операция = "ВозвратОплатыКлиенту" Тогда
		
		ЭтоЗаказ = "ЛОЖЬ";
		ЭтоНакладная = "ЛОЖЬ";
		Период = "УвеличениеПланаОплатыКлиентом.ДатаРегистратора";
		
		ПорядокРасчетов = "Неопределено";
		НакладнаяПоЗаказам = "ЛОЖЬ";
		СверхЗаказа = "ЛОЖЬ";
		ЗаказПродажи = "Неопределено";
		
		КОплате = "УвеличениеПланаОплатыКлиентом.СуммаВзаиморасчетов";
		
		ФормаОплаты = "УвеличениеПланаОплатыКлиентом.ФормаОплаты";
		СтатьяДвиженияДенежныхСредств = "УвеличениеПланаОплатыКлиентом.СтатьяДвиженияДенежныхСредств";
		ДатаПлатежа = "ДАТАВРЕМЯ(1,1,1)";
		СуммаОтклоненияМерныхТоваров = "0";
		ВариантОплаты = "Неопределено";
		ИсключатьПриКонтроле = "ИСТИНА";
		СвязанныйДокумент = "Неопределено";
		ИдентификаторФинЗаписи = "УвеличениеПланаОплатыКлиентом.ИдентификаторФинЗаписи";
		НастройкаХозяйственнойОперации = "УвеличениеПланаОплатыКлиентом.НастройкаХозяйственнойОперации";
		Вид = "5";
		
	КонецЕсли;
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	&Период                                                          КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)                           КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)                  КАК АналитикаУчетаПоПартнерам,
		|	УвеличениеПланаОплатыКлиентом.ОбъектРасчетов                     КАК ОбъектРасчетов,
		|	УвеличениеПланаОплатыКлиентом.ВалютаВзаиморасчетов               КАК Валюта,
		|	
		|	0                                                                КАК Сумма,
		|	&КОплате                                                         КАК КОплате,
		|	0                                                                КАК Оплачивается,
		|	0                                                                КАК КОтгрузке,
		|	0                                                                КАК Отгружается,
		|	
		|	УвеличениеПланаОплатыКлиентом.ХозяйственнаяОперация              КАК ХозяйственнаяОперация,
		|	&ФормаОплаты                                                     КАК ФормаОплаты,
		|	Неопределено                                                     КАК СчетНаОплату,
		|	&ЗаказПродажи                                                    КАК ПродажаПоЗаказу,
		|	УвеличениеПланаОплатыКлиентом.ДатаРегистратора                   КАК ДатаРегистратора,
		|	&ДатаПлатежа                                                     КАК ДатаПлатежа,
		|	0                                                                КАК СуммаРегл,
		|	0                                                                КАК СуммаУпр,
		|	&ИсключатьПриКонтроле                                            КАК ИсключатьПриКонтроле,
		|	ЕСТЬNULL(ДанныеДоговора.ДопустимаяСуммаЗадолженности, 0)         КАК ДопустимаяСуммаЗадолженности,
		|	0                                                                КАК ЗалогЗаТару,
		|	&СтатьяДвиженияДенежныхСредств                                   КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                                     КАК РасчетныйДокумент,
		|	&СвязанныйДокумент                                               КАК СвязанныйДокумент,
		|	&ВариантОплаты                                                   КАК ВариантОплаты,
		|	УвеличениеПланаОплатыКлиентом.ВалютаДокумента                    КАК ВалютаДокумента,
		|	Неопределено                                                     КАК КорОбъектРасчетов,
		|	Неопределено                                                     КАК КорАналитикаУчетаПоПартнерам,
		|	
		|	УвеличениеПланаОплатыКлиентом.ОбъектРасчетов.Организация         КАК Организация,
		|	УвеличениеПланаОплатыКлиентом.Партнер                            КАК Партнер,
		|	УвеличениеПланаОплатыКлиентом.ОбъектРасчетов.Контрагент          КАК Контрагент,
		|	УвеличениеПланаОплатыКлиентом.ОбъектРасчетов.Договор             КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики                     КАК НаправлениеДеятельности,
		|	Неопределено                                                     КАК КорПартнер,
		|	Неопределено                                                     КАК КорОрганизация,
		|	Неопределено                                                     КАК КорКонтрагент,
		|	Неопределено                                                     КАК КорДоговор,
		|	Неопределено                                                     КАК КорНаправлениеДеятельности,
		|	УвеличениеПланаОплатыКлиентом.НомерРегистратора                  КАК НомерРегистратора,
		|	&ИдентификаторФинЗаписи                                          КАК ИдентификаторФинЗаписи,
		|	Неопределено                                                     КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	&Вид                                                             КАК Вид,
		|	&НастройкаХозяйственнойОперации                                  КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                                     КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                                     КАК ОбъектРасчетовПриемник,
		|	Неопределено                                                     КАК ВалютаПриемник,
		|	Неопределено                                                     КАК ПартнерПриемник,
		|	Неопределено                                                     КАК ОрганизацияПриемник,
		|	Неопределено                                                     КАК КонтрагентПриемник,
		|	Неопределено                                                     КАК ДоговорПриемник,
		|	Неопределено                                                     КАК НаправлениеДеятельностиПриемник,
		|	0                                                                КАК СуммаПриемник,
		|	ЛОЖЬ                                                             КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#УвеличениеПланаОплатыКлиентом КАК УвеличениеПланаОплатыКлиентом
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО УвеличениеПланаОплатыКлиентом.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка = УвеличениеПланаОплатыКлиентом.ОбъектРасчетов.Договор
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|			ПО УвеличениеПланаОплатыКлиентом.ОбъектРасчетов.Организация = Аналитика.Организация
		|				И УвеличениеПланаОплатыКлиентом.ОбъектРасчетов.Контрагент = Аналитика.Контрагент
		|				И УвеличениеПланаОплатыКлиентом.Партнер = Аналитика.Партнер
		|				И УвеличениеПланаОплатыКлиентом.ОбъектРасчетов.Договор = Аналитика.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|ГДЕ
		|	&КОплате <> 0
		|	//При расчетах по договору с графиком план оплаты не увеличивается
		|	И НЕ (&ЭтоЗаказ
		|			И ЕСТЬNULL(ДанныеДоговора.ЗаданГрафикИсполнения, ЛОЖЬ)
		|			И ЕСТЬNULL(ДанныеДоговора.ТипДоговора, ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.ПустаяСсылка)) 
		|				В (ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СПокупателем),
		|					ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СКомиссионером),
		|					ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СДавальцем))
		|			И &ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов))
		|	//Заказ с расчетами не по накладным
		|	И (&ЭтоЗаказ И &ПорядокРасчетов <> ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоНакладным)
		|		ИЛИ &ЭтоНакладная
		|		// График исполнения договора, возврат оплаты
		|		ИЛИ НЕ (&ЭтоНакладная ИЛИ &ЭтоЗаказ)
		|		)
		|
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	&Период                                                         КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)                          КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)                 КАК АналитикаУчетаПоПартнерам,
		|	УвеличениеПланаОплатыКлиентом.ОбъектРасчетов                    КАК ОбъектРасчетов,
		|	УвеличениеПланаОплатыКлиентом.ВалютаВзаиморасчетов              КАК Валюта,
		|	
		|	0                                                               КАК Сумма,
		|	&СуммаОтклоненияМерныхТоваров                                   КАК КОплате,
		|	0                                                               КАК Оплачивается,
		|	0                                                               КАК КОтгрузке,
		|	0                                                               КАК Отгружается,
		|
		|	УвеличениеПланаОплатыКлиентом.ХозяйственнаяОперация             КАК ХозяйственнаяОперация,
		|	&ФормаОплаты                                                    КАК ФормаОплаты,
		|	Неопределено                                                    КАК СчетНаОплату,
		|	Неопределено                                                    КАК ПродажаПоЗаказу,
		|	УвеличениеПланаОплатыКлиентом.ДатаРегистратора                  КАК ДатаРегистратора,
		|	&ДатаПлатежа                                                    КАК ДатаПлатежа,
		|	0                                                               КАК СуммаРегл,
		|	0                                                               КАК СуммаУпр,
		|	ИСТИНА                                                          КАК ИсключатьПриКонтроле,
		|	0                                                               КАК ДопустимаяСуммаЗадолженности,
		|	0                                                               КАК ЗалогЗаТару,
		|	Неопределено                                                    КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                                    КАК РасчетныйДокумент,
		|	Неопределено                                                     КАК СвязанныйДокумент,
		|	&ВариантОплаты                                                   КАК ВариантОплаты,
		|	УвеличениеПланаОплатыКлиентом.ВалютаДокумента                    КАК ВалютаДокумента,
		|	Неопределено                                                     КАК КорОбъектРасчетов,
		|	Неопределено                                                     КАК КорАналитикаУчетаПоПартнерам,
		|	   
		|	УвеличениеПланаОплатыКлиентом.ОбъектРасчетов.Организация         КАК Организация,
		|	УвеличениеПланаОплатыКлиентом.ОбъектРасчетов.Партнер             КАК Партнер,
		|	УвеличениеПланаОплатыКлиентом.ОбъектРасчетов.Контрагент          КАК Контрагент,
		|	УвеличениеПланаОплатыКлиентом.ОбъектРасчетов.Договор             КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики                     КАК НаправлениеДеятельности,
		|	Неопределено                                                     КАК КорПартнер,
		|	Неопределено                                                     КАК КорОрганизация,
		|	Неопределено                                                     КАК КорКонтрагент,
		|	Неопределено                                                     КАК КорДоговор,
		|	Неопределено                                                     КАК КорНаправлениеДеятельности,
		|	УвеличениеПланаОплатыКлиентом.НомерРегистратора                  КАК НомерРегистратора,
		|	&ИдентификаторФинЗаписи                                          КАК ИдентификаторФинЗаписи,
		|	Неопределено                                                     КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	&Вид                                                             КАК Вид,
		|	&НастройкаХозяйственнойОперации                                  КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                                     КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                                     КАК ОбъектРасчетовПриемник,
		|	Неопределено                                                     КАК ВалютаПриемник,
		|	Неопределено                                                     КАК ПартнерПриемник,
		|	Неопределено                                                     КАК ОрганизацияПриемник,
		|	Неопределено                                                     КАК КонтрагентПриемник,
		|	Неопределено                                                     КАК ДоговорПриемник,
		|	Неопределено                                                     КАК НаправлениеДеятельностиПриемник,
		|	0                                                                КАК СуммаПриемник,
		|	ЛОЖЬ                                                             КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#УвеличениеПланаОплатыКлиентом КАК УвеличениеПланаОплатыКлиентом
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО УвеличениеПланаОплатыКлиентом.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|			ПО УвеличениеПланаОплатыКлиентом.ОбъектРасчетов.Организация = Аналитика.Организация
		|				И УвеличениеПланаОплатыКлиентом.ОбъектРасчетов.Контрагент = Аналитика.Контрагент
		|				И УвеличениеПланаОплатыКлиентом.ОбъектРасчетов.Партнер = Аналитика.Партнер
		|				И УвеличениеПланаОплатыКлиентом.ОбъектРасчетов.Договор = Аналитика.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|ГДЕ
		|	&СуммаОтклоненияМерныхТоваров <> 0
		|	И &ЭтоЗаказ И НЕ &ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоНакладным)
		|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ПорядокРасчетов",ПорядокРасчетов);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ФормаОплаты",ФормаОплаты);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СуммаОтклоненияМерныхТоваров",СуммаОтклоненияМерныхТоваров);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЭтоЗаказ",ЭтоЗаказ);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЭтоНакладная",ЭтоНакладная);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&НакладнаяПоЗаказам", НакладнаяПоЗаказам);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СверхЗаказа", СверхЗаказа);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЗаказПродажи", ЗаказПродажи);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СтатьяДвиженияДенежныхСредств", СтатьяДвиженияДенежныхСредств);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&КОплате", КОплате);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&Период", Период);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ДатаПлатежа", ДатаПлатежа);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ВариантОплаты", ВариантОплаты);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ИсключатьПриКонтроле", ИсключатьПриКонтроле);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СвязанныйДокумент", СвязанныйДокумент);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ИдентификаторФинЗаписи", ИдентификаторФинЗаписи);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&НастройкаХозяйственнойОперации", НастройкаХозяйственнойОперации);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&Вид", Вид);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция УменьшитьПланОплатыОтКлиента(Операция, НакладнаяПоЗаказам = Ложь)

	Если Операция = "ВозвратТоваров" Тогда
		
		СчетНаОплату = "Неопределено";
		ФормаОплаты = "Неопределено";
		СтатьяДвиженияДенежныхСредств = "Неопределено";
		КОплате = "УменьшениеПланаОплатыОтКлиента.КОплате";
		СвязанныйДокумент = "Неопределено";
		ИдентификаторФинЗаписи = "УменьшениеПланаОплатыОтКлиента.ОбъектРасчетов.УникальныйИдентификатор";
		НастройкаХозяйственнойОперации = "Неопределено";
		ПродажаПоЗаказу = "Неопределено";
		Вид = "4";
		ОбъектРасчетов = "УменьшениеПланаОплатыОтКлиента.ОбъектРасчетов";
		УсловиеОперации = "ИСТИНА";
		Организация = "УменьшениеПланаОплатыОтКлиента.Организация";
		ВариантОплаты = "Неопределено";
	ИначеЕсли Операция = "Продажа" Тогда
		
		СчетНаОплату = "Неопределено";
		ФормаОплаты = "Неопределено";
		СтатьяДвиженияДенежныхСредств = "Неопределено";
		СвязанныйДокумент = "Неопределено";
		НастройкаХозяйственнойОперации = "Неопределено";
		Вид = "2";
		КОплате = "УменьшениеПланаОплатыОтКлиента.КОплате";
		
		Если НакладнаяПоЗаказам Тогда
			ВариантОплаты = "УменьшениеПланаОплатыОтКлиента.ВариантОплаты";
			ИдентификаторФинЗаписи = "ВЫБОР 
			|		КОГДА УменьшениеПланаОплатыОтКлиента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
			|			ТОГДА УменьшениеПланаОплатыОтКлиента.ЗаказПродажи.ОбъектРасчетов.УникальныйИдентификатор
			|		КОГДА УменьшениеПланаОплатыОтКлиента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
			|			ТОГДА ДанныеДоговора.ОбъектРасчетов.УникальныйИдентификатор
			|		ИНАЧЕ УменьшениеПланаОплатыОтКлиента.ОбъектРасчетов.УникальныйИдентификатор
			|	КОНЕЦ";
			
			ПродажаПоЗаказу = "УменьшениеПланаОплатыОтКлиента.ЗаказПродажи";
			
			ОбъектРасчетов = "ВЫБОР 
			|		КОГДА УменьшениеПланаОплатыОтКлиента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
			|			ТОГДА УменьшениеПланаОплатыОтКлиента.ЗаказПродажи.ОбъектРасчетов
			|		КОГДА УменьшениеПланаОплатыОтКлиента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
			|			ТОГДА ДанныеДоговора.ОбъектРасчетов
			|		ИНАЧЕ УменьшениеПланаОплатыОтКлиента.ОбъектРасчетов
			|	КОНЕЦ";
			УсловиеОперации = "	(УменьшениеПланаОплатыОтКлиента.НакладнаяПоЗаказам 
			|						И НЕ УменьшениеПланаОплатыОтКлиента.СверхЗаказа 
			|						И ИспользоватьРасширенныеВозможностиЗаказаКлиента.Значение
			|					ИЛИ УменьшениеПланаОплатыОтКлиента.ОбъектРасчетов.Договор.ЗаданГрафикИсполнения)
			|						И УменьшениеПланаОплатыОтКлиента.ПорядокРасчетов <> ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоНакладным)";
			Организация = "ВЫБОР 
			|		КОГДА УменьшениеПланаОплатыОтКлиента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
			|			ТОГДА УменьшениеПланаОплатыОтКлиента.ЗаказПродажи.Организация
			|		КОГДА УменьшениеПланаОплатыОтКлиента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
			|			ТОГДА ДанныеДоговора.Организация
			|		ИНАЧЕ УменьшениеПланаОплатыОтКлиента.ОбъектРасчетов.Организация
			|	КОНЕЦ";
		Иначе
			ВариантОплаты = "Неопределено";
			ИдентификаторФинЗаписи = "ВЫБОР 
			|		КОГДА УменьшениеПланаОплатыОтКлиента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
			|			ТОГДА ДанныеДоговора.ОбъектРасчетов.УникальныйИдентификатор
			|		ИНАЧЕ УменьшениеПланаОплатыОтКлиента.ОбъектРасчетов.УникальныйИдентификатор
			|	КОНЕЦ";
			ПродажаПоЗаказу = "Неопределено";
			ОбъектРасчетов = "ВЫБОР 
			|		КОГДА УменьшениеПланаОплатыОтКлиента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
			|			ТОГДА ДанныеДоговора.ОбъектРасчетов
			|		ИНАЧЕ УменьшениеПланаОплатыОтКлиента.ОбъектРасчетов
			|	КОНЕЦ";
			УсловиеОперации = "УменьшениеПланаОплатыОтКлиента.ОбъектРасчетов.Договор.ЗаданГрафикИсполнения
			|		И УменьшениеПланаОплатыОтКлиента.ПорядокРасчетов <> ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоНакладным)
			|		И УменьшениеПланаОплатыОтКлиента.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаЗадолженности)";
			Организация = "ВЫБОР 
			|		КОГДА УменьшениеПланаОплатыОтКлиента.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
			|			ТОГДА ДанныеДоговора.Организация
			|		ИНАЧЕ УменьшениеПланаОплатыОтКлиента.ОбъектРасчетов.Организация
			|	КОНЕЦ";
		КонецЕсли;
	ИначеЕсли Операция = "ОплатаОтКлиента" ИЛИ Операция = "ЗачетОбязательствКлиента" Тогда
		
		СчетНаОплату = "УменьшениеПланаОплатыОтКлиента.СчетНаОплату";
		ФормаОплаты = "УменьшениеПланаОплатыОтКлиента.ФормаОплаты";
		СтатьяДвиженияДенежныхСредств = "УменьшениеПланаОплатыОтКлиента.СтатьяДвиженияДенежныхСредств";
		КОплате = "УменьшениеПланаОплатыОтКлиента.СуммаВзаиморасчетов";
		СвязанныйДокумент = "УменьшениеПланаОплатыОтКлиента.СвязанныйДокумент";
		ИдентификаторФинЗаписи = "УменьшениеПланаОплатыОтКлиента.ИдентификаторФинЗаписи";
		НастройкаХозяйственнойОперации = "УменьшениеПланаОплатыОтКлиента.НастройкаХозяйственнойОперации";
		ПродажаПоЗаказу = "Неопределено";
		Вид = "ВЫБОР КОГДА
		|	УменьшениеПланаОплатыОтКлиента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.УдержаниеВознагражденияКомиссионера)
		|		ТОГДА 2
		|	КОГДА УменьшениеПланаОплатыОтКлиента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаЗадолженности)
		|		ТОГДА 3
		|	ИНАЧЕ 4
		|КОНЕЦ";
		ОбъектРасчетов = "УменьшениеПланаОплатыОтКлиента.ОбъектРасчетов";
		УсловиеОперации = "ИСТИНА";
		Организация = "УменьшениеПланаОплатыОтКлиента.Организация";
		ВариантОплаты = "Неопределено";
		
	КонецЕсли;
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	УменьшениеПланаОплатыОтКлиента.ДатаРегистратора                  КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                           КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)                  КАК АналитикаУчетаПоПартнерам,
		|	&ОбъектРасчетов                                                  КАК ОбъектРасчетов,
		|	УменьшениеПланаОплатыОтКлиента.ВалютаВзаиморасчетов              КАК Валюта,
		|	
		|	0                                                                КАК Сумма,
		|	(&КОплате)                                                       КАК КОплате,
		|	0                                                                КАК Оплачивается,
		|	0                                                                КАК КОтгрузке,
		|	0                                                                КАК Отгружается,
		|	
		|	УменьшениеПланаОплатыОтКлиента.ХозяйственнаяОперация             КАК ХозяйственнаяОперация,
		|	&ФормаОплаты                                                     КАК ФормаОплаты,
		|	&СчетНаОплату                                                    КАК СчетНаОплату,
		|	&ПродажаПоЗаказу                                                 КАК ПродажаПоЗаказу,
		|	УменьшениеПланаОплатыОтКлиента.ДатаРегистратора                  КАК ДатаРегистратора,
		|	ВЫБОР КОГДА &КОплате < 0
		|			ТОГДА НАЧАЛОПЕРИОДА(УменьшениеПланаОплатыОтКлиента.ДатаРегистратора, ДЕНЬ)
		|		ИНАЧЕ ДАТАВРЕМЯ(1,1,1)
		|	КОНЕЦ                                                     КАК ДатаПлатежа,
		|	0                                                                КАК СуммаРегл,
		|	0                                                                КАК СуммаУпр,
		|	ЛОЖЬ                                                             КАК ИсключатьПриКонтроле,
		|	0                                                                КАК ДопустимаяСуммаЗадолженности,
		|	0                                                                КАК ЗалогЗаТару,
		|	&СтатьяДвиженияДенежныхСредств                                   КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                                     КАК РасчетныйДокумент,
		|	&СвязанныйДокумент                                               КАК СвязанныйДокумент,
		|	&ВариантОплаты                                                   КАК ВариантОплаты,
		|	УменьшениеПланаОплатыОтКлиента.ВалютаДокумента                   КАК ВалютаДокумента,
		|	Неопределено                                                     КАК КорОбъектРасчетов,
		|	Неопределено                                                     КАК КорАналитикаУчетаПоПартнерам,
		|	
		|	&Организация                                                     КАК Организация,
		|	УменьшениеПланаОплатыОтКлиента.Партнер                           КАК Партнер,
		|	УменьшениеПланаОплатыОтКлиента.ОбъектРасчетов.Контрагент         КАК Контрагент,
		|	УменьшениеПланаОплатыОтКлиента.ОбъектРасчетов.Договор            КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики                     КАК НаправлениеДеятельности,
		|	Неопределено                                                     КАК КорПартнер,
		|	Неопределено                                                     КАК КорОрганизация,
		|	Неопределено                                                     КАК КорКонтрагент,
		|	Неопределено                                                     КАК КорДоговор,
		|	Неопределено                                                     КАК КорНаправлениеДеятельности,
		|	УменьшениеПланаОплатыОтКлиента.НомерРегистратора                 КАК НомерРегистратора,
		|	&ИдентификаторФинЗаписи                                          КАК ИдентификаторФинЗаписи,
		|	Неопределено                                                     КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	&Вид                                                             КАК Вид,
		|	&НастройкаХозяйственнойОперации                                  КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                                     КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                                     КАК ОбъектРасчетовПриемник,
		|	Неопределено                                                     КАК ВалютаПриемник,
		|	Неопределено                                                     КАК ПартнерПриемник,
		|	Неопределено                                                     КАК ОрганизацияПриемник,
		|	Неопределено                                                     КАК КонтрагентПриемник,
		|	Неопределено                                                     КАК ДоговорПриемник,
		|	Неопределено                                                     КАК НаправлениеДеятельностиПриемник,
		|	0                                                                КАК СуммаПриемник,
		|	ЛОЖЬ                                                             КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#УменьшениеПланаОплатыОтКлиента КАК УменьшениеПланаОплатыОтКлиента
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка =  УменьшениеПланаОплатыОтКлиента.ОбъектРасчетов.Договор
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО &ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Константа.ИспользоватьРасширенныеВозможностиЗаказаКлиента КАК ИспользоватьРасширенныеВозможностиЗаказаКлиента
		|			ПО ИСТИНА
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|			ПО &Организация = Аналитика.Организация
		|				И УменьшениеПланаОплатыОтКлиента.ОбъектРасчетов.Контрагент = Аналитика.Контрагент
		|				И УменьшениеПланаОплатыОтКлиента.Партнер = Аналитика.Партнер
		|				И УменьшениеПланаОплатыОтКлиента.ОбъектРасчетов.Договор = Аналитика.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|ГДЕ
		|	&КОплате <> 0
		|	И &УсловиеОперации
		|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ФормаОплаты",                   ФормаОплаты);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СчетНаОплату",                  СчетНаОплату);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СтатьяДвиженияДенежныхСредств", СтатьяДвиженияДенежныхСредств);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&КОплате",                       КОплате);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СвязанныйДокумент",             СвязанныйДокумент);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ИдентификаторФинЗаписи",        ИдентификаторФинЗаписи);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&НастройкаХозяйственнойОперации", НастройкаХозяйственнойОперации);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ПродажаПоЗаказу",                ПродажаПоЗаказу);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&Вид",                            Вид);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ОбъектРасчетов",                 ОбъектРасчетов);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&УсловиеОперации",                УсловиеОперации);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&Организация",                    Организация);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ВариантОплаты",                  ВариантОплаты);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция УвеличитьЗадолженностьКлиента(Операция)

	Если Операция = "Продажа" Тогда
		
		ЗаказПродажи = "УвеличениеЗадолженностиКлиента.ЗаказПродажи";
		СуммаВзаиморасчетовПоТаре = "УвеличениеЗадолженностиКлиента.СуммаВзаиморасчетовПоТаре";
		ВариантОплаты = "УвеличениеЗадолженностиКлиента.ВариантОплаты";
		ФормаОплаты = "Неопределено";
		СтатьяДвиженияДенежныхСредств = "Неопределено";
		ИсключатьПриКонтроле = "УвеличениеЗадолженностиКлиента.ПорядокРасчетов <> ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов)
		|	ИЛИ НЕ ДанныеДоговора.ЗаданГрафикИсполнения";
		ДатаПлатежа = "ВЫБОР КОГДА УвеличениеЗадолженностиКлиента.Сумма < 0
						|		ТОГДА ДАТАВРЕМЯ(1,1,1)
						|	ИНАЧЕ УвеличениеЗадолженностиКлиента.ДатаПлатежа
						|КОНЕЦ";
		СвязанныйДокумент = "УвеличениеЗадолженностиКлиента.СвязанныйДокумент";
		ИдентификаторФинЗаписи = "УвеличениеЗадолженностиКлиента.ОбъектРасчетов.УникальныйИдентификатор";
		НастройкаХозяйственнойОперации = "Неопределено";
		ХозяйственнаяОперация = "УвеличениеЗадолженностиКлиента.ХозяйственнаяОперация";
		Вид = "2";
		
	ИначеЕсли Операция = "ВозвратОплатыКлиенту" Тогда
		
		ЗаказПродажи = "Неопределено";
		СуммаВзаиморасчетовПоТаре = "0";
		ВариантОплаты = "ЗНАЧЕНИЕ(Перечисление.ВариантыКонтроляОплатыКлиентом.ПустаяСсылка)";
		ФормаОплаты = "УвеличениеЗадолженностиКлиента.ФормаОплаты";
		СтатьяДвиженияДенежныхСредств = "УвеличениеЗадолженностиКлиента.СтатьяДвиженияДенежныхСредств";
		ИсключатьПриКонтроле = "ИСТИНА";
		ДатаПлатежа = "НАЧАЛОПЕРИОДА(УвеличениеЗадолженностиКлиента.ДатаРегистратора, ДЕНЬ)";
		СвязанныйДокумент = "Неопределено";
		ИдентификаторФинЗаписи = "УвеличениеЗадолженностиКлиента.ИдентификаторФинЗаписи";
		НастройкаХозяйственнойОперации = "УвеличениеЗадолженностиКлиента.НастройкаХозяйственнойОперации";
		ХозяйственнаяОперация = "УвеличениеЗадолженностиКлиента.ХозяйственнаяОперация";
		Вид = "5";
		
	КонецЕсли;
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	УвеличениеЗадолженностиКлиента.ДатаРегистратора           КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)                    КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)           КАК АналитикаУчетаПоПартнерам,
		|	УвеличениеЗадолженностиКлиента.ОбъектРасчетов             КАК ОбъектРасчетов,
		|	УвеличениеЗадолженностиКлиента.ВалютаВзаиморасчетов       КАК Валюта,
		|	
		|	(УвеличениеЗадолженностиКлиента.СуммаВзаиморасчетов)      КАК Сумма,
		|	0                                                         КАК КОплате,
		|	0                                                         КАК Оплачивается,
		|	0                                                         КАК КОтгрузке,
		|	0                                                         КАК Отгружается,
		|	
		|	&ХозяйственнаяОперация                                    КАК ХозяйственнаяОперация,
		|	&ФормаОплаты                                              КАК ФормаОплаты,
		|	Неопределено                                              КАК СчетНаОплату,
		|	&ЗаказПродажи                                             КАК ПродажаПоЗаказу,
		|	УвеличениеЗадолженностиКлиента.ДатаРегистратора           КАК ДатаРегистратора,
		|	&ДатаПлатежа                                              КАК ДатаПлатежа,
		|	
		|	(ВЫБОР КОГДА УвеличениеЗадолженностиКлиента.ВалютаВзаиморасчетов = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА УвеличениеЗадолженностиКлиента.СуммаВзаиморасчетов
		|			КОГДА УвеличениеЗадолженностиКлиента.ВалютаДокумента = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА УвеличениеЗадолженностиКлиента.Сумма
		|			ИНАЧЕ ВЫРАЗИТЬ(УвеличениеЗадолженностиКлиента.Сумма * Коэффициенты.КоэффициентРегл КАК ЧИСЛО(31,2))
		|	КОНЕЦ)                                                    КАК СуммаРегл,
		|	(ВЫБОР КОГДА УвеличениеЗадолженностиКлиента.ВалютаВзаиморасчетов = &ВалютаУправленческогоУчета
		|				ТОГДА УвеличениеЗадолженностиКлиента.СуммаВзаиморасчетов
		|			КОГДА УвеличениеЗадолженностиКлиента.ВалютаДокумента = &ВалютаУправленческогоУчета
		|				ТОГДА УвеличениеЗадолженностиКлиента.Сумма
		|			ИНАЧЕ ВЫРАЗИТЬ((УвеличениеЗадолженностиКлиента.Сумма * Коэффициенты.КоэффициентУпр) КАК ЧИСЛО(31,2))
		|	КОНЕЦ)                                                    КАК СуммаУпр,
		|
		|	&ИсключатьПриКонтроле                                     КАК ИсключатьПриКонтроле,
		|	ЕСТЬNULL(ДанныеДоговора.ДопустимаяСуммаЗадолженности, 0)  КАК ДопустимаяСуммаЗадолженности,
		|	(&СуммаВзаиморасчетовПоТаре)                              КАК ЗалогЗаТару,
		|	&СтатьяДвиженияДенежныхСредств                            КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                              КАК РасчетныйДокумент,
		|	&СвязанныйДокумент                                        КАК СвязанныйДокумент,
		|	&ВариантОплаты                                            КАК ВариантОплаты,
		|	УвеличениеЗадолженностиКлиента.ВалютаДокумента            КАК ВалютаДокумента,
		|	Неопределено                                              КАК КорОбъектРасчетов,
		|	Неопределено                                              КАК КорАналитикаУчетаПоПартнерам,
		|	  
		|	ВЫБОР КОГДА ЕСТЬNULL(ДанныеДоговора.ЦентрализованныйДоговор, Ложь)
		|		ТОГДА УвеличениеЗадолженностиКлиента.Организация
		|		ИНАЧЕ УвеличениеЗадолженностиКлиента.ОбъектРасчетов.Организация
		|	КОНЕЦ                                                     КАК Организация,
		|	УвеличениеЗадолженностиКлиента.Партнер                    КАК Партнер,
		|	УвеличениеЗадолженностиКлиента.ОбъектРасчетов.Контрагент  КАК Контрагент,
		|	УвеличениеЗадолженностиКлиента.ОбъектРасчетов.Договор     КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики              КАК НаправлениеДеятельности,
		|	Неопределено                                              КАК КорПартнер,
		|	Неопределено                                              КАК КорОрганизация,
		|	Неопределено                                              КАК КорКонтрагент,
		|	Неопределено                                              КАК КорДоговор,
		|	Неопределено                                              КАК КорНаправлениеДеятельности,
		|	УвеличениеЗадолженностиКлиента.НомерРегистратора          КАК НомерРегистратора,
		|	&ИдентификаторФинЗаписи                                   КАК ИдентификаторФинЗаписи,
		|	Неопределено                                              КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	&Вид                                                      КАК Вид,
		|	&НастройкаХозяйственнойОперации                           КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                              КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                              КАК ОбъектРасчетовПриемник,
		|	Неопределено                                              КАК ВалютаПриемник,
		|	Неопределено                                              КАК ПартнерПриемник,
		|	Неопределено                                              КАК ОрганизацияПриемник,
		|	Неопределено                                              КАК КонтрагентПриемник,
		|	Неопределено                                              КАК ДоговорПриемник,
		|	Неопределено                                              КАК НаправлениеДеятельностиПриемник,
		|	0                                                         КАК СуммаПриемник,
		|	ЛОЖЬ                                                      КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#УвеличениеЗадолженностиКлиента КАК УвеличениеЗадолженностиКлиента
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО УвеличениеЗадолженностиКлиента.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка = УвеличениеЗадолженностиКлиента.ОбъектРасчетов.Договор
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|			ПО ВЫБОР КОГДА ЕСТЬNULL(ДанныеДоговора.ЦентрализованныйДоговор, Ложь)
		|					ТОГДА УвеличениеЗадолженностиКлиента.Организация
		|					ИНАЧЕ УвеличениеЗадолженностиКлиента.ОбъектРасчетов.Организация
		|				КОНЕЦ = Аналитика.Организация
		|				И УвеличениеЗадолженностиКлиента.ОбъектРасчетов.Контрагент = Аналитика.Контрагент
		|				И УвеличениеЗадолженностиКлиента.Партнер = Аналитика.Партнер
		|				И УвеличениеЗадолженностиКлиента.ОбъектРасчетов.Договор = Аналитика.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаиморасчетыВтКоэффициентыПересчетаВалют КАК Коэффициенты
		|			ПО Коэффициенты.Ссылка = УвеличениеЗадолженностиКлиента.Ссылка
		|				И Коэффициенты.ОбъектРасчетов = УвеличениеЗадолженностиКлиента.ОбъектРасчетов
		|				И Коэффициенты.ВалютаВзаиморасчетов = УвеличениеЗадолженностиКлиента.ВалютаВзаиморасчетов
		|				И Коэффициенты.ДатаКурса = УвеличениеЗадолженностиКлиента.ДатаКурса
		|ГДЕ 
		|	УвеличениеЗадолженностиКлиента.СуммаВзаиморасчетов <> 0
		|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЗаказПродажи",                  ЗаказПродажи);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СуммаВзаиморасчетовПоТаре",     СуммаВзаиморасчетовПоТаре);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ВариантОплаты",                 ВариантОплаты);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ФормаОплаты",                   ФормаОплаты);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СтатьяДвиженияДенежныхСредств", СтатьяДвиженияДенежныхСредств);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ИсключатьПриКонтроле",          ИсключатьПриКонтроле);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ДатаПлатежа",                   ДатаПлатежа);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СвязанныйДокумент",             СвязанныйДокумент);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ИдентификаторФинЗаписи",        ИдентификаторФинЗаписи);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&НастройкаХозяйственнойОперации", НастройкаХозяйственнойОперации);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ХозяйственнаяОперация",        ХозяйственнаяОперация);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&Вид", Вид);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция УвеличитьНашуЗадолженностьКлиенту(Операция)
	
	Если Операция = "ВозвратТоваров" Тогда
		
		СчетНаОплату = "Неопределено";
		ФормаОплаты = "Неопределено";
		СтатьяДвиженияДенежныхСредств = "Неопределено";
		СвязанныйДокумент = "Неопределено";
		ДатаПлатежа = "ДАТАВРЕМЯ(1,1,1)";
		ИдентификаторФинЗаписи = "ТаблицаОплатаОтКлиента.ОбъектРасчетов.УникальныйИдентификатор";
		НастройкаХозяйственнойОперации = "Неопределено";
		Вид = "4";
		
	ИначеЕсли Операция = "ОплатаОтКлиента" ИЛИ Операция = "ЗачетОбязательствКлиента" Тогда
		
		СчетНаОплату = "ТаблицаОплатаОтКлиента.СчетНаОплату";
		ФормаОплаты = "ТаблицаОплатаОтКлиента.ФормаОплаты";
		СтатьяДвиженияДенежныхСредств = "ТаблицаОплатаОтКлиента.СтатьяДвиженияДенежныхСредств";
		СвязанныйДокумент = "ТаблицаОплатаОтКлиента.СвязанныйДокумент";
		Если Операция = "ОплатаОтКлиента" Тогда
			ДатаПлатежа = "ВЫБОР КОГДА ТаблицаОплатаОтКлиента.СуммаВзаиморасчетов < 0
			|			ТОГДА НАЧАЛОПЕРИОДА(ТаблицаОплатаОтКлиента.ДатаРегистратора, ДЕНЬ)
			|		ИНАЧЕ ТаблицаОплатаОтКлиента.ДатаПогашения
			|	КОНЕЦ";
		Иначе
			ДатаПлатежа = "ВЫБОР КОГДА ТаблицаОплатаОтКлиента.СуммаВзаиморасчетов < 0
			|			ТОГДА НАЧАЛОПЕРИОДА(ТаблицаОплатаОтКлиента.ДатаРегистратора, ДЕНЬ)
			|		ИНАЧЕ ДАТАВРЕМЯ(1,1,1)
			|	КОНЕЦ";
		КонецЕсли;
		ИдентификаторФинЗаписи = "ТаблицаОплатаОтКлиента.ИдентификаторФинЗаписи";
		НастройкаХозяйственнойОперации = "ТаблицаОплатаОтКлиента.НастройкаХозяйственнойОперации";
		Вид = "ВЫБОР КОГДА
		|	ТаблицаОплатаОтКлиента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.УдержаниеВознагражденияКомиссионера)
		|		ТОГДА 2
		|	КОГДА ТаблицаОплатаОтКлиента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаЗадолженности)
		|		ТОГДА 3
		|	ИНАЧЕ 4
		|КОНЕЦ";
		
	КонецЕсли;
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ТаблицаОплатаОтКлиента.ДатаРегистратора               КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)       КАК АналитикаУчетаПоПартнерам,
		|	ТаблицаОплатаОтКлиента.ОбъектРасчетов                 КАК ОбъектРасчетов,
		|	ТаблицаОплатаОтКлиента.ВалютаВзаиморасчетов           КАК Валюта,
		|	
		|	(ТаблицаОплатаОтКлиента.СуммаВзаиморасчетов)          КАК Сумма,
		|	0                                                     КАК КОплате,
		|	0                                                     КАК Оплачивается,
		|	0                                                     КАК КОтгрузке,
		|	0                                                     КАК Отгружается,
		|	
		|	ТаблицаОплатаОтКлиента.ХозяйственнаяОперация          КАК ХозяйственнаяОперация,
		|	&ФормаОплаты                                          КАК ФормаОплаты,
		|	&СчетНаОплату                                         КАК СчетНаОплату,
		|	Неопределено                                          КАК ПродажаПоЗаказу,
		|	ТаблицаОплатаОтКлиента.ДатаРегистратора               КАК ДатаРегистратора,
		|	&ДатаПлатежа                                          КАК ДатаПлатежа,
		|	
		|	(ВЫБОР КОГДА ТаблицаОплатаОтКлиента.ВалютаВзаиморасчетов = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА ТаблицаОплатаОтКлиента.СуммаВзаиморасчетов
		|			КОГДА ТаблицаОплатаОтКлиента.ВалютаДокумента = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА ТаблицаОплатаОтКлиента.Сумма
		|			ИНАЧЕ ВЫРАЗИТЬ(ТаблицаОплатаОтКлиента.Сумма * Коэффициенты.КоэффициентРегл КАК ЧИСЛО(31,2))
		|	КОНЕЦ)                                                КАК СуммаРегл,
		|	(ВЫБОР КОГДА ТаблицаОплатаОтКлиента.ВалютаВзаиморасчетов = &ВалютаУправленческогоУчета
		|				ТОГДА ТаблицаОплатаОтКлиента.СуммаВзаиморасчетов
		|			КОГДА ТаблицаОплатаОтКлиента.ВалютаДокумента = &ВалютаУправленческогоУчета
		|				ТОГДА ТаблицаОплатаОтКлиента.Сумма
		|			ИНАЧЕ ВЫРАЗИТЬ(ТаблицаОплатаОтКлиента.Сумма * Коэффициенты.КоэффициентУпр КАК ЧИСЛО(31,2))
		|	КОНЕЦ)                                                КАК СуммаУпр,
		|
		|	ЛОЖЬ                                                  КАК ИсключатьПриКонтроле,
		|	0                                                     КАК ДопустимаяСуммаЗадолженности,
		|	0                                                     КАК ЗалогЗаТару,
		|	&СтатьяДвиженияДенежныхСредств                        КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                          КАК РасчетныйДокумент,
		|	&СвязанныйДокумент                                    КАК СвязанныйДокумент,
		|	Неопределено                                          КАК ВариантОплаты,
		|	ТаблицаОплатаОтКлиента.ВалютаДокумента                КАК ВалютаДокумента,
		|	Неопределено                                          КАК КорОбъектРасчетов,
		|	Неопределено                                          КАК КорАналитикаУчетаПоПартнерам,
		|	
		|	ВЫБОР КОГДА ТаблицаОплатаОтКлиента.Организация <> ТаблицаОплатаОтКлиента.ОбъектРасчетов.Организация
		|		ТОГДА ТаблицаОплатаОтКлиента.Организация
		|		ИНАЧЕ ТаблицаОплатаОтКлиента.ОбъектРасчетов.Организация
		|	КОНЕЦ                                                 КАК Организация,
		|	ТаблицаОплатаОтКлиента.Партнер                        КАК Партнер,
		|	ТаблицаОплатаОтКлиента.ОбъектРасчетов.Контрагент      КАК Контрагент,
		|	ТаблицаОплатаОтКлиента.ОбъектРасчетов.Договор         КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики          КАК НаправлениеДеятельности,
		|	Неопределено                                          КАК КорПартнер,
		|	Неопределено                                          КАК КорОрганизация,
		|	Неопределено                                          КАК КорКонтрагент,
		|	Неопределено                                          КАК КорДоговор,
		|	Неопределено                                          КАК КорНаправлениеДеятельности,
		|	ТаблицаОплатаОтКлиента.НомерРегистратора              КАК НомерРегистратора,
		|	&ИдентификаторФинЗаписи                               КАК ИдентификаторФинЗаписи,
		|	Неопределено                                          КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	&Вид                                                  КАК Вид,
		|	&НастройкаХозяйственнойОперации                       КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                          КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                          КАК ОбъектРасчетовПриемник,
		|	Неопределено                                          КАК ВалютаПриемник,
		|	Неопределено                                          КАК ПартнерПриемник,
		|	Неопределено                                          КАК ОрганизацияПриемник,
		|	Неопределено                                          КАК КонтрагентПриемник,
		|	Неопределено                                          КАК ДоговорПриемник,
		|	Неопределено                                          КАК НаправлениеДеятельностиПриемник,
		|	0                                                     КАК СуммаПриемник,
		|	ЛОЖЬ                                                  КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#ТаблицаОплатаОтКлиента КАК ТаблицаОплатаОтКлиента
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО ТаблицаОплатаОтКлиента.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ТаблицаОплатаОтКлиента.ОбъектРасчетов.Договор = ДанныеДоговора.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|			ПО ВЫБОР КОГДА ТаблицаОплатаОтКлиента.Организация <> ТаблицаОплатаОтКлиента.ОбъектРасчетов.Организация
		|						ТОГДА ТаблицаОплатаОтКлиента.Организация
		|					ИНАЧЕ ТаблицаОплатаОтКлиента.ОбъектРасчетов.Организация
		|				КОНЕЦ = Аналитика.Организация
		|				И ТаблицаОплатаОтКлиента.ОбъектРасчетов.Контрагент = Аналитика.Контрагент
		|				И ТаблицаОплатаОтКлиента.Партнер = Аналитика.Партнер
		|				И ТаблицаОплатаОтКлиента.ОбъектРасчетов.Договор = Аналитика.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаиморасчетыВтКоэффициентыПересчетаВалют КАК Коэффициенты
		|			ПО Коэффициенты.Ссылка = ТаблицаОплатаОтКлиента.Ссылка
		|				И Коэффициенты.ОбъектРасчетов = ТаблицаОплатаОтКлиента.ОбъектРасчетов
		|				И Коэффициенты.ВалютаВзаиморасчетов = ТаблицаОплатаОтКлиента.ВалютаВзаиморасчетов
		|				И Коэффициенты.ДатаКурса = ТаблицаОплатаОтКлиента.ДатаКурса
		|ГДЕ
		|	ТаблицаОплатаОтКлиента.СуммаВзаиморасчетов <> 0 
		|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ФормаОплаты",                   ФормаОплаты);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СчетНаОплату",                  СчетНаОплату);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СтатьяДвиженияДенежныхСредств", СтатьяДвиженияДенежныхСредств);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СвязанныйДокумент",             СвязанныйДокумент);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ДатаПлатежа",                   ДатаПлатежа);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ИдентификаторФинЗаписи",        ИдентификаторФинЗаписи);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&НастройкаХозяйственнойОперации", НастройкаХозяйственнойОперации);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&Вид", Вид);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция УвеличитьОплачиваетсяКлиентом(Операция)

	Если Операция = "ОплатаОтКлиента" Тогда
		СчетНаОплату = "УвеличениеОплачиваетсяКлиентом.СчетНаОплату";
		Вид = "4";
		ЗаявкаНаРасходованиеДенежныхСредств = "Неопределено";
	ИначеЕсли Операция = "ВозвратОплатыКлиенту" Тогда
		СчетНаОплату = "Неопределено";
		Вид = "5";
		ЗаявкаНаРасходованиеДенежныхСредств = "УвеличениеОплачиваетсяКлиентом.ЗаявкаНаРасходованиеДенежныхСредств";
	КонецЕсли;
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	УвеличениеОплачиваетсяКлиентом.ДатаРегистратора                  КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)                           КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)                  КАК АналитикаУчетаПоПартнерам,
		|	УвеличениеОплачиваетсяКлиентом.ОбъектРасчетов                    КАК ОбъектРасчетов,
		|	
		|	УвеличениеОплачиваетсяКлиентом.ВалютаВзаиморасчетов              КАК Валюта,
		|	
		|	0                                                                КАК Сумма,
		|	0                                                                КАК КОплате,
		|	(УвеличениеОплачиваетсяКлиентом.УвеличениеОплачивается)          КАК Оплачивается,
		|	0                                                                КАК КОтгрузке,
		|	0                                                                КАК Отгружается,
		|	
		|	УвеличениеОплачиваетсяКлиентом.ХозяйственнаяОперация             КАК ХозяйственнаяОперация,
		|	УвеличениеОплачиваетсяКлиентом.ФормаОплаты                       КАК ФормаОплаты,
		|	&СчетНаОплату                                                    КАК СчетНаОплату,
		|	Неопределено                                                     КАК ПродажаПоЗаказу,
		|	УвеличениеОплачиваетсяКлиентом.ДатаРегистратора                  КАК ДатаРегистратора,
		|	ДАТАВРЕМЯ(1,1,1)                                                 КАК ДатаПлатежа,
		|	0                                                                КАК СуммаРегл,
		|	0                                                                КАК СуммаУпр,
		|	ЛОЖЬ                                                             КАК ИсключатьПриКонтроле,
		|	0                                                                КАК ДопустимаяСуммаЗадолженности,
		|	0                                                                КАК ЗалогЗаТару,
		|	УвеличениеОплачиваетсяКлиентом.СтатьяДвиженияДенежныхСредств     КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                                     КАК РасчетныйДокумент,
		|	Неопределено                                                     КАК СвязанныйДокумент,
		|	Неопределено                                                     КАК ВариантОплаты,
		|	УвеличениеОплачиваетсяКлиентом.ВалютаДокумента                   КАК ВалютаДокумента,
		|	Неопределено                                                     КАК КорОбъектРасчетов,
		|	Неопределено                                                     КАК КорАналитикаУчетаПоПартнерам,
		|	
		|	УвеличениеОплачиваетсяКлиентом.ОбъектРасчетов.Организация        КАК Организация,
		|	УвеличениеОплачиваетсяКлиентом.Партнер                           КАК Партнер,
		|	УвеличениеОплачиваетсяКлиентом.ОбъектРасчетов.Контрагент         КАК Контрагент,
		|	УвеличениеОплачиваетсяКлиентом.ОбъектРасчетов.Договор            КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики                     КАК НаправлениеДеятельности,
		|	Неопределено                                                     КАК КорПартнер,
		|	Неопределено                                                     КАК КорОрганизация,
		|	Неопределено                                                     КАК КорКонтрагент,
		|	Неопределено                                                     КАК КорДоговор,
		|	Неопределено                                                     КАК КорНаправлениеДеятельности,
		|	УвеличениеОплачиваетсяКлиентом.НомерРегистратора                 КАК НомерРегистратора,
		|	&ИдентификаторНеиспользуемойФинЗаписи                            КАК ИдентификаторФинЗаписи,
		|	&ЗаявкаНаРасходованиеДенежныхСредств                             КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	&Вид                                                             КАК Вид,
		|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПустаяСсылка) КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                                     КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                                     КАК ОбъектРасчетовПриемник,
		|	Неопределено                                                     КАК ВалютаПриемник,
		|	Неопределено                                                     КАК ПартнерПриемник,
		|	Неопределено                                                     КАК ОрганизацияПриемник,
		|	Неопределено                                                     КАК КонтрагентПриемник,
		|	Неопределено                                                     КАК ДоговорПриемник,
		|	Неопределено                                                     КАК НаправлениеДеятельностиПриемник,
		|	0                                                                КАК СуммаПриемник,
		|	ЛОЖЬ                                                             КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#УвеличениеОплачиваетсяКлиентом КАК УвеличениеОплачиваетсяКлиентом
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО УвеличениеОплачиваетсяКлиентом.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка =  УвеличениеОплачиваетсяКлиентом.ОбъектРасчетов.Договор
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|			ПО УвеличениеОплачиваетсяКлиентом.ОбъектРасчетов.Организация = Аналитика.Организация
		|				И УвеличениеОплачиваетсяКлиентом.ОбъектРасчетов.Контрагент = Аналитика.Контрагент
		|				И УвеличениеОплачиваетсяКлиентом.Партнер = Аналитика.Партнер
		|				И УвеличениеОплачиваетсяКлиентом.ОбъектРасчетов.Договор = Аналитика.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|ГДЕ
		|	УвеличениеОплачиваетсяКлиентом.УвеличениеОплачивается <> 0
		|	И УвеличениеОплачиваетсяКлиентом.ОбъектРасчетов.Объект <> УвеличениеОплачиваетсяКлиентом.Ссылка
		|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СчетНаОплату", СчетНаОплату);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&Вид", Вид);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЗаявкаНаРасходованиеДенежныхСредств", ЗаявкаНаРасходованиеДенежныхСредств);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция УменьшитьОплачиваетсяКлиентом(Операция)
	
	Если Операция = "ОплатаОтКлиента" Тогда
		
		Оплачивается = "УменьшениеОплачиваетсяКлиентом.УменьшениеОплачивается";
		СчетНаОплату = "УменьшениеОплачиваетсяКлиентом.СчетНаОплату";
		ИсключатьПриКонтроле = "ЛОЖЬ";
		Вид = "4";
		ЗаявкаНаРасходованиеДенежныхСредств = "Неопределено";
		
	ИначеЕсли Операция = "ЗаявкаНаВозвратОплатыКлиенту" Тогда
		
		Оплачивается = "УменьшениеОплачиваетсяКлиентом.Оплачивается";
		СчетНаОплату = "Неопределено";
		ИсключатьПриКонтроле = "ЛОЖЬ";
		Вид = "1";
		ЗаявкаНаРасходованиеДенежныхСредств = "&Ссылка";
		
	ИначеЕсли Операция = "ВозвратОплатыКлиенту" Тогда
		
		Оплачивается = "УменьшениеОплачиваетсяКлиентом.Оплачивается";
		СчетНаОплату = "Неопределено";
		ИсключатьПриКонтроле = "ИСТИНА";
		Вид = "5";
		ЗаявкаНаРасходованиеДенежныхСредств = "УменьшениеОплачиваетсяКлиентом.ЗаявкаНаРасходованиеДенежныхСредств";
		
	КонецЕсли;
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	УменьшениеОплачиваетсяКлиентом.ДатаРегистратора                  КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                           КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)                  КАК АналитикаУчетаПоПартнерам,
		|	УменьшениеОплачиваетсяКлиентом.ОбъектРасчетов                    КАК ОбъектРасчетов,
		|	УменьшениеОплачиваетсяКлиентом.ВалютаВзаиморасчетов              КАК Валюта,
		|	
		|	0                                                                КАК Сумма,
		|	0                                                                КАК КОплате,
		|	(&Оплачивается)                                                  КАК Оплачивается,
		|	0                                                                КАК КОтгрузке,
		|	0                                                                КАК Отгружается,
		|	
		|	УменьшениеОплачиваетсяКлиентом.ХозяйственнаяОперация             КАК ХозяйственнаяОперация,
		|	УменьшениеОплачиваетсяКлиентом.ФормаОплаты                       КАК ФормаОплаты,
		|	&СчетНаОплату                                                    КАК СчетНаОплату,
		|	Неопределено                                                     КАК ПродажаПоЗаказу,
		|	УменьшениеОплачиваетсяКлиентом.ДатаРегистратора                  КАК ДатаРегистратора,
		|	ДАТАВРЕМЯ(1,1,1)                                                 КАК ДатаПлатежа,
		|	0                                                                КАК СуммаРегл,
		|	0                                                                КАК СуммаУпр,
		|	&ИсключатьПриКонтроле                                            КАК ИсключатьПриКонтроле,
		|	0                                                                КАК ДопустимаяСуммаЗадолженности,
		|	0                                                                КАК ЗалогЗаТару,
		|	УменьшениеОплачиваетсяКлиентом.СтатьяДвиженияДенежныхСредств     КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                                     КАК РасчетныйДокумент,
		|	Неопределено                                                     КАК СвязанныйДокумент,
		|	Неопределено                                                     КАК ВариантОплаты,
		|	УменьшениеОплачиваетсяКлиентом.ВалютаДокумента                   КАК ВалютаДокумента,
		|	Неопределено                                                     КАК КорОбъектРасчетов,
		|	Неопределено                                                     КАК КорАналитикаУчетаПоПартнерам,
		|	
		|	УменьшениеОплачиваетсяКлиентом.ОбъектРасчетов.Организация        КАК Организация,
		|	УменьшениеОплачиваетсяКлиентом.Партнер                           КАК Партнер,
		|	УменьшениеОплачиваетсяКлиентом.ОбъектРасчетов.Контрагент         КАК Контрагент,
		|	УменьшениеОплачиваетсяКлиентом.ОбъектРасчетов.Договор            КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики                     КАК НаправлениеДеятельности,
		|	Неопределено                                                     КАК КорПартнер,
		|	Неопределено                                                     КАК КорОрганизация,
		|	Неопределено                                                     КАК КорКонтрагент,
		|	Неопределено                                                     КАК КорДоговор,
		|	Неопределено                                                     КАК КорНаправлениеДеятельности,
		|	УменьшениеОплачиваетсяКлиентом.НомерРегистратора                 КАК НомерРегистратора,
		|	&ИдентификаторНеиспользуемойФинЗаписи                            КАК ИдентификаторФинЗаписи,
		|	&ЗаявкаНаРасходованиеДенежныхСредств                             КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	&Вид                                                             КАК Вид,
		|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПустаяСсылка) КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                                     КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                                     КАК ОбъектРасчетовПриемник,
		|	Неопределено                                                     КАК ВалютаПриемник,
		|	Неопределено                                                     КАК ПартнерПриемник,
		|	Неопределено                                                     КАК ОрганизацияПриемник,
		|	Неопределено                                                     КАК КонтрагентПриемник,
		|	Неопределено                                                     КАК ДоговорПриемник,
		|	Неопределено                                                     КАК НаправлениеДеятельностиПриемник,
		|	0                                                                КАК СуммаПриемник,
		|	ЛОЖЬ                                                             КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#УменьшениеОплачиваетсяКлиентом КАК УменьшениеОплачиваетсяКлиентом
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО УменьшениеОплачиваетсяКлиентом.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка =  УменьшениеОплачиваетсяКлиентом.ОбъектРасчетов.Договор
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|			ПО УменьшениеОплачиваетсяКлиентом.ОбъектРасчетов.Организация = Аналитика.Организация
		|				И УменьшениеОплачиваетсяКлиентом.ОбъектРасчетов.Контрагент = Аналитика.Контрагент
		|				И УменьшениеОплачиваетсяКлиентом.Партнер = Аналитика.Партнер
		|				И УменьшениеОплачиваетсяКлиентом.ОбъектРасчетов.Договор = Аналитика.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|ГДЕ
		|	&Оплачивается <> 0
		|	И УменьшениеОплачиваетсяКлиентом.ОбъектРасчетов.Объект <> УменьшениеОплачиваетсяКлиентом.Ссылка
		|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&Оплачивается", Оплачивается);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СчетНаОплату", СчетНаОплату);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&Вид", Вид);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЗаявкаНаРасходованиеДенежныхСредств", ЗаявкаНаРасходованиеДенежныхСредств);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ИсключатьПриКонтроле", ИсключатьПриКонтроле);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция УвеличитьОтгружается(Операция)
	
	Если Операция = "ЗаказКлиента" Тогда
		
		ЭтоЗаказ = "ИСТИНА";
		ЭтоНакладная = "ЛОЖЬ";
		НакладнаяПоЗаказам = "ЛОЖЬ";
		Вид = "1";
		
	ИначеЕсли Операция = "Продажа" Тогда
		
		ЭтоЗаказ = "ЛОЖЬ";
		ЭтоНакладная = "ИСТИНА";
		НакладнаяПоЗаказам = "УвеличениеОтгружается.НакладнаяПоЗаказам";
		Вид = "2";
		
	КонецЕсли;
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	УвеличениеОтгружается.ДатаОтгрузки                               КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)                           КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)                  КАК АналитикаУчетаПоПартнерам,
		|	УвеличениеОтгружается.ОбъектРасчетов                             КАК ОбъектРасчетов,
		|	УвеличениеОтгружается.ВалютаВзаиморасчетов                       КАК Валюта,
		|	
		|	0                                                                КАК Сумма,
		|	0                                                                КАК КОплате,
		|	0                                                                КАК Оплачивается,
		|	0                                                                КАК КОтгрузке,
		|	(УвеличениеОтгружается.УвеличитьОтгружается)                     КАК Отгружается,
		|	
		|	УвеличениеОтгружается.ХозяйственнаяОперация                      КАК ХозяйственнаяОперация,
		|	Неопределено                                                     КАК ФормаОплаты,
		|	Неопределено                                                     КАК СчетНаОплату,
		|	Неопределено                                                     КАК ПродажаПоЗаказу,
		|	УвеличениеОтгружается.ДатаРегистратора                           КАК ДатаРегистратора,
		|	ДАТАВРЕМЯ(1,1,1)                                                 КАК ДатаПлатежа,
		|	0                                                                КАК СуммаРегл,
		|	0                                                                КАК СуммаУпр,
		|	ИСТИНА                                                           КАК ИсключатьПриКонтроле,
		|	ЕСТЬNULL(ДанныеДоговора.ДопустимаяСуммаЗадолженности, 0)         КАК ДопустимаяСуммаЗадолженности,
		|	0                                                                КАК ЗалогЗаТару,
		|	Неопределено                                                     КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                                     КАК РасчетныйДокумент,
		|	Неопределено                                                     КАК СвязанныйДокумент,
		|	Неопределено                                                     КАК ВариантОплаты,
		|	УвеличениеОтгружается.ВалютаДокумента                            КАК ВалютаДокумента,
		|	Неопределено                                                     КАК КорОбъектРасчетов,
		|	Неопределено                                                     КАК КорАналитикаУчетаПоПартнерам,
		|	              
		|	ВЫБОР КОГДА ЕСТЬNULL(ДанныеДоговора.ЦентрализованныйДоговор, Ложь)
		|		ТОГДА УвеличениеОтгружается.Организация
		|		ИНАЧЕ УвеличениеОтгружается.ОбъектРасчетов.Организация
		|	КОНЕЦ                                                            КАК Организация,
		|	УвеличениеОтгружается.Партнер                                    КАК Партнер,
		|	УвеличениеОтгружается.ОбъектРасчетов.Контрагент                  КАК Контрагент,
		|	УвеличениеОтгружается.ОбъектРасчетов.Договор                     КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики                     КАК НаправлениеДеятельности,
		|	Неопределено                                                     КАК КорПартнер,
		|	Неопределено                                                     КАК КорОрганизация,
		|	Неопределено                                                     КАК КорКонтрагент,
		|	Неопределено                                                     КАК КорДоговор,
		|	Неопределено                                                     КАК КорНаправлениеДеятельности,
		|	УвеличениеОтгружается.НомерРегистратора                          КАК НомерРегистратора,
		|	&ИдентификаторНеиспользуемойФинЗаписи                            КАК ИдентификаторФинЗаписи,
		|	Неопределено                                                     КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	&Вид                                                             КАК Вид,
		|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПустаяСсылка) КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                                     КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                                     КАК ОбъектРасчетовПриемник,
		|	Неопределено                                                     КАК ВалютаПриемник,
		|	Неопределено                                                     КАК ПартнерПриемник,
		|	Неопределено                                                     КАК ОрганизацияПриемник,
		|	Неопределено                                                     КАК КонтрагентПриемник,
		|	Неопределено                                                     КАК ДоговорПриемник,
		|	Неопределено                                                     КАК НаправлениеДеятельностиПриемник,
		|	0                                                                КАК СуммаПриемник,
		|	ЛОЖЬ                                                             КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#УвеличениеОтгружается КАК УвеличениеОтгружается
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО УвеличениеОтгружается.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка = УвеличениеОтгружается.ОбъектРасчетов.Договор
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|			ПО ВЫБОР КОГДА ЕСТЬNULL(ДанныеДоговора.ЦентрализованныйДоговор, Ложь)
		|					ТОГДА УвеличениеОтгружается.Организация
		|					ИНАЧЕ УвеличениеОтгружается.ОбъектРасчетов.Организация
		|				КОНЕЦ = Аналитика.Организация
		|				И УвеличениеОтгружается.ОбъектРасчетов.Контрагент = Аналитика.Контрагент
		|				И УвеличениеОтгружается.Партнер = Аналитика.Партнер
		|				И УвеличениеОтгружается.ОбъектРасчетов.Договор = Аналитика.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|ГДЕ
		|	УвеличениеОтгружается.УвеличитьОтгружается <> 0 
		|	И (&ЭтоЗаказ И УвеличениеОтгружается.ПорядокРасчетов <> ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоНакладным)
		|		ИЛИ &ЭтоНакладная И (УвеличениеОтгружается.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоНакладным)
		|			ИЛИ НЕ &НакладнаяПоЗаказам))
		|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЭтоЗаказ", ЭтоЗаказ);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЭтоНакладная", ЭтоНакладная);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&НакладнаяПоЗаказам", НакладнаяПоЗаказам);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&Вид", Вид);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция УменьшитьОтгружается(Запрос)
	
	ТекстЗапроса = "ВЫБРАТЬ
		|	УменьшениеОтгружается.ДатаРегистратора                           КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                           КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)                  КАК АналитикаУчетаПоПартнерам,
		|	УменьшениеОтгружается.ОбъектРасчетов                             КАК ОбъектРасчетов,
		|	УменьшениеОтгружается.ВалютаВзаиморасчетов                       КАК Валюта,
		|	
		|	0                                                                КАК Сумма,
		|	0                                                                КАК КОплате,
		|	0                                                                КАК Оплачивается,
		|	0                                                                КАК КОтгрузке,
		|	(УменьшениеОтгружается.УменьшитьОтгружается)                     КАК Отгружается,
		|	
		|	УменьшениеОтгружается.ХозяйственнаяОперация                      КАК ХозяйственнаяОперация,
		|	Неопределено                                                     КАК ФормаОплаты,
		|	Неопределено                                                     КАК СчетНаОплату,
		|	УменьшениеОтгружается.ЗаказПродажи                               КАК ПродажаПоЗаказу,
		|	УменьшениеОтгружается.ДатаРегистратора                           КАК ДатаРегистратора,
		|	УменьшениеОтгружается.ДатаРегистратора                           КАК ДатаПлатежа,
		|	0                                                                КАК СуммаРегл,
		|	0                                                                КАК СуммаУпр,
		|	ИСТИНА                                                           КАК ИсключатьПриКонтроле,
		|	ЕСТЬNULL(ДанныеДоговора.ДопустимаяСуммаЗадолженности, 0)         КАК ДопустимаяСуммаЗадолженности,
		|	0                                                                КАК ЗалогЗаТару,
		|	Неопределено                                                     КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                                     КАК РасчетныйДокумент,
		|	Неопределено                                                     КАК СвязанныйДокумент,
		|	Неопределено                                                     КАК ВариантОплаты,
		|	УменьшениеОтгружается.ВалютаДокумента                            КАК ВалютаДокумента,
		|	Неопределено                                                     КАК КорОбъектРасчетов,
		|	Неопределено                                                     КАК КорАналитикаУчетаПоПартнерам,
		|	   
		|	ВЫБОР КОГДА ЕСТЬNULL(ДанныеДоговора.ЦентрализованныйДоговор, Ложь)
		|		ТОГДА УменьшениеОтгружается.Организация
		|		ИНАЧЕ УменьшениеОтгружается.ОбъектРасчетов.Организация
		|	КОНЕЦ                                                            КАК Организация,
		|	УменьшениеОтгружается.Партнер                                    КАК Партнер,
		|	УменьшениеОтгружается.ОбъектРасчетов.Контрагент                  КАК Контрагент,
		|	УменьшениеОтгружается.ОбъектРасчетов.Договор                     КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики                     КАК НаправлениеДеятельности,
		|	Неопределено                                                     КАК КорПартнер,
		|	Неопределено                                                     КАК КорОрганизация,
		|	Неопределено                                                     КАК КорКонтрагент,
		|	Неопределено                                                     КАК КорДоговор,
		|	Неопределено                                                     КАК КорНаправлениеДеятельности,
		|	УменьшениеОтгружается.НомерРегистратора                          КАК НомерРегистратора,
		|	&ИдентификаторНеиспользуемойФинЗаписи                            КАК ИдентификаторФинЗаписи,
		|	Неопределено                                                     КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	""2""                                                            КАК Вид,
		|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПустаяСсылка) КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                                     КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                                     КАК ОбъектРасчетовПриемник,
		|	Неопределено                                                     КАК ВалютаПриемник,
		|	Неопределено                                                     КАК ПартнерПриемник,
		|	Неопределено                                                     КАК ОрганизацияПриемник,
		|	Неопределено                                                     КАК КонтрагентПриемник,
		|	Неопределено                                                     КАК ДоговорПриемник,
		|	Неопределено                                                     КАК НаправлениеДеятельностиПриемник,
		|	0                                                                КАК СуммаПриемник,
		|	ЛОЖЬ                                                             КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#УменьшениеОтгружается КАК УменьшениеОтгружается
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО УменьшениеОтгружается.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка = УменьшениеОтгружается.ОбъектРасчетов.Договор
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|			ПО ВЫБОР КОГДА ЕСТЬNULL(ДанныеДоговора.ЦентрализованныйДоговор, Ложь)
		|					ТОГДА УменьшениеОтгружается.Организация
		|					ИНАЧЕ УменьшениеОтгружается.ОбъектРасчетов.Организация
		|				КОНЕЦ = Аналитика.Организация
		|				И УменьшениеОтгружается.ОбъектРасчетов.Контрагент = Аналитика.Контрагент
		|				И УменьшениеОтгружается.Партнер = Аналитика.Партнер
		|				И УменьшениеОтгружается.ОбъектРасчетов.Договор = Аналитика.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказКлиента КАК ДокументЗаказКлиента
		|			ПО УменьшениеОтгружается.ЗаказПродажи = ДокументЗаказКлиента.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаявкаНаВозвратТоваровОтКлиента КАК ДокументЗаявкаНаВозвратТоваровОтКлиента
		|			ПО УменьшениеОтгружается.ЗаказПродажи = ДокументЗаявкаНаВозвратТоваровОтКлиента.Ссылка
		|ГДЕ
		|	УменьшениеОтгружается.УменьшитьОтгружается <> 0
		|	И (УменьшениеОтгружается.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказам)
		|		ИЛИ УменьшениеОтгружается.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов)
		|			И НЕ ДанныеДоговора.ЗаданГрафикИсполнения)
		|	И УменьшениеОтгружается.НакладнаяПоЗаказам
		|	И НЕ ЕСТЬNULL(ЕСТЬNULL(ДокументЗаказКлиента.ЭтоЗаказКакСчет, ДокументЗаявкаНаВозвратТоваровОтКлиента.ЭтоЗаказКакСчет), ЛОЖЬ)
		|	И НЕ УменьшениеОтгружается.СверхЗаказа
		|
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	УменьшениеОтгружается.ДатаРегистратора                           КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                           КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)                  КАК АналитикаУчетаПоПартнерам,
		|	УменьшениеОтгружается.ЗаказПродажи.ОбъектРасчетов                КАК ОбъектРасчетов,
		|	УменьшениеОтгружается.ВалютаВзаиморасчетов                       КАК Валюта,
		|	
		|	0                                                                КАК Сумма,
		|	0                                                                КАК КОплате,
		|	0                                                                КАК Оплачивается,
		|	0                                                                КАК КОтгрузке,
		|	(УменьшениеОтгружается.УменьшитьОтгружается)                     КАК Отгружается,
		|	
		|	УменьшениеОтгружается.ХозяйственнаяОперация                      КАК ХозяйственнаяОперация,
		|	Неопределено                                                     КАК ФормаОплаты,
		|	Неопределено                                                     КАК СчетНаОплату,
		|	УменьшениеОтгружается.ЗаказПродажи                               КАК ПродажаПоЗаказу,
		|	УменьшениеОтгружается.ДатаРегистратора                           КАК ДатаРегистратора,
		|	УменьшениеОтгружается.ДатаРегистратора                           КАК ДатаПлатежа,
		|	0                                                                КАК СуммаРегл,
		|	0                                                                КАК СуммаУпр,
		|	ИСТИНА                                                           КАК ИсключатьПриКонтроле,
		|	ЕСТЬNULL(ДанныеДоговора.ДопустимаяСуммаЗадолженности, 0)         КАК ДопустимаяСуммаЗадолженности,
		|	0                                                                КАК ЗалогЗаТару,
		|	Неопределено                                                     КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                                     КАК РасчетныйДокумент,
		|	Неопределено                                                     КАК СвязанныйДокумент,
		|	Неопределено                                                     КАК ВариантОплаты,
		|	УменьшениеОтгружается.ВалютаДокумента                            КАК ВалютаДокумента,
		|	Неопределено                                                     КАК КорОбъектРасчетов,
		|	Неопределено                                                     КАК КорАналитикаУчетаПоПартнерам,
		|	 
		|	УменьшениеОтгружается.ЗаказПродажи.ОбъектРасчетов.Организация    КАК Организация,
		|	УменьшениеОтгружается.ЗаказПродажи.ОбъектРасчетов.Партнер        КАК Партнер,
		|	УменьшениеОтгружается.ЗаказПродажи.ОбъектРасчетов.Контрагент     КАК Контрагент,
		|	УменьшениеОтгружается.ЗаказПродажи.ОбъектРасчетов.Договор        КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики                     КАК НаправлениеДеятельности,
		|	Неопределено                                                     КАК КорПартнер,
		|	Неопределено                                                     КАК КорОрганизация,
		|	Неопределено                                                     КАК КорКонтрагент,
		|	Неопределено                                                     КАК КорДоговор,
		|	Неопределено                                                     КАК КорНаправлениеДеятельности,
		|	УменьшениеОтгружается.НомерРегистратора                          КАК НомерРегистратора,
		|	&ИдентификаторНеиспользуемойФинЗаписи                            КАК ИдентификаторФинЗаписи,
		|	Неопределено                                                     КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	""2""                                                            КАК Вид,
		|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПустаяСсылка) КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                                     КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                                     КАК ОбъектРасчетовПриемник,
		|	Неопределено                                                     КАК ВалютаПриемник,
		|	Неопределено                                                     КАК ПартнерПриемник,
		|	Неопределено                                                     КАК ОрганизацияПриемник,
		|	Неопределено                                                     КАК КонтрагентПриемник,
		|	Неопределено                                                     КАК ДоговорПриемник,
		|	Неопределено                                                     КАК НаправлениеДеятельностиПриемник,
		|	0                                                                КАК СуммаПриемник,
		|	ЛОЖЬ                                                             КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#УменьшениеОтгружается КАК УменьшениеОтгружается
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО УменьшениеОтгружается.ЗаказПродажи.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка = УменьшениеОтгружается.ОбъектРасчетов.Договор
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|			ПО УменьшениеОтгружается.ЗаказПродажи.ОбъектРасчетов.Организация = Аналитика.Организация
		|				И УменьшениеОтгружается.ЗаказПродажи.ОбъектРасчетов.Контрагент = Аналитика.Контрагент
		|				И УменьшениеОтгружается.ЗаказПродажи.ОбъектРасчетов.Партнер = Аналитика.Партнер
		|				И УменьшениеОтгружается.ЗаказПродажи.ОбъектРасчетов.Договор = Аналитика.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказКлиента КАК ДокументЗаказКлиента
		|			ПО УменьшениеОтгружается.ЗаказПродажи = ДокументЗаказКлиента.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаявкаНаВозвратТоваровОтКлиента КАК ДокументЗаявкаНаВозвратТоваровОтКлиента
		|			ПО УменьшениеОтгружается.ЗаказПродажи = ДокументЗаявкаНаВозвратТоваровОтКлиента.Ссылка
		|ГДЕ
		|	УменьшениеОтгружается.УменьшитьОтгружается <> 0
		|	И УменьшениеОтгружается.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
		|	И УменьшениеОтгружается.НакладнаяПоЗаказам
		|	И НЕ ЕСТЬNULL(ЕСТЬNULL(ДокументЗаказКлиента.ЭтоЗаказКакСчет, ДокументЗаявкаНаВозвратТоваровОтКлиента.ЭтоЗаказКакСчет), ЛОЖЬ)
		|	И НЕ УменьшениеОтгружается.СверхЗаказа
		|
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	УменьшениеОтгружается.ДатаРегистратора                           КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                           КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)                  КАК АналитикаУчетаПоПартнерам,
		|	ДанныеДоговора.ОбъектРасчетов                                    КАК ОбъектРасчетов,
		|	УменьшениеОтгружается.ВалютаВзаиморасчетов                       КАК Валюта,
		|	
		|	0                                                                КАК Сумма,
		|	0                                                                КАК КОплате,
		|	0                                                                КАК Оплачивается,
		|	0                                                                КАК КОтгрузке,
		|	(УменьшениеОтгружается.УменьшитьОтгружается)                     КАК Отгружается,
		|	
		|	УменьшениеОтгружается.ХозяйственнаяОперация                      КАК ХозяйственнаяОперация,
		|	Неопределено                                                     КАК ФормаОплаты,
		|	Неопределено                                                     КАК СчетНаОплату,
		|	УменьшениеОтгружается.ЗаказПродажи                               КАК ПродажаПоЗаказу,
		|	УменьшениеОтгружается.ДатаРегистратора                           КАК ДатаРегистратора,
		|	УменьшениеОтгружается.ДатаРегистратора                           КАК ДатаПлатежа,
		|	0                                                                КАК СуммаРегл,
		|	0                                                                КАК СуммаУпр,
		|	ИСТИНА                                                           КАК ИсключатьПриКонтроле,
		|	ЕСТЬNULL(ДанныеДоговора.ДопустимаяСуммаЗадолженности, 0)         КАК ДопустимаяСуммаЗадолженности,
		|	0                                                                КАК ЗалогЗаТару,
		|	Неопределено                                                     КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                                     КАК РасчетныйДокумент,
		|	Неопределено                                                     КАК СвязанныйДокумент,
		|	Неопределено                                                     КАК ВариантОплаты,
		|	УменьшениеОтгружается.ВалютаДокумента                            КАК ВалютаДокумента,
		|	Неопределено                                                     КАК КорОбъектРасчетов,
		|	Неопределено                                                     КАК КорАналитикаУчетаПоПартнерам,
		|	  
		|	ДанныеДоговора.ОбъектРасчетов.Организация                        КАК Организация,
		|	УменьшениеОтгружается.Партнер                                    КАК Партнер,
		|	ДанныеДоговора.ОбъектРасчетов.Контрагент                         КАК Контрагент,
		|	ДанныеДоговора.ОбъектРасчетов.Договор                            КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики                     КАК НаправлениеДеятельности,
		|	Неопределено                                                     КАК КорПартнер,
		|	Неопределено                                                     КАК КорОрганизация,
		|	Неопределено                                                     КАК КорКонтрагент,
		|	Неопределено                                                     КАК КорДоговор,
		|	Неопределено                                                     КАК КорНаправлениеДеятельности,
		|	УменьшениеОтгружается.НомерРегистратора                          КАК НомерРегистратора,
		|	&ИдентификаторНеиспользуемойФинЗаписи                            КАК ИдентификаторФинЗаписи,
		|	Неопределено                                                     КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	""2""                                                            КАК Вид,
		|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПустаяСсылка) КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                                     КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                                     КАК ОбъектРасчетовПриемник,
		|	Неопределено                                                     КАК ВалютаПриемник,
		|	Неопределено                                                     КАК ПартнерПриемник,
		|	Неопределено                                                     КАК ОрганизацияПриемник,
		|	Неопределено                                                     КАК КонтрагентПриемник,
		|	Неопределено                                                     КАК ДоговорПриемник,
		|	Неопределено                                                     КАК НаправлениеДеятельностиПриемник,
		|	0                                                                КАК СуммаПриемник,
		|	ЛОЖЬ                                                             КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#УменьшениеОтгружается КАК УменьшениеОтгружается
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка = УменьшениеОтгружается.ОбъектРасчетов.Договор
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО ДанныеДоговора.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|			ПО ДанныеДоговора.ОбъектРасчетов.Организация = Аналитика.Организация
		|				И ДанныеДоговора.ОбъектРасчетов.Контрагент = Аналитика.Контрагент
		|				И УменьшениеОтгружается.Партнер = Аналитика.Партнер
		|				И ДанныеДоговора.ОбъектРасчетов.Договор = Аналитика.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказКлиента КАК ДокументЗаказКлиента
		|			ПО УменьшениеОтгружается.ЗаказПродажи = ДокументЗаказКлиента.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаявкаНаВозвратТоваровОтКлиента КАК ДокументЗаявкаНаВозвратТоваровОтКлиента
		|			ПО УменьшениеОтгружается.ЗаказПродажи = ДокументЗаявкаНаВозвратТоваровОтКлиента.Ссылка
		|ГДЕ
		|	УменьшениеОтгружается.УменьшитьОтгружается <> 0
		|	И УменьшениеОтгружается.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
		|	И НЕ ДанныеДоговора.ЗаданГрафикИсполнения
		|	И УменьшениеОтгружается.НакладнаяПоЗаказам
		|	И НЕ ЕСТЬNULL(ЕСТЬNULL(ДокументЗаказКлиента.ЭтоЗаказКакСчет, ДокументЗаявкаНаВозвратТоваровОтКлиента.ЭтоЗаказКакСчет), ЛОЖЬ)
		|	И НЕ УменьшениеОтгружается.СверхЗаказа
		|";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция УвеличитьПланОтгрузкиКлиенту(Запрос, Операция)
	
	Если Операция = "ГрафикИсполненияКлиент" Тогда
		
		ЭтоЗаказ = "ЛОЖЬ";
		ЭтоНакладная = "ЛОЖЬ";
		ПорядокРасчетов = "ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов)";
		ДатаПлатежа = "ДАТАВРЕМЯ(1,1,1)";
		Вид = "1";
		
	ИначеЕсли Операция = "ЗаказКлиента" Тогда
		
		ЭтоЗаказ = "ИСТИНА";
		ЭтоНакладная = "ЛОЖЬ";
		ПорядокРасчетов = "УвеличениеПланаОтгрузкиКлиенту.ПорядокРасчетов";
		ДатаПлатежа = "ДАТАВРЕМЯ(1,1,1)";
		Вид = "1";
		
	ИначеЕсли Операция = "Продажа" Тогда
		
		ЭтоЗаказ = "ЛОЖЬ";
		ЭтоНакладная = "ИСТИНА";
		ПорядокРасчетов = "УвеличениеПланаОтгрузкиКлиенту.ПорядокРасчетов";
		ДатаПлатежа = "УвеличениеПланаОтгрузкиКлиенту.ДатаРегистратора";
		Вид = "2";
		
	КонецЕсли;
	
	ТекстЗапроса = 
		"ВЫБРАТЬ
		|	УвеличениеПланаОтгрузкиКлиенту.ДатаОтгрузки                      КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                           КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)                  КАК АналитикаУчетаПоПартнерам,
		|	УвеличениеПланаОтгрузкиКлиенту.ОбъектРасчетов                    КАК ОбъектРасчетов,
		|	УвеличениеПланаОтгрузкиКлиенту.ВалютаВзаиморасчетов              КАК Валюта,
		|	
		|	0                                                                КАК Сумма,
		|	0                                                                КАК КОплате,
		|	0                                                                КАК Оплачивается,
		|	УвеличениеПланаОтгрузкиКлиенту.УвеличитьКОтгрузке                КАК КОтгрузке,
		|	0                                                                КАК Отгружается,
		|
		|	УвеличениеПланаОтгрузкиКлиенту.ХозяйственнаяОперация             КАК ХозяйственнаяОперация,
		|	Неопределено                                                     КАК ФормаОплаты,
		|	Неопределено                                                     КАК СчетНаОплату,
		|	УвеличениеПланаОтгрузкиКлиенту.ЗаказПродажи                      КАК ПродажаПоЗаказу,
		|	УвеличениеПланаОтгрузкиКлиенту.ДатаРегистратора                  КАК ДатаРегистратора,
		|	&ДатаПлатежа                                                     КАК ДатаПлатежа,
		|	0                                                                КАК СуммаРегл,
		|	0                                                                КАК СуммаУпр,
		|	ИСТИНА                                                           КАК ИсключатьПриКонтроле,
		|	УвеличениеПланаОтгрузкиКлиенту.ДопустимаяСуммаЗадолженности      КАК ДопустимаяСуммаЗадолженности,
		|	0                                                                КАК ЗалогЗаТару,
		|	Неопределено                                                     КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                                     КАК РасчетныйДокумент,
		|	Неопределено                                                     КАК СвязанныйДокумент,
		|	Неопределено                                                     КАК ВариантОплаты,
		|	УвеличениеПланаОтгрузкиКлиенту.ВалютаДокумента                   КАК ВалютаДокумента,
		|	Неопределено                                                     КАК КорОбъектРасчетов,
		|	Неопределено                                                     КАК КорАналитикаУчетаПоПартнерам,
		|
		|	УвеличениеПланаОтгрузкиКлиенту.Организация                       КАК Организация,
		|	УвеличениеПланаОтгрузкиКлиенту.Партнер                           КАК Партнер,
		|	УвеличениеПланаОтгрузкиКлиенту.Контрагент                        КАК Контрагент,
		|	УвеличениеПланаОтгрузкиКлиенту.Договор                           КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики                     КАК НаправлениеДеятельности,
		|	Неопределено                                                     КАК КорПартнер,
		|	Неопределено                                                     КАК КорОрганизация,
		|	Неопределено                                                     КАК КорКонтрагент,
		|	Неопределено                                                     КАК КорДоговор,
		|	Неопределено                                                     КАК КорНаправлениеДеятельности,
		|	УвеличениеПланаОтгрузкиКлиенту.НомерРегистратора                 КАК НомерРегистратора,
		|	&ИдентификаторНеиспользуемойФинЗаписи                            КАК ИдентификаторФинЗаписи,
		|	Неопределено                                                     КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	&Вид                                                             КАК Вид,
		|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПустаяСсылка) КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                                     КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                                     КАК ОбъектРасчетовПриемник,
		|	Неопределено                                                     КАК ВалютаПриемник,
		|	Неопределено                                                     КАК ПартнерПриемник,
		|	Неопределено                                                     КАК ОрганизацияПриемник,
		|	Неопределено                                                     КАК КонтрагентПриемник,
		|	Неопределено                                                     КАК ДоговорПриемник,
		|	Неопределено                                                     КАК НаправлениеДеятельностиПриемник,
		|	0                                                                КАК СуммаПриемник,
		|	ЛОЖЬ                                                             КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	ВтУвеличениеПланаОтгрузкиКлиенту КАК УвеличениеПланаОтгрузкиКлиенту
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО УвеличениеПланаОтгрузкиКлиенту.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|			ПО УвеличениеПланаОтгрузкиКлиенту.Организация = Аналитика.Организация
		|				И УвеличениеПланаОтгрузкиКлиенту.Контрагент = Аналитика.Контрагент
		|				И УвеличениеПланаОтгрузкиКлиенту.Партнер = Аналитика.Партнер
		|				И УвеличениеПланаОтгрузкиКлиенту.Договор = Аналитика.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|ГДЕ
		|	НЕ (&ЭтоЗаказ
		|			И УвеличениеПланаОтгрузкиКлиенту.ЗаданГрафикИсполнения 
		|			И &ПорядокРасчетов В (ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов),
		|									ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным))
		|		ИЛИ &ЭтоНакладная
		|			И НЕ УвеличениеПланаОтгрузкиКлиенту.СверхЗаказа
		|			И УвеличениеПланаОтгрузкиКлиенту.ЗаданГрафикИсполнения
		|			И &ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов))
		|	И УвеличениеПланаОтгрузкиКлиенту.УвеличитьКОтгрузке <> 0
		|	И (&ЭтоЗаказ 
		|			И &ПорядокРасчетов <> ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоНакладным)
		|		ИЛИ УвеличениеПланаОтгрузкиКлиенту.НакладнаяПоЗаказам
		|			И &ПорядокРасчетов <> ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоНакладным)
		|			И УвеличениеПланаОтгрузкиКлиенту.СверхЗаказа
		|			И НЕ УвеличениеПланаОтгрузкиКлиенту.ЭтоЗаказКакСчет
		|		ИЛИ НЕ (&ЭтоЗаказ ИЛИ &ЭтоНакладная))
		|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЭтоЗаказ",           ЭтоЗаказ);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЭтоНакладная",       ЭтоНакладная);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ПорядокРасчетов",    ПорядокРасчетов);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ДатаПлатежа",        ДатаПлатежа);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&Вид",                Вид);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция УменьшитьПланОтгрузкиКлиенту(Запрос)
	
	ТекстКОтгрузке = "
		|ВЫБРАТЬ
		|	УменьшениеПланаОтгрузкиКлиенту.ДатаРегистратора                  КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)                           КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)                  КАК АналитикаУчетаПоПартнерам,
		|	УменьшениеПланаОтгрузкиКлиенту.ОбъектРасчетов                    КАК ОбъектРасчетов,
		|	УменьшениеПланаОтгрузкиКлиенту.ВалютаВзаиморасчетов              КАК Валюта,
		|	
		|	0                                                                КАК Сумма,
		|	0                                                                КАК КОплате,
		|	0                                                                КАК Оплачивается,
		|	УменьшениеПланаОтгрузкиКлиенту.УменьшитьКОтгрузке                КАК КОтгрузке,
		|	0                                                                КАК Отгружается,
		|	
		|	УменьшениеПланаОтгрузкиКлиенту.ХозяйственнаяОперация             КАК ХозяйственнаяОперация,
		|	Неопределено                                                     КАК ФормаОплаты,
		|	Неопределено                                                     КАК СчетНаОплату,
		|	УменьшениеПланаОтгрузкиКлиенту.ЗаказПродажи                      КАК ПродажаПоЗаказу,
		|	УменьшениеПланаОтгрузкиКлиенту.ДатаРегистратора                  КАК ДатаРегистратора,
		|	УменьшениеПланаОтгрузкиКлиенту.ДатаРегистратора                  КАК ДатаПлатежа,
		|	0                                                                КАК СуммаРегл,
		|	0                                                                КАК СуммаУпр,
		|	ИСТИНА                                                           КАК ИсключатьПриКонтроле,
		|	УменьшениеПланаОтгрузкиКлиенту.ДопустимаяСуммаЗадолженности      КАК ДопустимаяСуммаЗадолженности,
		|	0                                                                КАК ЗалогЗаТару,
		|	Неопределено                                                     КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                                     КАК РасчетныйДокумент,
		|	Неопределено                                                     КАК СвязанныйДокумент,
		|	Неопределено                                                     КАК ВариантОплаты,
		|	УменьшениеПланаОтгрузкиКлиенту.ВалютаДокумента                   КАК ВалютаДокумента,
		|	Неопределено                                                     КАК КорОбъектРасчетов,
		|	Неопределено                                                     КАК КорАналитикаУчетаПоПартнерам,
		|	
		|	УменьшениеПланаОтгрузкиКлиенту.Организация                       КАК Организация,
		|	УменьшениеПланаОтгрузкиКлиенту.Партнер                           КАК Партнер,
		|	УменьшениеПланаОтгрузкиКлиенту.Контрагент                        КАК Контрагент,
		|	УменьшениеПланаОтгрузкиКлиенту.Договор                           КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики                     КАК НаправлениеДеятельности,
		|	Неопределено                                                     КАК КорПартнер,
		|	Неопределено                                                     КАК КорОрганизация,
		|	Неопределено                                                     КАК КорКонтрагент,
		|	Неопределено                                                     КАК КорДоговор,
		|	Неопределено                                                     КАК КорНаправлениеДеятельности,
		|	УменьшениеПланаОтгрузкиКлиенту.НомерРегистратора                 КАК НомерРегистратора,
		|	&ИдентификаторНеиспользуемойФинЗаписи                            КАК ИдентификаторФинЗаписи,
		|	Неопределено                                                     КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	""2""                                                            КАК Вид,
		|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПустаяСсылка) КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                                     КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                                     КАК ОбъектРасчетовПриемник,
		|	Неопределено                                                     КАК ВалютаПриемник,
		|	Неопределено                                                     КАК ПартнерПриемник,
		|	Неопределено                                                     КАК ОрганизацияПриемник,
		|	Неопределено                                                     КАК КонтрагентПриемник,
		|	Неопределено                                                     КАК ДоговорПриемник,
		|	Неопределено                                                     КАК НаправлениеДеятельностиПриемник,
		|	0                                                                КАК СуммаПриемник,
		|	ЛОЖЬ                                                             КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	ВтУменьшениеПланаОтгрузкиКлиенту КАК УменьшениеПланаОтгрузкиКлиенту
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО УменьшениеПланаОтгрузкиКлиенту.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|			ПО УменьшениеПланаОтгрузкиКлиенту.Организация = Аналитика.Организация
		|				И УменьшениеПланаОтгрузкиКлиенту.Контрагент = Аналитика.Контрагент
		|				И УменьшениеПланаОтгрузкиКлиенту.Партнер = Аналитика.Партнер
		|				И УменьшениеПланаОтгрузкиКлиенту.Договор = Аналитика.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|ГДЕ
		|	(УменьшениеПланаОтгрузкиКлиенту.ЗаданГрафикИсполнения 
		|		И УменьшениеПланаОтгрузкиКлиенту.ПорядокРасчетов В (ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов),
		|		                                                    ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным))
		|	ИЛИ УменьшениеПланаОтгрузкиКлиенту.НакладнаяПоЗаказам 
		|		И НЕ УменьшениеПланаОтгрузкиКлиенту.ЭтоЗаказКакСчет
		|		И (УменьшениеПланаОтгрузкиКлиенту.ПорядокРасчетов В (ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказам),
		|		                                                     ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным))
		|			ИЛИ УменьшениеПланаОтгрузкиКлиенту.ПорядокРасчетов В (ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов),
		|			                                                      ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным))
		|				И НЕ УменьшениеПланаОтгрузкиКлиенту.ЗаданГрафикИсполнения))
		|";
	
	Возврат ТекстКОтгрузке;
	
КонецФункции

#КонецОбласти

#Область РасчетыСПоставщиками

Функция ОтразитьПереносРасчетовСПоставщиком(Запрос, Операция)
	
	Если НЕ Запрос.Параметры.Свойство("ОбъектРасчетовАванс") Тогда
		ОбъектРасчетовАванс = Метаданные.ОпределяемыеТипы.ОбъектРасчетовАванс.Тип.Типы();
		Запрос.УстановитьПараметр("ОбъектРасчетовАванс", ОбъектРасчетовАванс);
	КонецЕсли;
	
	Если Операция = "Закупка" Тогда
		
		КредиторскаяЗадолженность = "ЛОЖЬ"; // что в источнике
		СторноИсточник = "ЛОЖЬ";
		СторноПриемник = "ЛОЖЬ";
		ЗаполнятьПриемникВИсточнике = "ИСТИНА";
		
		УсловиеОперации = "
		|	ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовИсточник <> ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовПриемник";
		
		ХозяйственнаяОперация = "ТаблицаРасшифровкаПлатежаПоставщик.ХозяйственнаяОперация";
		
		ФормаОплаты = "Неопределено";
		
		ОбъектРасчетовИсточникОрганизация = "ОбъектыРасчетовИсточники.Организация";
		ОбъектРасчетовПриемникОрганизация = "ОбъектыРасчетовПриемники.Организация";
	
		ОбъектРасчетовИсточникПартнер = "ОбъектыРасчетовИсточники.Партнер";
		ОбъектРасчетовПриемникПартнер = "ОбъектыРасчетовПриемники.Партнер";
		
		ВалютаВзаиморасчетовИсточник = "ТаблицаРасшифровкаПлатежаПоставщик.ВалютаВзаиморасчетов";
		ВалютаВзаиморасчетовПриемник = "ТаблицаРасшифровкаПлатежаПоставщик.ВалютаВзаиморасчетов";
		
		СуммаВзаиморасчетовИсточник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		СуммаВзаиморасчетовПриемник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		
		КОплатеИсточник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		КОплатеПриемник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		
		ДатаПлатежа = "ТаблицаРасшифровкаПлатежаПоставщик.ДатаРегистратора";
		
		ВариантОплаты = "ЗНАЧЕНИЕ(Перечисление.ВариантыКонтроляОплатыПоставщику.ПредоплатаДоПоступления)";
		СтатьяДвиженияДенежныхСредств = "Неопределено";
	
		ИдентификаторФинЗаписи = "ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовИсточник.УникальныйИдентификатор";
		НастройкаХозяйственнойОперации = "ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПереносАванса)"; 
		
		ВидИсточник = "2";
		ВидПриемник = "2";
		
	ИначеЕсли Операция = "ПереносПлатежа" Тогда
		
		КредиторскаяЗадолженность = "ЛОЖЬ"; // что в источнике
		СторноИсточник = "ЛОЖЬ";
		СторноПриемник = "ЛОЖЬ";
		ЗаполнятьПриемникВИсточнике = "ИСТИНА";
		
		УсловиеОперации = "ТаблицаРасшифровкаПлатежаПоставщик.Организация <> ОбъектыРасчетовПриемники.Организация";
		
		ХозяйственнаяОперация = "ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносПлатежаМеждуФилиалами)";

		ФормаОплаты = "Неопределено";
		
		ОбъектРасчетовИсточникОрганизация = "ТаблицаРасшифровкаПлатежаПоставщик.Организация";
		ОбъектРасчетовПриемникОрганизация = "ОбъектыРасчетовПриемники.Организация";
		
		ОбъектРасчетовИсточникПартнер = "ТаблицаРасшифровкаПлатежаПоставщик.Партнер";
		ОбъектРасчетовПриемникПартнер = "ТаблицаРасшифровкаПлатежаПоставщик.Партнер";
		
		ВалютаВзаиморасчетовИсточник = "ТаблицаРасшифровкаПлатежаПоставщик.ВалютаВзаиморасчетов";
		ВалютаВзаиморасчетовПриемник = "ТаблицаРасшифровкаПлатежаПоставщик.ВалютаВзаиморасчетов";
		
		СуммаВзаиморасчетовИсточник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		СуммаВзаиморасчетовПриемник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		
		КОплатеИсточник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		КОплатеПриемник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		
		ДатаПлатежа = "ТаблицаРасшифровкаПлатежаПоставщик.ДатаРегистратора";
		ВариантОплаты = "ЗНАЧЕНИЕ(Перечисление.ВариантыКонтроляОплатыКлиентом.КредитПослеОтгрузки)";
		СтатьяДвиженияДенежныхСредств = "ТаблицаРасшифровкаПлатежаПоставщик.СтатьяДвиженияДенежныхСредств";
	
		ИдентификаторФинЗаписи = "ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовИсточник.УникальныйИдентификатор";
		НастройкаХозяйственнойОперации = "ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПереносПлатежаМеждуФилиалами)";
		
		ВидИсточник = "4";
		ВидПриемник = "4";
		
	ИначеЕсли Операция = "ПереносВозврата" Тогда
		
		КредиторскаяЗадолженность = "ЛОЖЬ"; // что в источнике
		СторноИсточник = "ЛОЖЬ";
		СторноПриемник = "ЛОЖЬ";
		ЗаполнятьПриемникВИсточнике = "ЛОЖЬ";
		
		УсловиеОперации = "ЕСТЬNULL(ДанныеДоговора.ЦентрализованныйДоговор, ЛОЖЬ)
		|	И ТаблицаРасшифровкаПлатежаПоставщик.Организация <> ОбъектыРасчетовПриемники.Организация";
		
		ХозяйственнаяОперация = "ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносЗадолженностиМеждуФилиалами)";

		ФормаОплаты = "Неопределено";
		
		ОбъектРасчетовИсточникОрганизация = "ТаблицаРасшифровкаПлатежаПоставщик.Организация";
		ОбъектРасчетовПриемникОрганизация = "ОбъектыРасчетовПриемники.Организация";
		
		ОбъектРасчетовИсточникПартнер = "ТаблицаРасшифровкаПлатежаПоставщик.Партнер";
		ОбъектРасчетовПриемникПартнер = "ТаблицаРасшифровкаПлатежаПоставщик.Партнер";
		
		ВалютаВзаиморасчетовИсточник = "ТаблицаРасшифровкаПлатежаПоставщик.ВалютаВзаиморасчетов";
		ВалютаВзаиморасчетовПриемник = "ТаблицаРасшифровкаПлатежаПоставщик.ВалютаВзаиморасчетов";
		
		СуммаВзаиморасчетовИсточник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		СуммаВзаиморасчетовПриемник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		
		КОплатеИсточник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		КОплатеПриемник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		
		ДатаПлатежа = "ТаблицаРасшифровкаПлатежаПоставщик.ДатаРегистратора";
		ВариантОплаты = "ЗНАЧЕНИЕ(Перечисление.ВариантыКонтроляОплатыКлиентом.КредитПослеОтгрузки)";
		СтатьяДвиженияДенежныхСредств = "ТаблицаРасшифровкаПлатежаПоставщик.СтатьяДвиженияДенежныхСредств";
	
		ИдентификаторФинЗаписи = "ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовИсточник.УникальныйИдентификатор";
		НастройкаХозяйственнойОперации = "ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПереносЗадолженностиМеждуФилиалами)";
		
		ВидИсточник = "2";
		ВидПриемник = "2";
		
	ИначеЕсли Операция = "ВозвратОплатыОтПоставщика" Тогда
		
		КредиторскаяЗадолженность = "ЛОЖЬ";
		СторноИсточник = "ИСТИНА";
		СторноПриемник = "ЛОЖЬ";
		ЗаполнятьПриемникВИсточнике = "ИСТИНА";
		
		УсловиеОперации = "ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовИсточник <> ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовПриемник";
		
		ХозяйственнаяОперация = "ТаблицаРасшифровкаПлатежаПоставщик.ХозяйственнаяОперация";
		
		ФормаОплаты = "ТаблицаРасшифровкаПлатежаПоставщик.ФормаОплаты";
		
		ОбъектРасчетовИсточникОрганизация = "ОбъектыРасчетовИсточники.Организация";
		ОбъектРасчетовПриемникОрганизация = "ОбъектыРасчетовПриемники.Организация";
	
		//Возврат оплаты от дочернего партнера, должен пройти по дочернему партнеру, а не по головному
		ОбъектРасчетовИсточникПартнер = "ТаблицаРасшифровкаПлатежаПоставщик.Партнер";
		ОбъектРасчетовПриемникПартнер = "ТаблицаРасшифровкаПлатежаПоставщик.Партнер";
		
		ВалютаВзаиморасчетовИсточник = "ТаблицаРасшифровкаПлатежаПоставщик.ВалютаВзаиморасчетов";
		ВалютаВзаиморасчетовПриемник = "ТаблицаРасшифровкаПлатежаПоставщик.ВалютаВзаиморасчетов";
		
		СуммаВзаиморасчетовИсточник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		СуммаВзаиморасчетовПриемник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		
		КОплатеИсточник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		КОплатеПриемник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		
		ДатаПлатежа = "Неопределено";
		ВариантОплаты = "Неопределено";
		СтатьяДвиженияДенежныхСредств = "ТаблицаРасшифровкаПлатежаПоставщик.СтатьяДвиженияДенежныхСредств";
		
		//Для переноса нужно писать идентификаторы источники из объектов расчетов в расшифровке платежа.
		ИдентификаторФинЗаписи = "ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовИсточник.УникальныйИдентификатор";
		НастройкаХозяйственнойОперации = "ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПереносАванса)";
		
		ВидИсточник = "7";
		ВидПриемник = "6";
		
	ИначеЕсли Операция = "ВозвратТоваровПоставщику" Тогда
		
		КредиторскаяЗадолженность = "ЛОЖЬ";
		СторноИсточник = "ЛОЖЬ";
		СторноПриемник = "ЛОЖЬ";
		ЗаполнятьПриемникВИсточнике = "ЛОЖЬ";
		
		УсловиеОперации = "ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовИсточник <> ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовПриемник";
		
		ХозяйственнаяОперация = "ТаблицаРасшифровкаПлатежаПоставщик.ХозяйственнаяОперация";
		
		ФормаОплаты = "Неопределено";
		
		ОбъектРасчетовИсточникОрганизация = "ОбъектыРасчетовИсточники.Организация";
		ОбъектРасчетовПриемникОрганизация = "ОбъектыРасчетовПриемники.Организация";
	
		ОбъектРасчетовИсточникПартнер = "ОбъектыРасчетовИсточники.Партнер";
		ОбъектРасчетовПриемникПартнер = "ОбъектыРасчетовПриемники.Партнер";
		
		ВалютаВзаиморасчетовИсточник = "ТаблицаРасшифровкаПлатежаПоставщик.ВалютаДокумента";
		ВалютаВзаиморасчетовПриемник = "ТаблицаРасшифровкаПлатежаПоставщик.ВалютаВзаиморасчетов";
		
		СуммаВзаиморасчетовИсточник = "ТаблицаРасшифровкаПлатежаПоставщик.Сумма";
		СуммаВзаиморасчетовПриемник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		
		КОплатеИсточник = "ТаблицаРасшифровкаПлатежаПоставщик.Сумма";
		КОплатеПриемник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		
		ДатаПлатежа = "Неопределено";
		ВариантОплаты = "Неопределено";
		СтатьяДвиженияДенежныхСредств = "Неопределено";
		
		ИдентификаторФинЗаписи = "ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовПриемник.УникальныйИдентификатор";
		НастройкаХозяйственнойОперации = "ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВзаимозачетЗадолженности)";
		
		ВидИсточник = "5";
		ВидПриемник = "6";
		
	ИначеЕсли Операция = "ПереносАвансаПоставщику" Тогда
		КредиторскаяЗадолженность = "ЛОЖЬ";
		СторноИсточник = "ЛОЖЬ";
		СторноПриемник = "ЛОЖЬ";
		ЗаполнятьПриемникВИсточнике = "ИСТИНА";
		
		УсловиеОперации = "ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовИсточник <> ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовПриемник";
		
		ХозяйственнаяОперация = "ТаблицаРасшифровкаПлатежаПоставщик.ХозяйственнаяОперация";
		
		ФормаОплаты = "ЗНАЧЕНИЕ(Перечисление.ФормыОплаты.Взаимозачет)";
		
		ОбъектРасчетовИсточникОрганизация = "ОбъектыРасчетовИсточники.Организация";
		ОбъектРасчетовПриемникОрганизация = "ОбъектыРасчетовПриемники.Организация";
	
		ОбъектРасчетовИсточникПартнер = "ОбъектыРасчетовИсточники.Партнер";
		ОбъектРасчетовПриемникПартнер = "ОбъектыРасчетовПриемники.Партнер";
		
		ВалютаВзаиморасчетовИсточник = "ОбъектыРасчетовИсточники.ВалютаВзаиморасчетов";
		ВалютаВзаиморасчетовПриемник = "ОбъектыРасчетовПриемники.ВалютаВзаиморасчетов";
		
		СуммаВзаиморасчетовИсточник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		СуммаВзаиморасчетовПриемник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		
		КОплатеИсточник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		КОплатеПриемник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		
		ДатаПлатежа = "ТаблицаРасшифровкаПлатежаПоставщик.ДатаПлатежа";
		ВариантОплаты = "Неопределено";
		СтатьяДвиженияДенежныхСредств = "ТаблицаРасшифровкаПлатежаПоставщик.СтатьяДвиженияДенежныхСредств";
		
		ИдентификаторФинЗаписи = "ТаблицаРасшифровкаПлатежаПоставщик.ИдентификаторФинЗаписи";
		НастройкаХозяйственнойОперации = "ТаблицаРасшифровкаПлатежаПоставщик.НастройкаХозяйственнойОперации";
		
		ВидИсточник = "5";
		ВидПриемник = "6";
		
	ИначеЕсли Операция = "ВозвратПереносаАвансаПоставщику" Тогда
		КредиторскаяЗадолженность = "ЛОЖЬ";
		СторноИсточник = "ИСТИНА";
		СторноПриемник = "ИСТИНА";
		ЗаполнятьПриемникВИсточнике = "ИСТИНА";
		
		УсловиеОперации = "ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовИсточник <> ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовПриемник";
		
		ХозяйственнаяОперация = "ТаблицаРасшифровкаПлатежаПоставщик.ХозяйственнаяОперация";
		
		ФормаОплаты = "ЗНАЧЕНИЕ(Перечисление.ФормыОплаты.Взаимозачет)";
		
		ОбъектРасчетовИсточникОрганизация = "ОбъектыРасчетовИсточники.Организация";
		ОбъектРасчетовПриемникОрганизация = "ОбъектыРасчетовПриемники.Организация";
	
		ОбъектРасчетовИсточникПартнер = "ОбъектыРасчетовИсточники.Партнер";
		ОбъектРасчетовПриемникПартнер = "ОбъектыРасчетовПриемники.Партнер";
		
		ВалютаВзаиморасчетовИсточник = "ОбъектыРасчетовИсточники.ВалютаВзаиморасчетов";
		ВалютаВзаиморасчетовПриемник = "ОбъектыРасчетовПриемники.ВалютаВзаиморасчетов";
		
		СуммаВзаиморасчетовИсточник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		СуммаВзаиморасчетовПриемник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		
		КОплатеИсточник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		КОплатеПриемник = "ТаблицаРасшифровкаПлатежаПоставщик.СуммаВзаиморасчетов";
		
		ДатаПлатежа = "ТаблицаРасшифровкаПлатежаПоставщик.ДатаПлатежа";
		ВариантОплаты = "Неопределено";
		СтатьяДвиженияДенежныхСредств = "ТаблицаРасшифровкаПлатежаПоставщик.СтатьяДвиженияДенежныхСредств";
		
		ИдентификаторФинЗаписи = "ТаблицаРасшифровкаПлатежаПоставщик.ИдентификаторФинЗаписи";
		НастройкаХозяйственнойОперации = "ТаблицаРасшифровкаПлатежаПоставщик.НастройкаХозяйственнойОперации";
		
		ВидИсточник = "5";
		ВидПриемник = "6";
		
	КонецЕсли;
	
	#Область ТекстЗапроса
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ТаблицаРасшифровкаПлатежаПоставщик.ДатаРегистратора       КАК Период,
		|	ВЫБОР
		|		КОГДА НЕ &СторноИсточник И &КредиторскаяЗадолженность
		|			ИЛИ &СторноИсточник И НЕ &КредиторскаяЗадолженность
		|			ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ                                                     КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(АналитикаИсточник.КлючАналитики, Неопределено)   КАК АналитикаУчетаПоПартнерам,
		|	ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовИсточник КАК ОбъектРасчетов,
		|	&ВалютаВзаиморасчетовИсточник                             КАК Валюта,
		|	
		|	&СуммаВзаиморасчетовИсточник *
		|		ВЫБОР КОГДА &СторноИсточник ТОГДА -1 ИНАЧЕ 1 КОНЕЦ    КАК Сумма,
		|	0                                                         КАК Оплачивается,
		|	&КОплатеИсточник *
		|		ВЫБОР КОГДА &СторноИсточник ТОГДА -1 ИНАЧЕ 1 КОНЕЦ    КАК КОплате,
		|	0                                                         КАК КПоступлению,
		|	
		|	&ХозяйственнаяОперация                                    КАК ХозяйственнаяОперация,
		|	&ФормаОплаты                                              КАК ФормаОплаты,
		|	Неопределено                                              КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	Неопределено                                              КАК ЗакупкаПоЗаказу,
		|	ТаблицаРасшифровкаПлатежаПоставщик.ДатаРегистратора       КАК ДатаРегистратора,
		|	&ДатаПлатежа                                              КАК ДатаПлатежа,
		|	
		|	ВЫБОР КОГДА &ВалютаВзаиморасчетовИсточник = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА &СуммаВзаиморасчетовИсточник
		|			КОГДА ТаблицаРасшифровкаПлатежаПоставщик.ВалютаДокумента = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА ТаблицаРасшифровкаПлатежаПоставщик.Сумма
		|			ИНАЧЕ ВЫРАЗИТЬ(ТаблицаРасшифровкаПлатежаПоставщик.Сумма * Коэффициенты.КоэффициентРегл КАК ЧИСЛО(31,2))
		|	КОНЕЦ *
		|		ВЫБОР КОГДА &СторноИсточник ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК СуммаРегл,
		|	ВЫБОР КОГДА &ВалютаВзаиморасчетовИсточник = &ВалютаУправленческогоУчета
		|				ТОГДА &СуммаВзаиморасчетовИсточник
		|			КОГДА ТаблицаРасшифровкаПлатежаПоставщик.ВалютаДокумента = &ВалютаУправленческогоУчета
		|				ТОГДА ТаблицаРасшифровкаПлатежаПоставщик.Сумма
		|			ИНАЧЕ ВЫРАЗИТЬ(ТаблицаРасшифровкаПлатежаПоставщик.Сумма * Коэффициенты.КоэффициентУпр КАК ЧИСЛО(31,2))
		|	КОНЕЦ *
		|		ВЫБОР КОГДА &СторноИсточник ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК СуммаУпр,
		|
		|	0                                                         КАК ЗалогЗаТару,
		|	&СтатьяДвиженияДенежныхСредств                            КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                              КАК РасчетныйДокумент,
		|	Неопределено                                              КАК СвязанныйДокумент,
		|	&ВариантОплаты                                            КАК ВариантОплаты,
		|	ТаблицаРасшифровкаПлатежаПоставщик.ВалютаДокумента        КАК ВалютаДокумента,
		|	Неопределено                                              КАК КорОбъектРасчетов,
		|	Неопределено                                              КАК КорАналитикаУчетаПоПартнерам,
		|	
		|	&ОбъектРасчетовИсточникОрганизация                        КАК Организация,
		|	&ОбъектРасчетовИсточникПартнер                            КАК Партнер,
		|	ОбъектыРасчетовИсточники.Контрагент                       КАК Контрагент,
		|	ОбъектыРасчетовИсточники.Договор                          КАК Договор,
		|	НаправленияДеятельностиИсточник.НаправлениеАналитики      КАК НаправлениеДеятельности,
		|
		|	Неопределено                                              КАК КорПартнер,
		|	Неопределено                                              КАК КорОрганизация,
		|	Неопределено                                              КАК КорКонтрагент,
		|	Неопределено                                              КАК КорДоговор,
		|	Неопределено                                              КАК КорНаправлениеДеятельности,
		|	ТаблицаРасшифровкаПлатежаПоставщик.НомерРегистратора      КАК НомерРегистратора,
		|	&ИдентификаторФинЗаписи                                   КАК ИдентификаторФинЗаписи,
		|	&ВидИсточник                                              КАК Вид,
		|	&НастройкаХозяйственнойОперации                           КАК НастройкаХозяйственнойОперации,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА ЕСТЬNULL(АналитикаПриемник.КлючАналитики, Неопределено)
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                     КАК АналитикаУчетаПоПартнерамПриемник,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА ОбъектыРасчетовПриемники.Ссылка
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                     КАК ОбъектРасчетовПриемник,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА &ВалютаВзаиморасчетовПриемник
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                     КАК ВалютаПриемник,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА &ОбъектРасчетовПриемникПартнер
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                     КАК ПартнерПриемник,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА &ОбъектРасчетовПриемникОрганизация
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                     КАК ОрганизацияПриемник,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА ОбъектыРасчетовПриемники.Контрагент
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                     КАК КонтрагентПриемник,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА ОбъектыРасчетовПриемники.Договор
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                     КАК ДоговорПриемник,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА НаправленияДеятельностиПриемник.НаправлениеАналитики
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                     КАК НаправлениеДеятельностиПриемник,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА &СуммаВзаиморасчетовПриемник
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                     КАК СуммаПриемник,
		|	ЛОЖЬ                                                      КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#ТаблицаРасшифровкаПлатежаПоставщик КАК ТаблицаРасшифровкаПлатежаПоставщик
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетовИсточники
		|			ПО ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовИсточник = ОбъектыРасчетовИсточники.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка = ОбъектыРасчетовИсточники.Договор
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетовПриемники
		|			ПО ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовПриемник = ОбъектыРасчетовПриемники.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговораПриемник
		|			ПО ДанныеДоговораПриемник.Ссылка = ОбъектыРасчетовПриемники.Договор
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельностиИсточник
		|			ПО ОбъектыРасчетовИсточники.Ссылка = НаправленияДеятельностиИсточник.ОбъектРасчетов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельностиПриемник
		|			ПО ОбъектыРасчетовПриемники.Ссылка = НаправленияДеятельностиПриемник.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаИсточник
		|			ПО &ОбъектРасчетовИсточникОрганизация = АналитикаИсточник.Организация
		|				И ОбъектыРасчетовИсточники.Контрагент = АналитикаИсточник.Контрагент
		|				И &ОбъектРасчетовИсточникПартнер = АналитикаИсточник.Партнер
		|				И ОбъектыРасчетовИсточники.Договор = АналитикаИсточник.Договор
		|				И НаправленияДеятельностиИсточник.НаправлениеАналитики = АналитикаИсточник.НаправлениеДеятельности
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаПриемник
		|			ПО &ОбъектРасчетовПриемникОрганизация = АналитикаПриемник.Организация
		|				И ОбъектыРасчетовПриемники.Контрагент = АналитикаПриемник.Контрагент
		|				И &ОбъектРасчетовПриемникПартнер = АналитикаПриемник.Партнер
		|				И ОбъектыРасчетовПриемники.Договор = АналитикаПриемник.Договор
		|				И НаправленияДеятельностиПриемник.НаправлениеАналитики = АналитикаПриемник.НаправлениеДеятельности
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаиморасчетыВтКоэффициентыПересчетаВалют КАК Коэффициенты
		|			ПО Коэффициенты.Ссылка = ТаблицаРасшифровкаПлатежаПоставщик.Ссылка
		|				И Коэффициенты.ОбъектРасчетов = ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовИсточник
		|				И Коэффициенты.ВалютаВзаиморасчетов = &ВалютаВзаиморасчетовИсточник
		|				И Коэффициенты.ДатаКурса = ТаблицаРасшифровкаПлатежаПоставщик.ДатаКурса
		|ГДЕ
		|	&СуммаВзаиморасчетовИсточник > 0
		|	И &УсловиеОперации
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ТаблицаРасшифровкаПлатежаПоставщик.ДатаРегистратора              КАК Период,
		|	ВЫБОР
		|		КОГДА НЕ &СторноПриемник И &КредиторскаяЗадолженность
		|			ИЛИ &СторноПриемник И НЕ &КредиторскаяЗадолженность
		|			ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	КОНЕЦ                                                            КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(АналитикаПриемник.КлючАналитики, Неопределено)          КАК АналитикаУчетаПоПартнерам,
		|	ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовПриемник        КАК ОбъектРасчетов,
		|	&ВалютаВзаиморасчетовПриемник                                    КАК Валюта,
		|	
		|	&СуммаВзаиморасчетовПриемник *
		|		ВЫБОР КОГДА &СторноПриемник ТОГДА -1 ИНАЧЕ 1 КОНЕЦ           КАК Сумма,
		|	0                                                                КАК Оплачивается,
		|	&КОплатеПриемник *
		|		ВЫБОР КОГДА &СторноПриемник ТОГДА -1 ИНАЧЕ 1 КОНЕЦ           КАК КОплате,
		|	0                                                                КАК КПоступлению,
		|	
		|	&ХозяйственнаяОперация                                           КАК ХозяйственнаяОперация,
		|	&ФормаОплаты                                                     КАК ФормаОплаты,
		|	Неопределено                                                     КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	Неопределено                                                     КАК ЗакупкаПоЗаказу,
		|	ТаблицаРасшифровкаПлатежаПоставщик.ДатаРегистратора              КАК ДатаРегистратора,
		|	&ДатаПлатежа                                                     КАК ДатаПлатежа,
		|	
		|	ВЫБОР КОГДА &ВалютаВзаиморасчетовПриемник = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА &СуммаВзаиморасчетовПриемник
		|			КОГДА ТаблицаРасшифровкаПлатежаПоставщик.ВалютаДокумента = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА ТаблицаРасшифровкаПлатежаПоставщик.Сумма
		|			ИНАЧЕ ВЫРАЗИТЬ(ТаблицаРасшифровкаПлатежаПоставщик.Сумма * Коэффициенты.КоэффициентРегл КАК ЧИСЛО(31,2))
		|	КОНЕЦ*
		|		ВЫБОР КОГДА &СторноПриемник ТОГДА -1 ИНАЧЕ 1 КОНЕЦ           КАК СуммаРегл,
		|	ВЫБОР КОГДА &ВалютаВзаиморасчетовПриемник = &ВалютаУправленческогоУчета
		|				ТОГДА &СуммаВзаиморасчетовПриемник
		|			КОГДА ТаблицаРасшифровкаПлатежаПоставщик.ВалютаДокумента = &ВалютаУправленческогоУчета
		|				ТОГДА ТаблицаРасшифровкаПлатежаПоставщик.Сумма
		|			ИНАЧЕ ВЫРАЗИТЬ(ТаблицаРасшифровкаПлатежаПоставщик.Сумма * Коэффициенты.КоэффициентУпр КАК ЧИСЛО(31,2))
		|	КОНЕЦ*
		|		ВЫБОР КОГДА &СторноПриемник ТОГДА -1 ИНАЧЕ 1 КОНЕЦ           КАК СуммаУпр,
		|
		|	0                                                                КАК ЗалогЗаТару,
		|	&СтатьяДвиженияДенежныхСредств                                   КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                                     КАК РасчетныйДокумент,
		|	Неопределено                                                     КАК СвязанныйДокумент,
		|	&ВариантОплаты                                                   КАК ВариантОплаты,
		|	ТаблицаРасшифровкаПлатежаПоставщик.ВалютаДокумента               КАК ВалютаДокумента,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА ОбъектыРасчетовИсточники.Ссылка
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                            КАК КорОбъектРасчетов,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА ЕСТЬNULL(АналитикаИсточник.КлючАналитики, Неопределено)
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                            КАК КорАналитикаУчетаПоПартнерам,
		|	
		|	&ОбъектРасчетовПриемникОрганизация                               КАК Организация,
		|	&ОбъектРасчетовПриемникПартнер                                   КАК Партнер,
		|	ОбъектыРасчетовПриемники.Контрагент                              КАК Контрагент,
		|	ОбъектыРасчетовПриемники.Договор                                 КАК Договор,
		|	НаправленияДеятельностиПриемник.НаправлениеАналитики             КАК НаправлениеДеятельности,
		|
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА &ОбъектРасчетовИсточникПартнер
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                            КАК КорПартнер,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА &ОбъектРасчетовИсточникОрганизация
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                            КАК КорОрганизация,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА ОбъектыРасчетовИсточники.Контрагент
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                            КАК КорКонтрагент,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА ОбъектыРасчетовИсточники.Договор
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                            КАК КорДоговор,
		|	ВЫБОР КОГДА &ЗаполнятьПриемникВИсточнике
		|		ТОГДА НаправленияДеятельностиИсточник.НаправлениеАналитики
		|		ИНАЧЕ Неопределено
		|	КОНЕЦ                                                            КАК КорНаправлениеДеятельности,
		|
		|	ТаблицаРасшифровкаПлатежаПоставщик.НомерРегистратора             КАК НомерРегистратора,
		|	&ИдентификаторФинЗаписи                                          КАК ИдентификаторФинЗаписи,
		|	&ВидПриемник                                                     КАК Вид,
		|	&НастройкаХозяйственнойОперации                                  КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                                     КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                                     КАК ОбъектРасчетовПриемник,
		|	Неопределено                                                     КАК ВалютаПриемник,
		|	Неопределено                                                     КАК ПартнерПриемник,
		|	Неопределено                                                     КАК ОрганизацияПриемник,
		|	Неопределено                                                     КАК КонтрагентПриемник,
		|	Неопределено                                                     КАК ДоговорПриемник,
		|	Неопределено                                                     КАК НаправлениеДеятельностиПриемник,
		|	0                                                                КАК СуммаПриемник,
		|	&ЗаполнятьПриемникВИсточнике                                     КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#ТаблицаРасшифровкаПлатежаПоставщик КАК ТаблицаРасшифровкаПлатежаПоставщик
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетовИсточники
		|			ПО ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовИсточник = ОбъектыРасчетовИсточники.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговораИсточник
		|			ПО ДанныеДоговораИсточник.Ссылка = ОбъектыРасчетовИсточники.Договор
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетовПриемники
		|			ПО ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовПриемник = ОбъектыРасчетовПриемники.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка = ОбъектыРасчетовПриемники.Договор
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельностиИсточник
		|			ПО ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовИсточник = НаправленияДеятельностиИсточник.ОбъектРасчетов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельностиПриемник
		|			ПО ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовПриемник = НаправленияДеятельностиПриемник.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаПриемник
		|			ПО &ОбъектРасчетовПриемникОрганизация = АналитикаПриемник.Организация
		|				И ОбъектыРасчетовПриемники.Контрагент = АналитикаПриемник.Контрагент
		|				И &ОбъектРасчетовПриемникПартнер = АналитикаПриемник.Партнер
		|				И ОбъектыРасчетовПриемники.Договор = АналитикаПриемник.Договор
		|				И НаправленияДеятельностиПриемник.НаправлениеАналитики = АналитикаПриемник.НаправлениеДеятельности
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаИсточник
		|			ПО &ОбъектРасчетовИсточникОрганизация = АналитикаИсточник.Организация
		|				И ОбъектыРасчетовИсточники.Контрагент = АналитикаИсточник.Контрагент
		|				И &ОбъектРасчетовИсточникПартнер = АналитикаИсточник.Партнер
		|				И ОбъектыРасчетовИсточники.Договор = АналитикаИсточник.Договор
		|				И НаправленияДеятельностиИсточник.НаправлениеАналитики = АналитикаИсточник.НаправлениеДеятельности
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаиморасчетыВтКоэффициентыПересчетаВалют КАК Коэффициенты
		|			ПО Коэффициенты.Ссылка = ТаблицаРасшифровкаПлатежаПоставщик.Ссылка
		|				И Коэффициенты.ОбъектРасчетов = ТаблицаРасшифровкаПлатежаПоставщик.ОбъектРасчетовПриемник
		|				И Коэффициенты.ВалютаВзаиморасчетов = &ВалютаВзаиморасчетовПриемник
		|				И Коэффициенты.ДатаКурса = ТаблицаРасшифровкаПлатежаПоставщик.ДатаКурса
		|ГДЕ
		|	&СуммаВзаиморасчетовПриемник > 0
		|	И &УсловиеОперации
		|";
	#КонецОбласти
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&УсловиеОперации",УсловиеОперации);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&КредиторскаяЗадолженность",       КредиторскаяЗадолженность);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СторноИсточник",                  СторноИсточник);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СторноПриемник",                  СторноПриемник);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&КОплатеИсточник",                 КОплатеИсточник);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ХозяйственнаяОперация",           ХозяйственнаяОперация);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ФормаОплаты",                     ФормаОплаты);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&КОплатеПриемник",                 КОплатеПриемник);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ОбъектРасчетовИсточникОрганизация", ОбъектРасчетовИсточникОрганизация);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ОбъектРасчетовПриемникОрганизация", ОбъектРасчетовПриемникОрганизация);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ОбъектРасчетовИсточникПартнер",   ОбъектРасчетовИсточникПартнер);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ОбъектРасчетовПриемникПартнер",   ОбъектРасчетовПриемникПартнер);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ВалютаВзаиморасчетовИсточник",    ВалютаВзаиморасчетовИсточник);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ВалютаВзаиморасчетовПриемник",    ВалютаВзаиморасчетовПриемник);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СуммаВзаиморасчетовИсточник",     СуммаВзаиморасчетовИсточник);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СуммаВзаиморасчетовПриемник",     СуммаВзаиморасчетовПриемник);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ДатаПлатежа",                     ДатаПлатежа);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ВариантОплаты",                   ВариантОплаты);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СтатьяДвиженияДенежныхСредств",   СтатьяДвиженияДенежныхСредств);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЗаполнятьПриемникВИсточнике",     ЗаполнятьПриемникВИсточнике);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ИдентификаторФинЗаписи",          ИдентификаторФинЗаписи);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&НастройкаХозяйственнойОперации",  НастройкаХозяйственнойОперации);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ВидИсточник",  ВидИсточник);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ВидПриемник",  ВидПриемник);
	
	Если Операция = "ПереносЗакупки" ИЛИ Операция = "ПереносПлатежа" ИЛИ Операция = "ПереносВозврата" Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"#ТаблицаРасшифровкаПлатежа",  "втПереносРасчетов");
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"ТаблицаРасшифровкаПлатежа",  "ПереносРасчетов");
	КонецЕсли;
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстПереносЗадолженностиПоставщикаМеждуФилиалами()
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	УвеличениеНашейЗадолженностиПоставщику.ДатаРегистратора          КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)                           КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(АналитикаИсточник.КлючАналитики, Неопределено)          КАК АналитикаУчетаПоПартнерам,
		|	УвеличениеНашейЗадолженностиПоставщику.ОбъектРасчетов            КАК ОбъектРасчетов,
		|	УвеличениеНашейЗадолженностиПоставщику.ВалютаВзаиморасчетов      КАК Валюта,
		|	
		|	УвеличениеНашейЗадолженностиПоставщику.СуммаВзаиморасчетов       КАК Сумма,
		|	0                                                                КАК Оплачивается,
		|	0                                                                КАК КОплате,
		|	0                                                                КАК КПоступлению,
		|	
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносЗадолженностиМеждуФилиалами) КАК ХозяйственнаяОперация,
		|	Неопределено                                                     КАК ФормаОплаты,
		|	Неопределено                                                     КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	УвеличениеНашейЗадолженностиПоставщику.ЗаказЗакупки              КАК ЗакупкаПоЗаказу,
		|	УвеличениеНашейЗадолженностиПоставщику.ДатаРегистратора          КАК ДатаРегистратора,
		|	УвеличениеНашейЗадолженностиПоставщику.ДатаПлатежа               КАК ДатаПлатежа,
		|	
		|	ВЫБОР КОГДА УвеличениеНашейЗадолженностиПоставщику.ВалютаВзаиморасчетов = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА УвеличениеНашейЗадолженностиПоставщику.СуммаВзаиморасчетов
		|			КОГДА УвеличениеНашейЗадолженностиПоставщику.ВалютаДокумента = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА УвеличениеНашейЗадолженностиПоставщику.Сумма
		|			ИНАЧЕ ВЫРАЗИТЬ(УвеличениеНашейЗадолженностиПоставщику.Сумма * Коэффициенты.КоэффициентРегл КАК ЧИСЛО(31,2))
		|	КОНЕЦ КАК СуммаРегл,
		|	ВЫБОР КОГДА УвеличениеНашейЗадолженностиПоставщику.ВалютаВзаиморасчетов = &ВалютаУправленческогоУчета
		|				ТОГДА УвеличениеНашейЗадолженностиПоставщику.СуммаВзаиморасчетов
		|			КОГДА УвеличениеНашейЗадолженностиПоставщику.ВалютаДокумента = &ВалютаУправленческогоУчета
		|				ТОГДА УвеличениеНашейЗадолженностиПоставщику.Сумма
		|			ИНАЧЕ ВЫРАЗИТЬ(УвеличениеНашейЗадолженностиПоставщику.Сумма * Коэффициенты.КоэффициентУпр КАК ЧИСЛО(31,2))
		|	КОНЕЦ КАК СуммаУпр,
		|
		|	0                                                       КАК ЗалогЗаТару,
		|	Неопределено                                            КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                            КАК РасчетныйДокумент,
		|	Неопределено                                            КАК СвязанныйДокумент,
		|	УвеличениеНашейЗадолженностиПоставщику.ВариантОплаты    КАК ВариантОплаты,
		|	УвеличениеНашейЗадолженностиПоставщику.ВалютаДокумента  КАК ВалютаДокумента,
		|	Неопределено                                            КАК КорОбъектРасчетов,
		|	Неопределено                                            КАК КорАналитикаУчетаПоПартнерам,
		|	
		|	УвеличениеНашейЗадолженностиПоставщику.Организация      КАК Организация,
		|	УвеличениеНашейЗадолженностиПоставщику.Партнер          КАК Партнер,
		|	ОбъектРасчетовЦД.Контрагент                             КАК Контрагент,
		|	ОбъектРасчетовЦД.Договор                                КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики            КАК НаправлениеДеятельности,
		|
		|	Неопределено                                            КАК КорПартнер,
		|	Неопределено                                            КАК КорОрганизация,
		|	Неопределено                                            КАК КорКонтрагент,
		|	Неопределено                                            КАК КорДоговор,
		|	Неопределено                                            КАК КорНаправлениеДеятельности,
		|	УвеличениеНашейЗадолженностиПоставщику.НомерРегистратора КАК НомерРегистратора,
		|	ОбъектРасчетовЦД.УникальныйИдентификатор                КАК ИдентификаторФинЗаписи,
		|	2                                                       КАК Вид,
		|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПереносЗадолженностиМеждуФилиалами) КАК НастройкаХозяйственнойОперации,
		|	ЕСТЬNULL(АналитикаПриемник.КлючАналитики, Неопределено) КАК АналитикаУчетаПоПартнерамПриемник,
		|	ОбъектРасчетовЦД.Ссылка                                 КАК ОбъектРасчетовПриемник,
		|	ОбъектРасчетовЦД.ВалютаВзаиморасчетов                   КАК ВалютаПриемник,
		|	УвеличениеНашейЗадолженностиПоставщику.Партнер          КАК ПартнерПриемник,
		|	ОбъектРасчетовЦД.Организация                            КАК ОрганизацияПриемник,
		|	ОбъектРасчетовЦД.Контрагент                             КАК КонтрагентПриемник,
		|	ОбъектРасчетовЦД.Договор                                КАК ДоговорПриемник,
		|	НаправленияДеятельности.НаправлениеАналитики            КАК НаправлениеДеятельностиПриемник,
		|	УвеличениеНашейЗадолженностиПоставщику.СуммаВзаиморасчетов КАК СуммаПриемник,
		|	ЛОЖЬ                                                    КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#УвеличениеНашейЗадолженностиПоставщику КАК УвеличениеНашейЗадолженностиПоставщику
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектРасчетовЦД
		|			ПО УвеличениеНашейЗадолженностиПоставщику.ОбъектРасчетов = ОбъектРасчетовЦД.Ссылка
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка = ОбъектРасчетовЦД.Договор
		|				И ДанныеДоговора.ЦентрализованныйДоговор
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО ОбъектРасчетовЦД.Ссылка = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаПриемник
		|			ПО ОбъектРасчетовЦД.Организация = АналитикаПриемник.Организация
		|				И ОбъектРасчетовЦД.Контрагент = АналитикаПриемник.Контрагент
		|				И УвеличениеНашейЗадолженностиПоставщику.Партнер = АналитикаПриемник.Партнер
		|				И ОбъектРасчетовЦД.Договор = АналитикаПриемник.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = АналитикаПриемник.НаправлениеДеятельности
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаИсточник
		|			ПО УвеличениеНашейЗадолженностиПоставщику.Организация = АналитикаИсточник.Организация
		|				И ОбъектРасчетовЦД.Контрагент = АналитикаИсточник.Контрагент
		|				И УвеличениеНашейЗадолженностиПоставщику.Партнер = АналитикаИсточник.Партнер
		|				И ОбъектРасчетовЦД.Договор = АналитикаИсточник.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = АналитикаИсточник.НаправлениеДеятельности
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаиморасчетыВтКоэффициентыПересчетаВалют КАК Коэффициенты
		|			ПО Коэффициенты.Ссылка = УвеличениеНашейЗадолженностиПоставщику.Ссылка
		|				И Коэффициенты.ОбъектРасчетов = УвеличениеНашейЗадолженностиПоставщику.ОбъектРасчетов
		|				И Коэффициенты.ВалютаВзаиморасчетов = УвеличениеНашейЗадолженностиПоставщику.ВалютаВзаиморасчетов
		|				И Коэффициенты.ДатаКурса = УвеличениеНашейЗадолженностиПоставщику.ДатаКурса
		|ГДЕ
		|	УвеличениеНашейЗадолженностиПоставщику.СуммаВзаиморасчетов > 0
		|	И УвеличениеНашейЗадолженностиПоставщику.Организация <> ОбъектРасчетовЦД.Организация
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	УвеличениеНашейЗадолженностиПоставщику.ДатаРегистратора          КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                           КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(АналитикаПриемник.КлючАналитики, Неопределено)          КАК АналитикаУчетаПоПартнерам,
		|	УвеличениеНашейЗадолженностиПоставщику.ОбъектРасчетов            КАК ОбъектРасчетов,
		|	УвеличениеНашейЗадолженностиПоставщику.ВалютаВзаиморасчетов      КАК Валюта,
		|	
		|	УвеличениеНашейЗадолженностиПоставщику.СуммаВзаиморасчетов       КАК Сумма,
		|	0                                                                КАК Оплачивается,
		|	0                                                                КАК КОплате,
		
		|	0                                                                КАК КПоступлению,
		|	
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносЗадолженностиМеждуФилиалами) КАК ХозяйственнаяОперация,
		|	Неопределено                                                     КАК ФормаОплаты,
		|	Неопределено                                                     КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	УвеличениеНашейЗадолженностиПоставщику.ЗаказЗакупки              КАК ЗакупкаПоЗаказу,
		|	УвеличениеНашейЗадолженностиПоставщику.ДатаРегистратора          КАК ДатаРегистратора,
		|	УвеличениеНашейЗадолженностиПоставщику.ДатаПлатежа               КАК ДатаПлатежа,
		|	
		|	ВЫБОР КОГДА УвеличениеНашейЗадолженностиПоставщику.ВалютаВзаиморасчетов = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА УвеличениеНашейЗадолженностиПоставщику.СуммаВзаиморасчетов
		|			КОГДА УвеличениеНашейЗадолженностиПоставщику.ВалютаДокумента = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА УвеличениеНашейЗадолженностиПоставщику.Сумма
		|			ИНАЧЕ ВЫРАЗИТЬ(УвеличениеНашейЗадолженностиПоставщику.Сумма * Коэффициенты.КоэффициентРегл КАК ЧИСЛО(31,2))
		|	КОНЕЦ КАК СуммаРегл,
		|	ВЫБОР КОГДА УвеличениеНашейЗадолженностиПоставщику.ВалютаВзаиморасчетов = &ВалютаУправленческогоУчета
		|				ТОГДА УвеличениеНашейЗадолженностиПоставщику.СуммаВзаиморасчетов
		|			КОГДА УвеличениеНашейЗадолженностиПоставщику.ВалютаДокумента = &ВалютаУправленческогоУчета
		|				ТОГДА УвеличениеНашейЗадолженностиПоставщику.Сумма
		|			ИНАЧЕ ВЫРАЗИТЬ(УвеличениеНашейЗадолженностиПоставщику.Сумма * Коэффициенты.КоэффициентУпр КАК ЧИСЛО(31,2))
		|	КОНЕЦ КАК СуммаУпр,
		|
		|	0                                                                КАК ЗалогЗаТару,
		|	Неопределено                                                     КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                                     КАК РасчетныйДокумент,
		|	Неопределено                                                     КАК СвязанныйДокумент,
		|	УвеличениеНашейЗадолженностиПоставщику.ВариантОплаты             КАК ВариантОплаты,
		|	УвеличениеНашейЗадолженностиПоставщику.ВалютаДокумента           КАК ВалютаДокумента,
		|	ОбъектРасчетовЦД.Ссылка                                          КАК КорОбъектРасчетов,
		|	ЕСТЬNULL(АналитикаИсточник.КлючАналитики, Неопределено)          КАК КорАналитикаУчетаПоПартнерам,
		|	
		|	ОбъектРасчетовЦД.Организация                                     КАК Организация,
		|	УвеличениеНашейЗадолженностиПоставщику.Партнер                   КАК Партнер,
		|	ОбъектРасчетовЦД.Контрагент                                      КАК Контрагент,
		|	ОбъектРасчетовЦД.Договор                                         КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики                     КАК НаправлениеДеятельности,
		|
		|	УвеличениеНашейЗадолженностиПоставщику.Партнер                   КАК КорПартнер,
		|	УвеличениеНашейЗадолженностиПоставщику.Организация               КАК КорОрганизация,
		|	ОбъектРасчетовЦД.Контрагент                                      КАК КорКонтрагент,
		|	ОбъектРасчетовЦД.Договор                                         КАК КорДоговор,
		|	НаправленияДеятельности.НаправлениеАналитики                     КАК КорНаправлениеДеятельности,
		|
		|	УвеличениеНашейЗадолженностиПоставщику.НомерРегистратора         КАК НомерРегистратора,
		|	ОбъектРасчетовЦД.УникальныйИдентификатор                         КАК ИдентификаторФинЗаписи,
		|	2                                                                КАК Вид,
		|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПереносЗадолженностиМеждуФилиалами) КАК НастройкаХозяйственнойОперации,

		|	Неопределено                                                     КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                                     КАК ОбъектРасчетовПриемник,
		|	Неопределено                                                     КАК ВалютаПриемник,
		|	Неопределено                                                     КАК ПартнерПриемник,
		|	Неопределено                                                     КАК ОрганизацияПриемник,
		|	Неопределено                                                     КАК КонтрагентПриемник,
		|	Неопределено                                                     КАК ДоговорПриемник,
		|	Неопределено                                                     КАК НаправлениеДеятельностиПриемник,
		|	0                                                                КАК СуммаПриемник,
		|	ИСТИНА                                                           КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#УвеличениеНашейЗадолженностиПоставщику КАК УвеличениеНашейЗадолженностиПоставщику
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектРасчетовЦД
		|			ПО УвеличениеНашейЗадолженностиПоставщику.ОбъектРасчетов = ОбъектРасчетовЦД.Ссылка
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка = ОбъектРасчетовЦД.Договор
		|				И ДанныеДоговора.ЦентрализованныйДоговор
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО ОбъектРасчетовЦД.Ссылка = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаПриемник
		|			ПО ОбъектРасчетовЦД.Организация = АналитикаПриемник.Организация
		|				И ОбъектРасчетовЦД.Контрагент = АналитикаПриемник.Контрагент
		|				И УвеличениеНашейЗадолженностиПоставщику.Партнер = АналитикаПриемник.Партнер
		|				И ОбъектРасчетовЦД.Договор = АналитикаПриемник.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = АналитикаПриемник.НаправлениеДеятельности
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаИсточник
		|			ПО УвеличениеНашейЗадолженностиПоставщику.Организация = АналитикаИсточник.Организация
		|				И ОбъектРасчетовЦД.Контрагент = АналитикаИсточник.Контрагент
		|				И УвеличениеНашейЗадолженностиПоставщику.Партнер = АналитикаИсточник.Партнер
		|				И ОбъектРасчетовЦД.Договор = АналитикаИсточник.Договор
		|				И НаправленияДеятельности.НаправлениеАналитики = АналитикаИсточник.НаправлениеДеятельности
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаиморасчетыВтКоэффициентыПересчетаВалют КАК Коэффициенты
		|			ПО Коэффициенты.Ссылка = УвеличениеНашейЗадолженностиПоставщику.Ссылка
		|				И Коэффициенты.ОбъектРасчетов = УвеличениеНашейЗадолженностиПоставщику.ОбъектРасчетов
		|				И Коэффициенты.ВалютаВзаиморасчетов = УвеличениеНашейЗадолженностиПоставщику.ВалютаВзаиморасчетов
		|				И Коэффициенты.ДатаКурса = УвеличениеНашейЗадолженностиПоставщику.ДатаКурса
		|ГДЕ
		|	УвеличениеНашейЗадолженностиПоставщику.СуммаВзаиморасчетов > 0
		|	И УвеличениеНашейЗадолженностиПоставщику.Организация <> ОбъектРасчетовЦД.Организация
		|";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция УвеличитьПланОплатыПоставщику(Операция)
	
	Если Операция = "ГрафикИсполненияПоставщик" Тогда
		
		ЭтоЗаказ = "ЛОЖЬ";
		ЭтоНакладная = "ЛОЖЬ";
		Период = "КОНЕЦПЕРИОДА(УвеличениеПланаОплатыПоставщику.ДатаПлатежа, ДЕНЬ)";
		
		ПорядокРасчетов = "ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов)";
		НакладнаяПоЗаказам = "ЛОЖЬ";
		ЗаказЗакупки = "Неопределено";
		СверхЗаказа = "ЛОЖЬ";
		КОплате = "УвеличениеПланаОплатыПоставщику.КОплате";
		
		СвязанныйДокумент = "Неопределено";
		ФормаОплаты = "Неопределено";
		СтатьяДвиженияДенежныхСредств = "Неопределено";
		ДатаПлатежа = "КОНЕЦПЕРИОДА(УвеличениеПланаОплатыПоставщику.ДатаПлатежа, ДЕНЬ)";
		ВариантОплаты = "УвеличениеПланаОплатыПоставщику.ВариантОплаты";
		ИдентификаторФинЗаписи = "&ИдентификаторНеиспользуемойФинЗаписи";
		НастройкаХозяйственнойОперации = "Неопределено";
		Вид = "1";
		
	ИначеЕсли Операция = "ЗаказПоставщику" Тогда
		
		ЭтоЗаказ = "ИСТИНА";
		ЭтоНакладная = "ЛОЖЬ";
		Период = "КОНЕЦПЕРИОДА(УвеличениеПланаОплатыПоставщику.ДатаПлатежа, ДЕНЬ)";
				
		ПорядокРасчетов = "УвеличениеПланаОплатыПоставщику.ПорядокРасчетов";
		НакладнаяПоЗаказам = "ЛОЖЬ";
		ЗаказЗакупки = "Неопределено";
		СверхЗаказа = "ЛОЖЬ";
		
		КОплате = "УвеличениеПланаОплатыПоставщику.КОплате";
		
		СвязанныйДокумент = "Неопределено";
		ФормаОплаты = "УвеличениеПланаОплатыПоставщику.ФормаОплаты";
		СтатьяДвиженияДенежныхСредств = "Неопределено";
		ДатаПлатежа = "КОНЕЦПЕРИОДА(УвеличениеПланаОплатыПоставщику.ДатаПлатежа)";
		ВариантОплаты = "УвеличениеПланаОплатыПоставщику.ВариантОплаты";
		ИдентификаторФинЗаписи = "&ИдентификаторНеиспользуемойФинЗаписи";
		НастройкаХозяйственнойОперации = "Неопределено";
		Вид = "1";
		
	ИначеЕсли Операция = "Закупка" Тогда
		
		ЭтоЗаказ = "ЛОЖЬ";
		ЭтоНакладная = "ИСТИНА";
		Период = "ВЫБОР КОГДА УвеличениеПланаОплатыПоставщику.КОплате < 0 ИЛИ УвеличениеПланаОплатыПоставщику.ДатаПлатежа < УвеличениеПланаОплатыПоставщику.ДатаРегистратора
				|		ТОГДА УвеличениеПланаОплатыПоставщику.ДатаРегистратора
				|	ИНАЧЕ КОНЕЦПЕРИОДА(УвеличениеПланаОплатыПоставщику.ДатаПлатежа, ДЕНЬ)
				|КОНЕЦ";
		ПорядокРасчетов = "УвеличениеПланаОплатыПоставщику.ПорядокРасчетов";
		НакладнаяПоЗаказам = "УвеличениеПланаОплатыПоставщику.НакладнаяПоЗаказам";
		ЗаказЗакупки = "УвеличениеПланаОплатыПоставщику.ЗаказЗакупки";
		СверхЗаказа = "УвеличениеПланаОплатыПоставщику.СверхЗаказа";
		
		КОплате = "УвеличениеПланаОплатыПоставщику.КОплате";
		
		СвязанныйДокумент = "УвеличениеПланаОплатыПоставщику.СвязанныйДокумент";
		ФормаОплаты = "УвеличениеПланаОплатыПоставщику.ФормаОплаты";
		СтатьяДвиженияДенежныхСредств = "Неопределено";

		ДатаПлатежа = "ВЫБОР КОГДА УвеличениеПланаОплатыПоставщику.КОплате < 0 
				|		ТОГДА ДАТАВРЕМЯ(1,1,1)
				|	ИНАЧЕ УвеличениеПланаОплатыПоставщику.ДатаПлатежа
				|КОНЕЦ";
		ВариантОплаты = "УвеличениеПланаОплатыПоставщику.ВариантОплаты";
		ИдентификаторФинЗаписи = "УвеличениеПланаОплатыПоставщику.ОбъектРасчетов.УникальныйИдентификатор";
		НастройкаХозяйственнойОперации = "Неопределено";
		Вид = "2";
		
	ИначеЕсли Операция = "ВозвратОплатыОтПоставщика" Тогда
		
		ЭтоЗаказ = "ЛОЖЬ";
		ЭтоНакладная = "ЛОЖЬ";
		Период = "УвеличениеПланаОплатыПоставщику.ДатаРегистратора";
		
		ПорядокРасчетов = "Неопределено";
		НакладнаяПоЗаказам = "ЛОЖЬ";
		ЗаказЗакупки = "Неопределено";
		СверхЗаказа = "ЛОЖЬ";
		
		КОплате = "УвеличениеПланаОплатыПоставщику.СуммаВзаиморасчетов";
		
		СвязанныйДокумент = "Неопределено";
		ФормаОплаты = "УвеличениеПланаОплатыПоставщику.ФормаОплаты";
		СтатьяДвиженияДенежныхСредств = "УвеличениеПланаОплатыПоставщику.СтатьяДвиженияДенежныхСредств";
		ДатаПлатежа = "ДАТАВРЕМЯ(1,1,1)";
		ВариантОплаты = "Неопределено";
		ИдентификаторФинЗаписи = "УвеличениеПланаОплатыПоставщику.ИдентификаторФинЗаписи";
		НастройкаХозяйственнойОперации = "УвеличениеПланаОплатыПоставщику.НастройкаХозяйственнойОперации";
		Вид = "5";
		
	КонецЕсли;
	
	ТекстЗапроса = 
		"ВЫБРАТЬ
		|	&Период                                                             КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                              КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)                     КАК АналитикаУчетаПоПартнерам,
		|	УвеличениеПланаОплатыПоставщику.ОбъектРасчетов                      КАК ОбъектРасчетов,
		|	УвеличениеПланаОплатыПоставщику.ВалютаВзаиморасчетов                КАК Валюта,
		|	
		|	0                                                                   КАК Сумма,
		|	0                                                                   КАК Оплачивается,
		|	&КОплате                                                            КАК КОплате,
		|	0                                                                   КАК КПоступлению,
		|	
		|	УвеличениеПланаОплатыПоставщику.ХозяйственнаяОперация               КАК ХозяйственнаяОперация,
		|	&ФормаОплаты                                                        КАК ФормаОплаты,
		|	Неопределено                                                        КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	&ЗаказЗакупки                                                       КАК ЗакупкаПоЗаказу,
		|	УвеличениеПланаОплатыПоставщику.ДатаРегистратора                    КАК ДатаРегистратора,
		|	&ДатаПлатежа                                                        КАК ДатаПлатежа,
		|	0                                                                   КАК СуммаРегл,
		|	0                                                                   КАК СуммаУпр,
		|	0                                                                   КАК ЗалогЗаТару,
		|	&СтатьяДвиженияДенежныхСредств                                      КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                                        КАК РасчетныйДокумент,
		|	//Порядок оплаты
		|	//Порядок зачета по дате платежа
		|	&СвязанныйДокумент                                                  КАК СвязанныйДокумент,
		|	
		|	&ВариантОплаты                                                      КАК ВариантОплаты,
		|	УвеличениеПланаОплатыПоставщику.ВалютаДокумента                     КАК ВалютаДокумента,
		|	Неопределено                                                        КАК КорОбъектРасчетов,
		|	Неопределено                                                        КАК КорАналитикаУчетаПоПартнерам,
		|	
		|	УвеличениеПланаОплатыПоставщику.ОбъектРасчетов.Организация          КАК Организация,
		|	УвеличениеПланаОплатыПоставщику.Партнер                             КАК Партнер,
		|	УвеличениеПланаОплатыПоставщику.ОбъектРасчетов.Контрагент           КАК Контрагент,
		|	УвеличениеПланаОплатыПоставщику.ОбъектРасчетов.Договор              КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики                        КАК НаправлениеДеятельности,
		|	
		|	Неопределено                                                        КАК КорПартнер,
		|	Неопределено                                                        КАК КорОрганизация,
		|	Неопределено                                                        КАК КорКонтрагент,
		|	Неопределено                                                        КАК КорДоговор,
		|	Неопределено                                                        КАК КорНаправлениеДеятельности,
		|	УвеличениеПланаОплатыПоставщику.НомерРегистратора                   КАК НомерРегистратора,
		|	&ИдентификаторФинЗаписи                                             КАК ИдентификаторФинЗаписи,
		|	&Вид                                                                КАК Вид,
		|	&НастройкаХозяйственнойОперации                                     КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                                        КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                                        КАК ОбъектРасчетовПриемник,
		|	Неопределено                                                        КАК ВалютаПриемник,
		|	Неопределено                                                        КАК ПартнерПриемник,
		|	Неопределено                                                        КАК ОрганизацияПриемник,
		|	Неопределено                                                        КАК КонтрагентПриемник,
		|	Неопределено                                                        КАК ДоговорПриемник,
		|	Неопределено                                                        КАК НаправлениеДеятельностиПриемник,
		|	0                                                                   КАК СуммаПриемник,
		|	ЛОЖЬ                                                                КАК ПоДаннымОбъектаРасчетовИсточника
		|	
		|ИЗ
		|	#УвеличениеПланаОплатыПоставщику КАК УвеличениеПланаОплатыПоставщику
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО УвеличениеПланаОплатыПоставщику.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка = УвеличениеПланаОплатыПоставщику.ОбъектРасчетов.Договор
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|				ПО УвеличениеПланаОплатыПоставщику.ОбъектРасчетов.Организация = Аналитика.Организация
		|					И УвеличениеПланаОплатыПоставщику.ОбъектРасчетов.Контрагент = Аналитика.Контрагент
		|					И УвеличениеПланаОплатыПоставщику.Партнер = Аналитика.Партнер
		|					И УвеличениеПланаОплатыПоставщику.ОбъектРасчетов.Договор = Аналитика.Договор
		|					И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|ГДЕ
		|	&КОплате <> 0
		|	//При расчетах по договору с графиком план оплаты не увеличивается
		|	И НЕ (&ЭтоЗаказ
		|			И ЕСТЬNULL(ДанныеДоговора.ЗаданГрафикИсполнения, ЛОЖЬ)
		|			И ЕСТЬNULL(ДанныеДоговора.ТипДоговора, ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.ПустаяСсылка)) 
		|				В (ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СПоставщиком),
		|					ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СКомитентом),
		|					ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.Импорт),
		|					ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СПереработчиком),
		|					ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СПереработчиком2_5))
		|			И &ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов))
		|	//Заказ с расчетами не по накладным
		|	И (&ЭтоЗаказ И &ПорядокРасчетов <> ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоНакладным)
		|		//Сверх заказа или не по заказу
		|		ИЛИ &ЭтоНакладная
		|		//График исполнения договора, возврат оплаты
		|		ИЛИ НЕ (&ЭтоНакладная ИЛИ &ЭтоЗаказ)
		|		)
		|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ПорядокРасчетов",               ПорядокРасчетов);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ФормаОплаты",                   ФормаОплаты);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЭтоЗаказ",                      ЭтоЗаказ);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЭтоНакладная",                  ЭтоНакладная);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&НакладнаяПоЗаказам",            НакладнаяПоЗаказам);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЗаказЗакупки",                  ЗаказЗакупки);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СверхЗаказа",                   СверхЗаказа);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&Период",                        Период);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&КОплате",                       КОплате);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СтатьяДвиженияДенежныхСредств", СтатьяДвиженияДенежныхСредств);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ДатаПлатежа",                   ДатаПлатежа);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ВариантОплаты",                 ВариантОплаты);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СвязанныйДокумент",             СвязанныйДокумент);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ИдентификаторФинЗаписи",        ИдентификаторФинЗаписи);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&НастройкаХозяйственнойОперации", НастройкаХозяйственнойОперации);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&Вид",                           Вид);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция УменьшитьПланОплатыПоставщику(Операция, НакладнаяПоЗаказам = Ложь)
	
	Если Операция = "ОплатаПоставщику" ИЛИ Операция = "ЗачетОбязательствПоставщика" Тогда
		
		КОплате = "УменьшениеПланаОплатыПоставщику.СуммаВзаиморасчетов";
		ФормаОплаты = "УменьшениеПланаОплатыПоставщику.ФормаОплаты";
		ЗаявкаНаРасходованиеДенежныхСредств = "УменьшениеПланаОплатыПоставщику.ЗаявкаНаРасходованиеДенежныхСредств";
		СтатьяДвиженияДенежныхСредств = "УменьшениеПланаОплатыПоставщику.СтатьяДвиженияДенежныхСредств";
		СвязанныйДокумент = "УменьшениеПланаОплатыПоставщику.СвязанныйДокумент";
		ИдентификаторФинЗаписи = "УменьшениеПланаОплатыПоставщику.ИдентификаторФинЗаписи";
		НастройкаХозяйственнойОперации = "УменьшениеПланаОплатыПоставщику.НастройкаХозяйственнойОперации";
		ЗаказЗакупки = "Неопределено";
		Вид = "ВЫБОР КОГДА
		|	УменьшениеПланаОплатыПоставщику.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.УдержаниеВознагражденияКомитентом)
		|		ТОГДА 2
		|	КОГДА УменьшениеПланаОплатыПоставщику.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаЗадолженности)
		|		ТОГДА 3
		|	ИНАЧЕ 4
		|КОНЕЦ";
		ОбъектРасчетов = "УменьшениеПланаОплатыПоставщику.ОбъектРасчетов";
		УсловиеОперации = "ИСТИНА";
		Организация = "УменьшениеПланаОплатыПоставщику.Организация";
		ВариантОплаты = "Неопределено";
		
	ИначеЕсли Операция = "Закупка" Тогда
		
		КОплате = "УменьшениеПланаОплатыПоставщику.КОплате";
		ФормаОплаты = "Неопределено";
		ЗаявкаНаРасходованиеДенежныхСредств = "Неопределено";
		СтатьяДвиженияДенежныхСредств = "Неопределено";
		СвязанныйДокумент = "Неопределено";
		Если НакладнаяПоЗаказам Тогда
			ВариантОплаты = "УменьшениеПланаОплатыПоставщику.ВариантОплаты";
			ИдентификаторФинЗаписи = "ВЫБОР 
			|		КОГДА УменьшениеПланаОплатыПоставщику.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
			|			ТОГДА УменьшениеПланаОплатыПоставщику.ЗаказЗакупки.ОбъектРасчетов.УникальныйИдентификатор
			|		КОГДА УменьшениеПланаОплатыПоставщику.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
			|			ТОГДА ЕСТЬNULL(ДанныеДоговора.ОбъектРасчетов.УникальныйИдентификатор, """")
			|		ИНАЧЕ УменьшениеПланаОплатыПоставщику.ОбъектРасчетов.УникальныйИдентификатор
			|	КОНЕЦ";
			НастройкаХозяйственнойОперации = "Неопределено";
			ЗаказЗакупки = "УменьшениеПланаОплатыПоставщику.ЗаказЗакупки";
			Вид = "2";
			ОбъектРасчетов = "ВЫБОР 
			|		КОГДА УменьшениеПланаОплатыПоставщику.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
			|			ТОГДА УменьшениеПланаОплатыПоставщику.ЗаказЗакупки.ОбъектРасчетов
			|		КОГДА УменьшениеПланаОплатыПоставщику.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
			|			ТОГДА ЕСТЬNULL(ДанныеДоговора.ОбъектРасчетов, Неопределено)
			|		ИНАЧЕ УменьшениеПланаОплатыПоставщику.ОбъектРасчетов
			|	КОНЕЦ";
			УсловиеОперации = "	(УменьшениеПланаОплатыПоставщику.НакладнаяПоЗаказам И НЕ УменьшениеПланаОплатыПоставщику.СверхЗаказа 
			|		ИЛИ ЕСТЬNULL(ДанныеДоговора.ЗаданГрафикИсполнения,ЛОЖЬ))
			|		И УменьшениеПланаОплатыПоставщику.ПорядокРасчетов <> ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоНакладным)";
			Организация = "ВЫБОР 
			|		КОГДА УменьшениеПланаОплатыПоставщику.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
			|			ТОГДА УменьшениеПланаОплатыПоставщику.ЗаказЗакупки.Организация
			|		КОГДА УменьшениеПланаОплатыПоставщику.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
			|			ТОГДА ЕСТЬNULL(ДанныеДоговора.Организация, Неопределено)
			|		ИНАЧЕ УменьшениеПланаОплатыПоставщику.ОбъектРасчетов.Организация
			|	КОНЕЦ";
		Иначе
			ВариантОплаты = "Неопределено";
			ИдентификаторФинЗаписи = "ВЫБОР 
			|		КОГДА УменьшениеПланаОплатыПоставщику.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
			|			ТОГДА ЕСТЬNULL(ДанныеДоговора.ОбъектРасчетов.УникальныйИдентификатор, """")
			|		ИНАЧЕ УменьшениеПланаОплатыПоставщику.ОбъектРасчетов.УникальныйИдентификатор
			|	КОНЕЦ";
			НастройкаХозяйственнойОперации = "Неопределено";
			ЗаказЗакупки = "Неопределено";
			Вид = "2";
			ОбъектРасчетов = "ВЫБОР 
			|		КОГДА УменьшениеПланаОплатыПоставщику.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
			|			ТОГДА ЕСТЬNULL(ДанныеДоговора.ОбъектРасчетов, Неопределено)
			|		ИНАЧЕ УменьшениеПланаОплатыПоставщику.ОбъектРасчетов
			|	КОНЕЦ";
			УсловиеОперации = "ЕСТЬNULL(ДанныеДоговора.ЗаданГрафикИсполнения,ЛОЖЬ)
			|		И УменьшениеПланаОплатыПоставщику.ПорядокРасчетов <> ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоНакладным)
			|		И УменьшениеПланаОплатыПоставщику.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаЗадолженности)";
			Организация = "ВЫБОР 
			|		КОГДА УменьшениеПланаОплатыПоставщику.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
			|			ТОГДА ЕСТЬNULL(ДанныеДоговора.Организация, Неопределено)
			|		ИНАЧЕ УменьшениеПланаОплатыПоставщику.ОбъектРасчетов.Организация
			|	КОНЕЦ";
		КонецЕсли;
		
	ИначеЕсли Операция = "ВозвратТоваровПоставщику" Тогда
		
		КОплате = "УменьшениеПланаОплатыПоставщику.СуммаВзаиморасчетов";
		ФормаОплаты = "Неопределено";
		ЗаявкаНаРасходованиеДенежныхСредств = "Неопределено";
		СтатьяДвиженияДенежныхСредств = "Неопределено";
		СвязанныйДокумент = "Неопределено";
		ИдентификаторФинЗаписи = "УменьшениеПланаОплатыПоставщику.ИдентификаторФинЗаписи";
		НастройкаХозяйственнойОперации = "УменьшениеПланаОплатыПоставщику.НастройкаХозяйственнойОперации";
		ЗаказЗакупки = "Неопределено";
		Вид = "5";
		ОбъектРасчетов = "УменьшениеПланаОплатыПоставщику.ОбъектРасчетов";
		УсловиеОперации = "ИСТИНА";
		Организация = "УменьшениеПланаОплатыПоставщику.Организация";
		ВариантОплаты = "Неопределено";
		
	КонецЕсли;
	
	ТекстЗапроса = 
		"ВЫБРАТЬ
		|	УменьшениеПланаОплатыПоставщику.ДатаРегистратора                    КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)                              КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)                     КАК АналитикаУчетаПоПартнерам,
		|	&ОбъектРасчетов                                                     КАК ОбъектРасчетов,
		|	УменьшениеПланаОплатыПоставщику.ВалютаВзаиморасчетов                КАК Валюта,
		|	
		|	0                                                                   КАК Сумма,
		|	0                                                                   КАК Оплачивается,
		|	&КОплате                                                            КАК КОплате,
		|	0                                                                   КАК КПоступлению,
		|	
		|	УменьшениеПланаОплатыПоставщику.ХозяйственнаяОперация               КАК ХозяйственнаяОперация,
		|	&ФормаОплаты                                                        КАК ФормаОплаты,
		|	&ЗаявкаНаРасходованиеДенежныхСредств                                КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	&ЗаказЗакупки                                                       КАК ЗакупкаПоЗаказу,
		|	УменьшениеПланаОплатыПоставщику.ДатаРегистратора                    КАК ДатаРегистратора,
		|	ВЫБОР КОГДА &КОплате < 0
		|			ТОГДА НАЧАЛОПЕРИОДА(УменьшениеПланаОплатыПоставщику.ДатаРегистратора, ДЕНЬ)
		|		ИНАЧЕ ДАТАВРЕМЯ(1,1,1)
		|	КОНЕЦ                                                               КАК ДатаПлатежа,
		|	0                                                                   КАК СуммаРегл,
		|	0                                                                   КАК СуммаУпр,
		|	0                                                                   КАК ЗалогЗаТару,
		|	&СтатьяДвиженияДенежныхСредств                                      КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                                        КАК РасчетныйДокумент,
		|	//Порядок оплаты
		|	//Порядок зачета по дате платежа
		|	&СвязанныйДокумент                                                  КАК СвязанныйДокумент,
		|	&ВариантОплаты                                                      КАК ВариантОплаты,
		|	УменьшениеПланаОплатыПоставщику.ВалютаДокумента                     КАК ВалютаДокумента,
		|	Неопределено                                                        КАК КорОбъектРасчетов,
		|	Неопределено                                                        КАК КорАналитикаУчетаПоПартнерам,
		|	
		|	&Организация                                                        КАК Организация,
		|	УменьшениеПланаОплатыПоставщику.Партнер                             КАК Партнер,
		|	УменьшениеПланаОплатыПоставщику.ОбъектРасчетов.Контрагент           КАК Контрагент,
		|	УменьшениеПланаОплатыПоставщику.ОбъектРасчетов.Договор              КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики                        КАК НаправлениеДеятельности,
		|	
		|	Неопределено                                                        КАК КорПартнер,
		|	Неопределено                                                        КАК КорОрганизация,
		|	Неопределено                                                        КАК КорКонтрагент,
		|	Неопределено                                                        КАК КорДоговор,
		|	Неопределено                                                        КАК КорНаправлениеДеятельности,
		|	УменьшениеПланаОплатыПоставщику.НомерРегистратора                   КАК НомерРегистратора,
		|	&ИдентификаторФинЗаписи                                             КАК ИдентификаторФинЗаписи,
		|	&Вид                                                                КАК Вид,
		|	&НастройкаХозяйственнойОперации                                     КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                                        КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                                        КАК ОбъектРасчетовПриемник,
		|	Неопределено                                                        КАК ВалютаПриемник,
		|	Неопределено                                                        КАК ПартнерПриемник,
		|	Неопределено                                                        КАК ОрганизацияПриемник,
		|	Неопределено                                                        КАК КонтрагентПриемник,
		|	Неопределено                                                        КАК ДоговорПриемник,
		|	Неопределено                                                        КАК НаправлениеДеятельностиПриемник,
		|	0                                                                   КАК СуммаПриемник,
		|	ЛОЖЬ                                                                КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#УменьшениеПланаОплатыПоставщику КАК УменьшениеПланаОплатыПоставщику
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО УменьшениеПланаОплатыПоставщику.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка =  УменьшениеПланаОплатыПоставщику.ОбъектРасчетов.Договор
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|				ПО &Организация = Аналитика.Организация
		|					И УменьшениеПланаОплатыПоставщику.ОбъектРасчетов.Контрагент = Аналитика.Контрагент
		|					И УменьшениеПланаОплатыПоставщику.Партнер = Аналитика.Партнер
		|					И УменьшениеПланаОплатыПоставщику.ОбъектРасчетов.Договор = Аналитика.Договор
		|					И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|ГДЕ
		|	&КОплате <> 0 И &УсловиеОперации
		|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&КОплате",                             КОплате);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ФормаОплаты",                         ФормаОплаты);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЗаявкаНаРасходованиеДенежныхСредств", ЗаявкаНаРасходованиеДенежныхСредств);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СтатьяДвиженияДенежныхСредств",       СтатьяДвиженияДенежныхСредств);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СвязанныйДокумент",                   СвязанныйДокумент);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ИдентификаторФинЗаписи",              ИдентификаторФинЗаписи);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&НастройкаХозяйственнойОперации",      НастройкаХозяйственнойОперации);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&Вид",                                 Вид);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ОбъектРасчетов",                      ОбъектРасчетов);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&УсловиеОперации",                     УсловиеОперации);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&Организация",                         Организация);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЗаказЗакупки",                        ЗаказЗакупки);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ВариантОплаты",                       ВариантОплаты);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция УвеличитьПланПоставкиОтПоставщика(Операция)
	
	Если Операция = "ГрафикИсполненияПоставщик" Тогда
		
		ЭтоЗаказ = "ЛОЖЬ";
		ЭтоНакладная = "ЛОЖЬ";
		ПорядокРасчетов = "ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов)";
		Вид = "1";
		
	ИначеЕсли Операция = "ЗаказПоставщику" Тогда
		
		ЭтоЗаказ = "ИСТИНА";
		ЭтоНакладная = "ЛОЖЬ";
		ПорядокРасчетов = "УвеличениеПланаПоставки.ПорядокРасчетов";
		Вид = "1";
		
	ИначеЕсли Операция = "Закупка" Тогда
		
		ЭтоЗаказ = "ЛОЖЬ";
		ЭтоНакладная = "ИСТИНА";
		ПорядокРасчетов = "УвеличениеПланаПоставки.ПорядокРасчетов";
		Вид = "2";
		
	КонецЕсли;
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	УвеличениеПланаПоставки.Период                           КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)                   КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)          КАК АналитикаУчетаПоПартнерам,
		|	УвеличениеПланаПоставки.ОбъектРасчетов                   КАК ОбъектРасчетов,
		|	УвеличениеПланаПоставки.ВалютаВзаиморасчетов             КАК Валюта,
		|	
		|	0                                                        КАК Сумма,
		|	0                                                        КАК Оплачивается,
		|	0                                                        КАК КОплате,
		|	УвеличениеПланаПоставки.УвеличитьКПоступлению            КАК КПоступлению,
		|	
		|	УвеличениеПланаПоставки.ХозяйственнаяОперация            КАК ХозяйственнаяОперация,
		|	Неопределено                                             КАК ФормаОплаты,
		|	Неопределено                                             КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	УвеличениеПланаПоставки.ЗаказЗакупки                     КАК ЗакупкаПоЗаказу,
		|	УвеличениеПланаПоставки.ДатаРегистратора                 КАК ДатаРегистратора,
		|	ДАТАВРЕМЯ(1,1,1)                                         КАК ДатаПлатежа,
		|	0                                                        КАК СуммаРегл,
		|	0                                                        КАК СуммаУпр,
		|	0                                                        КАК ЗалогЗаТару,
		|	Неопределено                                             КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                             КАК РасчетныйДокумент,
		|	Неопределено                                             КАК СвязанныйДокумент,
		|	Неопределено                                             КАК ВариантОплаты,
		|	УвеличениеПланаПоставки.ВалютаДокумента                  КАК ВалютаДокумента,
		|	Неопределено                                             КАК КорОбъектРасчетов,
		|	Неопределено                                             КАК КорАналитикаУчетаПоПартнерам,
		|	
		|	УвеличениеПланаПоставки.Организация                      КАК Организация,
		|	УвеличениеПланаПоставки.Партнер                          КАК Партнер,
		|	УвеличениеПланаПоставки.Контрагент                       КАК Контрагент,
		|	УвеличениеПланаПоставки.Договор                          КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики             КАК НаправлениеДеятельности,
		|	Неопределено                                             КАК КорПартнер,
		|	Неопределено                                             КАК КорОрганизация,
		|	Неопределено                                             КАК КорКонтрагент,
		|	Неопределено                                             КАК КорДоговор,
		|	Неопределено                                             КАК КорНаправлениеДеятельности,
		|	УвеличениеПланаПоставки.НомерРегистратора                КАК НомерРегистратора,
		|	&ИдентификаторНеиспользуемойФинЗаписи                    КАК ИдентификаторФинЗаписи,
		|	&Вид                                                     КАК Вид,
		|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПустаяСсылка) КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                             КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                             КАК ОбъектРасчетовПриемник,
		|	Неопределено                                             КАК ВалютаПриемник,
		|	Неопределено                                             КАК ПартнерПриемник,
		|	Неопределено                                             КАК ОрганизацияПриемник,
		|	Неопределено                                             КАК КонтрагентПриемник,
		|	Неопределено                                             КАК ДоговорПриемник,
		|	Неопределено                                             КАК НаправлениеДеятельностиПриемник,
		|	0                                                        КАК СуммаПриемник,
		|	ЛОЖЬ                                                     КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	ВтУвеличениеПланаПоставки КАК УвеличениеПланаПоставки
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО УвеличениеПланаПоставки.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|				ПО УвеличениеПланаПоставки.Организация = Аналитика.Организация
		|					И УвеличениеПланаПоставки.ОбъектРасчетов.Контрагент = Аналитика.Контрагент
		|					И УвеличениеПланаПоставки.Партнер = Аналитика.Партнер
		|					И УвеличениеПланаПоставки.Договор = Аналитика.Договор
		|					И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|ГДЕ
		|	НЕ ((&ЭтоЗаказ ИЛИ &ЭтоНакладная) 
		|		И УвеличениеПланаПоставки.ЗаданГрафикИсполнения 
		|		И &ПорядокРасчетов В (ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов), ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным))
		|		И НЕ УвеличениеПланаПоставки.СверхЗаказа)
		|	И (&ЭтоЗаказ 
		|			И &ПорядокРасчетов <> ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоНакладным)
		|		ИЛИ &ЭтоНакладная
		|			И УвеличениеПланаПоставки.НакладнаяПоЗаказам
		|			И &ПорядокРасчетов <> ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоНакладным)
		|			И УвеличениеПланаПоставки.СверхЗаказа
		|		ИЛИ НЕ (&ЭтоЗаказ ИЛИ &ЭтоНакладная))
		|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ПорядокРасчетов",               ПорядокРасчетов);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЭтоЗаказ",                      ЭтоЗаказ);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЭтоНакладная",                  ЭтоНакладная);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&Вид",                           Вид);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция УменьшитьПланПоставкиОтПоставщика()
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	УменьшениеПланаПоставки.ДатаРегистратора                 КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                   КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)          КАК АналитикаУчетаПоПартнерам,
		|	УменьшениеПланаПоставки.ОбъектРасчетов                   КАК ОбъектРасчетов,
		|	УменьшениеПланаПоставки.ВалютаВзаиморасчетов             КАК Валюта,
		|	
		|	0                                                        КАК Сумма,
		|	0                                                        КАК Оплачивается,
		|	0                                                        КАК КОплате,
		|	УменьшениеПланаПоставки.УменьшитьКПоступлению            КАК КПоступлению,
		|	
		|	УменьшениеПланаПоставки.ХозяйственнаяОперация            КАК ХозяйственнаяОперация,
		|	Неопределено                                             КАК ФормаОплаты,
		|	Неопределено                                             КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	УменьшениеПланаПоставки.ЗаказЗакупки                     КАК ЗакупкаПоЗаказу,
		|	УменьшениеПланаПоставки.ДатаРегистратора                 КАК ДатаРегистратора,
		|	ДАТАВРЕМЯ(1,1,1)                                         КАК ДатаПлатежа,
		|	0                                                        КАК СуммаРегл,
		|	0                                                        КАК СуммаУпр,
		|	0                                                        КАК ЗалогЗаТару,
		|	Неопределено                                             КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                             КАК РасчетныйДокумент,
		|	Неопределено                                             КАК СвязанныйДокумент,
		|	Неопределено                                             КАК ВариантОплаты,
		|	УменьшениеПланаПоставки.ВалютаДокумента                  КАК ВалютаДокумента,
		|	Неопределено                                             КАК КорОбъектРасчетов,
		|	Неопределено                                             КАК КорАналитикаУчетаПоПартнерам,
		|	
		|	УменьшениеПланаПоставки.Организация                      КАК Организация,
		|	УменьшениеПланаПоставки.Партнер                          КАК Партнер,
		|	УменьшениеПланаПоставки.ОбъектРасчетов.Контрагент        КАК Контрагент,
		|	УменьшениеПланаПоставки.ОбъектРасчетов.Договор           КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики             КАК НаправлениеДеятельности,
		|	Неопределено                                             КАК КорПартнер,
		|	Неопределено                                             КАК КорОрганизация,
		|	Неопределено                                             КАК КорКонтрагент,
		|	Неопределено                                             КАК КорДоговор,
		|	Неопределено                                             КАК КорНаправлениеДеятельности,
		|	УменьшениеПланаПоставки.НомерРегистратора                КАК НомерРегистратора,
		|	&ИдентификаторНеиспользуемойФинЗаписи                    КАК ИдентификаторФинЗаписи,
		|	""2""                                                    КАК Вид,
		|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПустаяСсылка) КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                             КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                             КАК ОбъектРасчетовПриемник,
		|	Неопределено                                             КАК ВалютаПриемник,
		|	Неопределено                                             КАК ПартнерПриемник,
		|	Неопределено                                             КАК ОрганизацияПриемник,
		|	Неопределено                                             КАК КонтрагентПриемник,
		|	Неопределено                                             КАК ДоговорПриемник,
		|	Неопределено                                             КАК НаправлениеДеятельностиПриемник,
		|	0                                                        КАК СуммаПриемник,
		|	ЛОЖЬ                                                     КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	ВтУменьшениеПланаПоставки КАК УменьшениеПланаПоставки
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО УменьшениеПланаПоставки.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|				ПО УменьшениеПланаПоставки.Организация = Аналитика.Организация
		|					И УменьшениеПланаПоставки.Контрагент = Аналитика.Контрагент
		|					И УменьшениеПланаПоставки.Партнер = Аналитика.Партнер
		|					И УменьшениеПланаПоставки.Договор = Аналитика.Договор
		|					И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|ГДЕ
		|	(УменьшениеПланаПоставки.ЗаданГрафикИсполнения 
		|		И УменьшениеПланаПоставки.ПорядокРасчетов В (ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов),
		|		                                             ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным))
		|	ИЛИ УменьшениеПланаПоставки.НакладнаяПоЗаказам 
		|		И (УменьшениеПланаПоставки.ПорядокРасчетов В (ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказам),
		|		                                              ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным))
		|			ИЛИ УменьшениеПланаПоставки.ПорядокРасчетов В (ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамКонтрагентов),
		|			                                               ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным))
		|				И НЕ УменьшениеПланаПоставки.ЗаданГрафикИсполнения))
		|";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция УвеличитьЗадолженностьПоставщика(Операция)
	
	Если Операция = "ОплатаПоставщику" ИЛИ Операция = "ЗачетОбязательствПоставщика" Тогда
		
		ФормаОплаты = "УвеличениеЗадолженностиПоставщика.ФормаОплаты";
		ЗаявкаНаРасходованиеДенежныхСредств = "УвеличениеЗадолженностиПоставщика.ЗаявкаНаРасходованиеДенежныхСредств";
		СтатьяДвиженияДенежныхСредств = "УвеличениеЗадолженностиПоставщика.СтатьяДвиженияДенежныхСредств";
		СвязанныйДокумент = "УвеличениеЗадолженностиПоставщика.СвязанныйДокумент";
		ИдентификаторФинЗаписи = "УвеличениеЗадолженностиПоставщика.ИдентификаторФинЗаписи";
		НастройкаХозяйственнойОперации = "УвеличениеЗадолженностиПоставщика.НастройкаХозяйственнойОперации";
		Вид = "ВЫБОР КОГДА
		|	УвеличениеЗадолженностиПоставщика.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.УдержаниеВознагражденияКомитентом)
		|		ТОГДА 2
		|	КОГДА УвеличениеЗадолженностиПоставщика.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаЗадолженности)
		|		ТОГДА 3
		|	ИНАЧЕ 4
		|КОНЕЦ";
		Если Операция = "ОплатаПоставщику" Тогда
			СуммаРегл = "УвеличениеЗадолженностиПоставщика.СуммаРегл";
			СуммаУпр = "УвеличениеЗадолженностиПоставщика.СуммаУпр";
			ДатаПлатежа = "ВЫБОР КОГДА УвеличениеЗадолженностиПоставщика.СуммаВзаиморасчетов < 0
			|			ТОГДА НАЧАЛОПЕРИОДА(УвеличениеЗадолженностиПоставщика.ДатаРегистратора, ДЕНЬ)
			|		ИНАЧЕ УвеличениеЗадолженностиПоставщика.ДатаПогашения
			|	КОНЕЦ";
		Иначе
			СуммаРегл = "0";
			СуммаУпр = "0";
			ДатаПлатежа = "ВЫБОР КОГДА УвеличениеЗадолженностиПоставщика.СуммаВзаиморасчетов < 0
			|			ТОГДА НАЧАЛОПЕРИОДА(УвеличениеЗадолженностиПоставщика.ДатаРегистратора, ДЕНЬ)
			|		ИНАЧЕ ДАТАВРЕМЯ(1,1,1)
			|	КОНЕЦ";
		КонецЕсли;
		
	ИначеЕсли Операция = "ВозвратТоваровПоставщику" Тогда
		
		ФормаОплаты = "Неопределено";
		ЗаявкаНаРасходованиеДенежныхСредств = "Неопределено";
		СтатьяДвиженияДенежныхСредств = "Неопределено";
		СвязанныйДокумент = "Неопределено";
		ИдентификаторФинЗаписи = "УвеличениеЗадолженностиПоставщика.ИдентификаторФинЗаписи";
		НастройкаХозяйственнойОперации = "УвеличениеЗадолженностиПоставщика.НастройкаХозяйственнойОперации";
		Вид = "4";
		СуммаРегл = "0";
		СуммаУпр = "0";
		ДатаПлатежа = "ВЫБОР КОГДА УвеличениеЗадолженностиПоставщика.СуммаВзаиморасчетов < 0
		|			ТОГДА НАЧАЛОПЕРИОДА(УвеличениеЗадолженностиПоставщика.ДатаРегистратора, ДЕНЬ)
		|		ИНАЧЕ ДАТАВРЕМЯ(1,1,1)
		|	КОНЕЦ";
		
	ИначеЕсли Операция = "Закупка" Тогда
		
		ФормаОплаты = "Неопределено";
		ЗаявкаНаРасходованиеДенежныхСредств = "Неопределено";
		СтатьяДвиженияДенежныхСредств = "Неопределено";
		СвязанныйДокумент = "Неопределено";
		ИдентификаторФинЗаписи = "УвеличениеЗадолженностиПоставщика.ОбъектРасчетов.УникальныйИдентификатор";
		НастройкаХозяйственнойОперации = "Неопределено";
		Вид = "2";
		СуммаРегл = "0";
		СуммаУпр = "0";
		ДатаПлатежа = "ВЫБОР КОГДА УвеличениеЗадолженностиПоставщика.СуммаВзаиморасчетов < 0
		|			ТОГДА НАЧАЛОПЕРИОДА(УвеличениеЗадолженностиПоставщика.ДатаРегистратора, ДЕНЬ)
		|		ИНАЧЕ ДАТАВРЕМЯ(1,1,1)
		|	КОНЕЦ";
		
	КонецЕсли;
	
	ТекстЗапроса = 
		"ВЫБРАТЬ
		|	УвеличениеЗадолженностиПоставщика.ДатаРегистратора                   КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)                               КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)                      КАК АналитикаУчетаПоПартнерам,
		|	УвеличениеЗадолженностиПоставщика.ОбъектРасчетов                     КАК ОбъектРасчетов,
		|	УвеличениеЗадолженностиПоставщика.ВалютаВзаиморасчетов               КАК Валюта,
		|	
		|	УвеличениеЗадолженностиПоставщика.СуммаВзаиморасчетов                КАК Сумма,
		|	0                                                                    КАК Оплачивается,
		|	0                                                                    КАК КОплате,
		|	0                                                                    КАК КПоступлению,
		|	
		|	УвеличениеЗадолженностиПоставщика.ХозяйственнаяОперация              КАК ХозяйственнаяОперация,
		|	&ФормаОплаты                                                         КАК ФормаОплаты,
		|	&ЗаявкаНаРасходованиеДенежныхСредств                                 КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	Неопределено                                                         КАК ЗакупкаПоЗаказу,
		|	УвеличениеЗадолженностиПоставщика.ДатаРегистратора                   КАК ДатаРегистратора,
		|	&ДатаПлатежа                                                         КАК ДатаПлатежа,
		|	ВЫБОР КОГДА УвеличениеЗадолженностиПоставщика.ВалютаВзаиморасчетов = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА УвеличениеЗадолженностиПоставщика.СуммаВзаиморасчетов
		|			КОГДА УвеличениеЗадолженностиПоставщика.ВалютаДокумента = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА УвеличениеЗадолженностиПоставщика.Сумма
		|			ИНАЧЕ ВЫБОР КОГДА &СуммаРегл = 0 
		|						ТОГДА ВЫРАЗИТЬ(УвеличениеЗадолженностиПоставщика.Сумма * Коэффициенты.КоэффициентРегл КАК ЧИСЛО(31,2))
		|					ИНАЧЕ &СуммаРегл
		|				КОНЕЦ
		|	КОНЕЦ                                                                КАК СуммаРегл,
		|	ВЫБОР КОГДА УвеличениеЗадолженностиПоставщика.ВалютаВзаиморасчетов = &ВалютаУправленческогоУчета
		|				ТОГДА УвеличениеЗадолженностиПоставщика.СуммаВзаиморасчетов
		|			КОГДА УвеличениеЗадолженностиПоставщика.ВалютаДокумента = &ВалютаУправленческогоУчета
		|				ТОГДА УвеличениеЗадолженностиПоставщика.Сумма
		|			ИНАЧЕ ВЫБОР КОГДА &СуммаУпр = 0 
		|						ТОГДА ВЫРАЗИТЬ(УвеличениеЗадолженностиПоставщика.Сумма * Коэффициенты.КоэффициентУпр КАК ЧИСЛО(31,2))
		|					ИНАЧЕ &СуммаУпр
		|				КОНЕЦ
		|	КОНЕЦ                                                               КАК СуммаУпр,
		|	0                                                                   КАК ЗалогЗаТару,
		|	&СтатьяДвиженияДенежныхСредств                                      КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                                        КАК РасчетныйДокумент,
		|	//Порядок оплаты
		|	//Порядок зачета по дате платежа
		|	&СвязанныйДокумент                                                  КАК СвязанныйДокумент,
		|	Неопределено                                                        КАК ВариантОплаты,
		|	УвеличениеЗадолженностиПоставщика.ВалютаДокумента                   КАК ВалютаДокумента,
		|	Неопределено                                                        КАК КорОбъектРасчетов,
		|	Неопределено                                                        КАК КорАналитикаУчетаПоПартнерам,
		|	
		|	ВЫБОР КОГДА УвеличениеЗадолженностиПоставщика.Организация <> УвеличениеЗадолженностиПоставщика.ОбъектРасчетов.Организация
		|		ТОГДА УвеличениеЗадолженностиПоставщика.Организация
		|		ИНАЧЕ УвеличениеЗадолженностиПоставщика.ОбъектРасчетов.Организация
		|	КОНЕЦ                                                               КАК Организация,
		|	УвеличениеЗадолженностиПоставщика.Партнер                           КАК Партнер,
		|	УвеличениеЗадолженностиПоставщика.ОбъектРасчетов.Контрагент         КАК Контрагент,
		|	УвеличениеЗадолженностиПоставщика.ОбъектРасчетов.Договор            КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики                        КАК НаправлениеДеятельности,
		|	
		|	Неопределено                                                        КАК КорПартнер,
		|	Неопределено                                                        КАК КорОрганизация,
		|	Неопределено                                                        КАК КорКонтрагент,
		|	Неопределено                                                        КАК КорДоговор,
		|	Неопределено                                                        КАК КорНаправлениеДеятельности,
		|	УвеличениеЗадолженностиПоставщика.НомерРегистратора                 КАК НомерРегистратора,
		|	&ИдентификаторФинЗаписи                                             КАК ИдентификаторФинЗаписи,
		|	&Вид                                                                КАК Вид,
		|	&НастройкаХозяйственнойОперации                                     КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                                        КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                                        КАК ОбъектРасчетовПриемник,
		|	Неопределено                                                        КАК ВалютаПриемник,
		|	Неопределено                                                        КАК ПартнерПриемник,
		|	Неопределено                                                        КАК ОрганизацияПриемник,
		|	Неопределено                                                        КАК КонтрагентПриемник,
		|	Неопределено                                                        КАК ДоговорПриемник,
		|	Неопределено                                                        КАК НаправлениеДеятельностиПриемник,
		|	0                                                                   КАК СуммаПриемник,
		|	ЛОЖЬ                                                                КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#УвеличениеЗадолженностиПоставщика КАК УвеличениеЗадолженностиПоставщика
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО УвеличениеЗадолженностиПоставщика.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка = УвеличениеЗадолженностиПоставщика.ОбъектРасчетов.Договор
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|				ПО ВЫБОР КОГДА УвеличениеЗадолженностиПоставщика.Организация <> УвеличениеЗадолженностиПоставщика.ОбъектРасчетов.Организация
		|							ТОГДА УвеличениеЗадолженностиПоставщика.Организация
		|							ИНАЧЕ УвеличениеЗадолженностиПоставщика.ОбъектРасчетов.Организация
		|					КОНЕЦ = Аналитика.Организация
		|					И УвеличениеЗадолженностиПоставщика.ОбъектРасчетов.Контрагент = Аналитика.Контрагент
		|					И УвеличениеЗадолженностиПоставщика.Партнер = Аналитика.Партнер
		|					И УвеличениеЗадолженностиПоставщика.ОбъектРасчетов.Договор = Аналитика.Договор
		|					И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаиморасчетыВтКоэффициентыПересчетаВалют КАК Коэффициенты
		|			ПО Коэффициенты.Ссылка = УвеличениеЗадолженностиПоставщика.Ссылка
		|				И Коэффициенты.ОбъектРасчетов = УвеличениеЗадолженностиПоставщика.ОбъектРасчетов
		|				И Коэффициенты.ВалютаВзаиморасчетов = УвеличениеЗадолженностиПоставщика.ВалютаВзаиморасчетов
		|				И Коэффициенты.ДатаКурса = УвеличениеЗадолженностиПоставщика.ДатаКурса
		|ГДЕ
		|	УвеличениеЗадолженностиПоставщика.СуммаВзаиморасчетов <> 0
		|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ФормаОплаты",                         ФормаОплаты);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЗаявкаНаРасходованиеДенежныхСредств", ЗаявкаНаРасходованиеДенежныхСредств);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СтатьяДвиженияДенежныхСредств",       СтатьяДвиженияДенежныхСредств);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СвязанныйДокумент",                   СвязанныйДокумент);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ИдентификаторФинЗаписи",              ИдентификаторФинЗаписи);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&НастройкаХозяйственнойОперации",      НастройкаХозяйственнойОперации);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&Вид",                                 Вид);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СуммаРегл",                           СуммаРегл);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СуммаУпр",                            СуммаУпр);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ДатаПлатежа",                         ДатаПлатежа);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция УвеличитьНашуЗадолженностьПоставщику(Операция)
	
	Если Операция = "Закупка" Тогда
		
		ЗаказЗакупки = "УвеличениеНашейЗадолженностиПоставщику.ЗаказЗакупки";
		ДатаПлатежа = "ВЫБОР КОГДА УвеличениеНашейЗадолженностиПоставщику.Сумма < 0
						|		ТОГДА ДАТАВРЕМЯ(1,1,1)
						|	ИНАЧЕ УвеличениеНашейЗадолженностиПоставщику.ДатаПлатежа
						|КОНЕЦ";
		ЗалогЗаТару = "УвеличениеНашейЗадолженностиПоставщику.СуммаВзаиморасчетовПоТаре";
		СтатьяДвиженияДенежныхСредств = "Неопределено";
		СвязанныйДокумент = "УвеличениеНашейЗадолженностиПоставщику.СвязанныйДокумент";
		ИдентификаторФинЗаписи = "УвеличениеНашейЗадолженностиПоставщику.ОбъектРасчетов.УникальныйИдентификатор";
		НастройкаХозяйственнойОперации = "Неопределено";
		ХозяйственнаяОперация = "УвеличениеНашейЗадолженностиПоставщику.ХозяйственнаяОперация";
		Вид = "2";
		ВариантОплаты = "УвеличениеНашейЗадолженностиПоставщику.ВариантОплаты";
		
	ИначеЕсли Операция = "ВозвратОплатыОтПоставщика" Тогда
		
		ЗаказЗакупки = "Неопределено";
		ДатаПлатежа = "НАЧАЛОПЕРИОДА(УвеличениеНашейЗадолженностиПоставщику.ДатаРегистратора, ДЕНЬ)";
		ЗалогЗаТару = "0";
		СтатьяДвиженияДенежныхСредств = "УвеличениеНашейЗадолженностиПоставщику.СтатьяДвиженияДенежныхСредств";
		СвязанныйДокумент = "Неопределено";
		ИдентификаторФинЗаписи = "УвеличениеНашейЗадолженностиПоставщику.ИдентификаторФинЗаписи";
		НастройкаХозяйственнойОперации = "УвеличениеНашейЗадолженностиПоставщику.НастройкаХозяйственнойОперации";
		ХозяйственнаяОперация = "УвеличениеНашейЗадолженностиПоставщику.ХозяйственнаяОперация";
		Вид = "5";
		ВариантОплаты = "Неопределено";
		
	КонецЕсли;
	
	ТекстЗапроса = 
		"ВЫБРАТЬ
		|	УвеличениеНашейЗадолженностиПоставщику.ДатаРегистратора               КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                                КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)                       КАК АналитикаУчетаПоПартнерам,
		|	УвеличениеНашейЗадолженностиПоставщику.ОбъектРасчетов                 КАК ОбъектРасчетов,
		|	УвеличениеНашейЗадолженностиПоставщику.ВалютаВзаиморасчетов           КАК Валюта,
		|	
		|	(УвеличениеНашейЗадолженностиПоставщику.СуммаВзаиморасчетов)          КАК Сумма,
		|	0                                                                     КАК Оплачивается,
		|	0                                                                     КАК КОплате,
		|	0                                                                     КАК КПоступлению,
		|	
		|	&ХозяйственнаяОперация                                                КАК ХозяйственнаяОперация,
		|	УвеличениеНашейЗадолженностиПоставщику.ФормаОплаты                    КАК ФормаОплаты,
		|	Неопределено                                                          КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	&ЗаказЗакупки                                                         КАК ЗакупкаПоЗаказу,
		|	УвеличениеНашейЗадолженностиПоставщику.ДатаРегистратора               КАК ДатаРегистратора,
		|	&ДатаПлатежа                                                          КАК ДатаПлатежа,
		|	ВЫБОР КОГДА УвеличениеНашейЗадолженностиПоставщику.ВалютаВзаиморасчетов = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА УвеличениеНашейЗадолженностиПоставщику.СуммаВзаиморасчетов
		|			КОГДА УвеличениеНашейЗадолженностиПоставщику.ВалютаДокумента = Коэффициенты.ВалютаРегламентированногоУчета
		|				ТОГДА УвеличениеНашейЗадолженностиПоставщику.Сумма
		|			ИНАЧЕ ВЫРАЗИТЬ(УвеличениеНашейЗадолженностиПоставщику.Сумма * Коэффициенты.КоэффициентРегл КАК ЧИСЛО(31,2))
		|	КОНЕЦ                                                                 КАК СуммаРегл,
		|	ВЫБОР КОГДА УвеличениеНашейЗадолженностиПоставщику.ВалютаВзаиморасчетов = &ВалютаУправленческогоУчета
		|				ТОГДА УвеличениеНашейЗадолженностиПоставщику.СуммаВзаиморасчетов
		|			КОГДА УвеличениеНашейЗадолженностиПоставщику.ВалютаДокумента = &ВалютаУправленческогоУчета
		|				ТОГДА УвеличениеНашейЗадолженностиПоставщику.Сумма
		|			ИНАЧЕ ВЫРАЗИТЬ(УвеличениеНашейЗадолженностиПоставщику.Сумма * Коэффициенты.КоэффициентУпр КАК ЧИСЛО(31,2))
		|	КОНЕЦ                                                                 КАК СуммаУпр,
		|	&ЗалогЗаТару                                                          КАК ЗалогЗаТару,
		|	&СтатьяДвиженияДенежныхСредств                                        КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                                          КАК РасчетныйДокумент,
		|	//Порядок оплаты
		|	//Порядок зачета по дате платежа
		|	&СвязанныйДокумент                                                    КАК СвязанныйДокумент,
		|	&ВариантОплаты                                                        КАК ВариантОплаты,
		|	УвеличениеНашейЗадолженностиПоставщику.ВалютаДокумента                КАК ВалютаДокумента,
		|	Неопределено                                                          КАК КорОбъектРасчетов,
		|	Неопределено                                                          КАК КорАналитикаУчетаПоПартнерам,
		|	
		|	ВЫБОР КОГДА ЕСТЬNULL(ДанныеДоговора.ЦентрализованныйДоговор, Ложь)
		|		ТОГДА УвеличениеНашейЗадолженностиПоставщику.Организация
		|		ИНАЧЕ УвеличениеНашейЗадолженностиПоставщику.ОбъектРасчетов.Организация
		|	КОНЕЦ                                                                 КАК Организация,
		|	УвеличениеНашейЗадолженностиПоставщику.Партнер                        КАК Партнер,
		|	УвеличениеНашейЗадолженностиПоставщику.ОбъектРасчетов.Контрагент      КАК Контрагент,
		|	УвеличениеНашейЗадолженностиПоставщику.ОбъектРасчетов.Договор         КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики                          КАК НаправлениеДеятельности,
		|	
		|	Неопределено                                                          КАК КорПартнер,
		|	Неопределено                                                          КАК КорОрганизация,
		|	Неопределено                                                          КАК КорКонтрагент,
		|	Неопределено                                                          КАК КорДоговор,
		|	Неопределено                                                          КАК КорНаправлениеДеятельности,
		|	УвеличениеНашейЗадолженностиПоставщику.НомерРегистратора              КАК НомерРегистратора,
		|	&ИдентификаторФинЗаписи                                               КАК ИдентификаторФинЗаписи,
		|	&Вид                                                                  КАК Вид,
		|	&НастройкаХозяйственнойОперации                                       КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                                          КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                                          КАК ОбъектРасчетовПриемник,
		|	Неопределено                                                          КАК ВалютаПриемник,
		|	Неопределено                                                          КАК ПартнерПриемник,
		|	Неопределено                                                          КАК ОрганизацияПриемник,
		|	Неопределено                                                          КАК КонтрагентПриемник,
		|	Неопределено                                                          КАК ДоговорПриемник,
		|	Неопределено                                                          КАК НаправлениеДеятельностиПриемник,
		|	0                                                                     КАК СуммаПриемник,
		|	ЛОЖЬ                                                                  КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#УвеличениеНашейЗадолженностиПоставщику КАК УвеличениеНашейЗадолженностиПоставщику
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО УвеличениеНашейЗадолженностиПоставщику.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка = УвеличениеНашейЗадолженностиПоставщику.ОбъектРасчетов.Договор
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|				ПО ВЫБОР КОГДА ЕСТЬNULL(ДанныеДоговора.ЦентрализованныйДоговор, Ложь)
		|							ТОГДА УвеличениеНашейЗадолженностиПоставщику.Организация
		|							ИНАЧЕ УвеличениеНашейЗадолженностиПоставщику.ОбъектРасчетов.Организация
		|					КОНЕЦ = Аналитика.Организация
		|					И УвеличениеНашейЗадолженностиПоставщику.ОбъектРасчетов.Контрагент = Аналитика.Контрагент
		|					И УвеличениеНашейЗадолженностиПоставщику.Партнер = Аналитика.Партнер
		|					И УвеличениеНашейЗадолженностиПоставщику.ОбъектРасчетов.Договор = Аналитика.Договор
		|					И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаиморасчетыВтКоэффициентыПересчетаВалют КАК Коэффициенты
		|			ПО Коэффициенты.Ссылка = УвеличениеНашейЗадолженностиПоставщику.Ссылка
		|				И Коэффициенты.ОбъектРасчетов = УвеличениеНашейЗадолженностиПоставщику.ОбъектРасчетов
		|				И Коэффициенты.ВалютаВзаиморасчетов = УвеличениеНашейЗадолженностиПоставщику.ВалютаВзаиморасчетов
		|				И Коэффициенты.ДатаКурса = УвеличениеНашейЗадолженностиПоставщику.ДатаКурса
		|ГДЕ
		|	УвеличениеНашейЗадолженностиПоставщику.СуммаВзаиморасчетов <> 0
		|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЗаказЗакупки",                   ЗаказЗакупки);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ДатаПлатежа",                    ДатаПлатежа);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЗалогЗаТару",                    ЗалогЗаТару);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СтатьяДвиженияДенежныхСредств",  СтатьяДвиженияДенежныхСредств);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СвязанныйДокумент",              СвязанныйДокумент);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ИдентификаторФинЗаписи",         ИдентификаторФинЗаписи);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&НастройкаХозяйственнойОперации", НастройкаХозяйственнойОперации);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ХозяйственнаяОперация",          ХозяйственнаяОперация);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&Вид",                            Вид);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ВариантОплаты",                  ВариантОплаты);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция УвеличитьОплачиваетсяПоставщику(Операция)
	
	Если Операция = "ЗаявкаНаОплатуПоставщику" Тогда
		ЗаявкаНаРасходованиеДенежныхСредств = "УвеличениеОплачиваетсяПоставщику.Ссылка";
		Вид = "1";
	ИначеЕсли Операция = "ОплатаПоставщику" Тогда
		ЗаявкаНаРасходованиеДенежныхСредств = "УвеличениеОплачиваетсяПоставщику.ЗаявкаНаРасходованиеДенежныхСредств";
		Вид = "4";
	КонецЕсли;
	
	ТекстЗапроса = 
		"ВЫБРАТЬ
		|	УвеличениеОплачиваетсяПоставщику.ДатаРегистратора                   КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                              КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)                     КАК АналитикаУчетаПоПартнерам,
		|	УвеличениеОплачиваетсяПоставщику.ОбъектРасчетов                     КАК ОбъектРасчетов,
		|	УвеличениеОплачиваетсяПоставщику.ВалютаВзаиморасчетов               КАК Валюта,
		|	
		|	0                                                                   КАК Сумма,
		|	(УвеличениеОплачиваетсяПоставщику.УвеличениеОплачивается)           КАК Оплачивается,
		|	0                                                                   КАК КОплате,
		|	0                                                                   КАК КПоступлению,
		|	
		|	УвеличениеОплачиваетсяПоставщику.ХозяйственнаяОперация              КАК ХозяйственнаяОперация,
		|	УвеличениеОплачиваетсяПоставщику.ФормаОплаты                        КАК ФормаОплаты,
		|	&ЗаявкаНаРасходованиеДенежныхСредств                                КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	Неопределено                                                        КАК ЗакупкаПоЗаказу,
		|	УвеличениеОплачиваетсяПоставщику.ДатаРегистратора                   КАК ДатаРегистратора,
		|	ДАТАВРЕМЯ(1,1,1)                                                    КАК ДатаПлатежа,
		|	0                                                                   КАК СуммаРегл,
		|	0                                                                   КАК СуммаУпр,
		|	0                                                                   КАК ЗалогЗаТару,
		|	УвеличениеОплачиваетсяПоставщику.СтатьяДвиженияДенежныхСредств      КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                                        КАК РасчетныйДокумент,
		|	//Порядок оплаты
		|	//Порядок зачета по дате платежа
		|	Неопределено                                                        КАК СвязанныйДокумент,
		|	Неопределено                                                        КАК ВариантОплаты,
		|	УвеличениеОплачиваетсяПоставщику.ВалютаДокумента                    КАК ВалютаДокумента,
		|	Неопределено                                                        КАК КорОбъектРасчетов,
		|	Неопределено                                                        КАК КорАналитикаУчетаПоПартнерам,
		|	
		|	УвеличениеОплачиваетсяПоставщику.ОбъектРасчетов.Организация         КАК Организация,
		|	УвеличениеОплачиваетсяПоставщику.Партнер                            КАК Партнер,
		|	УвеличениеОплачиваетсяПоставщику.ОбъектРасчетов.Контрагент          КАК Контрагент,
		|	УвеличениеОплачиваетсяПоставщику.ОбъектРасчетов.Договор             КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики                        КАК НаправлениеДеятельности,
		|	
		|	Неопределено                                                        КАК КорПартнер,
		|	Неопределено                                                        КАК КорОрганизация,
		|	Неопределено                                                        КАК КорКонтрагент,
		|	Неопределено                                                        КАК КорДоговор,
		|	Неопределено                                                        КАК КорНаправлениеДеятельности,
		|	УвеличениеОплачиваетсяПоставщику.НомерРегистратора                  КАК НомерРегистратора,
		|	&ИдентификаторНеиспользуемойФинЗаписи                               КАК ИдентификаторФинЗаписи,
		|	&Вид                                                                КАК Вид,
		|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПустаяСсылка)    КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                                        КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                                        КАК ОбъектРасчетовПриемник,
		|	Неопределено                                                        КАК ВалютаПриемник,
		|	Неопределено                                                        КАК ПартнерПриемник,
		|	Неопределено                                                        КАК ОрганизацияПриемник,
		|	Неопределено                                                        КАК КонтрагентПриемник,
		|	Неопределено                                                        КАК ДоговорПриемник,
		|	Неопределено                                                        КАК НаправлениеДеятельностиПриемник,
		|	0                                                                   КАК СуммаПриемник,
		|	ЛОЖЬ                                                                КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#УвеличениеОплачиваетсяПоставщику КАК УвеличениеОплачиваетсяПоставщику
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО УвеличениеОплачиваетсяПоставщику.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка =  УвеличениеОплачиваетсяПоставщику.ОбъектРасчетов.Договор
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|				ПО УвеличениеОплачиваетсяПоставщику.ОбъектРасчетов.Организация = Аналитика.Организация
		|					И УвеличениеОплачиваетсяПоставщику.ОбъектРасчетов.Контрагент = Аналитика.Контрагент
		|					И УвеличениеОплачиваетсяПоставщику.Партнер = Аналитика.Партнер
		|					И УвеличениеОплачиваетсяПоставщику.ОбъектРасчетов.Договор = Аналитика.Договор
		|					И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|ГДЕ
		|	УвеличениеОплачиваетсяПоставщику.УвеличениеОплачивается > 0
		|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЗаявкаНаРасходованиеДенежныхСредств", ЗаявкаНаРасходованиеДенежныхСредств);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&Вид",                                 Вид);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция УменьшитьОплачиваетсяПоставщику()
	
	ТекстЗапроса = 
		"ВЫБРАТЬ
		|	УменьшениеОплачиваетсяПоставщику.ДатаРегистратора                    КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)                               КАК ВидДвижения,
		|	
		|	ЕСТЬNULL(Аналитика.КлючАналитики, Неопределено)                      КАК АналитикаУчетаПоПартнерам,
		|	УменьшениеОплачиваетсяПоставщику.ОбъектРасчетов                      КАК ОбъектРасчетов,
		|	УменьшениеОплачиваетсяПоставщику.ВалютаВзаиморасчетов                КАК Валюта,
		|	
		|	0                                                                    КАК Сумма,
		|	(УменьшениеОплачиваетсяПоставщику.УменьшениеОплачивается)            КАК Оплачивается,
		|	0                                                                    КАК КОплате,
		|	0                                                                    КАК КПоступлению,
		|	
		|	УменьшениеОплачиваетсяПоставщику.ХозяйственнаяОперация               КАК ХозяйственнаяОперация,
		|	УменьшениеОплачиваетсяПоставщику.ФормаОплаты                         КАК ФормаОплаты,
		|	УменьшениеОплачиваетсяПоставщику.ЗаявкаНаРасходованиеДенежныхСредств КАК ЗаявкаНаРасходованиеДенежныхСредств,
		|	Неопределено                                                         КАК ЗакупкаПоЗаказу,
		|	УменьшениеОплачиваетсяПоставщику.ДатаРегистратора                    КАК ДатаРегистратора,
		|	ДАТАВРЕМЯ(1,1,1)                                                     КАК ДатаПлатежа,
		|	0                                                                    КАК СуммаРегл,
		|	0                                                                    КАК СуммаУпр,
		|	0                                                                    КАК ЗалогЗаТару,
		|	УменьшениеОплачиваетсяПоставщику.СтатьяДвиженияДенежныхСредств       КАК СтатьяДвиженияДенежныхСредств,
		|	Неопределено                                                         КАК РасчетныйДокумент,
		|	//Порядок оплаты
		|	//Порядок зачета по дате платежа
		|	Неопределено                                                         КАК СвязанныйДокумент,
		|	Неопределено                                                         КАК ВариантОплаты,
		|	УменьшениеОплачиваетсяПоставщику.ВалютаДокумента                     КАК ВалютаДокумента,
		|	Неопределено                                                         КАК КорОбъектРасчетов,
		|	Неопределено                                                         КАК КорАналитикаУчетаПоПартнерам,
		|	
		|	УменьшениеОплачиваетсяПоставщику.ОбъектРасчетов.Организация          КАК Организация,
		|	УменьшениеОплачиваетсяПоставщику.Партнер                             КАК Партнер,
		|	УменьшениеОплачиваетсяПоставщику.ОбъектРасчетов.Контрагент           КАК Контрагент,
		|	УменьшениеОплачиваетсяПоставщику.ОбъектРасчетов.Договор              КАК Договор,
		|	НаправленияДеятельности.НаправлениеАналитики                         КАК НаправлениеДеятельности,
		|	
		|	Неопределено                                                         КАК КорПартнер,
		|	Неопределено                                                         КАК КорОрганизация,
		|	Неопределено                                                         КАК КорКонтрагент,
		|	Неопределено                                                         КАК КорДоговор,
		|	Неопределено                                                         КАК КорНаправлениеДеятельности,
		|	УменьшениеОплачиваетсяПоставщику.НомерРегистратора                   КАК НомерРегистратора,
		|	&ИдентификаторНеиспользуемойФинЗаписи                                КАК ИдентификаторФинЗаписи,
		|	""4""                                                                КАК Вид,
		|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПустаяСсылка)     КАК НастройкаХозяйственнойОперации,
		|	Неопределено                                                         КАК АналитикаУчетаПоПартнерамПриемник,
		|	Неопределено                                                         КАК ОбъектРасчетовПриемник,
		|	Неопределено                                                         КАК ВалютаПриемник,
		|	Неопределено                                                         КАК ПартнерПриемник,
		|	Неопределено                                                         КАК ОрганизацияПриемник,
		|	Неопределено                                                         КАК КонтрагентПриемник,
		|	Неопределено                                                         КАК ДоговорПриемник,
		|	Неопределено                                                         КАК НаправлениеДеятельностиПриемник,
		|	0                                                                    КАК СуммаПриемник,
		|	ЛОЖЬ                                                                 КАК ПоДаннымОбъектаРасчетовИсточника
		|ИЗ
		|	#УменьшениеОплачиваетсяПоставщику КАК УменьшениеОплачиваетсяПоставщику
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНаправленияДеятельности КАК НаправленияДеятельности
		|			ПО УменьшениеОплачиваетсяПоставщику.ОбъектРасчетов = НаправленияДеятельности.ОбъектРасчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка =  УменьшениеОплачиваетсяПоставщику.ОбъектРасчетов.Договор
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
		|				ПО УменьшениеОплачиваетсяПоставщику.ОбъектРасчетов.Организация = Аналитика.Организация
		|					И УменьшениеОплачиваетсяПоставщику.ОбъектРасчетов.Контрагент = Аналитика.Контрагент
		|					И УменьшениеОплачиваетсяПоставщику.Партнер = Аналитика.Партнер
		|					И УменьшениеОплачиваетсяПоставщику.ОбъектРасчетов.Договор = Аналитика.Договор
		|					И НаправленияДеятельности.НаправлениеАналитики = Аналитика.НаправлениеДеятельности
		|ГДЕ
		|	УменьшениеОплачиваетсяПоставщику.УменьшениеОплачивается > 0
		|";
	
	Возврат ТекстЗапроса;
	
КонецФункции

#КонецОбласти

Функция ТекстЗапросаВТУменьшениеПланаОтгрузки()
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	УменьшениеПланаОтгрузкиКлиенту.ДатаРегистратора          КАК Период,
		|	УменьшениеПланаОтгрузкиКлиенту.ПорядокРасчетов           КАК ПорядокРасчетов,
		|	УменьшениеПланаОтгрузкиКлиенту.НакладнаяПоЗаказам        КАК НакладнаяПоЗаказам,
		|	
		|	ВЫБОР
		|		КОГДА УменьшениеПланаОтгрузкиКлиенту.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
		|			ТОГДА УменьшениеПланаОтгрузкиКлиенту.ЗаказПродажи.ОбъектРасчетов
		|		КОГДА УменьшениеПланаОтгрузкиКлиенту.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
		|			ТОГДА ОбъектыРасчетовДоговор.Ссылка
		|		ИНАЧЕ УменьшениеПланаОтгрузкиКлиенту.ОбъектРасчетов
		|	КОНЕЦ                                                    КАК ОбъектРасчетов,
		|	УменьшениеПланаОтгрузкиКлиенту.ВалютаВзаиморасчетов      КАК ВалютаВзаиморасчетов,
		|	
		|	УменьшениеПланаОтгрузкиКлиенту.УменьшитьКОтгрузке        КАК УменьшитьКОтгрузке,
		|	
		|	УменьшениеПланаОтгрузкиКлиенту.ХозяйственнаяОперация     КАК ХозяйственнаяОперация,
		|	УменьшениеПланаОтгрузкиКлиенту.ЗаказПродажи              КАК ЗаказПродажи,
		|	УменьшениеПланаОтгрузкиКлиенту.ДатаРегистратора          КАК ДатаРегистратора,
		|	УменьшениеПланаОтгрузкиКлиенту.ДатаРегистратора          КАК ДатаПлатежа,
		|	ЕСТЬNULL(ДанныеДоговора.ДопустимаяСуммаЗадолженности, 0) КАК ДопустимаяСуммаЗадолженности,
		|	УменьшениеПланаОтгрузкиКлиенту.ВалютаДокумента           КАК ВалютаДокумента,
		|	
		|	ВЫБОР
		|		КОГДА УменьшениеПланаОтгрузкиКлиенту.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
		|			ТОГДА УменьшениеПланаОтгрузкиКлиенту.ОбъектРасчетов.Организация
		|		КОГДА УменьшениеПланаОтгрузкиКлиенту.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
		|			ТОГДА ОбъектыРасчетовДоговор.Организация
		|		КОГДА ЕСТЬNULL(ДанныеДоговора.ЗаданГрафикИсполнения, ЛОЖЬ)
		|			ТОГДА УменьшениеПланаОтгрузкиКлиенту.ОбъектРасчетов.Организация
		|		ИНАЧЕ УменьшениеПланаОтгрузкиКлиенту.Организация
		|	КОНЕЦ                                                    КАК Организация,
		|	ВЫБОР
		|		КОГДА УменьшениеПланаОтгрузкиКлиенту.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
		|			ТОГДА УменьшениеПланаОтгрузкиКлиенту.ОбъектРасчетов.Партнер
		|		ИНАЧЕ УменьшениеПланаОтгрузкиКлиенту.Партнер
		|	КОНЕЦ                                                    КАК Партнер,
		|	ВЫБОР
		|		КОГДА УменьшениеПланаОтгрузкиКлиенту.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
		|			ТОГДА ОбъектыРасчетовДоговор.Контрагент
		|		ИНАЧЕ УменьшениеПланаОтгрузкиКлиенту.ОбъектРасчетов.Контрагент
		|	КОНЕЦ                                                    КАК Контрагент,
		|	ВЫБОР
		|		КОГДА УменьшениеПланаОтгрузкиКлиенту.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
		|			ТОГДА ДанныеДоговора.Ссылка
		|		ИНАЧЕ УменьшениеПланаОтгрузкиКлиенту.ОбъектРасчетов.Договор
		|	КОНЕЦ                                                    КАК Договор,
		|	УменьшениеПланаОтгрузкиКлиенту.НомерРегистратора         КАК НомерРегистратора,
		|	ЕСТЬNULL(ДанныеДоговора.ЗаданГрафикИсполнения, ЛОЖЬ)     КАК ЗаданГрафикИсполнения,
		|	ЕСТЬNULL(ЕСТЬNULL(ДокументЗаказКлиента.ЭтоЗаказКакСчет, ДокументЗаявкаНаВозвратТоваровОтКлиента.ЭтоЗаказКакСчет), ЛОЖЬ) КАК ЭтоЗаказКакСчет
		|ПОМЕСТИТЬ ВтУменьшениеПланаОтгрузкиКлиенту
		|ИЗ
		|	#УменьшениеПланаОтгрузкиКлиенту КАК УменьшениеПланаОтгрузкиКлиенту
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка = УменьшениеПланаОтгрузкиКлиенту.ОбъектРасчетов.Договор
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетовДоговор
		|			ПО ОбъектыРасчетовДоговор.Объект = ДанныеДоговора.Ссылка
		|				И ОбъектыРасчетовДоговор.ТипРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.РасчетыСКлиентом)
		|				И ОбъектыРасчетовДоговор.Организация = УменьшениеПланаОтгрузкиКлиенту.ОбъектРасчетов.Организация
		|				И НЕ ОбъектыРасчетовДоговор.ТолькоОстатки
		|				И НЕ ОбъектыРасчетовДоговор.ПометкаУдаления
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказКлиента КАК ДокументЗаказКлиента
		|			ПО УменьшениеПланаОтгрузкиКлиенту.ЗаказПродажи = ДокументЗаказКлиента.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаявкаНаВозвратТоваровОтКлиента КАК ДокументЗаявкаНаВозвратТоваровОтКлиента
		|			ПО УменьшениеПланаОтгрузкиКлиенту.ЗаказПродажи = ДокументЗаявкаНаВозвратТоваровОтКлиента.Ссылка
		|ГДЕ
		|	УменьшениеПланаОтгрузкиКлиенту.УменьшитьКОтгрузке <> 0 
		|";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаВТУвеличениеПланаОтгрузки(ЭтоПродажа=Ложь)
	
	Если ЭтоПродажа Тогда
		
		НакладнаяПоЗаказам = "УвеличениеПланаОтгрузкиКлиенту.НакладнаяПоЗаказам";
		СверхЗаказа = "УвеличениеПланаОтгрузкиКлиенту.СверхЗаказа";
		ЗаказПродажи = "УвеличениеПланаОтгрузкиКлиенту.ЗаказПродажи";
		ОбъектРасчетовЗаказа = "УвеличениеПланаОтгрузкиКлиенту.ЗаказПродажи.ОбъектРасчетов";
		
	Иначе
		
		НакладнаяПоЗаказам = "ЛОЖЬ";
		СверхЗаказа = "ЛОЖЬ";
		ЗаказПродажи = "НЕОПРЕДЕЛЕНО";
		ОбъектРасчетовЗаказа = "НЕОПРЕДЕЛЕНО";
		
	КонецЕсли;
	
	ТекстЗапроса = 
		"ВЫБРАТЬ
		|	УвеличениеПланаОтгрузкиКлиенту.ДатаОтгрузки                      КАК ДатаОтгрузки,
		|	УвеличениеПланаОтгрузкиКлиенту.ПорядокРасчетов                   КАК ПорядокРасчетов,
		|	&НакладнаяПоЗаказам                                              КАК НакладнаяПоЗаказам,
		|	&СверхЗаказа                                                     КАК СверхЗаказа,
		|	
		|	ВЫБОР
		|		КОГДА УвеличениеПланаОтгрузкиКлиенту.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
		|			И ЕСТЬNULL(&ОбъектРасчетовЗаказа, НЕОПРЕДЕЛЕНО) <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ОбъектРасчетовЗаказ.Ссылка
		|		КОГДА УвеличениеПланаОтгрузкиКлиенту.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
		|			ТОГДА ОбъектыРасчетовДоговор.Ссылка
		|		ИНАЧЕ УвеличениеПланаОтгрузкиКлиенту.ОбъектРасчетов
		|	КОНЕЦ                                                            КАК ОбъектРасчетов,
		|	УвеличениеПланаОтгрузкиКлиенту.ВалютаВзаиморасчетов              КАК ВалютаВзаиморасчетов,
		|	
		|	УвеличениеПланаОтгрузкиКлиенту.УвеличитьКОтгрузке                КАК УвеличитьКОтгрузке,
		|
		|	УвеличениеПланаОтгрузкиКлиенту.ХозяйственнаяОперация             КАК ХозяйственнаяОперация,
		|	&ЗаказПродажи                                                    КАК ЗаказПродажи,
		|	УвеличениеПланаОтгрузкиКлиенту.ДатаРегистратора                  КАК ДатаРегистратора,
		|	ЕСТЬNULL(ДанныеДоговора.ДопустимаяСуммаЗадолженности, 0)         КАК ДопустимаяСуммаЗадолженности,
		|	УвеличениеПланаОтгрузкиКлиенту.ВалютаДокумента                   КАК ВалютаДокумента,
		|
		|	ВЫБОР
		|		КОГДА УвеличениеПланаОтгрузкиКлиенту.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
		|			ТОГДА УвеличениеПланаОтгрузкиКлиенту.ОбъектРасчетов.Организация
		|		КОГДА УвеличениеПланаОтгрузкиКлиенту.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
		|			ТОГДА ОбъектыРасчетовДоговор.Организация
		|		КОГДА ЕСТЬNULL(ДанныеДоговора.ЗаданГрафикИсполнения, ЛОЖЬ)
		|			ТОГДА УвеличениеПланаОтгрузкиКлиенту.ОбъектРасчетов.Организация
		|		ИНАЧЕ УвеличениеПланаОтгрузкиКлиенту.Организация
		|	КОНЕЦ                                                            КАК Организация,
		|	ВЫБОР
		|		КОГДА УвеличениеПланаОтгрузкиКлиенту.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
		|			ТОГДА УвеличениеПланаОтгрузкиКлиенту.ОбъектРасчетов.Партнер
		|		ИНАЧЕ УвеличениеПланаОтгрузкиКлиенту.Партнер
		|	КОНЕЦ                                                            КАК Партнер,
		|	ВЫБОР
		|		КОГДА УвеличениеПланаОтгрузкиКлиенту.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
		|			ТОГДА ОбъектыРасчетовДоговор.Контрагент
		|		ИНАЧЕ УвеличениеПланаОтгрузкиКлиенту.ОбъектРасчетов.Контрагент
		|	КОНЕЦ                                                            КАК Контрагент,
		|	ВЫБОР
		|		КОГДА УвеличениеПланаОтгрузкиКлиенту.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
		|			ТОГДА ДанныеДоговора.Ссылка
		|		ИНАЧЕ УвеличениеПланаОтгрузкиКлиенту.ОбъектРасчетов.Договор
		|	КОНЕЦ                                                            КАК Договор,
		|	УвеличениеПланаОтгрузкиКлиенту.НомерРегистратора                 КАК НомерРегистратора,
		|	ЕСТЬNULL(ДанныеДоговора.ЗаданГрафикИсполнения, ЛОЖЬ)             КАК ЗаданГрафикИсполнения,
		|	ЕСТЬNULL(ЕСТЬNULL(ДокументЗаказКлиента.ЭтоЗаказКакСчет, ДокументЗаявкаНаВозвратТоваровОтКлиента.ЭтоЗаказКакСчет), ЛОЖЬ) КАК ЭтоЗаказКакСчет
		|ИЗ
		|	#УвеличениеПланаОтгрузкиКлиенту КАК УвеличениеПланаОтгрузкиКлиенту
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка = УвеличениеПланаОтгрузкиКлиенту.ОбъектРасчетов.Договор
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетовДоговор
		|			ПО ОбъектыРасчетовДоговор.Объект = ДанныеДоговора.Ссылка
		|				И ОбъектыРасчетовДоговор.ТипРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.РасчетыСКлиентом)
		|				И ОбъектыРасчетовДоговор.Организация = УвеличениеПланаОтгрузкиКлиенту.ОбъектРасчетов.Организация
		|				И НЕ ОбъектыРасчетовДоговор.ТолькоОстатки
		|				И НЕ ОбъектыРасчетовДоговор.ПометкаУдаления
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказКлиента КАК ДокументЗаказКлиента
		|			ПО &ЗаказПродажи = ДокументЗаказКлиента.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаявкаНаВозвратТоваровОтКлиента КАК ДокументЗаявкаНаВозвратТоваровОтКлиента
		|			ПО &ЗаказПродажи = ДокументЗаявкаНаВозвратТоваровОтКлиента.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектРасчетовЗаказ
		|			ПО &ОбъектРасчетовЗаказа = ОбъектРасчетовЗаказ.Ссылка
		|				И НЕ ОбъектРасчетовЗаказ.ТолькоОстатки
		|ГДЕ
		|	УвеличениеПланаОтгрузкиКлиенту.УвеличитьКОтгрузке <> 0
		|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&НакладнаяПоЗаказам",   НакладнаяПоЗаказам);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СверхЗаказа",          СверхЗаказа);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЗаказПродажи",         ЗаказПродажи);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ОбъектРасчетовЗаказа", ОбъектРасчетовЗаказа);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаВТУменьшениеПланаПоставки()
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	УменьшениеПланаПоставки.ПорядокРасчетов                  КАК ПорядокРасчетов,
		|	УменьшениеПланаПоставки.НакладнаяПоЗаказам               КАК НакладнаяПоЗаказам,
		|	
		|	ВЫБОР
		|		КОГДА УменьшениеПланаПоставки.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
		|			ТОГДА УменьшениеПланаПоставки.ЗаказЗакупки.ОбъектРасчетов
		|		КОГДА УменьшениеПланаПоставки.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
		|			ТОГДА ОбъектРасчетовДоговор.Ссылка
		|		ИНАЧЕ УменьшениеПланаПоставки.ОбъектРасчетов
		|	КОНЕЦ                                                    КАК ОбъектРасчетов,
		|	УменьшениеПланаПоставки.ВалютаВзаиморасчетов             КАК ВалютаВзаиморасчетов,
		|	
		|	УменьшениеПланаПоставки.УменьшитьКПоступлению            КАК УменьшитьКПоступлению,
		|	
		|	УменьшениеПланаПоставки.ХозяйственнаяОперация            КАК ХозяйственнаяОперация,
		|	УменьшениеПланаПоставки.ЗаказЗакупки                     КАК ЗаказЗакупки,
		|	УменьшениеПланаПоставки.ДатаРегистратора                 КАК ДатаРегистратора,
		|	УменьшениеПланаПоставки.ВалютаДокумента                  КАК ВалютаДокумента,
		|	
		|	ВЫБОР
		|		КОГДА УменьшениеПланаПоставки.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
		|			ТОГДА УменьшениеПланаПоставки.ЗаказЗакупки.ОбъектРасчетов.Организация
		|		КОГДА УменьшениеПланаПоставки.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
		|			ТОГДА ОбъектРасчетовДоговор.Организация
		|		КОГДА ЕСТЬNULL(ДанныеДоговора.ЗаданГрафикИсполнения, ЛОЖЬ)
		|			ТОГДА УменьшениеПланаПоставки.ОбъектРасчетов.Организация
		|		ИНАЧЕ УменьшениеПланаПоставки.Организация
		|	КОНЕЦ                                                    КАК Организация,
		|	ВЫБОР
		|		КОГДА УменьшениеПланаПоставки.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
		|			ТОГДА УменьшениеПланаПоставки.ЗаказЗакупки.ОбъектРасчетов.Партнер
		|		ИНАЧЕ УменьшениеПланаПоставки.Партнер
		|	КОНЕЦ                                                    КАК Партнер,
		|	ВЫБОР
		|		КОГДА УменьшениеПланаПоставки.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
		|			ТОГДА УменьшениеПланаПоставки.ЗаказЗакупки.ОбъектРасчетов.Контрагент
		|		КОГДА УменьшениеПланаПоставки.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
		|			ТОГДА ОбъектРасчетовДоговор.Контрагент
		|		ИНАЧЕ УменьшениеПланаПоставки.ОбъектРасчетов.Контрагент
		|	КОНЕЦ                                                    КАК Контрагент,
		|	ВЫБОР
		|		КОГДА УменьшениеПланаПоставки.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
		|			ТОГДА УменьшениеПланаПоставки.ЗаказЗакупки.ОбъектРасчетов.Договор
		|		КОГДА УменьшениеПланаПоставки.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
		|			ТОГДА ОбъектРасчетовДоговор.Договор
		|		ИНАЧЕ УменьшениеПланаПоставки.ОбъектРасчетов.Договор
		|	КОНЕЦ                                                    КАК Договор,
		|	УменьшениеПланаПоставки.НомерРегистратора                КАК НомерРегистратора,
		|	ЕСТЬNULL(ДанныеДоговора.ЗаданГрафикИсполнения, ЛОЖЬ)     КАК ЗаданГрафикИсполнения
		|ПОМЕСТИТЬ ВтУменьшениеПланаПоставки
		|ИЗ
		|	#УменьшениеПланаПоставки КАК УменьшениеПланаПоставки
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка = УменьшениеПланаПоставки.ОбъектРасчетов.Договор
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектРасчетовДоговор
		|			ПО УменьшениеПланаПоставки.ОбъектРасчетов.Договор = ОбъектРасчетовДоговор.Объект
		|				И ОбъектРасчетовДоговор.ТипРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.РасчетыСПоставщиком)
		|				И УменьшениеПланаПоставки.ОбъектРасчетов.Организация = ОбъектРасчетовДоговор.Организация
		|				И НЕ ОбъектРасчетовДоговор.ТолькоОстатки
		|				И НЕ ОбъектРасчетовДоговор.ПометкаУдаления
		|ГДЕ
		|	УменьшениеПланаПоставки.УменьшитьКПоступлению <> 0 
		|";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаВТУвеличениеПланаПоставки(ЭтоЗакупка=Ложь)
	
	Если ЭтоЗакупка Тогда
		НакладнаяПоЗаказам = "УвеличениеПланаПоставки.НакладнаяПоЗаказам";
		СверхЗаказа = "УвеличениеПланаПоставки.СверхЗаказа";
		Период = "УвеличениеПланаПоставки.ДатаРегистратора";
		ЗаказЗакупки = "УвеличениеПланаПоставки.ЗаказЗакупки";
		ОбъектРасчетовЗаказа = "УвеличениеПланаПоставки.ЗаказЗакупки.ОбъектРасчетов";
	Иначе
		НакладнаяПоЗаказам = "ЛОЖЬ";
		СверхЗаказа = "ЛОЖЬ";
		Период = "КОНЕЦПЕРИОДА(УвеличениеПланаПоставки.ДатаПоступления, ДЕНЬ)";
		ЗаказЗакупки = "НЕОПРЕДЕЛЕНО";
		ОбъектРасчетовЗаказа = "НЕОПРЕДЕЛЕНО";
	КонецЕсли;
	
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	УвеличениеПланаПоставки.ПорядокРасчетов                  КАК ПорядокРасчетов,
		|	&НакладнаяПоЗаказам                                      КАК НакладнаяПоЗаказам,
		|	&Период                                                  КАК Период,
		|	&СверхЗаказа                                             КАК СверхЗаказа,
		|	
		|	ВЫБОР
		|		КОГДА УвеличениеПланаПоставки.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
		|			И ЕСТЬNULL(&ОбъектРасчетовЗаказа, НЕОПРЕДЕЛЕНО) <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ОбъектРасчетовЗаказ.Ссылка
		|		КОГДА УвеличениеПланаПоставки.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
		|			ТОГДА ОбъектРасчетовДоговор.Ссылка
		|		ИНАЧЕ УвеличениеПланаПоставки.ОбъектРасчетов
		|	КОНЕЦ                                                    КАК ОбъектРасчетов,
		|	УвеличениеПланаПоставки.ВалютаВзаиморасчетов             КАК ВалютаВзаиморасчетов,
		|	
		|	УвеличениеПланаПоставки.УвеличитьКПоступлению            КАК УвеличитьКПоступлению,
		|	
		|	УвеличениеПланаПоставки.ХозяйственнаяОперация            КАК ХозяйственнаяОперация,
		|	&ЗаказЗакупки                                            КАК ЗаказЗакупки,
		|	УвеличениеПланаПоставки.ДатаРегистратора                 КАК ДатаРегистратора,
		|	УвеличениеПланаПоставки.ВалютаДокумента                  КАК ВалютаДокумента,
		|	
		|	ВЫБОР
		|		КОГДА УвеличениеПланаПоставки.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
		|			ТОГДА УвеличениеПланаПоставки.ОбъектРасчетов.Организация
		|		КОГДА УвеличениеПланаПоставки.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
		|			ТОГДА ОбъектРасчетовДоговор.Организация
		|		КОГДА ЕСТЬNULL(ДанныеДоговора.ЗаданГрафикИсполнения, ЛОЖЬ)
		|			ТОГДА УвеличениеПланаПоставки.ОбъектРасчетов.Организация
		|		ИНАЧЕ УвеличениеПланаПоставки.Организация
		|	КОНЕЦ                                                    КАК Организация,
		|	ВЫБОР
		|		КОГДА УвеличениеПланаПоставки.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
		|			ТОГДА УвеличениеПланаПоставки.ОбъектРасчетов.Партнер
		|		ИНАЧЕ УвеличениеПланаПоставки.Партнер
		|	КОНЕЦ                                                    КАК Партнер,
		|	ВЫБОР
		|		КОГДА УвеличениеПланаПоставки.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
		|			ТОГДА ОбъектРасчетовДоговор.Контрагент
		|		ИНАЧЕ УвеличениеПланаПоставки.ОбъектРасчетов.Контрагент
		|	КОНЕЦ                                                    КАК Контрагент,
		|	ВЫБОР
		|		КОГДА УвеличениеПланаПоставки.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоДоговорамНакладным)
		|			ТОГДА ОбъектРасчетовДоговор.Договор
		|		ИНАЧЕ УвеличениеПланаПоставки.ОбъектРасчетов.Договор
		|	КОНЕЦ                                                    КАК Договор,
		|	УвеличениеПланаПоставки.НомерРегистратора                КАК НомерРегистратора,
		|	ЕСТЬNULL(ДанныеДоговора.ЗаданГрафикИсполнения, ЛОЖЬ)     КАК ЗаданГрафикИсполнения
		|ПОМЕСТИТЬ ВтУвеличениеПланаПоставки
		|ИЗ
		|	#УвеличениеПланаПоставки КАК УвеличениеПланаПоставки
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДанныеДоговора
		|			ПО ДанныеДоговора.Ссылка =  УвеличениеПланаПоставки.ОбъектРасчетов.Договор
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектРасчетовДоговор
		|			ПО УвеличениеПланаПоставки.ОбъектРасчетов.Договор = ОбъектРасчетовДоговор.Объект
		|				И ОбъектРасчетовДоговор.ТипРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.РасчетыСПоставщиком)
		|				И УвеличениеПланаПоставки.ОбъектРасчетов.Организация = ОбъектРасчетовДоговор.Организация
		|				И НЕ ОбъектРасчетовДоговор.ТолькоОстатки
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектРасчетовЗаказ
		|			ПО &ОбъектРасчетовЗаказа = ОбъектРасчетовЗаказ.Ссылка
		|				И НЕ ОбъектРасчетовЗаказ.ТолькоОстатки
		|ГДЕ
		|	УвеличениеПланаПоставки.УвеличитьКПоступлению <> 0
		|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&Период",               Период);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&СверхЗаказа",          СверхЗаказа);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&НакладнаяПоЗаказам",   НакладнаяПоЗаказам);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ЗаказЗакупки",         ЗаказЗакупки);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"&ОбъектРасчетовЗаказа", ОбъектРасчетовЗаказа);
	
	Возврат ТекстЗапроса;
	
КонецФункции

// Функция получает временные таблицы курсов валют и направлений деятельности.
// 
// Параметры:
//  ТекстЗапросаИсходнойТаблицы - Строка - Текст запроса с данными об объектах расчетов, валютах, датах курса
//  ЭтоОперацияОплаты - Булево - Значение по умолчанию Ложь, Истина для операций оплаты и возврата оплаты
// 
// Возвращаемое значение:
//  Строка - Текст запроса с созданными временными таблицами ВтКоэффициентыПересчетаВалют и ВтНаправленияДеятельности
Функция ПолучитьТаблицуКурсовВалютНаправленийДеятельности(ТекстЗапросаИсходнойТаблицы, ЭтоОперацияОплаты = Ложь) Экспорт
	
	// Платежки всегда игнорируют курс договора при проведении, так как при оплате в иностранной валюте курс из договора невозможно применить, 
	// а при оплате в валюте учета курс из договора уже применен в самой форме документа и расчет при проведении не требуется
	Если ЭтоОперацияОплаты Тогда
		КурсИзДоговора = "ЛОЖЬ";
	Иначе
		КурсИзДоговора = "ЕСТЬNULL(КурсыВалютДокумента.ОбъектРасчетов.Договор.ВариантКурсаДоговора,
			|		ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.Переменный)) = ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.УстановленныйВДоговоре)";
	КонецЕсли;
	
	ТекстЗапроса = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	*
		|ПОМЕСТИТЬ ВТ_ТаблицаКурсыВалютДокумента
		|ИЗ
		|	&ВложенныйЗапрос КАК ВложенныйЗапрос
		|;
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	КурсыВалютДокумента.Ссылка КАК Ссылка,
		|	КурсыВалютДокумента.ОбъектРасчетов КАК ОбъектРасчетов,
		|	КурсыВалютДокумента.ОбъектРасчетов.Договор КАК Договор,
		|	КурсыВалютДокумента.ОбъектРасчетов.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	КурсыВалютДокумента.ДатаКурса КАК ДатаКурса,
		|	КурсыВалютДокумента.ВалютаДокумента КАК ВалютаДокумента,
		|	КурсыВалютДокумента.Организация.ВалютаРегламентированногоУчета КАК ВалютаРегламентированногоУчета,
		|	КурсыВалютДокумента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
		|	&ВалютаУправленческогоУчета КАК ВалютаУправленческогоУчета,
		|	НЕ ФиксированныеКурсыВалют.Документ ЕСТЬ NULL
		|	И ВЫБОР
		|		КОГДА КурсыВалютДокумента.ОбъектРасчетов.Договор.ВариантКурсаДоговора ЕСТЬ NULL
		|			ТОГДА ЛОЖЬ
		|		ИНАЧЕ КурсыВалютДокумента.ОбъектРасчетов.Договор.ВариантКурсаДоговора = ЗНАЧЕНИЕ(Перечисление.ВариантыКурсаДоговора.ФиксированныйНаДатуОтгрузки)
		|	КОНЕЦ КАК ФиксированныйКурсНакладной,
		|	&КурсИзДоговора КАК КурсИзДоговора,
		|	ЕСТЬNULL(ФиксированныеКурсыВалют.ВалютаВзаиморасчетов, ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка)) КАК
		|		ВалютаВзаиморасчетовФиксированныйКурс,
		|	ЕСТЬNULL(ФиксированныеКурсыВалют.КурсЧислительВалютыВзаиморасчетов, 1) КАК ВалютаРасчетовФиксированныйКурсЧислитель,
		|	ЕСТЬNULL(ФиксированныеКурсыВалют.КурсЗнаменательВалютыВзаиморасчетов, 1) КАК
		|		ВалютаРасчетовФиксированныйКурсЗнаменатель
		|ПОМЕСТИТЬ ВТ_РасширеннаяТаблицаКурсовВалют
		|ИЗ
		|	ВТ_ТаблицаКурсыВалютДокумента КАК КурсыВалютДокумента
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ВалютыИКурсыДокументов КАК ФиксированныеКурсыВалют
		|		ПО КурсыВалютДокумента.ОбъектРасчетов.Объект = ФиксированныеКурсыВалют.Документ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	КурсыВалютДокумента.ДатаКурса КАК ДатаКурса,
		|	КурсыВалютДокумента.ВалютаДокумента КАК Валюта,
		|	КурсыВалютДокумента.ВалютаРегламентированногоУчета КАК ВалютаРегламентированногоУчета
		|ПОМЕСТИТЬ ВТ_КурсыВалютСтрокиДокумента
		|ИЗ
		|	ВТ_РасширеннаяТаблицаКурсовВалют КАК КурсыВалютДокумента
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	КурсыВалютДокумента.ДатаКурса КАК ДатаКурса,
		|	КурсыВалютДокумента.ВалютаВзаиморасчетов КАК Валюта,
		|	КурсыВалютДокумента.ВалютаРегламентированногоУчета КАК ВалютаРегламентированногоУчета
		|ИЗ
		|	ВТ_РасширеннаяТаблицаКурсовВалют КАК КурсыВалютДокумента
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	КурсыВалютДокумента.ДатаКурса КАК ДатаКурса,
		|	КурсыВалютДокумента.ВалютаУправленческогоУчета КАК Валюта,
		|	КурсыВалютДокумента.ВалютаРегламентированногоУчета КАК ВалютаРегламентированногоУчета
		|ИЗ
		|	ВТ_РасширеннаяТаблицаКурсовВалют КАК КурсыВалютДокумента
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДанныеДляКурсов.ДатаКурса КАК ДатаКурса,
		|	ДанныеДляКурсов.Валюта КАК Валюта,
		|	ДанныеДляКурсов.ВалютаРегламентированногоУчета КАК ВалютаРегламентированногоУчета,
		|	МАКСИМУМ(Курсы.Период) КАК ПериодКурса
		|ПОМЕСТИТЬ ВТ_ПериодыКурсовВалютСтрокиДокумента
		|ИЗ
		|	ВТ_КурсыВалютСтрокиДокумента КАК ДанныеДляКурсов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ОтносительныеКурсыВалют КАК Курсы
		|		ПО Курсы.Период <= ДанныеДляКурсов.ДатаКурса
		|		И Курсы.Валюта = ДанныеДляКурсов.Валюта
		|		И Курсы.БазоваяВалюта = ДанныеДляКурсов.ВалютаРегламентированногоУчета
		|СГРУППИРОВАТЬ ПО
		|	ДанныеДляКурсов.ДатаКурса,
		|	ДанныеДляКурсов.Валюта,
		|	ДанныеДляКурсов.ВалютаРегламентированногоУчета
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////////////////		
		|ВЫБРАТЬ
		|	ПериодыКурсов.ДатаКурса КАК ДатаКурса,
		|	ПериодыКурсов.Валюта КАК Валюта,
		|	КурсыВалютДокументов.КурсЧислитель КАК ВалютаКурсЧислитель,
		|	КурсыВалютДокументов.КурсЗнаменатель КАК ВалютаКурсЗнаменатель
		|ПОМЕСТИТЬ ВТ_ДанныеКурсовВалютДокумента
		|ИЗ
		|	ВТ_ПериодыКурсовВалютСтрокиДокумента КАК ПериодыКурсов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ОтносительныеКурсыВалют КАК КурсыВалютДокументов
		|		ПО ПериодыКурсов.ПериодКурса = КурсыВалютДокументов.Период
		|		И ПериодыКурсов.Валюта = КурсыВалютДокументов.Валюта
		|		И ПериодыКурсов.ВалютаРегламентированногоУчета = КурсыВалютДокументов.БазоваяВалюта
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДанныеДляКурсов.ДатаКурса КАК ДатаКурса,
		|	ДанныеДляКурсов.Договор КАК Договор,
		|	МАКСИМУМ(Курсы.Период) КАК ПериодКурса
		|ПОМЕСТИТЬ ВТ_ПериодыКурсыДоговоров
		|ИЗ
		|	ВТ_РасширеннаяТаблицаКурсовВалют КАК ДанныеДляКурсов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалютРасчетовПоДоговорам КАК Курсы
		|		ПО Курсы.Период <= ДанныеДляКурсов.ДатаКурса
		|		И Курсы.Договор = ДанныеДляКурсов.Договор
		|		И ДанныеДляКурсов.КурсИзДоговора
		|СГРУППИРОВАТЬ ПО
		|	ДанныеДляКурсов.ДатаКурса,
		|	ДанныеДляКурсов.Договор
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////////////////		
		|ВЫБРАТЬ
		|	ПериодыКурсов.ДатаКурса КАК ДатаКурса,
		|	ПериодыКурсов.Договор КАК Договор,
		|	КурсыВалютДоговоры.КурсЧислитель КАК ДоговорВалютаКурсЧислитель,
		|	КурсыВалютДоговоры.КурсЗнаменатель КАК ДоговорВалютаКурсЗнаменатель
		|ПОМЕСТИТЬ ВТ_ДанныеКурсовВалютДоговоры
		|ИЗ
		|	ВТ_ПериодыКурсыДоговоров КАК ПериодыКурсов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалютРасчетовПоДоговорам КАК КурсыВалютДоговоры
		|		ПО ПериодыКурсов.ПериодКурса = КурсыВалютДоговоры.Период
		|		И ПериодыКурсов.Договор = КурсыВалютДоговоры.Договор
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ИсходнаяТаблицаКурсовВалют.Ссылка                               КАК Ссылка,
		|	ИсходнаяТаблицаКурсовВалют.ДатаКурса                            КАК ДатаКурса,
		|	ИсходнаяТаблицаКурсовВалют.ВалютаВзаиморасчетов                 КАК ВалютаВзаиморасчетов,
		|	ИсходнаяТаблицаКурсовВалют.ВалютаРегламентированногоУчета       КАК ВалютаРегламентированногоУчета,
		|	ИсходнаяТаблицаКурсовВалют.ОбъектРасчетов                       КАК ОбъектРасчетов,
		//КоэффициентУпр
		|	ВЫРАЗИТЬ(1.000000000000000000000000001 * 
		|	ВЫБОР
		|		КОГДА ИсходнаяТаблицаКурсовВалют.КурсИзДоговора
		|		И ИсходнаяТаблицаКурсовВалют.ВалютаДокумента = ИсходнаяТаблицаКурсовВалют.ВалютаВзаиморасчетов
		|			ТОГДА ЕСТЬNULL(КурсыВалютДоговоры.ДоговорВалютаКурсЧислитель, 1)
		|		ИНАЧЕ ЕСТЬNULL(КурсыВалютДокументов.ВалютаКурсЧислитель, 1)
		|	КОНЕЦ * 
		|	ВЫБОР
		|		КОГДА ИсходнаяТаблицаКурсовВалют.КурсИзДоговора
		|		И ИсходнаяТаблицаКурсовВалют.ВалютаУправленческогоУчета = ИсходнаяТаблицаКурсовВалют.ВалютаВзаиморасчетов
		|			ТОГДА ЕСТЬNULL(КурсыВалютДоговоры.ДоговорВалютаКурсЗнаменатель, 1)
		|		ИНАЧЕ ЕСТЬNULL(КурсыВалютУпр.ВалютаКурсЗнаменатель, 1)
		|	КОНЕЦ / 
		|	(ВЫБОР
		|		КОГДА ИсходнаяТаблицаКурсовВалют.КурсИзДоговора
		|		И ИсходнаяТаблицаКурсовВалют.ВалютаДокумента = ИсходнаяТаблицаКурсовВалют.ВалютаВзаиморасчетов
		|			ТОГДА ЕСТЬNULL(КурсыВалютДоговоры.ДоговорВалютаКурсЗнаменатель, 1)
		|		ИНАЧЕ ЕСТЬNULL(КурсыВалютДокументов.ВалютаКурсЗнаменатель, 1)
		|	КОНЕЦ *
		|	ВЫБОР
		|		КОГДА ИсходнаяТаблицаКурсовВалют.КурсИзДоговора
		|		И ИсходнаяТаблицаКурсовВалют.ВалютаУправленческогоУчета = ИсходнаяТаблицаКурсовВалют.ВалютаВзаиморасчетов
		|			ТОГДА ЕСТЬNULL(КурсыВалютДоговоры.ДоговорВалютаКурсЧислитель, 1)
		|		ИНАЧЕ ЕСТЬNULL(КурсыВалютУпр.ВалютаКурсЧислитель, 1)
		|	КОНЕЦ) КАК ЧИСЛО(31, 17))                                       КАК КоэффициентУпр,
		|
		//КоэффициентРегл
		|	ВЫРАЗИТЬ(1.000000000000000000000000001 * 
		|	ВЫБОР
		|		КОГДА ИсходнаяТаблицаКурсовВалют.КурсИзДоговора
		|		И ИсходнаяТаблицаКурсовВалют.ВалютаДокумента = ИсходнаяТаблицаКурсовВалют.ВалютаВзаиморасчетов
		|			ТОГДА ЕСТЬNULL(КурсыВалютДоговоры.ДоговорВалютаКурсЧислитель, 1)
		|		ИНАЧЕ ЕСТЬNULL(КурсыВалютДокументов.ВалютаКурсЧислитель, 1)
		|	КОНЕЦ * 
		|	ВЫБОР
		|		КОГДА ИсходнаяТаблицаКурсовВалют.КурсИзДоговора
		|		И ИсходнаяТаблицаКурсовВалют.ВалютаРегламентированногоУчета = ИсходнаяТаблицаКурсовВалют.ВалютаВзаиморасчетов
		|			ТОГДА ЕСТЬNULL(КурсыВалютДоговоры.ДоговорВалютаКурсЗнаменатель, 1)
		|		ИНАЧЕ 1
		|	КОНЕЦ / 
		|	(ВЫБОР
		|		КОГДА ИсходнаяТаблицаКурсовВалют.КурсИзДоговора
		|		И ИсходнаяТаблицаКурсовВалют.ВалютаДокумента = ИсходнаяТаблицаКурсовВалют.ВалютаВзаиморасчетов
		|			ТОГДА ЕСТЬNULL(КурсыВалютДоговоры.ДоговорВалютаКурсЗнаменатель, 1)
		|		ИНАЧЕ ЕСТЬNULL(КурсыВалютДокументов.ВалютаКурсЗнаменатель, 1)
		|	КОНЕЦ * 
		|	ВЫБОР
		|		КОГДА ИсходнаяТаблицаКурсовВалют.КурсИзДоговора
		|		И ИсходнаяТаблицаКурсовВалют.ВалютаРегламентированногоУчета = ИсходнаяТаблицаКурсовВалют.ВалютаВзаиморасчетов
		|			ТОГДА ЕСТЬNULL(КурсыВалютДоговоры.ДоговорВалютаКурсЧислитель, 1)
		|		ИНАЧЕ 1
		|	КОНЕЦ) КАК ЧИСЛО(31, 17))                                       КАК КоэффициентРегл,
		|
		//КоэффициентВзаиморасчетов
		|	ВЫРАЗИТЬ(1.000000000000000000000000001 * 
		|	ВЫБОР
		|		КОГДА ИсходнаяТаблицаКурсовВалют.КурсИзДоговора
		|		И ИсходнаяТаблицаКурсовВалют.ВалютаДокумента = ИсходнаяТаблицаКурсовВалют.ВалютаВзаиморасчетов
		|			ТОГДА ЕСТЬNULL(КурсыВалютДоговоры.ДоговорВалютаКурсЧислитель, 1)
		|		ИНАЧЕ ЕСТЬNULL(КурсыВалютДокументов.ВалютаКурсЧислитель, 1)
		|	КОНЕЦ * 
		|	ВЫБОР
		|		КОГДА ИсходнаяТаблицаКурсовВалют.КурсИзДоговора
		|			ТОГДА ЕСТЬNULL(КурсыВалютДоговоры.ДоговорВалютаКурсЗнаменатель, 1)
		|		КОГДА ИсходнаяТаблицаКурсовВалют.ФиксированныйКурсНакладной
		|			ТОГДА ВЫБОР
		|				КОГДА
		|					ИсходнаяТаблицаКурсовВалют.ВалютаВзаиморасчетов = ИсходнаяТаблицаКурсовВалют.ВалютаВзаиморасчетовФиксированныйКурс
		|					ТОГДА ИсходнаяТаблицаКурсовВалют.ВалютаРасчетовФиксированныйКурсЗнаменатель
		|				ИНАЧЕ ЕСТЬNULL(КурсыВалютРасчеты.ВалютаКурсЗнаменатель, 1)
		|			КОНЕЦ
		|		ИНАЧЕ ЕСТЬNULL(КурсыВалютРасчеты.ВалютаКурсЗнаменатель, 1)
		|	КОНЕЦ / 
		|	(ВЫБОР
		|		КОГДА ИсходнаяТаблицаКурсовВалют.КурсИзДоговора
		|		И ИсходнаяТаблицаКурсовВалют.ВалютаДокумента = ИсходнаяТаблицаКурсовВалют.ВалютаВзаиморасчетов
		|			ТОГДА ЕСТЬNULL(КурсыВалютДоговоры.ДоговорВалютаКурсЗнаменатель, 1)
		|		ИНАЧЕ ЕСТЬNULL(КурсыВалютДокументов.ВалютаКурсЗнаменатель, 1)
		|	КОНЕЦ * 
		|	ВЫБОР
		|		КОГДА ИсходнаяТаблицаКурсовВалют.КурсИзДоговора
		|			ТОГДА ЕСТЬNULL(КурсыВалютДоговоры.ДоговорВалютаКурсЧислитель, 1)
		|		КОГДА ИсходнаяТаблицаКурсовВалют.ФиксированныйКурсНакладной
		|			ТОГДА ВЫБОР
		|				КОГДА
		|					ИсходнаяТаблицаКурсовВалют.ВалютаВзаиморасчетов = ИсходнаяТаблицаКурсовВалют.ВалютаВзаиморасчетовФиксированныйКурс
		|					ТОГДА ИсходнаяТаблицаКурсовВалют.ВалютаРасчетовФиксированныйКурсЧислитель
		|				ИНАЧЕ ЕСТЬNULL(КурсыВалютРасчеты.ВалютаКурсЧислитель, 1)
		|			КОНЕЦ
		|		ИНАЧЕ ЕСТЬNULL(КурсыВалютРасчеты.ВалютаКурсЧислитель, 1)
		|	КОНЕЦ) КАК ЧИСЛО(31, 17))                                       КАК КоэффициентВзаиморасчетов
		|
		|ПОМЕСТИТЬ ВзаиморасчетыВтКоэффициентыПересчетаВалют
		|ИЗ
		|	ВТ_РасширеннаяТаблицаКурсовВалют КАК ИсходнаяТаблицаКурсовВалют
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ДанныеКурсовВалютДоговоры КАК КурсыВалютДоговоры
		|		по ИсходнаяТаблицаКурсовВалют.ДатаКурса = КурсыВалютДоговоры.ДатаКурса
		|		И ИсходнаяТаблицаКурсовВалют.Договор = КурсыВалютДоговоры.Договор
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ДанныеКурсовВалютДокумента КАК КурсыВалютДокументов
		|		ПО ИсходнаяТаблицаКурсовВалют.ДатаКурса = КурсыВалютДокументов.ДатаКурса
		|		И ИсходнаяТаблицаКурсовВалют.ВалютаДокумента = КурсыВалютДокументов.Валюта
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ДанныеКурсовВалютДокумента КАК КурсыВалютУпр
		|		ПО ИсходнаяТаблицаКурсовВалют.ДатаКурса = КурсыВалютУпр.ДатаКурса
		|		И ИсходнаяТаблицаКурсовВалют.ВалютаУправленческогоУчета = КурсыВалютУпр.Валюта
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ДанныеКурсовВалютДокумента КАК КурсыВалютРасчеты
		|		ПО ИсходнаяТаблицаКурсовВалют.ДатаКурса = КурсыВалютРасчеты.ДатаКурса
		|		И ИсходнаяТаблицаКурсовВалют.ВалютаВзаиморасчетов = КурсыВалютРасчеты.Валюта;
		//НаправлениеДеятельности
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	НаправленияДокументов.ОбъектРасчетов КАК ОбъектРасчетов,
		|	ВЫБОР 
		|		КОГДА (ЕСТЬNULL(НаправленияДокументов.ОбъектРасчетов.НаправлениеДеятельности.УчетДоходов, ЛОЖЬ) 
		|			   И НаправленияДокументов.ОбъектРасчетов.ТипРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.РасчетыСКлиентом))
		|			ИЛИ (ЕСТЬNULL(НаправленияДокументов.ОбъектРасчетов.НаправлениеДеятельности.УчетРасчетовСПоставщиками, ЛОЖЬ)
		|			   И НаправленияДокументов.ОбъектРасчетов.ТипРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.РасчетыСПоставщиком))
		|			ТОГДА НаправленияДокументов.ОбъектРасчетов.НаправлениеДеятельности
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|	КОНЕЦ КАК НаправлениеАналитики
		|ПОМЕСТИТЬ ВтНаправленияДеятельности
		|ИЗ
		|	ВТ_РасширеннаяТаблицаКурсовВалют КАК НаправленияДокументов
		|;
		|
		|УНИЧТОЖИТЬ ВТ_ТаблицаКурсыВалютДокумента;
		|УНИЧТОЖИТЬ ВТ_РасширеннаяТаблицаКурсовВалют;
		|УНИЧТОЖИТЬ ВТ_КурсыВалютСтрокиДокумента;
		|УНИЧТОЖИТЬ ВТ_ПериодыКурсовВалютСтрокиДокумента;
		|УНИЧТОЖИТЬ ВТ_ДанныеКурсовВалютДокумента;
		|УНИЧТОЖИТЬ ВТ_ДанныеКурсовВалютДоговоры;
		|УНИЧТОЖИТЬ ВТ_ПериодыКурсыДоговоров";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&КурсИзДоговора", КурсИзДоговора);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ВложенныйЗапрос", "(" + ТекстЗапросаИсходнойТаблицы + ")");
	
	Возврат ТекстЗапроса;
	
КонецФункции

// Функция получает временную таблицу направлений деятельности.
// 
// Параметры:
//  ТекстЗапросаИсходнойТаблицы - Строка - Текст запроса с данными об объектах расчетов, валютах, датах курса
// 
// Возвращаемое значение:
//  Строка - Текст запроса с созданной временной таблицей ВтНаправленияДеятельности
Функция ПолучитьТаблицуНаправленийДеятельности(ТекстЗапросаИсходнойТаблицы) Экспорт
	
	ТекстЗапроса = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	*
		|ПОМЕСТИТЬ ВТ_ТаблицаНаправлениеДеятельности
		|ИЗ
		|	&ВложенныйЗапрос КАК ВложенныйЗапрос
		|;
		|ВЫБРАТЬ 
		|	НаправленияДокументов.ОбъектРасчетов КАК ОбъектРасчетов,
		|	НаправленияДокументов.ОбъектРасчетов.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	ВЫБОР 
		|		КОГДА (ЕСТЬNULL(НаправленияДокументов.ОбъектРасчетов.НаправлениеДеятельности.УчетДоходов, ЛОЖЬ) 
		|			   И НаправленияДокументов.ОбъектРасчетов.ТипРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.РасчетыСКлиентом))
		|			ИЛИ (ЕСТЬNULL(НаправленияДокументов.ОбъектРасчетов.НаправлениеДеятельности.УчетРасчетовСПоставщиками, ЛОЖЬ)
		|			   И НаправленияДокументов.ОбъектРасчетов.ТипРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыРасчетовСПартнерами.РасчетыСПоставщиком))
		|			ТОГДА НаправленияДокументов.ОбъектРасчетов.НаправлениеДеятельности
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|	КОНЕЦ КАК НаправлениеАналитики
		|
		|ПОМЕСТИТЬ ВтНаправленияДеятельности
		|ИЗ
		|	ВТ_ТаблицаНаправлениеДеятельности КАК НаправленияДокументов
		|;
		|
		|УНИЧТОЖИТЬ ВТ_ТаблицаНаправлениеДеятельности
		|";

	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ВложенныйЗапрос", "(" + ТекстЗапросаИсходнойТаблицы + ")");
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстВтПереносаРасчетов(ИмяТаблицы = "")
	
	ТекстЗапросаРасшифровка = "
	|
	|ВЫБРАТЬ
	|	УвеличениеЗадолженностиКлиента.Ссылка                                    КАК Ссылка,
	|	УвеличениеЗадолженностиКлиента.Организация                               КАК Организация,
	|	УвеличениеЗадолженностиКлиента.Партнер                                   КАК Партнер,
	|	
	|	УвеличениеЗадолженностиКлиента.ОбъектРасчетов                            КАК ОбъектРасчетовПриемник,
	|	УвеличениеЗадолженностиКлиента.ОбъектРасчетов                            КАК ОбъектРасчетовИсточник,
	|	УвеличениеЗадолженностиКлиента.ВалютаВзаиморасчетов                      КАК ВалютаВзаиморасчетов,
	|	УвеличениеЗадолженностиКлиента.СуммаВзаиморасчетов                       КАК СуммаВзаиморасчетов,
	|	УвеличениеЗадолженностиКлиента.ВалютаДокумента                           КАК ВалютаДокумента,
	|	УвеличениеЗадолженностиКлиента.Сумма                                     КАК Сумма,
	|
	|	УвеличениеЗадолженностиКлиента.ДатаКурса                                 КАК ДатаКурса,
	|	УвеличениеЗадолженностиКлиента.ДатаРегистратора                          КАК ДатаРегистратора,
	|	УвеличениеЗадолженностиКлиента.НомерРегистратора                         КАК НомерРегистратора,
	|	УвеличениеЗадолженностиКлиента.ХозяйственнаяОперация                     КАК ХозяйственнаяОперация,
	|	УвеличениеЗадолженностиКлиента.СтатьяДвиженияДенежныхСредств             КАК СтатьяДвиженияДенежныхСредств
	|ИЗ
	|	#УвеличениеЗадолженностиКлиента КАК УвеличениеЗадолженностиКлиента
	|ГДЕ
	|	(УвеличениеЗадолженностиКлиента.ОбъектРасчетов.Организация <> УвеличениеЗадолженностиКлиента.Организация
	|		ИЛИ УвеличениеЗадолженностиКлиента.ОбъектРасчетов.Партнер <> УвеличениеЗадолженностиКлиента.Партнер)
	|	И УвеличениеЗадолженностиКлиента.СуммаВзаиморасчетов <> 0
	|";
		
	Если ЗначениеЗаполнено(ИмяТаблицы) Тогда
		ТекстЗапросаРасшифровка = СтрЗаменить(ТекстЗапросаРасшифровка, "УвеличениеЗадолженностиКлиента", ИмяТаблицы);
	КонецЕсли;
	
	Возврат ТекстЗапросаРасшифровка;
	
КонецФункции

#КонецОбласти

#КонецОбласти

#Область ПоискОснованийИДокументовОплаты

// Устанавливает необходимые параметры для исполнения запросов по данным взаиморасчетов
//
// Параметры:
//  Запрос           - Запрос - 
//  ПараметрыПоиска  - см. ИнициализироватьПараметрыПоискаОснованийИДокументовОплаты
Процедура ПостобработкаЗапроса_ПоискОснованийИДокументовОплаты(Запрос, ПараметрыПоиска)
	
	// Подготовка данных
	
	// - дата окончания
	Если НЕ ЗначениеЗаполнено(ПараметрыПоиска.НаДату) Тогда
		ДатаОкончания        = Дата(3000, 1, 1);
		ДатаОкончанияВключая = Неопределено;
	Иначе
		ДатаОкончания        = ПараметрыПоиска.НаДату;
		ДатаОкончанияВключая = Новый Граница(ДатаОкончания);
	КонецЕсли;
	
	// - организации
	Если ЗначениеЗаполнено(ПараметрыПоиска.Организации) Тогда
		Организации                 = ПараметрыПоиска.Организации;
		ВключитьОтборПоОрганизациям = Истина;
	Иначе
		Организации                 = Неопределено;
		ВключитьОтборПоОрганизациям = Ложь;
	КонецЕсли;
	
	// - инициализация таблицы документов для отбора
	мТиповДокументовОтбора = Новый Массив;
	
	Для каждого Документ Из ПараметрыПоиска.Документы Цикл
		мТиповДокументовОтбора.Добавить(ТипЗнч(Документ));
	КонецЦикла;
	
	ТаблицаДокументов = Новый ТаблицаЗначений;
	ТаблицаДокументов.Колонки.Добавить("ДокументОтбора", Новый ОписаниеТипов(мТиповДокументовОтбора));
	
	Для каждого Документ Из ПараметрыПоиска.Документы Цикл
		новСтрока = ТаблицаДокументов.Добавить();
		новСтрока.ДокументОтбора = Документ;
	КонецЦикла;
	
	// - типы документов оплаты
	
	мТиповДокументовОплатыВходящие = Новый Массив;
	мТиповДокументовОплатыВходящие.Добавить(Тип("ДокументСсылка.ПоступлениеБезналичныхДенежныхСредств"));
	мТиповДокументовОплатыВходящие.Добавить(Тип("ДокументСсылка.ПриходныйКассовыйОрдер"));
	мТиповДокументовОплатыВходящие.Добавить(Тип("ДокументСсылка.ПервичныйДокумент"));
	мТиповДокументовОплатыВходящие.Добавить(Тип("ДокументСсылка.ОперацияПоПлатежнойКарте"));
	мТиповДокументовОплатыВходящие.Добавить(Тип("ДокументСсылка.ВзаимозачетЗадолженности"));
	
	мТиповДокументовОплатыИсходящие = Новый Массив;
	мТиповДокументовОплатыИсходящие.Добавить(Тип("ДокументСсылка.СписаниеБезналичныхДенежныхСредств"));
	мТиповДокументовОплатыИсходящие.Добавить(Тип("ДокументСсылка.РасходныйКассовыйОрдер"));
	мТиповДокументовОплатыИсходящие.Добавить(Тип("ДокументСсылка.ПервичныйДокумент"));
	мТиповДокументовОплатыИсходящие.Добавить(Тип("ДокументСсылка.ВзаимозачетЗадолженности"));
	
	// - типы оснований (объектов) оплаты
	
	мТиповОснованийОплатыВходящие = Новый Массив;
	мТиповОснованийОплатыВходящие.Добавить(Тип("ДокументСсылка.ПриобретениеТоваровУслуг"));
	мТиповОснованийОплатыВходящие.Добавить(Тип("ДокументСсылка.ПриобретениеУслугПрочихАктивов"));
	мТиповОснованийОплатыВходящие.Добавить(Тип("ДокументСсылка.ПервичныйДокумент"));
	
	мТиповОснованийОплатыИсходящие = Новый Массив;
	мТиповОснованийОплатыИсходящие.Добавить(Тип("ДокументСсылка.РеализацияТоваровУслуг"));
	мТиповОснованийОплатыИсходящие.Добавить(Тип("ДокументСсылка.РеализацияУслугПрочихАктивов"));
	мТиповОснованийОплатыИсходящие.Добавить(Тип("ДокументСсылка.ПервичныйДокумент"));
	
	
	// Установка параметров
	
	Запрос.УстановитьПараметр("Организации",                        Организации);
	Запрос.УстановитьПараметр("ДатаОкончания",                      ДатаОкончания);
	Запрос.УстановитьПараметр("ДатаОкончанияВключая",               ДатаОкончанияВключая);
	Запрос.УстановитьПараметр("ТаблицаДокументов",                  ТаблицаДокументов);
	Запрос.УстановитьПараметр("ВключитьОтборПоОрганизациям",        ВключитьОтборПоОрганизациям);
	Запрос.УстановитьПараметр("ТолькоАвансы",                       ПараметрыПоиска.ТолькоАвансы);
	Запрос.УстановитьПараметр("ОграничитьТипыДокументовОплаты",     ПараметрыПоиска.ОграничитьТипыДокументовОплаты);
	Запрос.УстановитьПараметр("ОграничитьТипыОснованийОплаты",      ПараметрыПоиска.ОграничитьТипыОснованийОплаты);
	Запрос.УстановитьПараметр("мТиповДокументовОплатыВходящие",     мТиповДокументовОплатыВходящие);
	Запрос.УстановитьПараметр("мТиповДокументовОплатыИсходящие",    мТиповДокументовОплатыИсходящие);
	Запрос.УстановитьПараметр("мТиповОснованийОплатыВходящие",      мТиповОснованийОплатыВходящие);
	Запрос.УстановитьПараметр("мТиповОснованийОплатыИсходящие",     мТиповОснованийОплатыИсходящие);
	
	Запрос.УстановитьПараметр("НоваяАрхитектураВзаиморасчетов",
		ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов"));
	
	
	// Обработка текста запроса
	
	// - Текст отбора по документам
	
	ИмяПоляОтбора    = ПараметрыПоиска.ПараметрыОтбораПоТаблицеДокументов.ИмяПоля;
	ИмяТаблицыОтбора = ПараметрыПоиска.ПараметрыОтбораПоТаблицеДокументов.ИмяТаблицыОтбора;
	
	ЗаданОтборПоВременнойТаблице = ЗначениеЗаполнено(ИмяТаблицыОтбора) И ЗначениеЗаполнено(ИмяПоляОтбора);
	
	Если НЕ ЗаданОтборПоВременнойТаблице Тогда
		
		ИмяТаблицыОтбора = "ТаблицаОтбораОснованийИДокументовОплаты";
		ИмяПоляОтбора    = "ДокументОтбора";
		
		ТекстЗапросаСозданияТаблицыОтбора = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ТаблицаДокументов.ДокументОтбора КАК ДокументОтбора
		|ПОМЕСТИТЬ ТаблицаОтбораОснованийИДокументовОплаты_Предварительная
		|ИЗ
		|	&ТаблицаДокументов КАК ТаблицаДокументов
		|;
		|
		|ВЫБРАТЬ
		|	ТаблицаДокументов.ДокументОтбора,
		|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетов
		|ПОМЕСТИТЬ ТаблицаОтбораОснованийИДокументовОплаты
		|ИЗ
		|	ТаблицаОтбораОснованийИДокументовОплаты_Предварительная КАК ТаблицаДокументов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
		|			ПО ТаблицаДокументов.ДокументОтбора = ОбъектыРасчетов.Объект
		|				И НЕ ОбъектыРасчетов.ПометкаУдаления
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ДокументОтбора
		|;
		|
		|УНИЧТОЖИТЬ ТаблицаОтбораОснованийИДокументовОплаты_Предварительная
		|";
		
	Иначе
		
		ТекстЗапросаСозданияТаблицыОтбора = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ИмяПоляДокумента КАК ДокументОтбора,
		|	ОбъектыРасчетов.Ссылка КАК ОбъектРасчетов
		|ПОМЕСТИТЬ ТаблицаОтбораОснованийИДокументовОплаты
		|ИЗ
		|	ИмяТаблицыОтбораОснованийИДокументовОплаты КАК ТаблицаДокументов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
		|			ПО ТаблицаДокументов.ИмяПоляДокумента = ОбъектыРасчетов.Объект
		|				И НЕ ОбъектыРасчетов.ПометкаУдаления
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ДокументОтбора
		|";
		
	КонецЕсли;
	
	ТекстЗапросаУничтоженияТаблицыОтбора = "УНИЧТОЖИТЬ ТаблицаОтбораОснованийИДокументовОплаты";
	
	Запрос.Текст = ТекстЗапросаСозданияТаблицыОтбора
					+ ОбщегоНазначения.РазделительПакетаЗапросов() + Запрос.Текст
					+ ОбщегоНазначения.РазделительПакетаЗапросов() + ТекстЗапросаУничтоженияТаблицыОтбора;
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИмяТаблицыОтбораОснованийИДокументовОплаты", ИмяТаблицыОтбора);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИмяПоляДокумента",                           ИмяПоляОтбора);
	
	Если ПараметрыПоиска.РежимПоиска = 1 Тогда
		
		// Поля соединения
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&РежимПоиска1_ДокументРегистратор_РежимПоиска2_РасчетныйДокумент",
			"Расчеты.ДокументРегистратор = ТаблицаОтбораОснованийИДокументовОплаты.ДокументОтбора");
			
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&РежимПоиска1_ОбъектРасчетов_РежимПоиска2_ДокументРегистратор",
			"Расчеты.ОбъектРасчетов = ТаблицаОтбораОснованийИДокументовОплаты.ОбъектРасчетов");
			
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&РежимПоиска1_РасчетныйДокумент_РежимПоиска2_ДокументРегистратор",
			"Расчеты.РасчетныйДокумент = ТаблицаОтбораОснованийИДокументовОплаты.ДокументОтбора");
			
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&РежимПоиска1_Регистратор_РежимПоиска2_РасчетныйДокумент",
			"Расчеты.Регистратор = ТаблицаОтбораОснованийИДокументовОплаты.ДокументОтбора");
			
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&РежимПоиска1_ЗаказКлиента_РежимПоиска2_Регистратор",
			"Расчеты.ЗаказКлиента = ТаблицаОтбораОснованийИДокументовОплаты.ОбъектРасчетов");
			
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&РежимПоиска1_ЗаказПоставщику_РежимПоиска2_Регистратор",
			"Расчеты.ЗаказПоставщику = ТаблицаОтбораОснованийИДокументовОплаты.ОбъектРасчетов");
			
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&РежимПоиска1_РасчетныйДокумент_РежимПоиска2_Регистратор",
			"Расчеты.РасчетныйДокумент = ТаблицаОтбораОснованийИДокументовОплаты.ДокументОтбора");
		
		
		// поля выборки
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПолеОснованиеОплаты_ОбъектРасчетов",
			"ТаблицаОтбораОснованийИДокументовОплаты.ДокументОтбора");
			
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПолеОснованиеОплаты_ЗаказКлиента",
			"ТаблицаОтбораОснованийИДокументовОплаты.ДокументОтбора");
			
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПолеОснованиеОплаты_ЗаказПоставщику",
			"ТаблицаОтбораОснованийИДокументовОплаты.ДокументОтбора");
		
	ИначеЕсли ПараметрыПоиска.РежимПоиска = 2 Тогда
		
		// Поля соединения
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&РежимПоиска1_ДокументРегистратор_РежимПоиска2_РасчетныйДокумент",
			"Расчеты.РасчетныйДокумент = ТаблицаОтбораОснованийИДокументовОплаты.ДокументОтбора");
			
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&РежимПоиска1_ОбъектРасчетов_РежимПоиска2_ДокументРегистратор",
			"Расчеты.ДокументРегистратор = ТаблицаОтбораОснованийИДокументовОплаты.ДокументОтбора");
			
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&РежимПоиска1_РасчетныйДокумент_РежимПоиска2_ДокументРегистратор",
			"Расчеты.ДокументРегистратор = ТаблицаОтбораОснованийИДокументовОплаты.ДокументОтбора");
			
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&РежимПоиска1_Регистратор_РежимПоиска2_РасчетныйДокумент",
			"Расчеты.РасчетныйДокумент = ТаблицаОтбораОснованийИДокументовОплаты.ДокументОтбора");
			
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&РежимПоиска1_ЗаказКлиента_РежимПоиска2_Регистратор",
			"Расчеты.Регистратор = ТаблицаОтбораОснованийИДокументовОплаты.ДокументОтбора");
			
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&РежимПоиска1_ЗаказПоставщику_РежимПоиска2_Регистратор",
			"Расчеты.Регистратор = ТаблицаОтбораОснованийИДокументовОплаты.ДокументОтбора");
			
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&РежимПоиска1_РасчетныйДокумент_РежимПоиска2_Регистратор",
			"Расчеты.Регистратор = ТаблицаОтбораОснованийИДокументовОплаты.ДокументОтбора");
		
		
		// поля выборки
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПолеОснованиеОплаты_ОбъектРасчетов",
			"Расчеты.ОбъектРасчетов.Объект");
			
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПолеОснованиеОплаты_ЗаказКлиента",
			"Расчеты.ЗаказКлиента.Объект");
			
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПолеОснованиеОплаты_ЗаказПоставщику",
			"Расчеты.ЗаказПоставщику.Объект");
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область АвансыПоДаннымВзаиморасчетов

// Устанавливает необходимые параметры для исполнения запросов по данным взаиморасчетов
//
// Параметры:
//  Запрос           - Запрос - 
//  ПараметрыРасчета - см. ИнициализироватьПараметрыПодготовкиРасчетовАвансов
Процедура УстановитьПараметрыЗапросаПодготовкиРасчетовАвансов(Запрос, ПараметрыРасчета)
	
	Если НЕ ЗначениеЗаполнено(ПараметрыРасчета.ДатаОкончания) Тогда
		ДатаОкончания        = Дата(3000, 1, 1);
		ДатаОкончанияВключая = Неопределено;
	Иначе
		ДатаОкончания        = ПараметрыРасчета.ДатаОкончания;
		ДатаОкончанияВключая = Новый Граница(ДатаОкончания);
	КонецЕсли;
	
	ПустаяДата        = '00010101';
	
	Если ЗначениеЗаполнено(ПараметрыРасчета.Организации) Тогда
		Организации                 = ПараметрыРасчета.Организации;
	Иначе
		Организации                 = Неопределено;
	КонецЕсли;
	
	РасчетныйДокумент = ?(ЗначениеЗаполнено(ПараметрыРасчета.РасчетныйДокумент),
							ПараметрыРасчета.РасчетныйДокумент, Неопределено);
	
	Если ЗначениеЗаполнено(ПараметрыРасчета.ПараметрыОтбораПоРасчетномуДокументу.ИмяТаблицыОтбора)
		ИЛИ ЗначениеЗаполнено(РасчетныйДокумент) Тогда
		ВключитьОтборПоРасчетномуДокументу = Истина;
	Иначе
		ВключитьОтборПоРасчетномуДокументу = Ложь;
	КонецЕсли;
	
	ТипыДокументовВозврата_ПолученныеАвансы = Новый Массив;
	ТипыДокументовВозврата_ПолученныеАвансы.Добавить(Тип("ДокументСсылка.СписаниеБезналичныхДенежныхСредств"));
	ТипыДокументовВозврата_ПолученныеАвансы.Добавить(Тип("ДокументСсылка.РасходныйКассовыйОрдер"));
	
	Запрос.УстановитьПараметр("ДатаНачала",           ПараметрыРасчета.ДатаНачала);
	Запрос.УстановитьПараметр("ДатаОкончания",        ДатаОкончания);
	Запрос.УстановитьПараметр("ДатаОкончанияВключая", ДатаОкончанияВключая);
	Запрос.УстановитьПараметр("СоздатьПустуюТаблицу", ПараметрыРасчета.СоздатьПустуюТаблицу);
	Запрос.УстановитьПараметр("ПустаяДата",           ПустаяДата);
	Запрос.УстановитьПараметр("Организации",          Организации);
	Запрос.УстановитьПараметр("РасчетныйДокумент",    РасчетныйДокумент);
	Запрос.УстановитьПараметр("ПустойОбъектРасчетов", Справочники.ОбъектыРасчетов.ПустаяСсылка());
	Запрос.УстановитьПараметр("УчестьРезервированиеАвансов",        ПараметрыРасчета.УчестьРезервированиеАвансов);
	Запрос.УстановитьПараметр("НоваяАрхитектураВзаиморасчетов",     ПараметрыРасчета.НоваяАрхитектураВзаиморасчетов);
	Запрос.УстановитьПараметр("ВключитьОтборПоРасчетномуДокументу", ВключитьОтборПоРасчетномуДокументу);
	Запрос.УстановитьПараметр("ВключитьОтборПоОрганизациям",        ПараметрыРасчета.ВключитьОтборПоОрганизациям);
	Запрос.УстановитьПараметр("ТипыДокументовВозврата_ПолученныеАвансы", ТипыДокументовВозврата_ПолученныеАвансы);
	Запрос.УстановитьПараметр("ПравилоОтбораАвансов", ПараметрыРасчета.ПравилоОтбораАвансов);
	
КонецПроцедуры

// Переопределяет индексы запроса
// 
// Параметры:
// 	Запрос - Запрос -
// 	ПараметрыРасчета - см. ИнициализироватьПараметрыПодготовкиРасчетовАвансов
// 	ИмяТаблицы - Строка - имя временной таблицы, в которой меняем порядок индексов
Процедура УстановитьПоляИндексов(Запрос, ПараметрыРасчета, ИмяТаблицы)
	
	мПоляИндексов = ПараметрыРасчета.ПоляИндексовВручную;
	
	Если НЕ ЗначениеЗаполнено(мПоляИндексов) Тогда
		Возврат;
	КонецЕсли;
	
	СхемаЗапроса = Новый СхемаЗапроса;
	
	СхемаЗапроса.УстановитьТекстЗапроса(Запрос.Текст);
	
	Для каждого Пакет Из СхемаЗапроса.ПакетЗапросов Цикл
		Если Пакет.ТаблицаДляПомещения = ИмяТаблицы Тогда
			
			Пакет.Порядок.Очистить();
			Для каждого ПолеИндекса из мПоляИндексов Цикл
				Пакет.Индекс.Добавить(ПолеИндекса);
			КонецЦикла;
			
		КонецЕсли;
	КонецЦикла;
	
	Запрос.Текст = СхемаЗапроса.ПолучитьТекстЗапроса();
	
КонецПроцедуры

// Обработка запроса в целях отбора по расчетному документу
// 
// Параметры:
// 	Запрос - Запрос -
// 	ПараметрыРасчета - см. ИнициализироватьПараметрыПодготовкиРасчетовАвансов
// 	ПараметрыПутей   - см. ИнициализироватьПараметрыДляОтбораАвансов_ПутиКПолямИТекстуЗамены
//
Процедура ОбработатьТекстЗапросаДляОтбораАвансовПоПараметрам(Запрос, ПараметрыРасчета, ПараметрыПутей)
	
	мТекстовОтборПоПараметрам = Новый Массив;
	
	
	ИмяПоляОтбора    = ПараметрыРасчета.ПараметрыОтбораПоРасчетномуДокументу.ИмяПоля;
	ИмяТаблицыОтбора = ПараметрыРасчета.ПараметрыОтбораПоРасчетномуДокументу.ИмяТаблицыОтбора;
	
	ПолныйПуть = ПараметрыПутей.ПолныйПуть_РасчетныйДокумент;
	
	Если ЗначениеЗаполнено(ИмяТаблицыОтбора) Тогда
		
		ШаблонТекста = "%1 В
		|			(ВЫБРАТЬ
		|				%2 КАК Ссылка
		|			ИЗ
		|				%3 КАК Т
		|			)
		|";
		
		мТекстовОтборПоПараметрам.Добавить(СтрШаблон(ШаблонТекста, ПолныйПуть, ИмяПоляОтбора, ИмяТаблицыОтбора));
		
	Иначе
		
		ШаблонТекста = "(НЕ &ВключитьОтборПоРасчетномуДокументу ИЛИ %1 В (&РасчетныйДокумент))";
		мТекстовОтборПоПараметрам.Добавить(СтрШаблон(ШаблонТекста, ПолныйПуть));
		
	КонецЕсли;
	
	
	ТекстОтборПоПараметрам = СтрСоединить(мТекстовОтборПоПараметрам, " И ");
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ПараметрыПутей.ТекстЗамены, ТекстОтборПоПараметрам);
	
КонецПроцедуры

// Инициализировать параметры для указания путей к полям и тексту замены отбора по параметрам
//
// Возвращаемое значение:
//  Структура - содержит:
//  	* ТекстЗамены                  - Строка - Заменяемый текст в запросе
//  	* ПолныйПуть_РасчетныйДокумент - Строка - Полный путь к расчетному документу
//
Функция ИнициализироватьПараметрыДляОтбораАвансов_ПутиКПолямИТекстуЗамены()
	
	СтруктураПараметров = Новый Структура;
	
	СтруктураПараметров.Вставить("ТекстЗамены", "&ТекстОтборПоПараметрам");
	
	СтруктураПараметров.Вставить("ПолныйПуть_РасчетныйДокумент", "РасчетныйДокумент");
	
	Возврат СтруктураПараметров;
	
КонецФункции

Процедура ЗаполнитьСвойстваПараметров(Приемник, Источник)
	
	ТипПриемника  = ТипЗнч(Приемник);
	ТипИсточника  = ТипЗнч(Источник);
	
	Если ТипПриемника = Тип("Структура") И ТипИсточника = Тип("Структура") Тогда
			Для каждого ЭлементПриемника Из Приемник Цикл
				ЗначениеИсточника = Неопределено;
				Если Источник.Свойство(ЭлементПриемника.Ключ, ЗначениеИсточника) Тогда
					ЗаполнитьСвойстваПараметров(Приемник[ЭлементПриемника.Ключ], ЗначениеИсточника);
				КонецЕсли;
			КонецЦикла;
	ИначеЕсли ТипПриемника <> Тип("Структура") И ТипИсточника <> Тип("Структура") Тогда
		Приемник = ОбщегоНазначения.СкопироватьРекурсивно(Источник);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти
