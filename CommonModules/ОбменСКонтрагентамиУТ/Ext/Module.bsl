#Область ПрограммныйИнтерфейс

// См. ОбменСКонтрагентамиПереопределяемый.ПриОпределенииИспользуемыхТиповЭлектронныхДокументов.
Процедура ПриОпределенииИспользуемыхТиповЭлектронныхДокументов(АктуальныеТипы) Экспорт
	
	ТипыДокументов = ОбменСКонтрагентами.ТипыДокументов();
	
	// Для обмена по форматам ФНС.
	ОбменСКонтрагентами.ДобавитьИспользуемыйТипДокумента(АктуальныеТипы, ТипыДокументов.ТоварнаяНакладная);
	ОбменСКонтрагентами.ДобавитьИспользуемыйТипДокумента(АктуальныеТипы, ТипыДокументов.АктВыполненныхРабот);
	ОбменСКонтрагентами.ДобавитьИспользуемыйТипДокумента(АктуальныеТипы, ТипыДокументов.СчетФактура);
	ОбменСКонтрагентами.ДобавитьИспользуемыйТипДокумента(АктуальныеТипы, ТипыДокументов.КорректировочныйСчетФактура);
	ОбменСКонтрагентами.ДобавитьИспользуемыйТипДокумента(АктуальныеТипы, ТипыДокументов.СоглашениеОбИзмененииСтоимости);
	ОбменСКонтрагентами.ДобавитьИспользуемыйТипДокумента(АктуальныеТипы, ТипыДокументов.АктНаПередачуПрав);
	ОбменСКонтрагентами.ДобавитьИспользуемыйТипДокумента(АктуальныеТипы, ТипыДокументов.УПД);
	ОбменСКонтрагентами.ДобавитьИспользуемыйТипДокумента(АктуальныеТипы, ТипыДокументов.УКД);
	ОбменСКонтрагентами.ДобавитьИспользуемыйТипДокумента(АктуальныеТипы, ТипыДокументов.АктОРасхождениях);
	ОбменСКонтрагентами.ДобавитьИспользуемыйТипДокумента(АктуальныеТипы, ТипыДокументов.СведенияОРеализацииКомиссионером);
	ОбменСКонтрагентами.ДобавитьИспользуемыйТипДокумента(АктуальныеТипы, ТипыДокументов.СведенияОЗакупкеКомиссионером);
	ОбменСКонтрагентами.ДобавитьИспользуемыйТипДокумента(АктуальныеТипы, ТипыДокументов.АктСверкиВзаиморасчетов);  
	ОбменСКонтрагентами.ДобавитьИспользуемыйТипДокумента(АктуальныеТипы, ТипыДокументов.ДоговорныйДокумент);
	
	// Для обмена по форматам CML 2.
	ОбменСКонтрагентами.ДобавитьИспользуемыйТипДокумента(АктуальныеТипы, ТипыДокументов.КаталогТоваров);
	ОбменСКонтрагентами.ДобавитьИспользуемыйТипДокумента(АктуальныеТипы, ТипыДокументов.ЗаказТовара);
	ОбменСКонтрагентами.ДобавитьИспользуемыйТипДокумента(АктуальныеТипы, ТипыДокументов.ОтветНаЗаказ);
	ОбменСКонтрагентами.ДобавитьИспользуемыйТипДокумента(АктуальныеТипы, ТипыДокументов.СчетНаОплату);
	ОбменСКонтрагентами.ДобавитьИспользуемыйТипДокумента(АктуальныеТипы, ТипыДокументов.ОтчетОПродажахКомиссионногоТовара);
	ОбменСКонтрагентами.ДобавитьИспользуемыйТипДокумента(АктуальныеТипы, ТипыДокументов.ОтчетОСписанииКомиссионногоТовара);
	ОбменСКонтрагентами.ДобавитьИспользуемыйТипДокумента(АктуальныеТипы, ТипыДокументов.ЗапросКоммерческихПредложений);
	ОбменСКонтрагентами.ДобавитьИспользуемыйТипДокумента(АктуальныеТипы, ТипыДокументов.КоммерческоеПредложение);

	// Для обмена между организациями
	ОбменСКонтрагентами.ДобавитьИспользуемыйТипДокумента(АктуальныеТипы, ТипыДокументов.ПередачаТоваровМеждуОрганизациями);
	ОбменСКонтрагентами.ДобавитьИспользуемыйТипДокумента(АктуальныеТипы, ТипыДокументов.ВозвратТоваровМеждуОрганизациями);
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ПодготовитьСтруктуруОбъектовКомандЭДО.
Процедура ПодготовитьСтруктуруОбъектовКомандЭДО(СоставКомандЭДО) Экспорт
	
	СоставКомандЭДО.Исходящие.Добавить("Документ.РеализацияТоваровУслуг");
	СоставКомандЭДО.Исходящие.Добавить("Документ.РеализацияУслугПрочихАктивов");
	СоставКомандЭДО.Исходящие.Добавить("Документ.АктВыполненныхРабот");
	СоставКомандЭДО.Исходящие.Добавить("Документ.СчетФактураВыданный");
	СоставКомандЭДО.Исходящие.Добавить("Документ.СчетФактураВыданныйАванс");
	СоставКомандЭДО.Исходящие.Добавить("Документ.СчетФактураКомиссионеру");
	СоставКомандЭДО.Исходящие.Добавить("Документ.ЗаказПоставщику");
	СоставКомандЭДО.Исходящие.Добавить("Документ.ЗаказКлиента");
	СоставКомандЭДО.Исходящие.Добавить("Документ.СчетНаОплатуКлиенту");
	СоставКомандЭДО.Исходящие.Добавить("Документ.КоммерческоеПредложениеКлиенту");
	СоставКомандЭДО.Исходящие.Добавить("Документ.ОтчетКомитенту");
	СоставКомандЭДО.Исходящие.Добавить("Документ.ОтчетКомитентуОСписании");
	СоставКомандЭДО.Исходящие.Добавить("Документ.ОтчетКомитентуОЗакупках");
	СоставКомандЭДО.Исходящие.Добавить("Документ.КорректировкаРеализации");
	СоставКомандЭДО.Исходящие.Добавить("Обработка.ЖурналДокументовПродажи");
	СоставКомандЭДО.Исходящие.Добавить("Обработка.ЖурналДокументовНДС");
	СоставКомандЭДО.Исходящие.Добавить("Обработка.ЖурналДокументовОтчетыКомитентам");
	СоставКомандЭДО.Исходящие.Добавить("Обработка.ЖурналДокументовИнтеркампани");
	
	СоставКомандЭДО.Исходящие.Добавить("Документ.АктОРасхожденияхПослеПриемки");
	СоставКомандЭДО.Исходящие.Добавить("Документ.ВозвратТоваровПоставщику");
	СоставКомандЭДО.Исходящие.Добавить("Документ.ВыкупТоваровХранителем");
	СоставКомандЭДО.Исходящие.Добавить("Документ.СверкаВзаиморасчетов2_5_11");
	СоставКомандЭДО.Исходящие.Добавить("ЖурналДокументов.СверкиВзаиморасчетов");
	СоставКомандЭДО.Исходящие.Добавить("Документ.ПередачаТоваровМеждуОрганизациями");
	СоставКомандЭДО.Исходящие.Добавить("Документ.ВозвратТоваровМеждуОрганизациями"); 
	СоставКомандЭДО.Исходящие.Добавить("Справочник.ДоговорыКонтрагентов");
	
	СоставКомандЭДО.Входящие.Добавить("Документ.ПриобретениеТоваровУслуг");
	СоставКомандЭДО.Входящие.Добавить("Документ.ПриобретениеУслугПрочихАктивов");
	СоставКомандЭДО.Входящие.Добавить("Документ.ВозвратТоваровОтКлиента");
	СоставКомандЭДО.Входящие.Добавить("Документ.СчетФактураПолученный");
	СоставКомандЭДО.Входящие.Добавить("Документ.СчетФактураПолученныйАванс");
	СоставКомандЭДО.Входящие.Добавить("Документ.СчетФактураКомитента");
	СоставКомандЭДО.Входящие.Добавить("Документ.ЗаказПоставщику");
	СоставКомандЭДО.Входящие.Добавить("Документ.ЗаказКлиента");
	СоставКомандЭДО.Входящие.Добавить("Документ.ЗаявкаНаРасходованиеДенежныхСредств");
	СоставКомандЭДО.Входящие.Добавить("Документ.РегистрацияЦенНоменклатурыПоставщика");
	СоставКомандЭДО.Входящие.Добавить("Документ.ОтчетКомиссионера");
	СоставКомандЭДО.Входящие.Добавить("Документ.ОтчетКомиссионераОСписании");
	СоставКомандЭДО.Входящие.Добавить("Документ.КорректировкаПриобретения");
	СоставКомандЭДО.Входящие.Добавить("Обработка.ЖурналДокументовЗакупки");
	СоставКомандЭДО.Входящие.Добавить("Обработка.ЖурналДокументовНДС");
	СоставКомандЭДО.Входящие.Добавить("Обработка.ЖурналДокументовОтчетыКомиссионеров");
	СоставКомандЭДО.Входящие.Добавить("Документ.АктОРасхожденияхПослеОтгрузки");
	СоставКомандЭДО.Входящие.Добавить("Документ.СверкаВзаиморасчетов2_5_11");
	СоставКомандЭДО.Входящие.Добавить("ЖурналДокументов.СверкиВзаиморасчетов");

	СоставКомандЭДО.Интеркампани.Добавить("Документ.ПередачаТоваровМеждуОрганизациями");
	СоставКомандЭДО.Интеркампани.Добавить("Документ.ВозвратТоваровМеждуОрганизациями");
	СоставКомандЭДО.Интеркампани.Добавить("Обработка.ЖурналДокументовИнтеркампани");
	
	СоставКомандЭДО.БезПодписи.Добавить("Документ.РеализацияТоваровУслуг");
	СоставКомандЭДО.БезПодписи.Добавить("Документ.РеализацияУслугПрочихАктивов");
	СоставКомандЭДО.БезПодписи.Добавить("Документ.АктВыполненныхРабот");
	СоставКомандЭДО.БезПодписи.Добавить("Документ.ВозвратТоваровПоставщику");
	СоставКомандЭДО.БезПодписи.Добавить("Документ.ЗаказПоставщику");
	СоставКомандЭДО.БезПодписи.Добавить("Документ.ЗаказКлиента");
	СоставКомандЭДО.БезПодписи.Добавить("Документ.СчетНаОплатуКлиенту");
	СоставКомандЭДО.БезПодписи.Добавить("Документ.КоммерческоеПредложениеКлиенту");
	СоставКомандЭДО.БезПодписи.Добавить("ЖурналДокументов.ОтчетыКомитентам");
	СоставКомандЭДО.БезПодписи.Добавить("Документ.ОтчетКомитенту");
	СоставКомандЭДО.БезПодписи.Добавить("Документ.ОтчетКомитентуОСписании");
	СоставКомандЭДО.БезПодписи.Добавить("Документ.КорректировкаРеализации");
	СоставКомандЭДО.БезПодписи.Добавить("Обработка.ЖурналДокументовПродажи");
	
	СоставКомандЭДО.БезПодписи.Добавить("Документ.ПриобретениеТоваровУслуг");
	СоставКомандЭДО.БезПодписи.Добавить("Документ.ПриобретениеУслугПрочихАктивов");
	СоставКомандЭДО.БезПодписи.Добавить("Документ.ЗаявкаНаРасходованиеДенежныхСредств");
	СоставКомандЭДО.БезПодписи.Добавить("Документ.РегистрацияЦенНоменклатурыПоставщика");
	СоставКомандЭДО.БезПодписи.Добавить("Документ.ОтчетКомиссионера");
	СоставКомандЭДО.БезПодписи.Добавить("Документ.ОтчетКомиссионераОСписании");
	СоставКомандЭДО.БезПодписи.Добавить("Документ.КорректировкаПриобретения");
	СоставКомандЭДО.БезПодписи.Добавить("Обработка.ЖурналДокументовЗакупки");
	СоставКомандЭДО.БезПодписи.Добавить("Документ.СверкаВзаиморасчетов2_5_11");
	
	СоставКомандЭДО.Внутренние.Добавить("Документ.ИнвентаризационнаяОпись");
	СоставКомандЭДО.Внутренние.Добавить("Документ.ОприходованиеИзлишковТоваров");
	СоставКомандЭДО.Внутренние.Добавить("Документ.ВнутреннееПотребление");
	СоставКомандЭДО.Внутренние.Добавить("Документ.ПеремещениеТоваров");
	СоставКомандЭДО.Внутренние.Добавить("Документ.ПересортицаТоваров");
	СоставКомандЭДО.Внутренние.Добавить("Документ.СписаниеНедостачТоваров");
	СоставКомандЭДО.Внутренние.Добавить("Документ.ЛистКассовойКниги");
	СоставКомандЭДО.Внутренние.Добавить("Документ.ПриходныйКассовыйОрдер");
	СоставКомандЭДО.Внутренние.Добавить("Документ.РасходныйКассовыйОрдер");
	СоставКомандЭДО.Внутренние.Добавить("Документ.АвансовыйОтчет");
	СоставКомандЭДО.Внутренние.Добавить("Документ.ДоверенностьВыданная");
	СоставКомандЭДО.Внутренние.Добавить("Документ.ИнвентаризацияНаличныхДенежныхСредств");
	СоставКомандЭДО.Внутренние.Добавить("Документ.ПоступлениеТоваровНаСклад");
	СоставКомандЭДО.Внутренние.Добавить("Документ.ПоступлениеУслугВПодразделение");
	СоставКомандЭДО.Внутренние.Добавить("Документ.СборкаТоваров");
	СоставКомандЭДО.Внутренние.Добавить("Документ.ПриемкаТоваровНаХранение");
	
	ИспользоватьПартнеровКакКонтрагентов = ПолучитьФункциональнуюОпцию("ИспользоватьПартнеровКакКонтрагентов");
	Если ИспользоватьПартнеровКакКонтрагентов Тогда	
		СоставКомандЭДО.Контрагенты.Добавить("Справочник.Партнеры");
		СоставКомандЭДО.Контрагенты.Добавить("Справочник.Контрагенты");
	Иначе	
		СоставКомандЭДО.Контрагенты.Добавить("Справочник.Контрагенты");
	КонецЕсли;
	СоставКомандЭДО.Организации.Добавить("Справочник.Организации");
	СоставКомандЭДО.Договоры.Добавить("Справочник.ДоговорыКонтрагентов");
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.СоответствиеИсходящихТиповЭлектронныхДокументовДокументамИБ.
Процедура СоответствиеИсходящихТиповЭлектронныхДокументовДокументамИБ(СоответствиеТиповЭлектронныхДокументовДокументамИБ) Экспорт 
	
	ТипыДокументов = ОбменСКонтрагентами.ТипыДокументов();
	
	СоответствиеТиповЭлектронныхДокументовДокументамИБ.Вставить(ТипыДокументов.ТоварнаяНакладная,         				НСтр("ru = 'Реализация товаров и услуг'"));
	СоответствиеТиповЭлектронныхДокументовДокументамИБ.Вставить(ТипыДокументов.АктВыполненныхРабот,        				НСтр("ru = 'Акт выполненных работ для клиента'"));
	СоответствиеТиповЭлектронныхДокументовДокументамИБ.Вставить(ТипыДокументов.АктНаПередачуПрав,     					НСтр("ru = 'Акт на передачу прав'"));
	СоответствиеТиповЭлектронныхДокументовДокументамИБ.Вставить(ТипыДокументов.СчетФактура,            					НСтр("ru = 'Счет-фактура выданный'"));
	СоответствиеТиповЭлектронныхДокументовДокументамИБ.Вставить(ТипыДокументов.СоглашениеОбИзмененииСтоимости, 			НСтр("ru = 'Корректировка реализации'"));
	СоответствиеТиповЭлектронныхДокументовДокументамИБ.Вставить(ТипыДокументов.КорректировочныйСчетФактура, 			НСтр("ru = 'Счет-фактура выданный (корректировка)'"));
	СоответствиеТиповЭлектронныхДокументовДокументамИБ.Вставить(ТипыДокументов.ОтветНаЗаказ,           					НСтр("ru = 'Заказ клиента'"));
	СоответствиеТиповЭлектронныхДокументовДокументамИБ.Вставить(ТипыДокументов.ЗаказТовара,            					НСтр("ru = 'Заказ поставщику'"));
	СоответствиеТиповЭлектронныхДокументовДокументамИБ.Вставить(ТипыДокументов.ПрайсЛист,              					НСтр("ru = 'Коммерческое предложение клиенту'"));
	СоответствиеТиповЭлектронныхДокументовДокументамИБ.Вставить(ТипыДокументов.СчетНаОплату,           					НСтр("ru = 'Счет на оплату клиенту'"));
	СоответствиеТиповЭлектронныхДокументовДокументамИБ.Вставить(ТипыДокументов.ОтчетОСписанииКомиссионногоТовара, 		НСтр("ru = 'Отчет комитенту о списании'"));
	СоответствиеТиповЭлектронныхДокументовДокументамИБ.Вставить(ТипыДокументов.ОтчетОПродажахКомиссионногоТовара, 		НСтр("ru = 'Отчет комитенту о продажах'"));
	СоответствиеТиповЭлектронныхДокументовДокументамИБ.Вставить(ТипыДокументов.УПД,            							НСтр("ru = 'Акты, накладные, счет-фактуры'"));
	СоответствиеТиповЭлектронныхДокументовДокументамИБ.Вставить(ТипыДокументов.УКД,            							НСтр("ru = 'Акты, накладные, счет-фактуры (Корректировка)'"));
	СоответствиеТиповЭлектронныхДокументовДокументамИБ.Вставить(ТипыДокументов.АктОРасхождениях,       					НСтр("ru = 'Акт о расхождениях после поступления'"));
	СоответствиеТиповЭлектронныхДокументовДокументамИБ.Вставить(ТипыДокументов.КаталогТоваров,         					НСтр("ru = 'Каталог товаров (формируется из Настройки отправки)'"));
	СоответствиеТиповЭлектронныхДокументовДокументамИБ.Вставить(ТипыДокументов.СведенияОРеализацииКомиссионером,        НСтр("ru = 'Отчет комитенту о продажах'"));
	СоответствиеТиповЭлектронныхДокументовДокументамИБ.Вставить(ТипыДокументов.СведенияОЗакупкеКомиссионером,           НСтр("ru = 'Отчет комитенту о закупках'"));
	СоответствиеТиповЭлектронныхДокументовДокументамИБ.Вставить(ТипыДокументов.АктСверкиВзаиморасчетов,                 НСтр("ru = 'Сверка взаиморасчетов'"));
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.СписокТиповДокументовПоТипуЭлектронногоДокумента.
Процедура СписокТиповДокументовПоТипуЭлектронногоДокумента(ТипДокумента, СписокВозврата) Экспорт
	
	ТипыДокументов = ОбменСКонтрагентами.ТипыДокументов();
	
	Если ТипДокумента = ТипыДокументов.ТоварнаяНакладная 
		Или ТипДокумента = ТипыДокументов.АктНаПередачуПрав 
		Или ТипДокумента = ТипыДокументов.СоглашениеОбИзмененииСтоимости Тогда
		
		СписокВозврата.Добавить(Документы.ПриобретениеТоваровУслуг.ПустаяСсылка(), 
			Метаданные.Документы.ПриобретениеТоваровУслуг.Представление());
			
	ИначеЕсли ТипДокумента = ТипыДокументов.СчетФактура Или ТипДокумента = ТипыДокументов.КорректировочныйСчетФактура
		Или ТипДокумента = ТипыДокументов.УПД Или ТипДокумента = ТипыДокументов.УКД Тогда
		
		СписокВозврата.Добавить(Документы.СчетФактураПолученный.ПустаяСсылка(),
			Метаданные.Документы.СчетФактураПолученный.Представление());
		
	ИначеЕсли ТипДокумента = ТипыДокументов.АктВыполненныхРабот Тогда
		
		СписокВозврата.Добавить(Документы.ПриобретениеУслугПрочихАктивов.ПустаяСсылка(), 
			Метаданные.Документы.ПриобретениеУслугПрочихАктивов.Представление());
		
	ИначеЕсли ТипДокумента = ТипыДокументов.ОтчетОПродажахКомиссионногоТовара Тогда
		
		СписокВозврата.Добавить(Документы.ОтчетКомиссионера.ПустаяСсылка(), 
			Метаданные.Документы.ОтчетКомиссионера.Представление());
		
	ИначеЕсли ТипДокумента = ТипыДокументов.ОтчетОСписанииКомиссионногоТовара Тогда
		
		СписокВозврата.Добавить(Документы.ОтчетКомиссионераОСписании.ПустаяСсылка(), 
			Метаданные.Документы.ОтчетКомиссионераОСписании.Представление());
		
	ИначеЕсли ТипДокумента = ТипыДокументов.ПрайсЛист Тогда
		
		СписокВозврата.Добавить(Документы.РегистрацияЦенНоменклатурыПоставщика.ПустаяСсылка(), 
			 Метаданные.Документы.РегистрацияЦенНоменклатурыПоставщика.Представление());
		
	ИначеЕсли ТипДокумента = ТипыДокументов.СчетНаОплату Тогда
		
		СписокВозврата.Добавить(Документы.ЗаявкаНаРасходованиеДенежныхСредств.ПустаяСсылка(), 
			Метаданные.Документы.ЗаявкаНаРасходованиеДенежныхСредств.Представление());
		
	ИначеЕсли ТипДокумента = ТипыДокументов.ЗаказТовара Тогда
		
		СписокВозврата.Добавить(Документы.ЗаказКлиента.ПустаяСсылка(),
			Метаданные.Документы.ЗаказКлиента.Представление());
		
	ИначеЕсли ТипДокумента = ТипыДокументов.ОтветНаЗаказ Тогда
		
		СписокВозврата.Добавить(Документы.ЗаказПоставщику.ПустаяСсылка(),
			Метаданные.Документы.ЗаказПоставщику.Представление());
			
	ИначеЕсли ТипДокумента = ТипыДокументов.АктОРасхождениях Тогда
		
		СписокВозврата.Добавить(Документы.АктОРасхожденияхПослеОтгрузки.ПустаяСсылка(),
			Метаданные.Документы.АктОРасхожденияхПослеОтгрузки.Представление());
			
	ИначеЕсли ТипДокумента = ТипыДокументов.АктСверкиВзаиморасчетов Тогда
		
		СписокВозврата.Добавить(Документы.СверкаВзаиморасчетов2_5_11.ПустаяСсылка(),
			Метаданные.Документы.СверкаВзаиморасчетов2_5_11.Представление());
			
	КонецЕсли;
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.СвязанныеКонтрагенты.
Процедура СвязанныеКонтрагенты(СсылкиНаОбъекты, СоответствиеКонтрагентов) Экспорт
	
	Для Каждого ПартнерСсылка Из СсылкиНаОбъекты Цикл
		Если ТипЗнч(ПартнерСсылка) = Тип("СправочникСсылка.Партнеры") Тогда
			КонтрагентПоУмолчанию = ПартнерыИКонтрагенты.ПолучитьКонтрагентаПартнераПоУмолчанию(ПартнерСсылка);
			СоответствиеКонтрагентов.Вставить(ПартнерСсылка, КонтрагентПоУмолчанию);
		КонецЕсли;
	КонецЦикла	 
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьПараметрыЭДПоИсточнику.
Процедура ЗаполнитьПараметрыЭДПоИсточнику(Источник, ПараметрыЭлектронногоДокумента) Экспорт
	
	Перем Тип, НаправлениеЭД, Организация, Контрагент;
	
	ТипыДокументов        = ОбменСКонтрагентами.ТипыДокументов();
	НаправленияДокументов = ОбменСКонтрагентами.НаправленияДокументов();
	
	УстановитьПривилегированныйРежим(Истина);
	
	Договор = Справочники.ДоговорыКонтрагентов.ПустаяСсылка();
	
	ТипИсточника = ТипЗнч(Источник);
	ЭтоСсылка = ОбщегоНазначения.ЭтоСсылка(ТипИсточника);
	СтрокаПараметров = ПараметрыЭлектронногоДокумента.Добавить();
	
	Если ТипИсточника = Тип("ДокументСсылка.РеализацияТоваровУслуг")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.РеализацияТоваровУслуг") Тогда
		
		Если (Источник.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияЧерезКомиссионера
			Или Источник.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности) Тогда
			Тип = ТипыДокументов.СведенияОРеализацииКомиссионером;
			НаправлениеЭД = НаправленияДокументов.Входящий;
		Иначе
			Если Источник.ВариантОформленияПродажи = Перечисления.ВариантыОформленияПродажи.АктНаПередачуПрав Тогда
				Тип = ТипыДокументов.АктНаПередачуПрав;
			Иначе			
				Тип = ТипыДокументов.ТоварнаяНакладная;
			КонецЕсли;
			НаправлениеЭД = НаправленияДокументов.Исходящий;
		КонецЕсли;
		
		Если Источник.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаНаКомиссию 
				Или Источник.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС Тогда
			СтрокаПараметров.ФормированиеУниверсальногоДокумента = 
				ОбменСКонтрагентами.ВариантыФормированияУниверсальныхДокументов().Запрещено;
		КонецЕсли;
		
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент, Договор");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент;
			Договор = ЗначенияРеквизитов.Договор;
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
			Договор = Источник.Договор;
		КонецЕсли;
		
		Если Не ПолучитьФункциональнуюОпцию("ИспользоватьСчетаНаОплатуКлиентам")
			И ФорматСчетНаОплату101ИспользуетсяВНастройках(Организация, Контрагент, Договор) Тогда
			НоваяСтрокаПараметров = ПараметрыЭлектронногоДокумента.Добавить();
			НоваяСтрокаПараметров.Направление = НаправленияДокументов.Исходящий;
			НоваяСтрокаПараметров.Тип = ТипыДокументов.СчетНаОплату;
			НоваяСтрокаПараметров.Организация = Организация;
			НоваяСтрокаПараметров.Контрагент = Контрагент;
			НоваяСтрокаПараметров.ДоговорКонтрагента = Договор;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.РеализацияУслугПрочихАктивов")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.РеализацияУслугПрочихАктивов") Тогда
		
		Тип = ТипыДокументов.ТоварнаяНакладная;
		НаправлениеЭД = НаправленияДокументов.Исходящий;
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент, Договор");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент;
			Договор = ЗначенияРеквизитов.Договор;
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
			Договор = Источник.Договор;
		КонецЕсли;
		
		Если Источник.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС Тогда
			СтрокаПараметров.ФормированиеУниверсальногоДокумента = 
				ОбменСКонтрагентами.ВариантыФормированияУниверсальныхДокументов().Запрещено;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.АктВыполненныхРабот")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.АктВыполненныхРабот") Тогда
		
		Тип = ТипыДокументов.АктВыполненныхРабот;
		НаправлениеЭД = НаправленияДокументов.Исходящий;
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент, Договор");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент;
			Договор = ЗначенияРеквизитов.Договор;
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
			Договор = Источник.Договор;
		КонецЕсли;
		
		Если Не ПолучитьФункциональнуюОпцию("ИспользоватьСчетаНаОплатуКлиентам")
			И ФорматСчетНаОплату101ИспользуетсяВНастройках(Организация, Контрагент, Договор) Тогда
			НоваяСтрокаПараметров = ПараметрыЭлектронногоДокумента.Добавить();
			НоваяСтрокаПараметров.Направление = НаправленияДокументов.Исходящий;
			НоваяСтрокаПараметров.Тип = ТипыДокументов.СчетНаОплату;
			НоваяСтрокаПараметров.Организация = Организация;
			НоваяСтрокаПараметров.Контрагент = Контрагент;
			НоваяСтрокаПараметров.ДоговорКонтрагента = Договор;
		КонецЕсли;
		
		Если Источник.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС Тогда
			СтрокаПараметров.ФормированиеУниверсальногоДокумента = 
				ОбменСКонтрагентами.ВариантыФормированияУниверсальныхДокументов().Запрещено;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.ПриобретениеТоваровУслуг")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ПриобретениеТоваровУслуг") Тогда
		
		Тип = ТипыДокументов.ТоварнаяНакладная;
		НаправлениеЭД = НаправленияДокументов.Входящий;
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент, Договор");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент;
			Договор = ЗначенияРеквизитов.Договор;
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
			Договор = Источник.Договор;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.ПриобретениеУслугПрочихАктивов")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ПриобретениеУслугПрочихАктивов") Тогда
		
		Тип = ТипыДокументов.АктВыполненныхРабот;	
		НаправлениеЭД = НаправленияДокументов.Входящий;
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент, Договор");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент;
			Договор = ЗначенияРеквизитов.Договор;
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
			Договор = Источник.Договор;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.ПередачаТоваровМеждуОрганизациями")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ПередачаТоваровМеждуОрганизациями") Тогда
			
		Тип = ТипыДокументов.ПередачаТоваровМеждуОрганизациями;
		НаправлениеЭД = НаправленияДокументов.Интеркампани;
		
		СписокРеквизитов = "Организация, ОрганизацияПолучатель, Договор,
				|ХозяйственнаяОперация, НалогообложениеНДС, РасчетыЧерезОтдельногоКонтрагента";
				
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, СписокРеквизитов);
		Иначе
			ЗначенияРеквизитов = Новый Структура(СписокРеквизитов);
			ЗаполнитьЗначенияСвойств(ЗначенияРеквизитов, Источник);
		КонецЕсли;
		
		Организация = ЗначенияРеквизитов.Организация;
		Контрагент = ЗначенияРеквизитов.ОрганизацияПолучатель;
		Договор = ЗначенияРеквизитов.Договор;
		ХозяйственнаяОперация = ЗначенияРеквизитов.ХозяйственнаяОперация;
		НалогообложениеНДС = ЗначенияРеквизитов.НалогообложениеНДС;
		РасчетыЧерезОтдельногоКонтрагента = ЗначенияРеквизитов.РасчетыЧерезОтдельногоКонтрагента;
		
		Если РасчетыЧерезОтдельногоКонтрагента <> Неопределено И Не РасчетыЧерезОтдельногоКонтрагента Тогда
			НоваяСтрокаПараметров = ПараметрыЭлектронногоДокумента.Добавить();
			НоваяСтрокаПараметров.Направление = НаправленияДокументов.Исходящий;
			НоваяСтрокаПараметров.Тип = ТипыДокументов.ТоварнаяНакладная;
			НоваяСтрокаПараметров.Организация = Организация;
			НоваяСтрокаПараметров.Контрагент = Контрагент;
			НоваяСтрокаПараметров.ДоговорКонтрагента = Договор;
			
			Если ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаНаКомиссиюВДругуюОрганизацию
					Или НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС Тогда
				НоваяСтрокаПараметров.ФормированиеУниверсальногоДокумента = 
					ОбменСКонтрагентами.ВариантыФормированияУниверсальныхДокументов().Запрещено;
			КонецЕсли;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.ВозвратТоваровМеждуОрганизациями")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ВозвратТоваровМеждуОрганизациями") Тогда
		
		Тип = ТипыДокументов.ВозвратТоваровМеждуОрганизациями;
		НаправлениеЭД = НаправленияДокументов.Интеркампани;
		
		СписокРеквизитов = "Организация, ОрганизацияПолучатель, Договор, РасчетыЧерезОтдельногоКонтрагента";
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, СписокРеквизитов);
		Иначе
			ЗначенияРеквизитов = Новый Структура(СписокРеквизитов);
			ЗаполнитьЗначенияСвойств(ЗначенияРеквизитов, Источник);
		КонецЕсли;
		
		Организация = ЗначенияРеквизитов.Организация;
		Контрагент = ЗначенияРеквизитов.ОрганизацияПолучатель;
		Договор = ЗначенияРеквизитов.Договор;
		РасчетыЧерезОтдельногоКонтрагента = ЗначенияРеквизитов.РасчетыЧерезОтдельногоКонтрагента;
		
		Если РасчетыЧерезОтдельногоКонтрагента <> Неопределено И Не РасчетыЧерезОтдельногоКонтрагента Тогда
			НоваяСтрокаПараметров = ПараметрыЭлектронногоДокумента.Добавить();
			НоваяСтрокаПараметров.Направление = НаправленияДокументов.Исходящий;
			НоваяСтрокаПараметров.Тип = ТипыДокументов.ТоварнаяНакладная;
			НоваяСтрокаПараметров.Организация = Организация;
			НоваяСтрокаПараметров.Контрагент = Контрагент;
			НоваяСтрокаПараметров.ДоговорКонтрагента = Договор;
			НоваяСтрокаПараметров.ФормированиеУниверсальногоДокумента = 
				ОбменСКонтрагентами.ВариантыФормированияУниверсальныхДокументов().Запрещено;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.ВозвратТоваровПоставщику")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ВозвратТоваровПоставщику") Тогда
		
		Тип = ТипыДокументов.ТоварнаяНакладная;
		НаправлениеЭД = НаправленияДокументов.Исходящий;
		СтрокаПараметров.ФормированиеУниверсальногоДокумента = ОбменСКонтрагентами.ВариантыФормированияУниверсальныхДокументов().Запрещено;
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент, Договор");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент;
			Договор = ЗначенияРеквизитов.Договор;
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
			Договор = Источник.Договор;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.ВозвратТоваровОтКлиента")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ВозвратТоваровОтКлиента") Тогда
		
		Тип = ТипыДокументов.ТоварнаяНакладная;
		НаправлениеЭД = НаправленияДокументов.Входящий;
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент, Договор");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент;
			Договор = ЗначенияРеквизитов.Договор;
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
			Договор = Источник.Договор;
		КонецЕсли; 		
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.СчетФактураВыданный")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.СчетФактураВыданный") Тогда
		
		Если ЭтоКорректировочныйДокумент(Источник) Тогда
			Тип = ТипыДокументов.КорректировочныйСчетФактура;
		Иначе
			Тип = ТипыДокументов.СчетФактура;
		КонецЕсли;
		
		НаправлениеЭД = НаправленияДокументов.Исходящий;
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент, ДокументОснование, НалогообложениеНДС");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент  = ЗначенияРеквизитов.Контрагент;
			ДокументОснование = ЗначенияРеквизитов.ДокументОснование;
			ИсточникНалогообложениеНДС = ЗначенияРеквизитов.НалогообложениеНДС;
		Иначе
			Организация = Источник.Организация;
			Контрагент  = Источник.Контрагент;
			ДокументОснование = Источник.ДокументОснование;
			ИсточникНалогообложениеНДС = Источник.НалогообложениеНДС; 
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ДокументОснование)
			И ОбщегоНазначения.ЕстьРеквизитОбъекта("Договор", ДокументОснование.Метаданные()) Тогда
			
			Договор = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОснование, "Договор");
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ДокументОснование)
			И ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.ВозвратТоваровМеждуОрганизациями") Тогда
			СтрокаПараметров.ФормированиеУниверсальногоДокумента = ОбменСКонтрагентами.ВариантыФормированияУниверсальныхДокументов().Запрещено;
		КонецЕсли;
		Если ИсточникНалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС Тогда
			СтрокаПараметров.ФормированиеУниверсальногоДокумента = 	ОбменСКонтрагентами.ВариантыФормированияУниверсальныхДокументов().Запрещено;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.СчетФактураКомиссионеру")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.СчетФактураКомиссионеру") Тогда
		
		Тип = ТипыДокументов.СчетФактура;
		
		НаправлениеЭД = НаправленияДокументов.Исходящий;
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Комиссионер, ДокументОснование");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент  = ЗначенияРеквизитов.Комиссионер;
			ДокументОснование = ЗначенияРеквизитов.ДокументОснование;
		Иначе
			Организация = Источник.Организация;
			Контрагент  = Источник.Комиссионер;
			ДокументОснование = Источник.ДокументОснование;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ДокументОснование)
			И ОбщегоНазначения.ЕстьРеквизитОбъекта("Договор", ДокументОснование.Метаданные()) Тогда
			Договор = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОснование, "Договор");
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.СчетФактураВыданныйАванс")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.СчетФактураВыданныйАванс") Тогда
		
		Тип = ТипыДокументов.СчетФактура;
		НаправлениеЭД = НаправленияДокументов.Исходящий;
		СтрокаПараметров.ФормированиеУниверсальногоДокумента = ОбменСКонтрагентами.ВариантыФормированияУниверсальныхДокументов().Запрещено;
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент  = ЗначенияРеквизитов.Контрагент;
		Иначе
			Организация = Источник.Организация;
			Контрагент  = Источник.Контрагент;
		КонецЕсли;

	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.СчетФактураПолученный")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.СчетФактураПолученный") Тогда
		
		Если ЭтоКорректировочныйДокумент(Источник) Тогда
			Тип = ТипыДокументов.КорректировочныйСчетФактура;
		Иначе
			Тип = ТипыДокументов.СчетФактура;
		КонецЕсли;
		НаправлениеЭД = НаправленияДокументов.Входящий;
		
		Если ЭтоСсылка Тогда
			
			Запрос = Новый Запрос;
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	СчетФактураПолученный.Организация КАК Организация
			|ИЗ
			|	Документ.СчетФактураПолученный КАК СчетФактураПолученный
			|ГДЕ
			|	СчетФактураПолученный.Ссылка = &Источник
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	СчетФактураПолученныйДокументыОснования.ДокументОснование КАК ДокументОснование
			|ИЗ
			|	Документ.СчетФактураПолученный.ДокументыОснования КАК СчетФактураПолученныйДокументыОснования
			|ГДЕ
			|	СчетФактураПолученныйДокументыОснования.Ссылка = &Источник";
			Запрос.УстановитьПараметр("Источник", Источник);
			РезультатыЗапроса = Запрос.ВыполнитьПакет();
			Реквизиты = РезультатыЗапроса[0].Выбрать();
			Реквизиты.Следующий();
			
			Организация = Реквизиты.Организация;
			ДокументыОснования = РезультатыЗапроса[1].Выгрузить();
		Иначе
			Организация = Источник.Организация;
			ДокументыОснования = Источник.ДокументыОснования;
		КонецЕсли;
		
		Для Каждого Строка Из ДокументыОснования Цикл
			Если ЗначениеЗаполнено(Строка.ДокументОснование) Тогда
				
				РеквизитыОснования = Новый Структура("Контрагент");
				Если Строка.ДокументОснование.Метаданные().Реквизиты.Найти("Договор") <> Неопределено Тогда
					РеквизитыОснования.Вставить("Договор");
				КонецЕсли;
				ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Строка.ДокументОснование, РеквизитыОснования);
				Контрагент = ЗначенияРеквизитов.Контрагент;
				Если ЗначенияРеквизитов.Свойство("Договор") Тогда
					Договор = ЗначенияРеквизитов.Договор;
				КонецЕсли;
				
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.СчетФактураПолученныйНалоговыйАгент")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.СчетФактураПолученныйНалоговыйАгент") Тогда
		
		Если ЭтоКорректировочныйДокумент(Источник) Тогда
			Тип = ТипыДокументов.КорректировочныйСчетФактура;
		Иначе
			Тип = ТипыДокументов.СчетФактура;
		КонецЕсли;
		НаправлениеЭД = НаправленияДокументов.Входящий;
		
		Если ЭтоСсылка Тогда
			
			Запрос = Новый Запрос;
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	СчетФактураПолученный.Организация КАК Организация
			|ИЗ
			|	Документ.СчетФактураПолученныйНалоговыйАгент КАК СчетФактураПолученный
			|ГДЕ
			|	СчетФактураПолученный.Ссылка = &Источник
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	СчетФактураПолученныйДокументыОснования.ДокументОснование КАК ДокументОснование
			|ИЗ
			|	Документ.СчетФактураПолученныйНалоговыйАгент.ДокументыОснования КАК СчетФактураПолученныйДокументыОснования
			|ГДЕ
			|	СчетФактураПолученныйДокументыОснования.Ссылка = &Источник";
			Запрос.УстановитьПараметр("Источник", Источник);
			РезультатыЗапроса = Запрос.ВыполнитьПакет();
			Реквизиты = РезультатыЗапроса[0].Выбрать();
			Реквизиты.Следующий();
			
			Организация = Реквизиты.Организация;
			ДокументыОснования = РезультатыЗапроса[1].Выгрузить();
		Иначе
			Организация = Источник.Организация;
			ДокументыОснования = Источник.ДокументыОснования;
		КонецЕсли;
		
		Для Каждого Строка Из ДокументыОснования Цикл
			Если ЗначениеЗаполнено(Строка.ДокументОснование) Тогда
				
				РеквизитыОснования = Новый Структура("Контрагент");
				Если Строка.ДокументОснование.Метаданные().Реквизиты.Найти("Договор") <> Неопределено Тогда
					РеквизитыОснования.Вставить("Договор");
				КонецЕсли;
				ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Строка.ДокументОснование, РеквизитыОснования);
				Контрагент = ЗначенияРеквизитов.Контрагент;
				Если ЗначенияРеквизитов.Свойство("Договор") Тогда
					Договор = ЗначенияРеквизитов.Договор;
				КонецЕсли;
				
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.СчетФактураКомитента")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.СчетФактураКомитента") Тогда
		
		Тип = ТипыДокументов.СчетФактура;
		НаправлениеЭД = НаправленияДокументов.Входящий;
		
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Комитент");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент  = ЗначенияРеквизитов.Комитент;
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Комитент;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.СчетФактураПолученныйАванс")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.СчетФактураПолученныйАванс") Тогда
		
		Тип = ТипыДокументов.СчетФактура;
		НаправлениеЭД = НаправленияДокументов.Входящий;
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент  = ЗначенияРеквизитов.Контрагент;
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
		КонецЕсли;
	
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.ЗаказПоставщику")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ЗаказПоставщику") Тогда
		
		Тип = ТипыДокументов.ЗаказТовара;
		НаправлениеЭД = НаправленияДокументов.Исходящий;
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент, Договор");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент;
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.ЗаказКлиента")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ЗаказКлиента") Тогда
		
		Тип = ТипыДокументов.ОтветНаЗаказ;
		НаправлениеЭД = НаправленияДокументов.Исходящий;
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент, Договор");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент;
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
		КонецЕсли;
		
		Если Не ПолучитьФункциональнуюОпцию("ИспользоватьСчетаНаОплатуКлиентам")
			И ФорматСчетНаОплату101ИспользуетсяВНастройках(Организация, Контрагент, Договор) Тогда
			НоваяСтрокаПараметров = ПараметрыЭлектронногоДокумента.Добавить();
			НоваяСтрокаПараметров.Направление = НаправленияДокументов.Исходящий;
			НоваяСтрокаПараметров.Тип = ТипыДокументов.СчетНаОплату;
			НоваяСтрокаПараметров.Организация = Организация;
			НоваяСтрокаПараметров.Контрагент = Контрагент;
			НоваяСтрокаПараметров.ДоговорКонтрагента = Договор;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.СчетНаОплатуКлиенту")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.СчетНаОплатуКлиенту") Тогда
		
		Тип = ТипыДокументов.СчетНаОплату;
		НаправлениеЭД = НаправленияДокументов.Исходящий;
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент; 
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.ЗаявкаНаРасходованиеДенежныхСредств")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ЗаявкаНаРасходованиеДенежныхСредств") Тогда
		
		Тип = ТипыДокументов.СчетНаОплату;
		НаправлениеЭД = НаправленияДокументов.Входящий;
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент;
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.РегистрацияЦенНоменклатурыПоставщика")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.РегистрацияЦенНоменклатурыПоставщика") Тогда
		
		Тип = ТипыДокументов.ПрайсЛист;
		НаправлениеЭД = НаправленияДокументов.Входящий;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.КоммерческоеПредложениеКлиенту")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.КоммерческоеПредложениеКлиенту") Тогда
		
		Тип = ТипыДокументов.ПрайсЛист;
		НаправлениеЭД = НаправленияДокументов.Исходящий;
		Если ЭтоСсылка Тогда
			Реквизиты = Новый Структура("Организация, Контрагент", "Организация", "Соглашение.Контрагент");
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, Реквизиты);
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент;
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.КоммерческоеПредложениеПоставщика")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.КоммерческоеПредложениеПоставщика") Тогда
		
		Тип = ТипыДокументов.КоммерческоеПредложение;
		НаправлениеЭД = НаправленияДокументов.Входящий;
		Если ЭтоСсылка Тогда
			Реквизиты = Новый Структура("Организация, Контрагент");
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, Реквизиты);
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент;
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.ОтчетКомитенту")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ОтчетКомитенту") Тогда
		
		Если ЗначениеЗаполнено(Источник.ДокументПродажи) Тогда
			Тип = ТипыДокументов.СведенияОРеализацииКомиссионером;
		Иначе
			Тип = ТипыДокументов.ОтчетОПродажахКомиссионногоТовара;
		КонецЕсли;

		НаправлениеЭД = НаправленияДокументов.Исходящий;
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент, Договор");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент;
			Договор = ЗначенияРеквизитов.Договор;
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
			Договор = Источник.Договор;
		КонецЕсли;
		
		Если Не Источник.СпособРасчетаВознаграждения = Перечисления.СпособыРасчетаКомиссионногоВознаграждения.НеРассчитывается Тогда
			НоваяСтрокаПараметров = ПараметрыЭлектронногоДокумента.Добавить();
			НоваяСтрокаПараметров.Направление = НаправленияДокументов.Исходящий;
			НоваяСтрокаПараметров.Тип = ТипыДокументов.ТоварнаяНакладная;
			НоваяСтрокаПараметров.Организация = Организация;
			НоваяСтрокаПараметров.Контрагент = Контрагент;
			НоваяСтрокаПараметров.ДоговорКонтрагента = Договор;
		КонецЕсли;
		
		Если Не ПолучитьФункциональнуюОпцию("ИспользоватьСчетаНаОплатуКлиентам")
			И ФорматСчетНаОплату101ИспользуетсяВНастройках(Организация, Контрагент, Договор) Тогда
			НоваяСтрокаПараметров = ПараметрыЭлектронногоДокумента.Добавить();
			НоваяСтрокаПараметров.Направление = НаправленияДокументов.Исходящий;
			НоваяСтрокаПараметров.Тип = ТипыДокументов.СчетНаОплату;
			НоваяСтрокаПараметров.Организация = Организация;
			НоваяСтрокаПараметров.Контрагент = Контрагент;
			НоваяСтрокаПараметров.ДоговорКонтрагента = Договор;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.ОтчетКомитентуОЗакупках")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ОтчетКомитентуОЗакупках") Тогда
		
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент, Договор");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент;
			Договор = ЗначенияРеквизитов.Договор;
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
			Договор = Источник.Договор;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Источник.ДокументПриобретения) Тогда
			
			Тип = ТипыДокументов.СведенияОЗакупкеКомиссионером;
			НаправлениеЭД = НаправленияДокументов.Исходящий;
			
			Если Не Источник.СпособРасчетаВознаграждения = Перечисления.СпособыРасчетаКомиссионногоВознаграждения.НеРассчитывается Тогда
				НоваяСтрокаПараметров = ПараметрыЭлектронногоДокумента.Добавить();
				НоваяСтрокаПараметров.Направление = НаправленияДокументов.Исходящий;
				НоваяСтрокаПараметров.Тип = ТипыДокументов.ТоварнаяНакладная;
				НоваяСтрокаПараметров.Организация = Организация;
				НоваяСтрокаПараметров.Контрагент = Контрагент;
				НоваяСтрокаПараметров.ДоговорКонтрагента = Договор;
			КонецЕсли;
			
		ИначеЕсли Не Источник.СпособРасчетаВознаграждения = Перечисления.СпособыРасчетаКомиссионногоВознаграждения.НеРассчитывается Тогда
			
			НаправлениеЭД = НаправленияДокументов.Исходящий;
			Тип = ТипыДокументов.ТоварнаяНакладная;
			
		Иначе
			
			Тип = ТипыДокументов.СведенияОЗакупкеКомиссионером;
			НаправлениеЭД = НаправленияДокументов.Внутренний;
			
		КонецЕсли;
		
		Если Не ПолучитьФункциональнуюОпцию("ИспользоватьСчетаНаОплатуКлиентам")
			И ФорматСчетНаОплату101ИспользуетсяВНастройках(Организация, Контрагент, Договор) Тогда
			НоваяСтрокаПараметров = ПараметрыЭлектронногоДокумента.Добавить();
			НоваяСтрокаПараметров.Направление = НаправленияДокументов.Исходящий;
			НоваяСтрокаПараметров.Тип = ТипыДокументов.СчетНаОплату;
			НоваяСтрокаПараметров.Организация = Организация;
			НоваяСтрокаПараметров.Контрагент = Контрагент;
			НоваяСтрокаПараметров.ДоговорКонтрагента = Договор;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.ОтчетКомиссионера")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ОтчетКомиссионера") Тогда
		
		Тип = ТипыДокументов.ОтчетОПродажахКомиссионногоТовара;
		НаправлениеЭД = НаправленияДокументов.Входящий;
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент, Договор");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент;
			Договор = ЗначенияРеквизитов.Договор;
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
			Договор = Источник.Договор;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.ОтчетКомитентуОСписании")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ОтчетКомитентуОСписании") Тогда
		
		Тип = ТипыДокументов.ОтчетОСписанииКомиссионногоТовара;
		НаправлениеЭД = НаправленияДокументов.Исходящий;
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент, Договор");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент;
			Договор = ЗначенияРеквизитов.Договор;
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
			Договор = Источник.Договор;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.ОтчетКомиссионераОСписании")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ОтчетКомиссионераОСписании") Тогда
		
		Тип = ТипыДокументов.ОтчетОСписанииКомиссионногоТовара;
		НаправлениеЭД = НаправленияДокументов.Входящий;
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент, Договор");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент;
			Договор = ЗначенияРеквизитов.Договор;
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
			Договор = Источник.Договор;
		КонецЕсли; 		
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.КорректировкаРеализации")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.КорректировкаРеализации") Тогда
		
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, 
				"ВидКорректировки, Организация, Контрагент, Договор");
			ХозяйственнаяОперация = ЗначенияРеквизитов.ВидКорректировки;
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент;
			Договор = ЗначенияРеквизитов.Договор;
		Иначе
			ХозяйственнаяОперация = Источник.ВидКорректировки;
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
			Договор = Источник.Договор;
		КонецЕсли;
		
		Если ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон Тогда
			Тип = ТипыДокументов.СоглашениеОбИзмененииСтоимости;
			НаправлениеЭД = НаправленияДокументов.Исходящий;
		ИначеЕсли ЗначениеЗаполнено(Источник.ДокументОснование) Тогда
			Если ТипЗнч(Источник.ДокументОснование) = Тип("ДокументСсылка.АктВыполненныхРабот") Тогда
				Тип = ТипыДокументов.АктВыполненныхРабот;
				НаправлениеЭД = НаправленияДокументов.Исходящий;
			ИначеЕсли ТипЗнч(Источник.ДокументОснование) = Тип("ДокументСсылка.РеализацияТоваровУслуг") 
					И Источник.ВариантОформленияПродажи = Перечисления.ВариантыОформленияПродажи.АктНаПередачуПрав Тогда
			Тип = ТипыДокументов.АктНаПередачуПрав;
			НаправлениеЭД = НаправленияДокументов.Исходящий;
			ИначеЕсли ТипЗнч(Источник.ДокументОснование) = Тип("ДокументСсылка.РеализацияТоваровУслуг") 
					Или ТипЗнч(Источник.ДокументОснование) = Тип("ДокументСсылка.РеализацияУслугПрочихАктивов") Тогда
			Тип = ТипыДокументов.ТоварнаяНакладная;
			НаправлениеЭД = НаправленияДокументов.Исходящий;
			ИначеЕсли ТипЗнч(Источник.ДокументОснование) = Тип("ДокументСсылка.ПервичныйДокумент") Тогда
				Тип = ТипыДокументов.ТоварнаяНакладная;
				НаправлениеЭД = НаправленияДокументов.Исходящий;
			Иначе
				Тип = ТипыДокументов.Внутренний;
				НаправлениеЭД = НаправленияДокументов.Внутренний;
			КонецЕсли;
		Иначе
			Тип = ТипыДокументов.ТоварнаяНакладная;
			НаправлениеЭД = НаправленияДокументов.Исходящий;
		КонецЕсли;
		
		Если Источник.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС Тогда
			СтрокаПараметров.ФормированиеУниверсальногоДокумента = 
				ОбменСКонтрагентами.ВариантыФормированияУниверсальныхДокументов().Запрещено;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.КорректировкаПриобретения")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.КорректировкаПриобретения") Тогда
		
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, 
				"ВидКорректировки, Организация, Контрагент, Договор");
			ХозяйственнаяОперация = ЗначенияРеквизитов.ВидКорректировки;			
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент;
			Договор = ЗначенияРеквизитов.Договор;
		Иначе
			ХозяйственнаяОперация = Источник.ВидКорректировки;			
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
			Договор = Источник.Договор;
		КонецЕсли;
		
		Если ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон Тогда
			Тип = ТипыДокументов.СоглашениеОбИзмененииСтоимости;
			НаправлениеЭД = НаправленияДокументов.Входящий;
		ИначеЕсли ЗначениеЗаполнено(Источник.ДокументОснование) Тогда
			Если ТипЗнч(Источник.ДокументОснование) = Тип("ДокументСсылка.ПриобретениеУслугПрочихАктивов") Тогда
				Тип = ТипыДокументов.АктВыполненныхРабот;
				НаправлениеЭД = НаправленияДокументов.Входящий;
			ИначеЕсли ТипЗнч(Источник.ДокументОснование) = Тип("ДокументСсылка.ПриобретениеТоваровУслуг") Тогда
				Тип = ТипыДокументов.ТоварнаяНакладная;
				НаправлениеЭД = НаправленияДокументов.Входящий;
			ИначеЕсли ТипЗнч(Источник.ДокументОснование) = Тип("ДокументСсылка.ПервичныйДокумент") Тогда
				Тип = ТипыДокументов.ТоварнаяНакладная;
				НаправлениеЭД = НаправленияДокументов.Входящий;
			КонецЕсли;
		Иначе
			Тип = ТипыДокументов.ТоварнаяНакладная;
			НаправлениеЭД = НаправленияДокументов.Входящий;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.АктОРасхожденияхПослеПриемки")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.АктОРасхожденияхПослеПриемки") Тогда
		
		Тип = ТипыДокументов.АктОРасхождениях;
		НаправлениеЭД = НаправленияДокументов.Исходящий;
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент, Договор");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент;
			Договор = ЗначенияРеквизитов.Договор;
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
			Договор = Источник.Договор;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.АктОРасхожденияхПослеОтгрузки")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.АктОРасхожденияхПослеОтгрузки") Тогда
		
		Тип = ТипыДокументов.АктОРасхождениях;
		НаправлениеЭД = НаправленияДокументов.Входящий;
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент, Договор");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент;
			Договор = ЗначенияРеквизитов.Договор;
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
			Договор = Источник.Договор;
		КонецЕсли;
	
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.ВыкупТоваровХранителем")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ВыкупТоваровХранителем") Тогда
		
		Тип = ТипыДокументов.ТоварнаяНакладная;
		НаправлениеЭД = НаправленияДокументов.Исходящий;
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент, Договор");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент;
			Договор = ЗначенияРеквизитов.Договор;
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
			Договор = Источник.Договор;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.СверкаВзаиморасчетов2_5_11")
		Или ТипИсточника = Тип("ДокументОбъект.СверкаВзаиморасчетов2_5_11") Тогда
		
		Тип				= ТипыДокументов.АктСверкиВзаиморасчетов;
		НаправлениеЭД	= НаправленияДокументов.Исходящий;
		
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент, Договор");
			
			Организация	= ЗначенияРеквизитов.Организация;
			Контрагент	= ЗначенияРеквизитов.Контрагент;
			Договор		= ЗначенияРеквизитов.Договор;
		Иначе
			Организация	= Источник.Организация;
			Контрагент	= Источник.Контрагент;
			Договор		= Источник.Договор;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("СправочникСсылка.ДоговорыКонтрагентов")
		ИЛИ ТипИсточника = Тип("СправочникОбъект.ДоговорыКонтрагентов") Тогда
		
		Тип = ТипыДокументов.ДоговорныйДокумент;
		НаправлениеЭД = НаправленияДокументов.Исходящий;
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Контрагент, Ссылка");
			Организация = ЗначенияРеквизитов.Организация;
			Контрагент = ЗначенияРеквизитов.Контрагент;
			Договор = ЗначенияРеквизитов.Ссылка;
		Иначе
			Организация = Источник.Организация;
			Контрагент = Источник.Контрагент;
			Договор = Источник.Ссылка;
		КонецЕсли;
		
	ИначеЕсли ТипИсточника = Тип("ДокументСсылка.АвансовыйОтчет")
		ИЛИ ТипИсточника = Тип("ДокументСсылка.ИнвентаризационнаяОпись")
		ИЛИ ТипИсточника = Тип("ДокументСсылка.ОприходованиеИзлишковТоваров")
		ИЛИ ТипИсточника = Тип("ДокументСсылка.ВнутреннееПотребление")
		ИЛИ ТипИсточника = Тип("ДокументСсылка.ПеремещениеТоваров")
		ИЛИ ТипИсточника = Тип("ДокументСсылка.ПересортицаТоваров")
		ИЛИ ТипИсточника = Тип("ДокументСсылка.СписаниеНедостачТоваров")
		ИЛИ ТипИсточника = Тип("ДокументСсылка.ЛистКассовойКниги")
		ИЛИ ТипИсточника = Тип("ДокументСсылка.ПриходныйКассовыйОрдер")
		ИЛИ ТипИсточника = Тип("ДокументСсылка.РасходныйКассовыйОрдер")
		ИЛИ ТипИсточника = Тип("ДокументСсылка.ДоверенностьВыданная")
		ИЛИ ТипИсточника = Тип("ДокументСсылка.ИнвентаризацияНаличныхДенежныхСредств")
		ИЛИ ТипИсточника = Тип("ДокументСсылка.ПоступлениеТоваровНаСклад")
		ИЛИ ТипИсточника = Тип("ДокументСсылка.ПоступлениеУслугВПодразделение")
		ИЛИ ТипИсточника = Тип("ДокументСсылка.СборкаТоваров")
		ИЛИ ТипИсточника = Тип("ДокументСсылка.ПриемкаТоваровНаХранение")
		ИЛИ ТипИсточника = Тип("ДокументСсылка.СверкаВзаиморасчетов2_4")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.АвансовыйОтчет")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ИнвентаризационнаяОпись")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ОприходованиеИзлишковТоваров")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ВнутреннееПотребление")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ПеремещениеТоваров")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ПересортицаТоваров")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.СписаниеНедостачТоваров")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ЛистКассовойКниги")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ПриходныйКассовыйОрдер")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.РасходныйКассовыйОрдер")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ДоверенностьВыданная")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ИнвентаризацияНаличныхДенежныхСредств")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ПоступлениеТоваровНаСклад")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.СборкаТоваров")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.ПриемкаТоваровНаХранение")
		ИЛИ ТипИсточника = Тип("ДокументОбъект.СверкаВзаиморасчетов2_4")
		Тогда
		
		Реквизиты = "Организация";
		
		Если ЭтоСсылка Тогда
			ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, Реквизиты);
		Иначе
			ЗначенияРеквизитов = Новый Структура(Реквизиты);
			ЗаполнитьЗначенияСвойств(ЗначенияРеквизитов, Источник);
		КонецЕсли;
		
		Тип = ТипыДокументов.Внутренний;
		НаправлениеЭД = НаправленияДокументов.Внутренний;
		Организация   = ЗначенияРеквизитов.Организация;
		
	КонецЕсли;
	
	СтрокаПараметров.Тип = Тип;
	СтрокаПараметров.Направление = НаправлениеЭД;
	СтрокаПараметров.Организация = Организация;
	СтрокаПараметров.Контрагент  = Контрагент;
	СтрокаПараметров.ДоговорКонтрагента = Договор;

КонецПроцедуры

// Находит ссылку на справочник по переданному реквизиту.
//
// Параметры:
//  ИмяСправочника - Строка - имя справочника, объект которого надо найти,
//  ИмяРеквизита - Строка - имя реквизита, по которому будет проведен поиск,
//  ЗначРеквизита - Строка, СправочникСсылка - значение реквизита, по которому будет проведен поиск,
//  Владелец - СправочникСсылка - на владельца для поиска в иерархическом справочнике.
// 
// Возвращаемое значение:
//  - СправочникСсылка - найденное значение
//
Функция НайтиСсылкуНаОбъектПоРеквизиту(ИмяСправочника, ИмяРеквизита, ЗначРеквизита, Владелец = Неопределено) Экспорт
	
	Результат = Неопределено;
	
	ОбъектМетаданных = Метаданные.Справочники[ИмяСправочника];
	Если НЕ ОбщегоНазначения.ЭтоСтандартныйРеквизит(ОбъектМетаданных.СтандартныеРеквизиты, ИмяРеквизита) // нестандартный реквизит
		И НЕ ОбъектМетаданных.Реквизиты.Найти(ИмяРеквизита)<> Неопределено Тогда // другой реквизит
		Возврат Неопределено;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ИскСправочник.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник."+ИмяСправочника+" КАК ИскСправочник
	|ГДЕ
	|	ИскСправочник."+ИмяРеквизита+" = &ЗначРеквизита";
	
	Если ЗначениеЗаполнено(Владелец) Тогда
		Запрос.Текст = Запрос.Текст + " И ИскСправочник.Владелец = &Владелец";
		Запрос.УстановитьПараметр("Владелец", 	Владелец);
	КонецЕсли;
	Если ИмяСправочника = "КлассификаторБанков" Тогда
		Запрос.Текст = Запрос.Текст + " И ИскСправочник.ДеятельностьПрекращена = Ложь";
	КонецЕсли;
	Запрос.УстановитьПараметр("ЗначРеквизита", ЗначРеквизита);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Результат = Выборка.Ссылка;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// См. ОбменСКонтрагентамиПереопределяемый.ПослеФормированияЭлектронногоДокумента.
Процедура ПослеФормированияЭлектронногоДокумента(ЭлектронныйДокумент) Экспорт
	
	//++ Локализация
	Если ПолучитьФункциональнуюОпцию("ВестиУчетМаркируемойПродукцииИСМП")
			И ТипЗнч(ЭлектронныйДокумент) = Тип("ДокументСсылка.ЭлектронныйДокументИсходящийЭДО") Тогда
		ОбъектыУчета = ОбменСКонтрагентами.СведенияОбЭлектронномДокументе(ЭлектронныйДокумент).ОбъектыУчета;
		ДокументыПоТипам = Новый Соответствие;
		Для Каждого ДокументОснование Из ОбъектыУчета Цикл
			ТипОснования = ТипЗнч(ДокументОснование);
			Элемент = ДокументыПоТипам.Получить(ТипОснования);
			Если Элемент = Неопределено Тогда
				Элемент = Новый Массив;
			КонецЕсли;
			Элемент.Добавить(ДокументОснование);
			ДокументыПоТипам.Вставить(ТипОснования, Элемент);
		КонецЦикла;
		
		СчетаФактуры = ДокументыПоТипам.Получить(Тип("ДокументСсылка.СчетФактураВыданный"));
		Если СчетаФактуры<>Неопределено Тогда
			Запрос = Новый Запрос;
			Запрос.УстановитьПараметр("Ссылка", СчетаФактуры);
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	СчетФактураВыданныйДокументыОснования.ДокументОснование КАК ДокументОснование
			|ИЗ
			|	Документ.СчетФактураВыданный.ДокументыОснования КАК СчетФактураВыданныйДокументыОснования
			|ГДЕ
			|	СчетФактураВыданныйДокументыОснования.Ссылка В(&Ссылка)";
			Выборка = Запрос.Выполнить().Выбрать();
			Пока Выборка.Следующий() Цикл
				ТипОснования = ТипЗнч(Выборка.ДокументОснование);
				Элемент = ДокументыПоТипам.Получить(ТипОснования);
				Если Элемент = Неопределено Тогда
					Элемент = Новый Массив;
				КонецЕсли;
				Элемент.Добавить(Выборка.ДокументОснование);
				ДокументыПоТипам.Вставить(ТипОснования, Элемент);
			КонецЦикла;
		КонецЕсли;
		
		ТипыКПроверке = Новый Массив;
		ОбщегоНазначенияКлиентСервер.ДополнитьМассив(ТипыКПроверке, Метаданные.ОпределяемыеТипы.ОснованиеОтгрузкаТоваровИСМП.Тип.Типы());
		ОбщегоНазначенияКлиентСервер.ДополнитьМассив(ТипыКПроверке, Метаданные.ОпределяемыеТипы.ОснованиеВыводаИзОборотаИСМП.Тип.Типы());
		
		Для Каждого Тип Из ТипыКПроверке Цикл
			ДокументыТипа = ДокументыПоТипам.Получить(Тип);
			Если ДокументыТипа<>Неопределено Тогда
				РасчетСтатусовОформленияИСМП.РассчитатьСтатусыОформленияДокументов(ДокументыТипа);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	СоответствиеТребованиямГИСМТ.ПослеФормированияЭлектронногоДокумента(ЭлектронныйДокумент);
	//-- Локализация
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ПослеЗавершенияОбменаЭлектроннымДокументом.
Процедура ПослеЗавершенияОбменаЭлектроннымДокументом(ЭлектронныйДокумент) Экспорт
	
	
	//++ Локализация
	СоответствиеТребованиямГИСМТ.ПослеЗавершенияОбменаЭлектроннымДокументом(ЭлектронныйДокумент);
	//-- Локализация
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ПослеАннулированияЭлектронногоДокумента.
Процедура ПослеАннулированияЭлектронногоДокумента(ЭлектронныйДокумент) Экспорт
	
	//++ Локализация
	СоответствиеТребованиямГИСМТ.ПослеАннулированияЭлектронногоДокумента(ЭлектронныйДокумент);
	//-- Локализация
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ПослеИзмененияОтраженияВУчете.
Процедура ПослеИзмененияОтраженияВУчете(ЭлектронныйДокумент, ДобавленныеОбъектыУчета, УдаленныеОбъектыУчета) Экспорт
	
	//++ Локализация
	СоответствиеТребованиямГИСМТ.ПослеИзмененияОтраженияВУчете(ЭлектронныйДокумент, ДобавленныеОбъектыУчета, УдаленныеОбъектыУчета);
	//-- Локализация
	
КонецПроцедуры

Функция НайтиСсылкуНаНоменклатуруПоИдентификаторуНоменклатурыПоставщика(Идентификатор) Экспорт
	
	Результат = Неопределено;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
	               |	СпрНоменклатура.Номенклатура КАК Ссылка
	               |ИЗ
	               |	Справочник.НоменклатураКонтрагентов КАК СпрНоменклатура
	               |ГДЕ
	               |	СпрНоменклатура.Идентификатор = &Идентификатор";
	
	Запрос.УстановитьПараметр("Идентификатор", Идентификатор);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Результат = Выборка.Ссылка;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Функция ДоговорКонтрагентаПоРеквизитам(РеквизитыДоговора) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
	|	ДоговорыКонтрагентов.Ссылка КАК Договор
	|ИЗ
	|	Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
	|ГДЕ
	|	ДоговорыКонтрагентов.Номер = &НомерДоговора
	|	И ДоговорыКонтрагентов.Дата = &ДатаДоговора
	|	И ДоговорыКонтрагентов.Контрагент = &Владелец
	|	И ДоговорыКонтрагентов.КомиссионныеПродажи25 = &КомиссионныеПродажи25";
	Запрос.УстановитьПараметр("НомерДоговора", РеквизитыДоговора.НомерДоговора);
	Запрос.УстановитьПараметр("ДатаДоговора", РеквизитыДоговора.ДатаДоговора);
	Запрос.УстановитьПараметр("Владелец", РеквизитыДоговора.Владелец);
	
	КомиссионныеПродажи25 = Ложь;
	Если РеквизитыДоговора.Свойство("КомиссионныеПродажи25") Тогда
		КомиссионныеПродажи25 = РеквизитыДоговора.КомиссионныеПродажи25;
	КонецЕсли;
	Запрос.УстановитьПараметр("КомиссионныеПродажи25", КомиссионныеПродажи25);
	
	
	Выборка = Запрос.Выполнить().Выбрать();
	Выборка.Следующий();
	
	Возврат Выборка.Договор;
	
КонецФункции

Процедура УдалитьДокументыНеподходящиеДляФормированияЭД(МассивДокументов, МассивДокументовДляУдаления, ШаблонСообщения) Экспорт
	
	Для Каждого Документ Из МассивДокументовДляУдаления Цикл
		Найденный = МассивДокументов.Найти(Документ);
		Если Найденный <> Неопределено Тогда
			МассивДокументов.Удалить(Найденный);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
				СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения, Строка(Документ)), 
				Документ);
		КонецЕсли;
		
	КонецЦикла
	
КонецПроцедуры

// Находит ссылку на номенклатуру БД по переданной номенклатуре контрагента.
//
// Параметры:
//  НоменклатураКонтрагента - СправочникСсылка.НоменклатураКонтрагентов - идентификатор номенклатуры поставщика
//
// Возвращаемое значение:
//  СправочникСсылка.Номенклатура - ссылка на элемент справочника.
//
Функция НайтиСсылкуНаНоменклатуруПоНоменклатуреПоставщика(НоменклатураКонтрагента) Экспорт
	
	Результат = Неопределено;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СпрНоменклатура.Номенклатура КАК Ссылка
	|ИЗ
	|	Справочник.НоменклатураКонтрагентов КАК СпрНоменклатура
	|ГДЕ
	|	СпрНоменклатура.Ссылка = &НоменклатураКонтрагента";
	
	Запрос.УстановитьПараметр("НоменклатураКонтрагента", НоменклатураКонтрагента);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Результат = Выборка.Ссылка;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Процедура ЗаполнитьДанныеУчастника(ДеревоДанных, СведенияОбУчастнике, ВидУчастника, ВидАдреса = "Юр", ДатаКИ = Неопределено) Экспорт
	
	Если СведенияОбУчастнике.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ЮрЛицо
		Или СведенияОбУчастнике.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ЮрЛицоНеРезидент Тогда
		 
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН", СведенияОбУчастнике.ИНН);
			
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП", СведенияОбУчастнике.КПП);
			
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.НаименованиеОрганизации", СведенияОбУчастнике.ПолноеНаименование);
	
	Иначе
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.ИНН", СведенияОбУчастнике.ИНН);
			
		Если ЗначениеЗаполнено(СведенияОбУчастнике.ПолноеНаименование)
			И ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.ПолноеНаименование") Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.ПолноеНаименование", СведенияОбУчастнике.ПолноеНаименование);
		КонецЕсли;
			
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.Фамилия", СведенияОбУчастнике.Фамилия);
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.Имя", СведенияОбУчастнике.Имя);
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.Отчество", СведенияОбУчастнике.Отчество);
		
	КонецЕсли;
	
	СведенияОбУчастнике.Вставить("ДатаКИ", ДатаКИ);
	АдресУчастника = Новый Структура();
	ПолучитьАдресСтруктурой(АдресУчастника, СведенияОбУчастнике, "Ссылка", ВидАдреса);
	
	Если АдресУчастника.Свойство("АдресРФ") Тогда
		ПолныйПуть = ВидУчастника + ".Адрес.Структурированный";
		Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, ПолныйПуть) Тогда
			Если АдресУчастника.ПроизвольныйАдрес Тогда
				ТипАдреса = "Произвольный";
			Иначе
				ТипАдреса = ?(АдресУчастника.АдресРФ, "Структурированный", "Иностранный");				
			КонецЕсли;			
		Иначе
			ТипАдреса = "Произвольный";
		КонецЕсли;
		
		ЗаполнитьАдресВДереве(ДеревоДанных, АдресУчастника, ТипАдреса, ВидУчастника);
	КонецЕсли;	
	
	Если ЗначениеЗаполнено(СведенияОбУчастнике.Телефоны)
		И ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, ВидУчастника + ".Контакт.Телефон") Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".Контакт.Телефон",
									СведенияОбУчастнике.Телефоны);
	КонецЕсли;
	
	НомерСчета = "";
	Если СведенияОбУчастнике.Свойство("НомерСчета", НомерСчета) И ЗначениеЗаполнено(НомерСчета) 
		 И ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, ВидУчастника + ".БанковскийСчет") Тогда
		Банк = "";
		БИК = "";
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".БанковскийСчет.НомерСчета", НомерСчета);
		
		Если СведенияОбУчастнике.Свойство("Банк", Банк) И ЗначениеЗаполнено(Банк) Тогда
			Если ТипЗнч(Банк) = Тип("Строка") Тогда
				БанкНаименование = Банк
			Иначе
				БанкНаименование = Банк.Наименование
			КонецЕсли;
				
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДанных, ВидУчастника + ".БанковскийСчет.НаимБанк", БанкНаименование);
		КонецЕсли;
		
		Если СведенияОбУчастнике.Свойство("БИК", БИК) И ЗначениеЗаполнено(БИК) Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДанных, ВидУчастника + ".БанковскийСчет.БИК", БИК);
		КонецЕсли;
	КонецЕсли;
	
	ПолныйПуть = ВидУчастника + ".Руководитель";
	Значение = "";
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, ПолныйПуть)
		И СведенияОбУчастнике.Свойство("Комментарий", Значение) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, ПолныйПуть + ".Фамилия", Значение.Фамилия);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, ПолныйПуть + ".Имя", Значение.Имя);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, ПолныйПуть + ".Отчество", Значение.Отчество);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, ПолныйПуть + ".Должность", Значение.Должность);
	КонецЕсли;
	
	ПолныйПуть = ВидУчастника + ".Комментарий";
	Значение = "";
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, ПолныйПуть) 
		И СведенияОбУчастнике.Свойство("Комментарий", Значение) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, ПолныйПуть, Значение);
	КонецЕсли;
	
	ПолныйПуть = ВидУчастника + ".КодОКПО";
	Значение = "";
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, ПолныйПуть)
		И СведенияОбУчастнике.Свойство("КодПоОКПО", Значение) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, ПолныйПуть, Значение);
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьДанныеУчастникаТОРГ(ДеревоДанных, СведенияОбУчастнике, ВидУчастника, ВидАдреса = "Юр", ДатаКИ = Неопределено) Экспорт
	
	Если СведенияОбУчастнике.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ЮрЛицо Тогда
		 
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН", СведенияОбУчастнике.ИНН);			
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП", СведенияОбУчастнике.КПП);			
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.НаименованиеОрганизации", СведенияОбУчастнике.ПолноеНаименование);
			
	ИначеЕсли СведенияОбУчастнике.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ЮрЛицоНеРезидент Тогда
	
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ИностраннаяОрганизация.НаименованиеОрганизации", СведенияОбУчастнике.ПолноеНаименование);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ИностраннаяОрганизация.Страна", СведенияОбУчастнике.СтранаРегистрации.НаименованиеПолное);
			
	ИначеЕсли СведенияОбУчастнике.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ИндивидуальныйПредприниматель Тогда
			
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН", СведенияОбУчастнике.ИНН);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.СвидетельствоОГосРегистрации", СведенияОбУчастнике.Свидетельство);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.Фамилия", СведенияОбУчастнике.Фамилия);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.Имя", СведенияОбУчастнике.Имя);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.Отчество", СведенияОбУчастнике.Отчество);
			
	Иначе
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.ИНН", СведенияОбУчастнике.ИНН);
		Если ЗначениеЗаполнено(СведенияОбУчастнике.ПолноеНаименование)
			И ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.ПолноеНаименование") Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.ПолноеНаименование", СведенияОбУчастнике.ПолноеНаименование);
		КонецЕсли;
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.Фамилия", СведенияОбУчастнике.Фамилия);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.Имя", СведенияОбУчастнике.Имя);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.Отчество", СведенияОбУчастнике.Отчество);
		
	КонецЕсли;
	
	СведенияОбУчастнике.Вставить("ДатаКИ", ДатаКИ);
	АдресУчастника = Новый Структура();
	ПолучитьАдресСтруктурой(АдресУчастника, СведенияОбУчастнике, "Ссылка", ВидАдреса);
	
	Если АдресУчастника.Свойство("АдресРФ") Тогда
		ПолныйПуть = ВидУчастника + ".Адрес.Структурированный";
		Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, ПолныйПуть) Тогда
			Если АдресУчастника.ПроизвольныйАдрес Тогда
				ТипАдреса = "Произвольный";
			Иначе
				ТипАдреса = ?(АдресУчастника.АдресРФ, "Структурированный", "Иностранный");				
			КонецЕсли;			
		Иначе
			ТипАдреса = "Произвольный";
		КонецЕсли;
		
		ЗаполнитьАдресВДереве(ДеревоДанных, АдресУчастника, ТипАдреса, ВидУчастника);
	КонецЕсли;	
	
	Если ЗначениеЗаполнено(СведенияОбУчастнике.Телефоны)
		И ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, ВидУчастника + ".Контакт.Телефон") Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".Контакт.Телефон",
									СведенияОбУчастнике.Телефоны);
	КонецЕсли;
	
	НомерСчета = "";
	Если СведенияОбУчастнике.Свойство("НомерСчета", НомерСчета) И ЗначениеЗаполнено(НомерСчета) 
		 И ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, ВидУчастника + ".БанковскийСчет") Тогда
		Банк = "";
		БИК = "";
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".БанковскийСчет.НомерСчета", НомерСчета);
		
		Если СведенияОбУчастнике.Свойство("Банк", Банк) И ЗначениеЗаполнено(Банк) Тогда
			Если ТипЗнч(Банк) = Тип("Строка") Тогда
				БанкНаименование = Банк
			Иначе
				БанкНаименование = Банк.Наименование
			КонецЕсли;
				
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДанных, ВидУчастника + ".БанковскийСчет.НаимБанк", БанкНаименование);
		КонецЕсли;
		
		Если СведенияОбУчастнике.Свойство("БИК", БИК) И ЗначениеЗаполнено(БИК) Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДанных, ВидУчастника + ".БанковскийСчет.БИК", БИК);
		КонецЕсли;
		
		КоррСчет = "";
		Если СведенияОбУчастнике.Свойство("КоррСчет", КоррСчет) И ЗначениеЗаполнено(КоррСчет)
			И ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, ВидУчастника + ".БанковскийСчет.КорСчет") Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДанных, ВидУчастника + ".БанковскийСчет.КорСчет", КоррСчет);
		КонецЕсли;
		
	КонецЕсли;
	
	ПолныйПуть = ВидУчастника + ".Руководитель";
	Значение = "";
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, ПолныйПуть)
		И СведенияОбУчастнике.Свойство("Комментарий", Значение) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, ПолныйПуть + ".Фамилия", Значение.Фамилия);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, ПолныйПуть + ".Имя", Значение.Имя);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, ПолныйПуть + ".Отчество", Значение.Отчество);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, ПолныйПуть + ".Должность", Значение.Должность);
	КонецЕсли;
	
	ПолныйПуть = ВидУчастника + ".Комментарий";
	Значение = "";
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, ПолныйПуть) 
		И СведенияОбУчастнике.Свойство("Комментарий", Значение) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, ПолныйПуть, Значение);
	КонецЕсли;
	
	ПолныйПуть = ВидУчастника + ".КодОКПО";
	Значение = "";
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, ПолныйПуть)
		И СведенияОбУчастнике.Свойство("КодПоОКПО", Значение) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, ПолныйПуть, Значение);
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьСтруктурноеПодразделение(ДеревоДанных, ВидУчастника, Подразделение) Экспорт
	
	Если ЗначениеЗаполнено(Подразделение) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".СтруктурноеПодразделение", Подразделение.Наименование);
	КонецЕсли;

КонецПроцедуры

Функция ПолучитьЗначениеРеквизитаДерева(СтрокаДерева, ИмяРеквизита, ВключатьПодчиненные = Ложь, ДеревоРазбора = Неопределено) Экспорт
	
	Результат = Неопределено;
	
	Если СтрокаДерева.Строки.Количество() > 0 Тогда 
		НайденнаяСтрока = СтрокаДерева.Строки.Найти(ИмяРеквизита, "Реквизит", ВключатьПодчиненные);
	Иначе // Передали строку с реквизитом
		НайденнаяСтрока = СтрокаДерева;
	КонецЕсли;
	
	Если НайденнаяСтрока <> Неопределено Тогда
		Результат = НайденнаяСтрока.ЗначениеРеквизита;
		
		Если ИмяРеквизита = "СтавкаНДС" ИЛИ ИмяРеквизита = "НалСтВел" Тогда
			Результат = НайтиПеречисление("НДС", Результат);
		ИначеЕсли ИмяРеквизита = "ВариантОплаты" Тогда
			Если Результат = Перечисления.ВариантыКонтроляОплатыКлиентом.АвансДоОбеспечения Тогда
				Результат = Перечисления.ВариантыКонтроляОплатыПоставщику.АвансДоПодтверждения
			ИначеЕсли Результат = Перечисления.ВариантыКонтроляОплатыКлиентом.КредитПослеОтгрузки Тогда
				Результат = Перечисления.ВариантыКонтроляОплатыПоставщику.КредитПослеПоступления 
			ИначеЕсли Результат = Перечисления.ВариантыКонтроляОплатыКлиентом.ПредоплатаДоОтгрузки Тогда
				Результат = Перечисления.ВариантыКонтроляОплатыПоставщику.ПредоплатаДоПоступления
			ИначеЕсли Результат = Перечисления.ВариантыКонтроляОплатыПоставщику.КредитПослеПоступления Тогда
				Результат = Перечисления.ВариантыКонтроляОплатыКлиентом.КредитПослеОтгрузки
			ИначеЕсли Результат = Перечисления.ВариантыКонтроляОплатыПоставщику.АвансДоПодтверждения Тогда
				Результат = Перечисления.ВариантыКонтроляОплатыКлиентом.АвансДоОбеспечения
			ИначеЕсли Результат = Перечисления.ВариантыКонтроляОплатыПоставщику.ПредоплатаДоПоступления Тогда
				Результат = Перечисления.ВариантыКонтроляОплатыКлиентом.ПредоплатаДоОтгрузки
			КонецЕсли
		Иначе
			// Если реквизит ссылочного типа (передали реквизит ДеревоРазбора), тогда нашли всего лишь индекс строки
			Если ЗначениеЗаполнено(ДеревоРазбора) Тогда 
				НайденнаяСтрока = ДеревоРазбора.Строки.Найти(Результат, "ИндексСтроки", Истина);
				Если НайденнаяСтрока <> Неопределено Тогда
					Результат = НайденнаяСтрока.СсылкаНаОбъект;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Функция ПолучитьАдресИзКонтактнойИнформации(Владелец, ТипАдреса = "Юр", ДатаКИ = Неопределено) Экспорт
	
	Результат = Новый Структура;
	
	Если ТипЗнч(Владелец) = Тип("СправочникСсылка.Организации") Тогда
		ВидыКИ = Справочники.ВидыКонтактнойИнформации[ТипАдреса + "АдресОрганизации"].Ссылка;
	ИначеЕсли ТипЗнч(Владелец) = Тип("СправочникСсылка.Контрагенты") Тогда
		ВидыКИ = Справочники.ВидыКонтактнойИнформации[ТипАдреса + "АдресКонтрагента"].Ссылка;
	Иначе
		ВидыКИ = Неопределено;
	КонецЕсли;
	
	МассивОбъектов = Новый Массив;
	МассивОбъектов.Добавить(Владелец);

	Если Не ЗначениеЗаполнено(ДатаКИ) Тогда
		ДатаКИ = ТекущаяДатаСеанса();
	КонецЕсли;
	
	КонтактнаяИнформация = УправлениеКонтактнойИнформацией.КонтактнаяИнформацияОбъектов(МассивОбъектов, , ВидыКИ, ДатаКИ);
	
	Для Каждого Колонка Из КонтактнаяИнформация.Колонки Цикл
		Результат.Вставить(Колонка.Имя);
	КонецЦикла;
	
	Если КонтактнаяИнформация.Количество() > 0 Тогда
		ЗаполнитьЗначенияСвойств(Результат, КонтактнаяИнформация[0]);
	КонецЕсли; 
	
	Возврат Результат;
	
КонецФункции

Функция ПолучитьТелефонИзКонтактнойИнформации(Владелец) Экспорт
	
	Результат = ФормированиеПечатныхФорм.ПолучитьТелефонИзКонтактнойИнформации(Владелец);
	
	Возврат Результат;
	
КонецФункции

Функция ПолучитьАдресЭПИзКонтактнойИнформации(Владелец) Экспорт
	
	Результат = Неопределено;
	
	Если Не ЗначениеЗаполнено(Владелец) Тогда
		Возврат Результат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	КонтактнаяИнформация.Представление КАК АдресЭП
	|ИЗ
	|	Справочник.%ИмяСправочника%.КонтактнаяИнформация КАК КонтактнаяИнформация 
	|ГДЕ
	|	КонтактнаяИнформация.Ссылка = &Владелец
	|	И КонтактнаяИнформация.Тип = &Тип
	|	И КонтактнаяИнформация.Вид = &ВидEmail";
	
	Если ТипЗнч(Владелец) = Тип("СправочникСсылка.Организации") Тогда
		ВидEmail = Справочники.ВидыКонтактнойИнформации["EmailОрганизации"].Ссылка;
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "%ИмяСправочника%", "Организации");
	ИначеЕсли ТипЗнч(Владелец) = Тип("СправочникСсылка.Контрагенты") Тогда
		ВидEmail = Справочники.ВидыКонтактнойИнформации["EmailКонтрагента"].Ссылка;
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "%ИмяСправочника%", "Контрагенты");
	ИначеЕсли ТипЗнч(Владелец) = Тип("СправочникСсылка.Партнеры") Тогда
		ВидEmail = Справочники.ВидыКонтактнойИнформации["EmailПартнера"].Ссылка;
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "%ИмяСправочника%", "Партнеры");
	КонецЕсли;
	
	Запрос.УстановитьПараметр("Владелец", Владелец);
	Запрос.УстановитьПараметр("Тип",      Перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты);
	Запрос.УстановитьПараметр("ВидEmail", ВидEmail);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Результат = Выборка.АдресЭП;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// См. ОбменСКонтрагентамиПереопределяемый.ПолучитьБанковскиеСчета.
Процедура ПолучитьБанковскиеСчета(Организация, Таблица) Экспорт
	
	Запрос = Новый Запрос();
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	БанковскиеСчетаОрганизаций.Ссылка КАК БанковскийСчет
	|ИЗ
	|	Справочник.БанковскиеСчетаОрганизаций КАК БанковскиеСчетаОрганизаций
	|ГДЕ
	|	БанковскиеСчетаОрганизаций.Владелец = &Владелец
	|	";
	
	Запрос.УстановитьПараметр("Владелец", Организация);
	Таблица = Запрос.Выполнить().Выгрузить();
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ПолучитьБанковскиеРеквизиты.
Процедура ПолучитьБанковскиеРеквизиты(МассивСчетов, Таблица) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	БанковскиеСчетаОрганизаций.Ссылка,
	|	БанковскиеСчетаОрганизаций.НомерСчета КАК РасчетныйСчет,
	|	ВЫБОР
	|		КОГДА БанковскиеСчетаОрганизаций.РучноеИзменениеРеквизитовБанка
	|			ТОГДА БанковскиеСчетаОрганизаций.КоррСчетБанка
	|		ИНАЧЕ БанковскиеСчетаОрганизаций.Банк.КоррСчет
	|	КОНЕЦ КАК КорреспондентскийСчет,
	|	ВЫБОР
	|		КОГДА БанковскиеСчетаОрганизаций.РучноеИзменениеРеквизитовБанка
	|			ТОГДА БанковскиеСчетаОрганизаций.БИКБанка
	|		ИНАЧЕ БанковскиеСчетаОрганизаций.Банк.Код
	|	КОНЕЦ КАК БИК,
	|	ВЫБОР
	|		КОГДА БанковскиеСчетаОрганизаций.РучноеИзменениеРеквизитовБанка
	|			ТОГДА БанковскиеСчетаОрганизаций.НаименованиеБанка
	|		ИНАЧЕ БанковскиеСчетаОрганизаций.Банк.Наименование
	|	КОНЕЦ КАК Банк,
	|	ВЫБОР
	|		КОГДА БанковскиеСчетаОрганизаций.РучноеИзменениеРеквизитовБанкаДляРасчетов
	|			ТОГДА БанковскиеСчетаОрганизаций.НаименованиеБанкаДляРасчетов
	|		ИНАЧЕ БанковскиеСчетаОрганизаций.БанкДляРасчетов.Наименование
	|	КОНЕЦ КАК БанкДляРасчетов,
	|	ВЫБОР
	|		КОГДА БанковскиеСчетаОрганизаций.РучноеИзменениеРеквизитовБанкаДляРасчетов
	|			ТОГДА БанковскиеСчетаОрганизаций.БИКБанкаДляРасчетов
	|		ИНАЧЕ БанковскиеСчетаОрганизаций.БанкДляРасчетов.Код
	|	КОНЕЦ КАК БанкДляРасчетовБИК,
	|	ВЫБОР
	|		КОГДА БанковскиеСчетаОрганизаций.РучноеИзменениеРеквизитовБанкаДляРасчетов
	|			ТОГДА БанковскиеСчетаОрганизаций.КоррСчетБанкаДляРасчетов
	|		ИНАЧЕ БанковскиеСчетаОрганизаций.БанкДляРасчетов.КоррСчет
	|	КОНЕЦ КАК БанкДляРасчетовКоррСчет
	|ИЗ
	|	Справочник.БанковскиеСчетаОрганизаций КАК БанковскиеСчетаОрганизаций
	|ГДЕ
	|	БанковскиеСчетаОрганизаций.Ссылка В(&МассивСчетов)";
	Запрос.УстановитьПараметр("МассивСчетов", МассивСчетов);
	Таблица = Запрос.Выполнить().Выгрузить();
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ЭтоФизЛицо.
Процедура ЭтоФизЛицо(ДанныеКонтрагента, ПризнакФизЛица) Экспорт
	
	Если ДанныеКонтрагента.Метаданные().Реквизиты.Найти("ЮрФизЛицо") = Неопределено Тогда
		ПризнакФизЛица = Ложь;
	КонецЕсли;
	
	ЮрФизЛицо = ДанныеКонтрагента.ЮрФизЛицо;
	
	Если ТипЗнч(ЮрФизЛицо) <> Тип("ПеречислениеСсылка.ЮрФизЛицо") Тогда
		ПризнакФизЛица = Ложь;
	КонецЕсли;
		
	ПризнакФизЛица = Ложь;
	Если ЮрФизЛицо = Перечисления.ЮрФизЛицо.ФизЛицо 
		ИЛИ ЮрФизЛицо = Перечисления.ЮрФизЛицо.ИндивидуальныйПредприниматель Тогда
		ПризнакФизЛица = Истина;
	КонецЕсли;
	
КонецПроцедуры

// Получает таблицу с ключевыми реквизитами объекта.
// 
// Параметры:
//  ИмяОбъекта - Строка - имя объекта конфигурации, ключевые реквизиты которого необходимо получить.
//
// Возвращаемое значение:
//  ТаблицаЗначений - таблица ключевых реквизитов.
//
Функция КлючевыеРеквизитыОбъекта(ИмяОбъекта) Экспорт
	
	ТаблицаРеквизитов = ИнициализацияТаблицыРеквизитовОбъектов();
	
	Если ИмяОбъекта = "Документ.ПакетЭД" Тогда
		Возврат ТаблицаРеквизитов;
	КонецЕсли;
	
	СтруктураКлючевыхРеквизитов = Новый Структура;
	ПолучитьСтруктуруКлючевыхРеквизитовОбъекта(ИмяОбъекта, СтруктураКлючевыхРеквизитов);
	
	ТекПорядок = -50;
	Для Каждого ТекЭлемент Из СтруктураКлючевыхРеквизитов Цикл
		НовСтрока                            = ТаблицаРеквизитов.Добавить();
		НовСтрока.Порядок                    = ТекПорядок;
		НовСтрока.ИмяОбъекта                 = ИмяОбъекта;
		НовСтрока.ИмяТабличнойЧасти          = ?(ТекЭлемент.Ключ = "Шапка", "", ТекЭлемент.Ключ);
		НовСтрока.РеквизитыОбъекта           = ТекЭлемент.Значение;
		НовСтрока.СтруктураРеквизитовОбъекта = Новый Структура(ТекЭлемент.Значение);
		ТекПорядок = ТекПорядок + 100;
	КонецЦикла;
	
	ТаблицаРеквизитов.Сортировать("Порядок Возр");
	
	Возврат ТаблицаРеквизитов;
	
КонецФункции

Функция ОпределитьИзмененияВерсийОбъекта(Объект, СтрокаТаблицыРеквизитовРегистрации) Экспорт
	
	Если ПустаяСтрока(СтрокаТаблицыРеквизитовРегистрации.ИмяТабличнойЧасти) Тогда
		
		ТаблицаРеквизитовРегистрацииВерсияОбъектаДоИзменения = РеквизитыРегистрацииШапкиДоИзменения(Объект,
			СтрокаТаблицыРеквизитовРегистрации);
		ТаблицаРеквизитовРегистрацииВерсияОбъектаПослеИзменения = РеквизитыРегистрацииШапкиПослеИзменения(
			Объект, СтрокаТаблицыРеквизитовРегистрации);
	Иначе
		
		ТаблицаРеквизитовРегистрацииВерсияОбъектаДоИзменения = РеквизитыРегистрацииТабличнойЧастиДоИзменения(
			Объект, СтрокаТаблицыРеквизитовРегистрации);
		ТаблицаРеквизитовРегистрацииВерсияОбъектаПослеИзменения = РеквизитыРегистрацииТабличнойЧастиПослеИзменения(
			Объект, СтрокаТаблицыРеквизитовРегистрации);
	КонецЕсли;
	
	Возврат НЕ ТаблицыРеквизитовОбъектовОдинаковые(ТаблицаРеквизитовРегистрацииВерсияОбъектаДоИзменения,
												   ТаблицаРеквизитовРегистрацииВерсияОбъектаПослеИзменения,
												   СтрокаТаблицыРеквизитовРегистрации.РеквизитыОбъекта);
	
КонецФункции

Функция ПодлежитОбменуЭД(Объект, ЭлектронныйДокументСформирован) Экспорт
	
	ПодлежитОбменуЭД = Истина;
	
	Если ТипЗнч(Объект) = Тип("ДокументОбъект.ПоступлениеБезналичныхДенежныхСредств")
		Или ТипЗнч(Объект) = Тип("ДокументОбъект.СписаниеБезналичныхДенежныхСредств") Тогда
		
		ПодлежитОбменуЭД = Не Объект.ПроведеноБанком;
	КонецЕсли;

	Если Объект.ДополнительныеСвойства.Свойство("РежимЗаписи") Тогда
		ЭтоНеПроведениеДокумента = Объект.ДополнительныеСвойства.РежимЗаписи <> РежимЗаписиДокумента.Проведение;
	ИначеЕсли Объект.ДополнительныеСвойства.Свойство("ПроведениеДокументов") Тогда 
		ЭтоНеПроведениеДокумента = ПроведениеДокументов.СвойстваДокумента(Объект).РежимЗаписи <> РежимЗаписиДокумента.Проведение;
	Иначе
		ЭтоНеПроведениеДокумента = Истина;
	КонецЕсли;

	Если ЭтоНеПроведениеДокумента И Не ЭлектронныйДокументСформирован Тогда
		ПодлежитОбменуЭД = Ложь;
	КонецЕсли;
	
	Возврат ПодлежитОбменуЭД;
	
КонецФункции

// Заполняет сопоставление номенклатуры для дерева ЭД.
// 
// Параметры:
//  Строка - СтрокаТаблицыЗначений - строка данных из документа.
//  ШтрихкодыКомбинаций - Массив - штрихкоды номенклатуры.
//  ШтрихкодыНоменклатуры - Массив - штрихкоды номенклатуры.
//  Упаковка - СправочникСсылка.УпаковкиЕдиницыИзмерения - упаковки из строки документа.
//  СоответствиеСтавокНДСКонтрагента - Соответствие - соответствие ставок НДС.
//
// Возвращаемое значение:
//  Структура - структура содержащая данные сопоставления.
//
Функция ЗаполнитьСопоставлениеНоменклатуры(Строка, ШтрихкодыКомбинаций = Неопределено, ШтрихкодыНоменклатуры = Неопределено, Упаковка = Неопределено, СоответствиеСтавокНДСКонтрагента = Неопределено) Экспорт
	
	Таблица = Строка.Владелец();
	Сопоставление = Новый Структура;
	Сопоставление.Вставить("НоменклатураИБ", 		Строка.Номенклатура);
	Сопоставление.Вставить("ХарактеристикаИБ", 		Строка.Характеристика);
	Если Упаковка <> Неопределено Тогда
		ЗначениеУпаковки = Упаковка
	ИначеЕсли ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(Строка, "Упаковка") И ЗначениеЗаполнено(Строка.Упаковка) Тогда
		ЗначениеУпаковки = Строка.Упаковка
	Иначе
		ЗначениеУпаковки = Справочники.УпаковкиЕдиницыИзмерения.ПустаяСсылка();
	КонецЕсли;
	Если Не ЗначениеЗаполнено(ЗначениеУпаковки) И СоответствиеСтавокНДСКонтрагента = Неопределено Тогда
		ЗначениеУпаковки = Строка.ЕдиницаИзмерения
	КонецЕсли;
	Сопоставление.Вставить("УпаковкаИБ", 			ЗначениеУпаковки);
	
	Если Таблица.Колонки.Найти("Идентификатор") <> Неопределено Тогда
		Сопоставление.Вставить("Идентификатор", 		Строка.Идентификатор);
	Иначе
		Сопоставление.Вставить("Идентификатор", 		"");
	КонецЕсли;	
	
	Если Таблица.Колонки.Найти("ЕдиницаИзмеренияНаименование") <> Неопределено Тогда
		Сопоставление.Вставить("ЕдиницаИзмерения", 		Строка.ЕдиницаИзмеренияНаименование);
	Иначе
		Сопоставление.Вставить("ЕдиницаИзмерения", 		"");
	КонецЕсли;
		
	Если Таблица.Колонки.Найти("ЕдиницаИзмеренияКод") <> Неопределено Тогда
		Сопоставление.Вставить("ЕдиницаИзмеренияКод", 	Строка.ЕдиницаИзмеренияКод);
	ИначеЕсли Таблица.Колонки.Найти("ЕдиницаИзмеренияКодПоОКЕИ") <> Неопределено Тогда
		Сопоставление.Вставить("ЕдиницаИзмеренияКод", 	Строка.ЕдиницаИзмеренияКодПоОКЕИ);
	Иначе
		Сопоставление.Вставить("ЕдиницаИзмеренияКод", 		"");
	КонецЕсли;
	
	Если Таблица.Колонки.Найти("ХарактеристикаНаименование") <> Неопределено Тогда
		Сопоставление.Вставить("Характеристика", 		Строка.ХарактеристикаНаименование);
	ИначеЕсли Таблица.Колонки.Найти("ХарактеристикаНаименованиеПолное") <> Неопределено Тогда
		Сопоставление.Вставить("Характеристика", 		Строка.ХарактеристикаНаименованиеПолное);		
	ИначеЕсли Таблица.Колонки.Найти("НаименованиеХарактеристики") <> Неопределено Тогда
		Сопоставление.Вставить("Характеристика", 		Строка.НаименованиеХарактеристики);
	Иначе
		Если ЗначениеЗаполнено(Строка.Характеристика) Тогда
			Сопоставление.Вставить("Характеристика", 		Строка.Характеристика.Наименование);
		Иначе
			Сопоставление.Вставить("Характеристика", 		"");
		КонецЕсли;	
	КонецЕсли;
	
	Если Таблица.Колонки.Найти("НоменклатураНаименование") <> Неопределено Тогда
		Сопоставление.Вставить("Наименование", 			Строка.НоменклатураНаименование);
	ИначеЕсли Таблица.Колонки.Найти("УслугаНаименованиеПолное") <> Неопределено Тогда
		Сопоставление.Вставить("Наименование", 			Строка.УслугаНаименованиеПолное);		
	Иначе
		Сопоставление.Вставить("Наименование", 			Строка.Наименование);
	КонецЕсли;
	
	Если Таблица.Колонки.Найти("НоменклатураКод") <> Неопределено Тогда
		Сопоставление.Вставить("Артикул", 			Строка.НоменклатураКод);
	ИначеЕсли Таблица.Колонки.Найти("Артикул") <> Неопределено Тогда
		Сопоставление.Вставить("Артикул", 			Строка.Артикул);
	Иначе
		Сопоставление.Вставить("Артикул", 			"");		
	КонецЕсли;
	
	Если Сопоставление.Идентификатор <> "" И Сопоставление.Идентификатор <> NULL 
		И СоответствиеСтавокНДСКонтрагента <> Неопределено // для акта о расхождениях (ГосИС)
		Тогда
		Сопоставление.Вставить("СтавкаНДС", СоответствиеСтавокНДСКонтрагента.Получить(Строка.СтавкаНДС));
		Сопоставление.Вставить("ШтрихкодыНоменклатуры", Строка.ШтрихкодыНоменклатуры);
		Сопоставление.Вставить("ШтрихкодКомбинации",    Строка.ШтрихкодКомбинации);		
	Иначе
		Сопоставление.Вставить("СтавкаНДС", Строка.СтавкаНДС);
		НоменклатураПартнеровСервер.ЗаполнитьШтрихкодыТоваровВСопоставление(Сопоставление, ШтрихкодыНоменклатуры, ШтрихкодыКомбинаций,
				Строка.Номенклатура, Строка.Характеристика, ЗначениеУпаковки);
	КонецЕсли;
	
	Возврат Сопоставление
	
КонецФункции

// Обработчик события "ОбработкаЗаполнения" электронных документов.
// 
// Параметры:
//  Источник		 		- Объект 	   - Электронный документ;
//	ДанныеЗаполнения 		- Произвольный - Значение, которое используется как основание для заполнения;
//  СтандартнаяОбработка    - Булево       - Признак выполнения стандартной (системной) обработки события.
//
Процедура ЗаполнитьЗначениеРеквизитаОрганизацияПриОднофирменномУчетеОбработкаЗаполнения(Источник, ДанныеЗаполнения, СтандартнаяОбработка) Экспорт

	ОбщегоНазначенияУТ.ОбработкаЗаполнения(Источник, ДанныеЗаполнения, СтандартнаяОбработка);
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Поиск и создание документов

Функция НайтиСоздатьПриобретениеТоваровУслуг(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца = Неопределено, Записывать = Истина) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	ДанныеДляЗагрузки = ПодготовитьСтруктуруДляПриобретенияТоваровУслуг(СтрокаДляЗагрузки, ДеревоРазбора);
	
	Документ = СсылкаНаВладельца;
	ЗаполнитьДокументПриобретенияТоваровУслуг(Документ, ДанныеДляЗагрузки, Записывать);
	
	Возврат Документ;
	
КонецФункции

Функция НайтиСоздатьВозвратТоваровОтПокупателя(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца = Неопределено, Записывать = Истина) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	ДанныеДляЗагрузки = ПодготовитьСтруктуруДляПриобретенияТоваровУслуг(СтрокаДляЗагрузки, ДеревоРазбора);
	
	Документ = СсылкаНаВладельца;
	ЗаполнитьДокументВозвратаТоваровОтПокупателя(Документ, ДанныеДляЗагрузки, Записывать);
	
	Возврат Документ;
	
КонецФункции

Функция НайтиСоздатьСчетФактуру(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца = Неопределено, Записывать = Истина) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	ДанныеДляЗагрузки = ПодготовитьСтруктуруДляСчетаФактуры(СтрокаДляЗагрузки, ДеревоРазбора);
	
	Документ = СсылкаНаВладельца;
	ЗаполнитьДокументСчетФактура(Документ, ДанныеДляЗагрузки, Записывать);
	
	Возврат Документ;

КонецФункции

Функция НайтиСоздатьСчетФактуруАванс(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца = Неопределено, Записывать = Истина) Экспорт
	
	Текст = "";
	ДанныеДляЗагрузки = ПодготовитьСтруктуруДляСчетаФактуры(СтрокаДляЗагрузки, ДеревоРазбора, Истина);
	ДанныеШапки = ДанныеДляЗагрузки.Шапка;
	Авансы = ДанныеДляЗагрузки.Авансы;
	
	РежимЗаписи = РежимЗаписиДокумента.Запись;
	Если ЗначениеЗаполнено(СсылкаНаВладельца) Тогда
		ДокументОбъект = СсылкаНаВладельца.ПолучитьОбъект();
		//Попытка заблокировать документ
		Попытка
			ДокументОбъект.Заблокировать();
		Исключение
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить данные документа ""%1"".
				|Возможно, документ редактируется другим пользователем'"),
				Строка(ДокументОбъект.Ссылка));
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
		//конец попытки заблокировать документ
		Если ДокументОбъект.Проведен Тогда
			РежимЗаписи = РежимЗаписиДокумента.Проведение;
			Текст = НСтр("ru = 'Операция возможна только для непроведенных документов'");
		КонецЕсли;
	Иначе
		УстановитьПривилегированныйРежим(истина);
		ДокументОбъект = Документы.СчетФактураПолученныйАванс.СоздатьДокумент();
		ДокументОбъект.Дата = ТекущаяДатаСеанса();
		ДокументОбъект.УстановитьНовыйНомер();
		ДокументОбъект.Заполнить(ДанныеШапки);
	КонецЕсли;
	
	ДокументОбъект.ОбменДанными.Загрузка = Истина;
	ДокументОбъект.ДополнительныеСвойства.Вставить("ЕстьСоглашение", Истина);
	
	ПерезаполнениеЗначенийРеквизитовШапки(ДокументОбъект, ДанныеШапки);
	
	ДокументОбъект.Авансы.Загрузить(Авансы);
	
	Попытка
		Если Записывать Тогда
			ДокументОбъект.Записать(РежимЗаписи);
			ДокументОбъект.Разблокировать();
			ВозвращаемоеЗначение = ДокументОбъект.Ссылка;
			
			//Запись в Реестр документов
			ТаблицыДанных = ПроведениеДокументов.ДанныеДокументаДляПроведения(ВозвращаемоеЗначение, "РеестрДокументов");
			РегистрыСведений.РеестрДокументов.ЗаписатьДанные(ТаблицыДанных, ВозвращаемоеЗначение,  Неопределено, Ложь);
		Иначе
			ВозвращаемоеЗначение = ДокументОбъект;
		КонецЕсли;
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка()),
					Текст);
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка, ДокументОбъект.Метаданные(), СсылкаНаВладельца, 
									ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

Функция НайтиСоздатьСчетФактуруКомитента(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца = Неопределено, Записывать = Истина) Экспорт
	
	Текст = "";
	ДанныеДляЗагрузки = ПодготовитьСтруктуруДляСчетаФактуры(СтрокаДляЗагрузки, ДеревоРазбора);
	ДанныеШапки = ДанныеДляЗагрузки.Шапка;
	
	РежимЗаписи = РежимЗаписиДокумента.Запись;
	Если ЗначениеЗаполнено(СсылкаНаВладельца) Тогда
		ДокументОбъект = СсылкаНаВладельца.ПолучитьОбъект();
		//Попытка заблокировать документ
		Попытка
			ДокументОбъект.Заблокировать();
		Исключение
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить данные документа ""%1"".
				|Возможно, документ редактируется другим пользователем'"),
				Строка(ДокументОбъект.Ссылка));
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
		//конец попытки заблокировать документ
		Если ДокументОбъект.Проведен Тогда
			РежимЗаписи = РежимЗаписиДокумента.Проведение;
			Текст = НСтр("ru = 'Операция возможна только для непроведенных документов'");
		КонецЕсли;
	Иначе
		УстановитьПривилегированныйРежим(истина);
		ДокументОбъект = Документы.СчетФактураКомитента.СоздатьДокумент();
		ДокументОбъект.Заполнить(ДанныеШапки);
		ЗаполнитьЗначенияСвойств(ДокументОбъект, ДанныеШапки);
	КонецЕсли;
	
	ДокументОбъект.ОбменДанными.Загрузка = Истина;
	ДокументОбъект.ДополнительныеСвойства.Вставить("ЕстьСоглашение", Истина);
	
	ПерезаполнениеЗначенийРеквизитовШапки(ДокументОбъект, ДанныеШапки);
	
	// Заполним ТЧ Покупатели
	Если ДанныеШапки.Свойство("Покупатель") Тогда
		ДокументОбъект.Покупатели.Очистить();
		НоваяСтрока = ДокументОбъект.Покупатели.Добавить();
		НоваяСтрока.Покупатель = ДанныеШапки.Покупатель;
	КонецЕсли;
	
	Попытка
		Если Записывать Тогда
			ДокументОбъект.Записать(РежимЗаписи);
			ДокументОбъект.Разблокировать();			
			ВозвращаемоеЗначение = ДокументОбъект.Ссылка;
		Иначе
			ВозвращаемоеЗначение = ДокументОбъект;
		КонецЕсли;
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка()),
					Текст); 
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка, ДокументОбъект.Метаданные(), СсылкаНаВладельца, 
									ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

Функция НайтиСоздатьПоступлениеУслуг(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца = Неопределено, Записывать = Истина) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	ДанныеДляЗагрузки = ПодготовитьСтруктуруДляПоступленияУслуг(СтрокаДляЗагрузки, ДеревоРазбора);
	
	Документ = СсылкаНаВладельца;
	ЗаполнитьДокументПоступленияУслуг(Документ, ДанныеДляЗагрузки, Записывать);
	
	Возврат Документ;
	
КонецФункции

Функция НайтиСоздатьЗаявкуНаРасходованиеДенежныхСредств(СтрокаДляЗагрузки, ДеревоРазбора, ДополнительныеДанные, СсылкаНаВладельца = Неопределено, Записывать = Истина) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если Не ПолучитьФункциональнуюОпцию("ИспользоватьЗаявкиНаРасходованиеДенежныхСредств") Тогда
		Текст = НСтр("ru = 'Для создания документа ""Заявка на расходование денежных средств"" необходимо включить функциональную опцию ""Использовать заявки на расходование денежных средств""'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);		
		Возврат Неопределено		
	КонецЕсли;
	
	Текст = "";
	ДанныеДляЗагрузки = ПодготовитьСтруктуруДляЗаявкиНаРасходование(СтрокаДляЗагрузки, ДеревоРазбора);
	
	Если ДанныеДляЗагрузки.Свойство("Шапка") Тогда 
		ДанныеЗаполнения = ДанныеДляЗагрузки.Шапка;
	КонецЕсли; 
	
	РежимЗаписи = РежимЗаписиДокумента.Запись;
	Если ЗначениеЗаполнено(СсылкаНаВладельца) Тогда // получены изменения по существующему документу
		ДокументОбъект = СсылкаНаВладельца.ПолучитьОбъект();
		//Попытка заблокировать документ
		Попытка
			ДокументОбъект.Заблокировать();
		Исключение
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить данные документа ""%1"".
				|Возможно, документ редактируется другим пользователем'"),
				Строка(ДокументОбъект.Ссылка));
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
		//конец попытки заблокировать документ
		Если ДокументОбъект.Проведен Тогда 
			РежимЗаписи = РежимЗаписиДокумента.Проведение;
			Текст = НСтр("ru = 'Операция возможна только для непроведенных документов'");
        КонецЕсли;
		ДокументОбъект.РасшифровкаПлатежа.Очистить();
	Иначе  // создаем новый
		ДокументОбъект = Документы.ЗаявкаНаРасходованиеДенежныхСредств.СоздатьДокумент();
		ДокументОбъект.Дата = ТекущаяДатаСеанса();
		ДокументОбъект.Автор = Пользователи.АвторизованныйПользователь();
		ДокументОбъект.Заполнить(ДанныеЗаполнения);
		ДокументОбъект.УстановитьНовыйНомер();
	КонецЕсли;
	ДокументОбъект.ОбменДанными.Загрузка = Истина;
			
	// вручную переопределим, если требуется
	ПерезаполнениеЗначенийРеквизитовШапки(ДокументОбъект, ДанныеЗаполнения);
	
	Если ДанныеЗаполнения.Свойство("СрокПлатежа") Тогда 
		ДокументОбъект.ЖелательнаяДатаПлатежа = ДанныеЗаполнения.СрокПлатежа;
	КонецЕсли;
	
	Если ДанныеЗаполнения.Свойство("НомерДокументаОснования") 
	   И ДанныеЗаполнения.Свойство("ДатаДокументаОснования") 
	   И ЗначениеЗаполнено(ДанныеЗаполнения.НомерДокументаОснования)
	   И ЗначениеЗаполнено(ДанныеЗаполнения.ДатаДокументаОснования) Тогда
	   	РеквизитыИБ = Новый Структура;
		РеквизитыИБ.Вставить("Номер", 	ДанныеЗаполнения.НомерДокументаОснования);
		Если ТипЗнч(ДанныеЗаполнения.ДатаДокументаОснования) = Тип("Строка") Тогда
        	РеквизитыИБ.Вставить("Дата", 	ПолучитьДатуВремяИзСтроки(ДанныеЗаполнения.ДатаДокументаОснования));
		Иначе
        	РеквизитыИБ.Вставить("Дата", 	ДанныеЗаполнения.ДатаДокументаОснования);
		КонецЕсли;
		ТипыДокументов = ОбменСКонтрагентами.ТипыДокументов();			
		НайденныйДок = НайтиДокумент(ТипыДокументов.ОтветНаЗаказ, ДокументОбъект.Контрагент, РеквизитыИБ);
		Если ЗначениеЗаполнено(НайденныйДок) Тогда
			ДокументОбъект.ДокументОснование = НайденныйДок;
		КонецЕсли;	
	КонецЕсли;   
	 	
	ДокументОбъект.Статус = Перечисления.СтатусыЗаявокНаРасходованиеДенежныхСредств.НеСогласована;
	
	// сумма документа
	ДокументОбъект.СуммаДокумента = ДанныеЗаполнения.Сумма;
	
	// табл.часть расшифровка
	НовСтрока = ДокументОбъект.РасшифровкаПлатежа.Добавить();
	НовСтрока.ВалютаВзаиморасчетов 	= ДокументОбъект.Валюта;
	НовСтрока.Сумма 				= ДокументОбъект.СуммаДокумента;
	НовСтрока.СуммаВзаиморасчетов 	= ДокументОбъект.СуммаДокумента;
	Если ДанныеЗаполнения.Свойство("СуммаНалогаИтог") Тогда
		НовСтрока.СуммаНДС			= ДанныеЗаполнения.СуммаНалогаИтог;
	КонецЕсли;
	Если ДанныеДляЗагрузки.Свойство("РасшифровкаПлатежа") Тогда
		ДанныеЗаполненияРП = ДанныеДляЗагрузки.РасшифровкаПлатежа;
		Если ДанныеЗаполненияРП.Количество() Тогда
			Если ЗначениеЗаполнено(ДанныеЗаполненияРП[0].СтавкаНДС) Тогда
				НовСтрока.СтавкаНДС	= ДанныеЗаполненияРП[0].СтавкаНДС;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли; 
	
    Если ДанныеЗаполнения.Свойство("Партнер") Тогда
		НовСтрока.Партнер = ДанныеЗаполнения.Партнер;
	КонецЕсли;
	Если ЗначениеЗаполнено(НайденныйДок) Тогда
		НовСтрока.ОбъектРасчетов = ОбъектыРасчетовСервер.ПолучитьОбъектРасчетовПоСсылке(НайденныйДок);
	КонецЕсли;
	
	Попытка
		Если Записывать Тогда
			// запись версии создаваемого документа в подсистеме версионирования
			ДокументОбъект.ОбменДанными.Загрузка = Ложь;
			ВерсионированиеОбъектовСобытия.ЗаписатьВерсиюДокумента(ДокументОбъект, Ложь, РежимЗаписи, РежимПроведенияДокумента.Неоперативный);
			ДокументОбъект.ОбменДанными.Загрузка = Истина;
			// запись версии конец
						
			ДокументОбъект.Записать(РежимЗаписи);
			
			ЗаписатьПрисоединенныеФайлыКДокументуЧерезСервисShare(ДокументОбъект.Ссылка, ДополнительныеДанные);
			ДокументОбъект.Разблокировать();
			ВозвращаемоеЗначение = ДокументОбъект.Ссылка;
		Иначе
			ВозвращаемоеЗначение = ДокументОбъект;
		КонецЕсли;
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка()),
					Текст); 
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка, ДокументОбъект.Метаданные(), СсылкаНаВладельца, 
									ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

Функция НайтиСоздатьСписаниеБезналичныхДенежныхСредств(СтрокаДляЗагрузки, ДеревоРазбора, ДополнительныеДанные, СсылкаНаВладельца = Неопределено, Записывать = Истина) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Текст = "";
	ДанныеДляЗагрузки = ПодготовитьСтруктуруДляЗаявкиНаРасходование(СтрокаДляЗагрузки, ДеревоРазбора);
	
	Если ДанныеДляЗагрузки.Свойство("Шапка") Тогда 
		ДанныеЗаполнения = ДанныеДляЗагрузки.Шапка;
	КонецЕсли; 
	
	РежимЗаписи = РежимЗаписиДокумента.Запись;
	Если ЗначениеЗаполнено(СсылкаНаВладельца) Тогда // получены изменения по существующему документу
		ДокументОбъект = СсылкаНаВладельца.ПолучитьОбъект();
		//Попытка заблокировать документ
		Попытка
			ДокументОбъект.Заблокировать();
		Исключение
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить данные документа ""%1"".
				|Возможно, документ редактируется другим пользователем'"),
				Строка(ДокументОбъект.Ссылка));
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
		//конец попытки заблокировать документ
		Если ДокументОбъект.Проведен Тогда 
			РежимЗаписи = РежимЗаписиДокумента.Проведение;
			Текст = НСтр("ru = 'Операция возможна только для непроведенных документов'");
        КонецЕсли;
		ДокументОбъект.РасшифровкаПлатежа.Очистить();
	Иначе  // создаем новый
		ДокументОбъект = Документы.СписаниеБезналичныхДенежныхСредств.СоздатьДокумент();
		ДокументОбъект.Дата = ТекущаяДатаСеанса();
		ДокументОбъект.Автор = Пользователи.АвторизованныйПользователь();
		ДокументОбъект.Заполнить(ДанныеЗаполнения);
		ДокументОбъект.УстановитьНовыйНомер();
	КонецЕсли;
	ДокументОбъект.ОбменДанными.Загрузка = Истина;
			
	// вручную переопределим, если требуется
	ПерезаполнениеЗначенийРеквизитовШапки(ДокументОбъект, ДанныеЗаполнения);
	
	Если ДанныеЗаполнения.Свойство("НомерДокументаОснования") 
	   И ДанныеЗаполнения.Свойство("ДатаДокументаОснования") 
	   И ЗначениеЗаполнено(ДанныеЗаполнения.НомерДокументаОснования)
	   И ЗначениеЗаполнено(ДанныеЗаполнения.ДатаДокументаОснования) Тогда
	   	РеквизитыИБ = Новый Структура;
		РеквизитыИБ.Вставить("Номер", 	ДанныеЗаполнения.НомерДокументаОснования);
		Если ТипЗнч(ДанныеЗаполнения.ДатаДокументаОснования) = Тип("Строка") Тогда
        	РеквизитыИБ.Вставить("Дата", 	ПолучитьДатуВремяИзСтроки(ДанныеЗаполнения.ДатаДокументаОснования));
		Иначе
        	РеквизитыИБ.Вставить("Дата", 	ДанныеЗаполнения.ДатаДокументаОснования);
		КонецЕсли;
		ТипыДокументов = ОбменСКонтрагентами.ТипыДокументов();			
		НайденныйДок = НайтиДокумент(ТипыДокументов.ОтветНаЗаказ, ДокументОбъект.Контрагент, РеквизитыИБ);
		Если ЗначениеЗаполнено(НайденныйДок) Тогда
			ДокументОбъект.ДокументОснование = НайденныйДок;
		КонецЕсли;	
	КонецЕсли;   
	 	
	ДокументОбъект.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ОплатаПоставщику;
	ДокументОбъект.СтатьяДвиженияДенежныхСредств = 
		Справочники.СтатьиДвиженияДенежныхСредств.СтатьяДвиженияДенежныхСредствПоХозяйственнойОперации(ДокументОбъект.ХозяйственнаяОперация);
		
	Если ЗначениеЗаполнено(ДокументОбъект.БанковскийСчет) Тогда
		РазрешеныПлатежиБезУказанияЗаявок =
			ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОбъект.БанковскийСчет, "РазрешитьПлатежиБезУказанияЗаявок")
			Или Не ПолучитьФункциональнуюОпцию("ИспользоватьЗаявкиНаРасходованиеДенежныхСредств");
		Если Не РазрешеныПлатежиБезУказанияЗаявок Тогда
			ДокументОбъект.ОплатаПоЗаявкам = Истина;
		КонецЕсли;
	КонецЕсли;
	
	// сумма документа
	ДокументОбъект.СуммаДокумента = ДанныеЗаполнения.Сумма;
	
	// табл.часть расшифровка
	НовСтрока = ДокументОбъект.РасшифровкаПлатежа.Добавить();
	НовСтрока.ВалютаВзаиморасчетов 	= ДокументОбъект.Валюта;
	НовСтрока.Сумма 				= ДокументОбъект.СуммаДокумента;
	НовСтрока.СуммаВзаиморасчетов 	= ДокументОбъект.СуммаДокумента;
	Если ДанныеЗаполнения.Свойство("СуммаНалогаИтог") Тогда
		НовСтрока.СуммаНДС			= ДанныеЗаполнения.СуммаНалогаИтог;
	КонецЕсли;
	Если ДанныеДляЗагрузки.Свойство("РасшифровкаПлатежа") Тогда
		ДанныеЗаполненияРП = ДанныеДляЗагрузки.РасшифровкаПлатежа;
		Если ДанныеЗаполненияРП.Количество() Тогда
			Если ЗначениеЗаполнено(ДанныеЗаполненияРП[0].СтавкаНДС) Тогда
				НовСтрока.СтавкаНДС	= ДанныеЗаполненияРП[0].СтавкаНДС;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли; 
	
    Если ДанныеЗаполнения.Свойство("Партнер") Тогда
		НовСтрока.Партнер = ДанныеЗаполнения.Партнер;
	КонецЕсли;
	Если ЗначениеЗаполнено(НайденныйДок) Тогда
		НовСтрока.ОбъектРасчетов = ОбъектыРасчетовСервер.ПолучитьОбъектРасчетовПоСсылке(НайденныйДок);
	КонецЕсли;
	
	Попытка
		Если Записывать Тогда
			// запись версии создаваемого документа в подсистеме версионирования
			ДокументОбъект.ОбменДанными.Загрузка = Ложь;
			ВерсионированиеОбъектовСобытия.ЗаписатьВерсиюДокумента(ДокументОбъект, Ложь, РежимЗаписи, РежимПроведенияДокумента.Неоперативный);
			ДокументОбъект.ОбменДанными.Загрузка = Истина;
			// запись версии конец
						
			ДокументОбъект.Записать(РежимЗаписи);
			
			ЗаписатьПрисоединенныеФайлыКДокументуЧерезСервисShare(ДокументОбъект.Ссылка, ДополнительныеДанные);
			ДокументОбъект.Разблокировать();
			ВозвращаемоеЗначение = ДокументОбъект.Ссылка;
		Иначе
			ВозвращаемоеЗначение = ДокументОбъект;
		КонецЕсли;
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка()),
					Текст); 
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка, ДокументОбъект.Метаданные(), СсылкаНаВладельца, 
									ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

Функция НайтиСоздатьРегистрацияЦен(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца = Неопределено, Записывать = Истина) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Текст = "";
	ДанныеДляЗагрузки = ПодготовитьСтруктуруДляРегистрацииЦен(СтрокаДляЗагрузки, ДеревоРазбора);
	
	Если ДанныеДляЗагрузки.Свойство("Шапка") Тогда 
		ДанныеЗаполнения = ДанныеДляЗагрузки.Шапка;
	КонецЕсли; 
	
	РежимЗаписи = РежимЗаписиДокумента.Запись;
	Если ЗначениеЗаполнено(СсылкаНаВладельца) Тогда // получены изменения по существующему документу
		ДокументОбъект = СсылкаНаВладельца.ПолучитьОбъект();
		//Попытка заблокировать документ
		Попытка
			ДокументОбъект.Заблокировать();
		Исключение
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить данные документа ""%1"".
				|Возможно, документ редактируется другим пользователем'"),
				Строка(ДокументОбъект.Ссылка));
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
		//конец попытки заблокировать документ
		Если ДокументОбъект.Проведен Тогда 
			РежимЗаписи = РежимЗаписиДокумента.Проведение;
			Текст = НСтр("ru = 'Операция возможна только для непроведенных документов'");
        КонецЕсли;
	Иначе  // создаем новый
		ДокументОбъект = Документы.РегистрацияЦенНоменклатурыПоставщика.СоздатьДокумент();
		ДокументОбъект.Заполнить(ДанныеЗаполнения);
		ДокументОбъект.Дата = ТекущаяДатаСеанса();
		ДокументОбъект.УстановитьНовыйНомер();
	КонецЕсли;
	ДокументОбъект.ОбменДанными.Загрузка = Истина; 
	
	// вручную переопределим, если требуется
	ПерезаполнениеЗначенийРеквизитовШапки(ДокументОбъект, ДанныеЗаполнения);
	
	ДокументОбъект.Товары.Загрузить(ДанныеДляЗагрузки.Товары);
		
	Попытка
		Если Записывать Тогда
			// запись версии создаваемого документа в подсистеме версионирования
			ДокументОбъект.ОбменДанными.Загрузка = Ложь;
			ВерсионированиеОбъектовСобытия.ЗаписатьВерсиюДокумента(ДокументОбъект, Ложь, РежимЗаписи, РежимПроведенияДокумента.Неоперативный);
			ДокументОбъект.ОбменДанными.Загрузка = Истина;
			// запись версии конец
						
			ДокументОбъект.Записать(РежимЗаписи);
			ДокументОбъект.Разблокировать();			
			ВозвращаемоеЗначение = ДокументОбъект.Ссылка;
		Иначе
			ВозвращаемоеЗначение = ДокументОбъект;
		КонецЕсли;
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка()),
					Текст); 
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка, ДокументОбъект.Метаданные(), СсылкаНаВладельца, 
									ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

Функция НайтиСоздатьЗаказКлиента(СтрокаДляЗагрузки, ДеревоРазбора, ДополнительныеДанные, СсылкаНаВладельца = Неопределено, Записывать = Истина) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если Не ПолучитьФункциональнуюОпцию("ИспользоватьЗаказыКлиентов") Тогда
		Текст = НСтр("ru = 'Для создания документа ""Заказ клиента"" необходимо включить функциональную опцию ""Использовать заказы клиентов""'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);		
		Возврат Неопределено		
	КонецЕсли;
	
	Текст = "";   
	ДанныеДляЗагрузки = ПодготовитьСтруктуруДляЗаказаКлиента(СтрокаДляЗагрузки, ДеревоРазбора);
	
	Если ДанныеДляЗагрузки.Свойство("Шапка") Тогда 
		ДанныеЗаполнения = ДанныеДляЗагрузки.Шапка;
	КонецЕсли; 
			
	РежимЗаписи = РежимЗаписиДокумента.Запись;
	Если ЗначениеЗаполнено(СсылкаНаВладельца) Тогда // получены изменения по существующему документу
		ДокументОбъект = СсылкаНаВладельца.ПолучитьОбъект();
		//Попытка заблокировать документ
		Попытка
			ДокументОбъект.Заблокировать();
		Исключение
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить данные документа ""%1"".
				|Возможно, документ редактируется другим пользователем'"),
				Строка(ДокументОбъект.Ссылка));
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
		//конец попытки заблокировать документ
		Если ДокументОбъект.Проведен Тогда 
			РежимЗаписи = РежимЗаписиДокумента.Проведение;
			Текст = НСтр("ru = 'Операция возможна только для непроведенных документов'");
        КонецЕсли;
	Иначе // попробуем найти по РеквизитыИБ и РеквизитыИБКонтрагента
		НайденныйДок = Неопределено;
		Если ДанныеЗаполнения.Свойство("Контрагент") Тогда
			РеквизитыИБКонтрагента = Новый Структура;
			Если ДанныеЗаполнения.Свойство("НомерПоДаннымКлиента") И ЗначениеЗаполнено(ДанныеЗаполнения.НомерПоДаннымКлиента) Тогда
				РеквизитыИБКонтрагента.Вставить("НомерПоДаннымКлиента", ДанныеЗаполнения.НомерПоДаннымКлиента);
			КонецЕсли;
			Если ДанныеЗаполнения.Свойство("ДатаПоДаннымКлиента") И ЗначениеЗаполнено(ДанныеЗаполнения.ДатаПоДаннымКлиента) Тогда
				РеквизитыИБКонтрагента.Вставить("ДатаПоДаннымКлиента", ДанныеЗаполнения.ДатаПоДаннымКлиента);
			КонецЕсли;
				РеквизитыИБ = Новый Структура;
			Если ДанныеЗаполнения.Свойство("НомерПоДаннымПоставщика") И ЗначениеЗаполнено(ДанныеЗаполнения.НомерПоДаннымПоставщика) Тогда
				РеквизитыИБ.Вставить("Номер", ДанныеЗаполнения.НомерПоДаннымПоставщика);
			КонецЕсли;
			Если ДанныеЗаполнения.Свойство("ДатаПоДаннымПоставщика") И ЗначениеЗаполнено(ДанныеЗаполнения.ДатаПоДаннымПоставщика) Тогда
				РеквизитыИБ.Вставить("Дата", ДанныеЗаполнения.ДатаПоДаннымПоставщика);
			КонецЕсли;
			Если РеквизитыИБ.Количество()>0 ИЛИ РеквизитыИБКонтрагента.Количество()>0 Тогда // есть еще реквизиты поиска, кроме Контрагента
				ТипыДокументов = ОбменСКонтрагентами.ТипыДокументов();				
				НайденныйДок = НайтиДокумент(ТипыДокументов.ЗаказТовара, ДанныеЗаполнения.Контрагент, РеквизитыИБ, РеквизитыИБКонтрагента);
			КонецЕсли;
		КонецЕсли;
		Если Записывать И ЗначениеЗаполнено(НайденныйДок) Тогда // нашли документ, вернем ссылку, чтоб просто привязать ЭД
			ДокументОбъект = НайденныйДок.ПолучитьОбъект();
			//Попытка заблокировать документ
			Попытка
				ДокументОбъект.Заблокировать();
			Исключение
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Не удалось изменить данные документа ""%1"".
					|Возможно, документ редактируется другим пользователем'"),
					Строка(ДокументОбъект.Ссылка));
				ВызватьИсключение ТекстСообщения;
			КонецПопытки;
			//конец попытки заблокировать документ
			Возврат ДокументОбъект.Ссылка;
		КонецЕсли;
		ДокументОбъект = Документы.ЗаказКлиента.СоздатьДокумент();
		ДокументОбъект.Дата = ТекущаяДатаСеанса();
		ДокументОбъект.Автор = Пользователи.АвторизованныйПользователь();
		Если ДанныеЗаполнения.Свойство("ДополнительнаяИнформация") Тогда
			ДанныеЗаполнения.Вставить("ДопИнф", ДанныеЗаполнения.ДополнительнаяИнформация);
			ДанныеЗаполнения.Удалить("ДополнительнаяИнформация");
		КонецЕсли;
		ДокументОбъект.Заполнить(ДанныеЗаполнения);
		Если ДанныеЗаполнения.Свойство("ДопИнф") Тогда
			ДокументОбъект.ДополнительнаяИнформация = ДанныеЗаполнения.ДопИнф;
		КонецЕсли;
		ДокументОбъект.УстановитьНовыйНомер();
	КонецЕсли;
	ДокументОбъект.ОбменДанными.Загрузка = Истина;
	ДокументОбъект.Статус = Перечисления.СтатусыЗаказовКлиентов.НеСогласован;
	// заполнение контрагента
	Если ДанныеЗаполнения.Свойство("Контрагент") Тогда
		ДокументОбъект.Контрагент = ДанныеЗаполнения.Контрагент;
	КонецЕсли;	
		
	// вручную переопределим, если требуется
	ПерезаполнениеЗначенийРеквизитовШапки(ДокументОбъект, ДанныеЗаполнения);
	
	// заполнение соглашения по прайс-листу из торгового предложения
	Если ДанныеЗаполнения.Свойство("ПрайсЛист") Тогда
		ДокументОбъект.Соглашение = ДанныеЗаполнения.ПрайсЛист;
	КонецЕсли;	
	
	// заполнение соглашения по статистике
	Если Не ЗначениеЗаполнено(ДокументОбъект.Соглашение) Тогда
		ЗаполнитьСоглашениеПоСтатистике(ДокументОбъект);
	КонецЕсли;
	
	// заполнение способа доставки
	Если ДанныеЗаполнения.Свойство("СпособДоставки") Тогда
	     СпособДоставки = ДанныеЗаполнения.СпособДоставки;
	     Если СпособДоставки = "Доставка" Тогда
	          ДокументОбъект.СпособДоставки = Перечисления.СпособыДоставки.ДоКлиента;
	     ИначеЕсли СпособДоставки = "Самовывоз" Тогда
	          ДокументОбъект.СпособДоставки = Перечисления.СпособыДоставки.Самовывоз;
	     КонецЕсли;
	КонецЕсли;
	
	// заполнение договора
	Если ЗначениеЗаполнено(ДокументОбъект.Соглашение) И ДанныеЗаполнения.Свойство("ДоговорКонтрагента") Тогда
		Если ДокументОбъект.Соглашение.ИспользуютсяДоговорыКонтрагентов И ЗначениеЗаполнено(ДанныеЗаполнения.ДоговорКонтрагента) Тогда
			ДокументОбъект.Договор = ДанныеЗаполнения.ДоговорКонтрагента;
		КонецЕсли;
	КонецЕсли;

	Для Каждого ТекущаяСтрока Из ДанныеДляЗагрузки.Товары Цикл
		КэшированныеЗначения = ОбработкаТабличнойЧастиКлиентСервер.ПолучитьСтруктуруКэшируемыеЗначения();
		
		СтруктураДействий = Новый Структура;
		СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");
		ОбработкаТабличнойЧастиКлиентСервер.ПересчитатьКоличествоЕдиницВСтрокеТЧ(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения);
	КонецЦикла;	
	
	ДокументОбъект.Товары.Загрузить(ДанныеДляЗагрузки.Товары);
	ДокументОбъект.ЭтапыГрафикаОплаты.Загрузить(ДанныеДляЗагрузки.ЭтапыГрафикаОплаты);
	
	// склады в ТЧ
	СкладГруппа = Справочники.Склады.ЭтоГруппаИСкладыИспользуютсяВТЧДокументовПродажи(ДокументОбъект.Склад);
	СкладыСервер.ЗаполнитьСкладыВТабличнойЧасти(ДокументОбъект.Склад, СкладГруппа, ДокументОбъект.Товары, Истина);
	
	// сумма документа
	Если ДанныеДляЗагрузки.Шапка.Свойство("Сумма") Тогда
		ДокументОбъект.СуммаДокумента = ДанныеДляЗагрузки.Шапка.Сумма;
	КонецЕсли;
	
	Если ДанныеДляЗагрузки.Товары.Итог("СуммаСНДС") = 0 Тогда
		ДокументОбъект.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ОблагаетсяНДСУПокупателя;
	ИначеЕсли ДанныеДляЗагрузки.Товары.Итог("СуммаНДС") = 0 Тогда 
		ДокументОбъект.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС;
	Иначе
		ДокументОбъект.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС;
	КонецЕсли;
	
	Попытка
		Если Записывать Тогда
			// запись версии создаваемого документа в подсистеме версионирования
			ДокументОбъект.ОбменДанными.Загрузка = Ложь;
			ВерсионированиеОбъектовСобытия.ЗаписатьВерсиюДокумента(ДокументОбъект, Ложь, РежимЗаписи, РежимПроведенияДокумента.Неоперативный);
			ДокументОбъект.ОбменДанными.Загрузка = Истина;
			// запись версии конец
						
			ДокументОбъект.Записать(РежимЗаписи);
			
			ЗаписатьПрисоединенныеФайлыКДокументуЧерезСервисShare(ДокументОбъект.Ссылка, ДополнительныеДанные);
			ДокументОбъект.Разблокировать();
			ВозвращаемоеЗначение = ДокументОбъект.Ссылка;
			
			//Запись в Реестр документов
			ТаблицыДанных = ПроведениеДокументов.ДанныеДокументаДляПроведения(ВозвращаемоеЗначение, "РеестрДокументов");
			РегистрыСведений.РеестрДокументов.ЗаписатьДанные(ТаблицыДанных, ВозвращаемоеЗначение,  Неопределено, Ложь);
		Иначе
			ВозвращаемоеЗначение = ДокументОбъект;
		КонецЕсли;
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка()),
					Текст); 
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка, ДокументОбъект.Метаданные(), СсылкаНаВладельца, 
									ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));		
		ВызватьИсключение;
	КонецПопытки;
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

Функция НайтиСоздатьЗаказПоставщику(СтрокаДляЗагрузки, ДеревоРазбора, ДополнительныеДанные, СсылкаНаВладельца = Неопределено, Записывать = Истина) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если Не ПолучитьФункциональнуюОпцию("ИспользоватьЗаказыПоставщикам") Тогда
		Текст = НСтр("ru = 'Для создания документа ""Заказ поставщику"" необходимо включить функциональную опцию ""Использовать заказы поставщикам""'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);		
		Возврат Неопределено		
	КонецЕсли;
	
	Текст = "";
	ДанныеДляЗагрузки = ПодготовитьСтруктуруДляЗаказаПоставщику(СтрокаДляЗагрузки, ДеревоРазбора);
	
	Если ДанныеДляЗагрузки.Свойство("Шапка") Тогда 
		ДанныеЗаполнения = ДанныеДляЗагрузки.Шапка;
	КонецЕсли; 
	
	РежимЗаписи = РежимЗаписиДокумента.Запись;
	Если ЗначениеЗаполнено(СсылкаНаВладельца) Тогда // получены изменения по существующему документу
		ДокументОбъект = СсылкаНаВладельца.ПолучитьОбъект();
		//Попытка заблокировать документ
		Попытка
			ДокументОбъект.Заблокировать();
		Исключение
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить данные документа ""%1"".
				|Возможно, документ редактируется другим пользователем'"),
				Строка(ДокументОбъект.Ссылка));
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
		//конец попытки заблокировать документ
		Если ДокументОбъект.Проведен Тогда 
			РежимЗаписи = РежимЗаписиДокумента.Проведение;
			Текст = НСтр("ru = 'Операция возможна только для непроведенных документов'");
		КонецЕсли;
	Иначе // попробуем найти по РеквизитыИБ и РеквизитыИБКонтрагента
		НайденныйДок = Неопределено;
		Если ДанныеЗаполнения.Свойство("Контрагент") Тогда
			РеквизитыИБКонтрагента = Новый Структура;
			Если ДанныеЗаполнения.Свойство("НомерПоДаннымПоставщика") И ЗначениеЗаполнено(ДанныеЗаполнения.НомерПоДаннымПоставщика) Тогда
				РеквизитыИБКонтрагента.Вставить("НомерПоДаннымПоставщика", ДанныеЗаполнения.НомерПоДаннымПоставщика);
			КонецЕсли;
			Если ДанныеЗаполнения.Свойство("ДатаПоДаннымПоставщика") И ЗначениеЗаполнено(ДанныеЗаполнения.ДатаПоДаннымПоставщика) Тогда
				РеквизитыИБКонтрагента.Вставить("ДатаПоДаннымПоставщика", ДанныеЗаполнения.ДатаПоДаннымПоставщика);
			КонецЕсли;
			РеквизитыИБ = Новый Структура;
			Если ДанныеЗаполнения.Свойство("НомерПоДаннымКлиента") И ЗначениеЗаполнено(ДанныеЗаполнения.НомерПоДаннымКлиента) Тогда
				РеквизитыИБ.Вставить("Номер", ДанныеЗаполнения.НомерПоДаннымКлиента);
			КонецЕсли;
			Если ДанныеЗаполнения.Свойство("ДатаПоДаннымКлиента") И ЗначениеЗаполнено(ДанныеЗаполнения.ДатаПоДаннымКлиента) Тогда
				РеквизитыИБ.Вставить("Дата", ДанныеЗаполнения.ДатаПоДаннымКлиента);
			КонецЕсли;
			Если РеквизитыИБ.Количество()>0 ИЛИ РеквизитыИБКонтрагента.Количество()>0 Тогда // есть еще реквизиты поиска, кроме Контрагента
				ТипыДокументов = ОбменСКонтрагентами.ТипыДокументов();				
				НайденныйДок = НайтиДокумент(ТипыДокументов.ОтветНаЗаказ, ДанныеЗаполнения.Контрагент, РеквизитыИБ, РеквизитыИБКонтрагента);
			КонецЕсли;
		КонецЕсли;
		Если Записывать И ЗначениеЗаполнено(НайденныйДок) Тогда // нашли документ, вернем ссылку, чтоб просто привязать ЭД
			ДокументОбъект = НайденныйДок.ПолучитьОбъект();
			//Попытка заблокировать документ
			Попытка
				ДокументОбъект.Заблокировать();
			Исключение
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Не удалось изменить данные документа ""%1"".
					|Возможно, документ редактируется другим пользователем'"),
					Строка(ДокументОбъект.Ссылка));
				ВызватьИсключение ТекстСообщения;
			КонецПопытки;
			//конец попытки заблокировать документ
			Возврат ДокументОбъект.Ссылка;
		КонецЕсли;
		ДокументОбъект = Документы.ЗаказПоставщику.СоздатьДокумент();
		ДокументОбъект.Дата = ТекущаяДатаСеанса();
		ДокументОбъект.Автор = Пользователи.АвторизованныйПользователь();
		ДокументОбъект.Заполнить(ДанныеЗаполнения);
		ДокументОбъект.УстановитьНовыйНомер();
	КонецЕсли;
	ДокументОбъект.ОбменДанными.Загрузка = Истина;
	Если ПолучитьФункциональнуюОпцию("ИспользоватьСтатусыЗаказовПоставщикам") Тогда
		ДокументОбъект.Статус = Перечисления.СтатусыЗаказовПоставщикам.НеСогласован;
	КонецЕсли;
	// заполнение контрагента
	Если ДанныеЗаполнения.Свойство("Контрагент") Тогда
		ДокументОбъект.Контрагент = ДанныеЗаполнения.Контрагент;
	КонецЕсли;	

	// заполнение данных поставщика
	Если ДанныеЗаполнения.Свойство("Номер") Тогда
		ДокументОбъект.НомерПоДаннымПоставщика = ДанныеЗаполнения.Номер;
	КонецЕсли;	
	Если ДанныеЗаполнения.Свойство("Дата") Тогда
		ДокументОбъект.ДатаПоДаннымПоставщика = ДанныеЗаполнения.Дата;
	КонецЕсли;	
	
	// заполнение реквизита ЗакупкаПодДеятельность
	ПараметрыЗаполнения = Документы.ЗаказПоставщику.ПараметрыЗаполненияВидаДеятельностиНДС(ДокументОбъект);
	УчетНДСУП.ЗаполнитьВидДеятельностиНДС(ДокументОбъект.ЗакупкаПодДеятельность, ПараметрыЗаполнения);
	
	// вручную переопределим, если требуется
	ПерезаполнениеЗначенийРеквизитовШапки(ДокументОбъект, ДанныеЗаполнения);
	
	// заполнение соглашения по статистике
	Если Не ЗначениеЗаполнено(ДокументОбъект.Соглашение) Тогда
		ЗаполнитьСоглашениеПоСтатистике(ДокументОбъект);
	КонецЕсли;
	
	// заполнение способа доставки
	Если ДанныеЗаполнения.Свойство("СпособДоставки") Тогда
	     СпособДоставки = ДанныеЗаполнения.СпособДоставки;
	     Если СпособДоставки = "Доставка" Тогда
	          ДокументОбъект.СпособДоставки = Перечисления.СпособыДоставки.СиламиПоставщикаДоНашегоСклада;
	     ИначеЕсли СпособДоставки = "Самовывоз" Тогда
	          ДокументОбъект.СпособДоставки = Перечисления.СпособыДоставки.НашимиСиламиСАдресаОтправителя;
	     КонецЕсли;
	КонецЕсли;
	
	// заполнение договора
	Если ЗначениеЗаполнено(ДокументОбъект.Соглашение) И ДанныеЗаполнения.Свойство("ДоговорКонтрагента") Тогда
		Если ДокументОбъект.Соглашение.ИспользуютсяДоговорыКонтрагентов И ЗначениеЗаполнено(ДанныеЗаполнения.ДоговорКонтрагента) Тогда
			ДокументОбъект.Договор = ДанныеЗаполнения.ДоговорКонтрагента;
		КонецЕсли;
	КонецЕсли;

	Для Каждого ТекущаяСтрока Из ДанныеДляЗагрузки.Товары Цикл
		КэшированныеЗначения = ОбработкаТабличнойЧастиКлиентСервер.ПолучитьСтруктуруКэшируемыеЗначения();
		
		СтруктураДействий = Новый Структура;
		СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");
		ОбработкаТабличнойЧастиКлиентСервер.ПересчитатьКоличествоЕдиницВСтрокеТЧ(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения);
	КонецЦикла;
	
	ДокументОбъект.Товары.Загрузить(ДанныеДляЗагрузки.Товары);
	
	Если ДанныеЗаполнения.Свойство("Партнер") Тогда
		Если ЗначениеЗаполнено(ДанныеЗаполнения.Партнер) Тогда
			НоменклатураПартнеровСервер.ЗаполнитьНоменклатуруПартнераПоНоменклатуреВТаблице(ДокументОбъект.Товары, ДанныеЗаполнения.Партнер);
		КонецЕсли;
	КонецЕсли;
	
	Если ДанныеДляЗагрузки.Товары.Итог("СуммаСНДС") = 0 Тогда
		ДокументОбъект.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ОблагаетсяНДСУПокупателя;
	ИначеЕсли ДанныеДляЗагрузки.Товары.Итог("СуммаНДС") = 0 Тогда 
		ДокументОбъект.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС;
	Иначе
		ДокументОбъект.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС;
	КонецЕсли;
	
	ДокументОбъект.ЭтапыГрафикаОплаты.Загрузить(ДанныеДляЗагрузки.ЭтапыГрафикаОплаты);
	
	// склады в ТЧ
	СкладГруппа = Справочники.Склады.ЭтоГруппаИСкладыИспользуютсяВТЧДокументовЗакупки(ДокументОбъект.Склад);
	СкладыСервер.ЗаполнитьСкладыВТабличнойЧасти(ДокументОбъект.Склад, СкладГруппа, ДокументОбъект.Товары, Истина);
	
	// сумма документа
	ДокументОбъект.СуммаДокумента = ЦенообразованиеКлиентСервер.ПолучитьСуммуДокумента(ДокументОбъект.Товары, ДокументОбъект.ЦенаВключаетНДС);
	
	Попытка
		Если Записывать Тогда
			// запись версии создаваемого документа в подсистеме версионирования
			ДокументОбъект.ОбменДанными.Загрузка = Ложь;
			ВерсионированиеОбъектовСобытия.ЗаписатьВерсиюДокумента(ДокументОбъект, Ложь, РежимЗаписи, РежимПроведенияДокумента.Неоперативный);
			ДокументОбъект.ОбменДанными.Загрузка = Истина;
			// запись версии конец
						
			ДокументОбъект.Записать(РежимЗаписи);
			
			ЗаписатьПрисоединенныеФайлыКДокументуЧерезСервисShare(ДокументОбъект.Ссылка, ДополнительныеДанные);
			ДокументОбъект.Разблокировать();
			ВозвращаемоеЗначение = ДокументОбъект.Ссылка;
			
			//Запись в Реестр документов
			ТаблицыДанных = ПроведениеДокументов.ДанныеДокументаДляПроведения(ВозвращаемоеЗначение, "РеестрДокументов");
			РегистрыСведений.РеестрДокументов.ЗаписатьДанные(ТаблицыДанных, ВозвращаемоеЗначение,  Неопределено, Ложь);
		Иначе
			ВозвращаемоеЗначение = ДокументОбъект;
		КонецЕсли;
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка()),
					Текст);
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка, ДокументОбъект.Метаданные(), СсылкаНаВладельца,
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

Функция НайтиСоздатьОтчетКомиссионера(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца = Неопределено, Записывать = Истина) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Текст = "";
	ДанныеДляЗагрузки = ПодготовитьСтруктуруДляОтчетаКомиссионера(СтрокаДляЗагрузки, ДеревоРазбора);
	
	Если ДанныеДляЗагрузки.Свойство("Шапка") Тогда 
		ДанныеЗаполнения = ДанныеДляЗагрузки.Шапка;
	КонецЕсли; 
	
	РежимЗаписи = РежимЗаписиДокумента.Запись;
	Если ЗначениеЗаполнено(СсылкаНаВладельца) Тогда // получены изменения по существующему документу
		ДокументОбъект = СсылкаНаВладельца.ПолучитьОбъект();
		//Попытка заблокировать документ
		Попытка
			ДокументОбъект.Заблокировать();
		Исключение
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить данные документа ""%1"".
				|Возможно, документ редактируется другим пользователем'"),
				Строка(ДокументОбъект.Ссылка));
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
		//конец попытки заблокировать документ
		Если ДокументОбъект.Проведен Тогда 
			РежимЗаписи = РежимЗаписиДокумента.Проведение;
			Текст = НСтр("ru = 'Операция возможна только для непроведенных документов'");
        КонецЕсли;
	Иначе  // создаем новый
		ДокументОбъект = Документы.ОтчетКомиссионера.СоздатьДокумент();
		ДокументОбъект.Дата = ТекущаяДатаСеанса();
		ДокументОбъект.Заполнить(ДанныеЗаполнения);
		ДокументОбъект.УстановитьНовыйНомер();
	КонецЕсли;
	ДокументОбъект.ОбменДанными.Загрузка = Истина; 
	// заполнение контрагента
	Если ДанныеЗаполнения.Свойство("Контрагент") Тогда
		ДокументОбъект.Контрагент = ДанныеЗаполнения.Контрагент;
	КонецЕсли;	
	
	// вручную переопределим, если требуется
	ПерезаполнениеЗначенийРеквизитовШапки(ДокументОбъект, ДанныеЗаполнения);
	
	// заполнение соглашения по статистике
	Если Не ЗначениеЗаполнено(ДокументОбъект.Соглашение) Тогда
		ЗаполнитьСоглашениеПоСтатистике(ДокументОбъект);
	КонецЕсли;
	
	ДокументОбъект.Товары.Загрузить(ДанныеДляЗагрузки.Товары);
	
	Для Каждого Строка ИЗ ДокументОбъект.Товары Цикл
		Строка.Сумма = Строка.СуммаСНДС - Строка.СуммаНДС;
	КонецЦикла;	
	
	ДокументОбъект.ЭтапыГрафикаОплаты.Загрузить(ДанныеДляЗагрузки.ЭтапыГрафикаОплаты);
	
	Попытка
		Если Записывать Тогда
			// запись версии создаваемого документа в подсистеме версионирования
			ДокументОбъект.ОбменДанными.Загрузка = Ложь;
			ВерсионированиеОбъектовСобытия.ЗаписатьВерсиюДокумента(ДокументОбъект, Ложь, РежимЗаписи, РежимПроведенияДокумента.Неоперативный);
			ДокументОбъект.ОбменДанными.Загрузка = Истина;
			// запись версии конец
						
			ДокументОбъект.Записать(РежимЗаписи);
			ДокументОбъект.Разблокировать();			
			ВозвращаемоеЗначение = ДокументОбъект.Ссылка;
			
			//Запись в Реестр документов
			ТаблицыДанных = ПроведениеДокументов.ДанныеДокументаДляПроведения(ДокументОбъект.Ссылка, "РеестрДокументов");
			РегистрыСведений.РеестрДокументов.ЗаписатьДанные(ТаблицыДанных, ДокументОбъект.Ссылка, Неопределено, Ложь);
		Иначе
			ВозвращаемоеЗначение = ДокументОбъект;
		КонецЕсли;
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка()),
					Текст); 
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка, ДокументОбъект.Метаданные(), СсылкаНаВладельца, 
									ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

Функция НайтиСоздатьОтчетКомиссионераОСписании(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца = Неопределено, Записывать = Истина) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Текст = "";
	ДанныеДляЗагрузки = ПодготовитьСтруктуруДляОтчетаКомиссионераОСписании(СтрокаДляЗагрузки, ДеревоРазбора);
	
	Если ДанныеДляЗагрузки.Свойство("Шапка") Тогда 
		ДанныеЗаполнения = ДанныеДляЗагрузки.Шапка;
	КонецЕсли; 
	
	РежимЗаписи = РежимЗаписиДокумента.Запись;
	Если ЗначениеЗаполнено(СсылкаНаВладельца) Тогда // получены изменения по существующему документу
		ДокументОбъект = СсылкаНаВладельца.ПолучитьОбъект();
		//Попытка заблокировать документ
		Попытка
			ДокументОбъект.Заблокировать();
		Исключение
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить данные документа ""%1"".
				|Возможно, документ редактируется другим пользователем'"),
				Строка(ДокументОбъект.Ссылка));
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
		//конец попытки заблокировать документ
		Если ДокументОбъект.Проведен Тогда 
			РежимЗаписи = РежимЗаписиДокумента.Проведение;
			Текст = НСтр("ru = 'Операция возможна только для непроведенных документов'");
        КонецЕсли;
	Иначе  // создаем новый
		ДокументОбъект = Документы.ОтчетКомиссионераОСписании.СоздатьДокумент();
		ДокументОбъект.Дата = ТекущаяДатаСеанса();
		ДокументОбъект.Заполнить(ДанныеЗаполнения);
		ДокументОбъект.УстановитьНовыйНомер();
	КонецЕсли;
	ДокументОбъект.ОбменДанными.Загрузка = Истина; 
	// заполнение контрагента
	Если ДанныеЗаполнения.Свойство("Контрагент") Тогда
		ДокументОбъект.Контрагент = ДанныеЗаполнения.Контрагент;
	КонецЕсли;	
	
	// вручную переопределим, если требуется
	ПерезаполнениеЗначенийРеквизитовШапки(ДокументОбъект, ДанныеЗаполнения);
	
	// заполнение соглашения по статистике
	Если Не ЗначениеЗаполнено(ДокументОбъект.Соглашение) Тогда
		ЗаполнитьСоглашениеПоСтатистике(ДокументОбъект);
	КонецЕсли;
	
	ДокументОбъект.Товары.Загрузить(ДанныеДляЗагрузки.Товары);
		
	// сумма документа
	ДокументОбъект.СуммаДокумента = ЦенообразованиеКлиентСервер.ПолучитьСуммуДокумента(ДокументОбъект.Товары, ДокументОбъект.ЦенаВключаетНДС);
	
	Попытка
		Если Записывать Тогда
			// запись версии создаваемого документа в подсистеме версионирования
			ДокументОбъект.ОбменДанными.Загрузка = Ложь;
			ВерсионированиеОбъектовСобытия.ЗаписатьВерсиюДокумента(ДокументОбъект, Ложь, РежимЗаписи, РежимПроведенияДокумента.Неоперативный);
			ДокументОбъект.ОбменДанными.Загрузка = Истина;
			// запись версии конец
						
			ДокументОбъект.Записать(РежимЗаписи);
			ДокументОбъект.Разблокировать();			
			ВозвращаемоеЗначение = ДокументОбъект.Ссылка;
			
			//Запись в Реестр документов
			ТаблицыДанных = ПроведениеДокументов.ДанныеДокументаДляПроведения(ДокументОбъект.Ссылка, "РеестрДокументов");
			РегистрыСведений.РеестрДокументов.ЗаписатьДанные(ТаблицыДанных, ДокументОбъект.Ссылка, Неопределено, Ложь);
		Иначе
			ВозвращаемоеЗначение = ДокументОбъект;
		КонецЕсли;
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка()),
					Текст); 
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка, ДокументОбъект.Метаданные(), СсылкаНаВладельца, 
									ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));		
		ВызватьИсключение;
	КонецПопытки;
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

Функция НайтиСоздатьКорректировкуПоступления(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца = Неопределено, Записывать = Истина) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	ДанныеДляЗагрузки = ПодготовитьСтруктуруДляКорректировкиПоступления(СтрокаДляЗагрузки, ДеревоРазбора);
	
	Документ = СсылкаНаВладельца;
	ЗаполнитьДокументКорректировкиПоступления(Документ, ДанныеДляЗагрузки, Записывать);
	
	Возврат Документ;
	
КонецФункции

Процедура ЗаполнитьДокументПриобретенияТоваровУслуг(Документ, ДанныеДляЗагрузки, Записывать) Экспорт
	
	Текст = "";
	Если ДанныеДляЗагрузки.Свойство("Шапка") Тогда 
		ДанныеЗаполнения = ДанныеДляЗагрузки.Шапка;
	КонецЕсли; 
	
	РежимЗаписи = РежимЗаписиДокумента.Запись;
	Если ЗначениеЗаполнено(Документ) Тогда // получены изменения по существующему документу
		ДокументОбъект = Документ.ПолучитьОбъект();
		//Попытка заблокировать документ
		Попытка
			ДокументОбъект.Заблокировать();
		Исключение
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить данные документа ""%1"".
				|Возможно, документ редактируется другим пользователем'"),
				Строка(ДокументОбъект.Ссылка));
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
		//конец попытки заблокировать документ
		Если ДокументОбъект.Проведен Тогда 
			РежимЗаписи = РежимЗаписиДокумента.Проведение;
			Текст = НСтр("ru = 'Операция возможна только для непроведенных документов'");
		КонецЕсли;
	Иначе  // создаем новый
		ДокументОбъект = Документы.ПриобретениеТоваровУслуг.СоздатьДокумент();
		ДокументОбъект.Дата = ТекущаяДатаСеанса();
		ДокументОбъект.Автор = Пользователи.АвторизованныйПользователь();
		ДокументОбъект.Заполнить(ДанныеЗаполнения);
		ДокументОбъект.УстановитьНовыйНомер();
	КонецЕсли;
	ДокументОбъект.ОбменДанными.Загрузка = Истина;
	
	РеквизитыИБКонтрагента = Новый Структура;
	
	// попробуем найти заказ поставщику
	ТипыДокументов = ОбменСКонтрагентами.ТипыДокументов();
	НайденныйДок = Неопределено;
	Если ДанныеЗаполнения.Свойство("Контрагент") Тогда
		ДокументОбъект.Контрагент = ДанныеЗаполнения.Контрагент;
		Если ДанныеЗаполнения.Свойство("НомерПоДаннымПоставщика") И ЗначениеЗаполнено(ДанныеЗаполнения.НомерПоДаннымПоставщика) Тогда
			РеквизитыИБКонтрагента.Вставить("НомерПоДаннымПоставщика", ДанныеЗаполнения.НомерПоДаннымПоставщика);
		КонецЕсли;
		Если ДанныеЗаполнения.Свойство("ДатаПоДаннымПоставщика") И ЗначениеЗаполнено(ДанныеЗаполнения.ДатаПоДаннымПоставщика) Тогда
			РеквизитыИБКонтрагента.Вставить("ДатаПоДаннымПоставщика", ДанныеЗаполнения.ДатаПоДаннымПоставщика);
		КонецЕсли;
		РеквизитыИБ = Новый Структура;
		Если ДанныеЗаполнения.Свойство("НомерПоДаннымКлиента") И ЗначениеЗаполнено(ДанныеЗаполнения.НомерПоДаннымКлиента) Тогда
			РеквизитыИБ.Вставить("Номер", ДанныеЗаполнения.НомерПоДаннымКлиента);
		КонецЕсли;
		Если ДанныеЗаполнения.Свойство("ДатаПоДаннымКлиента") И ЗначениеЗаполнено(ДанныеЗаполнения.ДатаПоДаннымКлиента) Тогда
			РеквизитыИБ.Вставить("Дата", ДанныеЗаполнения.ДатаПоДаннымКлиента);
		КонецЕсли;
		Если РеквизитыИБ.Количество() > 0 ИЛИ РеквизитыИБКонтрагента.Количество() > 0 Тогда // есть еще реквизиты поиска, кроме Контрагента
			НайденныйДок = НайтиДокумент(ТипыДокументов.ОтветНаЗаказ, ДанныеЗаполнения.Контрагент, РеквизитыИБ, РеквизитыИБКонтрагента);
		КонецЕсли;
	КонецЕсли;
	
	Если ДанныеЗаполнения.Свойство("ОбстоятельстваФормированияСФ") И ЗначениеЗаполнено(ДанныеЗаполнения.ОбстоятельстваФормированияСФ) Тогда
		Если ДанныеЗаполнения.ОбстоятельстваФормированияСФ = "4" Тогда
			ДокументОбъект.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПриемНаКомиссию
		КонецЕсли;	
	КонецЕсли;
	
	// заполнение договора
	Если ЗначениеЗаполнено(ДокументОбъект.Контрагент) И ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСПоставщиками") Тогда
		ДопПараметры = ЗакупкиСервер.ДополнительныеПараметрыОтбораДоговоров();
		ДопПараметры.ВалютаВзаиморасчетов = ДанныеЗаполнения.Валюта;
		Если ЗначениеЗаполнено(ДокументОбъект.ХозяйственнаяОперация) Тогда
			ХозяйственнаяОперацияДоговора = ДокументОбъект.ХозяйственнаяОперация;
		Иначе
			ХозяйственнаяОперацияДоговора = Перечисления.ХозяйственныеОперации.ЗакупкаУПоставщика
		КонецЕсли;
		ДокументОбъект.Договор = ЗакупкиСервер.ПолучитьДоговорПоУмолчанию(ДокументОбъект, ХозяйственнаяОперацияДоговора, ДопПараметры);
	КонецЕсли;
	
	// Заполнение партнера, если контрагент создается новый.
	ПартнерКонтрагента = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОбъект.Контрагент, "Партнер"); 
	Если Не ЗначениеЗаполнено(ДокументОбъект.Партнер) И ЗначениеЗаполнено(ПартнерКонтрагента) Тогда
		ДокументОбъект.Партнер = ПартнерКонтрагента;
	КонецЕсли;
	
	ДокументОбъект.ЗаказПоставщику = НайденныйДок;
	
	Если ЗначениеЗаполнено(НайденныйДок) Тогда
		ДокументОбъект.ПоступлениеПоЗаказам = Истина;
	КонецЕсли;

	// заполнение реквизита ЗакупкаПодДеятельность
	ПараметрыЗаполнения = Документы.ПриобретениеТоваровУслуг.ПараметрыЗаполненияВидаДеятельностиНДС(ДокументОбъект);
	УчетНДСУП.ЗаполнитьВидДеятельностиНДС(ДокументОбъект.ЗакупкаПодДеятельность, ПараметрыЗаполнения);

	// вручную переопределим, если требуется
	ПерезаполнениеЗначенийРеквизитовШапки(ДокументОбъект, ДанныеЗаполнения);
	
	// заполнение соглашения по статистике
	Если Не ЗначениеЗаполнено(ДокументОбъект.Соглашение) Тогда
		ЗаполнитьСоглашениеПоСтатистике(ДокументОбъект);
	КонецЕсли;
	
	ЕстьЗаказВТЧ = Ложь;
	Для Каждого Строка Из ДанныеДляЗагрузки.Товары Цикл
		РеквизитыИБ = Новый Структура;
		Если ЗначениеЗаполнено(Строка.НомерПоДаннымКлиента) Тогда
			РеквизитыИБ.Вставить("Номер", Строка.НомерПоДаннымКлиента);
		КонецЕсли;
		Если ЗначениеЗаполнено(Строка.ДатаПоДаннымКлиента) Тогда
			РеквизитыИБ.Вставить("Дата", Строка.ДатаПоДаннымКлиента);
		КонецЕсли;
		Если РеквизитыИБ.Количество() > 0 ИЛИ РеквизитыИБКонтрагента.Количество() > 0 Тогда // есть еще реквизиты поиска, кроме Контрагента
			Строка.ЗаказПоставщику = НайтиДокумент(ТипыДокументов.ОтветНаЗаказ, ДокументОбъект.Контрагент, РеквизитыИБ);
			ЕстьЗаказВТЧ = Истина;
		КонецЕсли;
		Если ЗначениеЗаполнено(ДокументОбъект.Соглашение) Тогда
			Если ЗначениеЗаполнено(ДокументОбъект.Соглашение.ВидЦеныПоставщика) Тогда
				Строка.ВидЦеныПоставщика = ДокументОбъект.Соглашение.ВидЦеныПоставщика;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	ДокументОбъект.Товары.Загрузить(ДанныеДляЗагрузки.Товары);
	
	Если ЗначениеЗаполнено(ДокументОбъект.Партнер) Тогда
		НоменклатураПартнеровСервер.ЗаполнитьНоменклатуруПартнераПоНоменклатуреВТаблице(ДокументОбъект.Товары, ДокументОбъект.Партнер);
	КонецЕсли;
	
	Если ДанныеДляЗагрузки.Свойство("ШтрихкодыУпаковок") Тогда 
		ДокументОбъект.ШтрихкодыУпаковок.Загрузить(ДанныеДляЗагрузки.ШтрихкодыУпаковок);
		Если ЗначениеЗаполнено(Документ) Тогда// получены изменения по существующему документу 
			ЭлектронноеВзаимодействиеИСМП.ОчиститьРезультатыПроверкиДокументаПриЗагрузкеДокумента(Документ);
		КонецЕсли;
	КонецЕсли;
	
	Отказ = Ложь;
	
	НоменклатураПартнеровСервер.ЗаполнитьПустоеСопоставлениеВНоменклатуреПартнераПоНоменклатуреИБ(ДокументОбъект.Товары, Отказ);
	
	Если ЕстьЗаказВТЧ Тогда
		ДанныеДляЗагрузки.Товары.Свернуть("ЗаказПоставщику");
		Если ДанныеДляЗагрузки.Товары.Количество()>1 Тогда
			ДокументОбъект.ПоступлениеПоЗаказам=Истина;
			ДанныеПривязки = ПолучитьДанныеПривязкиСтрокЗаказов(ДокументОбъект.Товары.Выгрузить(,"Номенклатура, Количество, ЗаказПоставщику"));
			индекс = 0;
			Для Каждого Строка ИЗ ДанныеПривязки Цикл
				ДокСтрокаТовары = документОбъект.Товары.Получить(Индекс);
				ЗаполнитьЗначенияСвойств(ДокСтрокаТовары, Строка);
				Если НЕ ЗначениеЗаполнено(ДокСтрокаТовары.КодСтроки) ИЛИ ДокСтрокаТовары.КодСтроки = 0 Тогда
					ДокСтрокаТовары.ЗаказПоставщику = Документы.ЗаказПоставщику.ПустаяСсылка();
				КонецЕсли;
				Индекс = индекс + 1;
			КонецЦикла
		ИначеЕсли ДанныеДляЗагрузки.Товары.Количество()=1 Тогда
			ДокументОбъект.ЗаказПоставщику = ДанныеДляЗагрузки.Товары[0].ЗаказПоставщику;
		КонецЕсли
	КонецЕсли;
	
	// склады в ТЧ
	СкладГруппа = Справочники.Склады.ЭтоГруппаИСкладыИспользуютсяВТЧДокументовЗакупки(ДокументОбъект.Склад);
	СкладыСервер.ЗаполнитьСкладыВТабличнойЧасти(ДокументОбъект.Склад, СкладГруппа, ДокументОбъект.Товары, Истина);
	
	// заполнение реквизита ВариантПриемкиТоваров
	Если ЗначениеЗаполнено(ДокументОбъект.Договор) Тогда
		Распоряжение = РаспоряжениеДляПолученияВариантаПриемкиТоваров(ДокументОбъект);		
		ДокументОбъект.ВариантПриемкиТоваров = ЗакупкиСервер.ПолучитьВариантПриемкиТоваров(Распоряжение, ДокументОбъект.Договор);
		Если ЗначениеЗаполнено(ДокументОбъект.Договор.ПорядокРасчетов) Тогда
			 ДокументОбъект.ПорядокРасчетов = ДокументОбъект.Договор.ПорядокРасчетов;
		КонецЕсли;
	КонецЕсли;
		
	Если ДанныеЗаполнения.Свойство("Сумма") И ДанныеЗаполнения.Сумма = 0 Тогда
		ДокументОбъект.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ОблагаетсяНДСУПокупателя;
	ИначеЕсли ДокументОбъект.Товары.Итог("СуммаНДС") = 0 Тогда
		ДокументОбъект.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС;
	Иначе
		ДокументОбъект.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС;
	КонецЕсли;
	
	Для Каждого Строка Из ДокументОбъект.Товары Цикл 
		Если ДокументОбъект.ЦенаВключаетНДС И Строка.Сумма <> Строка.СуммаСНДС Тогда
			Строка.Сумма = Строка.СуммаСНДС;
			Если Строка.Количество <> 0 Тогда
				Строка.Цена = Окр(Строка.Сумма/Строка.Количество, 2);
			Иначе
				Строка.Цена = Строка.Сумма;
			КонецЕсли;
		КонецЕсли;
		
		// Проверка заполнения партнера в номенклатуре поставщика 
		Если ЗначениеЗаполнено(ДокументОбъект.Партнер) И ЗначениеЗаполнено(Строка.НоменклатураПартнера)
			И НЕ ЗначениеЗаполнено(Строка.НоменклатураПартнера.Владелец) Тогда
				НоменклатураПартнераОбъект = Строка.НоменклатураПартнера.ПолучитьОбъект();
				Попытка 
					НоменклатураПартнераОбъект.Заблокировать();
				Исключение
					ТекстИсключенияЗаписи = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Не удалось изменить данные номенклатуры поставщика ""%1"".
					|Возможно, номенклатура поставщика редактируется другим пользователем'"),
					НоменклатураПартнераОбъект.Наименование);			
					ВызватьИсключение ТекстИсключенияЗаписи;
				КонецПопытки;
				НоменклатураПартнераОбъект.Владелец = ДокументОбъект.Партнер;
				НоменклатураПартнераОбъект.Записать();
				НоменклатураПартнераОбъект.Разблокировать();
		КонецЕсли;		
	КонецЦикла;

	// сумма документа
	ДокументОбъект.СуммаДокумента = ЦенообразованиеКлиентСервер.ПолучитьСуммуДокумента(ДокументОбъект.Товары, ДокументОбъект.ЦенаВключаетНДС);
	
	Попытка
		Если Записывать Тогда
			// запись версии создаваемого документа в подсистеме версионирования
			ДокументОбъект.ОбменДанными.Загрузка = Ложь;
			ВерсионированиеОбъектовСобытия.ЗаписатьВерсиюДокумента(ДокументОбъект, Отказ, РежимЗаписи, РежимПроведенияДокумента.Неоперативный);
			ДокументОбъект.ОбменДанными.Загрузка = Истина;
			// запись версии конец
						
			ДокументОбъект.Записать(РежимЗаписи);
			ДокументОбъект.Разблокировать();
			Документ = ДокументОбъект.Ссылка;
			
			//Запись в Реестр документов
			ТаблицыДанных = ПроведениеДокументов.ДанныеДокументаДляПроведения(Документ, "РеестрДокументов");
			РегистрыСведений.РеестрДокументов.ЗаписатьДанные(ТаблицыДанных, Документ,  Неопределено, Ложь);
		Иначе
			Документ = ДокументОбъект;
		КонецЕсли;
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка()),
					Текст);
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка, ДокументОбъект.Метаданные(), Документ, 
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;
	
КонецПроцедуры

Процедура ЗаполнитьДокументПоступленияУслуг(Документ, ДанныеДляЗагрузки, Записывать) Экспорт
	
	Текст = "";
	Если ДанныеДляЗагрузки.Свойство("Шапка") Тогда
		ДанныеЗаполнения = ДанныеДляЗагрузки.Шапка;
	КонецЕсли;
	
	РежимЗаписи = РежимЗаписиДокумента.Запись;
	Если ЗначениеЗаполнено(Документ) Тогда // получены изменения по существующему документу
		ДокументОбъект = Документ.ПолучитьОбъект();
		//Попытка заблокировать документ
		Попытка
			ДокументОбъект.Заблокировать();
		Исключение
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить данные документа ""%1"".
				|Возможно, документ редактируется другим пользователем'"),
				Строка(ДокументОбъект.Ссылка));
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
		//конец попытки заблокировать документ
		Если ДокументОбъект.Проведен Тогда
			РежимЗаписи = РежимЗаписиДокумента.Проведение;
			Текст = НСтр("ru = 'Операция возможна только для непроведенных документов'");
		КонецЕсли;
	Иначе  // создаем новый
		ДокументОбъект = Документы.ПриобретениеУслугПрочихАктивов.СоздатьДокумент();
		ДокументОбъект.Дата = ТекущаяДатаСеанса();
		ДокументОбъект.Заполнить(ДанныеЗаполнения);
		ДокументОбъект.УстановитьНовыйНомер();
	КонецЕсли;
	ДокументОбъект.ОбменДанными.Загрузка = Истина;
	
	// попробуем найти заказ поставщику
	Если ДанныеЗаполнения.Свойство("Контрагент") Тогда
		ДокументОбъект.Контрагент = ДанныеЗаполнения.Контрагент;
		РеквизитыИБКонтрагента = Новый Структура;
		Если ДанныеЗаполнения.Свойство("НомерПоДаннымПоставщика") И ЗначениеЗаполнено(ДанныеЗаполнения.НомерПоДаннымПоставщика) Тогда
			РеквизитыИБКонтрагента.Вставить("НомерПоДаннымПоставщика", ДанныеЗаполнения.НомерПоДаннымПоставщика);
		КонецЕсли;
		Если ДанныеЗаполнения.Свойство("ДатаПоДаннымПоставщика") И ЗначениеЗаполнено(ДанныеЗаполнения.ДатаПоДаннымПоставщика) Тогда
			РеквизитыИБКонтрагента.Вставить("ДатаПоДаннымПоставщика", ДанныеЗаполнения.ДатаПоДаннымПоставщика);
		КонецЕсли;
		РеквизитыИБ = Новый Структура;
		Если ДанныеЗаполнения.Свойство("НомерПоДаннымКлиента") И ЗначениеЗаполнено(ДанныеЗаполнения.НомерПоДаннымКлиента) Тогда
			РеквизитыИБ.Вставить("Номер", ДанныеЗаполнения.НомерПоДаннымКлиента);
		КонецЕсли;
	КонецЕсли;

	// заполнение реквизита ЗакупкаПодДеятельность
	ПараметрыЗаполнения = Документы.ПриобретениеУслугПрочихАктивов.ПараметрыЗаполненияВидаДеятельностиНДС(ДокументОбъект);
	УчетНДСУП.ЗаполнитьВидДеятельностиНДС(ДокументОбъект.ЗакупкаПодДеятельность, ПараметрыЗаполнения);
	
	// вручную переопределим, если требуется
	ПерезаполнениеЗначенийРеквизитовШапки(ДокументОбъект, ДанныеЗаполнения);
	
	// заполнение соглашения по статистике
	Если Не ЗначениеЗаполнено(ДокументОбъект.Соглашение) Тогда
		ЗаполнитьСоглашениеПоСтатистике(ДокументОбъект);
	КонецЕсли;
	
	ДокументОбъект.Расходы.Загрузить(ДанныеДляЗагрузки.Расходы);
	
	Если ДокументОбъект.Расходы.Итог("СуммаНДС") > 0 Тогда
		ДокументОбъект.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС;
	Иначе
		ДокументОбъект.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС;
	Конецесли;
	ДокументОбъект.ЦенаВключаетНДС = Ложь;
	
	Для Каждого Строка Из ДокументОбъект.Расходы Цикл 
		Если ДокументОбъект.ЦенаВключаетНДС И Строка.Сумма <> Строка.СуммаСНДС Тогда
			Строка.Сумма = Строка.СуммаСНДС;
			Если Строка.Количество <> 0 Тогда
				Строка.Цена = Окр(Строка.Сумма/Строка.Количество, 2);
			Иначе
				Строка.Цена = Строка.Сумма;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла; 
	
	// сумма документа
	ДокументОбъект.СуммаДокумента = ЦенообразованиеКлиентСервер.ПолучитьСуммуДокумента(ДокументОбъект.Расходы, ДокументОбъект.ЦенаВключаетНДС);
	
	Попытка
		Если Записывать Тогда
			// запись версии создаваемого документа в подсистеме версионирования
			ДокументОбъект.ОбменДанными.Загрузка = Ложь;
			ВерсионированиеОбъектовСобытия.ЗаписатьВерсиюДокумента(ДокументОбъект, Ложь, РежимЗаписи, РежимПроведенияДокумента.Неоперативный);
			ДокументОбъект.ОбменДанными.Загрузка = Истина;
			// запись версии конец
						
			ДокументОбъект.Записать(РежимЗаписи);
			ДокументОбъект.Разблокировать();
			Документ = ДокументОбъект.Ссылка;
			
			//Запись в Реестр документов
			ТаблицыДанных = ПроведениеДокументов.ДанныеДокументаДляПроведения(Документ, "РеестрДокументов");
			РегистрыСведений.РеестрДокументов.ЗаписатьДанные(ТаблицыДанных, Документ,  Неопределено, Ложь);
		Иначе
			Документ = ДокументОбъект;
		КонецЕсли;
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка()),
					Текст);
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка, ДокументОбъект.Метаданные(), Документ,
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;
	
КонецПроцедуры

Процедура ЗаполнитьДокументСчетФактура(Документ, ДанныеДляЗагрузки, Записывать) Экспорт
	
	Текст = "";
	Если ДанныеДляЗагрузки.Свойство("Шапка") Тогда 
		ДанныеШапки = ДанныеДляЗагрузки.Шапка;
	КонецЕсли; 
	
	Если ДанныеШапки.Свойство("ПриемНаКомиссию") И ДанныеШапки.ПриемНаКомиссию Тогда 
		Возврат;
	КонецЕсли; 	
	
	РежимЗаписи = РежимЗаписиДокумента.Запись;
	Если ЗначениеЗаполнено(Документ) Тогда
		
		Если ТипЗнч(Документ.Контрагент) = Тип("СправочникСсылка.Организации") Тогда 
			Возврат;
		КонецЕсли;
		
		ДокументОбъект = Документ.ПолучитьОбъект();
		//Попытка заблокировать документ
		Попытка
			ДокументОбъект.Заблокировать();
		Исключение
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить данные документа ""%1"".
				|Возможно, документ редактируется другим пользователем'"),
				Строка(ДокументОбъект.Ссылка));
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
		//конец попытки заблокировать документ
		Если ДокументОбъект.Проведен Тогда
			РежимЗаписи = РежимЗаписиДокумента.Проведение;
			Текст = НСтр("ru = 'Операция возможна только для непроведенных документов'");
		КонецЕсли;
	Иначе
		УстановитьПривилегированныйРежим(истина);
		Если ДанныеШапки.КодВидаОперации = "02" Тогда
			ДокументОбъект = Документы.СчетФактураПолученныйАванс.СоздатьДокумент();
		ИначеЕсли ДанныеШапки.Свойство("Сумма") И (ДанныеШапки.Сумма = 0 ИЛИ ДанныеШапки.Сумма = "-") Тогда
			ДокументОбъект = Документы.СчетФактураПолученныйНалоговыйАгент.СоздатьДокумент();
			ДанныеШапки.КодВидаОперации = "42";
		Иначе
			ДокументОбъект = Документы.СчетФактураПолученный.СоздатьДокумент();
		КонецЕсли;
		ДокументОбъект.ОбменДанными.Загрузка = Истина;
		ДокументОбъект.Заполнить(ДанныеШапки);
		ЗаполнитьЗначенияСвойств(ДокументОбъект, ДанныеШапки);
	КонецЕсли;
	
	ДокументОбъект.ОбменДанными.Загрузка = Истина;
	ДокументОбъект.ДополнительныеСвойства.Вставить("ЕстьСоглашение", Истина);
	
	ПерезаполнениеЗначенийРеквизитовШапки(ДокументОбъект, ДанныеШапки);
	
	Если ДанныеШапки.Свойство("НомерИсправления") Тогда
		Если Не ДокументОбъект.Исправление Тогда
			Если ЗначениеЗаполнено(ДанныеШапки.НомерИсправления) Тогда
				ДокументОбъект.Исправление = Истина;
				ДокументОбъект.НомерИсправления = ДанныеШапки.НомерИсправления;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если ДанныеШапки.Свойство("ДокументыОснования") Тогда
		Если ТипЗнч(ДанныеШапки.ДокументыОснования) = Тип("Массив") Тогда
			Для Каждого Основание Из ДанныеШапки.ДокументыОснования Цикл
				Если ТипЗнч(Основание.Ссылка) = Тип("ДокументСсылка.КорректировкаПриобретения") Тогда 
					Если Основание.Ссылка.ВидКорректировки = Перечисления.ХозяйственныеОперации.ИсправлениеОшибок Тогда
						ДокументОбъект.Корректировочный = Ложь;
						ДокументОбъект.Исправление = Истина;
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	Если Не ДанныеШапки.КодВидаОперации = "02" Тогда
		// Заполним ТЧ ДокументыОснования
		Если ДанныеШапки.Свойство("ДокументыОснования") Тогда
			ДокументОбъект.ДокументыОснования.Очистить();
			Для Каждого ДокументОснование Из ДанныеШапки.ДокументыОснования Цикл
				Если ТипЗнч(ДокументОснование) <> Тип("ДокументСсылка.СчетФактураВыданный") И
				                     ТипЗнч(ДокументОснование) <> Тип("ДокументСсылка.СчетФактураПолученный") Тогда
					НоваяСтрока = ДокументОбъект.ДокументыОснования.Добавить();
					НоваяСтрока.ДокументОснование = ДокументОснование;
				КонецЕсли;
			КонецЦикла;
			
			// Дополнительно заполним суммы документа.
			// Если суммы по документу-основанию не найдены, то добавляем суммы к первой строке ТЧ.
			Если Не ДокументОбъект.ДокументыОснования.Количество() = 0 И ДанныеДляЗагрузки.Свойство("Суммы") Тогда
				Суммы = ДанныеДляЗагрузки.Суммы;
				Для Каждого СтрокаТЧ Из ДокументОбъект.ДокументыОснования Цикл
					СтрокаТЧ.Сумма = 0;
					СтрокаТЧ.СуммаНДС = 0;
					Если Не ДанныеШапки.КодВидаОперации = "42" Тогда
						СтрокаТЧ.СуммаУвеличение = 0;
						СтрокаТЧ.СуммаУменьшение = 0;
						СтрокаТЧ.СуммаНДСУвеличение = 0;
						СтрокаТЧ.СуммаНДСУменьшение = 0;
					КонецЕсли;
				КонецЦикла;
				Для Каждого ТекущаяСтрока Из Суммы Цикл
					Если Не ДанныеШапки.КодВидаОперации = "42" Тогда
						СтруктураПоиска = Новый Структура("ДокументОснование,ХозяйственнаяОперация,ИсходныйДокумент,СтавкаНДС");
					Иначе
						СтруктураПоиска = Новый Структура("ДокументОснование,ИсходныйДокумент,СтавкаНДС");
					КонецЕсли;
					ЗаполнитьЗначенияСвойств(СтруктураПоиска, ТекущаяСтрока);
					
					НайденныеСтроки = ДокументОбъект.ДокументыОснования.НайтиСтроки(СтруктураПоиска);
					Если НайденныеСтроки.Количество() = 0 Тогда
						НужнаяСтрока = ДокументОбъект.ДокументыОснования[0];
					Иначе
						НужнаяСтрока = НайденныеСтроки[0];
					КонецЕсли;
					
					НужнаяСтрока.Сумма = НужнаяСтрока.Сумма + ТекущаяСтрока.Сумма;
					НужнаяСтрока.СуммаНДС = НужнаяСтрока.СуммаНДС + ТекущаяСтрока.СуммаНДС;
					
					Если ДокументОбъект.Корректировочный И Не ДанныеШапки.КодВидаОперации = "42" Тогда
						Если Суммы.Колонки.Найти("СуммаУвеличение") <> Неопределено Тогда
							НужнаяСтрока.СуммаУвеличение = НужнаяСтрока.СуммаУвеличение + ТекущаяСтрока.СуммаУвеличение;
							НужнаяСтрока.СуммаУменьшение = НужнаяСтрока.СуммаУменьшение + ТекущаяСтрока.СуммаУменьшение;
							НужнаяСтрока.СуммаНДСУвеличение = НужнаяСтрока.СуммаНДСУвеличение + ТекущаяСтрока.СуммаНДСУвеличение;
							НужнаяСтрока.СуммаНДСУменьшение = НужнаяСтрока.СуммаНДСУменьшение + ТекущаяСтрока.СуммаНДСУменьшение;
						КонецЕсли;	
					КонецЕсли;
				КонецЦикла;
				
				// Устанавливаем флаг ручной корректировки сумм документа,
				// чтобы не затерлись при перезаполнении из торгового документа.
				ДокументОбъект.РучнаяКорректировкаСуммДокумента = Истина;
			КонецЕсли;
		КонецЕсли;
	Иначе
		// Заполним ТЧ Авансы
		ДокументОбъект.Авансы.Загрузить(ДанныеДляЗагрузки.Авансы);
		Если ДанныеШапки.Свойство("Сумма") И ДанныеШапки.Сумма = 0 Тогда
			ДокументОбъект.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ОблагаетсяНДСУПокупателя;
			ДокументОбъект.КодВидаОперации = "41";
			Для Каждого СтрокаАванса Из ДокументОбъект.Авансы Цикл
				СтрокаАванса.СтавкаНДС = УчетНДСУП.СтавкаНДСПоУмолчанию(ДокументОбъект.Организация, ДокументОбъект.Дата, Истина);
				ПроцентНДС = УчетНДСУПКлиентСервер.ЗначениеСтавкиНДС(СтрокаАванса.СтавкаНДС);
				СтрокаАванса.СуммаНДС = СтрокаАванса.Сумма * ПроцентНДС / (100 + ПроцентНДС);
			КонецЦикла;
			ДокументОбъект.Сумма = ДокументОбъект.Авансы.Итог("Сумма");
			ДокументОбъект.СуммаНДС = ДокументОбъект.Авансы.Итог("СуммаНДС");
			ДокументОбъект.ДатаОтраженияВРеглУчете = ДокументОбъект.ДатаСоставления;
		Иначе
			ДокументОбъект.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС;
			ДокументОбъект.ДатаОтраженияВРеглУчете = ДокументОбъект.Дата;
		КонецЕсли;
	КонецЕсли;
	
	Попытка
		Если Записывать Тогда
			ДокументОбъект.Записать(РежимЗаписи);
			ДокументОбъект.Разблокировать();
			Документ = ДокументОбъект.Ссылка;
			
			//Запись в Реестр документов
			ТаблицыДанных = ПроведениеДокументов.ДанныеДокументаДляПроведения(Документ, "РеестрДокументов");
			РегистрыСведений.РеестрДокументов.ЗаписатьДанные(ТаблицыДанных, Документ,  Неопределено, Ложь);
		Иначе
			Документ = ДокументОбъект;
		КонецЕсли;
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка()),
					Текст); 
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка, ДокументОбъект.Метаданные(), Документ, 
									ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;
	
КонецПроцедуры

Процедура ЗаполнитьДокументКорректировкиПоступления(Документ, ДанныеДляЗагрузки, Записывать) Экспорт
	
	Текст = "";
	ДанныеЗаполнения = ДанныеДляЗагрузки.Шапка;
	
	РежимЗаписи = РежимЗаписиДокумента.Запись;
	Если ЗначениеЗаполнено(Документ) Тогда // получены изменения по существующему документу
		ДокументОбъект = Документ.ПолучитьОбъект();
		//Попытка заблокировать документ
		Попытка
			ДокументОбъект.Заблокировать();
		Исключение
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить данные документа ""%1"".
				|Возможно, документ редактируется другим пользователем'"),
				Строка(ДокументОбъект.Ссылка));
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
		//конец попытки заблокировать документ
		Если ДокументОбъект.Проведен Тогда 
			РежимЗаписи = РежимЗаписиДокумента.Проведение;
			Текст = НСтр("ru = 'Операция возможна только для непроведенных документов'");
		КонецЕсли;
	Иначе // создаем новый
		ДокументОбъект = Документы.КорректировкаПриобретения.СоздатьДокумент();
		Если ДанныеЗаполнения.Свойство("ДокументОснование") И ЗначениеЗаполнено(ДанныеЗаполнения.ДокументОснование) Тогда
			ДокументОбъект.Заполнить(ДанныеЗаполнения.ДокументОснование);
		Иначе
			ДокументОбъект.Заполнить(ДанныеЗаполнения);
		КонецЕсли;
		ДокументОбъект.Дата = ТекущаяДатаСеанса();
		ДокументОбъект.УстановитьНовыйНомер();
	КонецЕсли;
	ДокументОбъект.ОбменДанными.Загрузка = Истина;
	// заполнение контрагента
	Если ДанныеЗаполнения.Свойство("Контрагент") Тогда
		ДокументОбъект.Контрагент = ДанныеЗаполнения.Контрагент;
	КонецЕсли;	

	Если ДанныеЗаполнения.Свойство("ИсправляемыйДокумент") Тогда
		ДокументОбъект.ИсправляемыйДокумент = ДанныеЗаполнения.ИсправляемыйДокумент;
	КонецЕсли;	
	
	ДокументОбъект.Товары.Загрузить(ДанныеДляЗагрузки.Товары);
	
	//++ Локализация
	Если ЗначениеЗаполнено(ДанныеДляЗагрузки.ШтрихкодыУпаковок) Тогда
		Если ДанныеДляЗагрузки.ШтрихкодыУпаковок.Колонки.Найти("Номенклатура") <> Неопределено Тогда
			ЭлектронноеВзаимодействиеИСМП.НормализоватьШтрихкодыУпаковокУКД(ДанныеДляЗагрузки.ШтрихкодыУпаковок);
		Иначе
			ЭлектронноеВзаимодействиеИСМП.НормализоватьШтрихкодыУпаковок(ДанныеДляЗагрузки.Товары, ДанныеДляЗагрузки.ШтрихкодыУпаковок);
		КонецЕсли;
		ДокументОбъект.ШтрихкодыУпаковок.Загрузить(ДанныеДляЗагрузки.ШтрихкодыУпаковок);
	КонецЕсли;
	//-- Локализация
	
	Отказ = Ложь;
	НоменклатураПартнеровСервер.ЗаполнитьПустоеСопоставлениеВНоменклатуреПартнераПоНоменклатуреИБ(ДокументОбъект.Товары, Отказ);
	
	ПерезаполнениеЗначенийРеквизитовШапки(ДокументОбъект, ДанныеЗаполнения);
	
	// заполнение соглашения по статистике
	Если Не ЗначениеЗаполнено(ДокументОбъект.Соглашение) Тогда
		ЗаполнитьСоглашениеПоСтатистике(ДокументОбъект);
	КонецЕсли;

	Если ДанныеДляЗагрузки.Свойство("Расхождения") Тогда
		ОснованиеПервичныйДокумент = Истина;
	Иначе
		ОснованиеПервичныйДокумент = Ложь;	
	КонецЕсли;
	
	// Склады в ТЧ
	Если ДанныеЗаполнения.Свойство("ДокументОснование") Тогда
		ЕстьСклад = ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ДанныеЗаполнения.ДокументОснование, "Склад");
		Если Не ОснованиеПервичныйДокумент И ЕстьСклад И Не ЗначениеЗаполнено(ДокументОбъект.Склад) Тогда
			ДокументОбъект.Склад = ДанныеЗаполнения.ДокументОснование.Склад;
		КонецЕсли
	КонецЕсли;	
	СкладГруппа = Справочники.Склады.ЭтоГруппаИСкладыИспользуютсяВТЧДокументовЗакупки(ДокументОбъект.Склад);
	СкладыСервер.ЗаполнитьСкладыВТабличнойЧасти(ДокументОбъект.Склад, СкладГруппа, ДокументОбъект.Товары, Истина);

	КорректировкаПУиПА = Ложь;
	Если ТипЗнч(ДокументОбъект.ДокументОснование) = Тип("ДокументСсылка.ПриобретениеУслугПрочихАктивов") Тогда
		КорректировкаПУиПА = Истина;
	КонецЕсли;
	
	Для Каждого Строка Из ДокументОбъект.Товары Цикл 
		Если КорректировкаПУиПА Тогда
			Если Не ЗначениеЗаполнено(Строка.Содержание) Тогда
				Строка.Содержание = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Строка.Номенклатура, "Наименование");
			КонецЕсли;
		КонецЕсли;
		Если ДокументОбъект.ЦенаВключаетНДС И Строка.Сумма <> Строка.СуммаСНДС Тогда
			Строка.Сумма = Строка.СуммаСНДС;
			Если Строка.Количество <> 0 Тогда
				Строка.Цена = Окр(Строка.Сумма/Строка.Количество, 2);
			Иначе
				Строка.Цена = Строка.Сумма;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	// Заполним расхождения
	Если ЗначениеЗаполнено(ДокументОбъект.ДокументОснование) И Не ОснованиеПервичныйДокумент Тогда
		ИспользуетсяДокументПоступлениеТоваров = Ложь;
		
		ОперацииРаздельнойЗакупки = Новый Массив;
		ОперацииРаздельнойЗакупки.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаУПоставщикаТоварыВПути);
		ОперацииРаздельнойЗакупки.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаУПоставщикаФактуровкаПоставки);
		ОперацииРаздельнойЗакупки.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСТоварыВПути);
		ОперацииРаздельнойЗакупки.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСФактуровкаПоставки);
		ОперацииРаздельнойЗакупки.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаПоИмпортуТоварыВПути);
		
		Если ТипЗнч(ДокументОбъект.ДокументОснование) = Тип("ДокументСсылка.ПриобретениеТоваровУслуг") 
				или ТипЗнч(ДокументОбъект.ДокументОснование) = Тип("ДокументСсылка.ПриобретениеУслугПрочихАктивов") Тогда
			ОперацияОснования = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОбъект.ДокументОснование,
																			"ХозяйственнаяОперация");
																			
			ИспользуетсяДокументПоступлениеТоваров = ОперацииРаздельнойЗакупки.Найти(ОперацияОснования) <> Неопределено;
		КонецЕсли;

		НоменклатураСервер.ОкруглитьКоличествоШтучныхТоваров(ДокументОбъект);		
		ДокументОбъект.ЗаполнитьРасхождения(ИспользуетсяДокументПоступлениеТоваров);
	Иначе
		Если ОснованиеПервичныйДокумент Тогда
			ДокументОбъект.Расхождения.Загрузить(ДанныеДляЗагрузки.Расхождения);
			ДокументОбъект.ТипКорректировки = Перечисления.ТипыКорректировки.КорректировкаДоВводаОстатковТоваровИУслуг;
			// попробуем найти первичный документ
			НайденныйДок = Неопределено;
			Если ЗначениеЗаполнено(ДанныеЗаполнения.НомерВходящегоДокумента) Тогда 
				НайденныйДок = НайтиПоступлениеТоваровУслуг(ДанныеЗаполнения.Организация, ДанныеЗаполнения.НомерВходящегоДокумента, ДанныеЗаполнения.ДатаВходящегоДокумента, "ДокументСсылка.ПервичныйДокумент");
			КонецЕсли;
			Если ЗначениеЗаполнено(НайденныйДок) Тогда	
				Если ТипЗнч(НайденныйДок) = Тип("ДокументСсылка.ПервичныйДокумент") Тогда
					ДокументОбъект.ДокументОснование = НайденныйДок.Ссылка;
					ДокументОбъект.НалогообложениеНДС = НайденныйДок.НалогообложениеНДС;
					ДокументОбъект.Договор = НайденныйДок.Договор;
					ДокументОбъект.ПорядокРасчетов = НайденныйДок.ПорядокРасчетов;
				КонецЕсли;
			КонецЕсли;			
		КонецЕсли;
	КонецЕсли;
	
	// Сумма документа
	ДокументОбъект.СуммаДокумента = ЦенообразованиеКлиентСервер.ПолучитьСуммуДокумента(ДокументОбъект.Товары, ДокументОбъект.ЦенаВключаетНДС);
	
	Попытка
		Если Записывать Тогда
			// запись версии создаваемого документа в подсистеме версионирования
			ДокументОбъект.ОбменДанными.Загрузка = Ложь;
			ВерсионированиеОбъектовСобытия.ЗаписатьВерсиюДокумента(ДокументОбъект, Отказ, РежимЗаписи, РежимПроведенияДокумента.Неоперативный);
			ДокументОбъект.ОбменДанными.Загрузка = Истина;
			// запись версии конец
						
			ДокументОбъект.Записать(РежимЗаписи);
			ДокументОбъект.Разблокировать();
			Документ = ДокументОбъект.Ссылка;
			
			//Запись в Реестр документов
			ТаблицыДанных = ПроведениеДокументов.ДанныеДокументаДляПроведения(Документ, "РеестрДокументов");
			РегистрыСведений.РеестрДокументов.ЗаписатьДанные(ТаблицыДанных, Документ,  Неопределено, Ложь);
		Иначе
			Документ = ДокументОбъект;
		КонецЕсли;
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка()),
					Текст);
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка, ДокументОбъект.Метаданные(), Документ, 
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;
	
КонецПроцедуры

Процедура ЗаполнитьДокументВозвратаТоваровОтПокупателя(Документ, ДанныеДляЗагрузки, Записывать) Экспорт
	
	Текст = "";
	Если ДанныеДляЗагрузки.Свойство("Шапка") Тогда
		ДанныеЗаполнения = ДанныеДляЗагрузки.Шапка;
	КонецЕсли;
	
	РежимЗаписи = РежимЗаписиДокумента.Запись;
	Если ЗначениеЗаполнено(Документ) Тогда // получены изменения по существующему документу
		ДокументОбъект = Документ.ПолучитьОбъект();
		//Попытка заблокировать документ
		Попытка
			ДокументОбъект.Заблокировать();
		Исключение
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить данные документа ""%1"".
				|Возможно, документ редактируется другим пользователем'"),
				Строка(ДокументОбъект.Ссылка));
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
		//конец попытки заблокировать документ
		Если ДокументОбъект.Проведен Тогда 
			РежимЗаписи = РежимЗаписиДокумента.Проведение;
			Текст = НСтр("ru = 'Операция возможна только для непроведенных документов'");
		КонецЕсли;
	Иначе  // создаем новый
		ДокументОбъект = Документы.ВозвратТоваровОтКлиента.СоздатьДокумент();
		ДокументОбъект.Дата = ТекущаяДатаСеанса();
		ДокументОбъект.Заполнить(ДанныеЗаполнения);
		Если Не ЗначениеЗаполнено(ДокументОбъект.Организация) Тогда
			ДокументОбъект.Организация = ДанныеЗаполнения.Организация;
		КонецЕсли;
		ДокументОбъект.УстановитьНовыйНомер();
	КонецЕсли;
	ДокументОбъект.ОбменДанными.Загрузка = Истина;
	
	// попробуем найти документ реализации
	НайденныйДок = Неопределено;
	Если ДанныеЗаполнения.Свойство("НомерДокументаОснования") И ЗначениеЗаполнено(ДанныеЗаполнения.НомерДокументаОснования) Тогда
		НайденныйДок = НайтиРеализациюТоваровУслуг(ДанныеЗаполнения.Организация, ДанныеЗаполнения.НомерДокументаОснования, ДанныеЗаполнения.ДатаДокументаОснования);
	КонецЕсли;
	
	ДокументОбъект.ДокументРеализации = НайденныйДок;

	Если ЗначениеЗаполнено(НайденныйДок) Тогда
		Если Не ЗначениеЗаполнено(ДокументОбъект.Договор) Тогда
			ДокументОбъект.Договор = НайденныйДок.Договор;
		КонецЕсли;
		Если Не ЗначениеЗаполнено(ДокументОбъект.Соглашение) Тогда
			ДокументОбъект.Соглашение = НайденныйДок.Соглашение;
		КонецЕсли;
		Если Не ЗначениеЗаполнено(ДокументОбъект.Склад) Тогда
			ДокументОбъект.Склад = НайденныйДок.Склад;
		КонецЕсли;
	КонецЕсли;
	
	// Заполнение партнера, если контрагент создается новый.
	ПартнерКонтрагента = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОбъект.Контрагент, "Партнер"); 
	Если Не ЗначениеЗаполнено(ДокументОбъект.Партнер) И ЗначениеЗаполнено(ПартнерКонтрагента) Тогда
		ДокументОбъект.Партнер = ПартнерКонтрагента;
	КонецЕсли;
	
	// вручную переопределим, если требуется
	ПерезаполнениеЗначенийРеквизитовШапки(ДокументОбъект, ДанныеЗаполнения);
	
	// заполнение соглашения по статистике
	Если Не ЗначениеЗаполнено(ДокументОбъект.Соглашение) Тогда
		ЗаполнитьСоглашениеПоСтатистике(ДокументОбъект);
	КонецЕсли;
	
	ДокументОбъект.Товары.Загрузить(ДанныеДляЗагрузки.Товары);
	
	Для Каждого Строка Из ДокументОбъект.Товары Цикл
		Если ЗначениеЗаполнено(НайденныйДок) Тогда 
			Строка.ДокументРеализации = НайденныйДок;
			Строка.СпособОпределенияСебестоимости = Перечисления.СпособыОпределенияСебестоимостиВозврата.ИзДокументаПродажи;
		КонецЕсли;
	КонецЦикла;
	
	Если ДокументОбъект.Товары.Итог("СуммаНДС") = 0 Тогда
		ДокументОбъект.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС;
	Иначе
		ДокументОбъект.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС;
	КонецЕсли;
	
	Для Каждого Строка Из ДокументОбъект.Товары Цикл 
		Если ДокументОбъект.ЦенаВключаетНДС И Строка.Сумма <> Строка.СуммаСНДС Тогда
			Строка.Сумма = Строка.СуммаСНДС;
			Если Строка.Количество <> 0 Тогда
				Строка.Цена = Окр(Строка.Сумма/Строка.Количество, 2);
			Иначе
				Строка.Цена = Строка.Сумма;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;

	// сумма документа
	ДокументОбъект.СуммаДокумента = ЦенообразованиеКлиентСервер.ПолучитьСуммуДокумента(ДокументОбъект.Товары, ДокументОбъект.ЦенаВключаетНДС);
	
	Попытка
		Если Записывать Тогда
			// запись версии создаваемого документа в подсистеме версионирования
			ДокументОбъект.ОбменДанными.Загрузка = Ложь;
			ВерсионированиеОбъектовСобытия.ЗаписатьВерсиюДокумента(ДокументОбъект, Ложь, РежимЗаписи, РежимПроведенияДокумента.Неоперативный);
			ДокументОбъект.ОбменДанными.Загрузка = Истина;
			// запись версии конец
						
			ДокументОбъект.Записать(РежимЗаписи);
			ДокументОбъект.Разблокировать();			
			Документ = ДокументОбъект.Ссылка;
			
			//Запись в Реестр документов
			ТаблицыДанных = ПроведениеДокументов.ДанныеДокументаДляПроведения(Документ, "РеестрДокументов");
			РегистрыСведений.РеестрДокументов.ЗаписатьДанные(ТаблицыДанных, Документ,  Неопределено, Ложь);
		Иначе
			Документ = ДокументОбъект;
		КонецЕсли;
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка()),
					Текст);
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка, ДокументОбъект.Метаданные(), Документ, 
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;

КонецПроцедуры

// Находит отчет комиссионера о продажах по указанному комиссионеру и указанной комиссионной услуге.
//
//Параметры:
// Документ - Неопределено, ДокументСсылка.ОтчетКомиссионера, ДокументОбъект.ОтчетКомиссионера - документ основание.
// ДанныеДляЗагрузки - Структура - структура данных ЭД.
// Записывать - Булево - признак возврата ссылки на документ и сам документ.
//
Процедура ЗаполнитьДокументОтчетКомиссионераОПродажахУслуги(Документ, ДанныеДляЗагрузки, Записывать) Экспорт
	
	Если ДанныеДляЗагрузки.Свойство("Шапка") Тогда 
		ДанныеЗаполнения = ДанныеДляЗагрузки.Шапка;
	КонецЕсли; 
	
	Если ЗначениеЗаполнено(Документ) Тогда // получены изменения по существующему документу
		ДокументОбъект = Документ.ПолучитьОбъект();
		//Попытка заблокировать документ
		Попытка
			ДокументОбъект.Заблокировать();
		Исключение
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить данные документа ""%1"".
				|Возможно, документ редактируется другим пользователем'"),
				Строка(ДокументОбъект.Ссылка));
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
		//конец попытки заблокировать документ
		Если Записывать Тогда
			Документ = ДокументОбъект.Ссылка;
		Иначе
			Документ = ДокументОбъект;
		КонецЕсли;
	Иначе  // ищем отчет
		СтруктураПоискаОтчета = Новый Структура();
		
		СтруктураПоискаОтчета.Вставить("Контрагент",             Справочники.Контрагенты.ПустаяСсылка());
		СтруктураПоискаОтчета.Вставить("Партнер",                Справочники.Партнеры.ПустаяСсылка());
		СтруктураПоискаОтчета.Вставить("Услуга",                 Справочники.Номенклатура.ПустаяСсылка());
		СтруктураПоискаОтчета.Вставить("СуммаВознаграждения",    0);
		СтруктураПоискаОтчета.Вставить("СуммаНДСВознаграждения", 0);
		
		Если ДанныеЗаполнения.Свойство("Контрагент") Тогда
			СтруктураПоискаОтчета.Контрагент = ДанныеЗаполнения.Контрагент;
		КонецЕсли;
		
		СтруктураПоискаОтчета.Партнер = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктураПоискаОтчета.Контрагент, "Партнер"); 
		
		Если ДанныеДляЗагрузки.Товары.Количество() = 1 Тогда
			СтрокаТовар = ДанныеДляЗагрузки.Товары[0];
			СтруктураПоискаОтчета.Услуга = СтрокаТовар.Номенклатура;
			СтруктураПоискаОтчета.СуммаВознаграждения = СтрокаТовар.СуммаСНДС;
			СтруктураПоискаОтчета.СуммаНДСВознаграждения = СтрокаТовар.СуммаНДС;
		Иначе
			ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						НСтр("ru = 'При поиске отчета комиссионера о продажах по комиссионеру %1 указано более одной комиссионной услуги, а в отчете может быть только одна.'"),
						СтруктураПоискаОтчета.Контрагент);
			ВызватьИсключение ТекстОшибки;
		КонецЕсли;
		
		Запрос = Новый Запрос();
		Запрос.УстановитьПараметр("Контрагент", СтруктураПоискаОтчета.Контрагент);
		Запрос.УстановитьПараметр("Партнер", СтруктураПоискаОтчета.Партнер);
		Запрос.УстановитьПараметр("СуммаВознаграждения", СтруктураПоискаОтчета.СуммаВознаграждения);
		Запрос.УстановитьПараметр("СуммаНДСВознаграждения", СтруктураПоискаОтчета.СуммаНДСВознаграждения);
		Запрос.УстановитьПараметр("Услуга", СтруктураПоискаОтчета.Услуга);
		
		Запрос.Текст = "ВЫБРАТЬ
		|	ОтчетКомиссионера.Ссылка КАК Ссылка,
		|	МАКСИМУМ(СчетФактураПолученный.ПометкаУдаления) КАК ПометкаУдалаения
		|ПОМЕСТИТЬ Вт_ДанныеПоОтчету
		|ИЗ
		|	Документ.ОтчетКомиссионера КАК ОтчетКомиссионера
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученный.ДокументыОснования КАК СчетФактураПолученныйДокументыОснования
		|		ПО ОтчетКомиссионера.Ссылка = СчетФактураПолученныйДокументыОснования.ДокументОснование
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученный КАК СчетФактураПолученный
		|		ПО (СчетФактураПолученныйДокументыОснования.Ссылка = СчетФактураПолученный.Ссылка)
		|ГДЕ
		|	ОтчетКомиссионера.Контрагент = &Контрагент
		|	И ОтчетКомиссионера.Партнер = &Партнер
		|	И ОтчетКомиссионера.Услуга = &Услуга
		|	И ОтчетКомиссионера.СуммаВознаграждения = &СуммаВознаграждения
		|	И ОтчетКомиссионера.СуммаНДСВознаграждения = &СуммаНДСВознаграждения
		|	И ОтчетКомиссионера.Проведен
		|
		|СГРУППИРОВАТЬ ПО
		|	ОтчетКомиссионера.Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Вт_ДанныеПоОтчету.Ссылка КАК Ссылка
		|ИЗ
		|	Вт_ДанныеПоОтчету КАК Вт_ДанныеПоОтчету
		|ГДЕ
		|	(Вт_ДанныеПоОтчету.ПометкаУдалаения ЕСТЬ NULL
		|			ИЛИ Вт_ДанныеПоОтчету.ПометкаУдалаения)";
		
		Результат = Запрос.Выполнить().Выбрать();
		Если Результат.Следующий() Тогда
			Документ = Результат.Ссылка;
			Если Не Записывать Тогда
				Документ = Документ.ПолучитьОбъект();
			КонецЕсли;
		Иначе
			ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						НСтр("ru = 'Не найден отчет комиссионера о продажах по комиссионеру %1 и комиссионной услуге %2 с суммой вознаграждения %3'"),
						СтруктураПоискаОтчета.Контрагент,
						СтруктураПоискаОтчета.Услуга,
						СтруктураПоискаОтчета.СуммаВознаграждения);
			ВызватьИсключение ТекстОшибки;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Функция ПодготовитьСтруктуруДляПриобретенияТоваровУслугПоПередачеТоваров(ДеревоДанных) Экспорт
	
	ДанныеОбъекта = Новый Структура;
	
	Валюта = Неопределено;
	ЭлектронноеВзаимодействиеПереопределяемый.НайтиСсылкуНаОбъект(
				"Валюты", Валюта, ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод"));
	ДанныеОбъекта.Вставить("Валюта", Валюта);
	ДанныеОбъекта.Вставить("КурсЧислитель", 1);
	ДанныеОбъекта.Вставить("КурсЗнаменатель", 1);
	
	ДанныеОбъекта.Вставить("НомерВходящегоДокумента", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерТоварнойНакладной"));
	ДанныеОбъекта.Вставить("ДатаВходящегоДокумента",  ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаТоварнойНакладной"));
	
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления")) Тогда
		ДанныеОбъекта.Вставить("Исправление", Истина);
		ДанныеОбъекта.Вставить("НомерИсправления", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления"));
		ДанныеОбъекта.Вставить("ДатаИсправления",  ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсправления"));
	Иначе
		ДанныеОбъекта.Вставить("Исправление", Ложь);
	КонецЕсли;
	
	// Сведения о поставщике.
	ИННПоставщика = ""; КПППоставщика = "";
	ВидУчастника = "Поставщик";
	Если ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ЮЛ" Тогда
		ИННПоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
		КПППоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ИП" Тогда
		ИННПоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН");
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ФЛ" Тогда
		ИННПоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.ИНН");
	КонецЕсли;
	Контрагент = Справочники.Контрагенты.ПустаяСсылка();
	СсылкаНаОбъектПоИННКПП("Контрагенты", ИННПоставщика, КПППоставщика, Контрагент);
	Если ЗначениеЗаполнено(Контрагент) Тогда
		ДанныеОбъекта.Вставить("Контрагент", Контрагент);
		ДанныеОбъекта.Вставить("Партнер",  	 Контрагент.Партнер);
	Иначе
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'В базе данных не удалось найти контрагента с ИНН ""%1"" и КПП ""%2""'"),
			ИННПоставщика, КПППоставщика);
		ВызватьИсключение ТекстСообщения;		
	КонецЕсли;
	
	// Сведения о покупателе.
	ИННПокупателя = ""; КПППокупателя = "";
	ВидУчастника = "Плательщик";
	Если ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ЮЛ" Тогда
		ИННПокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
		КПППокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ИП" Тогда
		ИННПокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН");
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ФЛ" Тогда
		ИННПокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.ИНН");
	КонецЕсли;
	Организация = Справочники.Организации.ПустаяСсылка();
	СсылкаНаОбъектПоИННКПП("Организации", ИННПокупателя, КПППокупателя, Организация);
	ДанныеОбъекта.Вставить("Организация", Организация);
	
	Товары = Документы.ПриобретениеТоваровУслуг.ПустаяСсылка().Товары.ВыгрузитьКолонки();
	Товары.Колонки.Добавить("НомерПоДаннымПоставщика");
	Товары.Колонки.Добавить("ДатаПоДаннымПоставщика");
	Товары.Колонки.Добавить("НомерПоДаннымКлиента");
	Товары.Колонки.Добавить("ДатаПоДаннымКлиента");
	
	СведенияОТоварах = ДеревоДанных.Строки.Найти("ТаблицаТоваров", "ПолныйПуть");
	Для Каждого СведенияОТоваре Из СведенияОТоварах.Строки Цикл
		
		НоваяСтрока = Товары.Добавить();
	
		// Обязательные реквизиты:
		НоваяСтрока.СтавкаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "ТаблицаТоваров.НомерСтроки.СтавкаНДС");
		НоваяСтрока.СуммаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "ТаблицаТоваров.НомерСтроки.СуммаНДС");
		
		// Необязательные реквизиты:
		МассаНетто = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "ТаблицаТоваров.НомерСтроки.МассаНетто");
		КоличествоМест = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "ТаблицаТоваров.НомерСтроки.КоличествоМест");
		НоваяСтрока.Количество = ?(ЗначениеЗаполнено(МассаНетто), МассаНетто, КоличествоМест);
		НоваяСтрока.Цена = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "ТаблицаТоваров.НомерСтроки.Цена");
		НоваяСтрока.Сумма = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "ТаблицаТоваров.НомерСтроки.СуммаБезНДС");
		НоваяСтрока.СуммаСНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "ТаблицаТоваров.НомерСтроки.СуммаСНДС");
		
		Сопоставление = СведенияОТоваре.Строки.Найти(
			"ТаблицаТоваров.НомерСтроки.Сопоставление", "ПолныйПуть", Истина);
		Если Сопоставление <> Неопределено Тогда
			
			Идентификатор = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"ТаблицаТоваров.НомерСтроки.Сопоставление.Идентификатор");
			Если ЗначениеЗаполнено(Идентификатор) Тогда
				НоменклатураПартнера = НоменклатураПартнеровСервер.НайтиСсылкуНаНоменклатуруПартнераПоИдентификатору(Идентификатор);
				Если ЗначениеЗаполнено(НоменклатураПартнера) Тогда
					НоваяСтрока.НоменклатураПартнера = НоменклатураПартнера;
				КонецЕсли;
			КонецЕсли;
			
			Номенклатура = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"ТаблицаТоваров.НомерСтроки.Сопоставление.НоменклатураИБ");
			Если ЗначениеЗаполнено(Номенклатура) Тогда
				НоваяСтрока.Номенклатура = Номенклатура;
			КонецЕсли;
			
			Характеристика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"ТаблицаТоваров.НомерСтроки.Сопоставление.ХарактеристикаИБ");
			Если ЗначениеЗаполнено(Характеристика) Тогда
				НоваяСтрока.Характеристика = Характеристика;
			КонецЕсли;
			
			Упаковка = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"ТаблицаТоваров.НомерСтроки.Сопоставление.УпаковкаИБ");
			Если ЗначениеЗаполнено(Упаковка) Тогда
				НоваяСтрока.Упаковка = Упаковка;
			КонецЕсли;
			
		КонецЕсли;
		
		ТипНоменклатуры = НоваяСтрока.Номенклатура.ТипНоменклатуры;
		Если ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Услуга") Тогда
			НоваяСтрока.СписатьНаРасходы = Истина;
		КонецЕсли;
		
	КонецЦикла;
	
	// заполним Характеристики и Упаковки по соответствию из НоменклатурыПоставщика,
	//Переносим значения из колонки СуммаСкидки в СуммаРучнойСкидки, т.к. название реквизита табличной части документа
	//не совпадает с названием реквизита СтрокиДляЗагрузки

	Для Каждого ТекСтрока Из Товары Цикл 
		ТекСтрока.КоличествоУпаковок = ТекСтрока.Количество;
		// заполним Количество с учетом единиц измерения
		Если ЗначениеЗаполнено(ТекСтрока.Упаковка) Тогда
			ТекКоэффициент = Справочники.УпаковкиЕдиницыИзмерения.КоэффициентУпаковки(ТекСтрока.Упаковка, ТекСтрока.Номенклатура);
		Иначе
			ТекКоэффициент = 1;
		КонецЕсли;
		ТекСтрока.Количество = ТекСтрока.КоличествоУпаковок * ТекКоэффициент;
	КонецЦикла;
	
	ДанныеДляЗаполнения = Новый Структура();
	ДанныеДляЗаполнения.Вставить("Шапка", ДанныеОбъекта);
	ДанныеДляЗаполнения.Вставить("Товары", Товары);
	
	Возврат ДанныеДляЗаполнения;
	
КонецФункции

Функция ПодготовитьСтруктуруДляПриобретенияТоваровУслугПоПередачеРабот(ДеревоДанных) Экспорт
	
	ДанныеОбъекта = Новый Структура;
	
	Валюта = Неопределено;
	ЭлектронноеВзаимодействиеПереопределяемый.НайтиСсылкуНаОбъект(
				"Валюты", Валюта, ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод"));
	ДанныеОбъекта.Вставить("Валюта", Валюта);
	ДанныеОбъекта.Вставить("КурсЧислитель", 1);
	ДанныеОбъекта.Вставить("КурсЗнаменатель", 1);
	
	ДанныеОбъекта.Вставить("НомерВходящегоДокумента", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерАкта"));
	ДанныеОбъекта.Вставить("ДатаВходящегоДокумента",  ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаАкта"));
	
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления")) Тогда
		ДанныеОбъекта.Вставить("Исправление", Истина);
		ДанныеОбъекта.Вставить("НомерИсправления", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления"));
		ДанныеОбъекта.Вставить("ДатаИсправления",  ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсправления"));
	Иначе
		ДанныеОбъекта.Вставить("Исправление", Ложь);
	КонецЕсли;
	
	// Сведения о поставщике.
	ИННПоставщика = ""; КПППоставщика = "";
	ВидУчастника = "Заказчик";
	Если ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ЮЛ" Тогда
		ИННПоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
		КПППоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ИП" Тогда
		ИННПоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН");
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ФЛ" Тогда
		ИННПоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.ИНН");
	КонецЕсли;
	Контрагент = Справочники.Контрагенты.ПустаяСсылка();
	СсылкаНаОбъектПоИННКПП("Контрагенты", ИННПоставщика, КПППоставщика, Контрагент);
	Если ЗначениеЗаполнено(Контрагент) Тогда
		ДанныеОбъекта.Вставить("Контрагент", Контрагент);
		ДанныеОбъекта.Вставить("Партнер",  	 Контрагент.Партнер);
	Иначе
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'В базе данных не удалось найти контрагента с ИНН ""%1"" и КПП ""%2""'"),
			ИННПоставщика, КПППоставщика);
		ВызватьИсключение ТекстСообщения;		
	КонецЕсли;
	
	// Сведения о покупателе.
	ИННПокупателя = ""; КПППокупателя = "";
	ВидУчастника = "Исполнитель";
	Если ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ЮЛ" Тогда
		ИННПокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
		КПППокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ИП" Тогда
		ИННПокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН");
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ФЛ" Тогда
		ИННПокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.ИНН");
	КонецЕсли;
	Организация = Справочники.Организации.ПустаяСсылка();
	СсылкаНаОбъектПоИННКПП("Организации", ИННПокупателя, КПППокупателя, Организация);
	ДанныеОбъекта.Вставить("Организация", Организация);
	
	Товары = Документы.ПриобретениеТоваровУслуг.ПустаяСсылка().Товары.ВыгрузитьКолонки();
	Товары.Колонки.Добавить("НомерПоДаннымПоставщика");
	Товары.Колонки.Добавить("ДатаПоДаннымПоставщика");
	Товары.Колонки.Добавить("НомерПоДаннымКлиента");
	Товары.Колонки.Добавить("ДатаПоДаннымКлиента");
	
	СведенияОТоварах = ДеревоДанных.Строки.Найти("ТаблицаУслуг", "ПолныйПуть");
	Для Каждого СведенияОТоваре Из СведенияОТоварах.Строки Цикл
		
		НоваяСтрока = Товары.Добавить();
	
		// Обязательные реквизиты:
		НоваяСтрока.СтавкаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "ТаблицаУслуг.НомерСтроки.СтавкаНДС");
		НоваяСтрока.СуммаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "ТаблицаУслуг.НомерСтроки.СуммаНДС");
		
		// Необязательные реквизиты:
		НоваяСтрока.Количество = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "ТаблицаУслуг.НомерСтроки.Количество");
		НоваяСтрока.Цена = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "ТаблицаУслуг.НомерСтроки.Цена");
		НоваяСтрока.Сумма = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "ТаблицаУслуг.НомерСтроки.СуммаБезНДС");
		НоваяСтрока.СуммаСНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "ТаблицаУслуг.НомерСтроки.СуммаСНДС");
		
		Сопоставление = СведенияОТоваре.Строки.Найти(
			"ТаблицаУслуг.НомерСтроки.Сопоставление", "ПолныйПуть", Истина);
		Если Сопоставление <> Неопределено Тогда
			
			Идентификатор = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"ТаблицаУслуг.НомерСтроки.Сопоставление.Идентификатор");
			Если ЗначениеЗаполнено(Идентификатор) Тогда
				НоменклатураПартнера = НоменклатураПартнеровСервер.НайтиСсылкуНаНоменклатуруПартнераПоИдентификатору(Идентификатор);
				Если ЗначениеЗаполнено(НоменклатураПартнера) Тогда
					НоваяСтрока.НоменклатураПартнера = НоменклатураПартнера;
				КонецЕсли;
			КонецЕсли;
			
			Номенклатура = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"ТаблицаУслуг.НомерСтроки.Сопоставление.НоменклатураИБ");
			Если ЗначениеЗаполнено(Номенклатура) Тогда
				НоваяСтрока.Номенклатура = Номенклатура;
			КонецЕсли;
			
			Характеристика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"ТаблицаУслуг.НомерСтроки.Сопоставление.ХарактеристикаИБ");
			Если ЗначениеЗаполнено(Характеристика) Тогда
				НоваяСтрока.Характеристика = Характеристика;
			КонецЕсли;
			
			Упаковка = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"ТаблицаУслуг.НомерСтроки.Сопоставление.УпаковкаИБ");
			Если ЗначениеЗаполнено(Упаковка) Тогда
				НоваяСтрока.Упаковка = Упаковка;
			КонецЕсли;
			
		КонецЕсли;
		
		ТипНоменклатуры = НоваяСтрока.Номенклатура.ТипНоменклатуры;
		Если ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Услуга") Тогда
			НоваяСтрока.СписатьНаРасходы = Истина;
		КонецЕсли;
		
	КонецЦикла;
	
	// заполним Характеристики и Упаковки по соответствию из НоменклатурыПоставщика,
	//Переносим значения из колонки СуммаСкидки в СуммаРучнойСкидки, т.к. название реквизита табличной части документа
	//не совпадает с названием реквизита СтрокиДляЗагрузки

	Для Каждого ТекСтрока Из Товары Цикл 
		ТекСтрока.КоличествоУпаковок = ТекСтрока.Количество;
		// заполним Количество с учетом единиц измерения
		Если ЗначениеЗаполнено(ТекСтрока.Упаковка) Тогда
			ТекКоэффициент = Справочники.УпаковкиЕдиницыИзмерения.КоэффициентУпаковки(ТекСтрока.Упаковка, ТекСтрока.Номенклатура);
		Иначе
			ТекКоэффициент = 1;
		КонецЕсли;
		ТекСтрока.Количество = ТекСтрока.КоличествоУпаковок * ТекКоэффициент;
	КонецЦикла;
	
	ДанныеДляЗаполнения = Новый Структура();
	ДанныеДляЗаполнения.Вставить("Шапка", ДанныеОбъекта);
	ДанныеДляЗаполнения.Вставить("Товары", Товары);
	
	Возврат ДанныеДляЗаполнения;
	
КонецФункции

Функция ПодготовитьСтруктуруДляПоступленияУслугПоПередачеРабот(ДеревоДанных) Экспорт
	
	ДанныеОбъекта = Новый Структура;
	
	Валюта = Неопределено;
	ЭлектронноеВзаимодействиеПереопределяемый.НайтиСсылкуНаОбъект(
				"Валюты", Валюта, ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод"));
	ДанныеОбъекта.Вставить("Валюта", Валюта);
	ДанныеОбъекта.Вставить("КурсЧислитель", 1);
	ДанныеОбъекта.Вставить("КурсЗнаменатель", 1);
	
	ДанныеОбъекта.Вставить("НомерВходящегоДокумента", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерАкта"));
	ДанныеОбъекта.Вставить("ДатаВходящегоДокумента",  ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаАкта"));
	
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления")) Тогда
		ДанныеОбъекта.Вставить("Исправление", Истина);
		ДанныеОбъекта.Вставить("НомерИсправления", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления"));
		ДанныеОбъекта.Вставить("ДатаИсправления",  ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсправления"));
	Иначе
		ДанныеОбъекта.Вставить("Исправление", Ложь);
	КонецЕсли;
	
	// Сведения о поставщике.
	ИННПоставщика = ""; КПППоставщика = "";
	ВидУчастника = "Заказчик";
	Если ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ЮЛ" Тогда
		ИННПоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
		КПППоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ИП" Тогда
		ИННПоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН");
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ФЛ" Тогда
		ИННПоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.ИНН");
	КонецЕсли;
	Контрагент = Справочники.Контрагенты.ПустаяСсылка();	
	СсылкаНаОбъектПоИННКПП("Контрагенты", ИННПоставщика, КПППоставщика, Контрагент);
	Если ЗначениеЗаполнено(Контрагент) Тогда
		ДанныеОбъекта.Вставить("Контрагент", Контрагент);
		ДанныеОбъекта.Вставить("Партнер",  	 Контрагент.Партнер);
	КонецЕсли;
	
	// Сведения о покупателе.
	ИННПокупателя = ""; КПППокупателя = "";
	ВидУчастника = "Исполнитель";
	Если ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ЮЛ" Тогда
		ИННПокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
		КПППокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ИП" Тогда
		ИННПокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН");
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ФЛ" Тогда
		ИННПокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.ИНН");
	КонецЕсли;
	Организация = Справочники.Организации.ПустаяСсылка();
	СсылкаНаОбъектПоИННКПП("Организации", ИННПокупателя, КПППокупателя, Организация);
	ДанныеОбъекта.Вставить("Организация", Организация);
	
	ТЗ = Документы.ПриобретениеУслугПрочихАктивов.ПустаяСсылка().Расходы.ВыгрузитьКолонки();
	
	СведенияОТоварах = ДеревоДанных.Строки.Найти("ТаблицаУслуг", "ПолныйПуть");
	Для Каждого СведенияОТоваре Из СведенияОТоварах.Строки Цикл
		
		НоваяСтрока = ТЗ.Добавить();
		
		// Обязательные реквизиты:
		НоваяСтрока.СтавкаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "ТаблицаУслуг.НомерСтроки.СтавкаНДС");
		НоваяСтрока.СуммаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,  "ТаблицаУслуг.НомерСтроки.СуммаНДС");
		
		// Необязательные реквизиты:
		НоваяСтрока.Количество = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "ТаблицаУслуг.НомерСтроки.Количество");
		НоваяСтрока.Цена = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "ТаблицаУслуг.НомерСтроки.Цена");
		НоваяСтрока.Сумма = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "ТаблицаУслуг.НомерСтроки.СуммаБезНДС");
		НоваяСтрока.СуммаСНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "ТаблицаУслуг.НомерСтроки.СуммаСНДС");
		
		НаименованиеНоменклатуры = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "ТаблицаУслуг.НомерСтроки.НаименованиеНоменклатуры");
		Если ЗначениеЗаполнено(НаименованиеНоменклатуры) Тогда
			НоваяСтрока.Содержание = НаименованиеНоменклатуры;
		Иначе
			НоваяСтрока.Содержание = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "ТаблицаУслуг.НомерСтроки.Описание");
		КонецЕсли;
		
	КонецЦикла;
	
	ДанныеДляЗаполнения = Новый Структура();
	ДанныеДляЗаполнения.Вставить("Шапка", ДанныеОбъекта);
	ДанныеДляЗаполнения.Вставить("Расходы", ТЗ);
	
	Возврат ДанныеДляЗаполнения;
	
КонецФункции

Функция ПодготовитьСтруктуруДляОтчетаКомиссионераУПД_2019(ДеревоДанных) Экспорт
	
	ДанныеОбъекта = Новый Структура;
	
	Валюта = Неопределено;
	ЭлектронноеВзаимодействиеПереопределяемый.НайтиСсылкуНаОбъект(
				"Валюты", Валюта, ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод"));
	ДанныеОбъекта.Вставить("Валюта", Валюта);
	ДанныеОбъекта.Вставить("ВалютаВзаиморасчетов", Валюта);
	Курс = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДополнительныеСведенияОбУчастниках.ВалютаКурс");
	ДанныеОбъекта.Вставить("КурсЧислитель", ?(ЗначениеЗаполнено(Курс), Курс, 1));
	ДанныеОбъекта.Вставить("КурсЗнаменатель", 1);
	
	ДанныеОбъекта.Вставить("НомерВходящегоДокумента", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерДокумента"));
	ДанныеОбъекта.Вставить("ДатаВходящегоДокумента",  ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокумента"));
	
	ДанныеОбъекта.Вставить("ХозяйственнаяОперация", Перечисления.ХозяйственныеОперации.РеализацияЧерезКомиссионера);
	
	ДанныеОбъекта.Вставить("Организация", ОрганизацияПоДаннымЭД(ДеревоДанных, "СведенияОКомитенте"));
	
	СведенияОПродавце = ДеревоДанных.Строки.Найти("СведенияОПродавце", "ПолныйПуть");
	СведенияОПокупателе = ДеревоДанных.Строки.Найти("СведенияОПокупателе", "ПолныйПуть");
	
	Если СведенияОПродавце.Строки.Количество() > 1
		ИЛИ СведенияОПокупателе.Строки.Количество() > 1 Тогда
		ТекстИсключения = СтрШаблон(НСтр("ru = 'Ошибка загрузки электронной товарной накладной %1 от %2.'"), 
			ДанныеОбъекта.Номер, Формат(ДанныеОбъекта.ДатаСоставления,"ДЛФ=D")) + Символы.ПС
			+ НСтр("ru = 'Загрузка сводных накладных не поддерживается.'");
		ВызватьИсключение ТекстИсключения;
	КонецЕсли;
	
	// Сведения о комиссионере.
	Для Каждого СтрокаПродавца Из СведенияОПродавце.Строки Цикл
		Контрагент = КонтрагентПоДаннымЭД(СтрокаПродавца, "СведенияОПродавце.НомерСтроки");
		Прервать;
	КонецЦикла;
	
	Если ЗначениеЗаполнено(Контрагент) Тогда
		ДанныеОбъекта.Вставить("Контрагент", Контрагент);
		ДанныеОбъекта.Вставить("Партнер",    Контрагент.Партнер);
	КонецЕсли;
	
	// Сведения о конечном покупателе.
	Для каждого СтрокаПокупателя Из СведенияОПокупателе.Строки Цикл
		Покупатель = КонтрагентПоДаннымЭД(СтрокаПокупателя, "СведенияОПокупателе.НомерСтроки");
		Прервать;
	КонецЦикла;
	
	// Сведения об основании.
	СведенияОДокументеОтгрузки = ДеревоДанных.Строки.Найти("ОснованиеОтгрузкиТоваров", "ПолныйПуть");
	Для Каждого СтрокиСведений Из СведенияОДокументеОтгрузки.Строки Цикл
		ДокументНаименование = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СтрокиСведений, "ОснованиеОтгрузкиТоваров.НомерСтроки.ДокументНаименование");
		ДанныеОбъекта.Вставить("ДатаДокументаОснования", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СтрокиСведений, "ОснованиеОтгрузкиТоваров.НомерСтроки.ДокументДата"));
		ДанныеОбъекта.Вставить("НомерДокументаОснования", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СтрокиСведений, "ОснованиеОтгрузкиТоваров.НомерСтроки.ДокументНомер"));
		Прервать;
	КонецЦикла;

	// Сведения о входящем документе.
	СведенияОДокументеПодтвержденияОтгрузки = ДеревоДанных.Строки.Найти("ДокументыПодтвержденияОтгрузки", "ПолныйПуть");
	НомерВходящегоДокумента = Неопределено;
	ДатаВходящегоДокумента = Неопределено;
	Для Каждого СтрокиСведений Из СведенияОДокументеПодтвержденияОтгрузки.Строки Цикл
		НомерВходящегоДокумента = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СтрокиСведений, "ДокументыПодтвержденияОтгрузки.НомерСтроки.Номер");
		ДатаВходящегоДокумента  = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СтрокиСведений, "ДокументыПодтвержденияОтгрузки.НомерСтроки.Дата");
		Прервать;
	КонецЦикла;
	
	ДанныеОбъекта.Вставить("СуммаДокумента", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоКОплате.ВсегоСтоимостьТоваровСНалогом"));
	
	ИменаСвойств = "НомерДоговора, ДатаДоговора";
	ДополнительныеСведения = ПолучитьДополнительныеСведения(ДеревоДанных,, ИменаСвойств);
	
	Если ДополнительныеСведения.НомерДоговора <> Неопределено
		И ДополнительныеСведения.ДатаДоговора <> Неопределено
		И ЗначениеЗаполнено(Контрагент) Тогда
		Договор = Неопределено;
		Попытка
			ДатаДоговора = Дата(ДополнительныеСведения.ДатаДоговора+" 0:00:00");
		Исключение
			ДатаДоговора = Дата('00010101');
		КонецПопытки;
		ДополнительныеСведения.Вставить("ДатаДоговора", ДатаДоговора);
		ДополнительныеСведения.Вставить("Владелец", Контрагент);
		ДополнительныеСведения.Вставить("КомиссионныеПродажи25", Истина);
		ЭлектронноеВзаимодействиеПереопределяемый.НайтиСсылкуНаОбъект("ДоговорыКонтрагентов", Договор,, ДополнительныеСведения);
		ДанныеОбъекта.Вставить("Договор", Договор);
	КонецЕсли;
	
	Товары = Документы.ОтчетКомиссионера.ПустаяСсылка().Товары.ВыгрузитьКолонки();
	
	ШтрихкодыУпаковок = ЭлектронноеВзаимодействиеИСМП.НоваяТаблицаШтрихкодыУпаковок();
	ПараметрыЗаполненияСтрокиТоваров = ПараметрыЗаполненияСтрокиТоваровСведениямиОПрослеживаемости();
	
	СведенияОТоварах = ДеревоДанных.Строки.Найти("СведенияОТоварах", "ПолныйПуть");
	Для Каждого СведенияОТоваре Из СведенияОТоварах.Строки Цикл
		
		Признак = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.Признак");
		
		НоваяСтрока = Товары.Добавить();
		
		НоваяСтрока.Покупатель = Покупатель;
		
		// Обязательные реквизиты:
		СтавкаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.НалоговаяСтавка");
		НоваяСтрока.СтавкаНДС = ?(СтавкаНДС = "НДС исчисляется налоговым агентом", УчетНДСУП.СтавкаНДСПоУмолчанию(ДанныеОбъекта.Организация, ТекущаяДатаСеанса(), Истина), СтавкаНДС);
		НоваяСтрока.СуммаПродажиНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СуммаНалога");
		
		// Необязательные реквизиты:
		НоваяСтрока.Количество = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.Количество");
		НоваяСтрока.ЦенаПродажи = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.ЦенаЗаЕдиницуИзмерения");
		НоваяСтрока.СуммаПродажи = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогом");
		
		Если НоваяСтрока.Количество = 0 Тогда
			НоваяСтрока.Количество = 1;
			Если НоваяСтрока.ЦенаПродажи = 0 Тогда
				НоваяСтрока.ЦенаПродажи = НоваяСтрока.СуммаПродажи;
			КонецЕсли;
		КонецЕсли;
		
		Сопоставление = СведенияОТоваре.Строки.Найти(
			"СведенияОТоварах.НомерСтроки.Сопоставление", "ПолныйПуть", Истина);
		Если Сопоставление <> Неопределено Тогда
			
			Идентификатор = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.Сопоставление.Идентификатор");
			Если ЗначениеЗаполнено(Идентификатор) Тогда
				НоменклатураПартнера = НоменклатураПартнеровСервер.НайтиСсылкуНаНоменклатуруПартнераПоИдентификатору(Идентификатор);
				Если ЗначениеЗаполнено(НоменклатураПартнера) Тогда
					НоваяСтрока.НоменклатураПартнера = НоменклатураПартнера;
				КонецЕсли;
			КонецЕсли;
			
			Номенклатура = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.Сопоставление.НоменклатураИБ");
			Если ЗначениеЗаполнено(Номенклатура) Тогда
				НоваяСтрока.Номенклатура = Номенклатура;
			КонецЕсли;
			
			Характеристика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.Сопоставление.ХарактеристикаИБ");
			Если ЗначениеЗаполнено(Характеристика) Тогда
				НоваяСтрока.Характеристика = Характеристика;
			КонецЕсли;
			
			Упаковка = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.Сопоставление.УпаковкаИБ");
			Если ЗначениеЗаполнено(Упаковка) Тогда
				НоваяСтрока.Упаковка = Упаковка;
			КонецЕсли;
			
		КонецЕсли;
		
		ЭтоИмущество = Ложь;
		Если ЗначениеЗаполнено(Признак) Тогда
			ЭтоИмущество = ?(Признак = "1", Истина, Ложь);
		Иначе
			ЭтоИмущество = Истина;
		КонецЕсли;
		
		ТипНоменклатуры = НоваяСтрока.Номенклатура.ТипНоменклатуры;
		Если ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Услуга") Тогда
			ЭтоИмущество = Ложь;
		ИначеЕсли ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Товар")
				Или ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Набор") Тогда
			ЭтоИмущество = Истина;
		КонецЕсли;
		
		Если ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НоваяСтрока.Номенклатура, "ВестиУчетПоГТД") = Истина Тогда
			ВестиУчетПоГТД = Истина;
		Иначе
			ВестиУчетПоГТД = Ложь;
		КонецЕсли;
		
		Если ЭтоИмущество
			И ВестиУчетПоГТД Тогда
			
			СведенияОПрослеживаемости		= СведенияОТоваре.Строки.Найти(
												"СведенияОТоварах.НомерСтроки.СведенияОПрослеживаемости",
												"ПолныйПуть",
												Истина);
			СведенияОТаможеннойДекларации	= СведенияОТоваре.Строки.Найти(
												"СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации",
												"ПолныйПуть",
												Истина);
												
			ПараметрыЗаполненияСтрокиТоваров.Вставить("ЭтоУПД_2019", Истина);
												
			ЗаполнитьСтрокуТоваровСведениямиОПрослеживаемости(НоваяСтрока,
																Товары,
																СведенияОПрослеживаемости,
																СведенияОТаможеннойДекларации,
																ПараметрыЗаполненияСтрокиТоваров);
			
			ЗаполнитьСтрокуТоваровСведениямиОТаможеннойДекларации(НоваяСтрока,
																	СведенияОТаможеннойДекларации,
																	ПараметрыЗаполненияСтрокиТоваров);
			
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеИСМП.ДобавитьШтрихкодыТаблицуШтрихкодовУпаковок_2019(ШтрихкодыУпаковок, СведенияОТоваре);
		
	КонецЦикла;
	
	ЭлектронноеВзаимодействиеИСМП.СвернутьТаблицуШтрихкодовУпаковок(ШтрихкодыУпаковок);
	
	// заполним Характеристики и Упаковки по соответствию из НоменклатурыПоставщика,
	//Переносим значения из колонки СуммаСкидки в СуммаРучнойСкидки, т.к. название реквизита табличной части документа
	//не совпадает с названием реквизита СтрокиДляЗагрузки

	Для Каждого ТекСтрока Из Товары Цикл 
		ТекСтрока.КоличествоУпаковок = ТекСтрока.Количество;
		// заполним Количество с учетом единиц измерения
		Если ЗначениеЗаполнено(ТекСтрока.Упаковка) Тогда
			ТекКоэффициент = Справочники.УпаковкиЕдиницыИзмерения.КоэффициентУпаковки(ТекСтрока.Упаковка, ТекСтрока.Номенклатура);
		Иначе
			ТекКоэффициент = 1;
		КонецЕсли;
		ТекСтрока.Количество = ТекСтрока.КоличествоУпаковок * ТекКоэффициент;
	КонецЦикла;
	
	ДанныеДляЗаполнения = Новый Структура();
	ДанныеДляЗаполнения.Вставить("Шапка", ДанныеОбъекта);
	ДанныеДляЗаполнения.Вставить("Товары", Товары);
	ДанныеДляЗаполнения.Вставить("ШтрихкодыУпаковок", ШтрихкодыУпаковок);
	
	Возврат ДанныеДляЗаполнения;
	
КонецФункции

// Получает дополнительные данные из ЭД.
//
// Параметры:
//  ДеревоДанных - ДеревоЗначений - данные для заполнения электронного документа.
//  РазделДанных - Строка - имя раздела дополнительных данных.
//  ИменаСвойств - Строка - Названия идентификаторов дополнительных данных.
//
// Возвращаемое значение:
//  Структура - структура содержащая данные дополнительного раздела. Состав зависит от данных доп. раздела.
//
Функция ПолучитьДополнительныеСведения(ДеревоДанных, РазделДанных = "ДопДанныеДокументаОтгрузки", ИменаСвойств = "") Экспорт
	
	СтруктураДополнительныхЗначений = Новый Структура();
	ИменаСвойств = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(ИменаСвойств,",",, Истина);
	Для Каждого Элемент Из ИменаСвойств Цикл
		СтруктураДополнительныхЗначений.Вставить(Элемент, Неопределено);
	КонецЦикла;
	
	ДополнительныеДанные = ДеревоДанных.Строки.Найти(РазделДанных, "ПолныйПуть");
	Если ДополнительныеДанные <> Неопределено Тогда
		ТекстоваяИнформация = ДополнительныеДанные.Строки.Найти(РазделДанных + ".ТекстоваяИнформация", "ПолныйПуть");
		Для Каждого СтрокиСведений Из ТекстоваяИнформация.Строки Цикл
			НазваниеИдентификатора = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СтрокиСведений, РазделДанных + ".ТекстоваяИнформация.НомерСтроки.Идентификатор");
			Если НазваниеИдентификатора <> Неопределено И ЗначениеЗаполнено(ИменаСвойств) И ИменаСвойств.Найти(НазваниеИдентификатора) <> Неопределено Тогда
				ЗначениеИдентификатора = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СтрокиСведений, РазделДанных + ".ТекстоваяИнформация.НомерСтроки.Значение", Ложь);
				СтруктураДополнительныхЗначений.Вставить(НазваниеИдентификатора, ЗначениеИдентификатора);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Возврат СтруктураДополнительныхЗначений;
	
КонецФункции

Процедура ЗаполнитьУПДДокументОтчетКомиссионера_2019(Документ, ДанныеДляЗагрузки, Записывать) Экспорт
	
	Текст = "";
	
	Если ДанныеДляЗагрузки.Свойство("Шапка") Тогда 
		ДанныеЗаполнения = ДанныеДляЗагрузки.Шапка;
	КонецЕсли; 
	
	РежимЗаписи = РежимЗаписиДокумента.Запись;
	Если ЗначениеЗаполнено(Документ) Тогда // получены изменения по существующему документу
		ДокументОбъект = Документ.ПолучитьОбъект();
		//Попытка заблокировать документ
		Попытка
			ДокументОбъект.Заблокировать();
		Исключение
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить данные документа ""%1"".
				|Возможно, документ редактируется другим пользователем'"),
				Строка(ДокументОбъект.Ссылка));
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
		//конец попытки заблокировать документ
		Если ДокументОбъект.Проведен Тогда 
			РежимЗаписи = РежимЗаписиДокумента.Проведение;
			Текст = НСтр("ru = 'Операция возможна только для непроведенных документов'");
		КонецЕсли;
	Иначе  // создаем новый
		ДокументОбъект = Документы.ОтчетКомиссионера.СоздатьДокумент();
		ДокументОбъект.Дата = ТекущаяДатаСеанса();
		ДокументОбъект.Заполнить(ДанныеЗаполнения);
		ДокументОбъект.УстановитьНовыйНомер();
	КонецЕсли;
	ДокументОбъект.ОбменДанными.Загрузка = Истина; 
	// заполнение контрагента
	Если ДанныеЗаполнения.Свойство("Контрагент") Тогда
		ДокументОбъект.Контрагент = ДанныеЗаполнения.Контрагент;
	КонецЕсли;	
	
	// вручную переопределим, если требуется
	ПерезаполнениеЗначенийРеквизитовШапки(ДокументОбъект, ДанныеЗаполнения);
	
	// заполнение соглашения по статистике
	Если Не ЗначениеЗаполнено(ДокументОбъект.Соглашение) Тогда
		ЗаполнитьСоглашениеПоСтатистике(ДокументОбъект);
	КонецЕсли;
	
	ДокументОбъект.Товары.Загрузить(ДанныеДляЗагрузки.Товары);
	
	Если ДокументОбъект.Товары.Итог("СуммаПродажиНДС") = 0 Тогда
		ДокументОбъект.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС;
	Иначе
		ДокументОбъект.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС;
	КонецЕсли;

	Попытка
		Если Записывать Тогда
			ДокументОбъект.Записать(РежимЗаписи);
			ДокументОбъект.Разблокировать();			
			Документ = ДокументОбъект.Ссылка;
			
			//Запись в Реестр документов
			ТаблицыДанных = ПроведениеДокументов.ДанныеДокументаДляПроведения(ДокументОбъект.Ссылка, "РеестрДокументов");
			РегистрыСведений.РеестрДокументов.ЗаписатьДанные(ТаблицыДанных, ДокументОбъект.Ссылка, Неопределено, Ложь);
		Иначе
			Документ = ДокументОбъект;
		КонецЕсли;
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка()),
					Текст); 
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка, ДокументОбъект.Метаданные(), Документ, 
									ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;
	
КонецПроцедуры

Функция ПодготовитьСтруктуруДляРеализацииТоваровУслугУПД_2019(ДеревоДанных) Экспорт
	
	ДанныеОбъекта = Новый Структура;
	
	Валюта = Неопределено;
	ЭлектронноеВзаимодействиеПереопределяемый.НайтиСсылкуНаОбъект(
				"Валюты", Валюта, ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод"));
	ДанныеОбъекта.Вставить("Валюта", Валюта);
	ДанныеОбъекта.Вставить("ВалютаВзаиморасчетов", Валюта);
	Курс = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДополнительныеСведенияОбУчастниках.ВалютаКурс");
	ДанныеОбъекта.Вставить("КурсЧислитель", ?(ЗначениеЗаполнено(Курс), Курс, 1));
	ДанныеОбъекта.Вставить("КурсЗнаменатель", 1);
	
	ДанныеОбъекта.Вставить("НомерВходящегоДокумента", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерДокумента"));
	ДанныеОбъекта.Вставить("ДатаВходящегоДокумента",  ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокумента"));
	
	ДанныеОбъекта.Вставить("ХозяйственнаяОперация", Перечисления.ХозяйственныеОперации.РеализацияЧерезКомиссионера);
	
	ДанныеОбъекта.Вставить("Организация", ОрганизацияПоДаннымЭД(ДеревоДанных, "СведенияОКомитенте"));
	
	СведенияОПродавце = ДеревоДанных.Строки.Найти("СведенияОПродавце", "ПолныйПуть");
	СведенияОПокупателе = ДеревоДанных.Строки.Найти("СведенияОПокупателе", "ПолныйПуть");
	
	Если СведенияОПродавце.Строки.Количество() > 1
		ИЛИ СведенияОПокупателе.Строки.Количество() > 1 Тогда
		ТекстИсключения = СтрШаблон(НСтр("ru = 'Ошибка загрузки электронной товарной накладной %1 от %2.'"), 
			ДанныеОбъекта.Номер, Формат(ДанныеОбъекта.ДатаСоставления,"ДЛФ=D")) + Символы.ПС
			+ НСтр("ru = 'Загрузка сводных накладных не поддерживается.'");
		ВызватьИсключение ТекстИсключения;
	КонецЕсли;
	
	// Сведения о комиссионере.
	Для Каждого СтрокаПродавца Из СведенияОПродавце.Строки Цикл
		Контрагент = КонтрагентПоДаннымЭД(СтрокаПродавца, "СведенияОПродавце.НомерСтроки");
		Прервать;
	КонецЦикла;
	
	Если ЗначениеЗаполнено(Контрагент) Тогда
		ДанныеОбъекта.Вставить("Контрагент", Контрагент);
		ДанныеОбъекта.Вставить("Партнер",    Контрагент.Партнер);
	КонецЕсли;
	
	// Сведения о конечном покупателе.
	Для каждого СтрокаПокупателя Из СведенияОПокупателе.Строки Цикл
		Покупатель = КонтрагентПоДаннымЭД(СтрокаПокупателя, "СведенияОПокупателе.НомерСтроки");
		Прервать;
	КонецЦикла;
	
	Если ЗначениеЗаполнено(Покупатель) Тогда
		ДанныеОбъекта.Вставить("КлиентКонтрагент", Покупатель);
		ДанныеОбъекта.Вставить("КлиентПартнер",    Покупатель.Партнер);
	КонецЕсли;

	// Сведения об основании.
	СведенияОДокументеОтгрузки = ДеревоДанных.Строки.Найти("ОснованиеОтгрузкиТоваров", "ПолныйПуть");
	Для Каждого СтрокиСведений Из СведенияОДокументеОтгрузки.Строки Цикл
		ДанныеОбъекта.Вставить("ДатаДокументаОснования", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СтрокиСведений, "ОснованиеОтгрузкиТоваров.НомерСтроки.ДокументДата"));
		ДанныеОбъекта.Вставить("НомерДокументаОснования", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СтрокиСведений, "ОснованиеОтгрузкиТоваров.НомерСтроки.ДокументНомер"));
		Прервать;
	КонецЦикла;

	// Сведения о входящем документе.
	СведенияОДокументеПодтвержденияОтгрузки = ДеревоДанных.Строки.Найти("ДокументыПодтвержденияОтгрузки", "ПолныйПуть");
	НомерВходящегоДокумента = Неопределено;
	ДатаВходящегоДокумента = Неопределено;
	Для Каждого СтрокиСведений Из СведенияОДокументеПодтвержденияОтгрузки.Строки Цикл
		НомерВходящегоДокумента = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СтрокиСведений, "ДокументыПодтвержденияОтгрузки.НомерСтроки.Номер");
		ДатаВходящегоДокумента  = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СтрокиСведений, "ДокументыПодтвержденияОтгрузки.НомерСтроки.Дата");
		Прервать;
	КонецЦикла;	
	
	ДанныеОбъекта.Вставить("Сумма", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоКОплате.ВсегоСтоимостьТоваровСНалогом"));
	
	ИменаСвойств = "НомерДоговора, ДатаДоговора";
	ДополнительныеСведения = ПолучитьДополнительныеСведения(ДеревоДанных,, ИменаСвойств);
	
	Если ДополнительныеСведения.НомерДоговора <> Неопределено
		И ДополнительныеСведения.ДатаДоговора <> Неопределено
		И ЗначениеЗаполнено(Контрагент) Тогда
		Договор = Неопределено;
		Попытка
			ДатаДоговора = Дата(ДополнительныеСведения.ДатаДоговора+" 0:00:00");
		Исключение
			ДатаДоговора = Дата('00010101');
		КонецПопытки;
		ДополнительныеСведения.Вставить("ДатаДоговора", ДатаДоговора);
		ДополнительныеСведения.Вставить("Владелец", Контрагент);
		ДополнительныеСведения.Вставить("КомиссионныеПродажи25", Истина);
		ЭлектронноеВзаимодействиеПереопределяемый.НайтиСсылкуНаОбъект("ДоговорыКонтрагентов", Договор,, ДополнительныеСведения);
		ДанныеОбъекта.Вставить("Договор", Договор);
	КонецЕсли;
	
	Товары = Документы.РеализацияТоваровУслуг.ПустаяСсылка().Товары.ВыгрузитьКолонки();
	Товары.Колонки.Добавить("НомерГТД", Новый ОписаниеТипов("СправочникСсылка.НомераГТД"));
	Товары.Колонки.Добавить("КоличествоПоРНПТ", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(23, 11, ДопустимыйЗнак.Неотрицательный)));
	
	ШтрихкодыУпаковок = ЭлектронноеВзаимодействиеИСМП.НоваяТаблицаШтрихкодыУпаковок();
	ПараметрыЗаполненияСтрокиТоваров = ПараметрыЗаполненияСтрокиТоваровСведениямиОПрослеживаемости();
	
	СведенияОТоварах = ДеревоДанных.Строки.Найти("СведенияОТоварах", "ПолныйПуть");
	
	ЕстьДанныеПоГТД = Ложь;
	
	Для Каждого СведенияОТоваре Из СведенияОТоварах.Строки Цикл
		
		Признак = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.Признак");
		
		НоваяСтрока = Товары.Добавить();
		
		// Обязательные реквизиты:
		СтавкаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.НалоговаяСтавка");
		НоваяСтрока.СтавкаНДС = ?(СтавкаНДС = "НДС исчисляется налоговым агентом", УчетНДСУП.СтавкаНДСПоУмолчанию(ДанныеОбъекта.Организация, ТекущаяДатаСеанса(), Истина), СтавкаНДС);
		НоваяСтрока.СуммаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СуммаНалога");
		
		// Необязательные реквизиты:
		НоваяСтрока.Количество = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.Количество");
		НоваяСтрока.Цена = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.ЦенаЗаЕдиницуИзмерения");
		НоваяСтрока.Сумма = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровБезНалога");
		НоваяСтрока.СуммаСНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогом");
		
		Если НоваяСтрока.Количество = 0 Тогда
			НоваяСтрока.Количество = 1;
			Если НоваяСтрока.Цена = 0 Тогда
				НоваяСтрока.Цена = НоваяСтрока.СуммаСНДС;
			КонецЕсли;
		КонецЕсли;
		
		Сопоставление = СведенияОТоваре.Строки.Найти(
			"СведенияОТоварах.НомерСтроки.Сопоставление", "ПолныйПуть", Истина);
		Если Сопоставление <> Неопределено Тогда
			
			Идентификатор = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.Сопоставление.Идентификатор");
			Если ЗначениеЗаполнено(Идентификатор) Тогда
				НоменклатураПартнера = НоменклатураПартнеровСервер.НайтиСсылкуНаНоменклатуруПартнераПоИдентификатору(Идентификатор);
				Если ЗначениеЗаполнено(НоменклатураПартнера) Тогда
					НоваяСтрока.НоменклатураПартнера = НоменклатураПартнера;
				КонецЕсли;
			КонецЕсли;
			
			Номенклатура = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.Сопоставление.НоменклатураИБ");
			Если ЗначениеЗаполнено(Номенклатура) Тогда
				НоваяСтрока.Номенклатура = Номенклатура;
			КонецЕсли;
			
			Характеристика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.Сопоставление.ХарактеристикаИБ");
			Если ЗначениеЗаполнено(Характеристика) Тогда
				НоваяСтрока.Характеристика = Характеристика;
			КонецЕсли;
			
			Упаковка = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.Сопоставление.УпаковкаИБ");
			Если ЗначениеЗаполнено(Упаковка) Тогда
				НоваяСтрока.Упаковка = Упаковка;
			КонецЕсли;
			
		КонецЕсли;
		
		ЭтоИмущество = Ложь;
		Если ЗначениеЗаполнено(Признак) Тогда
			ЭтоИмущество = ?(Признак = "1", Истина, Ложь);
		Иначе
			ЭтоИмущество = Истина;
		КонецЕсли;
		
		ТипНоменклатуры = НоваяСтрока.Номенклатура.ТипНоменклатуры;
		Если ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Услуга") Тогда
			ЭтоИмущество = Ложь;
		ИначеЕсли ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Товар")
				Или ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Набор") Тогда
			ЭтоИмущество = Истина;
		КонецЕсли;
		
		Если ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НоваяСтрока.Номенклатура, "ВестиУчетПоГТД") = Истина Тогда
			ВестиУчетПоГТД = Истина;
			ЕстьДанныеПоГТД = Истина;
		Иначе
			ВестиУчетПоГТД = Ложь;
		КонецЕсли;
		
		Если ЭтоИмущество
			И ВестиУчетПоГТД Тогда
			
			СведенияОПрослеживаемости		= СведенияОТоваре.Строки.Найти(
												"СведенияОТоварах.НомерСтроки.СведенияОПрослеживаемости",
												"ПолныйПуть",
												Истина);
			СведенияОТаможеннойДекларации	= СведенияОТоваре.Строки.Найти(
												"СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации",
												"ПолныйПуть",
												Истина);

			ПараметрыЗаполненияСтрокиТоваров.Вставить("ЭтоУПД_2019", Истина);
												
			ЗаполнитьСтрокуТоваровСведениямиОПрослеживаемости(НоваяСтрока,
																Товары,
																СведенияОПрослеживаемости,
																СведенияОТаможеннойДекларации,
																ПараметрыЗаполненияСтрокиТоваров);
			
			ЗаполнитьСтрокуТоваровСведениямиОТаможеннойДекларации(НоваяСтрока,
																	СведенияОТаможеннойДекларации,
																	ПараметрыЗаполненияСтрокиТоваров);
			
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеИСМП.ДобавитьШтрихкодыТаблицуШтрихкодовУпаковок_2019(ШтрихкодыУпаковок, СведенияОТоваре);
		
	КонецЦикла;

	ЭлектронноеВзаимодействиеИСМП.СвернутьТаблицуШтрихкодовУпаковок(ШтрихкодыУпаковок);

	// заполним Характеристики и Упаковки по соответствию из НоменклатурыПоставщика,
	//Переносим значения из колонки СуммаСкидки в СуммаРучнойСкидки, т.к. название реквизита табличной части документа
	//не совпадает с названием реквизита СтрокиДляЗагрузки
	
	НомерСтроки = 1;
	Для Каждого ТекСтрока Из Товары Цикл
		ТекСтрока.НомерСтроки = НомерСтроки;
		ТекСтрока.КоличествоУпаковок = ТекСтрока.Количество;
		// заполним Количество с учетом единиц измерения
		Если ЗначениеЗаполнено(ТекСтрока.Упаковка) Тогда
			ТекКоэффициент = Справочники.УпаковкиЕдиницыИзмерения.КоэффициентУпаковки(ТекСтрока.Упаковка, ТекСтрока.Номенклатура);
		Иначе
			ТекКоэффициент = 1;
		КонецЕсли;
		ТекСтрока.Количество = ТекСтрока.КоличествоУпаковок * ТекКоэффициент;
		НомерСтроки = НомерСтроки + 1;
	КонецЦикла;
	
	ДанныеДляЗаполнения = Новый Структура();
	ДанныеДляЗаполнения.Вставить("Шапка", ДанныеОбъекта);
	ДанныеДляЗаполнения.Вставить("Товары", Товары);
	ДанныеДляЗаполнения.Вставить("ШтрихкодыУпаковок", ШтрихкодыУпаковок);
	ДанныеДляЗаполнения.Вставить("ЕстьДанныеПоГТД", ЕстьДанныеПоГТД);

	Возврат ДанныеДляЗаполнения;
	
КонецФункции

Процедура ЗаполнитьУПДРеализациюТоваровУслуг_2019(Документ, ДанныеДляЗагрузки, Записывать) Экспорт
	
	Текст = "";
	ДанныеЗаполнения = Новый Структура();
	
	Если ДанныеДляЗагрузки.Свойство("Шапка") Тогда 
		ДанныеЗаполнения.Вставить("РеквизитыШапки", ДанныеДляЗагрузки.Шапка);
		Если ДанныеДляЗагрузки.Шапка.Свойство("ХозяйственнаяОперация") Тогда
			ДанныеЗаполнения.Вставить("ХозяйственнаяОперация", ДанныеДляЗагрузки.Шапка.ХозяйственнаяОперация);
		КонецЕсли;
	КонецЕсли; 
	
	РежимЗаписи = РежимЗаписиДокумента.Запись;
	Если ЗначениеЗаполнено(Документ) Тогда // получены изменения по существующему документу
		ДокументОбъект = Документ.ПолучитьОбъект();
		//Попытка заблокировать документ
		Попытка
			ДокументОбъект.Заблокировать();
		Исключение
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить данные документа ""%1"".
				|Возможно, документ редактируется другим пользователем'"),
				Строка(ДокументОбъект.Ссылка));
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
		//конец попытки заблокировать документ
		Если ДокументОбъект.Проведен Тогда 
			РежимЗаписи = РежимЗаписиДокумента.Проведение;
			Текст = НСтр("ru = 'Операция возможна только для непроведенных документов'");
		КонецЕсли;
	Иначе  // создаем новый
		ДокументОбъект = Документы.РеализацияТоваровУслуг.СоздатьДокумент();
		ДокументОбъект.Дата = ТекущаяДатаСеанса();
		ДокументОбъект.Заполнить(ДанныеЗаполнения);
		ДокументОбъект.УстановитьНовыйНомер();
	КонецЕсли;
	ДокументОбъект.ОбменДанными.Загрузка = Истина; 
	
	// вручную переопределим, если требуется
	ПерезаполнениеЗначенийРеквизитовШапки(ДокументОбъект, ДанныеЗаполнения);
	
	// заполнение соглашения по статистике
	Если Не ЗначениеЗаполнено(ДокументОбъект.Соглашение) Тогда
		ЗаполнитьСоглашениеПоСтатистике(ДокументОбъект);
	КонецЕсли;
	
	ДокументОбъект.Товары.Загрузить(ДанныеДляЗагрузки.Товары);
	
	Для Каждого Строка ИЗ ДокументОбъект.Товары Цикл
		Строка.Сумма = Строка.СуммаСНДС - Строка.СуммаНДС;
	КонецЦикла;	
	
	Если ДокументОбъект.Товары.Итог("СуммаНДС") = 0 Тогда
		ДокументОбъект.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС;
	Иначе
		ДокументОбъект.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС;
	КонецЕсли;

	Если ДанныеДляЗагрузки.ЕстьДанныеПоГТД
	И ЗначениеЗаполнено(ДокументОбъект.Договор) Тогда
		Отказ = Ложь;
		ТаблицыДокумента = Новый Структура();
		ТаблицыДокумента.Вставить("Товары", ДанныеДляЗагрузки.Товары);
		ДокументОбъект.ЗаполнитьВидыЗапасовПриОбмене(Отказ, ТаблицыДокумента);
		Если Отказ Тогда
			ВызватьИсключение НСтр("ru = 'Не удалось заполнить виды запасов'");
		КонецЕсли;
	КонецЕсли;
	
	Попытка
		Если Записывать Тогда
			ДокументОбъект.Записать(РежимЗаписи);
			ДокументОбъект.Разблокировать();			
			Документ = ДокументОбъект.Ссылка;
			
			//Запись в Реестр документов
			ТаблицыДанных = ПроведениеДокументов.ДанныеДокументаДляПроведения(ДокументОбъект.Ссылка, "РеестрДокументов");
			РегистрыСведений.РеестрДокументов.ЗаписатьДанные(ТаблицыДанных, ДокументОбъект.Ссылка, Неопределено, Ложь);
		Иначе
			Документ = ДокументОбъект;
		КонецЕсли;
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка()),
					Текст); 
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка, ДокументОбъект.Метаданные(), Документ, 
									ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;
	
КонецПроцедуры

#Область ПередачаТоваров

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПередачаТоваров_ИнформацияПродавца.
Процедура ЗаполнитьДанныеПередачаТоваров_ИнформацияПродавца(Знач Основание, Знач Настройки, Данные, Описание, Отказ) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	КоличествоЗаписей = 1;
	
	ОписаниеЗамера = Неопределено;
	Если ТипЗнч(Основание) = Тип("ДокументСсылка.ПередачаТоваровМеждуОрганизациями") Тогда
		ОписаниеЗамера = ОценкаПроизводительности.НачатьЗамерДлительнойОперации(
			"ОбщийМодуль.ОбменСКонтрагентамиУТ.ЗаполнитьДанныеИнтеркампаниПередачаТоваров");
	ИначеЕсли ТипЗнч(Основание) = Тип("ДокументСсылка.ВозвратТоваровМеждуОрганизациями") Тогда
		ОписаниеЗамера = ОценкаПроизводительности.НачатьЗамерДлительнойОперации(
			"ОбщийМодуль.ОбменСКонтрагентамиУТ.ЗаполнитьДанныеИнтеркампаниВозвратТоваров");
	КонецЕсли;
	
	СтруктураЭД = ОбщегоНазначения.СкопироватьРекурсивно(Настройки, Ложь);
	
	МассивОбъектов = Новый Массив;
	МассивОбъектов.Добавить(Основание);
	ПараметрыПечати = Новый Структура("ВыводитьУслуги", Истина);
	
	ИмяОбъекта = Основание.Метаданные().Имя;	
	МенеджерОбъекта = ОбщегоНазначенияУТ.ПолучитьМодульЛокализации(ИмяОбъекта);
	Если МенеджерОбъекта = Неопределено Тогда
		МенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоПолномуИмени(ИмяОбъекта);
	КонецЕсли;
		
	ДанныеДляПечати = МенеджерОбъекта.ПолучитьДанныеДляПечатнойФормыТОРГ12(ПараметрыПечати, МассивОбъектов);
	
	ВыборкаТоваров = ДанныеДляПечати.РезультатПоТабличнойЧасти.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	РеквизитыШапки = ДанныеДляПечати.РезультатПоШапке.Выбрать();
	РеквизитыШапки.Следующий();
	
	СтруктураПоиска = Новый Структура("Ссылка", РеквизитыШапки.Ссылка);
	ВыборкаТоваров.Сбросить();
	
	НайденСледующий = ВыборкаТоваров.НайтиСледующий(СтруктураПоиска);
	
	Если НайденСледующий Тогда
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, 
			"НомерТоварнойНакладной", 
			ПрефиксацияОбъектовКлиентСервер.НомерНаПечать(РеквизитыШапки.Номер));
			
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, 
			"ДатаТоварнойНакладной", 
			РеквизитыШапки.Дата);
		
		Если ЗначениеЗаполнено(РеквизитыШапки.Основание) 
			И ЗначениеЗаполнено(РеквизитыШапки.ОснованиеДата) Тогда
			ДокументыОснования = Новый ТаблицаЗначений;
			ДокументыОснования.Колонки.Добавить("ДокОснованиеНаименование");
			ДокументыОснования.Колонки.Добавить("ДокОснованиеНомер");
			ДокументыОснования.Колонки.Добавить("ДокОснованиеДата");
		
			СтрокаДокументыОснования = ДокументыОснования.Добавить();
			
			Если СтрНайти(РеквизитыШапки.Основание, "№") Тогда
				СтрокаНаименование = Лев(РеквизитыШапки.Основание, СтрНайти(РеквизитыШапки.Основание, "№") - 2);
			Иначе
				СтрокаНаименование = РеквизитыШапки.Основание;
			КонецЕсли;
			СтрокаДокументыОснования.ДокОснованиеНаименование 	= СтрокаНаименование;
			СтрокаДокументыОснования.ДокОснованиеНомер 			= РеквизитыШапки.ОснованиеНомер;
			СтрокаДокументыОснования.ДокОснованиеДата 			= РеквизитыШапки.ОснованиеДата;
			
			// Дополним таблицу оснований параметрами обработки ошибок.
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ДокументыОснования,
				"ДокОснованиеНаименование",,, НСтр("ru = 'Не указано наименование документа основания'"));
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ДокументыОснования,
				"ДокОснованиеНомер",,, НСтр("ru = 'Не указан номер документа основания'"));
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ДокументыОснования,
				"ДокОснованиеДата",,, НСтр("ru = 'Не указана дата документа основания'"));
			
			Если ЗначениеЗаполнено(СтрокаНаименование) Тогда
				ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(Данные, ДокументыОснования, "Основание");
			КонецЕсли;
		Иначе
			ТекстОшибки = НСтр("ru = 'Возникла ошибка при заполнении основания отгрузки. Возможные причины:
			|	- в документе отгрузки не указан договор
			|	- в договоре не указана дата'");
			ЭлектронноеВзаимодействие.ДобавитьВРеквизитОбработкуОшибки(Данные,
				"Основание.НомерСтроки.ДокОснованиеДата", ТекстОшибки);
		КонецЕсли;
			
		СведенияОПоставщике       = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(РеквизитыШапки.Организация, РеквизитыШапки.БанковскийСчетОрганизации, РеквизитыШапки.Дата);
		СведенияОПокупателе       = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(РеквизитыШапки.Контрагент, РеквизитыШапки.БанковскийСчетКонтрагента, РеквизитыШапки.Дата);
		ЗаполнитьДанныеУчастникаТОРГ(Данные, СведенияОПоставщике, "Поставщик",  "Юр", РеквизитыШапки.Дата);
		ЗаполнитьДанныеУчастникаТОРГ(Данные, СведенияОПокупателе, "Плательщик", "Юр", РеквизитыШапки.Дата);
		// Заполняем структурное подразделение
		ЗаполнитьСтруктурноеПодразделение(Данные, "Поставщик", РеквизитыШапки.Ссылка.Подразделение);

		Если ЗначениеЗаполнено(РеквизитыШапки.Организация) Тогда
			НаименованиеСоставителяДокумента = СведенияОПоставщике.ПолноеНаименование + ?(ЗначениеЗаполнено(
				СведенияОПоставщике.КПП), СтрШаблон(НСтр("ru = ', ИНН/КПП %1/%2'"), СведенияОПоставщике.ИНН,
				СведенияОПоставщике.КПП), СтрШаблон(НСтр("ru = ', ИНН %1'"), СведенияОПоставщике.ИНН));
				
			ПараметрыОбработкиОшибок = ЭлектронноеВзаимодействиеКлиентСервер.НовыеПараметрыОбработкиОшибки(
				РеквизитыШапки.Ссылка, "Объект.Организация");
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				Данные, "НаименованиеСоставителяДокумента", НаименованиеСоставителяДокумента,
				ПараметрыОбработкиОшибок);
		КонецЕсли;
		
		СведенияОГрузоотправителе = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(РеквизитыШапки.Грузоотправитель, РеквизитыШапки.БанковскийСчетГрузоотправителя, РеквизитыШапки.Дата);
		СведенияОГрузополучателе  = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(РеквизитыШапки.Грузополучатель, РеквизитыШапки.БанковскийСчетГрузополучателя, РеквизитыШапки.Дата);
		Если РеквизитыШапки.Организация <> РеквизитыШапки.Грузоотправитель Тогда
			ЗаполнитьДанныеУчастникаТОРГ(Данные, СведенияОГрузоотправителе, "Грузоотправитель", "Факт", РеквизитыШапки.Дата);
		Иначе
			ЗаполнитьДанныеУчастникаТОРГ(Данные, СведенияОПоставщике, "Грузоотправитель", "Факт", РеквизитыШапки.Дата);
		КонецЕсли;
		ЗаполнитьДанныеУчастникаТОРГ(Данные, СведенияОГрузополучателе, "Грузополучатель",  "Факт", РеквизитыШапки.Дата);
		
		ТекстОшибки = НСтр("ru = 'Не удалось заполнить код валюты документа. Проверьте, что:
		|	- в документе указана валюта,
		|	- для нее заполнен код по Общероссийскому классификатору валют.'");
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "ВалютаКод", "643", ТекстОшибки);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "ВалютаНаименование", "Российский рубль");
		
		ТаблицаТоваров = Новый ТаблицаЗначений;
		ТаблицаТоваров.Колонки.Добавить("НаименованиеНоменклатуры");
		ТаблицаТоваров.Колонки.Добавить("НаименованиеХарактеристики");
		ТаблицаТоваров.Колонки.Добавить("Сорт");
		ТаблицаТоваров.Колонки.Добавить("Артикул");
		ТаблицаТоваров.Колонки.Добавить("КодТовара");
		ТаблицаТоваров.Колонки.Добавить("ЕдиницаИзмеренияНаименование");
		ТаблицаТоваров.Колонки.Добавить("БазоваяЕдиницаКод");
		ТаблицаТоваров.Колонки.Добавить("ВидУпаковки");
		ТаблицаТоваров.Колонки.Добавить("КоличествоВОдномМесте");
		ТаблицаТоваров.Колонки.Добавить("КоличествоМест");
		ТаблицаТоваров.Колонки.Добавить("МассаБрутто");
		ТаблицаТоваров.Колонки.Добавить("МассаНетто");
		ТаблицаТоваров.Колонки.Добавить("Цена");
		ТаблицаТоваров.Колонки.Добавить("СуммаБезНДС");
		ТаблицаТоваров.Колонки.Добавить("СтавкаНДС");
		ТаблицаТоваров.Колонки.Добавить("СуммаНДС");
		ТаблицаТоваров.Колонки.Добавить("СуммаСНДС");
		ТаблицаТоваров.Колонки.Добавить("ДокументОснование");
		ТаблицаТоваров.Колонки.Добавить("Номенклатура");
		ТаблицаТоваров.Колонки.Добавить("Характеристика");
		ТаблицаТоваров.Колонки.Добавить("Упаковка");
		ТаблицаТоваров.Колонки.Добавить("ДопДанныеПодписанные");
		ТаблицаТоваров.Колонки.Добавить("ДопДанныеНеПодписанные");
		ТаблицаТоваров.Колонки.Добавить("Сопоставление");
		
		ИтоговыеСуммы = СтруктураИтоговыеСуммы(СтруктураЭД.ТипДокумента);
		
		ИспользоватьНаборы = Ложь;
		Если ОбщегоНазначенияУТКлиентСервер.ЕстьРеквизитОбъекта(ВыборкаТоваров, "ЭтоНабор") Тогда
			ИспользоватьНаборы = Истина;
		КонецЕсли;
	
		СтрокаТовары = ВыборкаТоваров.Выбрать();
		КоличествоЗаписей = СтрокаТовары.Количество();
		
		ЗаполнениеКодаТовара = СтруктураЭД.ВариантыЗаполненияПолей.ТоварКод;
	
		ШтрихкодыКомбинаций = Неопределено;
		ШтрихкодыНоменклатуры = Неопределено;
		НоменклатураПартнеровСервер.ШтрихкодыПоТоварам(СтрокаТовары, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры);	

		ЗаполнятьСопоставление = Истина;
		Если ТипЗнч(Основание) = Тип("ДокументСсылка.РеализацияУслугПрочихАктивов") Тогда
			ЗаполнятьСопоставление = Ложь;
		КонецЕсли;
		
		Если ЗаполнятьСопоставление Тогда
			ВыборкаДляСопоставления = НоменклатураПартнеровСервер.ВыборкаДляСопоставленияНоменклатуры(Основание);
			СоответствиеСтавокНДСКонтрагента = Новый Соответствие;
			ЗаполнитьСоответствиеСтавокНДС(СоответствиеСтавокНДСКонтрагента);
			ТаблицаСопоставления = ВыборкаДляСопоставления.Выгрузить();
		КонецЕсли;

		НДСИсчисляетсяНалоговымАгентом = Ложь;
		Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(РеквизитыШапки, "НалогообложениеНДС") Тогда
			НДСИсчисляетсяНалоговымАгентом = (РеквизитыШапки.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ОблагаетсяНДСУПокупателя);
		КонецЕсли;
		
		Пока СтрокаТовары.Следующий() Цикл
			
			Если ИспользоватьНаборы Тогда
				Если СтрокаТовары.ЭтоНабор и СтрокаТовары.ВариантПредставленияНабораВПечатныхФормах <> Перечисления.ВариантыПредставленияНаборовВПечатныхФормах.ТолькоНабор Тогда
					Продолжить;
				КонецЕсли;
			КонецЕсли;
			
			НоваяСтрока = ТаблицаТоваров.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТовары);
			
			НоваяСтрока.Артикул = СтрокаТовары.НоменклатураКод;
			
			НоваяСтрока.МассаНетто = СтрокаТовары.Количество;
			НоваяСтрока.Цена  = Окр(СтрокаТовары.Цена, 2);
			ОкруглитьМассыТовара(НоваяСтрока);
			
			Если ЗначениеЗаполнено(НоваяСтрока.КоличествоМест) Тогда
				Если НоваяСтрока.КоличествоМест <> Цел(НоваяСтрока.КоличествоМест) Тогда
					НоваяСтрока.КоличествоМест = Цел(НоваяСтрока.КоличествоМест) + 1;
				КонецЕсли;
			КонецЕсли;
			Если ЗначениеЗаполнено(НоваяСтрока.КоличествоВОдномМесте) Тогда
				Если НоваяСтрока.КоличествоВОдномМесте <> Цел(НоваяСтрока.КоличествоВОдномМесте) Тогда
					НоваяСтрока.КоличествоВОдномМесте = Цел(НоваяСтрока.КоличествоВОдномМесте) + 1;
				КонецЕсли;
			КонецЕсли;
			
			НоваяСтрока.БазоваяЕдиницаКод = СокрЛП(СтрокаТовары.ЕдиницаИзмеренияКод);
			НоваяСтрока.НаименованиеНоменклатуры = СтрокаТовары.НоменклатураНаименование;
			НоваяСтрока.НаименованиеХарактеристики 	= СтрокаТовары.ХарактеристикаНаименование;
		
			Если НДСИсчисляетсяНалоговымАгентом Тогда
				НоваяСтрока.СтавкаНДС          = "НДС исчисляется налоговым агентом";
				НоваяСтрока.СуммаНДС           = 0;
				НоваяСтрока.СуммаСНДС          = 0;
			КонецЕсли;
			
			УпаковкаИзДокумента = Неопределено;
			Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(СтрокаТовары, "Упаковка") И ЗначениеЗаполнено(СтрокаТовары.Упаковка) Тогда
				УпаковкаИзДокумента = СтрокаТовары.Упаковка;
			ИначеЕсли ЗаполнятьСопоставление Тогда
				УпаковкаИзДокумента = ЭлектронноеВзаимодействиеУТВызовСервера.ЕдиницаХраненияНоменклатуры(СтрокаТовары.Номенклатура)
			Иначе
				УпаковкаИзДокумента = Справочники.УпаковкиЕдиницыИзмерения.ПустаяСсылка()
			КонецЕсли;		
		
			Если ЗаполнятьСопоставление Тогда
				// Сопоставление.
				ПараметрыОтбора = Новый Структура;
				ПараметрыОтбора.Вставить("Номенклатура", СтрокаТовары.Номенклатура);
				Если СтрокаТовары.Характеристика <> Неопределено Тогда
					ПараметрыОтбора.Вставить("Характеристика", СтрокаТовары.Характеристика);
				Иначе
					ПараметрыОтбора.Вставить("Характеристика", Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());				
				КонецЕсли;
				ПараметрыОтбора.Вставить("Упаковка", УпаковкаИзДокумента);
				СтрокиИзНоменклатурыКонтрагентов = ТаблицаСопоставления.НайтиСтроки(ПараметрыОтбора);
				Если СтрокиИзНоменклатурыКонтрагентов.Количество() Тогда
					НайденнаяСтрока = СтрокиИзНоменклатурыКонтрагентов[0];
					НоваяСтрока.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(НайденнаяСтрока,,,,СоответствиеСтавокНДСКонтрагента);
			    Иначе
					НоваяСтрока.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(СтрокаТовары, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры, УпаковкаИзДокумента);
				КонецЕсли;
			КонецЕсли;
	
			//Анализ вариантов заполнения
			Если ЗаполнениеКодаТовара = "Штрихкод" И НоваяСтрока.Сопоставление.Свойство("ШтрихкодКомбинации") Тогда
				НоваяСтрока.КодТовара = НоваяСтрока.Сопоставление.ШтрихкодКомбинации;
			ИначеЕсли ЗаполнениеКодаТовара = "Штрихкод" И НоваяСтрока.Сопоставление.Свойство("ШтрихкодыНоменклатуры") Тогда
				НоваяСтрока.ТоварКод = НоваяСтрока.Сопоставление.ШтрихкодыНоменклатуры[0];				
			Иначе
				НоваяСтрока.КодТовара = СтрокаТовары.НоменклатураКод;
			КонецЕсли;
			//Конец анализа вариантов заполнения
			
			РассчитатьИтоговыеСуммы(ИтоговыеСуммы, НоваяСтрока, СтруктураЭД.ТипДокумента);
		КонецЦикла;
		
		ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
			"ЕдиницаИзмеренияНаименование",,, НСтр("ru = 'Не заполнено наименование единицы измерения в справочнике ""Упаковки и единицы измерения"".'"));
		ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
			"БазоваяЕдиницаКод",,, НСтр("ru = 'Не заполнен код единицы измерения в справочнике ""Упаковки и единицы измерения"".'"));
		
		ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(Данные, ТаблицаТоваров, "ТаблицаТоваров");
		
		ЗаполнитьРеквизитыПодвала(РеквизитыШапки, ИтоговыеСуммы, Данные);
		
		Если ТипЗнч(Основание) = Тип("ДокументСсылка.КорректировкаРеализации") Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				Данные, 
				"ВидОперации", 
				Перечисления.ВидыОперацийЭД.Исправление);
			ЗаполнитьДокументыОснования(Данные, Основание);
		ИначеЕсли ТипЗнч(Основание) = Тип("ДокументСсылка.ПередачаТоваровМеждуОрганизациями")
			Или ТипЗнч(Основание) = Тип("ДокументСсылка.ВозвратТоваровМеждуОрганизациями") Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				Данные, 
				"ВидОперации", 
				Перечисления.ВидыОперацийЭД.ПродажаКомиссия);
			
			ДопДанные = Новый ТаблицаЗначений;
			ДопДанные.Колонки.Добавить("Идентификатор");
			ДопДанные.Колонки.Добавить("Значение");
			
			СтрокаДопДанных = ДопДанные.Добавить();
			СтрокаДопДанных.Идентификатор = "ИдентификаторПередачи";
			СтрокаДопДанных.Значение = Строка(Основание.УникальныйИдентификатор());
			
			ЭлектронноеВзаимодействие.ДобавитьДопДанныеВДерево(Данные, ДопДанные, Истина);
			
		Иначе
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				Данные, 
				"ВидОперации", 
				Перечисления.ВидыОперацийЭД.ПродажаКомиссия);
			ЗаполнитьУИП(Данные, Основание.ИдентификаторПлатежа);			
		КонецЕсли;
		
	Иначе
		
		Если (РеквизитыШапки.Статус <> Перечисления.СтатусыРеализацийТоваровУслуг.Отгружено) Тогда 
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Документ %1 для формирования ЭД должен быть в статусе ""Реализовано"".'"), 
				РеквизитыШапки.Ссылка);
		Иначе
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Документ %1 не содержит данных для формирования ЭД.'"), 
				РеквизитыШапки.Ссылка);				
		КонецЕсли;
			
		ВызватьИсключение ТекстСообщения;
		
	КонецЕсли;
	
	Если ОписаниеЗамера <> Неопределено Тогда
		ОценкаПроизводительности.ЗакончитьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоЗаписей);
	КонецЕсли;
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПередачаТоваров_ИнформацияПокупателя.
Процедура ЗаполнитьДанныеПередачаТоваров_ИнформацияПокупателя(Знач Основания, Данные, Отказ) Экспорт
	
	ДокументОснование = Документы.СчетФактураПолученный.ПустаяСсылка();
	Для каждого Основание Из Основания Цикл
		Если ТипЗнч(Основание) = Тип("ДокументСсылка.КорректировкаПриобретения") Тогда
			ДокументОснование = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Основание, "ДокументОснование");
		Иначе
			ДокументОснование = Основание;
		КонецЕсли;
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Ссылка", ДокументОснование);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ПриобретениеТоваровУслуг.Дата КАК Дата,
	|	ПриобретениеТоваровУслуг.Организация.НаименованиеПолное КАК ОрганизацияНаименованиеПолное,
	|	ПриобретениеТоваровУслуг.Организация.ИНН КАК ОрганизацияИНН,
	|	ПриобретениеТоваровУслуг.Организация.КПП КАК ОрганизацияКПП
	|ИЗ
	|	&ТипДокумента КАК ПриобретениеТоваровУслуг
	|ГДЕ
	|	ПриобретениеТоваровУслуг.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СчетФактураПолученный.Дата КАК Дата,
	|	СчетФактураПолученный.Организация.НаименованиеПолное КАК ОрганизацияНаименованиеПолное,
	|	СчетФактураПолученный.Организация.ИНН КАК ОрганизацияИНН,
	|	СчетФактураПолученный.Организация.КПП КАК ОрганизацияКПП	
	|ИЗ
	|	Документ.СчетФактураПолученный КАК СчетФактураПолученный
	|ГДЕ
	|	СчетФактураПолученный.Ссылка = &Ссылка
	|";
	
	Если ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.ПриобретениеУслугПрочихАктивов") Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ТипДокумента", "Документ.ПриобретениеУслугПрочихАктивов");
	ИначеЕсли ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.КорректировкаПриобретения") Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ТипДокумента", "Документ.КорректировкаПриобретения");
	ИначеЕсли ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.ВозвратТоваровОтКлиента") Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ТипДокумента", "Документ.ВозвратТоваровОтКлиента");		
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ТипДокумента", "Документ.ПриобретениеТоваровУслуг");
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	РезультатЗапроса = Запрос.ВыполнитьПакет();
	ДатаПолученияТоваров = ТекущаяДатаСеанса();
	ОрганизацияНаименованиеПолное =	"";
	
	Если Не РезультатЗапроса[0].Пустой() Тогда // В основаниях есть документ поступления
		
		Выборка = РезультатЗапроса[0].Выбрать();
		Выборка.Следующий();
		ДатаПолученияТоваров 		  =	Выборка.Дата;
		ОрганизацияНаименованиеПолное =	Выборка.ОрганизацияНаименованиеПолное;
		
	ИначеЕсли Не РезультатЗапроса[1].Пустой() Тогда // основание - СФ
		
		Выборка = РезультатЗапроса[1].Выбрать();
		Выборка.Следующий();
		ДатаПолученияТоваров =			 Выборка.Дата;
		ОрганизацияНаименованиеПолное =	 Выборка.ОрганизацияНаименованиеПолное;
		
	ИначеЕсли РезультатЗапроса[0].Пустой() и РезультатЗапроса[1].Пустой() Тогда
		
		Если ЗначениеЗаполнено(ДокументОснование) Тогда
			ДатаПолученияТоваров =		ДокументОснование.Дата;
			ОрганизацияСсылка = ЗначениеНастроекПовтИсп.ПолучитьОрганизациюПоУмолчанию(ДокументОснование.Организация);
			ОрганизацияНаименованиеПолное = ?(ЗначениеЗаполнено(ОрганизацияСсылка.НаименованиеПолное), ОрганизацияСсылка.НаименованиеПолное, ОрганизацияСсылка.Наименование);
		КонецЕсли;
		
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ОрганизацияНаименованиеПолное) И Не ПолучитьФункциональнуюОпцию("ИспользоватьНесколькоОрганизаций") Тогда
		ОрганизацияСсылка = ЗначениеНастроекПовтИсп.ПолучитьОрганизациюПоУмолчанию();
		ОрганизацияНаименованиеПолное = ?(ЗначениеЗаполнено(ОрганизацияСсылка.НаименованиеПолное), ОрганизацияСсылка.НаименованиеПолное, ОрганизацияСсылка.Наименование);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Выборка) Тогда
		СоставительДокумента = ?(ЗначениеЗаполнено(Выборка.ОрганизацияКПП),
			СтрШаблон(НСтр("ru = '%1, ИНН/КПП %2/%3'"),
				ОрганизацияНаименованиеПолное, Выборка.ОрганизацияИНН, Выборка.ОрганизацияКПП),
			СтрШаблон(НСтр("ru = '%1, ИНН %2'"),
				ОрганизацияНаименованиеПолное, Выборка.ОрганизацияИНН));
	Иначе
		СоставительДокумента = ОрганизацияНаименованиеПолное;		
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные,
		"СоставительДокументаНаименование", СоставительДокумента);
	
	Если ЗначениеЗаполнено(ДатаПолученияТоваров) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, "ДатаПолученияГруза", ДатаПолученияТоваров);
	КонецЕсли;
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.НайтиСоздатьДокументПередачаТоваров.
Процедура НайтиСоздатьДокументПередачаТоваров(ДеревоДанных, СсылкаНаВладельца, СпособОбработки, ОписаниеОшибки) Экспорт
		
	УстановитьПривилегированныйРежим(Истина);
	
	ЗаполнитьДокументПередачиМеждуОрганизациямиПоПередачиТоваров(ДеревоДанных, СсылкаНаВладельца, Истина, СпособОбработки, ОписаниеОшибки, "ТоварнаяНакладная");
	
	Если Не (ТипЗнч(СсылкаНаВладельца) = Тип("ДокументСсылка.ПередачаТоваровМеждуОрганизациями")
		Или ТипЗнч(СсылкаНаВладельца) = Тип("ДокументСсылка.ВозвратТоваровМеждуОрганизациями")) Тогда
		
		ДанныеДляЗагрузки = ПодготовитьСтруктуруДляПриобретенияТоваровУслугПоПередачеТоваров(ДеревоДанных);
		
		Если СпособОбработки = "ВозвратТоваровОтКлиента" Тогда
			ЗаполнитьДокументВозвратаТоваровОтПокупателя(СсылкаНаВладельца, ДанныеДляЗагрузки, Истина);		
		Иначе
			Если ДанныеДляЗагрузки.Шапка.Исправление Тогда
				ДанныеДляЗагрузки.Шапка.Вставить("ВидКорректировки", Перечисления.ХозяйственныеОперации.ИсправлениеОшибок);			
				ЗаполнитьДокументКорректировкиПоступления(СсылкаНаВладельца, ДанныеДляЗагрузки, Истина)
			Иначе
				ЗаполнитьДокументПриобретенияТоваровУслуг(СсылкаНаВладельца, ДанныеДляЗагрузки, Истина);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ПередачаУслуг

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПередачаУслуг_ИнформацияПродавца.
Процедура ЗаполнитьДанныеПередачаУслуг_ИнформацияПродавца(Знач Основание, Знач Настройки, Данные, Описание, Отказ) Экспорт

	МассивОбъектов = Новый Массив;
	МассивОбъектов.Добавить(Основание);
	
	ПараметрыПечати = Новый Структура;
	Если ТипЗнч(Основание) = Тип("ДокументСсылка.АктВыполненныхРабот") Тогда
		ДанныеДляПечати = Документы["АктВыполненныхРабот"].ПолучитьДанныеДляПечати(МассивОбъектов, ПараметрыПечати);
	Иначе
		ДанныеДляПечати = Документы[Основание.Метаданные().Имя].ПолучитьДанныеДляПечатнойФормыАктОбОказанииУслуг(ПараметрыПечати, МассивОбъектов);
	КонецЕсли;
	
	ВыборкаПоДокументам = ДанныеДляПечати.РезультатПоТабличнойЧасти.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	РеквизитыШапки = ДанныеДляПечати.РезультатПоШапке.Выбрать();
	РеквизитыШапки.Следующий();
	
	СтруктураПоиска = Новый Структура("Ссылка", РеквизитыШапки.Ссылка);
	ВыборкаПоДокументам.Сбросить();
	
	Если ВыборкаПоДокументам.НайтиСледующий(СтруктураПоиска) Тогда
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, 
			"НомерАкта", 
			ПрефиксацияОбъектовКлиентСервер.НомерНаПечать(РеквизитыШапки.Номер, Ложь, Ложь));
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, 
			"ДатаАкта", 
			РеквизитыШапки.Дата);
			
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, 
			"СведенияПоВыполнениюУслуг.ДатаИсполнения",
			РеквизитыШапки.Дата);
			
		РеквизитыОснования = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(РеквизитыШапки.Ссылка, "Основание, ОснованиеНомер, ОснованиеДата");
		ОснованиеНаименование = РеквизитыОснования.Основание;
		ОснованиеНомер = РеквизитыОснования.ОснованиеНомер;
		ОснованиеДата  = РеквизитыОснования.ОснованиеДата;
			
		Если ЗначениеЗаполнено(ОснованиеНаименование) 
			И ЗначениеЗаполнено(ОснованиеДата) Тогда
			
			ДокументыОснования = Новый ТаблицаЗначений;
			ДокументыОснования.Колонки.Добавить("ДокОснованиеНаименование");
			ДокументыОснования.Колонки.Добавить("ДокОснованиеНомер");
			ДокументыОснования.Колонки.Добавить("ДокОснованиеДата");
		
			СтрокаДокументыОснования = ДокументыОснования.Добавить();
			
			Если СтрНайти(ОснованиеНаименование, "№") Тогда
				СтрокаНаименование = Лев(ОснованиеНаименование, СтрНайти(ОснованиеНаименование, "№") - 2);
			Иначе
				СтрокаНаименование = ОснованиеНаименование;
			КонецЕсли;
			СтрокаДокументыОснования.ДокОснованиеНаименование 	= СтрокаНаименование;
			СтрокаДокументыОснования.ДокОснованиеНомер 			= ОснованиеНомер;
			СтрокаДокументыОснования.ДокОснованиеДата 			= ОснованиеДата;
			
			// Дополним таблицу оснований параметрами обработки ошибок.
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ДокументыОснования,
				"ДокОснованиеНаименование",,, НСтр("ru = 'Не указано наименование документа основания'"));
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ДокументыОснования,
				"ДокОснованиеНомер",,, НСтр("ru = 'Не указан номер документа основания'"));
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ДокументыОснования,
				"ДокОснованиеДата",,, НСтр("ru = 'Не указана дата документа основания'"));
			
			Если ЗначениеЗаполнено(СтрокаНаименование) Тогда
				ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(Данные, ДокументыОснования, "Основание");
			КонецЕсли;
		Иначе
			ТекстОшибки = НСтр("ru = 'Возникла ошибка при заполнении основания отгрузки. Возможные причины:
			|	- в документе отгрузки не указан договор
			|	- в договоре не указана дата'");
			ЭлектронноеВзаимодействие.ДобавитьВРеквизитОбработкуОшибки(Данные,
				"Основание.НомерСтроки.ДокОснованиеДата", ТекстОшибки);
		КонецЕсли;
			
		ТекстЗаголовка = "Мы, нижеподписавшиеся, представитель ИСПОЛНИТЕЛЯ, с одной стороны и представитель ЗАКАЗЧИКА с другой
						|стороны, составили настоящий акт в том, что ИСПОЛНИТЕЛЬ выполнил, а ЗАКАЗЧИК принял следующие работы (услуги).";
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "Заголовок", ТекстЗаголовка);
		
		Если ТипЗнч(Основание) <> Тип("ДокументСсылка.КорректировкаРеализации") Тогда
			СведенияОПоставщике = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(РеквизитыШапки.Организация, РеквизитыШапки.СчетОрганизации, РеквизитыШапки.Дата);
			СведенияОПокупателе = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(РеквизитыШапки.Контрагент, РеквизитыШапки.СчетКонтрагента, РеквизитыШапки.Дата);
		Иначе
			СведенияОПоставщике = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(РеквизитыШапки.Организация, , РеквизитыШапки.Дата);
			СведенияОПокупателе = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(РеквизитыШапки.Контрагент, , РеквизитыШапки.Дата);
		КонецЕсли;	
		
		ЗаполнитьДанныеУчастникаТОРГ(Данные, СведенияОПоставщике, "Исполнитель", "Юр", РеквизитыШапки.Дата);
		ЗаполнитьДанныеУчастникаТОРГ(Данные, СведенияОПокупателе, "Заказчик",    "Юр", РеквизитыШапки.Дата);
	
		Если ЗначениеЗаполнено(РеквизитыШапки.Организация) Тогда
			НаименованиеСоставителяДокумента = СведенияОПоставщике.ПолноеНаименование + ?(ЗначениеЗаполнено(
				СведенияОПоставщике.КПП), СтрШаблон(НСтр("ru = ', ИНН/КПП %1/%2'"), СведенияОПоставщике.ИНН,
				СведенияОПоставщике.КПП), СтрШаблон(НСтр("ru = ', ИНН %1'"), СведенияОПоставщике.ИНН));
				
			ПараметрыОбработкиОшибок = ЭлектронноеВзаимодействиеКлиентСервер.НовыеПараметрыОбработкиОшибки(
				РеквизитыШапки.Ссылка, "Объект.Организация");
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				Данные, "НаименованиеСоставителяДокумента", НаименованиеСоставителяДокумента,
				ПараметрыОбработкиОшибок);
		КонецЕсли;
		
		// Заполняем структурное подразделение
		ЗаполнитьСтруктурноеПодразделение(Данные, "Исполнитель", РеквизитыШапки.Ссылка.Подразделение);
		
		ВалютаКод = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(РеквизитыШапки.Валюта, "Код");
		ВалютаНаименование = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(РеквизитыШапки.Валюта, "НаименованиеПолное");
		ТекстОшибки = НСтр("ru = 'Не удалось заполнить код валюты документа. Проверьте, что:
		|	- в документе указана валюта,
		|	- для нее заполнен код по Общероссийскому классификатору валют.'");
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "ВалютаКод", ВалютаКод, ТекстОшибки);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "ВалютаНаименование", ВалютаНаименование);
		
		ТаблицаУслуг = Новый ТаблицаЗначений();
		ТаблицаУслуг.Колонки.Добавить("НаименованиеНоменклатуры");
		ТаблицаУслуг.Колонки.Добавить("ЕдиницаИзмеренияНаименование");
		ТаблицаУслуг.Колонки.Добавить("ЕдиницаИзмеренияКод");
		ТаблицаУслуг.Колонки.Добавить("Количество");
		ТаблицаУслуг.Колонки.Добавить("Цена");
		ТаблицаУслуг.Колонки.Добавить("СуммаБезНДС");
		ТаблицаУслуг.Колонки.Добавить("СтавкаНДС");
		ТаблицаУслуг.Колонки.Добавить("СуммаНДС");
		ТаблицаУслуг.Колонки.Добавить("СуммаСНДС");
		ТаблицаУслуг.Колонки.Добавить("Описание");
		ТаблицаУслуг.Колонки.Добавить("ДокументОснование");
		ТаблицаУслуг.Колонки.Добавить("Номенклатура");
		ТаблицаУслуг.Колонки.Добавить("ДопДанныеПодписанные");
		ТаблицаУслуг.Колонки.Добавить("ДопДанныеНеПодписанные");
		ТаблицаУслуг.Колонки.Добавить("Сопоставление");
		
		// Выводим строки таблицы Услуги
		Выборка = ВыборкаПоДокументам.Выбрать();
		
		ШтрихкодыКомбинаций = Неопределено;
		ШтрихкодыНоменклатуры = Неопределено;
		НоменклатураПартнеровСервер.ШтрихкодыПоТоварам(Выборка, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры);	

		ВыборкаДляСопоставления = НоменклатураПартнеровСервер.ВыборкаДляСопоставленияНоменклатуры(Основание);
		СоответствиеСтавокНДСКонтрагента = Новый Соответствие;
		ЗаполнитьСоответствиеСтавокНДС(СоответствиеСтавокНДСКонтрагента);	
		ТаблицаСопоставления = ВыборкаДляСопоставления.Выгрузить();

		НДСИсчисляетсяНалоговымАгентом = Ложь;
		Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(РеквизитыШапки, "НалогообложениеНДС") Тогда
			НДСИсчисляетсяНалоговымАгентом = (РеквизитыШапки.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ОблагаетсяНДСУПокупателя);
		КонецЕсли;
		
		Пока Выборка.Следующий() Цикл
			НоваяСтрока = ТаблицаУслуг.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
			
			НоваяСтрока.НаименованиеНоменклатуры = Выборка.УслугаНаименованиеПолное;
			ЕстьХарактеристика = ЗначениеЗаполнено(Выборка.Характеристика);
			
			НоваяСтрока.Описание = 
				Выборка.УслугаНаименованиеПолное + ?(ЕстьХарактеристика, " (" + Выборка.ХарактеристикаНаименованиеПолное + ")", "");
			
			НоваяСтрока.СуммаБезНДС = Выборка.Сумма - ?(РеквизитыШапки.ЦенаВключаетНДС И Выборка.СуммаНДС > 0, Выборка.СуммаНДС, 0);
			НоваяСтрока.СуммаСНДС   = НоваяСтрока.СуммаБезНДС + Выборка.СуммаНДС;
			
			Если РеквизитыШапки.ЦенаВключаетНДС Тогда
				НоваяСтрока.Цена = ?(Выборка.Количество = 0, 0, Окр(НоваяСтрока.СуммаБезНДС / НоваяСтрока.Количество, 2));
			КонецЕсли;
			
			НоваяСтрока.ЕдиницаИзмеренияКод = СокрЛП(Выборка.ЕдиницаИзмеренияКод);
		
			Если НДСИсчисляетсяНалоговымАгентом Тогда
				НоваяСтрока.СтавкаНДС          = "НДС исчисляется налоговым агентом";
				НоваяСтрока.СуммаНДС           = 0;
				НоваяСтрока.СуммаСНДС          = 0;
			КонецЕсли;
			
			Если ТипЗнч(Выборка.Ссылка) = Тип("ДокументСсылка.АктВыполненныхРабот") Тогда
				УпаковкаИзДокумента = Выборка.ЕдиницаИзмерения;
			Иначе
				УпаковкаИзДокумента = Справочники.УпаковкиЕдиницыИзмерения.ПустаяСсылка();					
			КонецЕсли;
			
			// Сопоставление.
			ПараметрыОтбора = Новый Структура;
			ПараметрыОтбора.Вставить("Номенклатура", Выборка.Номенклатура);
			Если Выборка.Характеристика <> Неопределено Тогда
				ПараметрыОтбора.Вставить("Характеристика", Выборка.Характеристика);
			Иначе
				ПараметрыОтбора.Вставить("Характеристика", Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());				
			КонецЕсли;
			ПараметрыОтбора.Вставить("Упаковка", УпаковкаИзДокумента);
			СтрокиИзНоменклатурыКонтрагентов = ТаблицаСопоставления.НайтиСтроки(ПараметрыОтбора);
			Если СтрокиИзНоменклатурыКонтрагентов.Количество() Тогда
				НайденнаяСтрока = СтрокиИзНоменклатурыКонтрагентов[0];
				НоваяСтрока.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(НайденнаяСтрока,,,,СоответствиеСтавокНДСКонтрагента);
		    Иначе
				НоваяСтрока.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(Выборка, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры, УпаковкаИзДокумента);
			КонецЕсли;		
		КонецЦикла;
		
		ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаУслуг,
			"Количество",,, НСтр("ru = 'Не указано количество товара в табличной части'"));
		ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаУслуг,
			"ЕдиницаИзмеренияНаименование",,, НСтр("ru = 'Не заполнено наименование единицы измерения в справочнике ""Упаковки и единицы измерения"".'"));
		ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаУслуг,
			"ЕдиницаИзмеренияКод",,, НСтр("ru = 'Не заполнен код единицы измерения в справочнике ""Упаковки и единицы измерения"".'"));
		
		ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(Данные, ТаблицаУслуг, "ТаблицаУслуг");
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, 
			"ОписаниеУслуги.НачалоРабот", 
			РеквизитыШапки.Дата);
			
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные,
			"ОписаниеУслуги.КонецРабот", 
			РеквизитыШапки.Дата);
			
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, 
			"ОписаниеУслуги.СуммаБезНДСИтого",
			ТаблицаУслуг.Итог("СуммаБезНДС"));
			
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, 
			"ОписаниеУслуги.СуммаНДСИтого",
			ТаблицаУслуг.Итог("СуммаНДС"));
			
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, 
			"ОписаниеУслуги.СуммаСНДСИтого",
			ТаблицаУслуг.Итог("СуммаСНДС"));
			
		Если ТипЗнч(Основание) = Тип("ДокументСсылка.КорректировкаРеализации") Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				Данные, 
				"ВидОперации", 
				Перечисления.ВидыОперацийЭД.Исправление);
			ЗаполнитьДокументыОснования(Данные, Основание);
		Иначе
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				Данные, 
				"ВидОперации", 
				Перечисления.ВидыОперацийЭД.ПродажаКомиссия);
			ЗаполнитьУИП(Данные, Основание.ИдентификаторПлатежа); 			
		КонецЕсли; 		

	КонецЕсли;
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПередачаУслуг_ИнформацияПокупателя.
Процедура ЗаполнитьДанныеПередачаУслуг_ИнформацияПокупателя(Знач Основания, Данные, Отказ) Экспорт

	Поступление = Документы.ПриобретениеУслугПрочихАктивов.ПустаяСсылка();
	Для каждого Основание Из Основания Цикл
		Если ТипЗнч(Основание) = Тип("ДокументСсылка.ПриобретениеУслугПрочихАктивов") Тогда
			Поступление = Основание;
		КонецЕсли;
	КонецЦикла;

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПриобретениеУслугПрочихАктивов.Дата КАК Дата,
		|	ПриобретениеУслугПрочихАктивов.Организация.НаименованиеПолное КАК ОрганизацияНаименованиеПолное,
		|	ПриобретениеУслугПрочихАктивов.Организация.ИНН КАК ОрганизацияИНН,
		|	ПриобретениеУслугПрочихАктивов.Организация.КПП КАК ОрганизацияКПП
		|ИЗ
		|	Документ.ПриобретениеУслугПрочихАктивов КАК ПриобретениеУслугПрочихАктивов
		|ГДЕ
		|	ПриобретениеУслугПрочихАктивов.Ссылка = &Основание";
	Запрос.УстановитьПараметр("Основание", Поступление);
	
	УстановитьПривилегированныйРежим(Истина);
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() И ЗначениеЗаполнено(Выборка.Дата) Тогда
		ДатаПолучения = Выборка.Дата;
	Иначе
		ДатаПолучения = ТекущаяДатаСеанса();
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Выборка) Тогда
		СоставительДокумента = ?(ЗначениеЗаполнено(Выборка.ОрганизацияКПП),
			СтрШаблон(НСтр("ru = '%1, ИНН/КПП %2/%3'"),
				Выборка.ОрганизацияНаименованиеПолное, Выборка.ОрганизацияИНН, Выборка.ОрганизацияКПП),
			СтрШаблон(НСтр("ru = '%1, ИНН %2'"),
				Выборка.ОрганизацияНаименованиеПолное, Выборка.ОрганизацияИНН));
	Иначе
		СоставительДокумента = "";		
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные,
		"СоставительДокументаНаименование", СоставительДокумента);

	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, 
		"СведенияПоВыполнениюУслуг.ДатаЗаказа", ДатаПолучения);
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.НайтиСоздатьДокументПередачаРезультатовРабот.
Процедура НайтиСоздатьДокументПередачаРезультатовРабот(ДеревоДанных, СсылкаНаВладельца, СпособОбработки, ОписаниеОшибки) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если СпособОбработки = "ПриобретениеТоваровУслуг" Тогда
		ДанныеДляЗагрузки = ПодготовитьСтруктуруДляПриобретенияТоваровУслугПоПередачеРабот(ДеревоДанных);
		ЗаполнитьДокументПриобретенияТоваровУслуг(СсылкаНаВладельца, ДанныеДляЗагрузки, Истина);
	Иначе
		ДанныеДляЗагрузки = ПодготовитьСтруктуруДляПоступленияУслугПоПередачеРабот(ДеревоДанных);		
		Если ДанныеДляЗагрузки.Шапка.Исправление Тогда
			ДанныеДляЗагрузки.Шапка.Вставить("ВидКорректировки", Перечисления.ХозяйственныеОперации.ИсправлениеОшибок);				
			ЗаполнитьДокументКорректировкиПоступления(СсылкаНаВладельца, ДанныеДляЗагрузки, Истина)
		Иначе
			ЗаполнитьДокументПоступленияУслуг(СсылкаНаВладельца, ДанныеДляЗагрузки, Истина);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область Методы_УПД_УКД

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеУКД_ИнформацияПродавца.
Процедура ЗаполнитьДанныеУКД_ИнформацияПродавца(Основание, Настройки, Данные, Описание, Отказ) Экспорт

	ВсеВидыДокументов = ОбменСКонтрагентами.ТипыДокументов();
	ВидДокумента = Настройки.ТипДокумента;

	СтруктураЭД = ОбщегоНазначения.СкопироватьРекурсивно(Настройки, Ложь);

	ДокОснование = Основание; 
	Если ТипЗнч(Основание) = Тип("ДокументСсылка.СчетФактураВыданный") Тогда
		СчетФактура = Основание;
		ДокОснование = СчетФактура.ДокументОснование;
	Иначе
		МассивОбъектов = Новый Массив;
		МассивОбъектов.Добавить(Основание);		
		РезультатАнализа = Документы.СчетФактураВыданный.ПолучитьСчетаФактурыНаПечать(МассивОбъектов);
		МассивСчетовФактур = РезультатАнализа.СчетаФактурыНаПечать;
		Если МассивСчетовФактур.Количество() = 0 Тогда
			НоваяСчетФактура = Документы.СчетФактураВыданный.СоздатьДокумент();
			СтрокаОснований = НоваяСчетфактура.ДокументыОснования.Добавить();
			
			НоваяСчетФактура.ДокументОснование 	= Основание;
			СтрокаОснований.ДокументОснование 	= Основание;
			НоваяСчетФактура.КодВидаОперации = 
				Документы.СчетФактураВыданный.КодВидаОперации(НоваяСчетфактура.ДокументыОснования, 
						НоваяСчетфактура.Покупатели, НоваяСчетфактура.Дата, Основание);
			НоваяСчетФактура.КодВидаОперацииНаУменьшение 	= "18";
			НоваяСчетФактура.Дата 				= ТекущаяДатаСеанса();
			НоваяСчетФактура.ДатаВыставления 	= ТекущаяДатаСеанса();
			НоваяСчетФактура.ЗаполнитьПараметрыСчетаФактурыПоОснованию(Основание);
			
			НоваяСчетФактура.Записать(РежимЗаписиДокумента.Проведение);
			МассивСчетовФактур.Добавить(НоваяСчетФактура.Ссылка);
			
			//Запись в Реестр документов
			ТаблицыДанных = ПроведениеДокументов.ДанныеДокументаДляПроведения(НоваяСчетФактура.Ссылка, "РеестрДокументов");
			РегистрыСведений.РеестрДокументов.ЗаписатьДанные(ТаблицыДанных, НоваяСчетФактура.Ссылка,  Неопределено, Ложь);
		КонецЕсли;
		СчетФактура = МассивСчетовФактур[0];
	КонецЕсли;
	
	МассивОбъектов = Новый Массив;
	МассивОбъектов.Добавить(СчетФактура);
	
	ПараметрыПечати = Новый Структура();
	ПараметрыПечати.Вставить("ЗаполнитьДанныеШтрихкодовДляУКДДо", Истина);
	ПараметрыПечати.Вставить("ЗаполнениеЭлектронногоДокумента");
	
	СтруктураДанных = Документы.СчетФактураВыданный.ПолучитьДанныеДляПечатнойФормыУКД(ПараметрыПечати, МассивОбъектов);
	
	Если ВидДокумента = ВсеВидыДокументов.УКД Тогда				
		СтруктураЭД.Вставить("Функция", "КСЧФДИС");		
		ЗаполнитьДанныеСчетаФактурыУКД(СтруктураДанных, СтруктураЭД, Данные);		
		ЗаполнитьДанныеПервичногоДокументаУКД(СтруктураДанных, Настройки, СтруктураЭД, Данные);				
	ИначеЕсли ВидДокумента = ВсеВидыДокументов.КорректировочныйСчетФактура Тогда		
		СтруктураЭД.Вставить("Функция", "КСЧФ");
		ЗаполнитьДанныеСчетаФактурыУКД(СтруктураДанных, СтруктураЭД, Данные);
		ЗаполнитьДанныеПервичногоДокументаУКД(СтруктураДанных, Настройки, СтруктураЭД, Данные);
	Иначе		
		СтруктураЭД.Вставить("Функция", "ДИС");
		ЗаполнитьДанныеПервичногоДокументаУКД(СтруктураДанных, Настройки, СтруктураЭД, Данные);	
	КонецЕсли;

	ФункцияУКД = СтруктураЭД.Функция;	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "Функция", ФункцияУКД);

	ПередаточныеДокументы = Новый Массив;
	ПередаточныеДокументы.Добавить(ДокОснование);
	
	Если ФункцияУКД = "КСЧФДИС" Тогда		
		Если Основание = СчетФактура Тогда
			ОбщегоНазначенияКлиентСервер.ДополнитьМассив(Описание.Основания, ПередаточныеДокументы);
		Иначе
			Описание.Основания.Добавить(СчетФактура);
		КонецЕсли;
	КонецЕсли;	
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеУКД_ИнформацияПокупателя.
Процедура ЗаполнитьДанныеУКД_ИнформацияПокупателя(Знач Основания, Данные, Отказ) Экспорт
	
	ДокументОснование = Документы.СчетФактураПолученный.ПустаяСсылка();
	Для каждого Основание Из Основания Цикл
		ДокументОснование = Основание;
	КонецЦикла;	

	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Ссылка", ДокументОснование);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	КорректировкаПриобретения.Дата,
	|	КорректировкаПриобретения.Организация.НаименованиеПолное,
	|	КорректировкаПриобретения.Организация.ИНН КАК ОрганизацияИНН,
	|	КорректировкаПриобретения.Организация.КПП КАК ОрганизацияКПП	
	|ИЗ
	|	Документ.КорректировкаПриобретения КАК КорректировкаПриобретения
	|ГДЕ
	|	КорректировкаПриобретения.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СчетФактураПолученный.Дата,
	|	СчетФактураПолученный.Организация.НаименованиеПолное,
	|	СчетФактураПолученный.Организация.ИНН КАК ОрганизацияИНН,
	|	СчетФактураПолученный.Организация.КПП КАК ОрганизацияКПП	
	|ИЗ
	|	Документ.СчетФактураПолученный КАК СчетФактураПолученный
	|ГДЕ
	|	СчетФактураПолученный.Ссылка = &Ссылка";
	
	УстановитьПривилегированныйРежим(Истина);
	РезультатЗапроса = Запрос.ВыполнитьПакет();
	ДатаПолученияКорректировки = ТекущаяДатаСеанса();
	ОрганизацияНаименованиеПолное =	 "-";
	Если Не РезультатЗапроса[0].Пустой() Тогда // В основаниях есть документ поступления
		
		Выборка = РезультатЗапроса[0].Выбрать();
		Выборка.Следующий();
		ДатаПолученияКорректировки 	  =	 Выборка.Дата;
		ОрганизацияНаименованиеПолное =	 Выборка.ОрганизацияНаименованиеПолное;
		
	ИначеЕсли Не РезультатЗапроса[1].Пустой() Тогда // основание - СФ
		
		Выборка = РезультатЗапроса[1].Выбрать();
		Выборка.Следующий();
		ДатаПолученияКорректировки 	  =	 Выборка.Дата;
		ОрганизацияНаименованиеПолное =	 Выборка.ОрганизацияНаименованиеПолное;
		
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ОрганизацияНаименованиеПолное) И Не ПолучитьФункциональнуюОпцию("ИспользоватьНесколькоОрганизаций") Тогда
		Если ЗначениеЗаполнено(ДокументОснование) Тогда		
			ОрганизацияСсылка = ЗначениеНастроекПовтИсп.ПолучитьОрганизациюПоУмолчанию(ДокументОснование.Организация);
			ОрганизацияНаименованиеПолное = ?(ЗначениеЗаполнено(ОрганизацияСсылка.НаименованиеПолное), ОрганизацияСсылка.НаименованиеПолное, ОрганизацияСсылка.Наименование);
		КонецЕсли;	
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Выборка) Тогда
		СоставительДокумента = ?(ЗначениеЗаполнено(Выборка.ОрганизацияКПП),
			СтрШаблон(НСтр("ru = '%1, ИНН/КПП %2/%3'"),
				ОрганизацияНаименованиеПолное, Выборка.ОрганизацияИНН, Выборка.ОрганизацияКПП),
			СтрШаблон(НСтр("ru = '%1, ИНН %2'"),
				ОрганизацияНаименованиеПолное, Выборка.ОрганизацияИНН));
	Иначе
		СоставительДокумента = ОрганизацияНаименованиеПолное;		
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные,
		"СоставительДокументаНаименование", СоставительДокумента);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "ДатаСогласования", ДатаПолученияКорректировки);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "СодержаниеОперации", НСтр("ru = 'С изменением стоимости согласен.'"));

КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.НайтиСоздатьУниверсальныйКорректировочныйДокумент.
Процедура НайтиСоздатьУниверсальныйКорректировочныйДокумент(ДеревоДанных, СсылкиНаВладельцев = Неопределено, 
	СпособОбработки  = Неопределено, ОписаниеОшибки = "") Экспорт
	
	Текст = "";
	
	НачатьТранзакцию();
	Попытка
		
		ПервичныйДокумент = Неопределено;
		СчетФактура = Неопределено;
		
		Если СсылкиНаВладельцев <> Неопределено Тогда
			Для Каждого Ссылка Из СсылкиНаВладельцев Цикл
				Если ТипЗнч(Ссылка) = Тип("ДокументСсылка.СчетФактураПолученный")
				 Или ТипЗнч(Ссылка) = Тип("ДокументСсылка.СчетФактураПолученныйНалоговыйАгент") Тогда
					СчетФактура = Ссылка;
				Иначе
					ПервичныйДокумент = Ссылка;
				КонецЕсли;
				
			КонецЦикла;
		КонецЕсли;
		
		ДокументыУчета = Новый Массив;
		
		ЗаполнитьДокументПередачиМеждуОрганизациямиПоПередачиТоваров(ДеревоДанных, ПервичныйДокумент, Истина, СпособОбработки, ОписаниеОшибки, "КСЧФ");
			
		Если Не (ТипЗнч(ПервичныйДокумент) = Тип("ДокументСсылка.ПередачаТоваровМеждуОрганизациями")
			Или ТипЗнч(ПервичныйДокумент) = Тип("ДокументСсылка.ВозвратТоваровМеждуОрганизациями")) Тогда
			НайтиСоздатьКорректировкуПоступленияУКД(ДеревоДанных, ПервичныйДокумент);
		КонецЕсли;
		ДокументыУчета.Добавить(ПервичныйДокумент);
		
		// Заполним основание в СФ.
		ДокументыОснованияСчетаФактуры = Новый Массив;
		ДокументыОснованияСчетаФактуры.Добавить(ПервичныйДокумент);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументыОснованияСчетаФактуры", ДокументыОснованияСчетаФактуры);
		
		НайтиСоздатьКорректировочныйСчетФактуруУКД(ДеревоДанных, СчетФактура);
		ДокументыУчета.Добавить(СчетФактура);
		
		СсылкиНаВладельцев = ДокументыУчета;
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		ОтменитьТранзакцию();
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка()),
					Текст);
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка,,,	ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;	
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.НайтиСоздатьУниверсальныйПередаточныйДокумент.
Процедура НайтиСоздатьУниверсальныйПередаточныйДокумент(ДеревоДанных, СсылкиНаВладельцев, СпособОбработки, ОписаниеОшибки) Экспорт
	
	Текст = "";
	
	НачатьТранзакцию();
	Попытка
		
		ПервичныйДокумент = Неопределено;
		СчетФактура = Неопределено;
		
		Если СсылкиНаВладельцев <> Неопределено Тогда
			Для Каждого Ссылка Из СсылкиНаВладельцев Цикл
				Если ТипЗнч(Ссылка) = Тип("ДокументСсылка.СчетФактураПолученный")
				 Или ТипЗнч(Ссылка) = Тип("ДокументСсылка.СчетФактураПолученныйНалоговыйАгент") Тогда
					СчетФактура = Ссылка;
				Иначе
					ПервичныйДокумент = Ссылка;
				КонецЕсли;
				
			КонецЦикла;
		КонецЕсли;
		
		ДокументыУчета = Новый Массив;
		
		НайтиСоздатьПриобретениеТоваровУслугУПД(ДеревоДанных, ПервичныйДокумент, , СпособОбработки);
		ДокументыУчета.Добавить(ПервичныйДокумент);
		
		// Заполним основание в СФ.
		ДокументыОснованияСчетаФактуры = Новый Массив;
		ДокументыОснованияСчетаФактуры.Добавить(ПервичныйДокумент);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументыОснованияСчетаФактуры", ДокументыОснованияСчетаФактуры);
		
		НайтиСоздатьСчетФактуруУПД(ДеревоДанных, СчетФактура);
		ДокументыУчета.Добавить(СчетФактура);
		
		СсылкиНаВладельцев = ДокументыУчета;
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		ОтменитьТранзакцию();
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка()),
					Текст);
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка,,,	ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;	
	
КонецПроцедуры

Функция ПодготовитьСтруктуруДляСчетаФактурыУПД(ДеревоДанных) Экспорт
	
	ДанныеДляОбъекта = Новый Структура;
	
	ДанныеОбъекта = Новый Структура;
	ДанныеОбъекта.Вставить("Номер", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерДокумента"));
	ДанныеОбъекта.Вставить("ДатаСоставления", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокумента"));
	ДанныеОбъекта.Вставить("Дата", ТекущаяДатаСеанса());
	
	// Сведения о поставщике.
	ИННПоставщика = ""; КПППоставщика = "";
	ВидУчастника = "СведенияОПродавце";
	Если ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ЮЛ" Тогда
		
		ИННПоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
		КПППоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");
		
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ИП" Тогда
		
		ИННПоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН");
		
	КонецЕсли;	
	Контрагент = Справочники.Контрагенты.ПустаяСсылка();	
	СсылкаНаОбъектПоИННКПП("Контрагенты", ИННПоставщика, КПППоставщика, Контрагент);
	ДанныеОбъекта.Вставить("Контрагент",  Контрагент);
	ДанныеОбъекта.Вставить("ИННКонтрагента", ИННПоставщика);
	ДанныеОбъекта.Вставить("КППКонтрагента", КПППоставщика);
	
	// Сведения о покупателе.
	ИННПокупателя = ""; КПППокупателя = "";
	ВидУчастника = "СведенияОПокупателе";
	Если ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ЮЛ" Тогда
		
		ИННПокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
		КПППокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");
		
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ИП" Тогда
		
		ИННПокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН");
		
	КонецЕсли;
	Организация = Справочники.Организации.ПустаяСсылка();
	СсылкаНаОбъектПоИННКПП("Организации", ИННПокупателя, КПППокупателя, Организация);
	ДанныеОбъекта.Вставить("Организация", Организация);
	
	// Если счет-фактура на аванс.
	ВидСчетаФактуры = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВидСчетаФактуры");
	
	Если ВидСчетаФактуры = "Авансовый" Тогда
		КодВидаОперации = "02";
	Иначе
		КодВидаОперации = "01";
	КонецЕсли;
	
	ДанныеОбъекта.Вставить("КодВидаОперации", КодВидаОперации);
	ДанныеОбъекта.Вставить("ПолученВЭлектронномВиде", Истина);
	
	НомерИсправления = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления");
	ДатаИсправления  = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсправления");
	
	Если ЗначениеЗаполнено(НомерИсправления) Тогда
		ДанныеОбъекта.Вставить("Исправление", Истина);
		ДанныеОбъекта.Вставить("НомерИсправления", НомерИсправления);
		ДанныеОбъекта.Вставить("ДатаИсправления",  ДатаИсправления);
	КонецЕсли;	
	
	// Получим документы-основания
	ДокументыОснованияСчетаФактуры = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументыОснованияСчетаФактуры");
	Если ЗначениеЗаполнено(ДокументыОснованияСчетаФактуры) Тогда
		МассивДокументовОснований = Новый Массив;		
		Если ТипЗнч(ДокументыОснованияСчетаФактуры) = Тип("Массив") Тогда 
			Для Каждого ДокументОснования Из ДокументыОснованияСчетаФактуры Цикл
				МассивДокументовОснований.Добавить(ДокументОснования);
			КонецЦикла;
		Иначе
			МассивДокументовОснований.Добавить(ДокументыОснованияСчетаФактуры);
		КонецЕсли;
		ДанныеОбъекта.Вставить("ДокументыОснования", МассивДокументовОснований);		
	КонецЕсли;
	
	КодВалюты = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод");
	ВалютаОбъекта = Неопределено;	
	ЭлектронноеВзаимодействиеПереопределяемый.НайтиСсылкуНаОбъект("Валюты", ВалютаОбъекта, КодВалюты);
	ДанныеОбъекта.Вставить("Валюта", ВалютаОбъекта);
	
	ДанныеОбъекта.Вставить("Сумма", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоКОплате.ВсегоСтоимостьТоваровСНалогом"));
	ДанныеОбъекта.Вставить("СуммаНДС", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоКОплате.ВсегоСуммаНалога"));
	
	ДанныеДляОбъекта.Вставить("Шапка", ДанныеОбъекта);
	
	Если ВидСчетаФактуры = "Авансовый" Тогда
		Авансы = Документы.СчетФактураПолученныйАванс.ПустаяСсылка().Авансы.Выгрузить();
		СведенияОТоварах = ДеревоДанных.Строки.Найти("СведенияОТоварах", "ПолныйПуть");
		Для Каждого СведенияОТоваре Из СведенияОТоварах.Строки Цикл
			НоваяСтрока = Авансы.Добавить();
			НоваяСтрока.Сумма = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогом");
			СтавкаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.НалоговаяСтавка");
			НоваяСтрока.СтавкаНДС = ?(СтавкаНДС = "НДС исчисляется налоговым агентом", УчетНДСУП.СтавкаНДСПоУмолчанию(ДанныеОбъекта.Организация, ДанныеОбъекта.Дата, Истина), СтавкаНДС);
			НоваяСтрока.СуммаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СуммаНалога");
		КонецЦикла;
		ДанныеДляОбъекта.Вставить("Авансы", Авансы);
	КонецЕсли;
	
	Если ВидСчетаФактуры = "Реализация" Тогда
		ЗаполнитьСуммыДляСчетаФактуры(ДанныеДляОбъекта, ДеревоДанных);
	КонецЕсли;
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

Функция ПодготовитьСтруктуруДляСчетаФактурыУКД(ДеревоДанных) Экспорт
	
	ДанныеДляОбъекта = Новый Структура;
	
	ДанныеОбъекта = Новый Структура;
	ДанныеОбъекта.Вставить("Номер", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерДокумента"));
	ДанныеОбъекта.Вставить("ДатаСоставления", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокумента"));
	ДанныеОбъекта.Вставить("Дата", ТекущаяДатаСеанса());
	
	// Сведения о поставщике.
	ИННПоставщика = ""; КПППоставщика = "";
	ВидУчастника = "СведенияОПродавце";
	Если ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ЮЛ" Тогда
		
		ИННПоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
		КПППоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");
		
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ИП" Тогда
		
		ИННПоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН");
		
	КонецЕсли;
	Контрагент = Справочники.Контрагенты.ПустаяСсылка();
	СсылкаНаОбъектПоИННКПП("Контрагенты", ИННПоставщика, КПППоставщика,Контрагент);
	ДанныеОбъекта.Вставить("Контрагент",  Контрагент);
	ДанныеОбъекта.Вставить("ИННКонтрагента", ИННПоставщика);
	ДанныеОбъекта.Вставить("КППКонтрагента", КПППоставщика);
	
	// Сведения о покупателе.
	ИННПокупателя = ""; КПППокупателя = "";
	ВидУчастника = "СведенияОПокупателе";
	Если ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ЮЛ" Тогда
		
		ИННПокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
		КПППокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");
		
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ИП" Тогда
		
		ИННПокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН");
		
	КонецЕсли;
	Организация = Справочники.Организации.ПустаяСсылка();
	СсылкаНаОбъектПоИННКПП("Организации", ИННПокупателя, КПППокупателя, Организация);
	ДанныеОбъекта.Вставить("Организация", Организация);
	
	КодВидаОперации = "01";
	ДанныеОбъекта.Вставить("КодВидаОперации", КодВидаОперации);
	ДанныеОбъекта.Вставить("ПолученВЭлектронномВиде", Истина);
	
	НомерИсправления = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления");
	ДатаИсправления  = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсправления");
	
	Если ЗначениеЗаполнено(НомерИсправления) Тогда
		ДанныеОбъекта.Вставить("Исправление", Истина);
		ДанныеОбъекта.Вставить("НомерИсправления", НомерИсправления);
		ДанныеОбъекта.Вставить("ДатаИсправления",  ДатаИсправления);
	КонецЕсли;	
	
	ДанныеОбъекта.Вставить("Сумма", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровСНалогомУвеличение")
									+ ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровСНалогомУменьшение"));
	
	// Получим документы-основания
	ДокументыОснованияСчетаФактуры = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументыОснованияСчетаФактуры");
	Если ЗначениеЗаполнено(ДокументыОснованияСчетаФактуры) Тогда
		МассивДокументовОснований = Новый Массив;		
		Если ТипЗнч(ДокументыОснованияСчетаФактуры) = Тип("Массив") Тогда 
			Для Каждого ДокументОснования Из ДокументыОснованияСчетаФактуры Цикл
				МассивДокументовОснований.Добавить(ДокументОснования);
			КонецЦикла;
		Иначе
			МассивДокументовОснований.Добавить(ДокументыОснованияСчетаФактуры);
		КонецЕсли;
		ДанныеОбъекта.Вставить("ДокументыОснования", МассивДокументовОснований);		
	КонецЕсли;
	
	КодВалюты = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод");
	ВалютаОбъекта = Неопределено;	
	ЭлектронноеВзаимодействиеПереопределяемый.НайтиСсылкуНаОбъект("Валюты", ВалютаОбъекта, КодВалюты);
	ДанныеОбъекта.Вставить("Валюта", ВалютаОбъекта);
	
	ДанныеДляОбъекта.Вставить("Шапка", ДанныеОбъекта);
	
	ЗаполнитьСуммыДляКорректировочногоСчетаФактуры(ДанныеДляОбъекта, ДеревоДанных);
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

Функция ПодготовитьСтруктуруДляПриобретенияТоваровУслугУПД(ДеревоДанных) Экспорт
	
	ДанныеОбъекта = Новый Структура;
	
	Валюта = Неопределено;
	ЭлектронноеВзаимодействиеПереопределяемый.НайтиСсылкуНаОбъект(
				"Валюты", Валюта, ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод"));
	ДанныеОбъекта.Вставить("Валюта", Валюта);
	Курс = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДополнительныеСведенияОбУчастниках.ВалютаКурс");
	ДанныеОбъекта.Вставить("КурсЧислитель", ?(ЗначениеЗаполнено(Курс), Курс, 1));
	ДанныеОбъекта.Вставить("КурсЗнаменатель", 1);
	
	ДанныеОбъекта.Вставить("НомерВходящегоДокумента", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерДокумента"));
	ДанныеОбъекта.Вставить("ДатаВходящегоДокумента",  ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокумента"));
	
	// Сведения о поставщике.
	ИННПоставщика = ""; КПППоставщика = "";
	ВидУчастника = "СведенияОПродавце";
	Если ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ЮЛ" Тогда
		
		ИННПоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
		КПППоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");
		
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ИП" Тогда
		
		ИННПоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН");
		
	КонецЕсли;
	Контрагент = Справочники.Контрагенты.ПустаяСсылка();	
	СсылкаНаОбъектПоИННКПП("Контрагенты", ИННПоставщика, КПППоставщика, Контрагент);
	
	Если ЗначениеЗаполнено(Контрагент) Тогда
		ДанныеОбъекта.Вставить("Контрагент", Контрагент);
		ДанныеОбъекта.Вставить("Партнер",  	 Контрагент.Партнер);
	Иначе
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'В базе данных не удалось найти контрагента с ИНН ""%1"" и КПП ""%2""'"),
			ИННПоставщика, КПППоставщика);
		ВызватьИсключение ТекстСообщения;		
	КонецЕсли;
	
	// Сведения о покупателе.
	ИННПокупателя = ""; КПППокупателя = "";
	ВидУчастника = "СведенияОПокупателе";
	Если ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ЮЛ" Тогда
		
		ИННПокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
		КПППокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");
		
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ИП" Тогда
		
		ИННПокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН");
		
	КонецЕсли;
	Организация = Справочники.Организации.ПустаяСсылка();
	СсылкаНаОбъектПоИННКПП("Организации", ИННПокупателя, КПППокупателя, Организация);
	ДанныеОбъекта.Вставить("Организация", Организация);
	
	ДанныеОбъекта.Вставить("Сумма", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоКОплате.ВсегоСтоимостьТоваровСНалогом"));
	
	Товары = Документы.ПриобретениеТоваровУслуг.ПустаяСсылка().Товары.ВыгрузитьКолонки();
	Товары.Колонки.Добавить("НомерПоДаннымПоставщика");
	Товары.Колонки.Добавить("ДатаПоДаннымПоставщика");
	Товары.Колонки.Добавить("НомерПоДаннымКлиента");
	Товары.Колонки.Добавить("ДатаПоДаннымКлиента");
	Товары.Колонки.Добавить("ШтрихкодыУпаковок");
	
	ШтрихкодыУпаковок = ЭлектронноеВзаимодействиеИСМП.НоваяТаблицаШтрихкодыУпаковок();
	
	СведенияОТоварах = ДеревоДанных.Строки.Найти("СведенияОТоварах", "ПолныйПуть");
	Для Каждого СведенияОТоваре Из СведенияОТоварах.Строки Цикл
		
		Признак = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.Признак");
		
		НоваяСтрока = Товары.Добавить();
	
		// Обязательные реквизиты:
		СтавкаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.НалоговаяСтавка");
		НоваяСтрока.СтавкаНДС = ?(СтавкаНДС = "НДС исчисляется налоговым агентом", УчетНДСУП.СтавкаНДСПоУмолчанию(Организация, ТекущаяДатаСеанса(), Истина), СтавкаНДС);
		НоваяСтрока.СуммаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СуммаНалога");
		
		// Необязательные реквизиты:
		НоваяСтрока.Количество = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.Количество");
		НоваяСтрока.Цена = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.ЦенаЗаЕдиницуИзмерения");
		НоваяСтрока.Сумма = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровБезНалога");
		НоваяСтрока.СуммаСНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогом");
		
		Если НоваяСтрока.Количество = 0 Тогда
			НоваяСтрока.Количество = 1;
			Если НоваяСтрока.Цена = 0 Тогда
				НоваяСтрока.Цена = НоваяСтрока.Сумма;
			КонецЕсли;
		КонецЕсли;
		
		Сопоставление = СведенияОТоваре.Строки.Найти(
			"СведенияОТоварах.НомерСтроки.Сопоставление", "ПолныйПуть", Истина);
		Если Сопоставление <> Неопределено Тогда
			
			Идентификатор = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.Сопоставление.Идентификатор");
			Если ЗначениеЗаполнено(Идентификатор) Тогда
				НоменклатураПартнера = НоменклатураПартнеровСервер.НайтиСсылкуНаНоменклатуруПартнераПоИдентификатору(Идентификатор);
				Если ЗначениеЗаполнено(НоменклатураПартнера) Тогда
					НоваяСтрока.НоменклатураПартнера = НоменклатураПартнера;
				КонецЕсли;
			КонецЕсли;
			
			Номенклатура = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.Сопоставление.НоменклатураИБ");
			Если ЗначениеЗаполнено(Номенклатура) Тогда
				НоваяСтрока.Номенклатура = Номенклатура;
			КонецЕсли;
			
			Характеристика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.Сопоставление.ХарактеристикаИБ");
			Если ЗначениеЗаполнено(Характеристика) Тогда
				НоваяСтрока.Характеристика = Характеристика;
			КонецЕсли;
			
			Упаковка = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.Сопоставление.УпаковкаИБ");
			Если ЗначениеЗаполнено(Упаковка) Тогда
				НоваяСтрока.Упаковка = Упаковка;
			КонецЕсли;
			
		КонецЕсли;
		
		ЭтоИмущество = Ложь;
		Если ЗначениеЗаполнено(Признак) Тогда
			ЭтоИмущество = ?(Признак = "1", Истина, Ложь);
		Иначе
			ЭтоИмущество = Истина;
		КонецЕсли;
		
		ТипНоменклатуры = НоваяСтрока.Номенклатура.ТипНоменклатуры;
		Если ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Услуга") Тогда
			НоваяСтрока.СписатьНаРасходы = Истина;
			ЭтоИмущество = Ложь;
		КонецЕсли;
		
		Если ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НоваяСтрока.Номенклатура, "ВестиУчетПоГТД") = Истина Тогда
			ВестиУчетПоГТД = Истина;
		Иначе
			ВестиУчетПоГТД = Ложь;
		КонецЕсли;
		
		Если ЭтоИмущество И ВестиУчетПоГТД Тогда
			СведенияОТаможеннойДекларации = СведенияОТоваре.Строки.Найти(
											"СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации", "ПолныйПуть", Истина);
			Если СведенияОТаможеннойДекларации <> Неопределено И СведенияОТаможеннойДекларации.Строки.Количество() > 0 Тогда				
				НомерТаможеннойДекларации = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТаможеннойДекларации.Строки[0],
								"СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации.НомерСтроки.ТаможеннаяДекларацияНомер");
				КодСтраныПроисхождения = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТаможеннойДекларации.Строки[0],
								"СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации.НомерСтроки.СтранаПроисхожденияКод");				
				Если ЗначениеЗаполнено(НомерТаможеннойДекларации) Тогда
					ТаможеннаяДекларация = Неопределено;
					СтранаПроисхождения = Неопределено;
					ЭлектронноеВзаимодействиеПереопределяемый.НайтиСсылкуНаОбъект("СтраныМира", СтранаПроисхождения, КодСтраныПроисхождения);
					НайтиТаможенныеДекларации(ТаможеннаяДекларация, НомерТаможеннойДекларации, СтранаПроисхождения); 
					Если НЕ ЗначениеЗаполнено(ТаможеннаяДекларация) Тогда
						НоваяТаможеннаяДекларация = Справочники.НомераГТД.СоздатьЭлемент();
						
						ПараметрыДляЗаполнения = Справочники.НомераГТД.ПараметрыДляЗаполненияЭлемента(НомерТаможеннойДекларации, СтранаПроисхождения);
						ПараметрыДляЗаполнения.ЗаполнитьПорядковыйНомерТовараАвтоматически = Истина;
						НоваяТаможеннаяДекларация.Заполнить(ПараметрыДляЗаполнения);
						
						Реквизиты = Справочники.НомераГТД.РегистрационныйНомерИСтранаВвоза(НомерТаможеннойДекларации);
						ЗаполнитьЗначенияСвойств(НоваяТаможеннаяДекларация, Реквизиты, "РегистрационныйНомер,СтранаВвозаНеРФ,ПорядковыйНомерТовара");
						НоваяТаможеннаяДекларация.Записать();
						ТаможеннаяДекларация = НоваяТаможеннаяДекларация.Ссылка;
					КонецЕсли;
					НоваяСтрока.НомерГТД = ТаможеннаяДекларация;
				КонецЕсли;				
			КонецЕсли;			
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеИСМП.ДобавитьШтрихкодыТаблицуШтрихкодовУпаковок(ШтрихкодыУпаковок, СведенияОТоваре);
		
	КонецЦикла;
	
	ЭлектронноеВзаимодействиеИСМП.СвернутьТаблицуШтрихкодовУпаковок(ШтрихкодыУпаковок);
	
	// заполним Характеристики и Упаковки по соответствию из НоменклатурыПоставщика,
	//Переносим значения из колонки СуммаСкидки в СуммаРучнойСкидки, т.к. название реквизита табличной части документа
	//не совпадает с названием реквизита СтрокиДляЗагрузки

	Для Каждого ТекСтрока Из Товары Цикл 
		ТекСтрока.КоличествоУпаковок = ТекСтрока.Количество;
		// заполним Количество с учетом единиц измерения
		Если ЗначениеЗаполнено(ТекСтрока.Упаковка) Тогда
			ТекКоэффициент = Справочники.УпаковкиЕдиницыИзмерения.КоэффициентУпаковки(ТекСтрока.Упаковка, ТекСтрока.Номенклатура);
		Иначе
			ТекКоэффициент = 1;
		КонецЕсли;
		ТекСтрока.Количество = ТекСтрока.КоличествоУпаковок * ТекКоэффициент;
	КонецЦикла;
	
	ДанныеДляЗаполнения = Новый Структура();
	ДанныеДляЗаполнения.Вставить("Шапка",             ДанныеОбъекта);
	ДанныеДляЗаполнения.Вставить("Товары",            Товары);
	ДанныеДляЗаполнения.Вставить("ШтрихкодыУпаковок", ШтрихкодыУпаковок);
	
	Возврат ДанныеДляЗаполнения;
	
КонецФункции

Функция ПодготовитьСтруктуруДляПоступленияУслугУПД(ДеревоДанных) Экспорт
	
	ДанныеОбъекта = Новый Структура;
	
	Валюта = Неопределено;	
	ЭлектронноеВзаимодействиеПереопределяемый.НайтиСсылкуНаОбъект(
				"Валюты", Валюта, ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод"));
	Курс = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДополнительныеСведенияОбУчастниках.ВалютаКурс");
	ДанныеОбъекта.Вставить("КурсЧислитель", ?(ЗначениеЗаполнено(Курс), Курс, 1));
	ДанныеОбъекта.Вставить("КурсЗнаменатель", 1);
	
	ДанныеОбъекта.Вставить("НомерВходящегоДокумента", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерДокумента"));
	ДанныеОбъекта.Вставить("ДатаВходящегоДокумента",  ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокумента"));
	
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления")) Тогда
		ДанныеОбъекта.Вставить("Исправление", Истина);
		ДанныеОбъекта.Вставить("НомерИсправления", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления"));
		ДанныеОбъекта.Вставить("ДатаИсправления",  ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсправления"));
	Иначе
		ДанныеОбъекта.Вставить("Исправление", Ложь);
	КонецЕсли;
	
	// Сведения о поставщике.
	ИННПоставщика = ""; КПППоставщика = "";
	ВидУчастника = "СведенияОПродавце";
	Если ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ЮЛ" Тогда
		ИННПоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
		КПППоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ИП" Тогда
		ИННПоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН");
	КонецЕсли;
	Контрагент = Справочники.Контрагенты.ПустаяСсылка();
	СсылкаНаОбъектПоИННКПП("Контрагенты", ИННПоставщика, КПППоставщика, Контрагент);
	Если ЗначениеЗаполнено(Контрагент) Тогда
		ДанныеОбъекта.Вставить("Контрагент", Контрагент);
		ДанныеОбъекта.Вставить("Партнер",  	 Контрагент.Партнер);
	Иначе
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'В базе данных не удалось найти контрагента с ИНН ""%1"" и КПП ""%2""'"),
			ИННПоставщика, КПППоставщика);
		ВызватьИсключение ТекстСообщения;		
	КонецЕсли;
	
	// Сведения о покупателе.
	ИННПокупателя = ""; КПППокупателя = "";
	ВидУчастника = "СведенияОПокупателе";
	Если ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ЮЛ" Тогда
		ИННПокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
		КПППокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ИП" Тогда
		ИННПокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН");
	КонецЕсли;
	Организация = Справочники.Организации.ПустаяСсылка();
	СсылкаНаОбъектПоИННКПП("Организации", ИННПокупателя, КПППокупателя, Организация);
	ДанныеОбъекта.Вставить("Организация", Организация);
	
	ТЗ = Документы.ПриобретениеУслугПрочихАктивов.ПустаяСсылка().Расходы.ВыгрузитьКолонки();
	
	СведенияОТоварах = ДеревоДанных.Строки.Найти("СведенияОТоварах", "ПолныйПуть");
	Для Каждого СведенияОТоваре Из СведенияОТоварах.Строки Цикл
		
		НоваяСтрока = ТЗ.Добавить();
		
		// Обязательные реквизиты:
		СтавкаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.НалоговаяСтавка");
		НоваяСтрока.СтавкаНДС = ?(СтавкаНДС = "НДС исчисляется налоговым агентом", УчетНДСУП.СтавкаНДСПоУмолчанию(Организация, ТекущаяДатаСеанса(), Истина), СтавкаНДС);
		НоваяСтрока.СуммаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,  "СведенияОТоварах.НомерСтроки.СуммаНалога");
		
		// Необязательные реквизиты:
		НоваяСтрока.Количество = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.Количество");
		НоваяСтрока.Цена = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.ЦенаЗаЕдиницуИзмерения");
		НоваяСтрока.Сумма = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровБезНалога");
		НоваяСтрока.СуммаСНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогом");
		НоваяСтрока.Содержание = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.ТоварНаименование");
		
	КонецЦикла;
	
	ДанныеДляЗаполнения = Новый Структура();
	ДанныеДляЗаполнения.Вставить("Шапка", ДанныеОбъекта);
	ДанныеДляЗаполнения.Вставить("Расходы", ТЗ);
	
	Возврат ДанныеДляЗаполнения;
	
КонецФункции

Функция ПодготовитьСтруктуруДляКорректировкиПоступленияУКД(ДеревоДанных) Экспорт
	
	ДанныеОбъекта = Новый Структура;
	
	Валюта = Неопределено;	
	ЭлектронноеВзаимодействиеПереопределяемый.НайтиСсылкуНаОбъект(
				"Валюты", Валюта, ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод"));
	ДанныеОбъекта.Вставить("Валюта", Валюта);
	ДанныеОбъекта.Вставить("ВалютаВзаиморасчетов", Валюта);
	Курс = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДополнительныеСведенияОбУчастниках.ВалютаКурс");
	ДанныеОбъекта.Вставить("КурсЧислитель", ?(ЗначениеЗаполнено(Курс), Курс, 1));
	ДанныеОбъекта.Вставить("КурсЗнаменатель", 1);
	
	ДанныеОбъекта.Вставить("НомерВходящегоДокумента", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерДокумента"));
	ДанныеОбъекта.Вставить("ДатаВходящегоДокумента",  ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокумента"));
	ДанныеОбъекта.Вставить("ВидКорректировки", Перечисления.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон);

	ДокументыОснования = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументыОснованияСчетаФактуры");
	Если ЗначениеЗаполнено(ДокументыОснования) Тогда
		Для Каждого Основание Из ДокументыОснования Цикл
			Если ТипЗнч(Основание) = Тип("ДокументСсылка.ПриобретениеТоваровУслуг") 
					или ТипЗнч(Основание) = Тип("ДокументСсылка.ПриобретениеУслугПрочихАктивов") Тогда
				ДанныеОбъекта.Вставить("ДокументОснование", Основание);
				ДанныеОбъекта.Вставить("НалогообложениеНДС", Основание.НалогообложениеНДС);
				ДанныеОбъекта.Вставить("Соглашение", Основание.Соглашение);			
				ДанныеОбъекта.Вставить("Договор", Основание.Договор);			
			ИначеЕсли ТипЗнч(Основание) = Тип("ДокументСсылка.СчетФактураПолученный") Тогда
				Если Основание.ДокументыОснования.Количество() Тогда
					Для Каждого ЭлементТЧ Из Основание.ДокументыОснования Цикл
						Если ТипЗнч(ЭлементТЧ.ДокументОснование) = Тип("ДокументСсылка.ПриобретениеТоваровУслуг") Тогда
							ДанныеОбъекта.Вставить("ДокументОснование", ЭлементТЧ.ДокументОснование);
							ДанныеОбъекта.Вставить("НалогообложениеНДС", ЭлементТЧ.ДокументОснование.НалогообложениеНДС);
							ДанныеОбъекта.Вставить("Соглашение", ЭлементТЧ.ДокументОснование.Соглашение);							
							ДанныеОбъекта.Вставить("Договор", ЭлементТЧ.ДокументОснование.Договор);							
							АктОРасхождениях = ПроверкаИПодборПродукцииИСМП.СформированныйАктОРасхождениях(ЭлементТЧ.ДокументОснование);
							ДанныеОбъекта.Вставить("АктОРасхожденияхПослеПриемкиОснование", АктОРасхождениях);
						ИначеЕсли ТипЗнч(ЭлементТЧ.ДокументОснование) = Тип("ДокументСсылка.КорректировкаПриобретения") Тогда
							ОснованиеДокументКорректировки = ЭлементТЧ.ДокументОснование;
							ДанныеОбъекта.Вставить("ДокументОснование", ОснованиеДокументКорректировки.ДокументОснование);
							ДанныеОбъекта.Вставить("НалогообложениеНДС", ОснованиеДокументКорректировки.ДокументОснование.НалогообложениеНДС);
							Если ТипЗнч(ОснованиеДокументКорректировки.ДокументОснование) <> Тип("ДокументСсылка.ПервичныйДокумент") Тогда
								ДанныеОбъекта.Вставить("Соглашение", ОснованиеДокументКорректировки.ДокументОснование.Соглашение);
							КонецЕсли;
							ДанныеОбъекта.Вставить("Договор", ОснованиеДокументКорректировки.ДокументОснование.Договор);							
						КонецЕсли;
					КонецЦикла;
				КонецЕсли;
			Иначе
				ДанныеОбъекта.Вставить("ДокументОснование", Документы.ПриобретениеТоваровУслуг.ПустаяСсылка());
			КонецЕсли;
		КонецЦикла;
	Иначе
		ДанныеОбъекта.Вставить("ДокументОснование", Документы.ПриобретениеТоваровУслуг.ПустаяСсылка());		
	КонецЕсли;
	
	// Сведения о поставщике.
	ИННПоставщика = ""; КПППоставщика = "";
	ВидУчастника = "СведенияОПродавце";
	Если ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ЮЛ" Тогда
		
		ИННПоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
		КПППоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");
		
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ИП" Тогда
		
		ИННПоставщика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН");
		
	КонецЕсли;

	Контрагент = Справочники.Контрагенты.ПустаяСсылка();
	СсылкаНаОбъектПоИННКПП("Контрагенты", ИННПоставщика, КПППоставщика, Контрагент);
	Если ЗначениеЗаполнено(Контрагент) Тогда
		ДанныеОбъекта.Вставить("Контрагент", Контрагент);
		ДанныеОбъекта.Вставить("Партнер",  	 Контрагент.Партнер);
	Иначе
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'В базе данных не удалось найти контрагента с ИНН ""%1"" и КПП ""%2""'"),
			ИННПоставщика, КПППоставщика);
		ВызватьИсключение ТекстСообщения;		
	КонецЕсли;
	
	// Сведения о покупателе.
	ИННПокупателя = ""; КПППокупателя = "";
	ВидУчастника = "СведенияОПокупателе";
	Если ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ЮЛ" Тогда
		
		ИННПокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
		КПППокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");
		
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ИП" Тогда
		
		ИННПокупателя = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН");
		
	КонецЕсли;

	Организация = Справочники.Организации.ПустаяСсылка();
	СсылкаНаОбъектПоИННКПП("Организации", ИННПокупателя, КПППокупателя, Организация);
	ДанныеОбъекта.Вставить("Организация", Организация);
	
	ДанныеОбъекта.Вставить("Сумма", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровСНалогомУвеличение")
									+ ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровСНалогомУменьшение"));
									
	Товары = Документы.КорректировкаПриобретения.ПустаяСсылка().Товары.ВыгрузитьКолонки();
	Товары.Колонки.Добавить("НомерПоДаннымПоставщика");
	Товары.Колонки.Добавить("ДатаПоДаннымПоставщика");
	Товары.Колонки.Добавить("НомерПоДаннымКлиента");
	Товары.Колонки.Добавить("ДатаПоДаннымКлиента");
	
	ШтрихкодыУпаковок = ЭлектронноеВзаимодействиеИСМП.НоваяТаблицаШтрихкодыУпаковок(Истина);
	
	Если ТипЗнч(ДанныеОбъекта.ДокументОснование) = Тип("ДокументСсылка.ПриобретениеТоваровУслуг") Тогда
		ШтрихкодыУпаковокОснования = ШтрихкодированиеИСМПСлужебный.ДанныеМаркируемойНоменклатурыКодовМаркировкиПоДаннымЭДО(ДанныеОбъекта.ДокументОснование);
		Если ШтрихкодыУпаковокОснования <> Неопределено Тогда
			ШтрихкодыУпаковокОснования.Индексы.Добавить("Номенклатура, Характеристика");
		Иначе
			ШтрихкодыУпаковокОснования = ШтрихкодыУпаковок.СкопироватьКолонки();
		КонецЕсли;
	Иначе
		ШтрихкодыУпаковокОснования = ШтрихкодыУпаковок.СкопироватьКолонки();
	КонецЕсли;
	
	ПараметрыЗаполненияСтрокиТоваров = ПараметрыЗаполненияСтрокиТоваровСведениямиОПрослеживаемости();
	ПараметрыЗаполненияСтрокиТоваров.ИмяПоляКоличествоПоРНПТ = "КоличествоТовараПослеИзменения";
	ПараметрыЗаполненияСтрокиТоваров.ИмяПоляКоличествоУчетноеПоРНПТ = "КоличествоТовараУчетноеПослеИзменения";
	ПараметрыЗаполненияСтрокиТоваров.ИмяПоляСтоимостьБезНДС = "СтоимостьБезНДСПослеИзменения";
	
	ДокОснованияПервичныйДокумент = Ложь;
	СтрокиДопДанныеСчетаФактуры = ДеревоДанных.Строки.Найти("ДопДанныеСчетаФактуры", "ПолныйПуть");
	СтрокаТаблицы = СтрокиДопДанныеСчетаФактуры.Строки.Найти("ДопДанныеСчетаФактуры.ТекстоваяИнформация", "ПолныйПуть");
	Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
		Для Каждого Информация Из СтрокаТаблицы.Строки Цикл
			
			Идентификатор = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(Информация,
				"ДопДанныеСчетаФактуры.ТекстоваяИнформация.НомерСтроки.Идентификатор");
			Значение = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(Информация,
				"ДопДанныеСчетаФактуры.ТекстоваяИнформация.НомерСтроки.Значение");
			
			Если Идентификатор = "ДокументОснованиеПервичныйДокумент" Тогда
				ДокОснованияПервичныйДокумент = Значение;
			КонецЕсли;
 		КонецЦикла;
	КонецЕсли;
	
	ТоварыДокументаОснованияТабЧасть = Документы.КорректировкаПриобретения.ПустаяСсылка().Товары;
	Если Не ДокОснованияПервичныйДокумент Тогда
		Документы.КорректировкаПриобретения.ЗаполнитьТоварыПоИсходнымДанным(ДанныеОбъекта.ДокументОснование, ТоварыДокументаОснованияТабЧасть);
	КонецЕсли;
	ТоварыДокументаОснования = ТоварыДокументаОснованияТабЧасть.Выгрузить();
	
	СведенияОТоварах = ДеревоДанных.Строки.Найти("СведенияОТоварах", "ПолныйПуть");
	Для Каждого СведенияОТоваре Из СведенияОТоварах.Строки Цикл
		
		НоваяСтрока = Товары.Добавить();
	
		// Обязательные реквизиты:
		СтавкаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.НалоговаяСтавка");
		НоваяСтрока.СтавкаНДС = ?(СтавкаНДС = "НДС исчисляется налоговым агентом", УчетНДСУП.СтавкаНДСПоУмолчанию(Организация, ТекущаяДатаСеанса(), Истина), СтавкаНДС);
		НоваяСтрока.СуммаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СуммаНалога");
		
		// Необязательные реквизиты:
		НоваяСтрока.Количество = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.Количество");
		НоваяСтрока.Цена = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.ЦенаЗаЕдиницуИзмерения");
		НоваяСтрока.Сумма = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровБезНалога");
		НоваяСтрока.СуммаСНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогом");
		
		Сопоставление = СведенияОТоваре.Строки.Найти(
			"СведенияОТоварах.НомерСтроки.Сопоставление", "ПолныйПуть", Истина);
		Если Сопоставление <> Неопределено Тогда
			
			Идентификатор = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.Сопоставление.Идентификатор");
			Если ЗначениеЗаполнено(Идентификатор) Тогда
				НоменклатураПартнера = НоменклатураПартнеровСервер.НайтиСсылкуНаНоменклатуруПартнераПоИдентификатору(Идентификатор);
				Если ЗначениеЗаполнено(НоменклатураПартнера) Тогда
					НоваяСтрока.НоменклатураПартнера = НоменклатураПартнера;
				КонецЕсли;
			КонецЕсли;
			
			Номенклатура = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.Сопоставление.НоменклатураИБ");
			Если ЗначениеЗаполнено(Номенклатура) Тогда
				НоваяСтрока.Номенклатура = Номенклатура;
			КонецЕсли;
			
			Характеристика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.Сопоставление.ХарактеристикаИБ");
			Если ЗначениеЗаполнено(Характеристика) Тогда
				НоваяСтрока.Характеристика = Характеристика;
			КонецЕсли;
			
			Упаковка = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.Сопоставление.УпаковкаИБ");
			Если ЗначениеЗаполнено(Упаковка) Тогда
				НоваяСтрока.Упаковка = Упаковка;
			КонецЕсли;
			
		КонецЕсли;

		ПараметрыОтбора = Новый Структура;
		Если ТипЗнч(ДанныеОбъекта.ДокументОснование) <> Тип("ДокументСсылка.ПриобретениеУслугПрочихАктивов") Тогда
			ПараметрыОтбора.Вставить("Номенклатура", НоваяСтрока.Номенклатура);
			ИсключенияСвойствДляЗаполнения = "Номенклатура,Характеристика,Упаковка,
											|СтавкаНДС,СуммаНДС,Количество,КоличествоУпаковок,Цена,Сумма,СуммаСНДС,
											|СписатьНаРасходы,НомерГТД,КоличествоПоРНПТ";
		Иначе
			ПараметрыОтбора.Вставить("Содержание", Строка(НоваяСтрока.Номенклатура));
			ИсключенияСвойствДляЗаполнения = "СтавкаНДС,СуммаНДС,Количество,КоличествоУпаковок,Цена,Сумма,СуммаСНДС";
		КонецЕсли;
		Если ЗначениеЗаполнено(НоваяСтрока.Характеристика) Тогда
			ПараметрыОтбора.Вставить("Характеристика", НоваяСтрока.Характеристика);
		КонецЕсли;
		Если ЗначениеЗаполнено(НоваяСтрока.Упаковка) Тогда
			ЕдиницаХраненияНоменклатуры = ЭлектронноеВзаимодействиеУТВызовСервера.ЕдиницаХраненияНоменклатуры(НоваяСтрока.Номенклатура);
			Если НоваяСтрока.Упаковка <> ЕдиницаХраненияНоменклатуры Тогда			
				ПараметрыОтбора.Вставить("Упаковка", НоваяСтрока.Упаковка);
			КонецЕсли;
		КонецЕсли;		
		НайденнаяСтрокаТоваров = ТоварыДокументаОснования.НайтиСтроки(ПараметрыОтбора);
			
		Если НайденнаяСтрокаТоваров.Количество() = 1 Тогда
			ЗаполнитьЗначенияСвойств(НоваяСтрока, НайденнаяСтрокаТоваров[0],, ИсключенияСвойствДляЗаполнения);			
			Для Каждого Строка Из НайденнаяСтрокаТоваров Цикл
				ТоварыДокументаОснования.Удалить(Строка);
			КонецЦикла;
		ИначеЕсли НайденнаяСтрокаТоваров.Количество() > 1 Тогда
			
			КоличествоДоКорректировки = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.КоличествоДоКорректировки");
			СтоимостьТоваровСНалогомДоКорректировки = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогомДоКорректировки");
			
			СтрокаНашлась = Ложь;
			Для Каждого Строка Из НайденнаяСтрокаТоваров Цикл
				Если Строка.Количество = КоличествоДоКорректировки И Строка.СуммаСНДС = СтоимостьТоваровСНалогомДоКорректировки Тогда
					ЗаполнитьЗначенияСвойств(НоваяСтрока, Строка,, ИсключенияСвойствДляЗаполнения);					
					ТоварыДокументаОснования.Удалить(Строка);
					СтрокаНашлась = Истина;
					Прервать;
				КонецЕсли;
			КонецЦикла;
			Если Не СтрокаНашлась Тогда
				ЗаполнитьЗначенияСвойств(НоваяСтрока, НайденнаяСтрокаТоваров[0],, ИсключенияСвойствДляЗаполнения);				
				Для Каждого Строка Из НайденнаяСтрокаТоваров Цикл
					ТоварыДокументаОснования.Удалить(Строка);
				КонецЦикла;
			КонецЕсли;
		Иначе 
			НоваяСтрока.НомерСтроки = 99999;
		КонецЕсли;
		
		Если НоваяСтрока.Количество = 0 Тогда
			Товары.Удалить(НоваяСтрока);
			Продолжить;
		КонецЕсли;
		
		ЭтоИмущество = Истина;
		
		ТипНоменклатуры = НоваяСтрока.Номенклатура.ТипНоменклатуры;
		Если ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Услуга") Тогда
			НоваяСтрока.СписатьНаРасходы = Истина;
			ЭтоИмущество = Ложь;
		КонецЕсли;
		
		Если ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НоваяСтрока.Номенклатура, "ВестиУчетПоГТД") = Истина Тогда
			ВестиУчетПоГТД = Истина;
		Иначе
			ВестиУчетПоГТД = Ложь;
		КонецЕсли;
		
		Если ЭтоИмущество
			И ВестиУчетПоГТД Тогда
			
			СведенияОПрослеживаемости		= СведенияОТоваре.Строки.Найти(
												"СведенияОТоварах.НомерСтроки.СведенияОПрослеживаемости",
												"ПолныйПуть",
												Истина);
			СведенияОТаможеннойДекларации	= СведенияОТоваре.Строки.Найти(
												"СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации",
												"ПолныйПуть",
												Истина);

			ПараметрыЗаполненияСтрокиТоваров.Вставить("ЭтоУПД_2019", Ложь);
																								
			ЗаполнитьСтрокуТоваровСведениямиОПрослеживаемости(НоваяСтрока,
																Товары,
																СведенияОПрослеживаемости,
																СведенияОТаможеннойДекларации,
																ПараметрыЗаполненияСтрокиТоваров);
			
			ЗаполнитьСтрокуТоваровСведениямиОТаможеннойДекларации(НоваяСтрока,
																	СведенияОТаможеннойДекларации,
																	ПараметрыЗаполненияСтрокиТоваров);
			
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеИСМП.ДобавитьШтрихкодыТаблицуШтрихкодовУпаковок_УКД2020(ШтрихкодыУпаковок, СведенияОТоваре, ШтрихкодыУпаковокОснования, НоваяСтрока);
		
	КонецЦикла;
	
	// заполним Характеристики и Упаковки по соответствию из НоменклатурыПоставщика,
	//Переносим значения из колонки СуммаСкидки в СуммаРучнойСкидки, т.к. название реквизита табличной части документа
	//не совпадает с названием реквизита СтрокиДляЗагрузки

	Для Каждого ТекСтрока Из Товары Цикл 
		ТекСтрока.КоличествоУпаковок = ТекСтрока.Количество;
		// заполним Количество с учетом единиц измерения
		Если ЗначениеЗаполнено(ТекСтрока.Упаковка) Тогда
			ТекКоэффициент = Справочники.УпаковкиЕдиницыИзмерения.КоэффициентУпаковки(ТекСтрока.Упаковка, ТекСтрока.Номенклатура);
		Иначе
			ТекКоэффициент = 1;
		КонецЕсли;
		ТекСтрока.Количество = ТекСтрока.КоличествоУпаковок * ТекКоэффициент;
	КонецЦикла;

	Для Каждого СтрокаТЧоснования Из ТоварыДокументаОснования Цикл
		ДобавляемаяСтрока = Товары.Добавить();
		ЗаполнитьЗначенияСвойств(ДобавляемаяСтрока, СтрокаТЧоснования);
		ЭлектронноеВзаимодействиеИСМП.ДобавитьШтрихкодыПоДокументуОснованию_УКД(ШтрихкодыУпаковок, ШтрихкодыУпаковокОснования, ДобавляемаяСтрока);
	КонецЦикла;
	
	Товары.Сортировать("НомерСтроки, Номенклатура, Характеристика, Серия, Упаковка");
	
	ДанныеДляЗаполнения = Новый Структура();
	ДанныеДляЗаполнения.Вставить("Шапка", ДанныеОбъекта);
	ДанныеДляЗаполнения.Вставить("Товары", Товары);
	ДанныеДляЗаполнения.Вставить("ШтрихкодыУпаковок", ШтрихкодыУпаковок);
	
	Если ДокОснованияПервичныйДокумент Тогда
		Расхождения = Документы.КорректировкаПриобретения.ПустаяСсылка().Расхождения.ВыгрузитьКолонки(); 		
		ЗаполнитьРасхожденияДляПервичногоДокумента(Организация, СведенияОТоварах, Расхождения, ПараметрыЗаполненияСтрокиТоваров);
		ДанныеДляЗаполнения.Вставить("Расхождения", Расхождения);		
	КонецЕсли;	
	
	Возврат ДанныеДляЗаполнения;

КонецФункции

Процедура ЗаполнитьДанныеУчастникаУПД(ДеревоДанных, СведенияОбУчастнике, ВидУчастника, ВидАдреса = "Юр", ДатаКИ = Неопределено) Экспорт
	
	Если СведенияОбУчастнике.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ЮрЛицо Тогда
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".ТипУчастника.ЮЛ.НаименованиеОрганизации",
									СведенияОбУчастнике.ПолноеНаименование);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".ТипУчастника.ЮЛ.ИНН",
									СведенияОбУчастнике.ИНН);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".ТипУчастника.ЮЛ.КПП",
									СведенияОбУчастнике.КПП);

	ИначеЕсли СведенияОбУчастнике.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ЮрЛицоНеРезидент Тогда
	
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".ТипУчастника.ИЛ.НаименованиеОрганизации",
									СведенияОбУчастнике.ПолноеНаименование);
	Иначе
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".ТипУчастника.ИП.ИНН",
									СведенияОбУчастнике.ИНН);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".ТипУчастника.ИП.СвидетельствоОГосРегистрации",
									СведенияОбУчастнике.Свидетельство);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".ТипУчастника.ИП.Фамилия",
									СведенияОбУчастнике.Фамилия);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".ТипУчастника.ИП.Имя",
									СведенияОбУчастнике.Имя);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".ТипУчастника.ИП.Отчество",
									СведенияОбУчастнике.Отчество);
	КонецЕсли;
	
	СведенияОбУчастнике.Вставить("ДатаКИ", ДатаКИ);
	АдресУчастника = Новый Структура;
	ПолучитьАдресСтруктурой(АдресУчастника, СведенияОбУчастнике, "Ссылка", ВидАдреса);
	
	Если АдресУчастника.Свойство("АдресРФ") Тогда
		ТипАдреса = ?(АдресУчастника.АдресРФ, "АдресРФ", "АдресИнформация");
		ЗаполнитьАдресВДереве(ДеревоДанных, АдресУчастника, ТипАдреса, ВидУчастника);
	КонецЕсли;	
		
	Если ЗначениеЗаполнено(СведенияОбУчастнике.Телефоны) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".КонтактныеСведения.Телефон",
									СведенияОбУчастнике.Телефоны);
	КонецЕсли;

	Если ЗначениеЗаполнено(СведенияОбУчастнике.ЭлектроннаяПочта) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".КонтактныеСведения.ЭлектроннаяПочта",
									СведенияОбУчастнике.ЭлектроннаяПочта);
	КонецЕсли;
	
	НомерСчета = "";
	Если СведенияОбУчастнике.Свойство("НомерСчета", НомерСчета) И ЗначениеЗаполнено(НомерСчета) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДанных,
				ВидУчастника + ".БанковскиеРеквизиты.НомерСчета",
				НомерСчета);
				
		Банк = ""; БИК = ""; КоррСчет = "";
		Если СведенияОбУчастнике.Свойство("Банк", Банк) И ЗначениеЗаполнено(Банк) Тогда
			Если ТипЗнч(Банк) = Тип("Строка") Тогда
				БанкНаименование = Банк
			Иначе
				БанкНаименование = Банк.Наименование
			КонецЕсли;
			
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
										ДеревоДанных,
										ВидУчастника + ".БанковскиеРеквизиты.НаименованиеБанка",
										БанкНаименование);
		КонецЕсли;
		Если СведенияОбУчастнике.Свойство("БИК", БИК) И ЗначениеЗаполнено(БИК) Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
										ДеревоДанных,
										ВидУчастника + ".БанковскиеРеквизиты.БИКБанка",
										БИК);
		КонецЕсли;
		Если СведенияОбУчастнике.Свойство("КоррСчет", КоррСчет) И ЗначениеЗаполнено(КоррСчет) Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
										ДеревоДанных,
										ВидУчастника + ".БанковскиеРеквизиты.КорреспондентскийСчетБанка",
										КоррСчет);
		КонецЕсли;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СведенияОбУчастнике.КодПоОКПО) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".КодОКПО", СведенияОбУчастнике.КодПоОКПО);
	КонецЕсли;
		
КонецПроцедуры

Функция НомерСчетаФактурыНаПечать(Номер, ИндексПодразделения, УдалитьПользовательскийПрефикс = Ложь) Экспорт
	
	НомерНаПечать = "";
	
	Если Номер <> Неопределено Тогда
	
		НомерНаПечать = ПрефиксацияОбъектовКлиентСервер.НомерНаПечать(Номер, Ложь, УдалитьПользовательскийПрефикс);
		
		ПозицияРазделителя = СтрНайти(НомерНаПечать, "-");
		Префикс = Лев(НомерНаПечать, ПозицияРазделителя);
		НомерБезПрефикса = Сред(НомерНаПечать, ПозицияРазделителя + 1);
		
		Если Лев(НомерБезПрефикса, 1) = "И" Тогда
			НомерНаПечать = Префикс + Сред(НомерБезПрефикса, 2);
		КонецЕсли;
		Если ЗначениеЗаполнено(ИндексПодразделения) Тогда
			НомерНаПечать = НомерНаПечать + "/" + ИндексПодразделения;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат НомерНаПечать;
	
КонецФункции

#КонецОбласти

////////////////////////////////////////////////////////////////////////////////
// Прочие процедуры и функции

// Определяет, является ли объект корректировочным документом.
//
// Параметры:
//  СсылкаНаОбъект - ДокументСсылка._ДемоСчетФактураВыданный.
//
// Возвращаемое значение:
//  Результат - Булево - Истина, объект является ли корректировочным документом.
//
Функция ЭтоКорректировочныйДокумент(СсылкаНаОбъект) Экспорт
	
	Результат = Ложь;
	
	Если ТипЗнч(СсылкаНаОбъект) = Тип("ДокументСсылка.СчетФактураВыданный") Тогда
		Если СсылкаНаОбъект <> Документы.СчетФактураВыданный.ПустаяСсылка() Тогда
			Результат = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СсылкаНаОбъект, "Корректировочный");
		Иначе
			Результат = Ложь;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Процедура ЗаполнитьРеквизитыПодвала(ДанныеПечати, ИтоговыеСуммы, ДеревоДанных) Экспорт

	КоэффициентПересчетаВТонны     = НоменклатураСервер.КоэффициентПересчетаВТонны(Константы.ЕдиницаИзмеренияВеса.Получить());
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, 
			"СведенияПоОтпускуГруза.ДатаОтпуска", 
			ДанныеПечати.Дата);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, 
			"ОбщиеСведенияОТоварнойНакладной.КоличествоПорядковыхНомеровЗаписей", 
			ИтоговыеСуммы.КоличествоПорядковыхНомеровЗаписей);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, 
			"ОбщиеСведенияОТоварнойНакладной.КоличествоПорядковыхНомеровЗаписейПрописью", 
			ЧислоПрописью(ИтоговыеСуммы.КоличествоПорядковыхНомеровЗаписей, ,",,,,,,,,0"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, 
			"ОбщиеСведенияОТоварнойНакладной.ВсегоМест", 
			ИтоговыеСуммы.КоличествоМест);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, 
			"ОбщиеСведенияОТоварнойНакладной.МассаГрузаНетто", 
			ИтоговыеСуммы.МассаНетто);
	
	Если ИтоговыеСуммы.КоличествоМест > 0 Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, 
			"ОбщиеСведенияОТоварнойНакладной.ВсегоМестПрописью", 
			ЧислоПрописью(ИтоговыеСуммы.КоличествоМест, ,",,,,,,,,0"));
	КонецЕсли;
	
	Если ИтоговыеСуммы.МассаНетто > 0 Тогда
		ПараметрыМассыПрописью = ПараметрыМассыПрописью(ИтоговыеСуммы.МассаНетто, КоэффициентПересчетаВТонны);
		МассаГрузаНеттоПрописью = 
			ЧислоПрописью(ИтоговыеСуммы.МассаНетто * ПараметрыМассыПрописью.Коэффициент, "ДП=Истина", ПараметрыМассыПрописью.Формат);
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, 
			"ОбщиеСведенияОТоварнойНакладной.МассаГрузаНеттоПрописью", 
			МассаГрузаНеттоПрописью);
		
	КонецЕсли;
	
	Если ИтоговыеСуммы.МассаБрутто > 0 Тогда
		ПараметрыМассыПрописью = ПараметрыМассыПрописью(ИтоговыеСуммы.МассаНетто, КоэффициентПересчетаВТонны);
		МассаГрузаБруттоПрописью = 
			ЧислоПрописью(ИтоговыеСуммы.МассаБрутто * ПараметрыМассыПрописью.Коэффициент, "ДП=Истина", ПараметрыМассыПрописью.Формат);
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, 
			"ОбщиеСведенияОТоварнойНакладной.МассаГрузаБруттоПрописью", 
			МассаГрузаБруттоПрописью);
			
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, 
			"ОбщиеСведенияОТоварнойНакладной.МассаГрузаБрутто", 
			ИтоговыеСуммы.МассаБрутто);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, 
			"ВсегоПоНакладной.КоличествоМест", 
			ИтоговыеСуммы.КоличествоМест);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, 
			"ВсегоПоНакладной.МассаБрутто", 
			ИтоговыеСуммы.МассаБрутто);

	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, 
			"ВсегоПоНакладной.МассаНетто", 
			ИтоговыеСуммы.МассаНетто);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, 
			"ВсегоПоНакладной.СуммаБезНДС", 
			ИтоговыеСуммы.СуммаБезНДС);
			
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, 
			"ВсегоПоНакладной.СуммаНДС", 
			ИтоговыеСуммы.СуммаНДС);

	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, 
			"ВсегоПоНакладной.СуммаСНДС", 
			ИтоговыеСуммы.СуммаСНДС);
	
КонецПроцедуры

Процедура ОкруглитьМассыТовара(ДанныеСтроки) Экспорт
	
	ДанныеСтроки.МассаБрутто = Окр(ДанныеСтроки.МассаБрутто, 3);
	ДанныеСтроки.МассаНетто = Окр(ДанныеСтроки.МассаНетто, 3);

КонецПроцедуры

Процедура ОбработатьТаблицуТоваров(ТаблицаТоваров) Экспорт
	
	Для Каждого Строка из ТаблицаТоваров Цикл
		Если НЕ ЗначениеЗаполнено(Строка.ИД) Тогда
			ИДТовара = Строка.Номенклатура.УникальныйИдентификатор();
			Если ТипЗнч(Строка.Характеристика) = Тип("Строка") Тогда
				СсылкаНаХарактеристику = Строка.ХарактеристикаСсылка;
			Иначе
				СсылкаНаХарактеристику = Строка.Характеристика;
			КонецЕсли;
			ИДХарактеристики = ?(ЗначениеЗаполнено(СсылкаНаХарактеристику),СсылкаНаХарактеристику.УникальныйИдентификатор(),"");
			Если ТипЗнч(Строка.Упаковка) = Тип("Строка") Тогда
				СсылкаНаУпаковку = Строка.УпаковкаСсылка;
			Иначе
				СсылкаНаУпаковку = Строка.Упаковка;
			КонецЕсли;
			ИДУпаковки = ?(ЗначениеЗаполнено(СсылкаНаУпаковку),СсылкаНаУпаковку.УникальныйИдентификатор(),"");
			Строка.ИД = Строка(ИДТовара) + "#" + Строка(ИДХарактеристики) + "#" + Строка(ИДУпаковки);
			Строка.Наименование = ?(ЗначениеЗаполнено(Строка.Наименование),Строка.Наименование,"")  //номенклатура
			+ ?(ЗначениеЗаполнено(Строка.Характеристика)," (","") //Открывающаяся скобка
			+ ?(ЗначениеЗаполнено(Строка.Характеристика),Строка.Характеристика,"") //характеристика
			+ ?(ЗначениеЗаполнено(Строка.Характеристика),")",""); //Закрывающаяся скобка
		КонецЕсли;
		//Коды единиц измерения для CML 4.02
		Строка.БазоваяЕдиницаКод = СокрЛП(Строка.БазоваяЕдиницаКод);
		Строка.УпаковкаКод = СокрЛП(Строка.УпаковкаКод);
	КонецЦикла;
	
КонецПроцедуры

Функция СоздатьКонтрагентаВБД(ДанныеКонтрагента) Экспорт
	
	Если НЕ ЗначениеЗаполнено(ДанныеКонтрагента.ИНН) Тогда
		Возврат Неопределено; 
	КонецЕсли;
	
	НовыйПартнер        = Неопределено;
	СсылкаНаКонтрагента = Неопределено;
	
	Если СтрДлина(ДанныеКонтрагента.ИНН) = 10 Тогда
		ДанныеКонтрагента.Вставить("ЮрФизЛицо", Перечисления.ЮрФизЛицо.ЮрЛицо);
		ДанныеКонтрагента.Вставить("ЮридическоеФизическоеЛицо", Перечисления.ЮридическоеФизическоеЛицо.ЮридическоеЛицо);
	Иначе
		ДанныеКонтрагента.Вставить("ЮрФизЛицо", Перечисления.ЮрФизЛицо.ФизЛицо);
		ДанныеКонтрагента.Вставить("ЮридическоеФизическоеЛицо", Перечисления.ЮридическоеФизическоеЛицо.ФизическоеЛицо);
	КонецЕсли;
	Если ДанныеКонтрагента.Свойство("Наименование") Тогда
		ДанныеКонтрагента.Вставить("Наименование", ДанныеКонтрагента.Наименование);
		ДанныеКонтрагента.Вставить("НаименованиеПолное", ДанныеКонтрагента.Наименование);
	Иначе
		ДанныеКонтрагента.Вставить("Наименование", ДанныеКонтрагента.СокращенноеНаименование);
		ДанныеКонтрагента.Вставить("НаименованиеПолное", ДанныеКонтрагента.СокращенноеНаименование);
	КонецЕсли;
	Если ДанныеКонтрагента.Свойство("ПолноеНаименование") Тогда
		ДанныеКонтрагента.Вставить("НаименованиеПолное", ДанныеКонтрагента.ПолноеНаименование);
		Если Не ЗначениеЗаполнено(ДанныеКонтрагента.СокращенноеНаименование) Тогда
			ДанныеКонтрагента.Вставить("Наименование", ДанныеКонтрагента.ПолноеНаименование);
		КонецЕсли;
	КонецЕсли;
	Если ДанныеКонтрагента.Свойство("КодыОрганизации") Тогда
		Если ДанныеКонтрагента.КодыОрганизации.Свойство("ПолноеНаименование") Тогда
			ДанныеКонтрагента.Вставить("НаименованиеПолное", ДанныеКонтрагента.КодыОрганизации.ПолноеНаименование);
		КонецЕсли;
	КонецЕсли;
	
	НовыйКонтрагент = Справочники.Контрагенты.СоздатьЭлемент();
	ЗаполнитьЗначенияСвойств(НовыйКонтрагент, ДанныеКонтрагента);
	
	Если ДанныеКонтрагента.Свойство("ЮрАдрес") Тогда
		УправлениеКонтактнойИнформацией.ДобавитьКонтактнуюИнформацию(НовыйКонтрагент, 
		                                                             ДанныеКонтрагента.ЮрАдрес, 
		                                                             Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента,
			                                                         ТекущаяДатаСеанса());
	КонецЕсли; 
		
	Если ДанныеКонтрагента.Свойство("ФактАдрес") Тогда
		УправлениеКонтактнойИнформацией.ДобавитьКонтактнуюИнформацию(НовыйКонтрагент, 
		                                                             ДанныеКонтрагента.ФактАдрес, 
		                                                             Справочники.ВидыКонтактнойИнформации.ФактАдресКонтрагента);
	КонецЕсли;
	
	НовыйПартнер = Справочники.Партнеры.СоздатьЭлемент();
		
	СсылкаНовогоПартнера = Справочники.Партнеры.ПолучитьСсылку();
	НовыйПартнер.УстановитьСсылкуНового(СсылкаНовогоПартнера);
	
	ЗаполнитьЗначенияСвойств(НовыйПартнер, ДанныеКонтрагента);
	
	НовыйПартнер.ДатаРегистрации = ТекущаяДатаСеанса();
	НовыйПартнер.Клиент 		 = Истина;
	НовыйПартнер.Поставщик 		 = Истина;
	НовыйПартнер.ПрочиеОтношения = Истина;
	
	Если ДанныеКонтрагента.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ФизЛицо Тогда
		НовыйПартнер.ЮрФизЛицо = Перечисления.КомпанияЧастноеЛицо.ЧастноеЛицо;
	Иначе
		НовыйПартнер.ЮрФизЛицо = Перечисления.КомпанияЧастноеЛицо.Компания;
	КонецЕсли;
	
	ИспользуютсяГруппыДоступаПартнеров = Справочники.ГруппыДоступаПартнеров.ИспользуютсяГруппыДоступа();
	Если ИспользуютсяГруппыДоступаПартнеров
		И НЕ ЗначениеЗаполнено(НовыйПартнер.ГруппаДоступа) Тогда
		НовыйПартнер.ГруппаДоступа = ГруппаДоступаПартнера();
	КонецЕсли;
	
	Если ДанныеКонтрагента.Свойство("ФактАдрес") Тогда
		УправлениеКонтактнойИнформацией.ДобавитьКонтактнуюИнформацию(НовыйПартнер, 
		                                                             ДанныеКонтрагента.ФактАдрес, 
		                                                             Справочники.ВидыКонтактнойИнформации.АдресПартнера);
	КонецЕсли;
	
	НачатьТранзакцию();	
	Попытка		
		//Записываем нового партнера
		Если НовыйПартнер <> Неопределено Тогда
			НовыйПартнер.Записать();
			НовыйКонтрагент.Партнер = НовыйПартнер.Ссылка;
		КонецЕсли;
		
		//Записываем нового контрагента
		НовыйКонтрагент.Записать();
		СсылкаНаКонтрагента = НовыйКонтрагент.Ссылка;		
		ЗафиксироватьТранзакцию();
	Исключение
		ОтменитьТранзакцию();
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке()) + " " + НСтр("ru = '(подробности см. в Журнале регистрации).'");
		ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействие.ОбработатьОшибку(НСтр("ru = 'Создание нового контрагента'"), ТекстОшибки, ТекстСообщения);
	КонецПопытки;
	
	Возврат СсылкаНаКонтрагента; 
	
КонецФункции

Процедура ЗаполнитьДокументыОснования(ДеревоДанных, СсылкаНаОбъект) Экспорт
	
	ДокументОснование = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СсылкаНаОбъект, "ДокументОснование");
	Если ЗначениеЗаполнено(ДокументОснование) Тогда
		МассивДокументовОснований = Новый Массив;
		МассивДокументовОснований.Добавить(ДокументОснование);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, 
			"ДокументыОснования", 
			МассивДокументовОснований);
	КонецЕсли;
	
КонецПроцедуры

Функция СоздатьПерезаполнитьНоменклатуруПоставщика(СтрокаОбъекта, ДеревоРазбора) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если ЗначениеЗаполнено(СтрокаОбъекта.СсылкаНаОбъект) Тогда
		НовЭл = СтрокаОбъекта.СсылкаНаОбъект.ПолучитьОбъект();
		Попытка 
			НовЭл.Заблокировать();
		Исключение
			ТекстИсключенияЗаписи = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Не удалось изменить данные номенклатуры поставщика ""%1"".
			|Возможно, номенклатура поставщика редактируется другим пользователем'"),
			НовЭл.Наименование);			
			ВызватьИсключение ТекстИсключенияЗаписи;
		КонецПопытки;
		СсылкаНаОбъектНоменклатура = СтрокаОбъекта.СсылкаНаОбъект.Номенклатура;
	Иначе
		НовЭл = Справочники.НоменклатураКонтрагентов.СоздатьЭлемент();
		СсылкаНаОбъектНоменклатура = Неопределено;
	КонецЕсли;
	//
	ЗаполнитьРеквизитыОбъектаПоСоответствиюИмен(СтрокаОбъекта, НовЭл);
	// если нет ссылки на номенклатуру, то будем создавать ее
	Если НЕ ЗначениеЗаполнено(СсылкаНаОбъектНоменклатура) Тогда 
		НайденнаяСтрока = СтрокаОбъекта.Строки.Найти("Номенклатура", "Реквизит", Истина);
		Если НайденнаяСтрока <> Неопределено Тогда
			Если ЗначениеЗаполнено(НайденнаяСтрока.СсылкаНаОбъект) Тогда // Найдена ссылка
				СсылкаНаОбъектНоменклатура = НайденнаяСтрока.СсылкаНаОбъект;
			Иначе // будем искать по индексу
				ИндексИскомойСтроки = НайденнаяСтрока.ЗначениеРеквизита;	
				НайденнаяСтрока = ДеревоРазбора.Строки.Найти(ИндексИскомойСтроки, "ИндексСтроки", Истина); // строка с объектом
				Если НайденнаяСтрока <> Неопределено Тогда
					Если ЗначениеЗаполнено(НайденнаяСтрока.СсылкаНаОбъект) Тогда // есть ссылка на объект БД
						СсылкаНаОбъектНоменклатура = НайденнаяСтрока.СсылкаНаОбъект;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		НовЭл.Номенклатура = СсылкаНаОбъектНоменклатура;
		// Заполняем идентификатор номенклатуры поставщика, если он получен в реквизите Ид
		СтрокаИд = СтрокаОбъекта.Строки.Найти("Ид", "Реквизит", Истина);
		Если НЕ ЗначениеЗаполнено(НовЭл.Идентификатор) И ЗначениеЗаполнено(СтрокаИд) Тогда
			НовЭл.Идентификатор = СтрокаИд.ЗначениеРеквизита;
		КонецЕсли;
		// Заполнение найденного поставщика (владельца, тип Справочник.Партнеры)
		СтрокиПартнеры = ДеревоРазбора.Строки.Найти("Партнеры", "ТипОбъекта", Истина);
		Если СтрокиПартнеры <> Неопределено и СтрокиПартнеры.Строки.Количество() = 1 Тогда
			НовЭл.Владелец = СтрокиПартнеры.Строки[0].СсылкаНаОбъект;
		Иначе
			СтрокиКонтрагент = ДеревоРазбора.Строки.Найти("Контрагенты", "ТипОбъекта", Истина);
			Если СтрокиКонтрагент <> Неопределено И СтрокиКонтрагент.Строки.Количество() = 1 Тогда
				НовЭл.Владелец = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтрокиКонтрагент.Строки[0].СсылкаНаОбъект, "Партнер");
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(НовЭл.Код) Тогда
		НовЭл.УстановитьНовыйКод();
	КонецЕсли;
	//
	НовЭл.ОбменДанными.Загрузка = Истина;
	Попытка
		НовЭл.Записать();
		НовЭл.Разблокировать();
	Исключение
		Текст = НСтр("ru = 'Создание элемента справочника ""Номенклатура поставщиков"".'", ОбщегоНазначения.КодОсновногоЯзыка());
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка,,,ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;
	
	СсылкаНаОбъект = НовЭл.Ссылка;
	
	Возврат СсылкаНаОбъект;
	
КонецФункции

Функция РеквизитыБанковскогоСчета(ИмяСправочника, СсылкаНаБанковскийСчет) Экспорт
	
	БанковскийСчет = Новый Структура;
	ЗапросСчет = Новый Запрос;
	ТекстЗапроса = "ВЫБРАТЬ
					|	БанковскиеСчета.НомерСчета,
					|	ВЫБОР
					|		КОГДА БанковскиеСчета.РучноеИзменениеРеквизитовБанка
					|			ТОГДА БанковскиеСчета.НаименованиеБанка
					|		ИНАЧЕ БанковскиеСчета.Банк.Наименование
					|	КОНЕЦ КАК НаименованиеБанка,
					|	ВЫБОР
					|		КОГДА БанковскиеСчета.РучноеИзменениеРеквизитовБанка
					|			ТОГДА БанковскиеСчета.БИКБанка
					|		ИНАЧЕ БанковскиеСчета.Банк.Код
					|	КОНЕЦ КАК БИКБанка,
					|	ВЫБОР
					|		КОГДА БанковскиеСчета.РучноеИзменениеРеквизитовБанка
					|			ТОГДА БанковскиеСчета.КоррСчетБанка
					|		ИНАЧЕ БанковскиеСчета.Банк.КоррСчет
					|	КОНЕЦ КАК КоррСчетБанка,
					|	ВЫБОР
					|		КОГДА БанковскиеСчета.РучноеИзменениеРеквизитовБанкаДляРасчетов
					|			ТОГДА БанковскиеСчета.НаименованиеБанкаДляРасчетов
					|		ИНАЧЕ БанковскиеСчета.БанкДляРасчетов.Наименование
					|	КОНЕЦ КАК НаименованиеБанкаДляРасчетов,
					|	ВЫБОР
					|		КОГДА БанковскиеСчета.РучноеИзменениеРеквизитовБанкаДляРасчетов
					|			ТОГДА БанковскиеСчета.БИКБанкаДляРасчетов
					|		ИНАЧЕ БанковскиеСчета.БанкДляРасчетов.Код
					|	КОНЕЦ КАК БИКБанкаДляРасчетов,
					|	ВЫБОР
					|		КОГДА БанковскиеСчета.РучноеИзменениеРеквизитовБанкаДляРасчетов
					|			ТОГДА БанковскиеСчета.КоррСчетБанкаДляРасчетов
					|		ИНАЧЕ БанковскиеСчета.БанкДляРасчетов.КоррСчет
					|	КОНЕЦ КАК КоррСчетБанкаДляРасчетов
					|ИЗ
					|	Справочник."+ИмяСправочника+" КАК БанковскиеСчета
					|ГДЕ
					|	БанковскиеСчета.Ссылка = &Ссылка";
					ЗапросСчет.Текст = ТекстЗапроса;
	ЗапросСчет.УстановитьПараметр("Ссылка", СсылкаНаБанковскийСчет);
	Выборка = ЗапросСчет.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда 
		БанковскийСчет.Вставить("НомерСчета", Выборка.НомерСчета);
		Банк = Новый Структура;
		Банк.Вставить("Наименование", Выборка.НаименованиеБанка);
		Банк.Вставить("Код", Выборка.БИКБанка);
		Банк.Вставить("КоррСчет", Выборка.КоррСчетБанка);
		БанковскийСчет.Вставить("Банк", Банк);
		БанкДляРасчетов = Неопределено; // заполнение анализируется в модуле формирования
		Если ЗначениеЗаполнено(Выборка.БИКБанкаДляРасчетов) Тогда // используется банк для расчетов
			БанкДляРасчетов = Новый Структура;
			БанкДляРасчетов.Вставить("Наименование", Выборка.НаименованиеБанкаДляРасчетов);
			БанкДляРасчетов.Вставить("Код", Выборка.БИКБанкаДляРасчетов);
			БанкДляРасчетов.Вставить("КоррСчет", Выборка.КоррСчетБанкаДляРасчетов);
		КонецЕсли;
		БанковскийСчет.Вставить("БанкДляРасчетов", БанкДляРасчетов);
	КонецЕсли;
	Возврат БанковскийСчет;
	
КонецФункции

Функция СоздатьРасчетныйСчет(СтрокаОбъекта, ВидРС, ДеревоРазбора, СсылкаНаВладельца = Неопределено) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	СсылкаНаОбъект = Неопределено;
	НайденнаяСтрока = СтрокаОбъекта;
	
	Если ВидРС = "БанковскийСчетКонтрагента" Тогда
		НовЭл = Справочники.БанковскиеСчетаКонтрагентов.СоздатьЭлемент();
		Если (НЕ ДеревоРазбора.Строки.Найти("Контрагенты")=Неопределено) 
		   И ДеревоРазбора.Строки.Найти("Контрагенты").Строки.Количество()>0 Тогда
			СсылкаНаВладельца = ДеревоРазбора.Строки.Найти("Контрагенты").Строки[0].СсылкаНаОбъект;
		КонецЕсли;	
	ИначеЕсли ВидРС = "БанковскийСчетОрганизации" Тогда
		НовЭл = Справочники.БанковскиеСчетаОрганизаций.СоздатьЭлемент();
		НовЭл.ВариантВыводаМесяца = Перечисления.ВариантыВыводаМесяцаВДатеДокумента.Числом;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	НовЭл.НомерСчета 	= ПолучитьЗначениеРеквизитаДерева(НайденнаяСтрока, "НомерСчета");
		
	НовЭл.ВалютаДенежныхСредств = ДенежныеСредстваСерверЛокализация.ПолучитьВалютуПоНомеруСчета(НовЭл.НомерСчета);
	//
	ИндексИскомойСтроки = ПолучитьЗначениеРеквизитаДерева(НайденнаяСтрока, "Банк");
	Если ЗначениеЗаполнено(ИндексИскомойСтроки) Тогда
		НовЭл.Банк 			= НайтиОбъектВДереве(ДеревоРазбора, ИндексИскомойСтроки);
	КонецЕсли;
	//
	ИндексИскомойСтроки 	= ПолучитьЗначениеРеквизитаДерева(НайденнаяСтрока, "БанкКорреспондент");
	Если ЗначениеЗаполнено(ИндексИскомойСтроки) Тогда
		НовЭл.БанкДляРасчетов 	= НайтиОбъектВДереве(ДеревоРазбора, ИндексИскомойСтроки);
	КонецЕсли;
	//
	Если НЕ ЗначениеЗаполнено(СсылкаНаВладельца) Тогда
		СсылкаНаВладельца = ПолучитьЗначениеРеквизитаДерева(НайденнаяСтрока, "Владелец");	
	КонецЕсли;
	НовЭл.Владелец 		= СсылкаНаВладельца;
	НовЭл.Наименование 	= Прав(СокрЛП(НовЭл.НомерСчета), 4) + " в " + НовЭл.Банк.Наименование; // наименование счета
	НовЭл.ОбменДанными.Загрузка = Истина;
	Попытка
		НовЭл.Записать();
	Исключение
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Создание элемента справочника %1.'", ОбщегоНазначения.КодОсновногоЯзыка()),
					ВидРС); 
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка,,,ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));		
		ВызватьИсключение;
	КонецПопытки;
	
	СсылкаНаОбъект = НовЭл.Ссылка;
	НайденнаяСтрока.СсылкаНаОбъект = СсылкаНаОбъект; // запишем в дерево
	
	Возврат СсылкаНаОбъект;
	
КонецФункции

Процедура ДобавитьВДеревоДанныеСчета(ДеревоДокумента, ДанныеСчета) Экспорт
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДокумента, "РасчетныйСчет.НомерСчета", ДанныеСчета.НомерСчета);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДокумента, "РасчетныйСчет.Банк.Наименование", ДанныеСчета.Банк.Наименование);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДокумента, "РасчетныйСчет.Банк.БИК", ДанныеСчета.Банк.Код);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДокумента, "РасчетныйСчет.Банк.СчетКорреспондентский", ДанныеСчета.Банк.КоррСчет);
	
	Если ЗначениеЗаполнено(ДанныеСчета.БанкДляРасчетов) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДокумента, "РасчетныйСчет.БанкКорреспондент.Наименование", ДанныеСчета.БанкДляРасчетов.Наименование);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДокумента, "РасчетныйСчет.БанкКорреспондент.СчетКорреспондентский", ДанныеСчета.БанкДляРасчетов.КоррСчет);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДокумента, "РасчетныйСчет.БанкКорреспондент.БИК", ДанныеСчета.БанкДляРасчетов.Код);
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьУИП(ДеревоДокумента, УИП) Экспорт

	Если ЗначениеЗаполнено(УИП) Тогда
		ДопДанные = Новый ТаблицаЗначений;
		ДопДанные.Колонки.Добавить("Идентификатор");
		ДопДанные.Колонки.Добавить("Значение");
	
		СтрокаДопДанных = ДопДанные.Добавить();	
		СтрокаДопДанных.Идентификатор = "ИдентификаторПлатежа";
		СтрокаДопДанных.Значение = УИП;
		
		ЭлектронноеВзаимодействие.ДобавитьДопДанныеВДерево(ДеревоДокумента, ДопДанные, Истина);
	КонецЕсли;
	
КонецПроцедуры

Процедура ПриПроверкеВозможностиСозданияУчетногоДокумента(Знач Параметры, Отказ, Описание) Экспорт
	
	Если Параметры.ЭтоСводныйУПД Тогда
		
		Отказ = Истина;
		Описание = НСтр("ru = 'Отражение в учете сводных счетов-фактур не поддерживается.'");
		
	КонецЕсли;
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ПослеВозникновенииСобытияПоЭлектронномуСчетуФактуре.
Процедура ПослеВозникновенииСобытияПоЭлектронномуСчетуФактуре(ДокументыУчета, Событие, СостояниеОбработки) Экспорт
	
	ЭСФ = Неопределено;
	ИменаРеквизитов = Новый Массив();

	// Выделим счет-фактуру из документов учета
	СчетФактура = Неопределено;
	Для Каждого ДокументУчета Из ДокументыУчета Цикл
		ЭтоСчетФактура = Ложь;
		ОпределитьДокументЯвляетсяСчетомФактурой(ДокументУчета, ЭтоСчетФактура);
		Если ЭтоСчетФактура Тогда					
			СчетФактура = ДокументУчета;
		КонецЕсли;
	КонецЦикла;
	
	Если СчетФактура = Неопределено Тогда
		// Счет-фактура еще не привязан к электронному документу - прерываем обработку.
		Возврат;
	КонецЕсли;
	
	Если Событие = "ПолученПДП" Тогда
		
		// Датой выставления покупателю счета-фактуры в электронном виде по телекоммуникационным
		// каналам связи считается дата поступления файла счета-фактуры Оператору ЭДО от продавца,
		// указанная в подтверждении (ПДПЭСФ) этого Оператора ЭДО.
		// Счет-фактура в электронном виде считается выставленным, если продавцу поступило
		// соответствующее подтверждение (ПДПЭСФ) Оператора ЭДО.
		// Приказ Минфина России от 10.11.2015 N 174н.
		
		ЭСФ = СчетФактура.ПолучитьОбъект();
		//Попытка заблокировать документ
		Попытка
			ЭСФ.Заблокировать();
		Исключение
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить данные документа ""%1"".
				|Возможно, документ редактируется другим пользователем'"),
				Строка(ЭСФ.Ссылка));
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
		//конец попытки заблокировать документ
		ЭСФ.ДатаВыставления = СостояниеОбработки.ДатаПоступленияСФОператоруОтПродавца;
		ИменаРеквизитов.Добавить("ДатыВыставления");
		ЭСФ.ВыставленВЭлектронномВиде = Истина;
		ИменаРеквизитов.Добавить("ВыставленВЭлектронномВиде");
		
	ИначеЕсли Событие = "ПолученПДО" Тогда
		
		// Датой получения покупателем счета-фактуры в электронном виде по телекоммуникационным
		// каналам связи считается дата направления покупателю Оператором ЭДО файла счета-фактуры продавца,
		// указанная в подтверждении (ПДОЭСФ) Оператора ЭДО.
		// Счет-фактура в электронном виде считается полученным покупателем, если ему поступило
		// соответствующее подтверждение (ПДОЭСФ) Оператора ЭДО.
		// Приказ Минфина России от 10.11.2015 N 174н.
		
		Если ТипЗнч(СчетФактура) = Тип("ДокументСсылка.СчетФактураВыданный") Тогда
			Возврат;
		КонецЕсли;
		ЭСФ = СчетФактура.ПолучитьОбъект();
		//Попытка заблокировать документ
		Попытка
			ЭСФ.Заблокировать();
		Исключение
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить данные документа ""%1"".
				|Возможно, документ редактируется другим пользователем'"),
				Строка(ЭСФ.Ссылка));
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
		//конец попытки заблокировать документ
		ЭСФ.Дата = СостояниеОбработки.ДатаОтправкиСФПокупателюОператором;
		ИменаРеквизитов.Добавить("Дата");
		ЭСФ.ПолученВЭлектронномВиде = Истина;
		ИменаРеквизитов.Добавить("ПолученВЭлектронномВиде");
		
	ИначеЕсли Событие = "ПолученИоП" Тогда
		
		// Счет-фактура в электронном виде считается выставленным, если продавцу поступило 
		// соответствующее подтверждение (ПДПЭСФ) Оператора ЭДО, при наличии у продавца извещения покупателя 
		// о получении счета-фактуры (ИПЭСФ), подписанного ЭЦП покупателя и полученного через Оператора ЭДО.
		// ПРИКАЗ от 25 апреля 2011 г. N 50н
		
		ВыставленВЭлектронномВиде = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СчетФактура, "ВыставленВЭлектронномВиде");
		Если Не ВыставленВЭлектронномВиде Тогда
			ЭСФ = СчетФактура.ПолучитьОбъект();
			//Попытка заблокировать документ
			Попытка
				ЭСФ.Заблокировать();
			Исключение
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Не удалось изменить данные документа ""%1"".
					|Возможно, документ редактируется другим пользователем'"),
					Строка(ЭСФ.Ссылка));
				ВызватьИсключение ТекстСообщения;
			КонецПопытки;
			//конец попытки заблокировать документ			
			ЭСФ.ВыставленВЭлектронномВиде = Истина;
			ИменаРеквизитов.Добавить("ВыставленВЭлектронномВиде");
		КонецЕсли;
		
	ИначеЕсли Событие = "ПолученИоППДО" Тогда
		
		// Счет-фактура в электронном виде считается полученным покупателем, если ему поступило 
		// соответствующее подтверждение (ПДОЭСФ) Оператора ЭДО, при наличии извещения покупателя 
		// о получении счета-фактуры (ИПЭСФ), подписанного ЭЦП покупателя и подтвержденного (ПДОИПЭСФ)
		// Оператором ЭДО.  ПРИКАЗ от 25 апреля 2011 г. N 50н
		
		Если ТипЗнч(СчетФактура) = Тип("ДокументСсылка.СчетФактураВыданный") Тогда
			Возврат;
		КонецЕсли;
		
		ПолученВЭлектронномВиде = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СчетФактура, "ПолученВЭлектронномВиде");
		Если Не ПолученВЭлектронномВиде Тогда
			ЭСФ = СчетФактура.ПолучитьОбъект();
			//Попытка заблокировать документ
			Попытка
				ЭСФ.Заблокировать();
			Исключение
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Не удалось изменить данные документа ""%1"".
					|Возможно, документ редактируется другим пользователем'"),
					Строка(ЭСФ.Ссылка));
				ВызватьИсключение ТекстСообщения;
			КонецПопытки;
			//конец попытки заблокировать документ
			ЭСФ.ПолученВЭлектронномВиде = Истина;
			ИменаРеквизитов.Добавить("ПолученВЭлектронномВиде");
		КонецЕсли;
		
	КонецЕсли;
	
	Если ЭСФ = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Попытка
		РежимЗаписи = ?(ЭСФ.Проведен, РежимЗаписиДокумента.Проведение, РежимЗаписиДокумента.Запись);
		ЭСФ.ДополнительныеСвойства.Вставить("ПроверкаДокументов_Отключить", Истина);
		ЭСФ.Записать(РежимЗаписи);
	Исключение
		
		Если ИменаРеквизитов.Количество() > 1 Тогда
			ШаблонОшибки = НСтр("ru = 'При установке реквизитов %1 документа %2 возникла ошибка. Описание ошибки: ""%3""'");
		Иначе
			ШаблонОшибки = НСтр("ru = 'При установке реквизита %1 документа %2 возникла ошибка. Описание ошибки: ""%3""'")
		КонецЕсли;
		
		ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			ШаблонОшибки, 
			СтрСоединить(ИменаРеквизитов),
			ЭСФ.Ссылка,
			ИнформацияОбОшибке().Описание);
		
		ЗаписьЖурналаРегистрации(
			НСтр("ru = 'Ошибка установки реквизитов счета-фактуры при получении служебного ЭД от оператора'", 
			ОбщегоНазначения.КодОсновногоЯзыка()),
			УровеньЖурналаРегистрации.Ошибка,
			ЭСФ.Метаданные(),
			ЭСФ.Ссылка,
			ТекстОшибки);
		
	КонецПопытки;
	
КонецПроцедуры

Процедура ПриОпределенииВариантовЗаполненияПолейЭлектронныхДокументов(ВариантыЗаполненияПолей) Экспорт
	
	ВариантКодУПД = ВариантыЗаполненияПолей.УПД_ТоварКод.НайтиПоЗначению("Код");
	ВариантКодУПД.Представление = "Артикул";
	ВариантКодПередачаТоваров = ВариантыЗаполненияПолей.ПередачаТоваров_ТоварКод.НайтиПоЗначению("Код");
	ВариантКодПередачаТоваров.Представление = "Артикул";
	
КонецПроцедуры

Процедура ПолучитьЗапросКонструктораДополнительныхПолейШапки(Параметры, ТекстЗапроса) Экспорт
	
	ТипыДокументов = ОбменСКонтрагентами.ТипыДокументов();
	
	Если Параметры.ТипДокумента = ТипыДокументов.УПД
		ИЛИ Параметры.ТипДокумента = ТипыДокументов.УКД Тогда
		
		ТекстЗапроса = ЗапросКонструктораДополнительныхПолейШапкиУПД();
	
	ИначеЕсли Параметры.ТипДокумента = ТипыДокументов.СчетФактура
		ИЛИ Параметры.ТипДокумента = ТипыДокументов.КорректировочныйСчетФактура Тогда
		
		ТекстЗапроса = ЗапросКонструктораДополнительныхПолейШапкиСчетаФактуры();
		
	ИначеЕсли Параметры.ТипДокумента = ТипыДокументов.ТоварнаяНакладная
		ИЛИ Параметры.ТипДокумента = ТипыДокументов.АктНаПередачуПрав Тогда
		
		ТекстЗапроса = ЗапросКонструктораДополнительныхПолейШапкиРеализации();
		
	ИначеЕсли Параметры.ТипДокумента = ТипыДокументов.АктВыполненныхРабот Тогда
		
		ТекстЗапроса = ЗапросКонструктораДополнительныхПолейШапкиАкта();
		
	ИначеЕсли Параметры.ТипДокумента = ТипыДокументов.СоглашениеОбИзмененииСтоимости Тогда
		
		ТекстЗапроса = ЗапросКонструктораДополнительныхПолейШапкиКорректировкиРеализации();
		
	ИначеЕсли Параметры.ТипДокумента = ТипыДокументов.СведенияОРеализацииКомиссионером Тогда
		
		ТекстЗапроса = ЗапросКонструктораДополнительныхПолейШапкиСведенийОРеализацииКомиссионером();
		
	КонецЕсли;
	
КонецПроцедуры

Функция ДанныеДляЗаполнения(НоменклатураКонтрагента) Экспорт
	
	СтавкаНДС = Справочники.СтавкиНДС.ПустаяСсылка();
	РаботаСНоменклатуройУТ.ПреобразоватьСтавкуНДССервиса(НоменклатураКонтрагента.СтавкаНДС, СтавкаНДС);
			
	СсылкаНаЕдиницуИзмерения = Справочники.УпаковкиЕдиницыИзмерения.ПустаяСсылка();
	ЕдиницыИзмеренияКонтрагента = Новый Структура;
	ЕдиницыИзмеренияКонтрагента.Вставить("ОКЕИ", НоменклатураКонтрагента.ЕдиницаИзмеренияКод);
	ЕдиницыИзмеренияКонтрагента.Вставить("Наименование", НоменклатураКонтрагента.ЕдиницаИзмерения);
	РаботаСНоменклатуройУТ.ЕдиницаИзмеренияПоДаннымСервиса(ЕдиницыИзмеренияКонтрагента, СсылкаНаЕдиницуИзмерения);
	
	ДанныеЗаполнения = Новый Структура;
	ДанныеЗаполнения.Вставить("Артикул", НоменклатураКонтрагента.Артикул);
	ДанныеЗаполнения.Вставить("Наименование", НоменклатураКонтрагента.Наименование);
	ДанныеЗаполнения.Вставить("НаименованиеПолное", НоменклатураКонтрагента.Наименование);
	ДанныеЗаполнения.Вставить("ЕдиницаИзмерения", СсылкаНаЕдиницуИзмерения);
	ДанныеЗаполнения.Вставить("СтавкаНДС", СтавкаНДС);
	
	Возврат ДанныеЗаполнения;

КонецФункции

// См. ОбменСКонтрагентамиПереопределяемый.ПолучитьОтветственногоПоЭД.
Процедура ПолучитьОтветственногоПоЭД(Контрагент, Организация, ДоговорКонтрагента, ОтветственныйПоЭД) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	ОтветственныйПоЭД = Справочники.Пользователи.ПустаяСсылка();
	Если ТипЗнч(Контрагент) = Тип("СправочникСсылка.Контрагенты") И ЗначениеЗаполнено(Контрагент.Партнер) Тогда
		Если Контрагент.Партнер.Метаданные().Реквизиты.Найти("ОсновнойМенеджер")<> Неопределено 
			И ЗначениеЗаполнено(Контрагент.Партнер.ОсновнойМенеджер) Тогда 
			ОтветственныйПоЭД = Контрагент.Партнер.ОсновнойМенеджер;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.СведенияФизЛицаПользователя
Процедура СведенияФизЛицаПользователя(Пользователь, Организация, ДанныеФизЛица) Экспорт

	Если ТипЗнч(Пользователь) = Тип("СправочникСсылка.Пользователи") Тогда
		ФизЛицо = Пользователь.ФизическоеЛицо;
		Если Не ЗначениеЗаполнено(ДанныеФизЛица.ИмяПолное) Тогда
			ДанныеФизЛица.ИмяПолное = ФизЛицо.Наименование;	
		КонецЕсли;
		ДанныеФизЛица.Должность = "";
		
		
		Если Не ЗначениеЗаполнено(ДанныеФизЛица.Должность) Тогда
			РеквизитыВладельцаСертификата = Обработки.ЗаявлениеНаВыпускНовогоКвалифицированногоСертификата.РеквизитыВладельцаСертификата(Неопределено);
			Реквизиты = Новый Структура(СтрСоединить(РеквизитыВладельцаСертификата.ВыгрузитьЗначения(), ","));		
			Реквизиты.Вставить("Директор");
			Реквизиты.Вставить("ГлавныйБухгалтер");
			Реквизиты.Вставить("Пользователь");
			Реквизиты.Вставить("ЭтоФизическоеЛицо", Истина);
			Реквизиты.Вставить("Организация", Организация);
			Реквизиты.Вставить("Сотрудник",   ФизЛицо);
			Реквизиты.Вставить("ТипВладельца");
			Реквизиты.Вставить("ИНН");
			
			ЗаявлениеНаСертификатПереопределяемый.ПриЗаполненииРеквизитовВладельцаВЗаявленииНаСертификат(Реквизиты);
			
			Если ЗначениеЗаполнено(Реквизиты.Должность) Тогда 
				ДанныеФизЛица.Должность = Реквизиты.Должность;
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли ТипЗнч(Пользователь) = Тип("СправочникСсылка.Партнеры") Тогда	
		КонтактноеЛицо = ПартнерыИКонтрагенты.ПолучитьКонтактноеЛицоПартнераПоУмолчанию(Пользователь);
		ДанныеФизЛица.ИмяПолное = КонтактноеЛицо.Наименование;
		ДанныеФизЛица.Должность = КонтактноеЛицо.ДолжностьПоВизитке;
	ИначеЕсли ТипЗнч(Пользователь) = Тип("СправочникСсылка.КонтактныеЛицаПартнеров") Тогда	
		ДанныеФизЛица.ИмяПолное = Пользователь.Наименование;
		ДанныеФизЛица.Должность = Пользователь.ДолжностьПоВизитке;		
	КонецЕсли;
	
КонецПроцедуры

// Определяет вид ЭД по полному имени объекта метаданных.
//
// Параметры:
//  ПолноеИмяОбъектаМетаданных - Строка - имя объекта метаданных.
//
// Возвращаемое значение:
//  Массив - массив из видов ЭД доступных для данного объекта метаданных.
//
Функция ВидыЭДПоИмениОбъекта(ПолноеИмяОбъектаМетаданных) Экспорт
	
	ТипыДокументов = ОбменСКонтрагентами.ТипыДокументов();
	
	ТекстСообщенияОбОшибке = НСтр("ru = 'Не удалось определить вид документа'");
	
	МетаданныеОбъекта = Метаданные.НайтиПоПолномуИмени(ПолноеИмяОбъектаМетаданных);
	
	Если МетаданныеОбъекта = Неопределено Тогда
		ВызватьИсключение ТекстСообщенияОбОшибке;
	КонецЕсли;
	
	Результат = Новый Массив;
		
	Если МетаданныеОбъекта = Метаданные.Документы.ПриобретениеТоваровУслуг Тогда
		
		Результат.Добавить(ТипыДокументов.АктНаПередачуПрав);
		Результат.Добавить(ТипыДокументов.ТоварнаяНакладная);

	ИначеЕсли МетаданныеОбъекта = Метаданные.Документы.КорректировкаПриобретения Тогда
		
		Результат.Добавить(ТипыДокументов.СоглашениеОбИзмененииСтоимости);
		
	ИначеЕсли МетаданныеОбъекта = Метаданные.Документы.ПриобретениеУслугПрочихАктивов Тогда
		
		Результат.Добавить(ТипыДокументов.АктВыполненныхРабот);
	
	ИначеЕсли МетаданныеОбъекта = Метаданные.Документы.ВозвратТоваровОтКлиента Тогда
		
		Результат.Добавить(ТипыДокументов.ТоварнаяНакладная);
	
	ИначеЕсли МетаданныеОбъекта = Метаданные.РегистрыСведений.РеестрДокументов Тогда	
		
		Результат.Добавить(ТипыДокументов.АктНаПередачуПрав);
		Результат.Добавить(ТипыДокументов.ТоварнаяНакладная);
		Результат.Добавить(ТипыДокументов.СоглашениеОбИзмененииСтоимости);
		
	ИначеЕсли МетаданныеОбъекта = Метаданные.Документы.ЗаказКлиента Тогда
		
		Результат.Добавить(ТипыДокументов.ЗаказТовара);
		
	ИначеЕсли МетаданныеОбъекта = Метаданные.Документы.ЗаказПоставщику Тогда	
		
		Результат.Добавить(ТипыДокументов.ОтветНаЗаказ);
		
	ИначеЕсли МетаданныеОбъекта = Метаданные.Документы.ЗаявкаНаРасходованиеДенежныхСредств Тогда		
		
		Результат.Добавить(ТипыДокументов.СчетНаОплату);
	
	ИначеЕсли МетаданныеОбъекта = Метаданные.Документы.РегистрацияЦенНоменклатурыПоставщика Тогда		
		
		Результат.Добавить(ТипыДокументов.ПрайсЛист);
				
	ИначеЕсли МетаданныеОбъекта = Метаданные.Документы.ОтчетКомиссионера Тогда	
		
		Результат.Добавить(ТипыДокументов.ОтчетОПродажахКомиссионногоТовара);
				
	ИначеЕсли МетаданныеОбъекта = Метаданные.Документы.ОтчетКомиссионераОСписании Тогда	
		
		Результат.Добавить(ТипыДокументов.ОтчетОСписанииКомиссионногоТовара);
		
	ИначеЕсли МетаданныеОбъекта = Метаданные.Документы.ПередачаТоваровМеждуОрганизациями
		Или МетаданныеОбъекта = Метаданные.Документы.ВозвратТоваровМеждуОрганизациями Тогда
		
		Результат.Добавить(ТипыДокументов.ТоварнаяНакладная);
		
	Иначе
		ВызватьИсключение ТекстСообщенияОбОшибке;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// См. ОбменСКонтрагентамиПереопределяемый.ОпределитьДокументЯвляетсяСчетомФактурой.
Процедура ОпределитьДокументЯвляетсяСчетомФактурой(ДокументСсылка, Результат) Экспорт
	
	ТипДокумента = ТипЗнч(ДокументСсылка);
	Если ТипДокумента = Тип("ДокументСсылка.СчетФактураВыданный")
			ИЛИ ТипДокумента = Тип("ДокументСсылка.СчетФактураПолученный")
			ИЛИ ТипДокумента = Тип("ДокументСсылка.СчетФактураПолученныйНалоговыйАгент")
			ИЛИ ТипДокумента = Тип("ДокументСсылка.СчетФактураВыданныйАванс")
			ИЛИ ТипДокумента = Тип("ДокументСсылка.СчетФактураПолученныйАванс")
			ИЛИ ТипДокумента = Тип("ДокументСсылка.СчетФактураКомиссионеру")
			ИЛИ ТипДокумента = Тип("ДокументСсылка.СчетФактураКомитента")
		Тогда
		
		Результат = Истина;
	Иначе
		Результат = Ложь;
	КонецЕсли;
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ПриПолученииОписанияОснованияЭлектронногоДокумента.
Процедура ПриПолученииОписанияОснованияЭлектронногоДокумента(ОснованиеОбъект, Описание, СтандартнаяОбработка) Экспорт
	
	ТипОснования = ТипЗнч(ОснованиеОбъект);
	Если ТипОснования = Тип("ДокументОбъект.СчетФактураКомиссионеру") 
		Или ТипОснования = Тип("ДокументСсылка.СчетФактураКомиссионеру") Тогда
		СтандартнаяОбработка = Ложь;
		Описание.Организация = ОснованиеОбъект.Организация;
		Описание.Контрагент  = ОснованиеОбъект.Комиссионер;
		Описание.Дата  = ОснованиеОбъект.Дата;
		Описание.Номер = ОснованиеОбъект.Номер;
	КонецЕсли;
	Если ТипОснования = Тип("ДокументОбъект.СчетФактураКомитента") 
		Или ТипОснования = Тип("ДокументСсылка.СчетФактураКомитента") Тогда
		СтандартнаяОбработка = Ложь;
		Описание.Организация = ОснованиеОбъект.Организация;
		Описание.Контрагент  = ОснованиеОбъект.Комитент;
		Описание.Дата  = ОснованиеОбъект.Дата;
		Описание.Номер = ОснованиеОбъект.Номер;
	КонецЕсли;
	Если ТипОснования = Тип("СправочникОбъект.ДоговорыКонтрагентов") 
		Или ТипОснования = Тип("СправочникСсылка.ДоговорыКонтрагентов") Тогда		
		СтандартнаяОбработка = Ложь;		
		Описание.Организация = ОснованиеОбъект.Организация;
		Описание.Контрагент  = ОснованиеОбъект.Контрагент;
		Описание.Дата = ОснованиеОбъект.Дата;
		Описание.Номер = ОснованиеОбъект.Номер;	
		Описание.СуммаДокумента = ОснованиеОбъект.Сумма;		
	КонецЕсли;
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.СсылкаНаОбъектПоИННКПП.
Процедура СсылкаНаОбъектПоИННКПП(ТипОбъекта, ИНН, КПП, Ссылка, ДатаСведений = Неопределено) Экспорт
	
	Ссылка = Неопределено;
	
	Запрос = Новый Запрос;
	УсловиеПоКПП = "ИСТИНА";
	Если ТипОбъекта = "Контрагенты" И ЗначениеЗаполнено(ДатаСведений) Тогда
		Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ 
		|	Контрагенты.Ссылка КАК Ссылка
		|ИЗ
		|	Справочник.Контрагенты.ИсторияКПП КАК Контрагенты
		|ГДЕ
		|	Контрагенты.Ссылка.ИНН = &ИНН
		|	И &УсловиеПоКПП
		|	И Контрагенты.Период <= &ДатаСведений
		|	И Контрагенты.Ссылка.ЮрФизЛицо <> &ФизЛицо
        |
		|ОБЪЕДИНИТЬ ВСЕ
        |
		|ВЫБРАТЬ
		|	Контрагенты.Ссылка
		|ИЗ
		|	Справочник.Контрагенты КАК Контрагенты
		|ГДЕ
		|	Контрагенты.ИНН = &ИНН
		|	И &УсловиеПоКПП
		|	И Контрагенты.ЮрФизЛицо <> &ФизЛицо
		|	И НЕ Контрагенты.ПометкаУдаления";
		Запрос.УстановитьПараметр("ДатаСведений", ДатаСведений);
		Если ЗначениеЗаполнено(КПП) Тогда
			Запрос.УстановитьПараметр("КПП", КПП);
			УсловиеПоКПП = "Контрагенты.КПП = &КПП";
		КонецЕсли;
	Иначе
		Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
		|	Выборка.Ссылка
		|ИЗ
		|	Справочник." + ТипОбъекта + " КАК Выборка
		|ГДЕ
		|	Выборка.ИНН = &ИНН 
		|	И &УсловиеПоКПП
		|	И Выборка.ЮрФизЛицо <> &ФизЛицо
		|	И НЕ Выборка.ПометкаУдаления";
		Если ЗначениеЗаполнено(КПП) Тогда
			Запрос.УстановитьПараметр("КПП", КПП);
			УсловиеПоКПП = "Выборка.КПП = &КПП";
		КонецЕсли;
	КонецЕсли;
	Запрос.УстановитьПараметр("ИНН", ИНН);
	Запрос.УстановитьПараметр("ФизЛицо", Перечисления.ЮрФизЛицо.ФизЛицо);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеПоКПП", УсловиеПоКПП);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Ссылка = Выборка.Ссылка;
	КонецЕсли;
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьРеквизитыКонтрагента.
Процедура ЗаполнитьРеквизитыКонтрагента(СтруктураРеквизитов, КонтрагентСсылка) Экспорт
	
	КонтрагентСсылка = Неопределено;
	Партнер   = Неопределено;
	
	Если ЗначениеЗаполнено(СтруктураРеквизитов.Контрагент) Тогда
		Контрагент = СтруктураРеквизитов.Контрагент.ПолучитьОбъект();
		Попытка 
			Контрагент.Заблокировать();
		Исключение
			ТекстИсключенияЗаписи = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Не удалось изменить контрагента ""%1"".
			|Возможно, контрагент редактируется другим пользователем'"),
			Контрагент.Наименование);			
			ВызватьИсключение ТекстИсключенияЗаписи;
		КонецПопытки;	
	Иначе
		Контрагент = Справочники.Контрагенты.СоздатьЭлемент();
	КонецЕсли;
	
	Контрагент.Наименование = СтруктураРеквизитов.Наименование;
	ИНН_КПП        = СтруктураРеквизитов.ИНН_КПП;
	Контрагент.ИНН = Сред(ИНН_КПП, 1, Найти(ИНН_КПП, "/") - 1);
	Контрагент.КПП = Сред(ИНН_КПП, Найти(ИНН_КПП, "/") + 1);
	
	Если ПолучитьФункциональнуюОпцию("ИспользоватьПартнеровИКонтрагентов") Тогда
		// Заполним реквизиты партнера
		
		Если Контрагент.ЭтоНовый() Тогда
			Партнер = Справочники.Партнеры.СоздатьЭлемент();
			СсылкаНовогоПартнера = Справочники.Партнеры.ПолучитьСсылку();
			Партнер.УстановитьСсылкуНового(СсылкаНовогоПартнера);
			Контрагент.Партнер = СсылкаНовогоПартнера;
		Иначе
			Партнер = Контрагент.Партнер.ПолучитьОбъект();
			Попытка 
				Партнер.Заблокировать();
			Исключение
				ТекстИсключенияЗаписи = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить партнера ""%1"".
				|Возможно, партнер редактируется другим пользователем'"),
				Партнер.Наименование);			
				ВызватьИсключение ТекстИсключенияЗаписи;
			КонецПопытки;			
		КонецЕсли;
		
		Партнер.Наименование = Контрагент.Наименование;
		
	КонецЕсли;
	
	НачатьТранзакцию();
	Попытка
		Контрагент.Записать();
		Контрагент.Разблокировать();
		Если Партнер <> Неопределено Тогда
			Партнер.Записать();
			Партнер.Разблокировать();			
		КонецЕсли;
		КонтрагентСсылка = Контрагент.Ссылка;		
		ЗафиксироватьТранзакцию();
	Исключение
		ОтменитьТранзакцию();
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке()) + " (" + НСтр("ru = 'подробности см. в Журнале регистрации'") + ").";
		ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействие.ОбработатьОшибку(НСтр("ru = 'Загрузка реквизитов контрагента'"), ТекстОшибки, ТекстСообщения);
	КонецПопытки;
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ПолучитьРеквизитыОрганизацииДляВыгрузкиВФайл.
Процедура ПолучитьРеквизитыОрганизацииДляВыгрузкиВФайл(Организация, СтруктураВозврата) Экспорт
	
	РеквизитыОрганизации = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Организация, 
		"Наименование, НаименованиеПолное, ИНН, КПП, КодПоОКПО, ЮрФизЛицо, СвидетельствоСерияНомер, СвидетельствоДатаВыдачи");
	ЗаполнитьЗначенияСвойств(СтруктураВозврата, РеквизитыОрганизации);
	СтруктураВозврата.ОКПО = РеквизитыОрганизации.КодПоОКПО;
	
	ЮрАдресОрганизации = ПолучитьАдресИзКонтактнойИнформации(Организация, "Юр");
	СтруктураВозврата.ЮридическийАдрес     = ЮрАдресОрганизации.Представление;
	СтруктураВозврата.ЗначенияПолейЮрАдрес = ЮрАдресОрганизации.ЗначенияПолей;
	
	ФактАдресОрганизации = ПолучитьАдресИзКонтактнойИнформации(Организация, "Факт");
	СтруктураВозврата.ФактическийАдрес       = ФактАдресОрганизации.Представление;
	СтруктураВозврата.ЗначенияПолейФактАдрес = ФактАдресОрганизации.ЗначенияПолей;
	
	СтруктураВозврата.Телефон = ПолучитьТелефонИзКонтактнойИнформации(Организация);
	
	Если СтруктураВозврата.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ЮрЛицо Тогда
		СтруктураОтветственных = ОтветственныеЛицаСервер.ПолучитьОтветственныеЛицаОрганизации(Организация);
		СтруктураВозврата.Руководитель          = СтруктураОтветственных.Руководитель;
		СтруктураВозврата.ДолжностьРуководителя = СтруктураОтветственных.РуководительДолжность;
	Иначе
		СтруктураВозврата.СвидетельствоНомер = РеквизитыОрганизации.СвидетельствоСерияНомер;
		СтруктураВозврата.СвидетельствоДата  = РеквизитыОрганизации.СвидетельствоДатаВыдачи;
	КонецЕсли;
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьРегистрационныеДанныеОрганизации.
Процедура ЗаполнитьРегистрационныеДанныеОрганизации(Организация, ДанныеОрганизации) Экспорт
	
	Если ЗначениеЗаполнено(Организация) Тогда 
		Подключение1СТакскомПереопределяемый.ЗаполнитьРегистрационныеДанныеОрганизации(Организация, ДанныеОрганизации);
	КонецЕсли;
	
	РуководительДолжность = ОтветственныеЛицаСервер.ПолучитьДанныеОтветственногоЛица(
		Организация,, Перечисления.ОтветственныеЛицаОрганизаций.Руководитель).Должность;
	Если ЗначениеЗаполнено(РуководительДолжность) Тогда
		ДанныеОрганизации.Вставить("Должность", РуководительДолжность);
	Иначе
		ДанныеОрганизации.Вставить("Должность", "");
	КонецЕсли;
	ДанныеОрганизации.Вставить("КодРегиона", "");
	
	ДатаАдреса = ТекущаяДатаСеанса();
	ЮрАдресОрганизации = ПолучитьАдресИзКонтактнойИнформации(Организация, "Юр", ДатаАдреса);
	
	Если ЗначениеЗаполнено(ЮрАдресОрганизации.ЗначенияПолей) Тогда
		АдресСтруктурой = РаботаСАдресами.СведенияОбАдресе(ЮрАдресОрганизации.ЗначенияПолей);
		Если АдресСтруктурой.Свойство("Индекс") Тогда
			ДанныеОрганизации.Индекс = АдресСтруктурой.Индекс;
		КонецЕсли;
		Если АдресСтруктурой.Свойство("Регион") Тогда
			ДанныеОрганизации.Регион = АдресСтруктурой.Регион;
		КонецЕсли;
		Если АдресСтруктурой.Свойство("КодРегиона") Тогда
			ДанныеОрганизации.КодРегиона = АдресСтруктурой.КодРегиона;
		КонецЕсли;
		Если АдресСтруктурой.Свойство("Район") Тогда
			ДанныеОрганизации.Район = АдресСтруктурой.Район;
		КонецЕсли;
		Если АдресСтруктурой.Свойство("Город") Тогда
			ДанныеОрганизации.Город = АдресСтруктурой.Город;
		КонецЕсли;
		Если АдресСтруктурой.Свойство("НаселенныйПункт") Тогда
			ДанныеОрганизации.НаселенныйПункт = АдресСтруктурой.НаселенныйПункт;
		КонецЕсли;
		Если АдресСтруктурой.Свойство("Улица") Тогда
			ДанныеОрганизации.Улица = АдресСтруктурой.Улица;
		КонецЕсли;
		Если АдресСтруктурой.Свойство("Здание") И ЗначениеЗаполнено(АдресСтруктурой.Здание) Тогда
			ДанныеОрганизации.Дом = АдресСтруктурой.Здание.Номер;
		КонецЕсли;
		Если АдресСтруктурой.Свойство("Корпуса") И ЗначениеЗаполнено(АдресСтруктурой.Корпуса) Тогда
			ДанныеОрганизации.Корпус = АдресСтруктурой.Корпуса[0].Номер;
		КонецЕсли;
		Если АдресСтруктурой.Свойство("Помещения") И ЗначениеЗаполнено(АдресСтруктурой.Помещения) Тогда
			ДанныеОрганизации.Квартира = АдресСтруктурой.Помещения[0].Номер;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ДанныеСвидетельстваОРегистрацииИП.
Процедура ДанныеСвидетельстваОРегистрацииИП(ИП, Сведения) Экспорт
	
	РеквизитыСвидетельства = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ИП, "СвидетельствоДатаВыдачи, СвидетельствоСерияНомер");
	ШаблонДанныхСвидетельства = НСтр("ru = 'Свидетельство %1 от %2'");
	
	Сведения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонДанныхСвидетельства, 
		РеквизитыСвидетельства.СвидетельствоСерияНомер,
		Формат(РеквизитыСвидетельства.СвидетельствоДатаВыдачи, "ДЛФ=D"));
	
КонецПроцедуры

#Область УПД_2019

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеУПД2019_ИнформацияПродавца.
Процедура ЗаполнитьДанныеУПД2019_ИнформацияПродавца(Основание, Настройки, Данные, Описание, Отказ) Экспорт
	
	Если ТипЗнч(Основание) = Тип("ДокументСсылка.СчетФактураВыданный") Тогда
		ТипОснования = ТипЗнч(ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Основание, "ДокументОснование"));
		Если ТипОснования = Тип("ДокументСсылка.ПервичныйДокумент") Тогда
			ТекстСообщения = НСтр("ru='Действие недоступно для счета-фактуры, введенного на основании ""Первичного документа"".'");
			ОбщегоНазначения.СообщитьПользователю(ТекстСообщения,,,,Отказ);
			Возврат;
		ИначеЕсли ТипОснования = Тип("ДокументСсылка.ОтчетПоКомиссииМеждуОрганизациями") Тогда
			ТекстСообщения = НСтр("ru='Действие недоступно для счета-фактуры, введенного на основании ""Отчета по комиссии между организациями"".'");
			ОбщегоНазначения.СообщитьПользователю(ТекстСообщения,,,,Отказ);
			Возврат;
		КонецЕсли;
	ИначеЕсли ТипЗнч(Основание) = Тип("ДокументСсылка.СчетФактураКомиссионеру")
		И ТипЗнч(ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Основание, "ДокументОснование")) = Тип("ДокументСсылка.ОтчетПоКомиссииМеждуОрганизациями") Тогда
		ТекстСообщения = НСтр("ru='Действие недоступно для счета-фактуры, введенного на основании ""Отчета по комиссии между организациями"".'");
		ОбщегоНазначения.СообщитьПользователю(ТекстСообщения,,,,Отказ);
		Возврат;
	КонецЕсли;
	
	ВсеВидыДокументов = ОбменСКонтрагентами.ТипыДокументов();
	ТипДокумента = Настройки.ТипДокумента;
	ОписаниеЗамера = Неопределено;
	КоличествоЗаписей = 1;
	
	СтруктураЭД = ОбщегоНазначения.СкопироватьРекурсивно(Настройки, Ложь);

	Если ТипДокумента = ВсеВидыДокументов.УПД Тогда		
		СтруктураЭД.Вставить("Функция", "СЧФДОП");		
	ИначеЕсли ТипДокумента = ВсеВидыДокументов.СчетФактура Тогда		
		СтруктураЭД.Вставить("Функция", "СЧФ");		
	ИначеЕсли ТипДокумента = ВсеВидыДокументов.СведенияОРеализацииКомиссионером Тогда
		СтруктураЭД.Вставить("Функция", "СвРК");
		ОписаниеЗамера = ОценкаПроизводительности.НачатьЗамерДлительнойОперации(
			"ОбщийМодуль.ОбменСКонтрагентамиУТ.ЗаполнитьСведенияОРеализацииКомиссионером");
	ИначеЕсли ТипДокумента = ВсеВидыДокументов.СведенияОЗакупкеКомиссионером Тогда
		СтруктураЭД.Вставить("Функция", "СвЗК");
		ОписаниеЗамера = ОценкаПроизводительности.НачатьЗамерДлительнойОперации(
			"ОбщийМодуль.ОбменСКонтрагентамиУТ.ЗаполнитьДанныеСведенияОЗакупкеКомиссионером");
	ИначеЕсли ТипЗнч(Основание) = Тип("ДокументСсылка.ВозвратТоваровМеждуОрганизациями") Тогда
		СтруктураЭД.Вставить("Функция", "ДОП");
		ОписаниеЗамера = ОценкаПроизводительности.НачатьЗамерДлительнойОперации(
			"ОбщийМодуль.ОбменСКонтрагентамиУТ.ЗаполнитьДанныеИнтеркампаниВозвратДОП");
	Иначе		
		СтруктураЭД.Вставить("Функция", "ДОП");		
	КонецЕсли;
	
	Если ТипЗнч(Основание) = Тип("ДокументСсылка.ПередачаТоваровМеждуОрганизациями") Тогда
		Если СтруктураЭД.Функция = "СЧФДОП" Тогда
		ОписаниеЗамера = ОценкаПроизводительности.НачатьЗамерДлительнойОперации(
			"ОбщийМодуль.ОбменСКонтрагентамиУТ.ЗаполнитьДанныеИнтеркампаниСЧФДОП");
		ИначеЕсли СтруктураЭД.Функция = "ДОП" Тогда
		ОписаниеЗамера = ОценкаПроизводительности.НачатьЗамерДлительнойОперации(
			"ОбщийМодуль.ОбменСКонтрагентамиУТ.ЗаполнитьДанныеИнтеркампаниПередачаДОП");
		КонецЕсли;
	КонецЕсли;
	
	Если СтруктураЭД.Функция = "СЧФДОП" И (ТипЗнч(Основание) = Тип("ДокументСсылка.ОтчетКомитенту")
		Или ТипЗнч(Основание) = Тип("ДокументСсылка.ОтчетКомитентуОЗакупках")) 
		И Основание.СтавкаНДСВознаграждения <> Справочники.СтавкиНДС.БезНДС Тогда
		СтруктураЭД.Функция = "СЧФДОП";
	ИначеЕсли ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(Основание, "НалогообложениеНДС") 
										и ТипЗнч(Основание) <> Тип("ДокументСсылка.СчетФактураВыданный") Тогда
		ТипыБезНДС = Перечисления.ТипыНалогообложенияНДС.ТипыБезНДС();
		Если ТипыБезНДС.Найти(Основание.НалогообложениеНДС) <> Неопределено И СтруктураЭД.Функция = "СЧФДОП" Тогда
			СтруктураЭД.Функция = "ДОП";
		КонецЕсли;
	КонецЕсли;
	
	Если ТипЗнч(Основание) = Тип("ДокументСсылка.ВозвратТоваровПоставщику")  И СтруктураЭД.Функция = "СЧФДОП" Тогда
		СтруктураЭД.Функция = "ДОП";
	КонецЕсли;

	ДокОснование = Основание; 
	Если СтруктураЭД.Функция <> "ДОП"
		И СтруктураЭД.Функция <> "СвРК"
		И СтруктураЭД.Функция <> "СвЗК" Тогда
		Если ТипЗнч(Основание) = Тип("ДокументСсылка.СчетФактураВыданный") 
				ИЛИ ТипЗнч(Основание) = Тип("ДокументСсылка.СчетФактураКомиссионеру") 
				ИЛИ ТипЗнч(Основание) = Тип("ДокументСсылка.СчетФактураВыданныйАванс") Тогда
			СчетФактура = Основание;
			ДокОснование = СчетФактура.ДокументОснование;
		Иначе
			МассивОбъектов = Новый Массив;
			МассивОбъектов.Добавить(Основание);
			РезультатАнализа = Документы.СчетФактураВыданный.ПолучитьСчетаФактурыНаПечать(МассивОбъектов);
			МассивСчетовФактур = РезультатАнализа.СчетаФактурыНаПечать;
			Если МассивСчетовФактур.Количество() = 0 Тогда
				НоваяСчетФактура = Документы.СчетФактураВыданный.СоздатьДокумент();
				СтрокаОснований = НоваяСчетфактура.ДокументыОснования.Добавить();
				
				НоваяСчетФактура.ДокументОснование 	= Основание;
				СтрокаОснований.ДокументОснование 	= Основание;
				НоваяСчетФактура.КодВидаОперации = 
					Документы.СчетФактураВыданный.КодВидаОперации(НоваяСчетфактура.ДокументыОснования, 
							НоваяСчетфактура.Покупатели, НоваяСчетфактура.Дата, Основание);
				НоваяСчетФактура.Дата 				= ТекущаяДатаСеанса();
				НоваяСчетФактура.ДатаВыставления 	= ТекущаяДатаСеанса();
				НоваяСчетФактура.ЗаполнитьПараметрыСчетаФактурыПоОснованию(Основание);
				НоваяСчетФактура.УстановитьНовыйНомер();
				НоваяСчетФактура.Записать(РежимЗаписиДокумента.Проведение);
				МассивСчетовФактур.Добавить(НоваяСчетФактура.Ссылка);
				
				//Запись в Реестр документов
				ТаблицыДанных = ПроведениеДокументов.ДанныеДокументаДляПроведения(НоваяСчетФактура.Ссылка, "РеестрДокументов");
				РегистрыСведений.РеестрДокументов.ЗаписатьДанные(ТаблицыДанных, НоваяСчетФактура.Ссылка,  Неопределено, Ложь);
			КонецЕсли;
			СчетФактура = МассивСчетовФактур[0];
		КонецЕсли;
		
		МассивОбъектов = Новый Массив;
		МассивОбъектов.Добавить(СчетФактура);
		ПараметрыПечати = Новый Структура();
		ПараметрыПечати.Вставить("ЗаполнениеЭлектронногоДокумента");
		
		Если ТипЗнч(Основание) = Тип("ДокументСсылка.СчетФактураВыданныйАванс") Тогда
			СтруктураДанных = СчетФактураВыданныйАвансЛокализация.ПолучитьДанныеДляПечатнойФормыСчетФактура(ПараметрыПечати, МассивОбъектов);
		Иначе
			СтруктураДанных = Документы[СчетФактура.Метаданные().Имя].ПолучитьДанныеДляПечатнойФормыУПД(ПараметрыПечати, МассивОбъектов);
		КонецЕсли;
		
		ЗаполнитьДанныеСчетаФактурыУПД_2019(СтруктураДанных, СтруктураЭД, Данные, Отказ);
		ЗаполнитьДанныеПервичногоДокументаУПД_2019(СтруктураДанных, СтруктураЭД, Данные, Настройки, Отказ, КоличествоЗаписей);
	Иначе
		ЗаполнитьДанныеДляДОПИнформацияПродавцаФНС_2019(Основание, Настройки, СтруктураЭД, Данные, Отказ, КоличествоЗаписей);
	КонецЕсли;

	ФункцияУПД = СтруктураЭД.Функция;	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "Функция", ФункцияУПД);

	ПередаточныеДокументы = Новый Массив;
	ПередаточныеДокументы.Добавить(ДокОснование);

	Если ФункцияУПД = "СЧФДОП" Тогда
		
		Если Основание = СчетФактура Тогда
			ОбщегоНазначенияКлиентСервер.ДополнитьМассив(Описание.Основания, ПередаточныеДокументы);
		Иначе
			Описание.Основания.Добавить(СчетФактура);
		КонецЕсли;
		
	КонецЕсли;	

	Если ОписаниеЗамера <> Неопределено Тогда
		ОценкаПроизводительности.ЗакончитьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоЗаписей);
	КонецЕсли;
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеУПД2019_ИнформацияПокупателя.
Процедура ЗаполнитьДанныеУПД2019_ИнформацияПокупателя(Основания, Данные, Отказ) Экспорт
	
	ДокументОснование = Документы.СчетФактураПолученный.ПустаяСсылка();
	СчетФактураПолученный = Документы.СчетФактураПолученный.ПустаяСсылка();
	Для каждого Основание Из Основания Цикл
		Если ТипЗнч(Основание) = Тип("ДокументСсылка.СчетФактураПолученный") Тогда
			СчетФактураПолученный = Основание;
		ИначеЕсли ТипЗнч(Основание) = Тип("ДокументСсылка.КорректировкаПриобретения") Тогда
			ДокументОснование = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Основание, "ДокументОснование");
		Иначе
			ДокументОснование = Основание;
		КонецЕсли;
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Ссылка", ДокументОснование);
	Запрос.УстановитьПараметр("СчетФактураПолученный", СчетФактураПолученный);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ПриобретениеТоваровУслуг.Дата КАК Дата,
	|	ПриобретениеТоваровУслуг.Организация.НаименованиеПолное КАК ОрганизацияНаименованиеПолное,
	|	ПриобретениеТоваровУслуг.Организация.ИНН КАК ОрганизацияИНН,
	|	ПриобретениеТоваровУслуг.Организация.КПП КАК ОрганизацияКПП,
	|	&Принял КАК Принял,
	|	&Должность КАК ПринялДолжность
	|ИЗ
	|	&ТипДокумента КАК ПриобретениеТоваровУслуг
	|ГДЕ
	|	ПриобретениеТоваровУслуг.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СчетФактураПолученный.Дата КАК Дата,
	|	СчетФактураПолученный.Организация.НаименованиеПолное КАК ОрганизацияНаименованиеПолное,
	|	СчетФактураПолученный.Организация.ИНН КАК ОрганизацияИНН,
	|	СчетФактураПолученный.Организация.КПП КАК ОрганизацияКПП	
	|ИЗ
	|	Документ.СчетФактураПолученный КАК СчетФактураПолученный
	|ГДЕ
	|	СчетФактураПолученный.Ссылка = &СчетФактураПолученный
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПриобретениеТоваровУслугТовары.НомерСтроки КАК НомерСтроки
	|ИЗ
	|	Документ.ПриобретениеТоваровУслуг.Товары КАК ПриобретениеТоваровУслугТовары
	|ГДЕ
	|	ПриобретениеТоваровУслугТовары.Ссылка = &Ссылка И	
	|	ПриобретениеТоваровУслугТовары.Номенклатура.ТипНоменклатуры = Значение(Перечисление.ТипыНоменклатуры.Товар)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПриобретениеТоваровУслугТовары.НомерСтроки КАК НомерСтроки
	|ИЗ
	|	Документ.ПриобретениеТоваровУслуг.Товары КАК ПриобретениеТоваровУслугТовары
	|ГДЕ
	|	ПриобретениеТоваровУслугТовары.Ссылка = &Ссылка И	
	|	ПриобретениеТоваровУслугТовары.Номенклатура.ТипНоменклатуры = Значение(Перечисление.ТипыНоменклатуры.Услуга)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПриобретениеТоваровУслугТовары.НомерСтроки КАК НомерСтроки
	|ИЗ
	|	Документ.ПриобретениеТоваровУслуг.Товары КАК ПриобретениеТоваровУслугТовары
	|ГДЕ
	|	ПриобретениеТоваровУслугТовары.Ссылка = &Ссылка И	
	|	ПриобретениеТоваровУслугТовары.Номенклатура.ТипНоменклатуры = Значение(Перечисление.ТипыНоменклатуры.Работа)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	АктОРасхожденияхПослеПриемкиТовары.Ссылка.Номер КАК Номер,
	|	АктОРасхожденияхПослеПриемкиТовары.Ссылка.Дата КАК Дата
	|ИЗ
	|	Документ.АктОРасхожденияхПослеПриемки.Товары КАК АктОРасхожденияхПослеПриемкиТовары
	|ГДЕ
	|	АктОРасхожденияхПослеПриемкиТовары.ДокументОснование = &Ссылка И	
	|	АктОРасхожденияхПослеПриемкиТовары.Ссылка.Статус <> Значение(Перечисление.СтатусыАктаОРасхождениях.ПустаяСсылка)
	|	И АктОРасхожденияхПослеПриемкиТовары.Ссылка.Статус <> Значение(Перечисление.СтатусыАктаОРасхождениях.НеСогласовано)
	|	И НЕ АктОРасхожденияхПослеПриемкиТовары.Ссылка.ПометкаУдаления
	|";
	
	ОснованиеАкт = Ложь;
	ОснованиеКорректировка = Ложь;
	ОснованиеВозврат = Ложь;
	Если ЗначениеЗаполнено(ДокументОснование) Тогда
		Если ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.ПриобретениеУслугПрочихАктивов") Тогда		
			ОснованиеАкт = Истина;
		ИначеЕсли ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.КорректировкаПриобретения") Тогда
			ОснованиеКорректировка = Истина;
		ИначеЕсли ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.ВозвратТоваровОтКлиента") Тогда
			ОснованиеВозврат = Истина;
		КонецЕсли;
	КонецЕсли;	
		
	Если ОснованиеАкт Или ОснованиеКорректировка Или ОснованиеВозврат Тогда
		Если ОснованиеАкт Тогда 
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ТипДокумента", "Документ.ПриобретениеУслугПрочихАктивов");
		ИначеЕсли ОснованиеВозврат Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ТипДокумента", "Документ.ВозвратТоваровОтКлиента");
		Иначе
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ТипДокумента", "Документ.КорректировкаПриобретения");
		КонецЕсли;
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&Принял", "Неопределено");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&Должность", "Неопределено");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ТипДокумента", "Документ.ПриобретениеТоваровУслуг");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&Принял", "ПриобретениеТоваровУслуг.Принял");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&Должность", "ПриобретениеТоваровУслуг.ПринялДолжность");
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	РезультатЗапроса = Запрос.ВыполнитьПакет();
	СодержаниеОперации = "-";
	ДатаПолученияТоваров = ТекущаяДатаСеанса();
	ОрганизацияНаименованиеПолное =	"-";
	ТоварПринял = "";
	ТоварПринялДолжность = "";
	ЕстьДокументыУчета = Истина;
	
	Если Не РезультатЗапроса[0].Пустой() Тогда // В основаниях есть документ поступления
		
		Выборка = РезультатЗапроса[0].Выбрать();
		Выборка.Следующий();
		ДатаПолученияТоваров 		  =	Выборка.Дата;
		ОрганизацияНаименованиеПолное =	Выборка.ОрганизацияНаименованиеПолное;
		Если Не ОснованиеАкт И Не ОснованиеКорректировка Тогда
			ТоварПринял 				  = Выборка.Принял;
			ТоварПринялДолжность 		  = Выборка.ПринялДолжность;
		КонецЕсли;
		
	ИначеЕсли Не РезультатЗапроса[1].Пустой() Тогда // основание - СФ
		
		Выборка = РезультатЗапроса[1].Выбрать();
		Выборка.Следующий();
		ДатаПолученияТоваров =			 Выборка.Дата;
		ОрганизацияНаименованиеПолное =	 Выборка.ОрганизацияНаименованиеПолное;
		
	ИначеЕсли РезультатЗапроса[0].Пустой() и РезультатЗапроса[1].Пустой() Тогда
		
		ЕстьДокументыУчета = Ложь;
		Если ЗначениеЗаполнено(ДокументОснование) Тогда
			ДатаПолученияТоваров =		ДокументОснование.Дата;
			ОрганизацияСсылка = ЗначениеНастроекПовтИсп.ПолучитьОрганизациюПоУмолчанию(ДокументОснование.Организация);
			ОрганизацияНаименованиеПолное = ?(ЗначениеЗаполнено(ОрганизацияСсылка.НаименованиеПолное), ОрганизацияСсылка.НаименованиеПолное, ОрганизацияСсылка.Наименование);
		КонецЕсли;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ОрганизацияНаименованиеПолное) И Не ПолучитьФункциональнуюОпцию("ИспользоватьНесколькоОрганизаций") Тогда
		ОрганизацияСсылка = ЗначениеНастроекПовтИсп.ПолучитьОрганизациюПоУмолчанию();
		ОрганизацияНаименованиеПолное = ?(ЗначениеЗаполнено(ОрганизацияСсылка.НаименованиеПолное), ОрганизацияСсылка.НаименованиеПолное, ОрганизацияСсылка.Наименование);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Выборка) Тогда
		СоставительДокумента = ?(ЗначениеЗаполнено(Выборка.ОрганизацияКПП),
			СтрШаблон(НСтр("ru = '%1, ИНН/КПП %2/%3'"),
				ОрганизацияНаименованиеПолное, Выборка.ОрганизацияИНН, Выборка.ОрганизацияКПП),
			СтрШаблон(НСтр("ru = '%1, ИНН %2'"),
				ОрганизацияНаименованиеПолное, Выборка.ОрганизацияИНН));
	Иначе
		СоставительДокумента = ОрганизацияНаименованиеПолное;		
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные,
		"СоставительДокументаНаименование", СоставительДокумента);
	
	Если ЕстьДокументыУчета Тогда 
		Если РезультатЗапроса[5].Пустой() Тогда

			СоставСодержания = Новый Массив;
			Если Не РезультатЗапроса[2].Пустой() Или ОснованиеКорректировка Тогда
				СоставСодержания.Добавить(НСтр("ru = 'Товары принял без претензий.'"));
			КонецЕсли;
			Если Не РезультатЗапроса[3].Пустой() Или ОснованиеАкт Тогда
				СоставСодержания.Добавить(НСтр("ru = 'Услуги получены, претензий нет.'"));
			КонецЕсли;
			Если Не РезультатЗапроса[4].Пустой() Тогда
				СоставСодержания.Добавить(НСтр("ru = 'Результаты работ принял без претензий.'"));
			КонецЕсли;
			Если СоставСодержания.Количество() Тогда
				СодержаниеОперации  = СтрСоединить(СоставСодержания, " ");
			КонецЕсли;
			
			КодИтога = "1";
			
		Иначе
			
			КодИтога = "2";
			СодержаниеОперации = НСтр("ru = 'Товары (работы, услуги, права) приняты с расхождениями (претензией)'");
			ВидДокументаОРасхождении = "3";
			Выборка = РезультатЗапроса[5].Выбрать();
			Выборка.Следующий();
			
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "СведенияОПринятииТоваров.ДокументОРасхождениях.Наименование", "Акт о расхождениях после приемки");
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "СведенияОПринятииТоваров.ДокументОРасхождениях.Вид", ВидДокументаОРасхождении);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "СведенияОПринятииТоваров.ДокументОРасхождениях.Номер", Выборка.Номер);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "СведенияОПринятииТоваров.ДокументОРасхождениях.Дата", Выборка.Дата);
			
		КонецЕсли;
	Иначе
		КодИтога = "1";		
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "СведенияОПринятииТоваров.ДатаПолученияТоваров", ДатаПолученияТоваров);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "СведенияОПринятииТоваров.СодержаниеОперации", СодержаниеОперации);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "СведенияОПринятииТоваров.КодИтога", КодИтога);

	Если ЗначениеЗаполнено(ТоварПринял) Тогда
		ФИО = ФизическиеЛицаКлиентСервер.ЧастиИмени(ТоварПринял);
		Если ЗначениеЗаполнено(ТоварПринялДолжность)
			И ЗначениеЗаполнено(ТоварПринял) Тогда
			// Принявший товар работает в организации
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные,
				"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.Должность", Строка(ТоварПринялДолжность));
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные,
				"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.ОснованиеПолномочий", "Должностные обязанности");					
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные,
				"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.Фамилия", ФИО.Фамилия);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные,
				"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.Имя", ФИО.Имя);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные,
				"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.Отчество", ФИО.Отчество);
		ИначеЕсли ЗначениеЗаполнено(ТоварПринял) Тогда
			// Принявший товар не работает в организации
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные,
				"СведенияОЛицеПринявшемТовары.ИноеЛицо.ФЛ.Фамилия", ФИО.Фамилия);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные,
				"СведенияОЛицеПринявшемТовары.ИноеЛицо.ФЛ.Имя", ФИО.Имя);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные,
				"СведенияОЛицеПринявшемТовары.ИноеЛицо.ФЛ.Отчество", ФИО.Отчество);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура НайтиСоздатьУниверсальныйПередаточныйДокумент_2019(ДеревоДанных, СсылкиНаВладельцев = Неопределено, СпособОбработки = Неопределено, ОписаниеОшибки = "") Экспорт
	
	Текст = "";
	
	НачатьТранзакцию();
	Попытка
		
		ПервичныйДокумент = Неопределено;
		СчетФактура = Неопределено;
		
		Если СсылкиНаВладельцев <> Неопределено Тогда
			Для Каждого Ссылка Из СсылкиНаВладельцев Цикл
				Если ТипЗнч(Ссылка) = Тип("ДокументСсылка.СчетФактураПолученный")
				 Или ТипЗнч(Ссылка) = Тип("ДокументСсылка.СчетФактураПолученныйНалоговыйАгент") Тогда
					СчетФактура = Ссылка;
				Иначе
					ПервичныйДокумент = Ссылка;
				КонецЕсли;
				
			КонецЦикла;
		КонецЕсли;
		
		ДокументыУчета = Новый Массив;
		ФункцияУПД = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "Функция");

		Если ФункцияУПД = "ДОП" Или ФункцияУПД = "СЧФДОП" Тогда
			НайтиСоздатьУПДДокументОПередаче_2019(ДеревоДанных, ПервичныйДокумент, Истина, СпособОбработки, ОписаниеОшибки);
			ДокументыУчета.Добавить(ПервичныйДокумент);
		КонецЕсли;
		
		Если ФункцияУПД = "СвРК" Тогда
			НайтиСоздатьУПДДокументОтчетКомиссионераИлиРеализацияТоваровУслуг_2019(ДеревоДанных, ПервичныйДокумент, Истина, СпособОбработки, ОписаниеОшибки);
			ДокументыУчета.Добавить(ПервичныйДокумент);
		КонецЕсли;
		
		Если ФункцияУПД = "СвЗК" Тогда
			НайтиСоздатьУПДДокументПриобретениеТоваровУслуг_2019(ДеревоДанных, ПервичныйДокумент, Истина, СпособОбработки, ОписаниеОшибки);
			ДокументыУчета.Добавить(ПервичныйДокумент);
		КонецЕсли;
		
		// Заполним основание в СФ.
		Если ЗначениеЗаполнено(ПервичныйДокумент) Тогда
			ДокументыОснованияСчетаФактуры = Новый Массив;
			ДокументыОснованияСчетаФактуры.Добавить(ПервичныйДокумент);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументыОснованияСчетаФактуры", ДокументыОснованияСчетаФактуры);
		КонецЕсли;

		Если ФункцияУПД = "СЧФ" Или ФункцияУПД = "СЧФДОП" Тогда		
			НайтиСоздатьУПДСчетФактуру_2019(ДеревоДанных, СчетФактура, СпособОбработки, ОписаниеОшибки);
			Если ЗначениеЗаполнено(СчетФактура) Тогда
				ДокументыУчета.Добавить(СчетФактура);
			КонецЕсли;
		КонецЕсли;
		
		СсылкиНаВладельцев = ДокументыУчета;
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		ОтменитьТранзакцию();
		ОбщегоНазначения.СообщитьПользователю(Текст);
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка()),
					Текст);
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка,,,	ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;	
	
КонецПроцедуры

Процедура НайтиСоздатьУПДДокументОПередаче_2019(ДеревоДанных, СсылкаНаВладельца = Неопределено, Записывать = Истина, СпособОбработки, ОписаниеОшибки) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если ТипЗнч(СпособОбработки) = Тип("Строка") Тогда
		СпособОбработкиСтрокой = СпособОбработки;
	Иначе
		СпособОбработкиСтрокой = СпособОбработки.ПервичныйДокумент;
	КонецЕсли;
	
	ЗаполнитьДокументПередачиМеждуОрганизациямиПоПередачиТоваров(ДеревоДанных, СсылкаНаВладельца, Записывать, СпособОбработки, ОписаниеОшибки, "УПД_2019");
	
	Если Не (ТипЗнч(СсылкаНаВладельца) = Тип("ДокументСсылка.ПередачаТоваровМеждуОрганизациями")
		Или ТипЗнч(СсылкаНаВладельца) = Тип("ДокументСсылка.ВозвратТоваровМеждуОрганизациями")) Тогда
	
		Если СпособОбработкиСтрокой = "ПриобретениеУслугПрочихАктивов" Тогда
			ДанныеДляЗагрузки = ПодготовитьСтруктуруДляПоступленияУслугУПД_2019(ДеревоДанных);		
			ЗаполнитьДокументПоступленияУслуг(СсылкаНаВладельца, ДанныеДляЗагрузки, Записывать);
		ИначеЕсли СпособОбработкиСтрокой = "ПередачаТоваровМеждуОрганизациями"
			Или СпособОбработкиСтрокой = "ВозвратТоваровМеждуОрганизациями" Тогда
			ЗаполнитьДокументПередачиМеждуОрганизациямиПоПередачиТоваров(ДеревоДанных, СсылкаНаВладельца, Записывать, СпособОбработки, ОписаниеОшибки, "УПД_2019");
		Иначе
			ДанныеДляЗагрузки = ПодготовитьСтруктуруДляПриобретенияТоваровУслугУПД_2019(ДеревоДанных);
			Если СпособОбработкиСтрокой = "ВозвратТоваровОтКлиента" Тогда
				ЗаполнитьДокументВозвратаТоваровОтПокупателя(СсылкаНаВладельца, ДанныеДляЗагрузки, Записывать);
			ИначеЕсли СпособОбработкиСтрокой = "ОтчетКомиссионера" Тогда
				ЗаполнитьДокументОтчетКомиссионераОПродажахУслуги(СсылкаНаВладельца, ДанныеДляЗагрузки, Записывать);
			Иначе
				Если ДанныеДляЗагрузки.Шапка.Исправление Тогда
					ДанныеДляЗагрузки.Шапка.Вставить("ВидКорректировки", Перечисления.ХозяйственныеОперации.ИсправлениеОшибок);				
					ЗаполнитьДокументКорректировкиПоступления(СсылкаНаВладельца, ДанныеДляЗагрузки, Записывать);
				Иначе
					ЗаполнитьДокументПриобретенияТоваровУслуг(СсылкаНаВладельца, ДанныеДляЗагрузки, Записывать);
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура НайтиСоздатьУПДДокументОтчетКомиссионераИлиРеализацияТоваровУслуг_2019(ДеревоДанных, Документ = Неопределено, Записывать = Истина, СпособОбработки, ОписаниеОшибки) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если ТипЗнч(СпособОбработки) = Тип("Строка") Тогда
		СпособОбработкиСтрокой = СпособОбработки;
	Иначе
		СпособОбработкиСтрокой = СпособОбработки.ПервичныйДокумент;
	КонецЕсли;
	
	Если СпособОбработкиСтрокой = "ОтчетКомиссионера" Тогда
		ОписаниеЗамера = ОценкаПроизводительности.НачатьЗамерДлительнойОперации(
			"ОбщийМодуль.ОбменСКонтрагентамиУТ.ФормированиеОтчетаКомиссионераПоСведениямОПродажеКомиссионером");
			
		ДанныеДляЗагрузки = ПодготовитьСтруктуруДляОтчетаКомиссионераУПД_2019(ДеревоДанных);
		ЗаполнитьУПДДокументОтчетКомиссионера_2019(Документ, ДанныеДляЗагрузки, Записывать);
	ИначеЕсли СпособОбработкиСтрокой = "РеализацияТоваровУслуг" Тогда
		ОписаниеЗамера = ОценкаПроизводительности.НачатьЗамерДлительнойОперации(
			"ОбщийМодуль.ОбменСКонтрагентамиУТ.ФормированиеРеализацииТоваровУслугПоСведениямОПродажеКомиссионером");
			
		ДанныеДляЗагрузки = ПодготовитьСтруктуруДляРеализацииТоваровУслугУПД_2019(ДеревоДанных);
		ЗаполнитьУПДРеализациюТоваровУслуг_2019(Документ, ДанныеДляЗагрузки, Записывать);
	КонецЕсли;
	
	ОценкаПроизводительности.ЗакончитьЗамерДлительнойОперации(ОписаниеЗамера, 1);
	
КонецПроцедуры

Процедура НайтиСоздатьУПДДокументПриобретениеТоваровУслуг_2019(ДеревоДанных, Документ = Неопределено, Записывать = Истина, СпособОбработки, ОписаниеОшибки) Экспорт
	
	ОписаниеЗамера = ОценкаПроизводительности.НачатьЗамерДлительнойОперации(
		"ОбщийМодуль.ОбменСКонтрагентамиУТ.ФормированиеПриобретенияПоСведениямОЗакупкеКомиссионером");
	
	ДанныеДляЗагрузки = ПодготовитьСтруктуруДляПриобретенияТоваровУслугУПД_2019(ДеревоДанных);
	ЗаполнитьДокументПриобретенияТоваровУслуг(Документ, ДанныеДляЗагрузки, Записывать);
	
	ОценкаПроизводительности.ЗакончитьЗамерДлительнойОперации(ОписаниеЗамера, 1);
	
КонецПроцедуры

Процедура НайтиСоздатьУПДСчетФактуру_2019(ДеревоДанных, СсылкаНаВладельца = Неопределено, СпособОбработки = "", ОписаниеОшибки = "") Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	ДанныеДляЗагрузки = ПодготовитьСтруктуруДляСчетаФактурыУПД_2019(ДеревоДанных);
		
	НайтиДокументСчетФактураВыданныйМеждуОрганизациями(СсылкаНаВладельца, ДеревоДанных, Истина, "СЧФ");
		
	Если ДанныеДляЗагрузки.Шапка.Исправление Тогда
		Если ДанныеДляЗагрузки.Шапка.Свойство("ДокументыОснования") Тогда
			Для Каждого ДокументОснование Из ДанныеДляЗагрузки.Шапка.ДокументыОснования Цикл
				Если ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.КорректировкаПриобретения") или
				  ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.КорректировкаРеализации") Тогда
					Корректировка = ДокументОснование.Ссылка;
					ДокументОснование = Корректировка.ДокументОснование;
				Иначе
					ДокументОснование = ДокументОснование.Ссылка;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
		ДанныеДляЗагрузки.Шапка.Вставить("Корректировочный", Ложь);
		ДанныеДляЗагрузки.Шапка.Вставить("Исправление", Ложь);					
			
		ТаблицаСчетаФактуры = УчетНДСУП.СчетаФактурыПолученныеПоДокументамОснованиям(ДокументОснование, Ложь);
		Если ТаблицаСчетаФактуры.Количество() = 0 Тогда
			СчетФактураОснование = Неопределено;
		Иначе
			СчетФактураОснование = ТаблицаСчетаФактуры[0].Ссылка;
		КонецЕсли;
		ДанныеДляЗагрузки.Шапка.Вставить("СчетФактураОснование", СчетФактураОснование);
	КонецЕсли;	
	
	ЗаполнитьДокументСчетФактура(СсылкаНаВладельца, ДанныеДляЗагрузки, Истина);
	
КонецПроцедуры

#КонецОбласти

#Область УПД

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеУПД_ИнформацияПокупателя.
Процедура ЗаполнитьДанныеУПД_ИнформацияПокупателя(Знач Основания, Данные, Отказ) Экспорт

	ДокументОснование = Документы.СчетФактураПолученный.ПустаяСсылка();
	Для каждого Основание Из Основания Цикл
		Если ТипЗнч(Основание) = Тип("ДокументСсылка.КорректировкаПриобретения") Тогда
			ДокументОснование = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Основание, "ДокументОснование");
		Иначе
			ДокументОснование = Основание;
		КонецЕсли;
	КонецЦикла;	
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Ссылка", ДокументОснование);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ПриобретениеТоваровУслуг.Дата КАК Дата,
	|	ПриобретениеТоваровУслуг.Организация.НаименованиеПолное КАК ОрганизацияНаименованиеПолное,
	|	ПриобретениеТоваровУслуг.Организация.ИНН КАК ОрганизацияИНН,
	|	ПриобретениеТоваровУслуг.Организация.КПП КАК ОрганизацияКПП,
	|	&Принял КАК Принял,
	|	&Должность КАК ПринялДолжность
	|ИЗ
	|	&ТипДокумента КАК ПриобретениеТоваровУслуг
	|ГДЕ
	|	ПриобретениеТоваровУслуг.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СчетФактураПолученный.Дата КАК Дата,
	|	СчетФактураПолученный.Организация.НаименованиеПолное КАК ОрганизацияНаименованиеПолное,
	|	СчетФактураПолученный.Организация.ИНН КАК ОрганизацияИНН,
	|	СчетФактураПолученный.Организация.КПП КАК ОрганизацияКПП	
	|ИЗ
	|	Документ.СчетФактураПолученный КАК СчетФактураПолученный
	|ГДЕ
	|	СчетФактураПолученный.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПриобретениеТоваровУслугТовары.НомерСтроки КАК НомерСтроки
	|ИЗ
	|	Документ.ПриобретениеТоваровУслуг.Товары КАК ПриобретениеТоваровУслугТовары
	|ГДЕ
	|	ПриобретениеТоваровУслугТовары.Ссылка = &Ссылка И	
	|	ПриобретениеТоваровУслугТовары.Номенклатура.ТипНоменклатуры = Значение(Перечисление.ТипыНоменклатуры.Товар)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПриобретениеТоваровУслугТовары.НомерСтроки КАК НомерСтроки
	|ИЗ
	|	Документ.ПриобретениеТоваровУслуг.Товары КАК ПриобретениеТоваровУслугТовары
	|ГДЕ
	|	ПриобретениеТоваровУслугТовары.Ссылка = &Ссылка И	
	|	ПриобретениеТоваровУслугТовары.Номенклатура.ТипНоменклатуры = Значение(Перечисление.ТипыНоменклатуры.Услуга)
	|";
	
	Если ЗначениеЗаполнено(ДокументОснование) И 
				ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.ПриобретениеУслугПрочихАктивов") Тогда
		ОснованиеАкт = Истина;
	Иначе
		ОснованиеАкт = Ложь;
	КонецЕсли;	
		
	Если ОснованиеАкт Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ТипДокумента", "Документ.ПриобретениеУслугПрочихАктивов");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&Принял", "Неопределено");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&Должность", "Неопределено");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ТипДокумента", "Документ.ПриобретениеТоваровУслуг");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&Принял", "ПриобретениеТоваровУслуг.Принял");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&Должность", "ПриобретениеТоваровУслуг.ПринялДолжность");
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	РезультатЗапроса = Запрос.ВыполнитьПакет();
	СодержаниеОперации =			 "-";
	ДатаПолученияТоваров =			 ТекущаяДатаСеанса();
	ОрганизацияНаименованиеПолное =	 "-";
	ТоварПринял = "";
	ТоварПринялДолжность = "";
	ЕстьДокументыУчета = Истина;
	
	Если Не РезультатЗапроса[0].Пустой() Тогда // В основаниях есть документ поступления
		
		Выборка = РезультатЗапроса[0].Выбрать();
		Выборка.Следующий();
		ДатаПолученияТоваров 		  =	Выборка.Дата;
		ОрганизацияНаименованиеПолное =	Выборка.ОрганизацияНаименованиеПолное;
		Если Не ОснованиеАкт Тогда
			ТоварПринял 				  = Выборка.Принял;
			ТоварПринялДолжность 		  = Выборка.ПринялДолжность;
		КонецЕсли;
		
	ИначеЕсли Не РезультатЗапроса[1].Пустой() Тогда // основание - СФ
		
		Выборка = РезультатЗапроса[1].Выбрать();
		Выборка.Следующий();
		ДатаПолученияТоваров =			 Выборка.Дата;
		ОрганизацияНаименованиеПолное =	 Выборка.ОрганизацияНаименованиеПолное;
		
	ИначеЕсли РезультатЗапроса[0].Пустой() и РезультатЗапроса[1].Пустой() Тогда
		
		ЕстьДокументыУчета = Ложь;
		Если ЗначениеЗаполнено(ДокументОснование) Тогда
			ДатаПолученияТоваров =		ДокументОснование.Дата;
			ОрганизацияСсылка = ЗначениеНастроекПовтИсп.ПолучитьОрганизациюПоУмолчанию(ДокументОснование.Организация);
			ОрганизацияНаименованиеПолное = ?(ЗначениеЗаполнено(ОрганизацияСсылка.НаименованиеПолное), ОрганизацияСсылка.НаименованиеПолное, ОрганизацияСсылка.Наименование);
		КонецЕсли;
		
	КонецЕсли;
	
	СоставСодержания = Новый Массив;
	Если Не РезультатЗапроса[2].Пустой() ИЛИ Не ЕстьДокументыУчета  Тогда
		СоставСодержания.Добавить(НСтр("ru = 'Товары принял без претензий.'"));
	КонецЕсли;
	Если Не РезультатЗапроса[3].Пустой() Или ОснованиеАкт Тогда
		СоставСодержания.Добавить(НСтр("ru = 'Услуги получены, претензий нет.'"));
	КонецЕсли;
	Если СоставСодержания.Количество() Тогда
		СодержаниеОперации  = СтрСоединить(СоставСодержания, " ");
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ОрганизацияНаименованиеПолное) И Не ПолучитьФункциональнуюОпцию("ИспользоватьНесколькоОрганизаций") Тогда
		ОрганизацияСсылка = ЗначениеНастроекПовтИсп.ПолучитьОрганизациюПоУмолчанию();
		ОрганизацияНаименованиеПолное = ?(ЗначениеЗаполнено(ОрганизацияСсылка.НаименованиеПолное), ОрганизацияСсылка.НаименованиеПолное, ОрганизацияСсылка.Наименование);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Выборка) Тогда
		СоставительДокумента = ?(ЗначениеЗаполнено(Выборка.ОрганизацияКПП),
			СтрШаблон(НСтр("ru = '%1, ИНН/КПП %2/%3'"),
				ОрганизацияНаименованиеПолное, Выборка.ОрганизацияИНН, Выборка.ОрганизацияКПП),
			СтрШаблон(НСтр("ru = '%1, ИНН %2'"),
				ОрганизацияНаименованиеПолное, Выборка.ОрганизацияИНН));
	Иначе
		СоставительДокумента = ОрганизацияНаименованиеПолное;		
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные,
		"СоставительДокументаНаименование", СоставительДокумента);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "ДатаПолученияТоваров", ДатаПолученияТоваров);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "СодержаниеОперации", СодержаниеОперации);
	
	Если ЗначениеЗаполнено(ТоварПринял) Тогда
		ФИО = ФизическиеЛицаКлиентСервер.ЧастиИмени(ТоварПринял);
		Если ЗначениеЗаполнено(ТоварПринялДолжность)
			И ЗначениеЗаполнено(ТоварПринял) Тогда
			// Принявший товар работает в организации
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные,
				"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.Должность", Строка(ТоварПринялДолжность));
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные,
				"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.ОснованиеПолномочий", "Должностные обязанности");					
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные,
				"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.Фамилия", ФИО.Фамилия);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные,
				"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.Имя", ФИО.Имя);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные,
				"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.Отчество", ФИО.Отчество);
		ИначеЕсли ЗначениеЗаполнено(ТоварПринял) Тогда
			// Принявший товар не работает в организации
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные,
				"СведенияОЛицеПринявшемТовары.ИноеЛицо.ФЛ.Фамилия", ФИО.Фамилия);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные,
				"СведенияОЛицеПринявшемТовары.ИноеЛицо.ФЛ.Имя", ФИО.Имя);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные,
				"СведенияОЛицеПринявшемТовары.ИноеЛицо.ФЛ.Отчество", ФИО.Отчество);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область УКД_2020

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеУКД2020_ИнформацияПродавца
Процедура ЗаполнитьДанныеУКД2020_ИнформацияПродавца(Основание, Настройки, Данные, Описание, Отказ) Экспорт
	
	Если ТипЗнч(Основание) = Тип("ДокументСсылка.СчетФактураВыданный") Тогда
		ТипОснования = ТипЗнч(ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Основание, "ДокументОснование"));
		Если ТипОснования = Тип("ДокументСсылка.ПервичныйДокумент") Тогда
			ТекстСообщения = НСтр("ru='Действие недоступно для счета-фактуры, введенного на основании ""Первичного документа"".'");
			ОбщегоНазначения.СообщитьПользователю(ТекстСообщения,,,,Отказ);
			Возврат;
		ИначеЕсли ТипОснования = Тип("ДокументСсылка.ОтчетПоКомиссииМеждуОрганизациями") Тогда
			ТекстСообщения = НСтр("ru='Действие недоступно для счета-фактуры, введенного на основании ""Отчета по комиссии между организациями"".'");
			ОбщегоНазначения.СообщитьПользователю(ТекстСообщения,,,,Отказ);
			Возврат;
		КонецЕсли;
	ИначеЕсли ТипЗнч(Основание) = Тип("ДокументСсылка.СчетФактураКомиссионеру")
		И ТипЗнч(ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Основание, "ДокументОснование")) = Тип("ДокументСсылка.ОтчетПоКомиссииМеждуОрганизациями") Тогда
		ТекстСообщения = НСтр("ru='Действие недоступно для счета-фактуры, введенного на основании ""Отчета по комиссии между организациями"".'");
		ОбщегоНазначения.СообщитьПользователю(ТекстСообщения,,,,Отказ);
		Возврат;
	КонецЕсли;
	
	ВсеВидыДокументов = ОбменСКонтрагентами.ТипыДокументов();
	ВидДокумента = Настройки.ТипДокумента;
	
	СтруктураЭД = ОбщегоНазначения.СкопироватьРекурсивно(Настройки, Ложь);

	Если ВидДокумента = ВсеВидыДокументов.УКД Тогда		
		СтруктураЭД.Вставить("Функция", "КСЧФДИС");		
	ИначеЕсли ВидДокумента = ВсеВидыДокументов.КорректировочныйСчетФактура Тогда		
		СтруктураЭД.Вставить("Функция", "КСЧФ");
	Иначе		
		СтруктураЭД.Вставить("Функция", "ДИС");
	КонецЕсли;

	Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(Основание, "НалогообложениеНДС") 
										и ТипЗнч(Основание) <> Тип("ДокументСсылка.СчетФактураВыданный") Тогда
		ТипыБезНДС = Перечисления.ТипыНалогообложенияНДС.ТипыБезНДС();
		Если ТипыБезНДС.Найти(Основание.НалогообложениеНДС) <> Неопределено И СтруктураЭД.Функция = "КСЧФДИС" Тогда
			СтруктураЭД.Функция = "ДИС";
		КонецЕсли;
	КонецЕсли; 
	
	ДокОснование = Основание;
	Если СтруктураЭД.Функция <> "ДИС" Тогда	
		Если ТипЗнч(Основание) = Тип("ДокументСсылка.СчетФактураВыданный") Тогда
			СчетФактура = Основание;
			ДокОснование = СчетФактура.ДокументОснование;		
		Иначе
			МассивОбъектов = Новый Массив;
			МассивОбъектов.Добавить(Основание);		
			РезультатАнализа = Документы.СчетФактураВыданный.ПолучитьСчетаФактурыНаПечать(МассивОбъектов);
			МассивСчетовФактур = РезультатАнализа.СчетаФактурыНаПечать;
			Если МассивСчетовФактур.Количество() = 0 Тогда
				НоваяСчетФактура = Документы.СчетФактураВыданный.СоздатьДокумент();
				СтрокаОснований = НоваяСчетфактура.ДокументыОснования.Добавить();
				
				НоваяСчетФактура.ДокументОснование 	= Основание;
				СтрокаОснований.ДокументОснование 	= Основание;
				НоваяСчетФактура.КодВидаОперации = 
					Документы.СчетФактураВыданный.КодВидаОперации(НоваяСчетфактура.ДокументыОснования, 
							НоваяСчетфактура.Покупатели, НоваяСчетфактура.Дата, Основание);
				НоваяСчетФактура.КодВидаОперацииНаУменьшение 	= "18";
				НоваяСчетФактура.Дата 				= ТекущаяДатаСеанса();
				НоваяСчетФактура.ДатаВыставления 	= ТекущаяДатаСеанса();
				НоваяСчетФактура.ЗаполнитьПараметрыСчетаФактурыПоОснованию(Основание);
				
				НоваяСчетФактура.Записать(РежимЗаписиДокумента.Проведение);
				МассивСчетовФактур.Добавить(НоваяСчетФактура.Ссылка);
				
				//Запись в Реестр документов
				ТаблицыДанных = ПроведениеДокументов.ДанныеДокументаДляПроведения(НоваяСчетФактура.Ссылка, "РеестрДокументов");
				РегистрыСведений.РеестрДокументов.ЗаписатьДанные(ТаблицыДанных, НоваяСчетФактура.Ссылка,  Неопределено, Ложь);
			КонецЕсли;
			СчетФактура = МассивСчетовФактур[0];
		КонецЕсли;		

		МассивОбъектов = Новый Массив;
		МассивОбъектов.Добавить(СчетФактура);
		ПараметрыПечати = Новый Структура();
		
		// Маркировка
		ПараметрыПечати.Вставить("ЗаполнитьДанныеШтрихкодовДляУКДДо", Истина);
		ПараметрыПечати.Вставить("ЗаполнениеЭлектронногоДокумента");
		
		Если ТипЗнч(ДокОснование) = Тип("ДокументСсылка.ВозвратТоваровМеждуОрганизациями")
			И СтруктураЭД.Функция = "КСЧФДИС" Тогда
			СтруктураЭД.Функция = "КСЧФ";
			Настройки.ТипДокумента = Перечисления.ТипыДокументовЭДО.КорректировочныйСчетФактура;
		КонецЕсли;
		
		// Признак, что данные нужны для формирования ЭД КСЧФ, а 1не УПД/УКД
		ПараметрыПечати.Вставить("ПечатьЭДКСЧФ", Настройки.ТипДокумента = Перечисления.ТипыДокументовЭДО.КорректировочныйСчетФактура);

		СтруктураДанных = Документы.СчетФактураВыданный.ПолучитьДанныеДляПечатнойФормыУКД(ПараметрыПечати, МассивОбъектов); 
		
		ЗаполнитьДанныеСчетаФактурыУКД(СтруктураДанных, СтруктураЭД, Данные);		
		ЗаполнитьДанныеПервичногоДокументаУКД_2020(СтруктураДанных, СтруктураЭД, Данные, Настройки);		
	Иначе
		ЗаполнитьДанныеДляДИСИнформацияПродавцаФНС_2020(Основание, Настройки, СтруктураЭД, Данные);		
	КонецЕсли;
	
	ФункцияУКД = СтруктураЭД.Функция;	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "Функция", ФункцияУКД);

	ПередаточныеДокументы = Новый Массив;
	ПередаточныеДокументы.Добавить(ДокОснование);
	
	Если ФункцияУКД = "КСЧФДИС" Тогда		
		Если Основание = СчетФактура Тогда
			ОбщегоНазначенияКлиентСервер.ДополнитьМассив(Описание.Основания, ПередаточныеДокументы);
		Иначе
			Описание.Основания.Добавить(СчетФактура);
		КонецЕсли;		
	КонецЕсли;	
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеУКД2020_ИнформацияПокупателя.
Процедура ЗаполнитьДанныеУКД2020_ИнформацияПокупателя(Знач Основания, Данные, Отказ) Экспорт
	
	ДокументОснование = Документы.СчетФактураПолученный.ПустаяСсылка();
	Для каждого Основание Из Основания Цикл
		ДокументОснование = Основание;
	КонецЦикла;	

	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Ссылка", ДокументОснование);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	КорректировкаПриобретения.Дата,
	|	КорректировкаПриобретения.Организация.НаименованиеПолное,
	|	КорректировкаПриобретения.Организация.ИНН КАК ОрганизацияИНН,
	|	КорректировкаПриобретения.Организация.КПП КАК ОрганизацияКПП	
	|ИЗ
	|	Документ.КорректировкаПриобретения КАК КорректировкаПриобретения
	|ГДЕ
	|	КорректировкаПриобретения.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СчетФактураПолученный.Дата,
	|	СчетФактураПолученный.Организация.НаименованиеПолное,
	|	СчетФактураПолученный.Организация.ИНН КАК ОрганизацияИНН,
	|	СчетФактураПолученный.Организация.КПП КАК ОрганизацияКПП	
	|ИЗ
	|	Документ.СчетФактураПолученный КАК СчетФактураПолученный
	|ГДЕ
	|	СчетФактураПолученный.Ссылка = &Ссылка";
	
	УстановитьПривилегированныйРежим(Истина);
	РезультатЗапроса = Запрос.ВыполнитьПакет();
	ДатаПолученияКорректировки = ТекущаяДатаСеанса();
	ОрганизацияНаименованиеПолное =	 "-";
	Если Не РезультатЗапроса[0].Пустой() Тогда // В основаниях есть документ поступления
		
		Выборка = РезультатЗапроса[0].Выбрать();
		Выборка.Следующий();
		ДатаПолученияКорректировки 	  =	 Выборка.Дата;
		ОрганизацияНаименованиеПолное =	 Выборка.ОрганизацияНаименованиеПолное;
		
	ИначеЕсли Не РезультатЗапроса[1].Пустой() Тогда // основание - СФ
		
		Выборка = РезультатЗапроса[1].Выбрать();
		Выборка.Следующий();
		ДатаПолученияКорректировки 	  =	 Выборка.Дата;
		ОрганизацияНаименованиеПолное =	 Выборка.ОрганизацияНаименованиеПолное;
		
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ОрганизацияНаименованиеПолное) И Не ПолучитьФункциональнуюОпцию("ИспользоватьНесколькоОрганизаций") Тогда
		Если ЗначениеЗаполнено(ДокументОснование) Тогда	
			ОрганизацияСсылка = ЗначениеНастроекПовтИсп.ПолучитьОрганизациюПоУмолчанию(ДокументОснование.Организация);
			ОрганизацияНаименованиеПолное = ?(ЗначениеЗаполнено(ОрганизацияСсылка.НаименованиеПолное), ОрганизацияСсылка.НаименованиеПолное, ОрганизацияСсылка.Наименование);
		КонецЕсли;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Выборка) Тогда
		СоставительДокумента = ?(ЗначениеЗаполнено(Выборка.ОрганизацияКПП),
			СтрШаблон(НСтр("ru = '%1, ИНН/КПП %2/%3'"),
				ОрганизацияНаименованиеПолное, Выборка.ОрганизацияИНН, Выборка.ОрганизацияКПП),
			СтрШаблон(НСтр("ru = '%1, ИНН %2'"),
				ОрганизацияНаименованиеПолное, Выборка.ОрганизацияИНН));
	Иначе
		СоставительДокумента = ОрганизацияНаименованиеПолное;		
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные,
		"СоставительДокументаНаименование", СоставительДокумента);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "ДатаСогласования", ДатаПолученияКорректировки);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "СодержаниеОперации", НСтр("ru = 'С изменением стоимости согласен.'"));

КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.НайтиСоздатьУКД_2020.
Процедура НайтиСоздатьУКД_2020(ДеревоДанных, СсылкиНаВладельцев, СпособОбработки, ОписаниеОшибки = "") Экспорт
	
	Текст = "";	
	ФункцияУКД = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "Функция");	
	ДокументыУчета = Новый Массив;			
	
	Если СсылкиНаВладельцев <> Неопределено Тогда
		Для Каждого Ссылка Из СсылкиНаВладельцев Цикл
			Если ТипЗнч(Ссылка) = Тип("ДокументСсылка.СчетФактураПолученный")
			 Или ТипЗнч(Ссылка) = Тип("ДокументСсылка.СчетФактураПолученныйНалоговыйАгент") Тогда
				СчетФактура = Ссылка;
			Иначе
				ПервичныйДокумент = Ссылка;
			КонецЕсли;
			
		КонецЦикла;
	КонецЕсли;			
	
	НачатьТранзакцию();
	Попытка
		
		Если ФункцияУКД = "КСЧФДИС" Тогда		
			ПервичныйДокумент = Неопределено;
			СчетФактура = Неопределено;
			
			ЗаполнитьДокументПередачиМеждуОрганизациямиПоПередачиТоваров(ДеревоДанных, ПервичныйДокумент, Истина, СпособОбработки, ОписаниеОшибки, ФункцияУКД);
			
			Если ПервичныйДокумент = Неопределено Тогда
				НайтиСоздатьКорректировкуПоступленияУКД(ДеревоДанных, ПервичныйДокумент);
			КонецЕсли;
			ДокументыУчета.Добавить(ПервичныйДокумент);
			
			// Заполним основание в СФ.
			ДокументыОснованияСчетаФактуры = Новый Массив;
			ДокументыОснованияСчетаФактуры.Добавить(ПервичныйДокумент);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументыОснованияСчетаФактуры", ДокументыОснованияСчетаФактуры);
			НайтиДокументСчетФактураВыданныйМеждуОрганизациями(СчетФактура, ДеревоДанных, Истина, ФункцияУКД);
			Если СчетФактура = Неопределено Тогда
				НайтиСоздатьКорректировочныйСчетФактуруУКД(ДеревоДанных, СчетФактура);
			КонецЕсли;
			ДокументыУчета.Добавить(СчетФактура);
			
		ИначеЕсли ФункцияУКД = "ДИС" Тогда
			ЗаполнитьДокументПередачиМеждуОрганизациямиПоПередачиТоваров(ДеревоДанных, ПервичныйДокумент, Истина, СпособОбработки, ОписаниеОшибки, "КСЧФ");
			Если ПервичныйДокумент = Неопределено Тогда
				НайтиСоздатьКорректировкуПоступленияУКД(ДеревоДанных, ПервичныйДокумент);
			КонецЕсли;
			ДокументыУчета.Добавить(ПервичныйДокумент);
		ИначеЕсли ФункцияУКД = "КСЧФ" Тогда
			НайтиДокументСчетФактураВыданныйМеждуОрганизациями(СчетФактура, ДеревоДанных, Истина, ФункцияУКД);
			Если СчетФактура = Неопределено Тогда
				НайтиСоздатьКорректировочныйСчетФактуруУКД(ДеревоДанных, СчетФактура);
			КонецЕсли;
			ДокументыУчета.Добавить(СчетФактура);			
		КонецЕсли;
		
		СсылкиНаВладельцев = ДокументыУчета;	
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		ОтменитьТранзакцию();
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка()),
					Текст);
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка,,,	ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;
		
КонецПроцедуры

#КонецОбласти

#Область ВспомогательныеМетоды_УПД_УКД_2019

Процедура ЗаполнитьДанныеПервичногоДокументаУПД_2019(СтруктураДанных, СтруктураЭД, ДеревоДанных, Настройки, Отказ, КоличествоЗаписей = 1) Экспорт
	
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	
	ДанныеШапки = СтруктураДанных.РезультатПоШапке.Выбрать();
	ДанныеШапки.Следующий();
	
	НДСИсчисляетсяНалоговымАгентом = Ложь;
	ОблагаетсяНДССМежценовойРазницы = Ложь;
	Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ДанныеШапки, "НалогообложениеНДС") Тогда
		НДСИсчисляетсяНалоговымАгентом = (ДанныеШапки.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ОблагаетсяНДСУПокупателя);
		ОблагаетсяНДССМежценовойРазницы = (ДанныеШапки.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ОблагаетсяНДССМежценовойРазницы);
	КонецЕсли;
	
	Если ТипЗнч(ДанныеШапки.Ссылка) = Тип("ДокументСсылка.СчетФактураВыданный") 
			или ТипЗнч(ДанныеШапки.Ссылка) = Тип("ДокументСсылка.СчетФактураКомиссионеру") Тогда
		ДокументОтгрузки = ДанныеШапки.Ссылка.ДокументОснование;
	Иначе
		ДокументОтгрузки = ДанныеШапки.Ссылка;
	КонецЕсли;
	
	Если ДанныеШапки.ПредставлениеДокумента = "счет-фактура комиссионера" Тогда
		ЭтоКомиссия = Истина;
	Иначе
		ЭтоКомиссия = Ложь
	КонецЕсли;
	
	ЕстьТаблицаРезультатПоКонтрагентам = Ложь;
	Если СтруктураДанных.Свойство("РезультатПоКонтрагентам") Тогда
		ЕстьТаблицаРезультатПоКонтрагентам = Истина;
	КонецЕсли;
	
	Если ЕстьТаблицаРезультатПоКонтрагентам Тогда
		ВыборкаДанныхКонтрагента = СтруктураДанных.РезультатПоКонтрагентам.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		ВыборкаДанныхКонтрагента.НайтиСледующий(Новый Структура("Ссылка", ДанныеШапки.Ссылка));
		ДанныеКонтрагента = ВыборкаДанныхКонтрагента.Выбрать();
		ДанныеКонтрагента.Следующий();
		Если Не ЗначениеЗаполнено(ДанныеКонтрагента.Контрагент) Тогда
			ЕстьТаблицаРезультатПоКонтрагентам = Ложь;	
		КонецЕсли;		
	КонецЕсли;  	
	

	// ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС
	ЭтоЭлектронноеАктированиеЕИС = Ложь;
	Если СтруктураДанных.Свойство("ДанныеЭлектронногоАктирования") Тогда
		ЭтоЭлектронноеАктированиеЕИС = Истина;
		ДанныеЭлектронногоАктированияЕИС = СтруктураДанных.ДанныеЭлектронногоАктирования;
		ДанныеПриложенияЕИС = ЭлектронноеАктированиеЕИС.НовыеДанныеПриложенияКТитулуПродавцаУПД();
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, "ДанныеЭлектронногоАктированияЕИС.ДанныеПриложения", ДанныеПриложенияЕИС);
		ЭлектронноеАктированиеЕИСУТ.ЗаполнитьДанныеДереваДляЭлектронногоАктированияЕИС(ДеревоДанных,
			ДанныеЭлектронногоАктированияЕИС,
			ДанныеШапки,
			ДанныеПриложенияЕИС,
			ДокументОтгрузки,
			Ложь);
	Иначе
		ЭлектронноеАктированиеЕИСУТ.ПроверитьДоговорЭД(
			Настройки, ДокументОтгрузки, ДеревоДанных, Ложь);
	КонецЕсли;
	ИдентификаторМестаПоставкиЕИС = "";
	Если ЭтоЭлектронноеАктированиеЕИС Тогда
		ИдентификаторМестаПоставкиЕИС = Строка(Новый УникальныйИдентификатор);
		ИдентификаторМестаПоставкиЕИС = СтрЗаменить(ИдентификаторМестаПоставкиЕИС, "-", "");
	КонецЕсли;	

	МестаПоставкиНеЗаполнены = Истина;
	Если ЭтоЭлектронноеАктированиеЕИС И ТипЗнч(ДокументОтгрузки) = Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда
		Если ЗначениеЗаполнено(ДокументОтгрузки.АдресДоставкиЗначенияПолей) Тогда
			МестаПоставкиНеЗаполнены = Ложь;
			ЭлектронноеАктированиеЕИСУТ.ЗаполнитьМестаПоставкиПриложенияЕИСПоАдресуДоставки(
				ДокументОтгрузки.АдресДоставкиЗначенияПолей, ИдентификаторМестаПоставкиЕИС, ДанныеПриложенияЕИС);
		КонецЕсли;
	КонецЕсли;	
	// Конец ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС

	ТипДокумента = ТипЗнч(ДокументОтгрузки);
	
	Если ТипДокумента = Тип("ДокументСсылка.РеализацияТоваровУслуг") И СтруктураЭД.Функция <> "СЧФ" Тогда
		Если ДокументОтгрузки.Статус <> Перечисления.СтатусыРеализацийТоваровУслуг.Отгружено Тогда
			ВидОперации = НСтр("ru = 'Формирование ЭД'");
			ПодробныйТекстОшибки = НСтр("ru = 'Ошибка при формирование ЭД. Неверный статус документа.'");
			ТекстСообщения = НСтр("ru = 'Формирование ЭД возможно только для документов в статусе ""Реализовано"".'");
			ЭлектронноеВзаимодействие.ОбработатьОшибку(ВидОперации, ПодробныйТекстОшибки, ТекстСообщения);
			Отказ = Истина;
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	Если (ТипДокумента = Тип("ДокументСсылка.РеализацияТоваровУслуг")
		Или ТипДокумента = Тип("ДокументСсылка.ВозвратТоваровПоставщику")
		Или ТипДокумента = Тип("ДокументСсылка.КорректировкаРеализации"))
		И Не ЭлектронноеВзаимодействиеИСМП.ДанныеДокументаСоответствуютДаннымУпаковок(ДокументОтгрузки, Истина) Тогда
		ВидОперации          = НСтр("ru = 'Формирование ЭД'");
		ПодробныйТекстОшибки = НСтр("ru = 'Ошибка при формирование ЭД: Неверное указание маркированной продукции.'");
		ТекстСообщения       = НСтр("ru = 'Проверьте указание кодов маркировки.'");
		ЭлектронноеВзаимодействие.ОбработатьОшибку(ВидОперации, ПодробныйТекстОшибки, ТекстСообщения, ДанныеШапки.Ссылка);
		Отказ = Истина;
		Возврат;
	КонецЕсли;
		
	// Заполнение параметра ВидОборота
	ВидОборота = "";
	Если ТипЗнч(ДокументОтгрузки) = Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда
		ЕстьТоварыОСУ = ЕстьТоварыОСУ(ДокументОтгрузки);
		Если ЕстьТоварыОСУ Тогда
			ФискальнаяОперацияДанныеЖурнала = ФормированиеФискальныхЧековСервер.ДанныеПробитогоФискальногоЧекаПоДокументу(ДокументОтгрузки);
			Если ФискальнаяОперацияДанныеЖурнала <> Неопределено Тогда
				ВидОборота = "10";
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	Если ЗначениеЗаполнено(ВидОборота) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ВидОборота", ВидОборота);
	КонецЕсли;

	// Заполнение параметра ОбстоятельстваФормированияСФ для ДОП и СЧФДОП
	Если СтруктураЭД.Функция <> "СЧФ" Тогда
		ОбстоятельстваФормированияСФ = "";
		Если ТипЗнч(ДокументОтгрузки) = Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда
			ХозяйственнаяОперация = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОтгрузки, "ХозяйственнаяОперация");
			Если ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаНаКомиссию Тогда
				ОбстоятельстваФормированияСФ = "4";
			КонецЕсли;
		ИначеЕсли ТипЗнч(ДокументОтгрузки) = Тип("ДокументСсылка.ВозвратТоваровПоставщику") Тогда
			ХозяйственнаяОперация = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОтгрузки, "ХозяйственнаяОперация");
			Если ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратТоваровКомитенту Тогда
				ОбстоятельстваФормированияСФ = "5";
			КонецЕсли;
		ИначеЕсли  ТипЗнч(ДокументОтгрузки) = Тип("ДокументСсылка.ПередачаТоваровМеждуОрганизациями") Тогда
			ХозяйственнаяОперация = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОтгрузки, "ХозяйственнаяОперация");
			Если ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаНаКомиссиюВДругуюОрганизацию Тогда
				ОбстоятельстваФормированияСФ = "4";
			КонецЕсли;
		ИначеЕсли  ТипЗнч(ДокументОтгрузки) = Тип("ДокументСсылка.ВозвратТоваровМеждуОрганизациями") Тогда
			ХозяйственнаяОперация = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОтгрузки, "ХозяйственнаяОперация");
			Если ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратТоваровКомитенту
				Или ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратПоКомиссииМеждуОрганизациями Тогда
				ОбстоятельстваФормированияСФ = "5";
			КонецЕсли;
		ИначеЕсли  ТипЗнч(ДокументОтгрузки) = Тип("ДокументСсылка.ОтчетКомитентуОЗакупках") Тогда
			ОбстоятельстваФормированияСФ = "6";
		КонецЕсли;
		Если ЗначениеЗаполнено(ОбстоятельстваФормированияСФ) Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДополнительныеСведенияОбУчастниках.ОбстоятельстваФормированияСФ", ОбстоятельстваФормированияСФ);
		КонецЕсли;
	КонецЕсли;
	
	Если ТипЗнч(ДокументОтгрузки) = Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда
		ВнестиСведенияОВыбытииМаркированныхТоваровВДеревоУПДУКД(ДеревоДанных, ДокументОтгрузки.ВариантВыбытияМаркируемойПродукции);
	КонецЕсли;
	
	СтрокаДереваВидСчетаФактуры = ЭлектронноеВзаимодействие.СтрокаДерева(ДеревоДанных, "ВидСчетаФактуры");
	ВидСчетаФактуры = СтрокаДереваВидСчетаФактуры.Значение;
	
	ОпцииПечати = Новый Структура;
	ОпцииПечати.Вставить("НомерСформированВСчетеФактуре", СтруктураДанных.Свойство("НомерСформированВСчетеФактуре"));
	
	Если ОпцииПечати.НомерСформированВСчетеФактуре Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "НомерДокумента",  ДанныеШапки.Номер);		
	Иначе
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, 
			"НомерДокумента",  НомерСчетаФактурыНаПечать(ДанныеШапки.Номер, ДанныеШапки.ИндексПодразделения));
	КонецЕсли;
		
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокумента", ДанныеШапки.Дата);
	
	Если ДанныеШапки.Исправление Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления", Число(ДанныеШапки.НомерИсправления));	
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсправления", ДанныеШапки.ДатаИсправления);
	КонецЕсли;
	
	ТекстОшибки = НСтр("ru = 'Не удалось заполнить код валюты документа. Проверьте, что:
	|	- в документе указана валюта,
	|	- для нее заполнен код по Общероссийскому классификатору валют.'");
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод", "643", ТекстОшибки);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ДополнительныеСведенияОбУчастниках.ВалютаНаименование", "Российский рубль");
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ТолькоУслуги", ДанныеШапки.ТолькоУслуги);			
	
	// Выводим данные продавца. 
	ЕстьТаблицаРезультатПоПоставщикам = Ложь;
	Если СтруктураДанных.Свойство("РезультатПоПоставщикам") Тогда
		ЕстьТаблицаРезультатПоПоставщикам = Истина;
	КонецЕсли;
	
	Если ТипЗнч(ДокументОтгрузки) = Тип("ДокументСсылка.ОтчетКомитентуОЗакупках")
		И ЕстьТаблицаРезультатПоПоставщикам Тогда
		ВыборкаДанныхКонтрагента = СтруктураДанных.РезультатПоПоставщикам.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		ВыборкаДанныхКонтрагента.НайтиСледующий(Новый Структура("Ссылка", ДанныеШапки.Ссылка));
		ДанныеПоставщика = ВыборкаДанныхКонтрагента.Выбрать();
		ДанныеПоставщика.Следующий();
		Если ЗначениеЗаполнено(ДанныеПоставщика.Поставщик) Тогда
			СведенияОПоставщике = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(ДанныеПоставщика.Поставщик, , ДанныеШапки.Дата);
			Если ЗначениеЗаполнено(ДанныеПоставщика.КПППоставщика) Тогда
				СведенияОПоставщике.КПП = ДанныеПоставщика.КПППоставщика;
			КонецЕсли;
			Поставщик = ДанныеПоставщика.Поставщик;
		Иначе
			ЕстьТаблицаРезультатПоПоставщикам = Ложь;
		КонецЕсли;
	Иначе
		ЕстьТаблицаРезультатПоПоставщикам = Ложь;
	КонецЕсли;
	
	Если Не ЕстьТаблицаРезультатПоПоставщикам Тогда
		Поставщик = ДанныеШапки.Организация;
		Если ЗначениеЗаполнено(ДанныеШапки.БанковскийСчетОрганизации) Тогда
			БанковскийСчетОрганизации = ДанныеШапки.БанковскийСчетОрганизации;
		Иначе
			БанковскийСчетОрганизации = Неопределено;
		КонецЕсли;
	
		СведенияОПоставщике = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(ДанныеШапки.Организация, БанковскийСчетОрганизации, ДанныеШапки.Дата);
	
		// ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС
		Если ЭтоЭлектронноеАктированиеЕИС Тогда
			Если ДанныеЭлектронногоАктированияЕИС.ДанныеГосконтракта.Количество() = 0 Тогда
				ТекстОшибки = НСтр("ru = 'Не указан гос.контракт или не выбран этап гос.контракта.'");
				ЭлектронноеАктированиеЕИС.ДобавитьОшибкуЗаполненияПриложения(
					ДанныеПриложенияЕИС, ТекстОшибки);		
			Иначе
				НаименованиеПоставщикаДляЕИС = ДанныеЭлектронногоАктированияЕИС.ДанныеГосконтракта[0].ПолноеНаименованиеПоставщика;
				СведенияОПоставщике.ПолноеНаименование = НаименованиеПоставщикаДляЕИС;
			КонецЕсли;
		КонецЕсли;
		// Конец ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС
	
		Если ЗначениеЗаполнено(ДанныеШапки.КПППоставщика) Тогда
			СведенияОПоставщике.КПП = ДанныеШапки.КПППоставщика;
		КонецЕсли;
	КонецЕсли;
	
	ТаблицаПродавцов = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(ДеревоДанных, "СведенияОПродавце");
	ТаблицаПродавцов.Колонки.Добавить("СведенияОбУчастнике");
	ДанныеПродавца = ПолучитьДанныеУчастникаУПД(СведенияОПоставщике, "Юр");
	СтрокаПродавца = ТаблицаПродавцов.Добавить();
	ЗаполнитьЗначенияСвойств(СтрокаПродавца, ДанныеПродавца);
	// Заполняем структурное подразделение
	Если ДанныеШапки.ПредставлениеДокумента <> "счет-фактура комиссионера" Тогда
		Если ЗначениеЗаполнено(ДанныеШапки.Ссылка.Подразделение) Тогда
			СтрокаПродавца.СтруктурноеПодразделение = ДанныеШапки.Ссылка.Подразделение.Наименование;
		КонецЕсли;
	КонецЕсли;
	ДобавитьОбработкуОшибокВТаблицуУчастниковУПД(ТаблицаПродавцов);
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ТаблицаПродавцов, "СведенияОПродавце");
	
	Если ВидСчетаФактуры <> "Авансовый" Тогда	
		// Выводим данные грузоотправителя.
		ТаблицаГрузоотправителей = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(ДеревоДанных, "СведенияОГрузоотправителе");
		ТаблицаГрузоотправителей.Колонки.Добавить("СведенияОбУчастнике");
		
		Если Поставщик = ДанныеШапки.Грузоотправитель И Не ДанныеШапки.ТолькоУслуги Тогда
			ТаблицаГрузоотправителей.Добавить().ОнЖе = Истина;	
		ИначеЕсли ЗначениеЗаполнено(ДанныеШапки.Грузоотправитель) И Не ДанныеШапки.ТолькоУслуги Тогда
			СведенияОГрузоотправителе = Неопределено; 
			Если ЗначениеЗаполнено(ДанныеШапки.БанковскийСчетГрузоотправителя) Тогда
				БанковскийСчетГрузоотправителя = ДанныеШапки.БанковскийСчетГрузоотправителя;
			Иначе
				БанковскийСчетГрузоотправителя = Неопределено;
			КонецЕсли;
			СведенияОГрузоотправителе = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(ДанныеШапки.Грузоотправитель, БанковскийСчетГрузоотправителя, ДанныеШапки.Дата);
			
			ДанныеГрузоотправителя = ПолучитьДанныеУчастникаУПД(СведенияОГрузоотправителе, "Факт");
			СтрокаГрузоотправителя = ТаблицаГрузоотправителей.Добавить();
			СтрокаГрузоотправителя.Грузоотправитель = ДанныеГрузоотправителя;		
			СтрокаГрузоотправителя.СведенияОбУчастнике = СведенияОГрузоотправителе;
		КонецЕсли;
		ДобавитьОбработкуОшибокВТаблицуУчастниковУПД(ТаблицаГрузоотправителей, "Грузоотправитель");
		ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ТаблицаГрузоотправителей, "СведенияОГрузоотправителе");
		
		// Выводим данные грузополучателя.
		ТаблицаГрузополучателей = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(ДеревоДанных, "СведенияОГрузополучателе");
		ТаблицаГрузополучателей.Колонки.Добавить("СведенияОбУчастнике");
		
		Если Не ДанныеШапки.ТолькоУслуги Тогда
			СведенияОГрузополучателе = "";
			Если ЗначениеЗаполнено(ДанныеШапки.БанковскийСчетГрузополучателя) Тогда
				БанковскийСчетГрузополучателя = ДанныеШапки.БанковскийСчетГрузополучателя;
			Иначе
				БанковскийСчетГрузополучателя = Неопределено;
			КонецЕсли;
			
			Если НЕ ЕстьТаблицаРезультатПоКонтрагентам Тогда
				Если ДанныеШапки.Грузополучатель <> Неопределено Тогда
					СведенияОГрузополучателе = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(ДанныеШапки.Грузополучатель, БанковскийСчетГрузополучателя, ДанныеШапки.Дата);
				КонецЕсли;	
			ИначеЕсли ЗначениеЗаполнено(ДанныеКонтрагента.Грузополучатель) Тогда
				СведенияОГрузополучателе = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(ДанныеКонтрагента.Грузополучатель, БанковскийСчетГрузополучателя, ДанныеШапки.Дата);
			КонецЕсли;
			Если ЗначениеЗаполнено(СведенияОГрузополучателе) Тогда
				ДанныеГрузополучателя = ПолучитьДанныеУчастникаУПД(СведенияОГрузополучателе, "Факт");
				СтрокаГрузополучателя = ТаблицаГрузополучателей.Добавить();
				ЗаполнитьЗначенияСвойств(СтрокаГрузополучателя, ДанныеГрузополучателя);
			КонецЕсли; 
		
			ДобавитьОбработкуОшибокВТаблицуУчастниковУПД(ТаблицаГрузополучателей);
			ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ТаблицаГрузополучателей, "СведенияОГрузополучателе");
		КонецЕсли;
	КонецЕсли;
	
	// Выводим данные покупателя. 
	СведенияОПокупателе = "";
	Если ЗначениеЗаполнено(ДанныеШапки.БанковскийСчетКонтрагента) Тогда
		БанковскийСчетКонтрагента = ДанныеШапки.БанковскийСчетКонтрагента;
	Иначе
		БанковскийСчетКонтрагента = Неопределено;
	КонецЕсли;

	Если НЕ ЕстьТаблицаРезультатПоКонтрагентам Тогда 
		СведенияОПокупателе = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(ДанныеШапки.Контрагент, БанковскийСчетКонтрагента, ДанныеШапки.Дата);
		Если Не ПустаяСтрока(ДанныеШапки.КПППокупателя) Тогда
			СведенияОПокупателе.КПП = ДанныеШапки.КПППокупателя;
		КонецЕсли;
	Иначе
		Если ЗначениеЗаполнено(ДанныеКонтрагента.Контрагент) Тогда		
			СведенияОПокупателе = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(ДанныеКонтрагента.Контрагент, БанковскийСчетКонтрагента, ДанныеШапки.Дата);
			Если Не ПустаяСтрока(ДанныеКонтрагента.КПППокупателя) Тогда
				СведенияОПокупателе.КПП = ДанныеКонтрагента.КПППокупателя;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	Если ЗначениеЗаполнено(СведенияОПокупателе) Тогда
		ТаблицаПокупателей = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(ДеревоДанных, "СведенияОПокупателе");
		ТаблицаПокупателей.Колонки.Добавить("СведенияОбУчастнике");
		ДанныеПокупателя = ПолучитьДанныеУчастникаУПД(СведенияОПокупателе, "Юр");
		СтрокаПокупателя = ТаблицаПокупателей.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаПокупателя, ДанныеПокупателя);
		ДобавитьОбработкуОшибокВТаблицуУчастниковУПД(ТаблицаПокупателей);

		// ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС
		Если ЭтоЭлектронноеАктированиеЕИС Тогда
			Если МестаПоставкиНеЗаполнены Тогда
				СведенияОПокупателе.Вставить("ИдентификаторМестаПоставкиЕИС", ИдентификаторМестаПоставкиЕИС);
				ЭлектронноеАктированиеЕИСУТ.ЗаполнитьМестаПоставкиПриложенияЕИСПоДаннымУчастника(
					СведенияОПокупателе, СтрокаПокупателя, "СведенияОПокупателе", ДанныеПриложенияЕИС, ДанныеШапки.Дата);
			Иначе	
				СтрокаПокупателя.ИнформацияДляУчастника = ЭлектронноеАктированиеЕИС.НачальныйИндексИнформацииУчастникаПокупателя();
			КонецЕсли;
		КонецЕсли;
		// Конец ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС

		ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ТаблицаПокупателей, "СведенияОПокупателе");
	КонецЕсли;	
		
	Если ЭтоКомиссия Тогда
		// Получателем данного счета-фактуры является комиссионер. Поместим данные о получателе в доп. данные.
		СведенияОКомиссионере = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(ДанныеШапки.Ссылка.Комиссионер, , ДанныеШапки.Дата);
		ЗаполнитьДанныеУчастникаУПД_2019(ДеревоДанных, СведенияОКомиссионере, "СведенияОКомиссионере", "Юр", ДанныеШапки.Дата);
		Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ДанныеШапки, "ПредставлениеВыставленКомиссионеру")
															И ЗначениеЗаполнено(ДанныеШапки.ПредставлениеВыставленКомиссионеру) Тогда
			ПутьВДереве = "ДопДанныеСчетаФактуры.ТекстоваяИнформация";
			ДобавитьДопополнительныеДанныеВДерево(ДеревоДанных, "ДополнительныеСведенияОКомиссионере",
				ДанныеШапки.ПредставлениеВыставленКомиссионеру, ПутьВДереве);
		КонецЕсли;		
	КонецЕсли;
	
	Если ТипЗнч(ДокументОтгрузки) = Тип("ДокументСсылка.ОтчетКомитентуОЗакупках")
		И СтруктураДанных.Свойство("РезультатПоПоставщикам")
		И ЗначениеЗаполнено(СведенияОПокупателе) И СтруктураЭД.Функция = "СвЗК" Тогда
		СоставительДокументаНаименование = СведенияОПокупателе.ПолноеНаименование
			+ ?(ЗначениеЗаполнено(СведенияОПокупателе.КПП),
				СтрШаблон(НСтр("ru = ', ИНН/КПП %1/%2'"), СведенияОПокупателе.ИНН, СведенияОПокупателе.КПП),
				СтрШаблон(НСтр("ru = ', ИНН %1'"), СведенияОПокупателе.ИНН));
	Иначе
		СоставительДокументаНаименование = СведенияОПоставщике.ПолноеНаименование
			+ ?(ЗначениеЗаполнено(СведенияОПоставщике.КПП),
				СтрШаблон(НСтр("ru = ', ИНН/КПП %1/%2'"), СведенияОПоставщике.ИНН, СведенияОПоставщике.КПП),
				СтрШаблон(НСтр("ru = ', ИНН %1'"), СведенияОПоставщике.ИНН));
	КонецЕсли;

	// ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС
	Если ЭтоЭлектронноеАктированиеЕИС Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
			"СоставительДокументаНаименование", НаименованиеПоставщикаДляЕИС);
	Иначе
	// Конец ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС

		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
			"СоставительДокументаНаименование", СоставительДокументаНаименование);

	// ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС
	КонецЕсли;
	// Конец ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС

	
	ТаблицаТоваров = Новый ТаблицаЗначений;
	ТаблицаТоваров.Колонки.Добавить("НомерСтроки", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(6)));
	ТаблицаТоваров.Колонки.Добавить("ТоварНаименование");
	ТаблицаТоваров.Колонки.Добавить("ЕдиницаИзмеренияКод");
	ТаблицаТоваров.Колонки.Добавить("ЕдиницаИзмеренияНаименование");
	ТаблицаТоваров.Колонки.Добавить("Количество");
	ТаблицаТоваров.Колонки.Добавить("ЦенаЗаЕдиницуИзмерения");
	ТаблицаТоваров.Колонки.Добавить("СтоимостьТоваровБезНалога");
	ТаблицаТоваров.Колонки.Добавить("НалоговаяСтавка");
	ТаблицаТоваров.Колонки.Добавить("СтоимостьТоваровСНалогом");
	ТаблицаТоваров.Колонки.Добавить("СуммаАкциза", Новый ОписаниеТипов("Число"));
	ТаблицаТоваров.Колонки.Добавить("СуммаНалога", Новый ОписаниеТипов("Число"));
	ТаблицаТоваров.Колонки.Добавить("СведенияОТаможеннойДекларации");
	ТаблицаТоваров.Колонки.Добавить("СведенияОПрослеживаемости");
	ТаблицаТоваров.Колонки.Добавить("ДокументОснование");
	ТаблицаТоваров.Колонки.Добавить("СтранаПроисхожденияНаименование");
	ТаблицаТоваров.Колонки.Добавить("Признак");
	ТаблицаТоваров.Колонки.Добавить("ТоварКод");
	ТаблицаТоваров.Колонки.Добавить("ТоварИдентификатор");
	ТаблицаТоваров.Колонки.Добавить("КодВидаТовара");
	ТаблицаТоваров.Колонки.Добавить("Сопоставление");
	ТаблицаТоваров.Колонки.Добавить("СведенияОДокументеОтгрузки");
	ТаблицаТоваров.Колонки.Добавить("СведенияОМаркировке");
	// ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС
	ТаблицаТоваров.Колонки.Добавить("ИдентификаторМестаПоставкиЕИС");
	// Конец ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС
	
	ВыборкаПоДокументам = СтруктураДанных.РезультатПоТабличнойЧасти.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	ВыборкаПоДокументам.Следующий();
	СтрокаТовары = ВыборкаПоДокументам.Выбрать();
	КоличествоЗаписей = СтрокаТовары.Количество();
	
	Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ДанныеШапки, "ПредставлениеСтроки5а")
			И ЗначениеЗаполнено(ДанныеШапки.ПредставлениеСтроки5а) Тогда
			
		ДокументыПодтвержденияОтгрузки = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(ДеревоДанных, "ДокументыПодтвержденияОтгрузки");
		СтрокаДокументыПодтвержденияОтгрузки = ДокументыПодтвержденияОтгрузки.Добавить();

		Если СтруктураЭД.Функция = "СЧФ" Тогда
			МассивЧастей = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(ДанныеШапки.ПредставлениеСтроки5а, ";");
			НаименованиеДокумента = ?(ДанныеШапки.ТолькоУслуги, НСтр("ru = 'Акт'"), НСтр("ru = 'Товарная накладная'"));
			
			СтрокаДокументыПодтвержденияОтгрузки.Наименование = НаименованиеДокумента;

			Если МассивЧастей.Количество() > 1 Тогда
				ПредставленияДокументов = Новый Массив;
				Для Каждого ЭлементМассива Из МассивЧастей Цикл
					ПредставленияДокументов.Добавить(
						СтрШаблон(
							НСтр("ru = '%1, %2'"),
							НаименованиеДокумента,
							ЭлементМассива));
				КонецЦикла;
				ПредставлениеСтроки5а = СтрСоединить(ПредставленияДокументов, "; ");
			Иначе
				ПредставлениеСтроки5а =
					СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						НСтр("ru = '%1, %2'"),
						НаименованиеДокумента,
						МассивЧастей[0]);
			КонецЕсли;

			Если ДокументОтгрузки.Дата < Дата('20241001') Тогда
				ПредставлениеСтроки5а = ДанныеШапки.ПредставлениеСтроки5а;
			КонецЕсли;
			
			НомерДокументаОтгрузки = ПрефиксацияОбъектовКлиентСервер.НомерНаПечать(ДокументОтгрузки.Номер);		
			СтрокаДокументыПодтвержденияОтгрузки.Номер = НомерДокументаОтгрузки;
			СтрокаДокументыПодтвержденияОтгрузки.Дата = ДокументОтгрузки.Дата;
		Иначе			
			СтрокаДокументыПодтвержденияОтгрузки.Наименование = НСтр("ru = 'Универсальный передаточный документ'");
			
			ПредставлениеСтроки5а = СтрокаДокументыПодтвержденияОтгрузки.Наименование + ", " + СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						НСтр("ru = '№ %1 от %2'"),
						ДанныеШапки.Номер,
						Формат(ДанныеШапки.Дата, "ДЛФ=ДД"));
		
			СтрокаДокументыПодтвержденияОтгрузки.Номер = ДанныеШапки.Номер;
			СтрокаДокументыПодтвержденияОтгрузки.Дата = ДанныеШапки.Дата;
			
			Если ДокументОтгрузки.Дата < Дата('20241001') Тогда
				КоличествоСтрок = СтрокаТовары.Количество();
				ПредставлениеСтроки5а = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
							НСтр("ru = '№ п/п %1 № %2 от %3'"),
							?(КоличествоСтрок = 1, "1" , "1-" + Формат(КоличествоСтрок, "ЧГ=0")),
							ДанныеШапки.Номер,
							Формат(ДанныеШапки.Дата, "ДЛФ=ДД"));
			КонецЕсли;
			
		КонецЕсли;
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументОбОтгрузке", ПредставлениеСтроки5а);		
		ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ДокументыПодтвержденияОтгрузки, "ДокументыПодтвержденияОтгрузки");
		
	КонецЕсли; 
	
	ЕстьТовары = Ложь;
	ЕстьУслуги = Ложь;
	ЕстьРаботы = Ложь;
	
	ИспользоватьНаборы = Ложь;
	Если ОбщегоНазначенияУТКлиентСервер.ЕстьРеквизитОбъекта(ВыборкаПоДокументам, "ЭтоНабор") Тогда
		ИспользоватьНаборы = Истина;
	КонецЕсли;
	
	ЗаполнятьСопоставление = Истина;
	Если ТипЗнч(ДокументОтгрузки) = Тип("ДокументСсылка.РеализацияУслугПрочихАктивов")
			Или ВидСчетаФактуры = "Авансовый" Тогда
		ЗаполнятьСопоставление = Ложь;
	КонецЕсли;
	
	ТаблицаКодовМаркировки = Неопределено;
	СтруктураДанных.Свойство("Маркировка", ТаблицаКодовМаркировки);
	
	ЗаполнениеКодаТовара = СтруктураЭД.ВариантыЗаполненияПолей.ТоварКод;
	Если ЗначениеЗаполнено(СведенияОПокупателе) Тогда
		ВыводитьКодыТНВЭД = ВыводитьКодыТНВЭД(СведенияОПокупателе.СтранаРегистрации, ДанныеШапки.Дата);
	Иначе
		ВыводитьКодыТНВЭД = Ложь;
	КонецЕсли;

	НомерСтроки = 1;
	
	ШтрихкодыКомбинаций = Неопределено;
	ШтрихкодыНоменклатуры = Неопределено;
	НоменклатураПартнеровСервер.ШтрихкодыПоТоварам(СтрокаТовары, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры);	

	Если ЗаполнятьСопоставление Тогда
		ВыборкаДляСопоставления = НоменклатураПартнеровСервер.ВыборкаДляСопоставленияНоменклатуры(ДокументОтгрузки);
		СоответствиеСтавокНДСКонтрагента = Новый Соответствие;
		ЗаполнитьСоответствиеСтавокНДС(СоответствиеСтавокНДСКонтрагента);	
		ТаблицаСопоставления = ВыборкаДляСопоставления.Выгрузить();
	КонецЕсли;
	
	// Получение данных по прослеживаемости
	ТаблицаДанныхПрослеживаемости = Неопределено;
	СтруктураДанных.Свойство("Прослеживаемость", ТаблицаДанныхПрослеживаемости);
	
	// Получение данных о прослеживаемых комплектующих
	ПрослеживаемыеКомплектующие = Неопределено;
	СтруктураДанных.Свойство("ПрослеживаемыеКомплектующие", ПрослеживаемыеКомплектующие);

	ВыводитьСерии = Константы.ВыводитьСерииВПечатныхФормах.Получить() 
					И СтруктураДанных.РезультатПоТабличнойЧасти.Колонки.Найти("СерияНаименование") <> Неопределено;
	
	Пока СтрокаТовары.Следующий() Цикл
		
		Если ИспользоватьНаборы Тогда
			Если СтрокаТовары.ЭтоНабор и СтрокаТовары.ВариантПредставленияНабораВПечатныхФормах <> Перечисления.ВариантыПредставленияНаборовВПечатныхФормах.ТолькоНабор Тогда
				Продолжить;
			КонецЕсли;
		КонецЕсли;
		
		Если Не (ЗначениеЗаполнено(СтрокаТовары.Номенклатура) или ЗначениеЗаполнено(СтрокаТовары.НоменклатураНаименование))  Тогда
			Продолжить;
		КонецЕсли;	
			
		Если ЗначениеЗаполнено(СтрокаТовары.Номенклатура) Тогда
			Если СтрокаТовары.Номенклатура.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Товар 
				или СтрокаТовары.Номенклатура.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Набор Тогда
				ЕстьТовары = Истина;
			ИначеЕсли СтрокаТовары.Номенклатура.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Услуга Тогда
				ЕстьУслуги = Истина;
			ИначеЕсли СтрокаТовары.Номенклатура.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Работа Тогда
				ЕстьРаботы = Истина;
			КонецЕсли;
		КонецЕсли;
		
		СуммаСНДС   = Окр(СтрокаТовары.СуммаСНДС, 2);
		СуммаНДС    = Окр(СтрокаТовары.СуммаНДС, 2);
		СуммаБезНДС = Окр(СтрокаТовары.СуммаБезНДС, 2);
		
		НовСтрока = ТаблицаТоваров.Добавить();
		ЗаполнитьЗначенияСвойств(НовСтрока, СтрокаТовары);
		НовСтрока.НомерСтроки = НомерСтроки;
		НомерСтроки = НомерСтроки + 1;

		СерияНаименование = Неопределено;
		Если ВыводитьСерии Тогда
			СерияНаименование = СтрокаТовары.СерияНаименование;
		КонецЕсли;	
		
		НовСтрока.ТоварНаименование  = НоменклатураКлиентСервер.ПредставлениеНоменклатурыДляПечати(
			СтрокаТовары.НоменклатураНаименование,
			СтрокаТовары.ХарактеристикаНаименование
			,
			СерияНаименование
			) + ?(СтрокаТовары.ЭтоВозвратнаяТара, НСтр("ru = ' (возвратная тара)'"), "");
			
		Если ЗначениеЗаполнено(СтрокаТовары.Номенклатура) Тогда
			НовСтрока.ТоварИдентификатор = Строка(СтрокаТовары.Номенклатура.УникальныйИдентификатор());
		КонецЕсли;
		Если ОблагаетсяНДССМежценовойРазницы Тогда 
			НовСтрока.НалоговаяСтавка = УчетНДСРФВызовСервера.СтавкаНДСПоЗначениюПеречисления(СтрокаТовары.СтавкаНДС.ПеречислениеСтавкаНДС, Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС);
		Иначе
			НовСтрока.НалоговаяСтавка = СтрокаТовары.СтавкаНДС;
		КонецЕсли;
			
		НовСтрока.ЦенаЗаЕдиницуИзмерения    = Окр(СтрокаТовары.Цена, 2);
		НовСтрока.СтоимостьТоваровБезНалога = СуммаБезНДС;
		НовСтрока.СуммаНалога               = СуммаНДС;
		НовСтрока.СтоимостьТоваровСНалогом  = СуммаСНДС;
		
		Если НДСИсчисляетсяНалоговымАгентом Тогда
			НовСтрока.НалоговаяСтавка          = "НДС исчисляется налоговым агентом";
			НовСтрока.СуммаНалога              = 0;
			НовСтрока.СтоимостьТоваровСНалогом = 0;
		КонецЕсли;		
		
		УпаковкаИзДокумента = Неопределено;
		Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(СтрокаТовары, "Упаковка") И ЗначениеЗаполнено(СтрокаТовары.Упаковка) Тогда
			УпаковкаИзДокумента = СтрокаТовары.Упаковка;
		ИначеЕсли ЗаполнятьСопоставление Тогда
			УпаковкаИзДокумента = ЭлектронноеВзаимодействиеУТВызовСервера.ЕдиницаХраненияНоменклатуры(СтрокаТовары.Номенклатура)
		Иначе
			УпаковкаИзДокумента = Справочники.УпаковкиЕдиницыИзмерения.ПустаяСсылка()
		КонецЕсли;

		Если ЗаполнятьСопоставление Тогда
			// Сопоставление.
			ПараметрыОтбора = Новый Структура;
			ПараметрыОтбора.Вставить("Номенклатура", СтрокаТовары.Номенклатура);
			Если СтрокаТовары.Характеристика <> Неопределено Тогда
				ПараметрыОтбора.Вставить("Характеристика", СтрокаТовары.Характеристика);
			Иначе
				ПараметрыОтбора.Вставить("Характеристика", Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());
			КонецЕсли;
			ПараметрыОтбора.Вставить("Упаковка", УпаковкаИзДокумента);
			СтрокиИзНоменклатурыКонтрагентов = ТаблицаСопоставления.НайтиСтроки(ПараметрыОтбора);
			Если СтрокиИзНоменклатурыКонтрагентов.Количество() Тогда
				НайденнаяСтрока = СтрокиИзНоменклатурыКонтрагентов[0];
				НовСтрока.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(НайденнаяСтрока,,,,СоответствиеСтавокНДСКонтрагента);
		    Иначе
				НовСтрока.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(СтрокаТовары, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры, УпаковкаИзДокумента);
			КонецЕсли;
			
			Если ОблагаетсяНДССМежценовойРазницы
				И ТипЗнч(НовСтрока.Сопоставление.СтавкаНДС) = Тип("СправочникСсылка.СтавкиНДС") Тогда
				НовСтрока.Сопоставление.СтавкаНДС = УчетНДСРФВызовСервера.СтавкаНДСПоЗначениюПеречисления(НовСтрока.Сопоставление.СтавкаНДС.ПеречислениеСтавкаНДС, Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС);
			КонецЕсли;
		КонецЕсли;
		
		Если Не ВидСчетаФактуры = "Авансовый" Тогда
			НовСтрока.ЕдиницаИзмеренияКод = СокрЛП(СтрокаТовары.ЕдиницаИзмеренияКод);
			НовСтрока.ЕдиницаИзмеренияНаименование = СокрЛП(СтрокаТовары.ЕдиницаИзмеренияНаименование);
			//Анализ вариантов заполнения
			Если ЗаполнениеКодаТовара = "Штрихкод" И НовСтрока.Сопоставление.Свойство("ШтрихкодКомбинации") Тогда
				НовСтрока.ТоварКод = НовСтрока.Сопоставление.ШтрихкодКомбинации;
			ИначеЕсли ЗаполнениеКодаТовара = "Штрихкод" И (НовСтрока.Сопоставление.Свойство("ШтрихкодыНоменклатуры") И НовСтрока.Сопоставление.ШтрихкодыНоменклатуры.Количество()) Тогда
				НовСтрока.ТоварКод = НовСтрока.Сопоставление.ШтрихкодыНоменклатуры[0];				
			Иначе
				НовСтрока.ТоварКод = СтрокаТовары.НоменклатураКод;
			КонецЕсли;
			//Конец анализа вариантов заполнения
		КонецЕсли;

		Если ЗначениеЗаполнено(СтрокаТовары.СтранаПроисхождения) Тогда
			НовСтрока.СтранаПроисхожденияНаименование = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтрокаТовары.СтранаПроисхождения, "Наименование");
		КонецЕсли;
		
		НовСтрока.Признак = ОпределитьПризнакТовара(СтрокаТовары.Номенклатура, ДокументОтгрузки);
		
		Если Не ЭтоКомиссия 
			 И Не ВидСчетаФактуры = "Авансовый"   
			 И ТипЗнч(ДокументОтгрузки) <> Тип("ДокументСсылка.АктВыполненныхРабот")
			 И ТипЗнч(ДокументОтгрузки) <> Тип("ДокументСсылка.ВозвратТоваровПоставщику")
			 И ТипЗнч(ДокументОтгрузки) <> Тип("ДокументСсылка.ВыкупТоваровХранителем")
			 И ТипЗнч(ДокументОтгрузки) <> Тип("ДокументСсылка.КорректировкаРеализации") 
			 И ТипЗнч(ДокументОтгрузки) <> Тип("ДокументСсылка.РеализацияУслугПрочихАктивов") 
			 И ТипЗнч(ДокументОтгрузки) <> Тип("ДокументСсылка.ВозвратТоваровМеждуОрганизациями") 
			 И ЗначениеЗаполнено(СтрокаТовары.КодТНВЭД) И ВыводитьКодыТНВЭД Тогда
			
			НовСтрока.КодВидаТовара = СтрокаТовары.КодТНВЭД.Код;
		ИначеЕсли ВидСчетаФактуры = "Авансовый" 
			И ЗначениеЗаполнено(СтрокаТовары.Номенклатура.КодТНВЭД) И ВыводитьКодыТНВЭД Тогда
			
			НовСтрока.КодВидаТовара = СтрокаТовары.Номенклатура.КодТНВЭД.Код;
		КонецЕсли;
		
		//Заполнение Таможенной декларации
		ЗаполнитьСведенияОТаможеннойДекларации(НовСтрока, СтрокаТовары);
		//Конец заполнения Таможенной декларации
		
		// Заполнение прослеживаемости
		Если ЗначениеЗаполнено(СтрокаТовары.КоличествоПоРНПТ) Тогда
			ЗаполнитьСведенияОПрослеживаемостиУПД(НовСтрока, СтрокаТовары, ПрослеживаемыеКомплектующие)
		ИначеЕсли ЗначениеЗаполнено(ТаблицаДанныхПрослеживаемости) Тогда
			ЗаполнитьПрослеживаемостьДляРеализацииАктивов(НовСтрока,
															СтрокаТовары,
															ТаблицаДанныхПрослеживаемости,
															ВыводитьКодыТНВЭД);
		КонецЕсли;
		// Конец заполнения прослеживаемости
		
		ЭлектронноеВзаимодействиеИСМП.ЗаполнитьСведенияОМаркировке_2019(НовСтрока, СтрокаТовары, ТаблицаКодовМаркировки);
		

		// ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС
		Если ЭтоЭлектронноеАктированиеЕИС Тогда
			НовСтрока.ИдентификаторМестаПоставкиЕИС = ИдентификаторМестаПоставкиЕИС;
			ЭлектронноеАктированиеЕИСУТ.ЗаполнитьДанныеПоСтрокеТоваровУПД_2019(НовСтрока, СтрокаТовары, СтруктураДанных, ДанныеПриложенияЕИС);
		КонецЕсли;
		// Конец ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС

		
	КонецЦикла;
	
	ЭлектронноеВзаимодействиеИСМП.ПроверитьСведенияОМаркировке_2019(ТаблицаКодовМаркировки, Отказ);
	
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
		"Количество",,, НСтр("ru = 'Не указано количество товара в табличной части'"));
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
		"ЕдиницаИзмеренияНаименование",,, НСтр("ru = 'Не заполнено наименование единицы измерения в справочнике ""Упаковки и единицы измерения"".'"));
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
		"ЕдиницаИзмеренияКод",,, НСтр("ru = 'Не заполнен код единицы измерения в справочнике ""Упаковки и единицы измерения"".'"));
	
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ТаблицаТоваров, "СведенияОТоварах");
	
	ТекстОшибки = НСтр("ru = 'Возникла ошибка при заполнении страны происхождения в сведениях по ГТД. Возможные причины:
		|	- не заполнена колонка ""Страна происхождения""
		|	- указанной страны нет в классификаторе стран мира'");
	ЭлектронноеВзаимодействие.ДобавитьВРеквизитОбработкуОшибки(ДеревоДанных,
			"СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации.НомерСтроки.СтранаПроисхожденияКод", ТекстОшибки);
	
	СоставСодержания = Новый Массив;
	Если Не ВидСчетаФактуры = "Авансовый" Тогда
		Если ЕстьТовары Тогда
			СоставСодержания.Добавить(НСтр("ru = 'Товары переданы.'"));
		КонецЕсли;
		Если ЕстьУслуги Тогда
			СоставСодержания.Добавить(НСтр("ru = 'Услуги оказаны в полном объеме.'"));
		КонецЕсли;
		Если ЕстьРаботы Тогда
			СоставСодержания.Добавить(НСтр("ru = 'Работы выполнены в полном объеме.'"));
		КонецЕсли;
		Если Не ЗначениеЗаполнено(СоставСодержания) Тогда
			СоставСодержания.Добавить(НСтр("ru = 'Товары переданы.'"));
		КонецЕсли;
	Иначе
		СоставСодержания.Добавить(НСтр("ru = 'Регистрация счет-фактуры на аванс.'"));
	КонецЕсли;
	СодержаниеОперации = СтрСоединить(СоставСодержания, " ");
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "СодержаниеОперации", СодержаниеОперации);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ВсегоКОплате.ВсегоСтоимостьТоваровБезНалога", ТаблицаТоваров.Итог("СтоимостьТоваровБезНалога"));
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ВсегоКОплате.ВсегоСтоимостьТоваровСНалогом", ТаблицаТоваров.Итог("СтоимостьТоваровСНалогом"));
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ВсегоКОплате.ВсегоСуммаНалога", ТаблицаТоваров.Итог("СуммаНалога"));
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ВсегоКОплате.ВсегоКоличество", ТаблицаТоваров.Итог("Количество"));
	
	//Заполним документы основания.
	МассивДокументовОснований = Новый Массив;
	ИсправляемыйДокументЭтоКорректировка = Ложь;
	Если ТипЗнч(ДокументОтгрузки) <> Тип("ДокументСсылка.КорректировкаРеализации")
			и ТипЗнч(ДокументОтгрузки) <> Тип("ДокументСсылка.РеализацияУслугПрочихАктивов")
			и ТипЗнч(ДокументОтгрузки) <> Тип("ДокументСсылка.ОтчетКомиссионера")
			и ТипЗнч(ДокументОтгрузки) <> Тип("ДокументСсылка.ОтчетКомитенту")
			и ТипЗнч(ДокументОтгрузки) <> Тип("ДокументСсылка.ВозвратТоваровПоставщику")
			И ТипЗнч(ДокументОтгрузки) <> Тип("ДокументСсылка.ВыкупТоваровХранителем")
			и ТипЗнч(ДокументОтгрузки) <> Тип("ДокументСсылка.ВозвратТоваровМеждуОрганизациями") 
			и ТипЗнч(ДокументОтгрузки) <> Тип("ДокументСсылка.ПередачаТоваровМеждуОрганизациями") 
			и Не ВидСчетаФактуры = "Авансовый" Тогда
			
		ЗаказКлиента = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОтгрузки, "ЗаказКлиента");
		Если ЗначениеЗаполнено(ЗаказКлиента) Тогда
			МассивДокументовОснований.Добавить(ЗаказКлиента);
		КонецЕсли;
	ИначеЕсли ТипЗнч(ДокументОтгрузки) = Тип("ДокументСсылка.КорректировкаРеализации") Тогда
		
		ДокументОснование = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОтгрузки, "ДокументОснование");
		МассивДокументовОснований.Добавить(ДокументОснование);		
		
		ВидКорректировки = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОтгрузки, "ВидКорректировки");
		Если ВидКорректировки =  Перечисления.ХозяйственныеОперации.ИсправлениеОшибок Тогда
			ИсправляемыйДокумент = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОтгрузки, "ИсправляемыйДокумент");
			Если ЗначениеЗаполнено(ИсправляемыйДокумент) И ИсправляемыйДокумент <> ДокументОснование Тогда
				ИсправляемыйДокументЭтоКорректировка = Истина;
				МассивДокументовОснований.Добавить(ИсправляемыйДокумент);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	Если МассивДокументовОснований.Количество() Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументыОснованияДокументаОтгрузки", МассивДокументовОснований);
	КонецЕсли;	
		
	Если ДанныеШапки.Исправление Тогда
		ВидОперацииЭД = Перечисления.ВидыОперацийЭД.Исправление;
	Иначе
		ВидОперацииЭД = Перечисления.ВидыОперацийЭД.ПродажаКомиссия;
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ВидОперации", ВидОперацииЭД);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаОтгрузкиТоваров", ДанныеШапки.Дата);
	
	Если Не ВидСчетаФактуры = "Авансовый" Тогда
		ОснованиеОтгрузкиТоваров = Новый ТаблицаЗначений;
		ОснованиеОтгрузкиТоваров.Колонки.Добавить("ДокументНаименование");
		ОснованиеОтгрузкиТоваров.Колонки.Добавить("ДокументНомер");
		ОснованиеОтгрузкиТоваров.Колонки.Добавить("ДокументДата");
		ОснованиеОтгрузкиТоваров.Колонки.Добавить("ДокументДопСведения");
		
		Если ЗначениеЗаполнено(ДанныеШапки.ДоверенностьНомер) И ЗначениеЗаполнено(ДанныеШапки.ДоверенностьДата)
			И (ЗначениеЗаполнено(ДанныеШапки.ДоверенностьВыдана) Или ЗначениеЗаполнено(ДанныеШапки.ДоверенностьЛицо)) Тогда
			
			НоваяСтрока = ОснованиеОтгрузкиТоваров.Добавить();
			НоваяСтрока.ДокументНаименование = НСтр("ru = 'по доверенности'");
			НоваяСтрока.ДокументНомер = ДанныеШапки.ДоверенностьНомер;
			НоваяСтрока.ДокументДата = ДанныеШапки.ДоверенностьДата;
			НоваяСтрока.ДокументДопСведения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'выданной %1 %2'"),
					ДанныеШапки.ДоверенностьВыдана,
					ДанныеШапки.ДоверенностьЛицо);
					
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(НоваяСтрока, "ДокументДата",,,
				НСтр("ru = 'Необходимо указать дату доверенности.'"));
					
		КонецЕсли;	
		
		Если ЗначениеЗаполнено(ДанныеШапки.Основание)
			И ЗначениеЗаполнено(ДанныеШапки.ОснованиеДата) Тогда
			НоваяСтрока = ОснованиеОтгрузкиТоваров.Добавить();
			Если СтрНайти(ДанныеШапки.Основание, "№") Тогда
				СтрокаНаименование = Лев(ДанныеШапки.Основание, СтрНайти(ДанныеШапки.Основание, "№") - 2);
				Если ПустаяСтрока(СтрокаНаименование) Тогда
					СтрокаНаименование = "Договор";
				КонецЕсли;
			Иначе
				СтрокаНаименование = ДанныеШапки.Основание;
			КонецЕсли;
			НоваяСтрока.ДокументНаименование = СтрокаНаименование;
			НоваяСтрока.ДокументНомер = ДанныеШапки.ОснованиеНомер;
			НоваяСтрока.ДокументДата = ДанныеШапки.ОснованиеДата;
			
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(НоваяСтрока, "ДокументДата",,,
				НСтр("ru = 'Необходимо указать дату договора.'"));
			
		КонецЕсли;
		
		Если ТипЗнч(ДокументОтгрузки) = Тип("ДокументСсылка.ВозвратТоваровПоставщику") Тогда
			Если ЗначениеЗаполнено(ДокументОтгрузки.ДокументПоступления) Тогда
				ДокументПоступления = ДокументОтгрузки.ДокументПоступления;
				Если ЗначениеЗаполнено(ДокументПоступления.ДатаВходящегоДокумента) И ЗначениеЗаполнено(ДокументПоступления.НомерВходящегоДокумента) Тогда
					НоваяСтрока = ОснованиеОтгрузкиТоваров.Добавить();
					НоваяСтрока.ДокументНаименование = "Входящий электронный документ";					
					НоваяСтрока.ДокументНомер = ДокументПоступления.НомерВходящегоДокумента;
					НоваяСтрока.ДокументДата = ДокументПоступления.ДатаВходящегоДокумента;
					
					ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(НоваяСтрока, "ДокументДата",,,
						НСтр("ru = 'Необходимо указать дату документа поступления.'"));
				КонецЕсли;
			КонецЕсли;
		ИначеЕсли ТипЗнч(ДокументОтгрузки) = Тип("ДокументСсылка.ОтчетКомитенту") Тогда
			Если ЗначениеЗаполнено(ДокументОтгрузки.Договор) Тогда
				ДопДанныеДокументаОтгрузки = ДеревоДанных.Строки.Найти("ДопДанныеДокументаОтгрузки", "ПолныйПуть");
				Если Не ДопДанныеДокументаОтгрузки = Неопределено
					И ЗначениеЗаполнено(ДокументОтгрузки.Договор.Дата)
					И ЗначениеЗаполнено(ДокументОтгрузки.Договор.Номер) Тогда
					
					ДопДанныеДокументаОтгрузки.Значение = Истина;
					
					ТекстоваяИнформация = Новый ТаблицаЗначений;
					ТекстоваяИнформация.Колонки.Добавить("Идентификатор");
					ТекстоваяИнформация.Колонки.Добавить("Значение");
					
					НоваяСтрока = ТекстоваяИнформация.Добавить();
					НоваяСтрока.Идентификатор = "ДатаДоговора";
					НоваяСтрока.Значение = Формат(ДокументОтгрузки.Договор.Дата,"ДФ=dd.MM.yyyy");
					ДеревоЭлектронногоДокументаБЭД.ДобавитьЗаписьВТаблицуДерева(
						ДопДанныеДокументаОтгрузки, НоваяСтрока, "ДопДанныеДокументаОтгрузки.ТекстоваяИнформация");
					
					НоваяСтрока = ТекстоваяИнформация.Добавить();
					НоваяСтрока.Идентификатор = "НомерДоговора";
					НоваяСтрока.Значение = ДокументОтгрузки.Договор.Номер;
					ДеревоЭлектронногоДокументаБЭД.ДобавитьЗаписьВТаблицуДерева(
						ДопДанныеДокументаОтгрузки, НоваяСтрока, "ДопДанныеДокументаОтгрузки.ТекстоваяИнформация");
					
				КонецЕсли;
			КонецЕсли;
		ИначеЕсли ТипЗнч(ДокументОтгрузки) = Тип("ДокументСсылка.ПередачаТоваровМеждуОрганизациями")
			Или ТипЗнч(ДокументОтгрузки) = Тип("ДокументСсылка.ВозвратТоваровМеждуОрганизациями") Тогда
				ДопДанныеДокументаОтгрузки = ДеревоДанных.Строки.Найти("ДопДанныеДокументаОтгрузки", "ПолныйПуть");
				Если Не ДопДанныеДокументаОтгрузки = Неопределено Тогда
					ИдентификаторПередачи = Строка(ДокументОтгрузки.УникальныйИдентификатор());
					ПутьВДереве = "ДопДанныеДокументаОтгрузки.ТекстоваяИнформация";
					ДобавитьДопополнительныеДанныеВДерево(ДеревоДанных, "ИдентификаторПередачи", ИдентификаторПередачи, ПутьВДереве);
				КонецЕсли;
		ИначеЕсли ИсправляемыйДокументЭтоКорректировка Тогда
				ДопДанныеДокументаОтгрузки = ДеревоДанных.Строки.Найти("ДопДанныеДокументаОтгрузки", "ПолныйПуть");
				Если Не ДопДанныеДокументаОтгрузки = Неопределено Тогда
					ИдентификаторПередачи = Строка(ДокументОтгрузки.УникальныйИдентификатор());
					ПутьВДереве = "ДопДанныеДокументаОтгрузки.ТекстоваяИнформация";
					ДобавитьДопополнительныеДанныеВДерево(ДеревоДанных, "ИсправляемыйДокументЭтоКорректировка", Истина, ПутьВДереве);
				КонецЕсли;				
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ОснованиеОтгрузкиТоваров) Тогда
			ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ОснованиеОтгрузкиТоваров, "ОснованиеОтгрузкиТоваров");
	    КонецЕсли;
		
		Если ЗначениеЗаполнено(ДанныеШапки.Кладовщик) Тогда
			ФИО = ФизическиеЛицаКлиентСервер.ЧастиИмени(ДанныеШапки.Кладовщик);
			Если ЗначениеЗаполнено(ДанныеШапки.ДолжностьКладовщика)
				И ЗначениеЗаполнено(ДанныеШапки.Кладовщик) Тогда
				// Кладовщик работает в организации
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Должность", Строка(ДанныеШапки.ДолжностьКладовщика));
					
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Фамилия", ФИО.Фамилия);
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Имя", ФИО.Имя);
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Отчество", ФИО.Отчество);
			ИначеЕсли ЗначениеЗаполнено(ДанныеШапки.Кладовщик) Тогда
				// Кладовщик не работает в организации
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Фамилия", ФИО.Фамилия);
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Имя", ФИО.Имя);
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Отчество", ФИО.Отчество);
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
	Если ТипЗнч(ДокументОтгрузки) = Тип("ДокументСсылка.КорректировкаРеализации") Тогда
		Если ТипЗнч(ДокументОтгрузки.ДокументОснование) = Тип("ДокументСсылка.ПервичныйДокумент") Тогда
			ПутьВДереве = "ДопДанныеСчетаФактуры.ТекстоваяИнформация";
			ДобавитьДопополнительныеДанныеВДерево(ДеревоДанных, "ДокументОснованиеПервичныйДокумент", Истина, ПутьВДереве);
		КонецЕсли;
	КонецЕсли;
			
КонецПроцедуры

Процедура ЗаполнитьДанныеСчетаФактурыУПД_2019(СтруктураДанных, СтруктураЭД, ДеревоДанных, Отказ) Экспорт
	
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	
	ДанныеШапки = СтруктураДанных.РезультатПоШапке.Выбрать();
	ДанныеШапки.Следующий();
	
	Если Не ЗначениеЗаполнено(ДанныеШапки.Ссылка) Тогда
		ВидОперации = НСтр("ru = 'Формирование ЭД'");
		ПодробныйТекстОшибки = НСтр("ru = 'Ошибка при формирование ЭД. Ошибка в документе-основании.'");
		ТекстСообщения = НСтр("ru = 'Невозможно сформировать ЭД. Проверьте корректность заполнения данных в счете-фактуре и документе-основании.'");
		ЭлектронноеВзаимодействие.ОбработатьОшибку(ВидОперации, ПодробныйТекстОшибки, ТекстСообщения);
		Отказ = Истина;
		Возврат
	КонецЕсли;	
	
	Если СтруктураДанных.Свойство("СчетФактураНаАванс") И СтруктураДанных.СчетФактураНаАванс Тогда
		ВидСчетаФактуры = "Авансовый";
	Иначе
		ВидСчетаФактуры = "Реализация";
	КонецЕсли;
	
	СчетФактура = ДанныеШапки.Ссылка;	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "СсылкаСчетаФактуры",	СчетФактура);	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ВидСчетаФактуры", ВидСчетаФактуры);
	ДокументыОснования = Новый Массив;
	Если ДанныеШапки.ПредставлениеДокумента = "счет-фактура комиссионера" или ВидСчетаФактуры = "Авансовый" Тогда
		Если ТипЗнч(СчетФактура.ДокументОснование) <> Тип("ДокументСсылка.ОтчетКомиссионера")
		            И ТипЗнч(СчетФактура.ДокументОснование) <> Тип("ДокументСсылка.ОтчетКомиссионераОСписании") Тогда
			ДокументыОснования.Добавить(СчетФактура.ДокументОснование);
		КонецЕсли;
	Иначе
		Для Каждого СтрокаТЧ Из СчетФактура.ДокументыОснования Цикл
			ДокументыОснования.Добавить(СтрокаТЧ.ДокументОснование);
		КонецЦикла;	
		Если ДанныеШапки.Исправление И ЗначениеЗаполнено(СчетФактура.СчетФактураОснование) Тогда
			ДокументыОснования.Добавить(СчетФактура.СчетФактураОснование);
		КонецЕсли;		
	КонецЕсли;
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументыОснованияСчетаФактуры", ДокументыОснования);
	
	ОбстоятельстваФормированияСФ = "";
	Если ДанныеШапки.ПредставлениеДокумента = "счет-фактура комиссионера" Тогда
		ОбстоятельстваФормированияСФ = "3";
	ИначеЕсли ВидСчетаФактуры = "Авансовый" Тогда
		ОбстоятельстваФормированияСФ = "2";
	ИначеЕсли ВидСчетаФактуры = "Реализация" Тогда
		ОбстоятельстваФормированияСФ = "1";
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ДополнительныеСведенияОбУчастниках.ОбстоятельстваФормированияСФ", ОбстоятельстваФормированияСФ);
	
	Если ДанныеШапки.ПредставлениеДокумента <> "счет-фактура комиссионера" Тогда	
		Если ЗначениеЗаполнено(ДанныеШапки.ИдентификаторГосКонтракта) Тогда
			ЭтоГОЗ = Истина;			
			Если СтруктураДанных.Свойство("ДанныеЭлектронногоАктирования") Тогда
				ЭтоГОЗ = Ложь;
				ДанныеЭлектронногоАктированияЕИС = СтруктураДанных.ДанныеЭлектронногоАктирования;
				Если ДанныеЭлектронногоАктированияЕИС.ДанныеГосконтракта.Количество() Тогда
					ДанныеКонтракта = ДанныеЭлектронногоАктированияЕИС.ДанныеГосконтракта[0];
					Если ЗначениеЗаполнено(ДанныеКонтракта) Тогда
						ТипНаправленияДеятельности = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДанныеКонтракта.Ссылка, "ТипНаправленияДеятельности");
						ЭтоГОЗ = (ТипНаправленияДеятельности = Перечисления.ТипыНаправленийДеятельности.КонтрактГОЗ);
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			Если ЭтоГОЗ Тогда 
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДополнительныеСведенияОбУчастниках.ИдентификаторГосКонтракта", ДанныеШапки.ИдентификаторГосКонтракта);
			КонецЕсли;	
		КонецЕсли;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СчетФактура) Тогда
		
		ПлатежныеДокументы = Новый ТаблицаЗначений;
		ПлатежныеДокументы.Колонки.Добавить("НомерСтроки");
		ПлатежныеДокументы.Колонки.Добавить("НомерПРД");
		ПлатежныеДокументы.Колонки.Добавить("ДатаПРД");
		
		Если ВидСчетаФактуры = "Реализация" Тогда
			Если ЗначениеЗаполнено(СчетФактура.ПлатежноРасчетныеДокументы) Тогда
				Для Каждого СтрокаПРД Из СчетФактура.ПлатежноРасчетныеДокументы Цикл
					НоваяСтрока = ПлатежныеДокументы.Добавить();
					НоваяСтрока.НомерСтроки = СтрокаПРД.НомерСтроки;
					НоваяСтрока.НомерПРД    = СтрокаПРД.НомерПлатежноРасчетногоДокумента;
					НоваяСтрока.ДатаПРД     = СтрокаПРД.ДатаПлатежноРасчетногоДокумента;
				КонецЦикла;
			ИначеЕсли ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(СтруктураДанных, "ПлатежноРасчетныеДокументы")
																	И ЗначениеЗаполнено(СтруктураДанных.ПлатежноРасчетныеДокументы) Тогда
				Для Каждого СтрокаПРД Из СтруктураДанных.ПлатежноРасчетныеДокументы Цикл
					НоваяСтрока = ПлатежныеДокументы.Добавить();
					НоваяСтрока.НомерПРД    = СтрокаПРД.НомерПлатежноРасчетногоДокумента;
					НоваяСтрока.ДатаПРД     = СтрокаПРД.ДатаПлатежноРасчетногоДокумента;
				КонецЦикла;
			КонецЕсли;
		Иначе
			НоваяСтрока = ПлатежныеДокументы.Добавить();
			НоваяСтрока.НомерСтроки = 1;
			НоваяСтрока.НомерПРД    = СчетФактура.НомерПлатежноРасчетногоДокумента;
			НоваяСтрока.ДатаПРД     = СчетФактура.ДатаПлатежноРасчетногоДокумента;
		КонецЕсли;	
		
		ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ПлатежныеДокументы, "ПлатежноРасчетныеДокументы");
		
		Если ТипЗнч(СчетФактура.Контрагент) = Тип("СправочникСсылка.Организации") Тогда
				
			ИдентификаторСЧФ = Строка(ДанныеШапки.Ссылка.УникальныйИдентификатор());
			ДобавитьДопополнительныеДанныеВДерево(ДеревоДанных, "ИдентификаторСЧФ", ИдентификаторСЧФ, "ДопДанныеСчетаФактуры.ТекстоваяИнформация");
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьДанныеУчастникаУПД_2019(ДеревоДанных, СведенияОбУчастнике, ВидУчастника, ВидАдреса = "Юр", ДатаКИ = Неопределено) Экспорт
	
	Если СведенияОбУчастнике.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ЮрЛицо Тогда
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН", СведенияОбУчастнике.ИНН);			
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП", СведенияОбУчастнике.КПП);			
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.НаименованиеОрганизации", СведенияОбУчастнике.ПолноеНаименование);

	ИначеЕсли СведенияОбУчастнике.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ЮрЛицоНеРезидент Тогда
	
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ИЛ.НаименованиеОрганизации", СведенияОбУчастнике.ПолноеНаименование);
			
	ИначеЕсли СведенияОбУчастнике.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ИндивидуальныйПредприниматель Тогда
			
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН", СведенияОбУчастнике.ИНН);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.СвидетельствоОГосРегистрации", СведенияОбУчастнике.Свидетельство);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.Фамилия", СведенияОбУчастнике.Фамилия);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.Имя", СведенияОбУчастнике.Имя);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.Отчество", СведенияОбУчастнике.Отчество);
			
	Иначе
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.ИНН", СведенияОбУчастнике.ИНН);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.Фамилия", СведенияОбУчастнике.Фамилия);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.Имя", СведенияОбУчастнике.Имя);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.Отчество", СведенияОбУчастнике.Отчество);
		
	КонецЕсли;
	
	Если ТипЗнч(СведенияОбУчастнике.Ссылка) = Тип("СправочникСсылка.Организации") Тогда
		ВидКонтактнойИнформации = Справочники.ВидыКонтактнойИнформации[ВидАдреса + "АдресОрганизации"].Ссылка;
	ИначеЕсли ТипЗнч(СведенияОбУчастнике.Ссылка) = Тип("СправочникСсылка.Контрагенты") Тогда
		ВидКонтактнойИнформации = Справочники.ВидыКонтактнойИнформации[ВидАдреса + "АдресКонтрагента"].Ссылка;
	Иначе
		ВидКонтактнойИнформации = Неопределено;
	КонецЕсли;
	
	ИспользоватьПартнеровКакКонтрагентов = ПолучитьФункциональнуюОпцию("ИспользоватьПартнеровКакКонтрагентов");
	ОбъектКонтактнойИнформации = СведенияОбУчастнике.Ссылка;
	
	АдресКонтрагентаЗаполнен = Истина;	
	Если ТипЗнч(СведенияОбУчастнике.Ссылка) = Тип("СправочникСсылка.Контрагенты") Тогда
		ПроверкаЗаполненностиАдреса = УправлениеКонтактнойИнформацией.КонтактнаяИнформацияОбъекта(
			ОбъектКонтактнойИнформации,
			ВидКонтактнойИнформации,
			ТекущаяДатаСеанса());
		АдресКонтрагентаЗаполнен = Ложь;
		Если ЗначениеЗаполнено(ПроверкаЗаполненностиАдреса) Тогда
			АдресКонтрагентаЗаполнен = Истина;
		КонецЕсли;
	КонецЕсли;
	
	Если ИспользоватьПартнеровКакКонтрагентов И Не АдресКонтрагентаЗаполнен Тогда
		ВидКонтактнойИнформации = Справочники.ВидыКонтактнойИнформации["АдресПартнера"].Ссылка;		
		ОбъектКонтактнойИнформации = СведенияОбУчастнике.Ссылка.Партнер;	
	КонецЕсли;

	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		ДеревоДанных, ВидУчастника + ".Адрес.АвтоматическиЗаполняемый.ОбъектКонтактнойИнформации", ОбъектКонтактнойИнформации);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		ДеревоДанных, ВидУчастника + ".Адрес.АвтоматическиЗаполняемый.ВидКонтактнойИнформации", ВидКонтактнойИнформации);
	
	Если ЗначениеЗаполнено(СведенияОбУчастнике.Телефоны) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".КонтактныеСведения.Телефон",
									СведенияОбУчастнике.Телефоны);
	КонецЕсли;

	Если ЗначениеЗаполнено(СведенияОбУчастнике.ЭлектроннаяПочта) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".КонтактныеСведения.ЭлектроннаяПочта",
									СведенияОбУчастнике.ЭлектроннаяПочта);
	КонецЕсли;
	
	НомерСчета = "";
	Если СведенияОбУчастнике.Свойство("НомерСчета", НомерСчета) И ЗначениеЗаполнено(НомерСчета) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДанных,
				ВидУчастника + ".БанковскиеРеквизиты.НомерСчета",
				НомерСчета);
				
		Банк = ""; БИК = ""; КоррСчет = "";
		Если СведенияОбУчастнике.Свойство("Банк", Банк) И ЗначениеЗаполнено(Банк) Тогда
			Если ТипЗнч(Банк) = Тип("Строка") Тогда
				БанкНаименование = Банк
			Иначе
				БанкНаименование = Банк.Наименование
			КонецЕсли;
			
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
										ДеревоДанных,
										ВидУчастника + ".БанковскиеРеквизиты.НаименованиеБанка",
										БанкНаименование);
		КонецЕсли;
		Если СведенияОбУчастнике.Свойство("БИК", БИК) И ЗначениеЗаполнено(БИК) Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
										ДеревоДанных,
										ВидУчастника + ".БанковскиеРеквизиты.БИКБанка",
										БИК);
		КонецЕсли;
		Если СведенияОбУчастнике.Свойство("КоррСчет", КоррСчет) И ЗначениеЗаполнено(КоррСчет) Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
										ДеревоДанных,
										ВидУчастника + ".БанковскиеРеквизиты.КорреспондентскийСчетБанка",
										КоррСчет);
		КонецЕсли;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СведенияОбУчастнике.КодПоОКПО) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных, ВидУчастника + ".КодОКПО", СведенияОбУчастнике.КодПоОКПО);
	КонецЕсли;
		
КонецПроцедуры

Функция ПодготовитьСтруктуруДляСчетаФактурыУПД_2019(ДеревоДанных) Экспорт
	
	ДанныеДляОбъекта = Новый Структура;
	
	ДанныеОбъекта = Новый Структура;
	ДанныеОбъекта.Вставить("Номер", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерДокумента"));
	ДанныеОбъекта.Вставить("ДатаСоставления", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокумента"));
	ДанныеОбъекта.Вставить("Дата", ТекущаяДатаСеанса());
	
	СведенияОПродавце = ДеревоДанных.Строки.Найти("СведенияОПродавце", "ПолныйПуть");
	СведенияОПокупателе = ДеревоДанных.Строки.Найти("СведенияОПокупателе", "ПолныйПуть");
	Если СведенияОПродавце.Строки.Количество() > 1
		ИЛИ СведенияОПокупателе.Строки.Количество() > 1 Тогда
		ТекстИсключения = СтрШаблон(НСтр("ru = 'Ошибка загрузки электронной товарной накладной %1 от %2.'"), 
			ДанныеОбъекта.Номер, Формат(ДанныеОбъекта.ДатаСоставления,"ДЛФ=D")) + Символы.ПС
			+ НСтр("ru = 'Загрузка сводных накладных не поддерживается.'");
		ВызватьИсключение ТекстИсключения;
	КонецЕсли;
	
	// Сведения о поставщике.
	Для Каждого СтрокаПродавца Из СведенияОПродавце.Строки Цикл
		ДанныеОбъекта.Вставить("Контрагент", КонтрагентПоДаннымЭД(СтрокаПродавца, "СведенияОПродавце.НомерСтроки"));
		Прервать;
	КонецЦикла;
	
	// Сведения о покупателе.
	Для каждого СтрокаПокупателя Из СведенияОПокупателе.Строки Цикл
		ДанныеОбъекта.Вставить("Организация", ОрганизацияПоДаннымЭД(СтрокаПокупателя, "СведенияОПокупателе.НомерСтроки"));
		Прервать;
	КонецЦикла;
	
	// Если счет-фактура на аванс.
	ВидСчетаФактуры = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВидСчетаФактуры");
	ПроверкаЧтоЭтоАванс(ДеревоДанных, ВидСчетаФактуры);
	
	Если ВидСчетаФактуры = "Авансовый" Тогда
		КодВидаОперации = "02";
	Иначе
		КодВидаОперации = "01";
	КонецЕсли;
	
	ДанныеОбъекта.Вставить("КодВидаОперации", КодВидаОперации);
	ДанныеОбъекта.Вставить("ПолученВЭлектронномВиде", Истина);
	
	НомерИсправления = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления");
	ДатаИсправления  = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсправления");
	
	Если ЗначениеЗаполнено(НомерИсправления) Тогда
		ДанныеОбъекта.Вставить("Исправление", Истина);
		ДанныеОбъекта.Вставить("НомерИсправления", НомерИсправления);
		ДанныеОбъекта.Вставить("ДатаИсправления",  ДатаИсправления);
	Иначе
		ДанныеОбъекта.Вставить("Исправление", Ложь);		
	КонецЕсли;	
	
	// Получим документы-основания
	ДокументыОснованияСчетаФактуры = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументыОснованияСчетаФактуры");
	Если ЗначениеЗаполнено(ДокументыОснованияСчетаФактуры) Тогда
		МассивДокументовОснований = Новый Массив;		
		Если ТипЗнч(ДокументыОснованияСчетаФактуры) = Тип("Массив") Тогда 
			Для Каждого ДокументОснования Из ДокументыОснованияСчетаФактуры Цикл
				Если ТипЗнч(ДокументОснования) <> Тип("ДокументСсылка.СчетФактураПолученный") Тогда
					МассивДокументовОснований.Добавить(ДокументОснования);
				КонецЕсли;
			КонецЦикла;
		Иначе
			МассивДокументовОснований.Добавить(ДокументыОснованияСчетаФактуры);
		КонецЕсли;
		ДанныеОбъекта.Вставить("ДокументыОснования", МассивДокументовОснований);		
	КонецЕсли;
	
	КодВалюты = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод");
	ВалютаОбъекта = Неопределено;	
	ЭлектронноеВзаимодействиеПереопределяемый.НайтиСсылкуНаОбъект("Валюты", ВалютаОбъекта, КодВалюты);
	ДанныеОбъекта.Вставить("Валюта", ВалютаОбъекта);
	
	ДанныеОбъекта.Вставить("Сумма", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоКОплате.ВсегоСтоимостьТоваровСНалогом"));
	ДанныеОбъекта.Вставить("СуммаНДС", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоКОплате.ВсегоСуммаНалога"));

	ОбстоятельстваФормированияСФ = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДополнительныеСведенияОбУчастниках.ОбстоятельстваФормированияСФ");
	Если ОбстоятельстваФормированияСФ = "4" Тогда
		ДанныеОбъекта.Вставить("ПриемНаКомиссию", Истина);
	Иначе
		ДанныеОбъекта.Вставить("ПриемНаКомиссию", Ложь);
	КонецЕсли;	
	
	ДанныеДляОбъекта.Вставить("Шапка", ДанныеОбъекта);
	
	Если ВидСчетаФактуры = "Авансовый" Тогда
		Авансы = Документы.СчетФактураПолученныйАванс.ПустаяСсылка().Авансы.Выгрузить();
		СведенияОТоварах = ДеревоДанных.Строки.Найти("СведенияОТоварах", "ПолныйПуть");
		Для Каждого СведенияОТоваре Из СведенияОТоварах.Строки Цикл
			НоваяСтрока = Авансы.Добавить();
			НоваяСтрока.Сумма = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогом");
			СтавкаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.НалоговаяСтавка");
			НоваяСтрока.СтавкаНДС = ?(СтавкаНДС = "НДС исчисляется налоговым агентом", УчетНДСУП.СтавкаНДСПоУмолчанию(ДанныеОбъекта.Организация, ДанныеОбъекта.Дата, Истина), СтавкаНДС);
			НоваяСтрока.СуммаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СуммаНалога");
		КонецЦикла;
		ДанныеДляОбъекта.Вставить("Авансы", Авансы);
	КонецЕсли;
	
	Если ВидСчетаФактуры = "Реализация" Тогда
		ЗаполнитьСуммыДляСчетаФактуры(ДанныеДляОбъекта, ДеревоДанных);
	КонецЕсли;
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

Функция ПодготовитьСтруктуруДляПриобретенияТоваровУслугУПД_2019(ДеревоДанных) Экспорт
	
	ДанныеОбъекта = Новый Структура;
	
	СведенияОЗакупкеКомиссионером = Ложь;
	Если ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "Функция") = "СвЗК" Тогда
		СведенияОЗакупкеКомиссионером = Истина;
	КонецЕсли;
	
	Валюта = Неопределено;
	ЭлектронноеВзаимодействиеПереопределяемый.НайтиСсылкуНаОбъект(
				"Валюты", Валюта, ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод"));
	ДанныеОбъекта.Вставить("Валюта", Валюта);
	ДанныеОбъекта.Вставить("ВалютаВзаиморасчетов", Валюта);
	Курс = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДополнительныеСведенияОбУчастниках.ВалютаКурс");
	ДанныеОбъекта.Вставить("КурсЧислитель", ?(ЗначениеЗаполнено(Курс), Курс, 1));
	ДанныеОбъекта.Вставить("КурсЗнаменатель", 1);
	
	ДанныеОбъекта.Вставить("НомерВходящегоДокумента", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерДокумента"));
	ДанныеОбъекта.Вставить("ДатаВходящегоДокумента",  ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокумента"));
	
	ДанныеОбъекта.Вставить("ОбстоятельстваФормированияСФ", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДополнительныеСведенияОбУчастниках.ОбстоятельстваФормированияСФ"));
	
	СведенияОПродавце = ДеревоДанных.Строки.Найти("СведенияОПродавце", "ПолныйПуть");
	СведенияОПокупателе = ДеревоДанных.Строки.Найти("СведенияОПокупателе", "ПолныйПуть");
	Если СведенияОПродавце.Строки.Количество() > 1
		ИЛИ СведенияОПокупателе.Строки.Количество() > 1 Тогда
		ТекстИсключения = СтрШаблон(НСтр("ru = 'Ошибка загрузки электронной товарной накладной %1 от %2.'"), 
			ДанныеОбъекта.Номер, Формат(ДанныеОбъекта.ДатаСоставления,"ДЛФ=D")) + Символы.ПС
			+ НСтр("ru = 'Загрузка сводных накладных не поддерживается.'");
		ВызватьИсключение ТекстИсключения;
	КонецЕсли;
	
	// Сведения о поставщике.
	Для Каждого СтрокаПродавца Из СведенияОПродавце.Строки Цикл
		Контрагент = КонтрагентПоДаннымЭД(СтрокаПродавца, "СведенияОПродавце.НомерСтроки");
		Прервать;
	КонецЦикла;
	
	Если ЗначениеЗаполнено(Контрагент) Тогда
		ДанныеОбъекта.Вставить("Контрагент", Контрагент);
		ДанныеОбъекта.Вставить("Партнер",  	 Контрагент.Партнер);
	КонецЕсли;
	
	// Сведения о покупателе.
	Если СведенияОЗакупкеКомиссионером Тогда
		ДанныеОбъекта.Вставить("Организация", ОрганизацияПоДаннымЭД(ДеревоДанных, "СведенияОКомитенте"));
	Иначе
		Для каждого СтрокаПокупателя Из СведенияОПокупателе.Строки Цикл
			ДанныеОбъекта.Вставить("Организация", ОрганизацияПоДаннымЭД(СтрокаПокупателя, "СведенияОПокупателе.НомерСтроки"));
			Прервать;
		КонецЦикла;
	КонецЕсли;
	
	// Сведения об основании.
	СведенияОДокументеОтгрузки = ДеревоДанных.Строки.Найти("ОснованиеОтгрузкиТоваров", "ПолныйПуть");
	Для Каждого СтрокиСведений Из СведенияОДокументеОтгрузки.Строки Цикл
		ДанныеОбъекта.Вставить("ДатаДокументаОснования", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СтрокиСведений, "ОснованиеОтгрузкиТоваров.НомерСтроки.ДокументДата"));
		ДанныеОбъекта.Вставить("НомерДокументаОснования", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СтрокиСведений, "ОснованиеОтгрузкиТоваров.НомерСтроки.ДокументНомер"));
		Прервать;
	КонецЦикла;

	// Сведения о входящем документе.
	СведенияОДокументеПодтвержденияОтгрузки = ДеревоДанных.Строки.Найти("ДокументыПодтвержденияОтгрузки", "ПолныйПуть");
	НомерВходящегоДокумента = Неопределено;
	ДатаВходящегоДокумента = Неопределено;
	Для Каждого СтрокиСведений Из СведенияОДокументеПодтвержденияОтгрузки.Строки Цикл
		НомерВходящегоДокумента = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СтрокиСведений, "ДокументыПодтвержденияОтгрузки.НомерСтроки.Номер");
		ДатаВходящегоДокумента  = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СтрокиСведений, "ДокументыПодтвержденияОтгрузки.НомерСтроки.Дата");
		Прервать;
	КонецЦикла;	
	
	НомерИсправления = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления");
	ДатаИсправления  = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсправления");
	
	Если ЗначениеЗаполнено(НомерИсправления) Тогда
		ДанныеОбъекта.Вставить("Исправление", Истина);
		ДанныеОбъекта.Вставить("НомерИсправления", НомерИсправления);
		ДанныеОбъекта.Вставить("ДатаИсправления",  ДатаИсправления);

		ИсправляемыйДокумент = Неопределено;
		ДокОснование = Неопределено;
		ДокументыОснованияДокументаОтгрузки = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументыОснованияДокументаОтгрузки");		
		Если ЗначениеЗаполнено(ДокументыОснованияДокументаОтгрузки) Тогда
			
			ДополнительныеСведения = ПолучитьДополнительныеСведения(ДеревоДанных);
			
			ИсправляемыйДокументЭтоКорректировка = Ложь;
			Если ДополнительныеСведения.Свойство("ИсправляемыйДокументЭтоКорректировка") Тогда
				ИсправляемыйДокументЭтоКорректировка = Истина;
			КонецЕсли;
			
			Для Каждого ДокументОснование Из ДокументыОснованияДокументаОтгрузки Цикл
				Если ТипЗнч(ДокументОснование) <> Тип("ДокументСсылка.СчетФактураПолученный") Тогда
					Если ТипЗнч(ДокументОснование) <> Тип("ДокументСсылка.КорректировкаПриобретения") Тогда
						ДокОснование = ДокументОснование;
						Если Не ЗначениеЗаполнено(ИсправляемыйДокумент) Тогда
							ИсправляемыйДокумент = ДокументОснование;
						КонецЕсли;
					Иначе
						Если ИсправляемыйДокументЭтоКорректировка Тогда
							ИсправляемыйДокумент = ДокументОснование;
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ДокОснование) Тогда	
			Если ТипЗнч(ДокОснование) = Тип("ДокументСсылка.ПриобретениеТоваровУслуг") 
					Или ТипЗнч(ДокОснование) = Тип("ДокументСсылка.ПриобретениеУслугПрочихАктивов") Тогда
				ДанныеОбъекта.Вставить("ДокументОснование", ДокОснование.Ссылка);
				ДанныеОбъекта.Вставить("НалогообложениеНДС", ДокОснование.НалогообложениеНДС);
				ДанныеОбъекта.Вставить("Соглашение", ДокОснование.Соглашение);
				ДанныеОбъекта.Вставить("Договор", ДокОснование.Договор);
				ДанныеОбъекта.Вставить("ПорядокРасчетов", ДокОснование.ПорядокРасчетов);
				АктОРасхождениях = ПроверкаИПодборПродукцииИСМП.СформированныйАктОРасхождениях(ДокОснование.Ссылка);
				ДанныеОбъекта.Вставить("АктОРасхожденияхПослеПриемкиОснование", АктОРасхождениях);
			КонецЕсли;
		КонецЕсли;
		
 		Если ЗначениеЗаполнено(ИсправляемыйДокумент) Тогда 
			ДанныеОбъекта.Вставить("ИсправляемыйДокумент", ИсправляемыйДокумент);
		КонецЕсли;
	Иначе
		ДанныеОбъекта.Вставить("Исправление", Ложь);
	КонецЕсли;
		
	ДанныеОбъекта.Вставить("Сумма", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоКОплате.ВсегоСтоимостьТоваровСНалогом"));
	
	Товары = Документы.ПриобретениеТоваровУслуг.ПустаяСсылка().Товары.ВыгрузитьКолонки();
	Товары.Колонки.Добавить("НомерПоДаннымПоставщика");
	Товары.Колонки.Добавить("ДатаПоДаннымПоставщика");
	Товары.Колонки.Добавить("НомерПоДаннымКлиента");
	Товары.Колонки.Добавить("ДатаПоДаннымКлиента");
	
	ШтрихкодыУпаковок = ЭлектронноеВзаимодействиеИСМП.НоваяТаблицаШтрихкодыУпаковок();
	ПараметрыЗаполненияСтрокиТоваров = ПараметрыЗаполненияСтрокиТоваровСведениямиОПрослеживаемости();
	
	СведенияОТоварах = ДеревоДанных.Строки.Найти("СведенияОТоварах", "ПолныйПуть");
	Для Каждого СведенияОТоваре Из СведенияОТоварах.Строки Цикл
		
		Признак = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.Признак");
		
		НоваяСтрока = Товары.Добавить();
	
		// Обязательные реквизиты:
		СтавкаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.НалоговаяСтавка");
		НоваяСтрока.СтавкаНДС = ?(СтавкаНДС = "НДС исчисляется налоговым агентом", УчетНДСУП.СтавкаНДСПоУмолчанию(ДанныеОбъекта.Организация, ТекущаяДатаСеанса(), Истина), СтавкаНДС);
		НоваяСтрока.СуммаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СуммаНалога");
		
		// Необязательные реквизиты:
		НоваяСтрока.Количество = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.Количество");
		НоваяСтрока.Цена = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.ЦенаЗаЕдиницуИзмерения");
		НоваяСтрока.Сумма = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровБезНалога");
		НоваяСтрока.СуммаСНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогом");
		
		Если НоваяСтрока.Количество = 0 Тогда
			НоваяСтрока.Количество = 1;
			Если НоваяСтрока.Цена = 0 Тогда
				НоваяСтрока.Цена = НоваяСтрока.Сумма;
			КонецЕсли;
		КонецЕсли;
		
		Сопоставление = СведенияОТоваре.Строки.Найти(
			"СведенияОТоварах.НомерСтроки.Сопоставление", "ПолныйПуть", Истина);
		Если Сопоставление <> Неопределено Тогда
			
			Идентификатор = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.Сопоставление.Идентификатор");
			Если ЗначениеЗаполнено(Идентификатор) Тогда
				НоменклатураПартнера = НоменклатураПартнеровСервер.НайтиСсылкуНаНоменклатуруПартнераПоИдентификатору(Идентификатор);
				Если ЗначениеЗаполнено(НоменклатураПартнера) Тогда
					НоваяСтрока.НоменклатураПартнера = НоменклатураПартнера;
				КонецЕсли;
			КонецЕсли;
			
			Номенклатура = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.Сопоставление.НоменклатураИБ");
			Если ЗначениеЗаполнено(Номенклатура) Тогда
				НоваяСтрока.Номенклатура = Номенклатура;
			КонецЕсли;
			
			Характеристика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.Сопоставление.ХарактеристикаИБ");
			Если ЗначениеЗаполнено(Характеристика) Тогда
				НоваяСтрока.Характеристика = Характеристика;
			КонецЕсли;
			
			Упаковка = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.Сопоставление.УпаковкаИБ");
			Если ЗначениеЗаполнено(Упаковка) Тогда
				ИспользоватьУпаковки = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НоваяСтрока.Номенклатура, "ИспользоватьУпаковки");
				Если ИспользоватьУпаковки Тогда
					НоваяСтрока.Упаковка = Упаковка;
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
		
		ЭтоИмущество = Ложь;
		Если ЗначениеЗаполнено(Признак) Тогда
			ЭтоИмущество = ?(Признак = "1", Истина, Ложь);
		Иначе
			ЭтоИмущество = Истина;
		КонецЕсли;
		
		ТипНоменклатуры = НоваяСтрока.Номенклатура.ТипНоменклатуры;
		Если ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Услуга") Тогда
			НоваяСтрока.СписатьНаРасходы = Истина;
			ЭтоИмущество = Ложь;
		ИначеЕсли ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Товар")
				Или ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Набор") Тогда
			ЭтоИмущество = Истина;
		ИначеЕсли ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Работа")
			И ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НоваяСтрока.Номенклатура, "ПрослеживаемыйТовар") = Истина Тогда
			ЭтоИмущество = Истина;
		КонецЕсли;
		
		Если ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НоваяСтрока.Номенклатура, "ВестиУчетПоГТД") = Истина Тогда
			ВестиУчетПоГТД = Истина;
		Иначе
			ВестиУчетПоГТД = Ложь;
		КонецЕсли;
		
		Если ЭтоИмущество
			И ВестиУчетПоГТД Тогда
			
			СведенияОПрослеживаемости		= СведенияОТоваре.Строки.Найти(
												"СведенияОТоварах.НомерСтроки.СведенияОПрослеживаемости",
												"ПолныйПуть",
												Истина);
			СведенияОТаможеннойДекларации	= СведенияОТоваре.Строки.Найти(
												"СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации",
												"ПолныйПуть",
												Истина);
												
			ПараметрыЗаполненияСтрокиТоваров.Вставить("ЭтоУПД_2019", Истина);
												
			ЗаполнитьСтрокуТоваровСведениямиОПрослеживаемости(НоваяСтрока,
																Товары,
																СведенияОПрослеживаемости,
																СведенияОТаможеннойДекларации,
																ПараметрыЗаполненияСтрокиТоваров);
			
			ЗаполнитьСтрокуТоваровСведениямиОТаможеннойДекларации(НоваяСтрока,
																	СведенияОТаможеннойДекларации,
																	ПараметрыЗаполненияСтрокиТоваров);
			
		КонецЕсли;
		
		Если ЗначениеЗаполнено(НомерВходящегоДокумента) Тогда
			НоваяСтрока.НомерВходящегоДокумента = НомерВходящегоДокумента;
		КонецЕсли;
		Если ЗначениеЗаполнено(ДатаВходящегоДокумента) Тогда
			НоваяСтрока.ДатаВходящегоДокумента = ДатаВходящегоДокумента;
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеИСМП.ДобавитьШтрихкодыТаблицуШтрихкодовУпаковок_2019(ШтрихкодыУпаковок, СведенияОТоваре);

	КонецЦикла;

	ЭлектронноеВзаимодействиеИСМП.СвернутьТаблицуШтрихкодовУпаковок(ШтрихкодыУпаковок);

	// заполним Характеристики и Упаковки по соответствию из НоменклатурыПоставщика,
	//Переносим значения из колонки СуммаСкидки в СуммаРучнойСкидки, т.к. название реквизита табличной части документа
	//не совпадает с названием реквизита СтрокиДляЗагрузки

	Для Каждого ТекСтрока Из Товары Цикл 
		ТекСтрока.КоличествоУпаковок = ТекСтрока.Количество;
		// заполним Количество с учетом единиц измерения
		Если ЗначениеЗаполнено(ТекСтрока.Упаковка) Тогда
			ТекКоэффициент = Справочники.УпаковкиЕдиницыИзмерения.КоэффициентУпаковки(ТекСтрока.Упаковка, ТекСтрока.Номенклатура);
		Иначе
			ТекКоэффициент = 1;
		КонецЕсли;
		ТекСтрока.Количество = ТекСтрока.КоличествоУпаковок * ТекКоэффициент;
	КонецЦикла;
	
	ДанныеДляЗаполнения = Новый Структура();
	ДанныеДляЗаполнения.Вставить("Шапка", ДанныеОбъекта);
	ДанныеДляЗаполнения.Вставить("Товары", Товары);
	ДанныеДляЗаполнения.Вставить("ШтрихкодыУпаковок", ШтрихкодыУпаковок);

	ДокОснованияПервичныйДокумент = Ложь;
	СтрокиДопДанныеСчетаФактуры = ДеревоДанных.Строки.Найти("ДопДанныеСчетаФактуры", "ПолныйПуть");
	СтрокаТаблицы = СтрокиДопДанныеСчетаФактуры.Строки.Найти("ДопДанныеСчетаФактуры.ТекстоваяИнформация", "ПолныйПуть");
	Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
		Для Каждого Информация Из СтрокаТаблицы.Строки Цикл
			
			Идентификатор = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(Информация,
				"ДопДанныеСчетаФактуры.ТекстоваяИнформация.НомерСтроки.Идентификатор");
			Значение = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(Информация,
				"ДопДанныеСчетаФактуры.ТекстоваяИнформация.НомерСтроки.Значение");
			
			Если Идентификатор = "ДокументОснованиеПервичныйДокумент" Тогда
				ДокОснованияПервичныйДокумент = Значение;
			КонецЕсли;
			
 		КонецЦикла;			
	КонецЕсли;	
	
	Если ДокОснованияПервичныйДокумент Тогда
		Расхождения = Документы.КорректировкаПриобретения.ПустаяСсылка().Расхождения.ВыгрузитьКолонки(); 		
		ДанныеДляЗаполнения.Вставить("Расхождения", Расхождения);		
	КонецЕсли;	
	
	Возврат ДанныеДляЗаполнения;
	
КонецФункции

Функция ПодготовитьСтруктуруДляПоступленияУслугУПД_2019(ДеревоДанных) Экспорт
	
	ДанныеОбъекта = Новый Структура;
	
	Валюта = Неопределено;	
	ЭлектронноеВзаимодействиеПереопределяемый.НайтиСсылкуНаОбъект(
				"Валюты", Валюта, ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод"));
	Курс = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДополнительныеСведенияОбУчастниках.ВалютаКурс");
	ДанныеОбъекта.Вставить("КурсЧислитель", ?(ЗначениеЗаполнено(Курс), Курс, 1));
	ДанныеОбъекта.Вставить("КурсЗнаменатель", 1);
	
	ДанныеОбъекта.Вставить("НомерВходящегоДокумента", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерДокумента"));
	ДанныеОбъекта.Вставить("ДатаВходящегоДокумента",  ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокумента"));
	
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления")) Тогда
		ДанныеОбъекта.Вставить("Исправление", Истина);
		ДанныеОбъекта.Вставить("НомерИсправления", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления"));
		ДанныеОбъекта.Вставить("ДатаИсправления",  ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсправления"));
	Иначе
		ДанныеОбъекта.Вставить("Исправление", Ложь);
	КонецЕсли;
	
	СведенияОПродавце = ДеревоДанных.Строки.Найти("СведенияОПродавце", "ПолныйПуть");
	СведенияОПокупателе = ДеревоДанных.Строки.Найти("СведенияОПокупателе", "ПолныйПуть");
	Если СведенияОПродавце.Строки.Количество() > 1
		ИЛИ СведенияОПокупателе.Строки.Количество() > 1 Тогда
		ТекстИсключения = СтрШаблон(НСтр("ru = 'Ошибка загрузки электронной товарной накладной %1 от %2.'"), 
			ДанныеОбъекта.Номер, Формат(ДанныеОбъекта.ДатаСоставления,"ДЛФ=D")) + Символы.ПС
			+ НСтр("ru = 'Загрузка сводных накладных не поддерживается.'");
		ВызватьИсключение ТекстИсключения;
	КонецЕсли;
	
	// Сведения о поставщике.
	Для Каждого СтрокаПродавца Из СведенияОПродавце.Строки Цикл
		Контрагент	= КонтрагентПоДаннымЭД(СтрокаПродавца, "СведенияОПродавце.НомерСтроки");	
		Прервать;
	КонецЦикла;
	
	Если ЗначениеЗаполнено(Контрагент) Тогда
		ДанныеОбъекта.Вставить("Контрагент", Контрагент);
		ДанныеОбъекта.Вставить("Партнер",  	 Контрагент.Партнер);
	КонецЕсли;
	
	// Сведения о покупателе.
	Для каждого СтрокаПокупателя Из СведенияОПокупателе.Строки Цикл
		ДанныеОбъекта.Вставить("Организация", ОрганизацияПоДаннымЭД(СтрокаПокупателя, "СведенияОПокупателе.НомерСтроки"));
		Прервать;
	КонецЦикла;
	
	ТЗ = Документы.ПриобретениеУслугПрочихАктивов.ПустаяСсылка().Расходы.ВыгрузитьКолонки();
	
	ПараметрыЗаполненияСтрокиТоваров = ПараметрыЗаполненияСтрокиТоваровСведениямиОПрослеживаемости();
	
	СведенияОТоварах = ДеревоДанных.Строки.Найти("СведенияОТоварах", "ПолныйПуть");
	Для Каждого СведенияОТоваре Из СведенияОТоварах.Строки Цикл
		
		НоваяСтрока = ТЗ.Добавить();
		
		// Обязательные реквизиты:
		СтавкаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.НалоговаяСтавка");
		НоваяСтрока.СтавкаНДС = ?(СтавкаНДС = "НДС исчисляется налоговым агентом", УчетНДСУП.СтавкаНДСПоУмолчанию(ДанныеОбъекта.Организация, ТекущаяДатаСеанса(), Истина), СтавкаНДС);
		НоваяСтрока.СуммаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,  "СведенияОТоварах.НомерСтроки.СуммаНалога");
		
		// Необязательные реквизиты:
		НоваяСтрока.Количество = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.Количество");
		НоваяСтрока.Цена = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.ЦенаЗаЕдиницуИзмерения");
		НоваяСтрока.Сумма = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровБезНалога");
		НоваяСтрока.СуммаСНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогом");
		НоваяСтрока.Содержание = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.ТоварНаименование");
		
		// Заполняем ТНВЭД
		КодВидаТовара = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.КодВидаТовара");
		
		Если ЗначениеЗаполнено(КодВидаТовара) Тогда
			НоваяСтрока.КодТНВЭД = Справочники.КлассификаторТНВЭД.НайтиСоздатьЭлементКлассификатораТНВЭД(КодВидаТовара);
		КонецЕсли;
		
		СведенияОПрослеживаемости		= СведенияОТоваре.Строки.Найти(
											"СведенияОТоварах.НомерСтроки.СведенияОПрослеживаемости",
											"ПолныйПуть",
											Истина);
		СведенияОТаможеннойДекларации	= СведенияОТоваре.Строки.Найти(
											"СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации",
											"ПолныйПуть",
											Истина);
											
		ПараметрыЗаполненияСтрокиТоваров.Вставить("ЭтоУПД_2019", Истина);
											
		ЗаполнитьСтрокуТоваровСведениямиОПрослеживаемости(НоваяСтрока,
															ТЗ,
															СведенияОПрослеживаемости,
															СведенияОТаможеннойДекларации,
															ПараметрыЗаполненияСтрокиТоваров);
		
		ЗаполнитьСтрокуТоваровСведениямиОТаможеннойДекларации(НоваяСтрока,
																СведенияОТаможеннойДекларации,
																ПараметрыЗаполненияСтрокиТоваров);
	КонецЦикла;
	
	ДанныеДляЗаполнения = Новый Структура();
	ДанныеДляЗаполнения.Вставить("Шапка", ДанныеОбъекта);
	ДанныеДляЗаполнения.Вставить("Расходы", ТЗ);
	
	Возврат ДанныеДляЗаполнения;
	
КонецФункции

Функция ОрганизацияПоДаннымЭД(ДеревоДанных, ВидУчастника)
	
	Организация = Неопределено;
	Если ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ЮЛ" Тогда
		ИНН = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
		КПП = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");
		Запрос = Новый Запрос();
		Запрос.Текст = 
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
			|	Организации.Ссылка
			|ИЗ
			|	Справочник.Организации КАК Организации
			|ГДЕ
			|	Организации.ИНН = &ИНН
			|	И Организации.КПП = &КПП
			|	И НЕ Организации.ПометкаУдаления";
		Запрос.УстановитьПараметр("ИНН", ИНН);
		Запрос.УстановитьПараметр("КПП", КПП);
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			Организация = Выборка.Ссылка;
		КонецЕсли;
		
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ИП" Тогда
		ИНН = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН");
		Запрос = Новый Запрос();
		Запрос.Текст = 
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
			|	Организации.Ссылка
			|ИЗ
			|	Справочник.Организации КАК Организации
			|ГДЕ
			|	Организации.ИНН = &ИНН
			|	И НЕ Организации.ПометкаУдаления";
		Запрос.УстановитьПараметр("ИНН", ИНН);
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			Организация = Выборка.Ссылка;
		КонецЕсли;
		
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ИЛ" Тогда
		НаименованиеПолное = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИЛ.НаименованиеОрганизации");
		Если ЗначениеЗаполнено(НаименованиеПолное) Тогда
			Запрос = Новый Запрос();
			Запрос.Текст = 
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
				|	Организации.Ссылка КАК Ссылка
				|ИЗ
				|	Справочник.Организации КАК Организации
				|ГДЕ
				|	Организации.НаименованиеПолное = &НаименованиеПолное
				|	И НЕ Организации.ПометкаУдаления";
			Запрос.УстановитьПараметр("НаименованиеПолное", НаименованиеПолное);
			
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				Организация = Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
		
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ФЛ" Тогда
		ИНН = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.ИНН");
		
		Фамилия  = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.Фамилия");
		Имя      = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.Имя");
		Отчество = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.Отчество");
		
		ЭлементыИмени = Новый Массив;
		Если ЗначениеЗаполнено(Фамилия) Тогда
			ЭлементыИмени.Добавить(Фамилия);
		КонецЕсли;
		Если ЗначениеЗаполнено(Имя) Тогда
			ЭлементыИмени.Добавить(Имя);
		КонецЕсли;
		Если ЗначениеЗаполнено(Отчество) Тогда
			ЭлементыИмени.Добавить(Отчество);
		КонецЕсли;
		ПолноеНаименование = СтрСоединить(ЭлементыИмени, " ");
		
		Если ЗначениеЗаполнено(ИНН) Или ЗначениеЗаполнено(ПолноеНаименование) Тогда 
			Запрос = Новый Запрос();
			Запрос.Текст = 
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
				|	Организации.Ссылка
				|ИЗ
				|	Справочник.Организации КАК Организации
				|ГДЕ
				|	Организации.ИНН = &ИНН
				|	И НЕ Организации.ПометкаУдаления";
			Если ЗначениеЗаполнено(ИНН) Тогда
				Запрос.УстановитьПараметр("ИНН", ИНН);
			Иначе
				Запрос.Текст = СтрЗаменить(Запрос.Текст, "Организации.ИНН = &ИНН", "Организации.НаименованиеПолное = &НаименованиеПолное");
				Запрос.УстановитьПараметр("НаименованиеПолное", ПолноеНаименование);
			КонецЕсли;
			
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				Организация = Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Организация;
	
КонецФункции

Функция КонтрагентПоДаннымЭД(ДеревоДанных, ВидУчастника)
	
	Контрагент = Неопределено;
	Если ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ЮЛ" Тогда
		ИНН = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
		КПП = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");
		Запрос = Новый Запрос();
		Запрос.Текст = 
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
			|	Контрагенты.Ссылка
			|ИЗ
			|	Справочник.Контрагенты КАК Контрагенты
			|ГДЕ
			|	Контрагенты.ИНН = &ИНН
			|	И Контрагенты.КПП = &КПП
			|	И НЕ Контрагенты.ПометкаУдаления";
		Запрос.УстановитьПараметр("ИНН", ИНН);
		Запрос.УстановитьПараметр("КПП", КПП);
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			Контрагент = Выборка.Ссылка;
		КонецЕсли;
		
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ИП" Тогда
		ИНН = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН");
		Запрос = Новый Запрос();
		Запрос.Текст = 
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
			|	Контрагенты.Ссылка
			|ИЗ
			|	Справочник.Контрагенты КАК Контрагенты
			|ГДЕ
			|	Контрагенты.ИНН = &ИНН
			|	И НЕ Контрагенты.ПометкаУдаления";
		Запрос.УстановитьПараметр("ИНН", ИНН);
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			Контрагент = Выборка.Ссылка;
		КонецЕсли;
		
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ИЛ" Тогда
		НаименованиеПолное = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИЛ.НаименованиеОрганизации");
		Если ЗначениеЗаполнено(НаименованиеПолное) Тогда
			Запрос = Новый Запрос();
			Запрос.Текст = 
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
				|	Контрагенты.Ссылка КАК Ссылка
				|ИЗ
				|	Справочник.Контрагенты КАК Контрагенты
				|ГДЕ
				|	Контрагенты.НаименованиеПолное = &НаименованиеПолное
				|	И НЕ Контрагенты.ПометкаУдаления";
			Запрос.УстановитьПараметр("НаименованиеПолное", НаименованиеПолное);
			
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				Контрагент = Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
		
	ИначеЕсли ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника") = "ФЛ" Тогда
		ИНН = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.ИНН");
		
		Фамилия  = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.Фамилия");
		Имя      = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.Имя");
		Отчество = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.Отчество");
		
		ЭлементыИмени = Новый Массив;
		Если ЗначениеЗаполнено(Фамилия) Тогда
			ЭлементыИмени.Добавить(Фамилия);
		КонецЕсли;
		Если ЗначениеЗаполнено(Имя) Тогда
			ЭлементыИмени.Добавить(Имя);
		КонецЕсли;
		Если ЗначениеЗаполнено(Отчество) Тогда
			ЭлементыИмени.Добавить(Отчество);
		КонецЕсли;
		ПолноеНаименование = СтрСоединить(ЭлементыИмени, " ");
		
		Если ЗначениеЗаполнено(ИНН) Или ЗначениеЗаполнено(ПолноеНаименование) Тогда 
			Запрос = Новый Запрос();
			Запрос.Текст = 
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
				|	Контрагенты.Ссылка КАК Ссылка
				|ИЗ
				|	Справочник.Контрагенты КАК Контрагенты
				|ГДЕ
				|	Контрагенты.ИНН = &ИНН
				|	И НЕ Контрагенты.ПометкаУдаления";
			Если ЗначениеЗаполнено(ИНН) Тогда
				Запрос.УстановитьПараметр("ИНН", ИНН);
			Иначе
				Запрос.Текст = СтрЗаменить(Запрос.Текст, "Контрагенты.ИНН = &ИНН", "Контрагенты.НаименованиеПолное = &НаименованиеПолное");
				Запрос.УстановитьПараметр("НаименованиеПолное", ПолноеНаименование);
			КонецЕсли;
			
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				Контрагент = Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;

	КонецЕсли;
	
	Возврат Контрагент;
	
КонецФункции

Процедура ДобавитьОбработкуОшибокВТаблицуУчастниковУПД(ТаблицаУчастников, ПутьКУчастнику = "")
	
	ПутьКПолю = ?(ЗначениеЗаполнено(ПутьКУчастнику), ПутьКУчастнику + ".", "");
	
	Для каждого СтрокаТаблицы Из ТаблицаУчастников Цикл
		
		Сведения = СтрокаТаблицы.СведенияОбУчастнике;
		Если Не ЗначениеЗаполнено(Сведения) Тогда
			Продолжить;
		КонецЕсли;
		
		Участник = ?(ЗначениеЗаполнено(ПутьКУчастнику), СтрокаТаблицы[ПутьКУчастнику], СтрокаТаблицы);
		
		Если Участник.ТипУчастника.Свойство("ЮЛ") Тогда
			
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокаТаблицы,
				ПутьКПолю + "ТипУчастника.ЮЛ.НаименованиеОрганизации", Сведения.Ссылка, "Объект.НаименованиеПолное");
				
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокаТаблицы,
				ПутьКПолю + "ТипУчастника.ЮЛ.ИНН", Сведения.Ссылка, "Объект.ИНН");
				
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокаТаблицы,
				ПутьКПолю + "ТипУчастника.ЮЛ.ИНН", Сведения.Ссылка, "Объект.КПП");
				
		ИначеЕсли Участник.ТипУчастника.Свойство("ИЛ") Тогда
			
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокаТаблицы,
				ПутьКПолю + "ТипУчастника.ИЛ.НаименованиеОрганизации", Сведения.Ссылка, "Объект.НаименованиеПолное");
				
		ИначеЕсли Участник.ТипУчастника.Свойство("ИП") Тогда
			
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокаТаблицы,
				ПутьКПолю + "ТипУчастника.ИП.ИНН", Сведения.Ссылка, "Объект.ИНН");
				
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокаТаблицы,
				ПутьКПолю + "ТипУчастника.ИП.Фамилия", Сведения.Ссылка, "Объект.НаименованиеПолное");
				
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокаТаблицы,
				ПутьКПолю + "ТипУчастника.ИП.Имя", Сведения.Ссылка, "Объект.НаименованиеПолное");
				
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокаТаблицы,
				ПутьКПолю + "ТипУчастника.ИП.Отчество", Сведения.Ссылка, "Объект.НаименованиеПолное");
				
			Если ТипЗнч(Сведения.Ссылка) = Тип("СправочникСсылка.Организации") Тогда
				
				ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокаТаблицы,
					ПутьКПолю + "ТипУчастника.ИП.СвидетельствоОГосРегистрации", Сведения.Ссылка, "Объект.СвидетельствоСерияНомер");
				
			КонецЕсли;
			
		КонецЕсли;
		
		ПостфиксПоляАдрес = ?(ТипЗнч(Сведения.Ссылка) = Тип("СправочникСсылка.Контрагенты"), "Контрагента", "Организации");
		
		ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокаТаблицы,
			ПутьКПолю + "Адрес.АвтоматическиЗаполняемый", Сведения.Ссылка, "КонтактнаяИнформацияПолеЮрАдрес" + ПостфиксПоляАдрес);
			
		ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокаТаблицы,
			ПутьКПолю + "КонтактныеСведения.Телефон", Сведения.Ссылка);
			
		ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокаТаблицы,
			ПутьКПолю + "КонтактныеСведения.ЭлектроннаяПочта", Сведения.Ссылка);
			
		НомерСчета = "";
		Если Сведения.Свойство("НомерСчета", НомерСчета) И ЗначениеЗаполнено(НомерСчета) Тогда
			
			Если Сведения.Свойство("БанковскийСчетСсылка") Тогда
				ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокаТаблицы,
					ПутьКПолю + "БанковскиеРеквизиты.НомерСчета", Сведения.БанковскийСчетСсылка, "Объект.НомерСчета");
			КонецЕсли;
				
			Банк = ""; БИК = ""; КоррСчет = "";
			Если Сведения.Свойство("Банк", Банк) И ЗначениеЗаполнено(Банк) Тогда
				Если Сведения.Свойство("БанкСсылка") Тогда
					ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокаТаблицы,
						ПутьКПолю + "БанковскиеРеквизиты.НаименованиеБанка", Сведения.БанкСсылка, "Объект.Наименование");
				КонецЕсли;
			КонецЕсли;
			Если Сведения.Свойство("БИК", БИК) И ЗначениеЗаполнено(БИК) Тогда
				Если Сведения.Свойство("БанкСсылка") Тогда
					ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокаТаблицы,
						ПутьКПолю + "БанковскиеРеквизиты.БИКБанка", Сведения.БанкСсылка, "Объект.Код");
				КонецЕсли;
			КонецЕсли;
			Если Сведения.Свойство("КоррСчет", КоррСчет) И ЗначениеЗаполнено(КоррСчет) Тогда
				Если Сведения.Свойство("БанкСсылка") Тогда
					ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокаТаблицы,
						ПутьКПолю + "БанковскиеРеквизиты.КорреспондентскийСчетБанка", Сведения.БанкСсылка, "Объект.КоррСчет");
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
		
		КодПоОКПО = "";
		Если Сведения.Свойство("КодПоОКПО", КодПоОКПО) И ЗначениеЗаполнено(КодПоОКПО) Тогда
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокаТаблицы,
				ПутьКПолю + "КодОКПО", Сведения.Ссылка, "Объект.КодПоОКПО");
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Функция ПолучитьДанныеУчастникаУПД(Знач СведенияОбУчастнике, ВидАдреса = "Юр")
	
	Данные = Новый Структура("СведенияОбУчастнике", СведенияОбУчастнике);
	
	Данные.Вставить("ТипУчастника", Новый Структура);
	
	Если СведенияОбУчастнике.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ЮрЛицо Тогда
		
		Данные.ТипУчастника.Вставить("ЮЛ", Новый Структура);
		Данные.ТипУчастника.ЮЛ.Вставить("НаименованиеОрганизации", СведенияОбУчастнике.ПолноеНаименование);
		Данные.ТипУчастника.ЮЛ.Вставить("ИНН", СведенияОбУчастнике.ИНН);
		Данные.ТипУчастника.ЮЛ.Вставить("КПП", СведенияОбУчастнике.КПП);
		
	ИначеЕсли СведенияОбУчастнике.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ЮрЛицоНеРезидент Тогда
		
		Данные.ТипУчастника.Вставить("ИЛ", Новый Структура);
		Данные.ТипУчастника.ИЛ.Вставить("НаименованиеОрганизации", СведенияОбУчастнике.ПолноеНаименование);
		
	ИначеЕсли СведенияОбУчастнике.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ИндивидуальныйПредприниматель Тогда
		
		Данные.ТипУчастника.Вставить("ИП", Новый Структура);
		Данные.ТипУчастника.ИП.Вставить("ИНН", СведенияОбУчастнике.ИНН);
		Данные.ТипУчастника.ИП.Вставить("Фамилия", СведенияОбУчастнике.Фамилия);
		Данные.ТипУчастника.ИП.Вставить("Имя", СведенияОбУчастнике.Имя);
		Данные.ТипУчастника.ИП.Вставить("Отчество", СведенияОбУчастнике.Отчество);
		Данные.ТипУчастника.ИП.Вставить("СвидетельствоОГосРегистрации",  СведенияОбУчастнике.Свидетельство);
		
	Иначе
		
		Данные.ТипУчастника.Вставить("ФЛ", Новый Структура);
		Данные.ТипУчастника.ФЛ.Вставить("ИНН", СведенияОбУчастнике.ИНН);
		Данные.ТипУчастника.ФЛ.Вставить("Фамилия", СведенияОбУчастнике.Фамилия);
		Данные.ТипУчастника.ФЛ.Вставить("Имя", СведенияОбУчастнике.Имя);
		Данные.ТипУчастника.ФЛ.Вставить("Отчество", СведенияОбУчастнике.Отчество);
		
	КонецЕсли;
	
	Если ТипЗнч(СведенияОбУчастнике.Ссылка) = Тип("СправочникСсылка.Организации") Тогда
		ВидКонтактнойИнформации = Справочники.ВидыКонтактнойИнформации[ВидАдреса + "АдресОрганизации"].Ссылка;
	ИначеЕсли ТипЗнч(СведенияОбУчастнике.Ссылка) = Тип("СправочникСсылка.Контрагенты") Тогда
		ВидКонтактнойИнформации = Справочники.ВидыКонтактнойИнформации[ВидАдреса + "АдресКонтрагента"].Ссылка;
	ИначеЕсли ТипЗнч(СведенияОбУчастнике.Ссылка) = Тип("СправочникСсылка.РегистрацииВНалоговомОргане") Тогда
		ВидКонтактнойИнформации = Справочники.ВидыКонтактнойИнформации["ФактАдресОбособленногоПодразделения"].Ссылка;
	Иначе
		ВидКонтактнойИнформации = Неопределено;
	КонецЕсли;
	
	ИспользоватьПартнеровКакКонтрагентов = ПолучитьФункциональнуюОпцию("ИспользоватьПартнеровКакКонтрагентов");
	ОбъектКонтактнойИнформации = СведенияОбУчастнике.Ссылка;
	
	АдресКонтрагентаЗаполнен = Истина;	
	Если ТипЗнч(СведенияОбУчастнике.Ссылка) = Тип("СправочникСсылка.Контрагенты") Тогда
		ПроверкаЗаполненностиАдреса = УправлениеКонтактнойИнформацией.КонтактнаяИнформацияОбъекта(
			ОбъектКонтактнойИнформации,
			ВидКонтактнойИнформации,
			ТекущаяДатаСеанса());
		АдресКонтрагентаЗаполнен = Ложь;
		Если ЗначениеЗаполнено(ПроверкаЗаполненностиАдреса) Тогда
			АдресКонтрагентаЗаполнен = Истина;
		КонецЕсли;
	КонецЕсли;
	
	Если ИспользоватьПартнеровКакКонтрагентов И Не АдресКонтрагентаЗаполнен Тогда
		ВидКонтактнойИнформации = Справочники.ВидыКонтактнойИнформации["АдресПартнера"].Ссылка;		
		ОбъектКонтактнойИнформации = СведенияОбУчастнике.Ссылка.Партнер;	
	КонецЕсли;
	
	Данные.Вставить("Адрес", Новый Структура);
	Данные.Адрес.Вставить("АвтоматическиЗаполняемый", Новый Структура);
	Данные.Адрес.АвтоматическиЗаполняемый.Вставить("ОбъектКонтактнойИнформации", ОбъектКонтактнойИнформации);
	Данные.Адрес.АвтоматическиЗаполняемый.Вставить("ВидКонтактнойИнформации", ВидКонтактнойИнформации);
	
	Данные.Вставить("КонтактныеСведения", Новый Структура);
	
	Телефон = "";
	Если СведенияОбУчастнике.Свойство("Телефоны", Телефон) И ЗначениеЗаполнено(Телефон) Тогда
		Данные.КонтактныеСведения.Вставить("Телефон", Телефон);
	КонецЕсли;
	
	ЭлектроннаяПочта = "";
	Если СведенияОбУчастнике.Свойство("ЭлектроннаяПочта", ЭлектроннаяПочта) И ЗначениеЗаполнено(ЭлектроннаяПочта) Тогда
		Данные.КонтактныеСведения.Вставить("ЭлектроннаяПочта", ЭлектроннаяПочта);
	КонецЕсли;
	
	Данные.Вставить("БанковскиеРеквизиты", Новый Структура);
	
	НомерСчета = "";
	Если СведенияОбУчастнике.Свойство("НомерСчета", НомерСчета) И ЗначениеЗаполнено(НомерСчета) Тогда
		
		Данные.БанковскиеРеквизиты.Вставить("НомерСчета", НомерСчета);
		
		Банк = ""; БИК = ""; КоррСчет = "";
		Если СведенияОбУчастнике.Свойство("Банк", Банк) И ЗначениеЗаполнено(Банк) Тогда
			Если ТипЗнч(Банк) = Тип("Строка") Тогда
				БанкНаименование = Банк
			Иначе
				БанкНаименование = Банк.Наименование
			КонецЕсли;
			
			Данные.БанковскиеРеквизиты.Вставить("НаименованиеБанка", БанкНаименование);
			
		КонецЕсли;
		Если СведенияОбУчастнике.Свойство("БИК", БИК) И ЗначениеЗаполнено(БИК) Тогда
			
			Данные.БанковскиеРеквизиты.Вставить("БИКБанка", БИК);
			
		КонецЕсли;
		Если СведенияОбУчастнике.Свойство("КоррСчет", КоррСчет) И ЗначениеЗаполнено(КоррСчет) Тогда
			
			Данные.БанковскиеРеквизиты.Вставить("КорреспондентскийСчетБанка", КоррСчет);
			
		КонецЕсли;
	КонецЕсли;
	
	КодПоОКПО = "";
	Если СведенияОбУчастнике.Свойство("КодПоОКПО", КодПоОКПО) И ЗначениеЗаполнено(КодПоОКПО) Тогда
	
		Данные.Вставить("КодОКПО", КодПоОКПО);
		
	КонецЕсли;
	
	Возврат Данные;
	
КонецФункции

Процедура ПроверкаЧтоЭтоАванс(ДеревоДанных, ВидСчетаФактуры)
	
	ОбстоятельстваФормированияСФ = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДополнительныеСведенияОбУчастниках.ОбстоятельстваФормированияСФ");
	Если Не ЗначениеЗаполнено(ОбстоятельстваФормированияСФ) Тогда
		СуммаБезНалогаВсего = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоКОплате.ВсегоСтоимостьТоваровБезНалога");
		Если СуммаБезНалогаВсего = 0 Тогда
			ВидСчетаФактуры = "Авансовый";
		Иначе
			ВидСчетаФактуры = "Реализация";
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область АктОРасхождениях

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеАктОРасхождениях_ИнформацияПокупателя.
Процедура ЗаполнитьДанныеАктОРасхождениях_ИнформацияПокупателя(Знач Основание, Знач Настройки, Данные, Описание, Отказ) Экспорт
	
	МассивОбъектов = Новый Массив;
	МассивОбъектов.Добавить(Основание);
	ПараметрыПечати = Новый Структура();
	ПараметрыПечати.Вставить("ЗаполнениеЭлектронногоДокумента");
	
	СтруктураДанных = АктОРасхожденияхПослеПриемкиЛокализация.ПолучитьДанныеДляПечатнойФормыТОРГ2(ПараметрыПечати, МассивОбъектов);
	ВыборкаШапка = СтруктураДанных.ДанныеПечати.Выбрать();
	ВыборкаШапка.Следующий();
	
	// Наименование документа
	НаименованиеДокумента = НСтр("ru = 'Акт об установленном расхождении по количеству и качеству при приемке товарно-материальных ценностей'");
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "НаименованиеДокумента", НаименованиеДокумента);
	
	// Номер документа.
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		Данные, "НомерДокумента", ВыборкаШапка.НомерДокумента);
	
	// Дата документа.
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		Данные, "ДатаДокумента", ВыборкаШапка.ДатаДокумента);
		
	// Покупатель / Составитель.
	Покупатель = Неопределено;
	Если ЗначениеЗаполнено(ВыборкаШапка.Организация) Тогда
		
		Покупатель = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(ВыборкаШапка.Организация, , ВыборкаШапка.ДатаДокумента);
		
		// Покупатель.
		ЗаполнитьДанныеУчастникаУПД_2019(Данные, Покупатель, "Покупатель", "Юр", ВыборкаШапка.ДатаДокумента);
		// Грузополучатель.
		ЗаполнитьДанныеУчастникаУПД_2019(Данные, Покупатель, "Грузополучатель", "Юр", ВыборкаШапка.ДатаДокумента);		
		// Составитель.
		СоставительДокументаНаименование = Покупатель.ПолноеНаименование
			+ ?(ЗначениеЗаполнено(Покупатель.КПП),
			СтрШаблон(НСтр("ru = ', ИНН/КПП %1/%2'"), Покупатель.ИНН, Покупатель.КПП),
			СтрШаблон(НСтр("ru = ', ИНН %1'"), Покупатель.ИНН));
				
		ПараметрыОбработкиОшибок = ЭлектронноеВзаимодействиеКлиентСервер.НовыеПараметрыОбработкиОшибки(
			ВыборкаШапка.Ссылка, "Объект.Организация");
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, "СоставительДокументаНаименование", СоставительДокументаНаименование, ПараметрыОбработкиОшибок);
	Иначе
		// Покупатель.
		ПараметрыОбработкиОшибок = ЭлектронноеВзаимодействиеКлиентСервер.НовыеПараметрыОбработкиОшибки(
			ВыборкаШапка.Ссылка, "Объект.Организация");
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, "Покупатель", Покупатель, ПараметрыОбработкиОшибок);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, "Грузополучатель", Покупатель, ПараметрыОбработкиОшибок);
	КонецЕсли;
	
	// Продавец.
	Продавец = Неопределено;
	Если ЗначениеЗаполнено(ВыборкаШапка.Поставщик) Тогда
		Продавец = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(ВыборкаШапка.Поставщик, , ВыборкаШапка.ДатаДокумента);
		ЗаполнитьДанныеУчастникаУПД_2019(Данные, Продавец, "Продавец", "Юр", ВыборкаШапка.ДатаДокумента);
	Иначе
		ПараметрыОбработкиОшибок = ЭлектронноеВзаимодействиеКлиентСервер.НовыеПараметрыОбработкиОшибки(
			ВыборкаШапка.Ссылка, "Объект.Контрагент");
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, "Продавец", Продавец, ПараметрыОбработкиОшибок);
	КонецЕсли;
	
	// Грузоотправитель.
	Грузоотправитель = Неопределено;
	Если ЗначениеЗаполнено(ВыборкаШапка.Грузоотправитель) Тогда
		Грузоотправитель = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(ВыборкаШапка.Грузоотправитель, , ВыборкаШапка.ДатаДокумента);
		ЗаполнитьДанныеУчастникаУПД_2019(Данные, Грузоотправитель, "Грузоотправитель", "Юр", ВыборкаШапка.ДатаДокумента);
	КонецЕсли;
	
	// Страховая компания.
	СтраховаяКомпания = Неопределено;
	Если ЗначениеЗаполнено(ВыборкаШапка.СтраховаяКомпания) Тогда
		СтраховаяКомпания = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(ВыборкаШапка.СтраховаяКомпания, , ВыборкаШапка.ДатаДокумента);
		ЗаполнитьДанныеУчастникаУПД_2019(Данные, СтраховаяКомпания, "СтраховаяКомпания", "Юр", ВыборкаШапка.ДатаДокумента);
	КонецЕсли;
	
	// Сведения по транспортным документам.
	ДокументОснование = Неопределено;
	СведенияПоТранспортнымДокументам = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(
		Данные, "СведенияПоТранспортнымДокументам");
	ВыборкаТовары = СтруктураДанных.ДанныеТовары.Выбрать();
	Пока ВыборкаТовары.Следующий() Цикл
		Если Не ЗначениеЗаполнено(ВыборкаТовары.КоличествоПоДокументам) Тогда
			Продолжить;
		КонецЕсли;
		НоваяСтрока = СведенияПоТранспортнымДокументам.Добавить();
		НоваяСтрока.ВидУпаковки = ВыборкаТовары.ВидУпаковки;
		НоваяСтрока.НаименованиеГруза = ВыборкаТовары.НоменклатураНаименование;
		НоваяСтрока.ЕдиницаИзмеренияКод = ВыборкаТовары.ЕдиницаИзмеренияКод;
		НоваяСтрока.ЕдиницаИзмеренияНаименование = ВыборкаТовары.ЕдиницаИзмеренияНаименование;
		Если ЗначениеЗаполнено(ВыборкаТовары.ДокументОснование) Тогда
			ДокументОснование = ВыборкаТовары.ДокументОснование;
		КонецЕсли;
	КонецЦикла;
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(Данные, СведенияПоТранспортнымДокументам, "СведенияПоТранспортнымДокументам");
	
	// Сопроводительный документ.
	Если ЗначениеЗаполнено(ДокументОснование) Тогда
		Если ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.ПриобретениеТоваровУслуг") Тогда
			Если ЗначениеЗаполнено(ДокументОснование.НомерВходящегоДокумента) и ЗначениеЗаполнено(ДокументОснование.ДатаВходящегоДокумента) Тогда 
				СопроводительныйДокументНаименование = ?(ЗначениеЗаполнено(ДокументОснование.НаименованиеВходящегоДокумента),
				ДокументОснование.НаименованиеВходящегоДокумента, "Счет-фактура");
			Иначе
				СопроводительныйДокументНаименование = "БСД";
			КонецЕсли;
		Иначе
			СопроводительныйДокументНаименование = "БСД";
		КонецЕсли;
		СопроводительныйДокументНомер = ?(ЗначениеЗаполнено(ДокументОснование.НомерВходящегоДокумента),
			ДокументОснование.НомерВходящегоДокумента, "б/н");
		СопроводительныйДокументДата = ?(ЗначениеЗаполнено(ДокументОснование.ДатаВходящегоДокумента),
			ДокументОснование.ДатаВходящегоДокумента, "");
		Если ЗначениеЗаполнено(СопроводительныйДокументНаименование) Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				Данные, "СведенияОбОсмотреГруза.СопроводительныйДокумент.Наименование", СопроводительныйДокументНаименование);
		КонецЕсли;
		Если ЗначениеЗаполнено(СопроводительныйДокументНомер) Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				Данные, "СведенияОбОсмотреГруза.СопроводительныйДокумент.Номер", СопроводительныйДокументНомер);
		КонецЕсли;
		Если ЗначениеЗаполнено(СопроводительныйДокументДата) Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				Данные, "СведенияОбОсмотреГруза.СопроводительныйДокумент.Дата", СопроводительныйДокументДата);
		КонецЕсли;
	КонецЕсли;
	
	// Сведения о времени приемки.
	ОбщийПуть = "СведенияОВремениПриемки.";
	ТаблицаПриемкиТоваров = ВыборкаШапка.ТаблицаПриемкиТоваров.Выбрать();
	Если ТаблицаПриемкиТоваров.Следующий() Тогда
		Если ЗначениеЗаполнено(ТаблицаПриемкиТоваров.ДатаПрибытияВПунктНазначения) Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				Данные, ОбщийПуть + "ДатаПрибытияВПунктНазначения", ТаблицаПриемкиТоваров.ДатаПрибытияВПунктНазначения);
		КонецЕсли;
		Если ЗначениеЗаполнено(ТаблицаПриемкиТоваров.ДатаВыдачи) Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				Данные, ОбщийПуть + "ДатаВыдачиОрганизациейТранспорта", ТаблицаПриемкиТоваров.ДатаВыдачи);
		КонецЕсли;
		Если ЗначениеЗаполнено(ТаблицаПриемкиТоваров.ДатаВскрытия) Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				Данные, ОбщийПуть + "ДатаВскрытияТранспортныхСредств", ТаблицаПриемкиТоваров.ДатаВскрытия);
		КонецЕсли;
		Если ЗначениеЗаполнено(ТаблицаПриемкиТоваров.ДатаДоставкиНаСклад) Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				Данные, ОбщийПуть + "ДатаДоставкиНаСкладПолучателя", ТаблицаПриемкиТоваров.ДатаДоставкиНаСклад);
		КонецЕсли;
	КонецЕсли;
	
	// Обстоятельства приемки.
	ОбщийПуть = "ОбстоятельстваПриемки.";
	Если ЗначениеЗаполнено(ВыборкаШапка.УсловияХраненияТовараДоВскрытия) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, ОбщийПуть + "УсловияХраненияТоваровНаСкладеПолучателя", ВыборкаШапка.УсловияХраненияТовараДоВскрытия);
	КонецЕсли;
	Если ЗначениеЗаполнено(ВыборкаШапка.СостояниеТарыИУпаковки) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, ОбщийПуть + "СостояниеТарыУпаковки", ВыборкаШапка.СостояниеТарыИУпаковки);
	КонецЕсли;
	Если ЗначениеЗаполнено(ВыборкаШапка.СпособОпределенияКоличества) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, ОбщийПуть + "ТипОпределенияКоличества", ВыборкаШапка.СпособОпределенияКоличества);
	КонецЕсли;
	Если ЗначениеЗаполнено(ВыборкаШапка.ДополнительнаяИнформация) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, ОбщийПуть + "ДополнительныеСведения", ВыборкаШапка.ДополнительнаяИнформация);
	КонецЕсли;
	//  Транспортный документ.
	Если ЗначениеЗаполнено(ВыборкаШапка.НомерЖелезнодорожнойНакладной) И ЗначениеЗаполнено(ВыборкаШапка.ДатаЖелезнодорожнойНакладной) Тогда
		ТранспортныйДокументНаименование = НСтр("ru = 'Железнодорожная накладная'");
		ТранспортныйДокументНомер = ?(ЗначениеЗаполнено(ВыборкаШапка.НомерЖелезнодорожнойНакладной),
			ВыборкаШапка.ТранспортныйДокументНомер,  НСтр("ru = 'б/н'"));
		ТранспортныйДокументДата = ?(ЗначениеЗаполнено(ВыборкаШапка.ДатаЖелезнодорожнойНакладной),
			ВыборкаШапка.ТранспортныйДокументДата, "");
	Иначе
		ТранспортныйДокументНаименование =  НСтр("ru = 'БСД'");
		ТранспортныйДокументНомер =  НСтр("ru = 'б/н'");
		ТранспортныйДокументДата = "";
	КонецЕсли;	
	Если ЗначениеЗаполнено(ТранспортныйДокументНаименование) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, ОбщийПуть + "ТранспортныйДокумент.Наименование", ТранспортныйДокументНаименование);
	КонецЕсли;
	Если ЗначениеЗаполнено(ТранспортныйДокументНомер) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, ОбщийПуть + "ТранспортныйДокумент.Номер", ТранспортныйДокументНомер);
	КонецЕсли;
	Если ЗначениеЗаполнено(ТранспортныйДокументДата) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, ОбщийПуть + "ТранспортныйДокумент.Дата", ТранспортныйДокументДата);
	КонецЕсли;
	
	// Сведения о лице, принявшем товар.
	ОбщийПуть = "СведенияОЛицеПринявшемТовар.РаботникОрганизацииПокупателя.";
	Если ЗначениеЗаполнено(ВыборкаШапка.КладовщикПринявшийТовар) Тогда
		ФИО = ФизическиеЛицаКлиентСервер.ЧастиИмени(ВыборкаШапка.КладовщикПринявшийТовар);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, ОбщийПуть + "Фамилия", ФИО.Фамилия);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, ОбщийПуть + "Имя", ФИО.Имя);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, ОбщийПуть + "Отчество", ФИО.Отчество);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, ОбщийПуть + "ОснованиеПолномочий", НСтр("ru = 'Должностные обязанности'"));
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, ОбщийПуть + "Должность", НСтр("ru = 'Кладовщик'"));
	КонецЕсли;
	
	// Краткое описание события.
	ОписаниеСобытия = НСтр("ru = 'При приемке указанных в документе ценностей (результатов работ) установлены расхождения с сопроводительными документами.'");
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		Данные, "КраткоеОписаниеСобытия", ОписаниеСобытия);
	
	// Заключение комиссии.
	Если ЗначениеЗаполнено(ВыборкаШапка.ЗаключениеКомиссии) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			Данные, "ЗаключениеКомиссии", ВыборкаШапка.ЗаключениеКомиссии);
	КонецЕсли;
	
	// Результаты приемки.
	РезультатыПриемки = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(
		Данные, "РезультатыПриемки");
	
	ШтрихкодыКомбинаций = Неопределено;
	ШтрихкодыНоменклатуры = Неопределено;
	НоменклатураПартнеровСервер.ШтрихкодыПоТоварам(ВыборкаТовары, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры);	
	
	ВыборкаДляСопоставления = НоменклатураПартнеровСервер.ВыборкаДляСопоставленияНоменклатуры(Основание);
	СоответствиеСтавокНДСКонтрагента = Новый Соответствие;
	ЗаполнитьСоответствиеСтавокНДС(СоответствиеСтавокНДСКонтрагента);	
	ТаблицаСопоставления = ВыборкаДляСопоставления.Выгрузить();
	
	Маркировка                 = СтруктураДанных.ШтрихкодыУпаковок.Выгрузить();
	Маркировка                 = ЭлектронноеВзаимодействиеИСМП.ЧастичноеСодержимоеТОРГ2(Маркировка);
	ТаблицаУпаковкиРасхождения = СтруктураДанных.ШтрихкодыУпаковокРасхождения.Выгрузить();
	ТаблицаУпаковкиРасхождения = ЭлектронноеВзаимодействиеИСМП.ЧастичноеСодержимоеТОРГ2(ТаблицаУпаковкиРасхождения, "ТипРасхождения");
	
	ВыборкаТовары.Сбросить();
	Пока ВыборкаТовары.Следующий() Цикл
		
		НоваяСтрока = РезультатыПриемки.Добавить();
		НоваяСтрока.ЕдиницаИзмеренияНаименование = ВыборкаТовары.ЕдиницаИзмеренияНаименование;
		НоваяСтрока.ЕдиницаИзмеренияКод = ВыборкаТовары.ЕдиницаИзмеренияКод;
		НоваяСтрока.ИнформацияОРасхождениях = ВыборкаТовары.КомментарийМенеджера;
		
		НоваяСтрока.Товар = Новый Структура;
		НоваяСтрока.Товар.Вставить("Наименование", ВыборкаТовары.НоменклатураНаименование);
		НоваяСтрока.Товар.Вставить("Характеристика", ВыборкаТовары.ХарактеристикаНаименование);
		НоваяСтрока.Товар.Вставить("Артикул", ВыборкаТовары.Артикул);
		НоваяСтрока.Товар.Вставить("Код", ВыборкаТовары.Код);
		НоваяСтрока.Товар.Вставить("Паспорт", ВыборкаТовары.НомерПаспорта);
		
		Если ЗначениеЗаполнено(ВыборкаТовары.КоличествоПоДокументам) Тогда
			НоваяСтрока.ПоДокументу = Новый Структура;
			НоваяСтрока.ПоДокументу.Вставить("Количество", ВыборкаТовары.КоличествоПоДокументам);
			НоваяСтрока.ПоДокументу.Вставить("Цена", ВыборкаТовары.Цена);
			НоваяСтрока.ПоДокументу.Вставить("СтавкаНДС", ВыборкаТовары.СтавкаНДС);
			НоваяСтрока.ПоДокументу.Вставить("СуммаНДС", ВыборкаТовары.СуммаНДСПоДокументам);
			НоваяСтрока.ПоДокументу.Вставить("СуммаСНДС", ВыборкаТовары.СуммаСНДСПоДокументам);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ВыборкаТовары.КоличествоПоФакту) Тогда
			НоваяСтрока.ПоФакту = Новый Структура;
			НоваяСтрока.ПоФакту.Вставить("Количество", ВыборкаТовары.КоличествоПоФакту);
			НоваяСтрока.ПоФакту.Вставить("Цена", ВыборкаТовары.ЦенаПоФакту);
			НоваяСтрока.ПоФакту.Вставить("СтавкаНДС", ВыборкаТовары.СтавкаНДС);
			НоваяСтрока.ПоФакту.Вставить("СуммаНДС", ВыборкаТовары.СуммаНДСПоФакту);
			НоваяСтрока.ПоФакту.Вставить("СуммаСНДС", ВыборкаТовары.СуммаСНДСПоФакту);
			
			ЭлектронноеВзаимодействиеИСМП.ЗаполнитьСведенияОМаркировкеАктОРасхождениях_2019(
				НоваяСтрока.ПоФакту,
				ВыборкаТовары, Маркировка, "КоличествоПоФакту");
			
		КонецЕсли;
		
		НоваяСтрока.Излишки   = Новый Структура;
		НоваяСтрока.Недостача = Новый Структура;
		НоваяСтрока.Брак      = Новый Структура;
		
		КоличествоБрак     = 0;
		СуммаНДСБрак       = 0;
		СуммаСНДСБрак      = 0;
		СуммаНДСНедостача  = 0;
		СуммаСНДСНедостача = 0;
		
		Если ВыборкаТовары.КоличествоПоФакту > ВыборкаТовары.КоличествоПоДокументам Тогда
			НоваяСтрока.Излишки.Вставить("Количество", ВыборкаТовары.КоличествоПоФакту - ВыборкаТовары.КоличествоПоДокументам);
		ИначеЕсли ВыборкаТовары.КоличествоПоФакту < ВыборкаТовары.КоличествоПоДокументам Тогда
			КоличествоРасхождение = ВыборкаТовары.КоличествоПоДокументам - ВыборкаТовары.КоличествоПоФакту;
			КоличествоБрак = ЭлектронноеВзаимодействиеИСМП.ПолучитьКоличествоОформитьРасхожденияКакБрак(ВыборкаТовары, ТаблицаУпаковкиРасхождения);
			СуммаНДСНедостача  = ВыборкаТовары.СуммаНДСПоДокументам - ВыборкаТовары.СуммаНДСПоФакту;
			СуммаСНДСНедостача = ВыборкаТовары.СуммаСНДСПоДокументам - ВыборкаТовары.СуммаСНДСПоФакту;
			
			Если КоличествоБрак > 0 Тогда
				
				КоличествоБрак      = Мин(КоличествоРасхождение, КоличествоБрак);
				Если КоличествоРасхождение = КоличествоБрак Тогда
					СуммаНДСБрак  = СуммаНДСНедостача;
					СуммаСНДСБрак = СуммаСНДСНедостача;
				Иначе
					СуммаНДСБрак  = Окр(СуммаНДСНедостача  * КоличествоБрак / КоличествоРасхождение, 2);
					СуммаСНДСБрак = Окр(СуммаСНДСНедостача * КоличествоБрак / КоличествоРасхождение, 2);
				КонецЕсли;
				
				СуммаНДСНедостача  = СуммаНДСНедостача - СуммаНДСБрак;
				СуммаСНДСНедостача = СуммаСНДСНедостача - СуммаСНДСБрак;
				
				КоличествоРасхождение = КоличествоРасхождение - КоличествоБрак;
				
				НоваяСтрока.Брак.Вставить("Количество", КоличествоБрак);
				НоваяСтрока.Брак.Вставить("СуммаНДС",   СуммаНДСБрак);
				НоваяСтрока.Брак.Вставить("СуммаСНДС",  СуммаСНДСБрак);
				
			КонецЕсли;
			
			Если КоличествоРасхождение > 0 Тогда 
				НоваяСтрока.Недостача.Вставить("Количество", КоличествоРасхождение);
			КонецЕсли;
		КонецЕсли;
		
		// Расхождения по кодам маркировки
		ТипРасхождения = ИнтеграцияИСМП.ТипРасхожденияИСМПБрак();
		ЭлектронноеВзаимодействиеИСМП.ЗаполнитьСведенияОМаркировкеАктОРасхождениях_2019(НоваяСтрока.Брак,
			ВыборкаТовары, ТаблицаУпаковкиРасхождения, "КоличествоПоДокументам", Истина, ТипРасхождения);
			
		ТипРасхождения = ИнтеграцияИСМП.ТипРасхожденияИСМПИзлишек();
		ЭлектронноеВзаимодействиеИСМП.ЗаполнитьСведенияОМаркировкеАктОРасхождениях_2019(НоваяСтрока.Излишки,
			ВыборкаТовары, ТаблицаУпаковкиРасхождения, "КоличествоПоФакту", Истина, ТипРасхождения);
		
		ТипРасхождения = ИнтеграцияИСМП.ТипРасхожденияИСМПНедостача();
		ЭлектронноеВзаимодействиеИСМП.ЗаполнитьСведенияОМаркировкеАктОРасхождениях_2019(НоваяСтрока.Недостача,
			ВыборкаТовары, ТаблицаУпаковкиРасхождения, "КоличествоПоДокументам", Истина, ТипРасхождения);
		
		Если ВыборкаТовары.СуммаНДСПоФакту > ВыборкаТовары.СуммаНДСПоДокументам Тогда
			НоваяСтрока.Излишки.Вставить("СуммаНДС", ВыборкаТовары.СуммаНДСПоФакту - ВыборкаТовары.СуммаНДСПоДокументам);
		ИначеЕсли СуммаНДСНедостача > 0 Тогда
			НоваяСтрока.Недостача.Вставить("СуммаНДС", СуммаНДСНедостача);
		КонецЕсли;
		Если ВыборкаТовары.СуммаСНДСПоФакту > ВыборкаТовары.СуммаСНДСПоДокументам Тогда
			НоваяСтрока.Излишки.Вставить("СуммаСНДС", ВыборкаТовары.СуммаСНДСПоФакту - ВыборкаТовары.СуммаСНДСПоДокументам);
		ИначеЕсли СуммаСНДСНедостача > 0 Тогда
			НоваяСтрока.Недостача.Вставить("СуммаСНДС", СуммаСНДСНедостача);
		КонецЕсли;
		
		// Сопоставление.
		ПараметрыОтбора = Новый Структура;
		ПараметрыОтбора.Вставить("Номенклатура", ВыборкаТовары.Номенклатура);
		Если ВыборкаТовары.Характеристика <> Неопределено Тогда
			ПараметрыОтбора.Вставить("Характеристика", ВыборкаТовары.Характеристика);
		Иначе
			ПараметрыОтбора.Вставить("Характеристика", Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());				
		КонецЕсли;
		ПараметрыОтбора.Вставить("Упаковка", ВыборкаТовары.Упаковка);
		СтрокиИзНоменклатурыКонтрагентов = ТаблицаСопоставления.НайтиСтроки(ПараметрыОтбора);
		Если СтрокиИзНоменклатурыКонтрагентов.Количество() Тогда
			НайденнаяСтрока = СтрокиИзНоменклатурыКонтрагентов[0];
			НоваяСтрока.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(НайденнаяСтрока,,,,СоответствиеСтавокНДСКонтрагента);
	    Иначе
			НоваяСтрока.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(ВыборкаТовары, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры);
		КонецЕсли;
		
	КонецЦикла;
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(Данные, РезультатыПриемки, "РезультатыПриемки");
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.НайтиСоздатьАктОРасхождениях_ФНС_2019.
Процедура НайтиСоздатьАктОРасхождениях_ФНС_2019(ДеревоДанных, ДокументУчета = Неопределено, СпособОбработки = "", ОписаниеОшибки = "") Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Данные = Новый Структура;
	Для каждого СтрокаДерева Из ДеревоДанных.Строки Цикл
		Путь = СтрокаДерева.ПолныйПуть;
		ДанныеСтроки = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(ДеревоДанных, Путь);
		Данные.Вставить(Путь, ДанныеСтроки);
	КонецЦикла;
	
	ТекущаяДатаСеанса = ТекущаяДатаСеанса();
	
	Если ЗначениеЗаполнено(ДокументУчета) Тогда
		ДокументОбъект = ДокументУчета.ПолучитьОбъект();
		// Попытка заблокировать документ.
		Попытка
			ДокументОбъект.Заблокировать();
		Исключение
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить данные документа ""%1"".
				|Возможно, документ редактируется другим пользователем'"),
				Строка(ДокументОбъект.Ссылка));
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
		// конец попытки заблокировать документ.
		Если ДокументОбъект.Проведен Тогда 
			РежимЗаписи = РежимЗаписиДокумента.Проведение;
			Текст = НСтр("ru = 'Операция возможна только для непроведенных документов'");
        КонецЕсли;		
	Иначе
		ДокументОбъект = Документы.АктОРасхожденияхПослеОтгрузки.СоздатьДокумент();
		ДокументОбъект.Дата = ТекущаяДатаСеанса;
		ДокументОбъект.УстановитьНовыйНомер();
	КонецЕсли;
	ДокументОбъект.ОбменДанными.Загрузка = Истина;
	
	// Шапка.
	ДокументОбъект.ОснованиеДляСоставленияАкта = "Входящий электронный документ";	
	ДокументОбъект.Статус = Перечисления.СтатусыАктаОРасхождениях.НеСогласовано;
	
	СведенияОПродавце = РеквизитыУчастникаАктаОРасхождениях(Данные.Продавец);
	СсылкаНаОбъектПоИННКПП("Организации", СведенияОПродавце.ИНН, СведенияОПродавце.КПП, ДокументОбъект.Организация);
	
	СведенияОПокупателе = РеквизитыУчастникаАктаОРасхождениях(Данные.Покупатель);	
	СсылкаНаОбъектПоИННКПП("Контрагенты", СведенияОПокупателе.ИНН, СведенияОПокупателе.КПП, ДокументОбъект.Контрагент);	
	ПартнерКонтрагента = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОбъект.Контрагент, "Партнер"); 
	Если Не ЗначениеЗаполнено(ДокументОбъект.Партнер) И ЗначениеЗаполнено(ПартнерКонтрагента) Тогда
		ДокументОбъект.Партнер = ПартнерКонтрагента;
	КонецЕсли;	
	
	СведенияОГрузоотправителе = РеквизитыУчастникаАктаОРасхождениях(Данные.Грузоотправитель);
	Грузоотправитель = Справочники.Контрагенты.ПустаяСсылка();
	СсылкаНаОбъектПоИННКПП("Контрагенты", СведенияОГрузоотправителе.ИНН, СведенияОГрузоотправителе.КПП, Грузоотправитель);
	Если ЗначениеЗаполнено(Грузоотправитель) Тогда
		ДокументОбъект.Грузоотправитель = Грузоотправитель.НаименованиеПолное;
	КонецЕсли;
	
	СведенияОСтраховойКомпании = РеквизитыУчастникаАктаОРасхождениях(Данные.СтраховаяКомпания);
	СтраховаяКомпания = Справочники.Контрагенты.ПустаяСсылка();	
	СсылкаНаОбъектПоИННКПП("Контрагенты", СведенияОСтраховойКомпании.ИНН, СведенияОСтраховойКомпании.КПП, СтраховаяКомпания);
	Если ЗначениеЗаполнено(СтраховаяКомпания) Тогда
		ДокументОбъект.СтраховаяКомпания = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтраховаяКомпания, "Партнер");
	КонецЕсли;
	
	ДокументОснование = Неопределено;
	ДокументЗаполненПоОснованию = Ложь;
	СопроводительныйДокумент = Данные.СведенияОбОсмотреГруза.СопроводительныйДокумент;
	Если ЗначениеЗаполнено(СопроводительныйДокумент.Номер) Тогда
		ДокументОснование = НайтиРеализациюТоваровУслуг(ДокументОбъект.Организация, СопроводительныйДокумент.Номер, СопроводительныйДокумент.Дата);
		Если ЗначениеЗаполнено(ДокументОснование) Тогда
			ЗаполнитьНаОсновании(ДокументОснование, ДокументОбъект);
			ДокументЗаполненПоОснованию = Истина;
		КонецЕсли;
	КонецЕсли;
	
	ДокументОбъект.НомерВходящегоДокумента = Данные.НомерДокумента;
	ДокументОбъект.ДатаВходящегоДокумента = Данные.ДатаДокумента;
	
	ДокументОбъект.МестоПриемкиТовара = Данные.СведенияОбОсмотреГруза.МестоСоставленияДокумента;
	ДокументОбъект.ДатаДоставкиТоваров = Данные.СведенияОбОсмотреГруза.ДатаОсмотра;
	
	ДокументОбъект.УсловияХраненияТовараДоВскрытияНаСкладеПолучателя = Данные.ОбстоятельстваПриемки.УсловияХраненияТоваровНаСкладеПолучателя;
	ДокументОбъект.СостояниеТарыИУпаковки = Данные.ОбстоятельстваПриемки.СостояниеТарыУпаковки;
	ДокументОбъект.СпособОпределенияКоличества = Данные.ОбстоятельстваПриемки.ТипОпределенияКоличества;
	ДокументОбъект.ДополнительнаяИнформация = Данные.ОбстоятельстваПриемки.ДополнительныеСведения;
	
	Приемщик = РеквизитыПриемщикаАктаОРасхождениях(Данные.СведенияОЛицеПринявшемТовар);
	ДокументОбъект.КладовщикПринявшийТовар = Приемщик.Представление;
	
	ДокументОбъект.ЗаключениеКомиссии = Данные.ЗаключениеКомиссии;
	
	// Приемка товаров.
	ДокументОбъект.ПриемкаТоваров.Очистить();
	НоваяСтрока = ДокументОбъект.ПриемкаТоваров.Добавить();	
	НоваяСтрока.ДатаПрибытияВПунктНазначения = Данные.СведенияОВремениПриемки.ДатаПрибытияВПунктНазначения;
	НоваяСтрока.ДатаВыдачиОрганизациейТранспорта = Данные.СведенияОВремениПриемки.ДатаВыдачиОрганизациейТранспорта;
	НоваяСтрока.ДатаВскрытия = Данные.СведенияОВремениПриемки.ДатаВскрытияТранспортныхСредств;
	НоваяСтрока.ДатаДоставкиНаСкладПолучателя = Данные.СведенияОВремениПриемки.ДатаДоставкиНаСкладПолучателя;	
	
	// Штрихкоды упаковок маркированной продукции
	ШтрихкодыУпаковокФакт = ЭлектронноеВзаимодействиеИСМП.ТаблицаШтрихкодыУпаковокНоменклатура();
	ШтрихкодыУпаковокРасхождения = ЭлектронноеВзаимодействиеИСМП.ТаблицаШтрихкодыУпаковокНоменклатура();
	
	// Товары.
	Если Не ДокументЗаполненПоОснованию Тогда
		ДокументОбъект.Товары.Очистить();
		Для Каждого СтрокаПриемки Из Данные.РезультатыПриемки Цикл
			СтрокаТовара = ДокументОбъект.Товары.Добавить();
			Если ЗначениеЗаполнено(СтрокаПриемки.ПоДокументу.Цена) Тогда
				СтрокаТовара.Цена = СтрокаПриемки.ПоДокументу.Цена;
				СтрокаТовара.СтавкаНДС = СтрокаПриемки.ПоДокументу.СтавкаНДС;
				СтрокаТовара.ЗаполненоПоРеализации = Истина;			
			Иначе
				СтрокаТовара.Цена = СтрокаПриемки.ПоФакту.Цена;
				СтрокаТовара.СтавкаНДС = СтрокаПриемки.ПоФакту.СтавкаНДС;
			КонецЕсли;
			
			СтрокаТовара.КоличествоПоДокументу = СтрокаПриемки.ПоДокументу.Количество;
			СтрокаТовара.КоличествоУпаковокПоДокументу = СтрокаПриемки.ПоДокументу.Количество;
			Если ДокументОбъект.ЦенаВключаетНДС Тогда
				СтрокаТовара.СуммаПоДокументу = СтрокаПриемки.ПоДокументу.СуммаСНДС;
			Иначе
				СтрокаТовара.СуммаПоДокументу = СтрокаПриемки.ПоДокументу.СуммаСНДС - СтрокаПриемки.ПоДокументу.СуммаНДС;
			КонецЕсли;
			СтрокаТовара.СуммаНДСПоДокументу = СтрокаПриемки.ПоДокументу.СуммаНДС;
			СтрокаТовара.СуммаСНДСПоДокументу = СтрокаПриемки.ПоДокументу.СуммаСНДС;
			
			СтрокаТовара.Количество = СтрокаПриемки.ПоФакту.Количество;
			СтрокаТовара.КоличествоУпаковок = СтрокаПриемки.ПоФакту.Количество;
			Если ДокументОбъект.ЦенаВключаетНДС Тогда
				СтрокаТовара.Сумма = СтрокаПриемки.ПоФакту.СуммаСНДС;
			Иначе
				СтрокаТовара.Сумма = СтрокаПриемки.ПоФакту.СуммаСНДС - СтрокаПриемки.ПоФакту.СуммаНДС;
			КонецЕсли;
			СтрокаТовара.СуммаНДС = СтрокаПриемки.ПоФакту.СуммаНДС;
			СтрокаТовара.СуммаСНДС = СтрокаПриемки.ПоФакту.СуммаСНДС;
			
			СтрокаТовара.КомментарийКлиента = СтрокаПриемки.ИнформацияОРасхождениях;
			
			Если ЗначениеЗаполнено(СтрокаПриемки.Сопоставление.НоменклатураИБ) Тогда
				СтрокаТовара.Номенклатура = СтрокаПриемки.Сопоставление.НоменклатураИБ;
			КонецЕсли;
			Если ЗначениеЗаполнено(СтрокаПриемки.Сопоставление.ХарактеристикаИБ) Тогда
				СтрокаТовара.Характеристика = СтрокаПриемки.Сопоставление.ХарактеристикаИБ;
			КонецЕсли;
			Если ЗначениеЗаполнено(СтрокаПриемки.Сопоставление.УпаковкаИБ) Тогда
				СтрокаТовара.Упаковка = СтрокаПриемки.Сопоставление.УпаковкаИБ;
			КонецЕсли;
			
			ЭлектронноеВзаимодействиеИСМП.ДобавитьШтрихкодыТаблицыШтрихкодовАктОРасхождениях(
				ШтрихкодыУпаковокФакт, ШтрихкодыУпаковокРасхождения, СтрокаПриемки);
			
		КонецЦикла;
	Иначе
		
		ПараметрыОтбораТовары = Новый Структура;
		ПараметрыОтбораТовары.Вставить("Номенклатура");
		
		Для Каждого СтрокаПриемки Из Данные.РезультатыПриемки Цикл
			ПараметрыОтбора = Новый Структура;
			ПараметрыОтбора.Вставить("Номенклатура", СтрокаПриемки.Сопоставление.НоменклатураИБ);
			Если ЗначениеЗаполнено(СтрокаПриемки.Сопоставление.ХарактеристикаИБ) Тогда
				ПараметрыОтбора.Вставить("Характеристика", СтрокаПриемки.Сопоставление.ХарактеристикаИБ);
			КонецЕсли;
			Если ЗначениеЗаполнено(СтрокаПриемки.Сопоставление.УпаковкаИБ) Тогда
				ЕдиницаХраненияНоменклатуры = ЭлектронноеВзаимодействиеУТВызовСервера.ЕдиницаХраненияНоменклатуры(СтрокаПриемки.Сопоставление.НоменклатураИБ);
				Если СтрокаПриемки.Сопоставление.УпаковкаИБ <> ЕдиницаХраненияНоменклатуры Тогда
					ПараметрыОтбора.Вставить("Упаковка", СтрокаПриемки.Сопоставление.УпаковкаИБ);
				КонецЕсли;
			КонецЕсли;
			Если СтрокаПриемки.ПоДокументу.Количество > 0 Тогда
				ПараметрыОтбора.Вставить("ЗаполненоПоРеализации", Истина);
			Иначе
				ПараметрыОтбора.Вставить("ЗаполненоПоРеализации", Ложь);
			КонецЕсли;
			СтрокиТовара = ДокументОбъект.Товары.НайтиСтроки(ПараметрыОтбора);
			
			Если СтрокиТовара.Количество() Тогда
				СтрокаТовара = СтрокиТовара[0]; 
				СтрокаТовара.Количество = СтрокаПриемки.ПоФакту.Количество;
				СтрокаТовара.КоличествоУпаковок = СтрокаПриемки.ПоФакту.Количество;
				Если ДокументОбъект.ЦенаВключаетНДС Тогда
					СтрокаТовара.Сумма = СтрокаПриемки.ПоФакту.СуммаСНДС;
				Иначе
					СтрокаТовара.Сумма = СтрокаПриемки.ПоФакту.СуммаСНДС - СтрокаПриемки.ПоФакту.СуммаНДС;
				КонецЕсли;
				СтрокаТовара.СуммаНДС = СтрокаПриемки.ПоФакту.СуммаНДС;
				СтрокаТовара.СуммаСНДС = СтрокаПриемки.ПоФакту.СуммаСНДС;
				
				СтрокаТовара.Реализация = ДокументОснование;	
				СтрокаТовара.Склад = ДокументОснование.Склад;	
				
				СтрокаТовара.КомментарийКлиента = СтрокаПриемки.ИнформацияОРасхождениях;
				
				ЭлектронноеВзаимодействиеИСМП.ДобавитьШтрихкодыТаблицыШтрихкодовАктОРасхождениях(
					ШтрихкодыУпаковокФакт, ШтрихкодыУпаковокРасхождения, СтрокаПриемки);
				
			Иначе //если можно добавлять новые позиции - тогда вот новая ветка
				СтрокаТовара = ДокументОбъект.Товары.Добавить();
				Если ЗначениеЗаполнено(СтрокаПриемки.ПоДокументу.Цена) Тогда
					СтрокаТовара.Цена = СтрокаПриемки.ПоДокументу.Цена;
					СтрокаТовара.СтавкаНДС = СтрокаПриемки.ПоДокументу.СтавкаНДС;
					СтрокаТовара.ЗаполненоПоРеализации = Истина;
				Иначе
					СтрокаТовара.Цена = СтрокаПриемки.ПоФакту.Цена;
					СтрокаТовара.СтавкаНДС = СтрокаПриемки.ПоФакту.СтавкаНДС;
				КонецЕсли;
				
				СтрокаТовара.КоличествоПоДокументу = СтрокаПриемки.ПоДокументу.Количество;
				СтрокаТовара.КоличествоУпаковокПоДокументу = СтрокаПриемки.ПоДокументу.Количество;
				СтрокаТовара.СуммаПоДокументу = СтрокаПриемки.ПоДокументу.СуммаСНДС - СтрокаПриемки.ПоДокументу.СуммаНДС;
				СтрокаТовара.СуммаНДСПоДокументу = СтрокаПриемки.ПоДокументу.СуммаНДС;
				СтрокаТовара.СуммаСНДСПоДокументу = СтрокаПриемки.ПоДокументу.СуммаСНДС;
				
				СтрокаТовара.Количество = СтрокаПриемки.ПоФакту.Количество;
				СтрокаТовара.КоличествоУпаковок = СтрокаПриемки.ПоФакту.Количество;
				СтрокаТовара.Сумма = СтрокаПриемки.ПоФакту.СуммаСНДС - СтрокаПриемки.ПоФакту.СуммаНДС;
				СтрокаТовара.СуммаНДС = СтрокаПриемки.ПоФакту.СуммаНДС;
				СтрокаТовара.СуммаСНДС = СтрокаПриемки.ПоФакту.СуммаСНДС;
				
				СтрокаТовара.КомментарийКлиента = СтрокаПриемки.ИнформацияОРасхождениях;
				
				Если ЗначениеЗаполнено(СтрокаПриемки.Сопоставление.НоменклатураИБ) Тогда
					СтрокаТовара.Номенклатура = СтрокаПриемки.Сопоставление.НоменклатураИБ;
				КонецЕсли;
				Если ЗначениеЗаполнено(СтрокаПриемки.Сопоставление.ХарактеристикаИБ) Тогда
					СтрокаТовара.Характеристика = СтрокаПриемки.Сопоставление.ХарактеристикаИБ;
				КонецЕсли;
				Если ЗначениеЗаполнено(СтрокаПриемки.Сопоставление.УпаковкаИБ) Тогда
					СтрокаТовара.Упаковка = СтрокаПриемки.Сопоставление.УпаковкаИБ;
				КонецЕсли;
				
				ЭлектронноеВзаимодействиеИСМП.ДобавитьШтрихкодыТаблицыШтрихкодовАктОРасхождениях(
					ШтрихкодыУпаковокФакт, ШтрихкодыУпаковокРасхождения, СтрокаПриемки);
				
			КонецЕсли;
		КонецЦикла;		
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеИСМП.СвернутьТаблицуШтрихкодовУпаковокАкт(ШтрихкодыУпаковокФакт);
	ЭлектронноеВзаимодействиеИСМП.СвернутьТаблицуШтрихкодовУпаковокАкт(ШтрихкодыУпаковокРасхождения);
	
	ДокументОбъект.ШтрихкодыУпаковокФактЭДО.Загрузить(ШтрихкодыУпаковокФакт);
	Если ШтрихкодыУпаковокРасхождения.Количество() Тогда
		ДокументОбъект.ШтрихкодыУпаковокРасхождения.Загрузить(ШтрихкодыУпаковокРасхождения);
	ИначеЕсли ШтрихкодыУпаковокФакт.Количество() Тогда
		// В акте может присутствовать маркируемая продукция. Для случая, когда по кодам нет, но есть расхождения по количеству,
		// необходимо заполнять штрихкоды упаковок документа для заполнения документа КорректировкаРеализации на основании акта.
		МассивШтрихкодов = ШтрихкодыУпаковокФакт.ВыгрузитьКолонку("ЗначениеШтрихкода");
		ШтрихкодыУпаковок = ШтрихкодированиеИС.ШтрихкодыУпаковок(МассивШтрихкодов);
		ДокументОбъект.ШтрихкодыУпаковок.ЗагрузитьКолонку(ШтрихкодыУпаковок.ВыгрузитьКолонку("Ссылка"), "ШтрихкодУпаковки");
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ДокументОбъект.НалогообложениеНДС) Тогда
		Если ДокументОбъект.Товары.Итог("СуммаНДС") = 0 Тогда
			ДокументОбъект.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС;
		Иначе
			ДокументОбъект.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС;
		КонецЕсли;
	КонецЕсли;
	
	Попытка
		// запись версии создаваемого документа в подсистеме версионирования
		ДокументОбъект.ОбменДанными.Загрузка = Ложь;
		ВерсионированиеОбъектовСобытия.ЗаписатьВерсиюДокумента(ДокументОбъект, Ложь, РежимЗаписи, РежимПроведенияДокумента.Неоперативный);
		ДокументОбъект.ОбменДанными.Загрузка = Истина;
		// запись версии конец
						
		ДокументОбъект.Записать(РежимЗаписи);
		ДокументОбъект.Разблокировать();			
		ДокументУчета = ДокументОбъект.Ссылка;
		
		//Запись в Реестр документов
		ТаблицыДанных = ПроведениеДокументов.ДанныеДокументаДляПроведения(ДокументУчета, "РеестрДокументов");
		РегистрыСведений.РеестрДокументов.ЗаписатьДанные(ТаблицыДанных, ДокументУчета,  Неопределено, Ложь);
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка()),
					Текст);
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка, ДокументОбъект.Метаданные(), ДокументУчета,
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти

#Область АктСверкиВзаиморасчетов

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеАктСверкиВзаиморасчетов_ИнформацияОтправителя.
Процедура ЗаполнитьДанныеАктСверкиВзаиморасчетов_ИнформацияОтправителя(Основание, Настройки, Данные, Описание, Отказ) Экспорт
	
	МассивОбъектов = Новый Массив;
	МассивОбъектов.Добавить(Основание);
	ПараметрыПечати = Новый Структура();
	
	ДанныеПечати = Документы.СверкаВзаиморасчетов2_5_11.ПолучитьДанныеДляПечатнойФормыУПД(ПараметрыПечати, МассивОбъектов);
	ВыборкаШапка = ДанныеПечати.РезультатПоШапке.Выбрать();
	ВыборкаШапка.Следующий();
	
	Если ВыборкаШапка.РежимСверкиИтоговВзаиморасчетов <> Перечисления.РежимСверкиИтоговВзаиморасчетов.ПоДоговорам Тогда
		ТекстСообщения = НСтр("ru = 'Обмен по ЭДО доступен только для сверок взаиморасчетов с настройкой ""Сверять итоги по: Договорам""'");
		ОбщегоНазначения.СообщитьПользователю(
				ТекстСообщения,
				ВыборкаШапка.Ссылка,
				"Объект.РежимСверкиИтоговВзаиморасчетов");
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	///////////////////////////////////////////////////////////////////////////////
	// Акт сверки взаимных расчетов, информация отправителя.
	// Номер документа.
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		Данные, "НомерДокумента", ПрефиксацияОбъектовКлиентСервер.НомерНаПечать(ВыборкаШапка.НомерДокумента,
			Истина,
			Истина));
	
	// Дата начала периода сверки.
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		Данные, "ДатаНачалаПериодаСверки", ВыборкаШапка.ДатаНачалаПериодаСверки);
		
	// Дата окончания периода сверки.
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		Данные, "ДатаОкончанияПериодаСверки", ВыборкаШапка.ДатаОкончанияПериодаСверки);
	
	///////////////////////////////////////////////////////////////////////////////
	// Сведения документа, кроме сведений таблицы акта сверки взаимных расчетов.
	// Дата окончания периода сверки.
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		Данные, "КодВалюты", ВыборкаШапка.КодВалюты);
	
	ЗаполнитьОтправителяПолучателяАктСверкиВзаиморасчетов(Данные, ВыборкаШапка.Отправитель,
		ВыборкаШапка.Ссылка, ВыборкаШапка.ДатаДокумента, Истина);
	ЗаполнитьОтправителяПолучателяАктСверкиВзаиморасчетов(Данные, ВыборкаШапка.Получатель,
		ВыборкаШапка.Ссылка, ВыборкаШапка.ДатаДокумента, Ложь);
	
	///////////////////////////////////////////////////////////////////////////////
	// Сведения таблицы акта сверки взаимных расчетов.
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		Данные, "СведенияОтправителя.СальдоНаНачалоПериодаДебет", ВыборкаШапка.СальдоНаНачалоПериодаДебет);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		Данные, "СведенияОтправителя.СальдоНаНачалоПериодаКредит", ВыборкаШапка.СальдоНаНачалоПериодаКредит);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		Данные, "СведенияОтправителя.ОборотПоДебету", ВыборкаШапка.ОборотПоДебету);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		Данные, "СведенияОтправителя.ОборотПоКредиту", ВыборкаШапка.ОборотПоКредиту);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		Данные, "СведенияОтправителя.СальдоНаКонецПериодаДебет", ВыборкаШапка.СальдоНаКонецПериодаДебет);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		Данные, "СведенияОтправителя.СальдоНаКонецПериодаКредит", ВыборкаШапка.СальдоНаКонецПериодаКредит);

	///////////////////////////////////////////////////////////////////////////////
	// Сведения о договоре.
	Выборка = ДанныеПечати.РезультатПоТабличнойЧасти.Выбрать();
	СведенияПоДоговорам = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(
		Данные, "СведенияОтправителя.СведенияПоДоговорам"); // Первый уровень.
	СведенияПоДокументам = Неопределено; // Второй уровень.
	СведенияПоОперациям = Неопределено; // Третий уровень.
	
	ТекущиеПоля = Новый Структура("ИдентификаторДоговора, ИдентификаторДокумента, ПорядковыйНомер");
	ТекущиеПоля.ИдентификаторДоговора = ""; // В целях предотвращения некорректного сравнения вида Неопределено = Неопределено.
	НоваяСтрокаПервогоУровня = Неопределено;
	НоваяСтрокаВторогоУровня = Неопределено;
	Пока Выборка.Следующий() Цикл
		
		ЕстьИзмененияГруппировки = Ложь;
		Если ТекущиеПоля.ИдентификаторДоговора <> Выборка.ИдентификаторДоговора Тогда
			
			НоваяСтрокаПервогоУровня = СведенияПоДоговорам.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрокаПервогоУровня, Выборка);
			Если Выборка.ИдентификаторДоговора <> Неопределено Тогда
				НоваяСтрокаПервогоУровня.ИдентификаторДоговора = Строка(Выборка.ИдентификаторДоговора.УникальныйИдентификатор());
			КонецЕсли;
			
			СведенияПоДокументам = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(
				Данные, "СведенияОтправителя.СведенияПоДоговорам.НомерСтроки.СведенияПоДокументам");
			НоваяСтрокаПервогоУровня.СведенияПоДокументам = СведенияПоДокументам;
			
			ЕстьИзмененияГруппировки = Истина;
			
		КонецЕсли;
		
		Если НоваяСтрокаПервогоУровня <> Неопределено
			И (ТекущиеПоля.ИдентификаторДокумента <> Выборка.ИдентификаторДокумента
				Или ЕстьИзмененияГруппировки) Тогда
			
			НоваяСтрокаВторогоУровня = НоваяСтрокаПервогоУровня.СведенияПоДокументам.Добавить();
			Если Не ПустаяСтрока(Выборка.НаименованиеДокумента) Тогда
				ЗаполнитьЗначенияСвойств(НоваяСтрокаВторогоУровня, Выборка);
				Если Выборка.ИдентификаторДокумента <> Неопределено Тогда
					НоваяСтрокаВторогоУровня.ИдентификаторДокумента = Строка(Выборка.ИдентификаторДокумента.УникальныйИдентификатор());
				Иначе
					НоваяСтрокаВторогоУровня.ИдентификаторДокумента = "0";
				КонецЕсли;
				
				ЕстьИзмененияГруппировки = Истина;
				
			Иначе
				// При отсутствии оборотов предусматривается фиктивная строка состоящая из нулевых сумм.
				НоваяСтрокаВторогоУровня.ДатаДокумента = Дата(2000, 1, 1);
				НоваяСтрокаВторогоУровня.ИдентификаторДокумента = "0";
				НоваяСтрокаВторогоУровня.НаименованиеДокумента = НСтр("ru='Документы за период отсутствуют.'");
				НоваяСтрокаВторогоУровня.НомерДокумента = "0";
			КонецЕсли;
			
			СведенияПоОперациям = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(
				Данные, "СведенияОтправителя.СведенияПоДоговорам.НомерСтроки.СведенияПоДокументам.НомерСтроки.СведенияПоОперациям");
			НоваяСтрокаВторогоУровня.СведенияПоОперациям = СведенияПоОперациям;
			
		КонецЕсли;
		
		Если НоваяСтрокаВторогоУровня <> Неопределено
			И (ТекущиеПоля.ПорядковыйНомер <> Выборка.ПорядковыйНомер
				Или ЕстьИзмененияГруппировки) Тогда
			
			НоваяСтрокаТретьегоУровня = НоваяСтрокаВторогоУровня.СведенияПоОперациям.Добавить();
			Если Выборка.ПорядковыйНомер > 0 Тогда
				ЗаполнитьЗначенияСвойств(НоваяСтрокаТретьегоУровня, Выборка);
				НоваяСтрокаТретьегоУровня.ПорядковыйНомерСтроки = Выборка.ПорядковыйНомер;
				
			Иначе
				// При отсутствии оборотов предусматривается фиктивная строка состоящая из нулевых сумм.
				НоваяСтрокаТретьегоУровня.ДатаОперации = Дата(2000, 1, 1);
				НоваяСтрокаТретьегоУровня.НаименованиеОперации = НСтр("ru='Операции за период отсутствуют.'");
				НоваяСтрокаТретьегоУровня.ПорядковыйНомерСтроки = -1;
				НоваяСтрокаТретьегоУровня.СуммаДебет = 0;
				НоваяСтрокаТретьегоУровня.СуммаКредит = 0;
			КонецЕсли;
		КонецЕсли;
		
		ЗаполнитьЗначенияСвойств(ТекущиеПоля, Выборка);
		
	КонецЦикла;
	
	Если СведенияПоДоговорам.Количество() = 0 Тогда
		// При отсутствии оборотов предусматривается фиктивная строка состоящая из нулевых сумм.
		
		НоваяСтрокаПервогоУровня = СведенияПоДоговорам.Добавить();
		
		СведенияПоДокументам = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(
				Данные, "СведенияОтправителя.СведенияПоДоговорам.НомерСтроки.СведенияПоДокументам");
		НоваяСтрокаПервогоУровня.СведенияПоДокументам = СведенияПоДокументам;
		
		НоваяСтрокаВторогоУровня = НоваяСтрокаПервогоУровня.СведенияПоДокументам.Добавить();
		НоваяСтрокаВторогоУровня.ДатаДокумента = Дата(2000, 1, 1);
		НоваяСтрокаВторогоУровня.ИдентификаторДокумента = "0";
		НоваяСтрокаВторогоУровня.НаименованиеДокумента = НСтр("ru='Документы за период отсутствуют.'");
		НоваяСтрокаВторогоУровня.НомерДокумента = "0";
		
		СведенияПоОперациям = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(
				Данные, "СведенияОтправителя.СведенияПоДоговорам.НомерСтроки.СведенияПоДокументам.НомерСтроки.СведенияПоОперациям");
		НоваяСтрокаВторогоУровня.СведенияПоОперациям = СведенияПоОперациям;
		
		НоваяСтрокаТретьегоУровня = НоваяСтрокаВторогоУровня.СведенияПоОперациям.Добавить();
		
		НоваяСтрокаТретьегоУровня.ДатаОперации = Дата(2000, 1, 1);
		НоваяСтрокаТретьегоУровня.НаименованиеОперации = НСтр("ru='Операции за период отсутствуют.'");
		НоваяСтрокаТретьегоУровня.ПорядковыйНомерСтроки = -1;
		НоваяСтрокаТретьегоУровня.СуммаДебет = 0;
		НоваяСтрокаТретьегоУровня.СуммаКредит = 0;
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(Данные, СведенияПоДоговорам, "СведенияОтправителя.СведенияПоДоговорам");
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеАктСверкиВзаиморасчетов_ИнформацияПолучателя.
Процедура ЗаполнитьДанныеАктСверкиВзаиморасчетов_ИнформацияПолучателя(Основание, Настройки, Данные, Описание, Отказ) Экспорт
	
	Если ТипЗнч(Основание) = Тип("Массив") И Основание.Количество() = 0 Тогда
		// Признак наличия разногласий (при ответе на акт сверки отправителя).
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "ПризнакНаличияРазногласий", Ложь);
		
		Возврат;
	КонецЕсли;

	Если ТипЗнч(Основание) = Тип("Массив") И Основание.Количество() > 0 Тогда
		ДокументУчета = Основание[0];
	Иначе
		ДокументУчета = Основание;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ДокументУчета) Тогда
		// Признак наличия разногласий (при ответе на акт сверки отправителя).
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "ПризнакНаличияРазногласий", Ложь);
		
		Возврат;
	КонецЕсли;
	
	ПараметрыПечати = Новый Структура;
	
	ДанныеПечати = Документы.СверкаВзаиморасчетов2_5_11.ПолучитьДанныеДляПечатнойФормыУПД(ПараметрыПечати, Основание);
	ВыборкаШапка = ДанныеПечати.РезультатПоШапке.Выбрать();
	ВыборкаШапка.Следующий();
	
	Если ВыборкаШапка.РежимСверкиИтоговВзаиморасчетов <> Перечисления.РежимСверкиИтоговВзаиморасчетов.ПоДоговорам Тогда
		ТекстСообщения = НСтр("ru = 'Обмен по ЭДО доступен только для сверок взаиморасчетов с настройкой ""Сверять итоги по: Договорам""'");
		ОбщегоНазначения.СообщитьПользователю(
				ТекстСообщения,
				ВыборкаШапка.Ссылка,
				"Объект.РежимСверкиИтоговВзаиморасчетов");
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	Если ВыборкаШапка.Статус <> Перечисления.СтатусыСверокВзаиморасчетов2_5_11.СверенаСРазногласиями
		И ВыборкаШапка.Статус <> Перечисления.СтатусыСверокВзаиморасчетов2_5_11.СверенаБезРазногласий Тогда
		ТекстСообщения = НСтр("ru = 'Требуется провести документ в одном из статусов: ""Сверена с разногласиями"" или ""Сверена без разногласий""'");
		ОбщегоНазначения.СообщитьПользователю(
				ТекстСообщения,
				ВыборкаШапка.Ссылка,
				"Объект.РежимСверкиИтоговВзаиморасчетов");
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	///////////////////////////////////////////////////////////////////////////////
	// Акт сверки взаимных расчетов.
	
	ЕстьРасхождения = ВыборкаШапка.Статус = Перечисления.СтатусыСверокВзаиморасчетов2_5_11.СверенаСРазногласиями;
	
	// Признак наличия разногласий (при ответе на акт сверки отправителя).
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		Данные, "ПризнакНаличияРазногласий", ЕстьРасхождения);
	
	///////////////////////////////////////////////////////////////////////////////
	// Сведения таблицы акта сверки взаимных расчетов.
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		Данные, "СведенияПолучателя.СальдоНаНачалоПериодаДебет", ВыборкаШапка.СальдоНаНачалоПериодаДебет);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		Данные, "СведенияПолучателя.СальдоНаНачалоПериодаКредит", ВыборкаШапка.СальдоНаНачалоПериодаКредит);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		Данные, "СведенияПолучателя.ОборотПоДебету", ВыборкаШапка.ОборотПоДебету);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		Данные, "СведенияПолучателя.ОборотПоКредиту", ВыборкаШапка.ОборотПоКредиту);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		Данные, "СведенияПолучателя.СальдоНаКонецПериодаДебет", ВыборкаШапка.СальдоНаКонецПериодаДебет);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		Данные, "СведенияПолучателя.СальдоНаКонецПериодаКредит", ВыборкаШапка.СальдоНаКонецПериодаКредит);

	///////////////////////////////////////////////////////////////////////////////
	// Сведения о договоре.
	Выборка = ДанныеПечати.РезультатПоТабличнойЧасти.Выбрать();
	СведенияПоДоговорам = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(
		Данные, "СведенияПолучателя.СведенияПоДоговорам"); // Первый уровень.
	СведенияПоДокументам = Неопределено; // Второй уровень.
	СведенияПоОперациям = Неопределено; // Третий уровень.
	
	ТекущиеПоля = Новый Структура("ИдентификаторДоговора, ИдентификаторДокумента, ПорядковыйНомер");
	НоваяСтрокаПервогоУровня = Неопределено;
	НоваяСтрокаВторогоУровня = Неопределено;
	Пока Выборка.Следующий() Цикл
		
		ЕстьИзмененияГруппировки = Ложь;
		Если ТекущиеПоля.ИдентификаторДоговора <> Выборка.ИдентификаторДоговора Тогда
			
			НоваяСтрокаПервогоУровня = СведенияПоДоговорам.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрокаПервогоУровня, Выборка);
			Если Выборка.ИдентификаторДоговора <> Неопределено Тогда
				НоваяСтрокаПервогоУровня.ИдентификаторДоговора = Строка(Выборка.ИдентификаторДоговора.УникальныйИдентификатор());
			КонецЕсли;
			
			СведенияПоДокументам = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(
				Данные, "СведенияПолучателя.СведенияПоДоговорам.НомерСтроки.СведенияПоДокументам");
			НоваяСтрокаПервогоУровня.СведенияПоДокументам = СведенияПоДокументам;
			
			ЕстьИзмененияГруппировки = Истина;
			
		КонецЕсли;
		
		Если НоваяСтрокаПервогоУровня <> Неопределено
			И (ТекущиеПоля.ИдентификаторДокумента <> Выборка.ИдентификаторДокумента
				Или ЕстьИзмененияГруппировки) Тогда
			
			НоваяСтрокаВторогоУровня = НоваяСтрокаПервогоУровня.СведенияПоДокументам.Добавить();
			Если Не ПустаяСтрока(Выборка.НаименованиеДокумента) Тогда
				ЗаполнитьЗначенияСвойств(НоваяСтрокаВторогоУровня, Выборка);
				Если Выборка.ИдентификаторДокумента <> Неопределено Тогда
					НоваяСтрокаВторогоУровня.ИдентификаторДокумента = Строка(Выборка.ИдентификаторДокумента.УникальныйИдентификатор());
				Иначе
					НоваяСтрокаВторогоУровня.ИдентификаторДокумента = "0";
				КонецЕсли;
				
				ЕстьИзмененияГруппировки = Истина;
				
			Иначе
				// При отсутствии оборотов предусматривается фиктивная строка состоящая из нулевых сумм.
				НоваяСтрокаВторогоУровня.ДатаДокумента = Дата(2000, 1, 1);
				НоваяСтрокаВторогоУровня.ИдентификаторДокумента = "0";
				НоваяСтрокаВторогоУровня.НаименованиеДокумента = НСтр("ru='Документы за период отсутствуют.'");
				НоваяСтрокаВторогоУровня.НомерДокумента = "0";
			КонецЕсли;
			
			СведенияПоОперациям = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(
				Данные, "СведенияПолучателя.СведенияПоДоговорам.НомерСтроки.СведенияПоДокументам.НомерСтроки.СведенияПоОперациям");
			НоваяСтрокаВторогоУровня.СведенияПоОперациям = СведенияПоОперациям;
			
		КонецЕсли;
		
		Если НоваяСтрокаВторогоУровня <> Неопределено
			И (ТекущиеПоля.ПорядковыйНомер <> Выборка.ПорядковыйНомер
				Или ЕстьИзмененияГруппировки) Тогда
			
			НоваяСтрокаТретьегоУровня = НоваяСтрокаВторогоУровня.СведенияПоОперациям.Добавить();
			Если Выборка.ПорядковыйНомер > 0 Тогда
				ЗаполнитьЗначенияСвойств(НоваяСтрокаТретьегоУровня, Выборка);
				НоваяСтрокаТретьегоУровня.ПорядковыйНомерСтроки = Выборка.ПорядковыйНомер;
				
			Иначе
				// При отсутствии оборотов предусматривается фиктивная строка состоящая из нулевых сумм.
				НоваяСтрокаТретьегоУровня.ДатаОперации = Дата(2000, 1, 1);
				НоваяСтрокаТретьегоУровня.НаименованиеОперации = НСтр("ru='Операции за период отсутствуют.'");
				НоваяСтрокаТретьегоУровня.ПорядковыйНомерСтроки = -1;
				НоваяСтрокаТретьегоУровня.СуммаДебет = 0;
				НоваяСтрокаТретьегоУровня.СуммаКредит = 0;
			КонецЕсли;
		КонецЕсли;
		
		ЗаполнитьЗначенияСвойств(ТекущиеПоля, Выборка);
		
	КонецЦикла;
	
	Если СведенияПоДоговорам.Количество() = 0 Тогда
		// При отсутствии оборотов предусматривается фиктивная строка состоящая из нулевых сумм.
		
		НоваяСтрокаПервогоУровня = СведенияПоДоговорам.Добавить();
		
		СведенияПоДокументам = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(
				Данные, "СведенияПолучателя.СведенияПоДоговорам.НомерСтроки.СведенияПоДокументам");
		НоваяСтрокаПервогоУровня.СведенияПоДокументам = СведенияПоДокументам;
		
		НоваяСтрокаВторогоУровня = НоваяСтрокаПервогоУровня.СведенияПоДокументам.Добавить();
		НоваяСтрокаВторогоУровня.ДатаДокумента = Дата(2000, 1, 1);
		НоваяСтрокаВторогоУровня.ИдентификаторДокумента = "0";
		НоваяСтрокаВторогоУровня.НаименованиеДокумента = НСтр("ru='Документы за период отсутствуют.'");
		НоваяСтрокаВторогоУровня.НомерДокумента = "0";
		
		СведенияПоОперациям = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(
				Данные, "СведенияПолучателя.СведенияПоДоговорам.НомерСтроки.СведенияПоДокументам.НомерСтроки.СведенияПоОперациям");
		НоваяСтрокаВторогоУровня.СведенияПоОперациям = СведенияПоОперациям;
		
		НоваяСтрокаТретьегоУровня = НоваяСтрокаВторогоУровня.СведенияПоОперациям.Добавить();
		
		НоваяСтрокаТретьегоУровня.ДатаОперации = Дата(2000, 1, 1);
		НоваяСтрокаТретьегоУровня.НаименованиеОперации = НСтр("ru='Операции за период отсутствуют.'");
		НоваяСтрокаТретьегоУровня.ПорядковыйНомерСтроки = -1;
		НоваяСтрокаТретьегоУровня.СуммаДебет = 0;
		НоваяСтрокаТретьегоУровня.СуммаКредит = 0;
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(Данные, СведенияПоДоговорам, "СведенияПолучателя.СведенияПоДоговорам");
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.НайтиСоздатьАктСверкиВзаиморасчетов(ДеревоДанных, ДокументУчета, СпособОбработки, ОписаниеОшибки)
Процедура НайтиСоздатьАктСверкиВзаиморасчетов(ДеревоДанных, ДокументУчета, СпособОбработки, ОписаниеОшибки) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	ДанныеДляЗагрузки = ПодготовитьСтруктуруДляАктаСверкиВзаиморасчетовПоДаннымОтправителя(ДеревоДанных);
	ЗаполнитьДокументАктаСверкиВзаиморасчетовПоДаннымОтправителя(ДокументУчета, ДанныеДляЗагрузки, ОписаниеОшибки);
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьАктСверкиВзаиморасчетовПоДаннымПолучателя(ДанныеДокумента, ОбъектыУчета) 
Процедура ЗаполнитьАктСверкиВзаиморасчетовПоДаннымПолучателя(ДанныеДокумента, ОбъектыУчета) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	ДанныеДляЗагрузки = ПодготовитьСтруктуруДляАктаСверкиВзаиморасчетовПоДаннымПолучателя(ДанныеДокумента, ОбъектыУчета);
	ЗаполнитьДокументАктаСверкиВзаиморасчетовПоДаннымПолучателя(ДанныеДляЗагрузки);
	
КонецПроцедуры

#КонецОбласти

#Область ДоговорнойДокумент

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПоДоговорномуДокументу101.
Процедура ЗаполнитьДанныеПоДоговорномуДокументу101(СсылкаНаОбъект, КонструкторЭД, Отказ) Экспорт

	Данные = Справочники.ДоговорыКонтрагентов.ПолучитьДанныеДляЭД(СсылкаНаОбъект);
	Данные.Следующий();
	
	КонструкторЭД.ОбработчикОшибок.ПараметрыСвязиПоУмолчанию(СсылкаНаОбъект);
	
	ИнформацияДокумента = КонструкторЭД.ИнформацияДокумента(); // см. ОбработкаОбъект.ФорматДоговорныйДокумент101
	ИнформацияДокумента.ФункцияДокумента = КонструкторЭД.ФункцииДокумента().Дог;
	ИнформацияДокумента.ПризнакПорядкаФормирования = КонструкторЭД.ПризнакиПорядкаФормирования().НеОферта;
	ИнформацияДокумента.НомерДоговора = Данные.Номер;
	ИнформацияДокумента.ДатаДоговора = Данные.Дата;
	ИнформацияДокумента.ТипДоговора = ВидДоговоровКонтрагентовПеречисление(Данные.ТипДоговора);
	КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИнформацияДокумента, "ТипДоговора", "Объект.ТипДоговора");

	СторонаКонтрагент = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(Данные.Контрагент, 
		Данные.БанковскийСчетКонтрагента, Данные.Дата);
	
	ИнформацияДокумента.Контрагент = КонструкторЭД.НоваяСторонаДоговора();
	КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИнформацияДокумента, "Контрагент", "Объект.Контрагент");
	ИнформацияДокумента.Контрагент.КодОКПО = СторонаКонтрагент.КодПоОКПО;
	ИнформацияДокумента.Контрагент.КраткоеНазвание = СторонаКонтрагент.СокращенноеНаименование;

	ИдентификационныеСведенияКонтрагента = Неопределено;

	Если Данные.Контрагент_ЮрФизЛицо = Перечисления.ЮрФизЛицо.ИндивидуальныйПредприниматель Тогда
		ИдентификационныеСведенияКонтрагента = КонструкторЭД.НовыеИдентификационныеСведенияИП();
		ИдентификационныеСведенияКонтрагента.ИНН = СторонаКонтрагент.ИНН;
		КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИдентификационныеСведенияКонтрагента, "ИНН", "Объект.ИНН", ,
			Данные.Контрагент);
		ИдентификационныеСведенияКонтрагента.ОГРН = СторонаКонтрагент.ОГРН;
		КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИдентификационныеСведенияКонтрагента, "ОГРН", "Объект.РегистрационныйНомер", ,
			Данные.Контрагент);
		ИдентификационныеСведенияКонтрагента.ФИО = КонструкторЭД.НовыеФИО(СторонаКонтрагент.Фамилия,
			СторонаКонтрагент.Имя, СторонаКонтрагент.Отчество);
		КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИдентификационныеСведенияКонтрагента.ФИО, "Фамилия",
			"Объект.НаименованиеПолное", , Данные.Контрагент);
		КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИдентификационныеСведенияКонтрагента.ФИО, "Имя",
			"Объект.НаименованиеПолное", , Данные.Контрагент);
	ИначеЕсли Данные.Контрагент_ЮрФизЛицо = Перечисления.ЮрФизЛицо.ЮрЛицо Тогда
		ИдентификационныеСведенияКонтрагента = КонструкторЭД.НовыеИдентификационныеСведенияОрганизации();
		ИдентификационныеСведенияКонтрагента.НаименованиеПолное = СторонаКонтрагент.ПолноеНаименование;
		КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИдентификационныеСведенияКонтрагента, "НаименованиеПолное",
			"Объект.НаименованиеПолное", , Данные.Контрагент);
		ИдентификационныеСведенияКонтрагента.ИНН = СторонаКонтрагент.ИНН;
		КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИдентификационныеСведенияКонтрагента, "ИНН",
			"Объект.ИНН", , Данные.Контрагент);
		ИдентификационныеСведенияКонтрагента.ОГРН = СторонаКонтрагент.ОГРН;
		Если ЗначениеЗаполнено(СторонаКонтрагент.КПП) Тогда
			МассивКППКонтрагента = Новый Массив;
			МассивКППКонтрагента.Добавить(СторонаКонтрагент.КПП);
			ИдентификационныеСведенияКонтрагента.КПП = МассивКППКонтрагента;
		КонецЕсли;
		КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИдентификационныеСведенияКонтрагента, "КПП",
			"Объект.КПП", , Данные.Контрагент);
	ИначеЕсли Данные.Контрагент_ЮрФизЛицо = Перечисления.ЮрФизЛицо.ЮрЛицоНеРезидент Тогда
		ИдентификационныеСведенияКонтрагента = КонструкторЭД.НовыеИдентификационныеСведенияИностранногоЛица();
		ИдентификационныеСведенияКонтрагента.НаименованиеПолное = СторонаКонтрагент.ПолноеНаименование;
		КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИдентификационныеСведенияКонтрагента, "НаименованиеПолное",
			"Объект.НаименованиеПолное", , Данные.Контрагент);
		ИдентификационныеСведенияКонтрагента.КодСтраны =
			КонструкторЭД.ЗаполнитьКодСтраныИностранногоАдреса(Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента,
				Данные.Контрагент, ИнформацияДокумента.Дата, КонструкторЭД);
		КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИдентификационныеСведенияКонтрагента, "КодСтраны", , ,
			Данные.Контрагент);
		ИдентификационныеСведенияКонтрагента.Идентификатор = Данные.Контрагент_ИдентификаторЮридическогоЛица;
		КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИдентификационныеСведенияКонтрагента, "Идентификатор",
			"Объект.РегистрационныйНомер", , Данные.Контрагент);
	ИначеЕсли Данные.Контрагент_ЮрФизЛицо = Перечисления.ЮрФизЛицо.ФизЛицо Тогда
		ИдентификационныеСведенияКонтрагента = КонструкторЭД.НовыеИдентификационныеСведенияФизЛица();
		ИдентификационныеСведенияКонтрагента.ИНН = СторонаКонтрагент.ИНН;
		КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИдентификационныеСведенияКонтрагента, "ИНН",
			"Объект.ИНН", , Данные.Контрагент);
		ИдентификационныеСведенияКонтрагента.ФИО = КонструкторЭД.НовыеФИО(СторонаКонтрагент.Фамилия,
			СторонаКонтрагент.Имя, СторонаКонтрагент.Отчество);
		КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИдентификационныеСведенияКонтрагента.ФИО, "Фамилия",
			"Объект.НаименованиеПолное", , Данные.Контрагент);
		КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИдентификационныеСведенияКонтрагента.ФИО, "Имя",
			"Объект.НаименованиеПолное", , Данные.Контрагент);
		ИдентификационныеСведенияКонтрагента.Адрес = КонструкторЭД.ЗаполнитьАдресАвтоматически(
			Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента, Данные.Контрагент,
				ИнформацияДокумента.ДатаДоговора, КонструкторЭД);
		КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИдентификационныеСведенияКонтрагента, "Адрес", , ,
			Данные.Контрагент);
	КонецЕсли;

	ИнформацияДокумента.Контрагент.ИдентификационныеСведения = ИдентификационныеСведенияКонтрагента;
	ИнформацияДокумента.Контрагент.Адрес = КонструкторЭД.ЗаполнитьАдресАвтоматически(
		Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента, Данные.Контрагент, ИнформацияДокумента.ДатаДоговора,
			КонструкторЭД);
			
	Если ЗначениеЗаполнено(СторонаКонтрагент.Телефоны) ИЛИ ЗначениеЗаполнено(СторонаКонтрагент.ЭлектроннаяПочта) Тогда
		ИнформацияДокумента.Контрагент.КонтактныеДанные = КонструкторЭД.НовыеКонтактныеДанные();
		ИнформацияДокумента.Контрагент.КонтактныеДанные.НомерТелефона = СторонаКонтрагент.Телефоны;
		ИнформацияДокумента.Контрагент.КонтактныеДанные.АдресЭП = СторонаКонтрагент.ЭлектроннаяПочта;
	КонецЕсли;
	
	ИнформацияДокумента.Контрагент.БанковскиеРеквизиты = КонструкторЭД.НовыеБанковскиеРеквизиты();
	ИнформацияДокумента.Контрагент.БанковскиеРеквизиты.ИНН = Данные.Контрагент_БанковскийСчет_ИНН;
	ИнформацияДокумента.Контрагент.БанковскиеРеквизиты.НомерСчета = Данные.Контрагент_БанковскийСчет_НомерСчета;
	КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИнформацияДокумента.Контрагент.БанковскиеРеквизиты, "НомерСчета",
		"Объект.НомерСчета", , Данные.БанковскийСчетКонтрагента);
	ИнформацияДокумента.Контрагент.БанковскиеРеквизиты.Наименование =
		Данные.Контрагент_БанковскийСчет_НаименованиеБанка;
	ИнформацияДокумента.Контрагент.БанковскиеРеквизиты.БИК = Данные.Контрагент_БанковскийСчет_БИК;
	КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИнформацияДокумента.Контрагент.БанковскиеРеквизиты, "БИК",
		"Объект.Код", , Данные.БанковскийСчетКонтрагента.Банк);
	ИнформацияДокумента.Контрагент.БанковскиеРеквизиты.КорреспондентскийСчет =
		Данные.Контрагент_БанковскийСчет_КоррСчет;
	КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИнформацияДокумента.Контрагент.БанковскиеРеквизиты,
		"КорреспондентскийСчет", "Объект.КоррСчет", , Данные.БанковскийСчетКонтрагента.Банк);
		
	СторонаОрганизация = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(Данные.Организация, 
		Данные.БанковскийСчет, Данные.Дата);

	ИнформацияДокумента.Организация = КонструкторЭД.НоваяСторонаДоговора();
	КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИнформацияДокумента, "Организация", "Объект.Организация");
	ИнформацияДокумента.Организация.КодОКПО = СторонаОрганизация.КодПоОКПО;
	ИнформацияДокумента.Организация.КраткоеНазвание = СторонаОрганизация.СокращенноеНаименование;

	ИдентификационныеСведенияОрганизации = Неопределено;
	
	Если Данные.Организация_ЮрФизЛицо = Перечисления.ЮрФизЛицо.ИндивидуальныйПредприниматель Тогда
		ИдентификационныеСведенияОрганизации = КонструкторЭД.НовыеИдентификационныеСведенияИП();
		ИдентификационныеСведенияОрганизации.ИНН = СторонаОрганизация.ИНН;
		КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИдентификационныеСведенияОрганизации, "ИНН", "Объект.ИНН", ,
			Данные.Организация);
		ИдентификационныеСведенияОрганизации.ОГРН = СторонаОрганизация.ОГРН;
		КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИдентификационныеСведенияОрганизации, "ОГРН", "Объект.ОГРН", ,
			Данные.Организация);
		ИдентификационныеСведенияОрганизации.ФИО = КонструкторЭД.НовыеФИО(СторонаОрганизация.Фамилия,
			СторонаОрганизация.Имя, СторонаОрганизация.Отчество);
		КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИдентификационныеСведенияОрганизации.ФИО, "Фамилия",
			"Объект.НаименованиеПолное", , Данные.Организация);
		КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИдентификационныеСведенияОрганизации.ФИО, "Имя",
			"Объект.НаименованиеПолное", , Данные.Организация);
	ИначеЕсли Данные.Организация_ЮрФизЛицо = Перечисления.ЮрФизЛицо.ЮрЛицо Тогда
		ИдентификационныеСведенияОрганизации = КонструкторЭД.НовыеИдентификационныеСведенияОрганизации();
		ИдентификационныеСведенияОрганизации.НаименованиеПолное = СторонаОрганизация.ПолноеНаименование;
		КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИдентификационныеСведенияОрганизации, "НаименованиеПолное",
			"Объект.НаименованиеПолное", , Данные.Организация);
		ИдентификационныеСведенияОрганизации.ИНН = СторонаОрганизация.ИНН;
		КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИдентификационныеСведенияОрганизации, "ИНН",
			"Объект.ИНН", , Данные.Организация);
		ИдентификационныеСведенияОрганизации.ОГРН = СторонаОрганизация.ОГРН;
		Если ЗначениеЗаполнено(СторонаОрганизация.КПП) Тогда
			МассивКППОрганизации = Новый Массив;
			МассивКППОрганизации.Добавить(СторонаОрганизация.КПП);
			ИдентификационныеСведенияОрганизации.КПП = МассивКППОрганизации;
		КонецЕсли;
		КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИдентификационныеСведенияОрганизации, "КПП",
			"Объект.КПП", , Данные.Организация);
	КонецЕсли;
	
	ИнформацияДокумента.Организация.ИдентификационныеСведения = ИдентификационныеСведенияОрганизации;
	ИнформацияДокумента.Организация.Адрес = КонструкторЭД.ЗаполнитьАдресАвтоматически(
		Справочники.ВидыКонтактнойИнформации.ЮрАдресОрганизации, Данные.Организация, ИнформацияДокумента.ДатаДоговора,
			КонструкторЭД);
			
	Если ЗначениеЗаполнено(СторонаОрганизация.Телефоны) ИЛИ ЗначениеЗаполнено(СторонаОрганизация.ЭлектроннаяПочта) Тогда
		ИнформацияДокумента.Организация.КонтактныеДанные = КонструкторЭД.НовыеКонтактныеДанные();
		ИнформацияДокумента.Организация.КонтактныеДанные.НомерТелефона = СторонаОрганизация.Телефоны;
		ИнформацияДокумента.Организация.КонтактныеДанные.АдресЭП = СторонаОрганизация.ЭлектроннаяПочта;
	КонецЕсли;
	
	ИнформацияДокумента.Организация.БанковскиеРеквизиты = КонструкторЭД.НовыеБанковскиеРеквизиты();
	ИнформацияДокумента.Организация.БанковскиеРеквизиты.ИНН = Данные.Организация_БанковскийСчет_ИНН;
	ИнформацияДокумента.Организация.БанковскиеРеквизиты.НомерСчета = Данные.Организация_БанковскийСчет_НомерСчета;
	КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИнформацияДокумента.Организация.БанковскиеРеквизиты, "НомерСчета",
		"Объект.НомерСчета", , Данные.БанковскийСчет);
	ИнформацияДокумента.Организация.БанковскиеРеквизиты.Наименование =
		Данные.Организация_БанковскийСчет_НаименованиеБанка;
	ИнформацияДокумента.Организация.БанковскиеРеквизиты.БИК = Данные.Организация_БанковскийСчет_БИК;
	КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИнформацияДокумента.Организация.БанковскиеРеквизиты, "БИК",
		"Объект.Код", , Данные.БанковскийСчет.Банк);
	ИнформацияДокумента.Организация.БанковскиеРеквизиты.КорреспондентскийСчет =
		Данные.Организация_БанковскийСчет_КоррСчет;
	КонструкторЭД.ОбработчикОшибок.УстановитьСвязь(ИнформацияДокумента.Организация.БанковскиеРеквизиты,
		"КорреспондентскийСчет", "Объект.КоррСчет", , Данные.БанковскийСчет.Банк);

	ИнформацияДокумента.СведенияОбОбщейСтоимости = КонструкторЭД.НовыеСведенияОбОбщейСтоимости();
	
	// Признака наличия НДС нет, поэтому заполним с СуммаВключаетНДС
	ИнформацияДокумента.СведенияОбОбщейСтоимости.СуммаСНДС = Данные.Сумма;
	ИнформацияДокумента.СведенияОбОбщейСтоимости.КодВалюты = Данные.Валюта_Код;
		
	ИнформацияДокумента.ПорядокРасчета = КонструкторЭД.НовыйПорядокРасчета();
	ИнформацияДокумента.ПорядокРасчета.ВидПлатежа = Данные.ПорядокРасчетов;
	ИнформацияДокумента.ПорядокРасчета.КодВалюты = Данные.Валюта_Код;
	ИнформацияДокумента.ПорядокРасчета.СрокОплаты = Данные.СрокОплаты;
	
	ИнформацияДокумента.СрокДействия = КонструкторЭД.НовыйСрокДействия();
	ИнформацияДокумента.СрокДействия.ДатаНачалаДействия = Данные.ДатаНачалаДействия;
	ИнформацияДокумента.СрокДействия.ДатаОкончанияДействия = Данные.ДатаОкончанияДействия;
	
	// Признака наличия пролонгации нет, поэтому заполним как отсутсвие условия
	ИнформацияДокумента.СрокДействия.НаличиеПролонгации =
			КонструкторЭД.ПризнакиНаличияПролонгации().ОтсутствуетУсловиеПролонгации;
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.НайтиСоздатьДоговорнойДокумент101
//
Процедура НайтиСоздатьДоговорнойДокумент101(КонструкторЭД, ДокументУчета, СпособОбработки, ОписаниеОшибки) Экспорт
	
	ИнформацияДокумента = КонструкторЭД.ИнформацияДокумента[0];
	
	// Если документ не соответствует ограничениям, то не распознаем.
	Если НЕ (ИнформацияДокумента.ФункцияДокумента = КонструкторЭД.ФункцииДокумента().Дог
		И ИнформацияДокумента.ПризнакПорядкаФормирования = КонструкторЭД.ПризнакиПорядкаФормирования().НеОферта) Тогда
		ОписаниеОшибки = НСтр("ru = 'Данный вид договора не поддерживается.'");
		Возврат;
	КонецЕсли;
	
	ДанныеЗаполнения = ОписаниеДанныхПриЗагрузкеДоговорногоДокумента101();
	КодВалюты = "";
	
	// Реквизиты шапки
	ДанныеЗаполнения.Статус = Перечисления.СтатусыДоговоровКонтрагентов.Действует;
	ДанныеЗаполнения.Менеджер = Пользователи.ТекущийПользователь();
	ДанныеЗаполнения.ВариантКурсаДоговора = Перечисления.ВариантыКурсаДоговора.Переменный;
	
	// Суммовые показатели
	Если ЗначениеЗаполнено(КонструкторЭД.Предмет) Тогда
		
		ОтборПредмета = Новый Структура;
		ОтборПредмета.Вставить("НомерСтрокиТаблицы", 0);
		НайденныеСтроки = КонструкторЭД.Предмет.НайтиСтроки(ОтборПредмета);
		
		Если НайденныеСтроки.Количество() > 0 Тогда
			СтрокаОбщейИнформацииПредмета = НайденныеСтроки[0];
			КодВалюты = СтрокаОбщейИнформацииПредмета.КодВалюты;
			ПроверитьУстановитьВалютуПоДаннымДоговорногоДокумента101(ДанныеЗаполнения.ВалютаВзаиморасчетов, КодВалюты);
			СтавкаНДСПоДаннымДоговорногоДокумента101(ДанныеЗаполнения.СтавкаНДС, СтрокаОбщейИнформацииПредмета);
			ДанныеЗаполнения.Сумма = СтрокаОбщейИнформацииПредмета.СуммаСНДС;
		КонецЕсли;
		
	ИначеЕсли ЗначениеЗаполнено(КонструкторЭД.СведенияОбОбщейСтоимости) И КонструкторЭД.СведенияОбОбщейСтоимости.Количество() > 0 Тогда
		СведенияОбОбщейСтоимости = КонструкторЭД.СведенияОбОбщейСтоимости[0];
		ДанныеЗаполнения.Сумма = СведенияОбОбщейСтоимости.СуммаСНДС;
		КодВалюты = СведенияОбОбщейСтоимости.КодВалюты;
		ПроверитьУстановитьВалютуПоДаннымДоговорногоДокумента101(ДанныеЗаполнения.ВалютаВзаиморасчетов, КодВалюты);
	КонецЕсли;
	
	// Тип договора, хозяйственная операция
	СоответствиеПротивоположныхВидовДоговоров = Новый Соответствие;
	ЗаполнитьСоответствиеВидовДоговоровПротивоположноеЗначениюКонтрагентов(СоответствиеПротивоположныхВидовДоговоров);
	ДанныеЗаполнения.ТипДоговора = СоответствиеПротивоположныхВидовДоговоров.Получить(ИнформацияДокумента.ТипДоговора);
	ДанныеЗаполнения.ХозяйственнаяОперация = Справочники.ДоговорыКонтрагентов.ХозяйственнаяОперация(
		ДанныеЗаполнения.ТипДоговора, Перечисления.ВариантыОформленияЗакупок.ПустаяСсылка());
	
	// Реквизиты сторон
	ТипыСторон = Обработки.ФорматДоговорныйДокумент101.ТипыСторонДоговора();
	ДанныеЗаполнения.Организация = ОрганизацияПоДаннымДоговорногоДокумента101(ИнформацияДокумента.Контрагент.ИдентификационныеСведения, ТипыСторон);
	ДанныеЗаполнения.Контрагент = КонтрагентПоДаннымДоговорногоДокумента101(ИнформацияДокумента.Организация.ИдентификационныеСведения, ТипыСторон);

	ДанныеЗаполнения.БанковскийСчет =
		БанковскийСчетПоДаннымДоговорногоДокумента101(ИнформацияДокумента.Контрагент.БанковскиеРеквизиты, ДанныеЗаполнения.Организация);

	ДанныеЗаполнения.БанковскийСчетКонтрагента =
		БанковскийСчетКонтрагентаПоДаннымДоговорногоДокумента101(ИнформацияДокумента.Организация.БанковскиеРеквизиты, ДанныеЗаполнения.Контрагент);

	Если ЗначениеЗаполнено(ДанныеЗаполнения.Контрагент) Тогда
		ДанныеЗаполнения.Вставить("Партнер", ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДанныеЗаполнения.Контрагент, "Партнер"));
		ДанныеЗаполнения.Вставить("КонтактноеЛицо", ПартнерыИКонтрагенты.ПолучитьКонтактноеЛицоПартнераПоУмолчанию(ДанныеЗаполнения.Партнер));
	КонецЕсли;

	// Номер, дата, наименование, срок действия
	ДанныеЗаполнения.Дата = ИнформацияДокумента.ДатаДоговора;
	ДанныеЗаполнения.Номер = ИнформацияДокумента.НомерДоговора;
	Если ЗначениеЗаполнено(ДанныеЗаполнения.Номер) Тогда
		Если НРег(ДанныеЗаполнения.Номер) <> НСтр("ru = 'без номера (б/н)'") Тогда
			ДанныеЗаполнения.Наименование = СтрШаблон(НСтр("ru = 'Договор № %1'"), ДанныеЗаполнения.Номер);
		Иначе
			ДанныеЗаполнения.Наименование = СтрШаблон(НСтр("ru = 'Договор %1'"), ДанныеЗаполнения.Номер);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ДанныеЗаполнения.Дата) Тогда
			ДанныеЗаполнения.Наименование = СтрШаблон(НСтр("ru = '%1 от %2'"), ДанныеЗаполнения.Наименование,
				Формат(ДанныеЗаполнения.Дата, "ДЛФ=ДД;"));
		КонецЕсли;
	КонецЕсли;
	Если ЗначениеЗаполнено(ИнформацияДокумента.СрокДействия) Тогда
		ДанныеЗаполнения.ДатаНачалаДействия = ИнформацияДокумента.СрокДействия.ДатаНачалаДействия;
		ДанныеЗаполнения.ДатаОкончанияДействия = ИнформацияДокумента.СрокДействия.ДатаОкончанияДействия;
	КонецЕсли;
	
	// Порядок расчетов, срок оплаты
	Если ЗначениеЗаполнено(ИнформацияДокумента.ПорядокРасчета) Тогда
		СоответствиеПорядковРасчетов = Новый Соответствие;
		ЗаполнитьСоответствиеПорядковРасчетов(СоответствиеПорядковРасчетов);
		ДанныеЗаполнения.ПорядокРасчетов = СоответствиеПорядковРасчетов.Получить(ИнформацияДокумента.ПорядокРасчета.ВидПлатежа);
		ДанныеЗаполнения.СрокОплаты = ИнформацияДокумента.ПорядокРасчета.СрокОплаты;
		КодВалюты = ИнформацияДокумента.ПорядокРасчета.КодВалюты;
		ПроверитьУстановитьВалютуПоДаннымДоговорногоДокумента101(ДанныеЗаполнения.ВалютаВзаиморасчетов, КодВалюты);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ДанныеЗаполнения.ВалютаВзаиморасчетов) Тогда
		ОписаниеОшибки = НСтр("ru = 'В базе данных не удалось найти валюту с кодом ""%1""'");
		ОписаниеОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ОписаниеОшибки, КодВалюты);
		Возврат;
	КонецЕсли;
	
	// Способ доставки
	Если Перечисления.ТипыДоговоров.ЭтоДоговорЗакупки(ДанныеЗаполнения.ТипДоговора) Тогда
		ДанныеЗаполнения.СпособДоставки = Перечисления.СпособыДоставки.ОпределяетсяВРаспоряжении;
	КонецЕсли;
	
	// Получение объекта
	Если ЗначениеЗаполнено(ДокументУчета) Тогда
		СправочникОбъект = ДокументУчета.ПолучитьОбъект();
		//Попытка заблокировать объект
		Попытка
			СправочникОбъект.Заблокировать();
		Исключение
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить данные объекта ""%1"".
				|Возможно, документ редактируется другим пользователем'"),
				Строка(СправочникОбъект.Ссылка));
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
		//конец попытки заблокировать объект
	Иначе
		СправочникОбъект = Справочники.ДоговорыКонтрагентов.СоздатьЭлемент();
	КонецЕсли;
	
	// Заполнение реквизитов
	ПерезаполнениеЗначенийРеквизитовШапки(СправочникОбъект, ДанныеЗаполнения);
	СправочникОбъект.Наименование = ДанныеЗаполнения.Наименование;
	СправочникОбъект.НаименованиеДляПечати = ДанныеЗаполнения.Наименование;
	
	// НалогообложениеНДС
	Если Перечисления.ТипыДоговоров.ЭтоДоговорПродажи(СправочникОбъект.ТипДоговора) Тогда
		ПараметрыЗаполнения = Справочники.ДоговорыКонтрагентов.ПараметрыЗаполненияНалогообложенияНДСПродажи(СправочникОбъект);
		УчетНДСУП.ЗаполнитьНалогообложениеНДСПродажи(СправочникОбъект.НалогообложениеНДС, ПараметрыЗаполнения);
	ИначеЕсли  Перечисления.ТипыДоговоров.ЭтоДоговорЗакупки(СправочникОбъект.ТипДоговора) Тогда
		ПараметрыЗаполнения = Справочники.ДоговорыКонтрагентов.ПараметрыЗаполненияНалогообложенияНДСЗакупки(СправочникОбъект);
		УчетНДСУП.ЗаполнитьНалогообложениеНДСЗакупки(СправочникОбъект.НалогообложениеНДС, ПараметрыЗаполнения);
		ПараметрыЗаполнения = Справочники.ДоговорыКонтрагентов.ПараметрыЗаполненияВидаДеятельностиНДС(СправочникОбъект);
		УчетНДСУП.ЗаполнитьВидДеятельностиНДС(СправочникОбъект.ЗакупкаПодДеятельность, ПараметрыЗаполнения);
	КонецЕсли;
	
	// Оплата в валюте
	ВалютаРегламентированногоУчета = ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(ДанныеЗаполнения.Организация);
	Если Не ДанныеЗаполнения.ВалютаВзаиморасчетов = ВалютаРегламентированногоУчета Тогда
		СправочникОбъект.ОплатаВВалюте = Истина;
	КонецЕсли;
	
	ЗаписатьСправочник(СправочникОбъект);
	ДокументУчета = СправочникОбъект.Ссылка;

КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.НайтиСоздатьДоговорныйДокументXML
//
Процедура НайтиСоздатьДоговорныйДокументXML(ДанныеФайлаЭД, ДокументУчета, СпособОбработки, ОписаниеОшибки) Экспорт
	
	ДанныеЗаполнения = ОписаниеДанныхПриЗагрузкеДоговорногоДокумента101();
	КодВалюты = "";
	
	ИННКонтрагента = Неопределено;
	КППКонтрагента = Неопределено;
	ОГРНКонтрагента = Неопределено;
	ОКПОКонтрагента = Неопределено;
	НаимОргКонтрагента = Неопределено;
	НомерСчетаКонтрагента = Неопределено; 
	НаимБанкаКонтрагента = Неопределено;
	НаимИнБанкаКонтрагента = Неопределено;
	БИКБанкаКонтрагента = Неопределено;
	БИКИнБанкаКонтрагента = Неопределено;
	КоррСчетБанкаКонтрагента = Неопределено;
	СсылкаФрагментКонтрагента = Неопределено;
	СсылкаФрагментНомерСчетаКонтрагента = Неопределено;
	СсылкаФрагментНаимБанкаКонтрагента = Неопределено;
	СсылкаФрагментНаимИнБанкаКонтрагента = Неопределено;
	
	ИННОрганизации = Неопределено;
	КППОрганизации = Неопределено;
	ОГРНОрганизации = Неопределено;
	ОКПООрганизации = Неопределено;
	НаимОргОрганизации = Неопределено; 
	НаимОргОрганизации = Неопределено;
	НомерСчетаОрганизации = Неопределено; 
	НаимБанкаОрганизации = Неопределено;
	НаимИнБанкаОрганизации = Неопределено;
	БИКБанкаОрганизации = Неопределено;
	БИКИнБанкаОрганизации = Неопределено;
	КоррСчетБанкаОрганизации = Неопределено;
	СсылкаФрагментОрганизации = Неопределено;
	СсылкаФрагментНомерСчетаОрганизации = Неопределено;
	СсылкаФрагментНаимБанкаОрганизации = Неопределено;
	СсылкаФрагментНаимИнБанкаОрганизации  = Неопределено;
	
	// Реквизиты шапки заполняемые автономно
	ДанныеЗаполнения.Статус = Перечисления.СтатусыДоговоровКонтрагентов.Действует;
	ДанныеЗаполнения.Менеджер = Пользователи.ТекущийПользователь();
	ДанныеЗаполнения.ВариантКурсаДоговора = Перечисления.ВариантыКурсаДоговора.Переменный;
		
	СодержаниеДокумента = РаботаСФайламиБЭД.ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Содержание");
	
	// Номер, дата, наименование
	ДанныеЗаполнения.Дата = ОбщегоНазначенияКлиентСервер.СтрокаВДату(СодержаниеДокумента.ДатаДок);
	ДанныеЗаполнения.Номер = СодержаниеДокумента.НомДок;
	Если ЗначениеЗаполнено(ДанныеЗаполнения.Номер) Тогда
		Если НРег(ДанныеЗаполнения.Номер) <> НСтр("ru = 'без номера (б/н)'") Тогда
			ДанныеЗаполнения.Наименование = СтрШаблон(НСтр("ru = 'Договор № %1'"), ДанныеЗаполнения.Номер);
		Иначе
			ДанныеЗаполнения.Наименование = СтрШаблон(НСтр("ru = 'Договор %1'"), ДанныеЗаполнения.Номер);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ДанныеЗаполнения.Дата) Тогда
			ДанныеЗаполнения.Наименование = СтрШаблон(НСтр("ru = '%1 от %2'"), ДанныеЗаполнения.Наименование,
				Формат(ДанныеЗаполнения.Дата, "ДЛФ=ДД;"));
		КонецЕсли;
	КонецЕсли;

	ТиповыеФрагменты = РаботаСФайламиБЭД.ЗначениеСвойстваXDTO(СодержаниеДокумента, "ФрагТиповой", , , Истина);
	
	ТаблицаЭлементов = Новый ТаблицаЗначений;
	ТаблицаЭлементов.Колонки.Добавить("НомерФрагмента");
	ТаблицаЭлементов.Колонки.Добавить("БуквенныйКодТиповогоНаименования");
	ТаблицаЭлементов.Колонки.Добавить("СодержаниеЭлемента");
	ТаблицаЭлементов.Колонки.Добавить("СсылкаНаНомерФрагмента");
	
	Если ТиповыеФрагменты <> Неопределено Тогда
		
		Для Каждого Фрагмент Из ТиповыеФрагменты Цикл	
			
			Элемент = ТаблицаЭлементов.Добавить();
			Элемент.НомерФрагмента = РаботаСФайламиБЭД.ЗначениеСвойстваXDTO(Фрагмент, "НомФраг");
			Элемент.БуквенныйКодТиповогоНаименования = РаботаСФайламиБЭД.ЗначениеСвойстваXDTO(Фрагмент, "БукКЭлПер");
			Элемент.СодержаниеЭлемента = РаботаСФайламиБЭД.ЗначениеСвойстваXDTO(Фрагмент, "СодержФраг");
			Элемент.СсылкаНаНомерФрагмента = РаботаСФайламиБЭД.ЗначениеСвойстваXDTO(Фрагмент, "СсылБлок");

		КонецЦикла; 
		
		// Данные контрагента из типовых фрагментов для поиска данных сторон 
		СтрокаИНН = ТаблицаЭлементов.Найти("ИННСт1","БуквенныйКодТиповогоНаименования");
		Если СтрокаИНН <> Неопределено Тогда
			СсылкаФрагментКонтрагента = СтрокаИНН.НомерФрагмента;
			ИННКонтрагента = СтрокаИНН.СодержаниеЭлемента;
		КонецЕсли;
		
		// Данные организации из типовых фрагментов для поиска данных сторон 
		СтрокаИНН = ТаблицаЭлементов.Найти("ИННСт2","БуквенныйКодТиповогоНаименования");
		Если СтрокаИНН <> Неопределено Тогда
			СсылкаФрагментОрганизации = СтрокаИНН.НомерФрагмента;
			ИННОрганизации = СтрокаИНН.СодержаниеЭлемента;
		КонецЕсли;
		
		// Данные счетов из типовых фрагментов для поиска данных банковских счетов 
		// Номер счета
		ОтборПоНомеруСчета = Новый Структура();
		ОтборПоНомеруСчета.Вставить("БуквенныйКодТиповогоНаименования", "НомерСчета");
		СтрокиНомерСчета = ТаблицаЭлементов.НайтиСтроки(ОтборПоНомеруСчета);
		Для Каждого СтрокаНомерСчета Из СтрокиНомерСчета Цикл
			Если СтрокаНомерСчета.СсылкаНаНомерФрагмента = СсылкаФрагментКонтрагента Тогда
				СсылкаФрагментНомерСчетаКонтрагента = СтрокаНомерСчета.НомерФрагмента;
				НомерСчетаКонтрагента = СтрокаНомерСчета.СодержаниеЭлемента;
			ИначеЕсли СтрокаНомерСчета.СсылкаНаНомерФрагмента = СсылкаФрагментОрганизации Тогда
				СсылкаФрагментНомерСчетаОрганизации = СтрокаНомерСчета.НомерФрагмента;
				НомерСчетаОрганизации = СтрокаНомерСчета.СодержаниеЭлемента; 
			КонецЕсли;
		КонецЦикла;
		
		// Ищем номер счета иностранного банка
		ОтборПоНомеруСчета = Новый Структура();
		ОтборПоНомеруСчета.Вставить("БуквенныйКодТиповогоНаименования", "НомСчетаИнБанк");
		СтрокиНомерСчета = ТаблицаЭлементов.НайтиСтроки(ОтборПоНомеруСчета);
		Для Каждого СтрокаНомерСчета Из СтрокиНомерСчета Цикл
			Если СтрокаНомерСчета.СсылкаНаНомерФрагмента = СсылкаФрагментКонтрагента Тогда
				СсылкаФрагментНомерСчетаКонтрагента = СтрокаНомерСчета.НомерФрагмента;
				НомерСчетаКонтрагента = СтрокаНомерСчета.СодержаниеЭлемента;
			ИначеЕсли СтрокаНомерСчета.СсылкаНаНомерФрагмента = СсылкаФрагментОрганизации Тогда
				СсылкаФрагментНомерСчетаОрганизации = СтрокаНомерСчета.НомерФрагмента;
				НомерСчетаОрганизации = СтрокаНомерСчета.СодержаниеЭлемента; 
			КонецЕсли;
		КонецЦикла;

		// Наименование банка
		ОтборПоНаименованиюБанка = Новый Структура();
		ОтборПоНаименованиюБанка.Вставить("БуквенныйКодТиповогоНаименования", "НаимБанк");
		СтрокиНаимБанка = ТаблицаЭлементов.НайтиСтроки(ОтборПоНаименованиюБанка);
		Для Каждого СтрокаНаимБанка Из СтрокиНаимБанка Цикл
			Если СтрокаНаимБанка.СсылкаНаНомерФрагмента = СсылкаФрагментНомерСчетаКонтрагента Тогда
				СсылкаФрагментНаимБанкаКонтрагента = СтрокаНаимБанка.НомерФрагмента;
				НаимБанкаКонтрагента = СтрокаНаимБанка.СодержаниеЭлемента;
			ИначеЕсли СтрокаНаимБанка.СсылкаНаНомерФрагмента = СсылкаФрагментНомерСчетаОрганизации Тогда
				СсылкаФрагментНаимБанкаКонтрагента = СтрокаНаимБанка.НомерФрагмента;
				НаимБанкаОрганизации = СтрокаНаимБанка.СодержаниеЭлемента;
			КонецЕсли;
		КонецЦикла;
		
		// Наименование иностранного банка
		ОтборПоНаименованиюБанка = Новый Структура();
		ОтборПоНаименованиюБанка.Вставить("БуквенныйКодТиповогоНаименования", "НаимИнБанк");
		СтрокиНаимБанка = ТаблицаЭлементов.НайтиСтроки(ОтборПоНаименованиюБанка);
		Для Каждого СтрокаНаимБанка Из СтрокиНаимБанка Цикл
			Если СтрокаНаимБанка.СсылкаНаНомерФрагмента = СсылкаФрагментНомерСчетаКонтрагента Тогда
				СсылкаФрагментНаимИнБанкаОрганизации = СтрокаНаимБанка.НомерФрагмента;
				НаимИнБанкаКонтрагента = СтрокаНаимБанка.СодержаниеЭлемента;
			ИначеЕсли СтрокаНаимБанка.СсылкаНаНомерФрагмента = СсылкаФрагментНомерСчетаОрганизации Тогда
				СсылкаФрагментНаимИнБанкаОрганизации = СтрокаНаимБанка.НомерФрагмента;
				НаимИнБанкаОрганизации = СтрокаНаимБанка.СодержаниеЭлемента; 
			КонецЕсли;
		КонецЦикла;

		Для Каждого Элемент Из ТаблицаЭлементов Цикл	
			
			НомерФрагмента = Элемент.НомерФрагмента;
			ТиповойЭлемент = Элемент.БуквенныйКодТиповогоНаименования;
			СодержаниеЭлемента = Элемент.СодержаниеЭлемента;
			СсылкаБлока = Элемент.СсылкаНаНомерФрагмента;
			
			// Данные из типовых фрагментов для поиска сторон		
			Если ТиповойЭлемент = "КПП" Тогда
				Если СсылкаБлока = СсылкаФрагментКонтрагента Тогда 
					КППКонтрагента = СодержаниеЭлемента;
				ИначеЕсли СсылкаБлока = СсылкаФрагментОрганизации Тогда
					КППОрганизации = СодержаниеЭлемента;
				КонецЕсли;
			ИначеЕсли ТиповойЭлемент = "ОГРН" Или ТиповойЭлемент = "ОГРНИП" Тогда
				Если СсылкаБлока = СсылкаФрагментКонтрагента Тогда
					ОГРНКонтрагента = СодержаниеЭлемента;
				ИначеЕсли СсылкаБлока = СсылкаФрагментОрганизации Тогда
					ОГРНОрганизации = СодержаниеЭлемента;
				КонецЕсли;
			ИначеЕсли ТиповойЭлемент = "ОКПО" Тогда 
				Если СсылкаБлока = СсылкаФрагментКонтрагента Тогда
					ОКПОКонтрагента = СодержаниеЭлемента;
				ИначеЕсли СсылкаБлока = СсылкаФрагментОрганизации Тогда
					ОКПООрганизации = СодержаниеЭлемента;
				КонецЕсли;
			ИначеЕсли ТиповойЭлемент = "НаимОрг" Тогда
				Если СсылкаБлока = СсылкаФрагментКонтрагента Тогда
					НаимОргКонтрагента = СодержаниеЭлемента; 
				ИначеЕсли СсылкаБлока = СсылкаФрагментОрганизации Тогда
					НаимОргОрганизации = СодержаниеЭлемента; 
				КонецЕсли; 
			// Данные из типовых фрагментов для поиска банковских счетов
			ИначеЕсли ТиповойЭлемент = "БИК" Тогда
				Если СсылкаБлока = СсылкаФрагментНаимБанкаКонтрагента Тогда
					БИКБанкаКонтрагента = СодержаниеЭлемента; 
				ИначеЕсли СсылкаБлока = СсылкаФрагментНаимБанкаОрганизации Тогда
					БИКБанкаОрганизации = СодержаниеЭлемента; 
				КонецЕсли;
			ИначеЕсли ТиповойЭлемент = "БИКИнБанк" Тогда
				Если СсылкаБлока = СсылкаФрагментНаимИнБанкаКонтрагента Тогда
					БИКИнБанкаКонтрагента = СодержаниеЭлемента; 
				ИначеЕсли СсылкаБлока = СсылкаФрагментНаимИнБанкаОрганизации Тогда
					БИКИнБанкаОрганизации = СодержаниеЭлемента; 
				КонецЕсли;
			ИначеЕсли ТиповойЭлемент = "КорСчет" Тогда
				Если СсылкаБлока = СсылкаФрагментНаимБанкаКонтрагента Тогда
					КоррСчетБанкаКонтрагента = СодержаниеЭлемента; 
				ИначеЕсли СсылкаБлока = СсылкаФрагментНаимБанкаКонтрагента Тогда
					КоррСчетБанкаКонтрагента = СодержаниеЭлемента; 
				КонецЕсли;
			ИначеЕсли ТиповойЭлемент = "КорСчетИнБанк" Тогда
				Если СсылкаБлока = СсылкаФрагментНаимИнБанкаКонтрагента Тогда
					КоррСчетБанкаКонтрагента = СодержаниеЭлемента; 
				ИначеЕсли СсылкаБлока = СсылкаФрагментНаимИнБанкаКонтрагента Тогда
					КоррСчетБанкаКонтрагента = СодержаниеЭлемента; 
				КонецЕсли;
				
			// Срок действия
			ИначеЕсли ТиповойЭлемент = "ДатаНач" Тогда
				ЗначениеДаты = ОбщегоНазначенияКлиентСервер.СтрокаВДату(СодержаниеЭлемента);
			    ДанныеЗаполнения.ДатаНачалаДействия = ЗначениеДаты;
			ИначеЕсли ТиповойЭлемент = "ДатаОкон" Тогда
				ЗначениеДаты = ОбщегоНазначенияКлиентСервер.СтрокаВДату(СодержаниеЭлемента);
				ДанныеЗаполнения.ДатаОкончанияДействия = ЗначениеДаты; 
			// Валюта, Ставка НДС, Сумма
			ИначеЕсли ТиповойЭлемент = "КодОКВ" Тогда
				КодВалюты = СодержаниеЭлемента;
				ПроверитьУстановитьВалютуПоДаннымДоговорногоДокумента101(ДанныеЗаполнения.ВалютаВзаиморасчетов, КодВалюты);
				Если Не ЗначениеЗаполнено(ДанныеЗаполнения.ВалютаВзаиморасчетов) Тогда
					ОписаниеОшибки = НСтр("ru = 'В базе данных не удалось найти валюту с кодом ""%1""'");
					ОписаниеОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ОписаниеОшибки, КодВалюты);
					Возврат;
				КонецЕсли;
			ИначеЕсли ТиповойЭлемент = "НалСтДог" Тогда				
				СтавкаНДСПоДаннымДоговорногоДокумента101(ДанныеЗаполнения.СтавкаНДС, Новый Структура("СтавкаНДС",СодержаниеЭлемента));
			ИначеЕсли ТиповойЭлемент = "Сумма" Тогда	
				ДанныеЗаполнения.Сумма = СодержаниеЭлемента;
			// Порядок расчетов, Срок оплаты
			ИначеЕсли ТиповойЭлемент = "СрокОплаты" И ЗначениеЗаполнено(СодержаниеЭлемента) Тогда
				ДанныеЗаполнения.СрокОплаты = СодержаниеЭлемента;
			КонецЕсли;
		КонецЦикла;
		
		// Стороны 
		ДанныеЗаполнения.Организация = ОрганизацияПоДаннымДоговорногоДокумента101XML(ИННОрганизации, КППОрганизации, ОГРНОрганизации, ОКПООрганизации, НаимОргОрганизации);
		ДанныеЗаполнения.Контрагент = КонтрагентПоДаннымДоговорногоДокумента101XML(ИННКонтрагента, КППКонтрагента, ОГРНКонтрагента, ОКПОКонтрагента, НаимОргКонтрагента);
		
		// Банковские счета
		ДанныеЗаполнения.БанковскийСчет =
			БанковскийСчетПоДаннымДоговорногоДокумента101XML(ДанныеЗаполнения.Организация, НомерСчетаОрганизации, НаимБанкаОрганизации, НаимИнБанкаОрганизации, 
				БИКБанкаОрганизации, БИКИнБанкаОрганизации, КоррСчетБанкаОрганизации);

		ДанныеЗаполнения.БанковскийСчетКонтрагента =
			БанковскийСчетКонтрагентаПоДаннымДоговорногоДокумента101XML(ДанныеЗаполнения.Контрагент, НомерСчетаКонтрагента, НаимБанкаКонтрагента, НаимИнБанкаКонтрагента, 
				БИКБанкаКонтрагента, БИКИнБанкаКонтрагента, КоррСчетБанкаКонтрагента);
				
		// Доп. данные
		Если ЗначениеЗаполнено(ДанныеЗаполнения.Контрагент) Тогда 
			Партнер = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДанныеЗаполнения.Контрагент, "Партнер"); 
			ДанныеЗаполнения.Вставить("Партнер", Партнер);
			ДанныеЗаполнения.Вставить("КонтактноеЛицо", ПартнерыИКонтрагенты.ПолучитьКонтактноеЛицоПартнераПоУмолчанию(ДанныеЗаполнения.Партнер));
			
			// Тип договора, хозяйственная операция 
			Если ЗначениеЗаполнено(Партнер) Тогда
				ПартнерКлиент = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Партнер, "Клиент");
				ПартнерПоставщик = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Партнер, "Поставщик");				
				Если ПартнерПоставщик И Не ПартнерКлиент Тогда
					ТипДоговора = Перечисления.ТипыДоговоров.СПоставщиком; 
				ИначеЕсли (ПартнерКлиент И Не ПартнерПоставщик) 
					Или (ПартнерКлиент И ПартнерПоставщик) 
					Или (Не ПартнерКлиент И Не ПартнерПоставщик) Тогда 
					ТипДоговора = Перечисления.ТипыДоговоров.СПокупателем;
				КонецЕсли;
				ДанныеЗаполнения.ТипДоговора = ТипДоговора;
				ДанныеЗаполнения.ХозяйственнаяОперация = Справочники.ДоговорыКонтрагентов.ХозяйственнаяОперация(
					ДанныеЗаполнения.ТипДоговора, Перечисления.ВариантыОформленияЗакупок.ПустаяСсылка());
							
				// Способ доставки
				Если Перечисления.ТипыДоговоров.ЭтоДоговорЗакупки(ДанныеЗаполнения.ТипДоговора) Тогда
					ДанныеЗаполнения.СпособДоставки = Перечисления.СпособыДоставки.ОпределяетсяВРаспоряжении;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		// Оплата в валюте
		Если Не ЗначениеЗаполнено(ДанныеЗаполнения.ВалютаВзаиморасчетов) Тогда
			ДанныеЗаполнения.ВалютаВзаиморасчетов = ДоходыИРасходыСервер.ПолучитьВалютуУправленческогоУчета();
		КонецЕсли;
		
		// Получение объекта
		Если ЗначениеЗаполнено(ДокументУчета) Тогда
			СправочникОбъект = ДокументУчета.ПолучитьОбъект();
			//Попытка заблокировать объект
			Попытка
				СправочникОбъект.Заблокировать();
			Исключение
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Не удалось изменить данные объекта ""%1"".
					|Возможно, документ редактируется другим пользователем'"),
					Строка(СправочникОбъект.Ссылка));
				ВызватьИсключение ТекстСообщения;
			КонецПопытки;
			//конец попытки заблокировать объект
		Иначе
			СправочникОбъект = Справочники.ДоговорыКонтрагентов.СоздатьЭлемент();
		КонецЕсли;

		// Заполнение реквизитов
		ПерезаполнениеЗначенийРеквизитовШапки(СправочникОбъект, ДанныеЗаполнения);
		СправочникОбъект.Наименование = ДанныеЗаполнения.Наименование;
		СправочникОбъект.НаименованиеДляПечати = ДанныеЗаполнения.Наименование;
		
		// НалогообложениеНДС
		Если Перечисления.ТипыДоговоров.ЭтоДоговорПродажи(СправочникОбъект.ТипДоговора) Тогда
			ПараметрыЗаполнения = Справочники.ДоговорыКонтрагентов.ПараметрыЗаполненияНалогообложенияНДСПродажи(СправочникОбъект);
			УчетНДСУП.ЗаполнитьНалогообложениеНДСПродажи(СправочникОбъект.НалогообложениеНДС, ПараметрыЗаполнения);
		ИначеЕсли  Перечисления.ТипыДоговоров.ЭтоДоговорЗакупки(СправочникОбъект.ТипДоговора) Тогда
			ПараметрыЗаполнения = Справочники.ДоговорыКонтрагентов.ПараметрыЗаполненияНалогообложенияНДСЗакупки(СправочникОбъект);
			УчетНДСУП.ЗаполнитьНалогообложениеНДСЗакупки(СправочникОбъект.НалогообложениеНДС, ПараметрыЗаполнения);
			ПараметрыЗаполнения = Справочники.ДоговорыКонтрагентов.ПараметрыЗаполненияВидаДеятельностиНДС(СправочникОбъект);
			УчетНДСУП.ЗаполнитьВидДеятельностиНДС(СправочникОбъект.ЗакупкаПодДеятельность, ПараметрыЗаполнения);
		КонецЕсли;
		
		// Оплата в валюте
		ВалютаРегламентированногоУчета = ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(ДанныеЗаполнения.Организация);
		Если Не ДанныеЗаполнения.ВалютаВзаиморасчетов = ВалютаРегламентированногоУчета Тогда
			СправочникОбъект.ОплатаВВалюте = Истина;
		КонецЕсли;
		
			// Порядок расчетов
		ЗаполнениеОбъектовПоСтатистике.ЗаполнитьПодчиненныеРеквизитыОбъекта(СправочникОбъект, "ПорядокРасчетов");
		Если Не ЗначениеЗаполнено(СправочникОбъект.ПорядокРасчетов) Тогда
			СправочникОбъект.ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоНакладным;
		КонецЕсли;
		
		ЗаписатьСправочник(СправочникОбъект);
		ДокументУчета = СправочникОбъект.Ссылка;
		
	КонецЕсли;	

КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.УстановитьПризнакИспользованияФорматаДоговорногоДокументаXML
//
Процедура УстановитьПризнакИспользованияФорматаДоговорногоДокументаXML(Используется = Ложь) Экспорт

	Используется = Истина;
	ОбменСКонтрагентами.ПодключитьИспользованиеФорматаДоговорныхДокументовXML();
	
КонецПроцедуры

// См. РаботаСФайламиПереопределяемый.ПриОсвобожденииФайла
//
Процедура ПриОсвобожденииФайла(ДанныеФайла, УникальныйИдентификатор) Экспорт
	
	Если ТипЗнч(ДанныеФайла.Владелец) <> Тип("СправочникСсылка.ДоговорыКонтрагентов") Тогда 
		Возврат;	
	ИначеЕсли ТипЗнч(ДанныеФайла.Владелец) = Тип("СправочникСсылка.ДоговорыКонтрагентов")
		И Не ДанныеФайла.Ссылка.ОтправленПолученЭД Тогда
		Возврат;
	КонецЕсли;
		
	Если ДанныеФайла.Версия.ДатаМодификацииУниверсальная <> ДанныеФайла.ДатаМодификацииУниверсальная Тогда
		
		// Изменяем состояние отправки присоединенного файла здесь, т.к. объект файла уже заблокирован в 
		// родительской процедуре РаботаСФайламиСлужебныйВызовСервера.ОсвободитьФайл
		Файл = ДанныеФайла.Ссылка.ПолучитьОбъект();
		Файл.ОтправленПолученЭД = Ложь;	
		Файл.Записать();
		
		ДоговорОбъект = ДанныеФайла.Владелец.ПолучитьОбъект();
		ДоговорОбъект.ДополнительныеСвойства.Вставить("ОбменСКонтрагентами", Новый Структура());
		ДоговорОбъект.ДополнительныеСвойства.ОбменСКонтрагентами.Вставить("ОписаниеИзменений", Новый Структура());
		ДоговорОбъект.ДополнительныеСвойства.ОбменСКонтрагентами.ОписаниеИзменений.Вставить("УчаствуетВОбмене", Истина);
		ДоговорОбъект.ДополнительныеСвойства.ОбменСКонтрагентами.ОписаниеИзменений.Вставить("ИзмененыКлючевыеДанные", Истина);
		СостояниеЭлектронногоДокумента = ОбменСКонтрагентами.СтатусДокументооборота(ДанныеФайла.Владелец);
		ДоговорОбъект.ДополнительныеСвойства.ОбменСКонтрагентами.ОписаниеИзменений.Вставить("СостояниеЭлектронногоДокумента", СостояниеЭлектронногоДокумента.Статус);
		 
		ИнтеграцияЭДО.ПриЗаписиСправочникаОбъектаУчетаЭДО(ДоговорОбъект, Ложь);  
	КонецЕсли;

КонецПроцедуры

// См. РаботаСФайламиПереопределяемый.ПриСозданииФормыСпискаФайлов
//
Процедура ПриСозданииФормыСпискаПрисоединенныхФайлов(Форма) Экспорт
		
	Если Форма.ИмяСправочникаХранилищаФайлов = "ДоговорыКонтрагентовПрисоединенныеФайлы" Тогда
	
		ОбъектыУчетаМассив = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Форма.ВладелецФайла);
		НастройкиОтправки = ОбменСКонтрагентами.НастройкиОтправки(ОбъектыУчетаМассив);
		
		Если ЗначениеЗаполнено(НастройкиОтправки) Тогда
			Если  НастройкиОтправки.Получить(Форма.ВладелецФайла).Формат = "ON_DOGDOC_1_999_01_01_01_01" Тогда
				ПравоеЗначение = "pdf";
			Иначе 
				ПравоеЗначение = "xml";
			КонецЕсли;
		
			ЭлементОтбора = Форма.Список.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
			ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Расширение");
			ЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
			ЭлементОтбора.ПравоеЗначение = ПравоеЗначение;
		КонецЕсли;	
	КонецЕсли;

КонецПроцедуры

Процедура ОбновитьСостояниеОтправленногоФайлаДоговорногоДокумента(ФайлСсылка, Значение) Экспорт
	
 	Файл = ФайлСсылка.ПолучитьОбъект();
	Файл.ОтправленПолученЭД = Значение;

	Попытка
		Файл.Заблокировать();
	Исключение
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить данные объекта ""%1"".
				|Возможно, документ редактируется другим пользователем'"),
				Строка(ФайлСсылка));
		ВызватьИсключение ТекстСообщения;
	КонецПопытки;
	
	Файл.Записать();
	Файл.Разблокировать();
	
КонецПроцедуры

#КонецОбласти

#Область ОбменИнтеркампаниЧерезЭДО

// Проверяет пришедшей ЭД на обмен между организациями и при возможности связывает с документом интеркампани.
//
// Параметры:
//  ДеревоДанных - ДеревоЗначений - данные для заполнения электронного документа.
//  СсылкаНаВладельца	 - ОпределяемыйТип.ОснованияЭлектронныхДокументовЭДО, Неопределено - ссылка на документ учета, если он уже
//                         прикреплен к электронному документу.
//  Записывать           - Булево - возвращать ссылку на найденный объект или сам объект.
//  СпособОбработки		 - Строка - способ сохранения данных в информационной базе, выбранный пользователем.
//  ОписаниеОшибки       - Строка - описание ошибки создания учетного документа. Может быть выведена пользователю.
//  ТипФункции           - Строка - определяет какой набор данных передан в параметре ДеревоДанных.
//
Процедура ЗаполнитьДокументПередачиМеждуОрганизациямиПоПередачиТоваров(ДеревоДанных, СсылкаНаВладельца, Записывать, СпособОбработки, ОписаниеОшибки, ТипФункции = "") Экспорт
	
	Если ЗначениеЗаполнено(СсылкаНаВладельца) Тогда
		Возврат;
	КонецЕсли;
	
	ОрганизацияОтправитель = Неопределено;

	ДанныеОписанияОшибки = ПолучитьОписаниеДанныхДляОшибки();
	ДанныеОписанияОшибки.СпособОбработки = СпособОбработки;

	Если ТипФункции = "КСЧФДИС" Или ТипФункции = "КСЧФ" Тогда
		
		ДанныеОписанияОшибки.НомерЭлектронногоДокумента = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерДокумента");
		ДанныеОписанияОшибки.ДатаЭлектронногоДокумента = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокумента");
		
		РазделДопДанных = "ДопДанныеСчетаФактуры"; 
		ВидУчастникаПродавец = "СведенияОПродавце";
		СведенияОПродавце = ДеревоДанных.Строки.Найти(ВидУчастникаПродавец, "ПолныйПуть");
		ОрганизацияОтправитель = ОрганизацияПоДаннымЭД(СведенияОПродавце, ВидУчастникаПродавец);
		
	ИначеЕсли ТипФункции = "ТоварнаяНакладная" Тогда
		
		ДанныеОписанияОшибки.НомерЭлектронногоДокумента = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерТоварнойНакладной");
		ДанныеОписанияОшибки.ДатаЭлектронногоДокумента = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаТоварнойНакладной");
		
		РазделДопДанных = "ДопДанные";
		
		ВидУчастникаПродавец = "Поставщик";
		СведенияОПродавце = ДеревоДанных.Строки.Найти(ВидУчастникаПродавец, "ПолныйПуть");
		ОрганизацияОтправитель = ОрганизацияПоДаннымЭД(СведенияОПродавце, ВидУчастникаПродавец);
		
	ИначеЕсли ТипФункции = "УПД_2019" Тогда
		
		ДанныеОписанияОшибки.НомерЭлектронногоДокумента = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерДокумента");
		ДанныеОписанияОшибки.ДатаЭлектронногоДокумента = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокумента");
		
		СведенияОПродавце = ДеревоДанных.Строки.Найти("СведенияОПродавце", "ПолныйПуть");
		СведенияОПокупателе = ДеревоДанных.Строки.Найти("СведенияОПокупателе", "ПолныйПуть");
		
		Для Каждого СтрокаПродавца Из СведенияОПродавце.Строки Цикл
			ОрганизацияОтправитель = ОрганизацияПоДаннымЭД(СтрокаПродавца, "СведенияОПродавце.НомерСтроки");
			Прервать;
		КонецЦикла;
		Для Каждого СтрокаПокупателя Из СведенияОПокупателе.Строки Цикл
			ОрганизацияПолучатель = ОрганизацияПоДаннымЭД(СтрокаПокупателя, "СведенияОПокупателе.НомерСтроки");
			Прервать;
		КонецЦикла; 

	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ОрганизацияОтправитель) Тогда
		
		ДанныеОписанияОшибки.НайденаОрганизация = Ложь;
		СообщитьОбОшибкеЗагрузкиИнтеркампани(ДанныеОписанияОшибки, ОписаниеОшибки);
		Возврат;
		
	Иначе
		
		ИменаСвойств = "ИдентификаторПередачи, ИдентификаторСЧФ";
		
		Если ТипФункции = "КСЧФДИС" Или ТипФункции = "КСЧФ" Тогда
			ДополнительныеДанные = ПолучитьДополнительныеСведения(ДеревоДанных, РазделДопДанных, ИменаСвойств);
		ИначеЕсли ТипФункции = "ТоварнаяНакладная" Тогда
			ДополнительныеДанные = ПолучитьДополнительныеСведенияПередачи(ДеревоДанных, РазделДопДанных, ИменаСвойств);
		ИначеЕсли ТипФункции = "УПД_2019" Тогда
			ДополнительныеДанные = ПолучитьДополнительныеСведения(ДеревоДанных,, ИменаСвойств);
		КонецЕсли;
		
		Если ДополнительныеДанные.ИдентификаторПередачи <> Неопределено Тогда
			СтрокаGUID = ДополнительныеДанные.ИдентификаторПередачи;
			ИдентификаторДокумента = Новый УникальныйИдентификатор(СтрокаGUID);
			ДокументПередачи = Документы.ПередачаТоваровМеждуОрганизациями.ПолучитьСсылку(ИдентификаторДокумента);
			Если ОбщегоНазначения.СсылкаСуществует(ДокументПередачи) Тогда
				СсылкаНаВладельца = ДокументПередачи;
			Иначе
				ДокументПередачи = Документы.ВозвратТоваровМеждуОрганизациями.ПолучитьСсылку(ИдентификаторДокумента);
				Если ОбщегоНазначения.СсылкаСуществует(ДокументПередачи) Тогда
					СсылкаНаВладельца = ДокументПередачи;
				КонецЕсли;
			КонецЕсли;
			
			ДанныеОписанияОшибки.СсылкаНаДокумент = СсылкаНаВладельца;
			СообщитьОбОшибкеЗагрузкиИнтеркампани(ДанныеОписанияОшибки, ОписаниеОшибки);
			
		ИначеЕсли ДополнительныеДанные.ИдентификаторСЧФ <> Неопределено Тогда
			СтрокаGUID = ДополнительныеДанные.ИдентификаторСЧФ;
			ИдентификаторДокумента = Новый УникальныйИдентификатор(СтрокаGUID);
			ДокументСчетаФактуры = Документы.СчетФактураВыданный.ПолучитьСсылку(ИдентификаторДокумента);
			Если ОбщегоНазначения.СсылкаСуществует(ДокументСчетаФактуры) Тогда
				СсылкаНаВладельца = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументСчетаФактуры, "ДокументОснование");
			КонецЕсли;
			
			ДанныеОписанияОшибки.СсылкаНаДокумент = СсылкаНаВладельца;
			СообщитьОбОшибкеЗагрузкиИнтеркампани(ДанныеОписанияОшибки, ОписаниеОшибки);
			
		ИначеЕсли СпособОбработки = "ПередачаТоваровМеждуОрганизациями"
				Или СпособОбработки = "ВозвратТоваровМеждуОрганизациями" Тогда
				
			ДанныеОписанияОшибки.НайденИдентификатор = Ложь;
			СообщитьОбОшибкеЗагрузкиИнтеркампани(ДанныеОписанияОшибки, ОписаниеОшибки);
			
		КонецЕсли;
		
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СсылкаНаВладельца)
		И Не Записывать Тогда
		СсылкаНаВладельца = СсылкаНаВладельца.ПолучитьОбъект();
		
	КонецЕсли;
	
КонецПроцедуры

// Проверяет пришедшей ЭД на СФ между организациями и при возможности связывает с СФ-выданным.
//
// Параметры:
//  СсылкаНаВладельца	 - ОпределяемыйТип.ОснованияЭлектронныхДокументовЭДО, Неопределено - ссылка на документ учета, если он уже
//                         прикреплен к электронному документу.
//  ДеревоДанных         - ДеревоЗначений - данные для заполнения электронного документа.
//  Записывать           - Булево - возвращать ссылку на найденный объект или сам объект.
//  ТипФункции           - Строка - определяет какой набор данных передан в параметре ДеревоДанных.
//
Процедура НайтиДокументСчетФактураВыданныйМеждуОрганизациями(СсылкаНаВладельца, ДеревоДанных, Записывать, ТипФункции = "") Экспорт
	
	Если ЗначениеЗаполнено(СсылкаНаВладельца) Тогда
		Возврат;
	КонецЕсли;
	
	НомерЭД = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерДокумента");
	ДатаЭД = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
	ДеревоДанных, "ДатаДокумента");
	Организация = Неопределено;
	ОрганизацияПолучатель = Неопределено;
	РазделДопДанных = "ДопДанныеСчетаФактуры";
	
	Если ТипФункции = "КСЧФДИС"
		Или ТипФункции = "КСЧФ" Тогда
		СведенияОПродавце = ДеревоДанных.Строки.Найти("СведенияОПродавце", "ПолныйПуть");
		СведенияОПокупателе = ДеревоДанных.Строки.Найти("СведенияОПокупателе", "ПолныйПуть");
		
		Организация = ОрганизацияПоДаннымЭД(СведенияОПродавце, "СведенияОПродавце");
		ОрганизацияПолучатель = ОрганизацияПоДаннымЭД(СведенияОПокупателе, "СведенияОПокупателе");
	Иначе // ТипФункции = "СЧФ"
		СведенияОПродавце = ДеревоДанных.Строки.Найти("СведенияОПродавце", "ПолныйПуть");
		СведенияОПокупателе = ДеревоДанных.Строки.Найти("СведенияОПокупателе", "ПолныйПуть");
		
		Для Каждого СтрокаПродавца Из СведенияОПродавце.Строки Цикл
			Организация = ОрганизацияПоДаннымЭД(СтрокаПродавца, "СведенияОПродавце.НомерСтроки");
			Прервать;
		КонецЦикла;
		Для Каждого СтрокаПокупателя Из СведенияОПокупателе.Строки Цикл
			ОрганизацияПолучатель = ОрганизацияПоДаннымЭД(СтрокаПокупателя, "СведенияОПокупателе.НомерСтроки");
			Прервать;
		КонецЦикла;
	КонецЕсли;
	
	Если ТипЗнч(Организация) = Тип("СправочникСсылка.Организации")
		И ТипЗнч(ОрганизацияПолучатель) = Тип("СправочникСсылка.Организации") Тогда
		
		ИменаСвойств = "ИдентификаторСЧФ";
		ДопДанныеСчетаФактуры = ПолучитьДополнительныеСведения(ДеревоДанных, РазделДопДанных, ИменаСвойств);
		
		Если ДопДанныеСчетаФактуры.ИдентификаторСЧФ <> Неопределено Тогда
			
			СтрокаGUID = ДопДанныеСчетаФактуры.ИдентификаторСЧФ;
			ИдентификаторДокумента = Новый УникальныйИдентификатор(СтрокаGUID);
			СчетФактураВыданный = Документы.СчетФактураВыданный.ПолучитьСсылку(ИдентификаторДокумента);
			Если ОбщегоНазначения.СсылкаСуществует(СчетФактураВыданный) Тогда
				СсылкаНаВладельца = СчетФактураВыданный;
			Иначе
				ШаблонСтроки = НСтр("ru = 'Ошибка загрузки электронной товарной накладной %1 от %2.'");
				ШаблонДаты = Формат(ДатаЭД, "ДЛФ=D");
				ТекстИсключения = СтрШаблон(ШаблонСтроки, НомерЭД, 
				ШаблонДаты) 
				+ Символы.ПС 
				+ НСтр("ru = 'Не найден счет-фактура между организациями по уникальному идентификатору.'");
				ВызватьИсключение ТекстИсключения;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СсылкаНаВладельца)
		И Не Записывать Тогда
		СсылкаНаВладельца = СсылкаНаВладельца.ПолучитьОбъект();
	КонецЕсли;
	
КонецПроцедуры

// Получает дополнительные данные из ЭД.
//
// Параметры:
//  ДеревоДанных         - ДеревоЗначений - данные для заполнения электронного документа.
//  РазделДопДанных      - Строка - имя раздела дополнительных данных.
//  ИменаСвойств - Строка - Названия идентификаторов дополнительных данных.
//
// Возвращаемое значение:
//  Структура - структура содержащая данные дополнительного раздела. Состав зависит от данных доп. раздела.
//
Функция ПолучитьДополнительныеСведенияПередачи(ДеревоДанных, РазделДопДанных, ИменаСвойств = "") Экспорт
	
	СтруктураДополнительныхЗначений = Новый Структура();
	ИменаСвойств = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(ИменаСвойств,",",, Истина);
	Для Каждого Элемент Из ИменаСвойств Цикл
		СтруктураДополнительныхЗначений.Вставить(Элемент, Неопределено);
	КонецЦикла;
	
	ДополнительныеДанные = ДеревоДанных.Строки.Найти(РазделДопДанных, "ПолныйПуть");
	Если ДополнительныеДанные <> Неопределено Тогда
		ТекстоваяИнформация = ДополнительныеДанные.Строки.Найти(РазделДопДанных+".Подписанные", "ПолныйПуть");
		Для Каждого СтрокиСведений Из ТекстоваяИнформация.Строки Цикл
			НазваниеИдентификатора = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СтрокиСведений, РазделДопДанных+".Подписанные.НомерСтроки.Идентификатор");
			Если НазваниеИдентификатора <> Неопределено  И ЗначениеЗаполнено(ИменаСвойств) И ИменаСвойств.Найти(НазваниеИдентификатора) <> Неопределено Тогда
				ЗначениеИдентификатора = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СтрокиСведений, РазделДопДанных+".Подписанные.НомерСтроки.Значение", Ложь);
				СтруктураДополнительныхЗначений.Вставить(НазваниеИдентификатора, ЗначениеИдентификатора);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Возврат СтруктураДополнительныхЗначений;
	
КонецФункции

// Возвращает структуру описания данных для анализа ошибки разбора ЭД.
//
// Возвращаемое значение:
//  Структура:
//  * НомерЭлектронногоДокумента - Строка - номер ЭД.
//  * ДатаЭлектронногоДокумента  - Дата - дата ЭД.
//  * СпособОбработки            - Строка - способ обработки ЭД.
//  * СсылкаНаДокумент           - Неопределено, ДокументСсылка - ссылка на обрабатываемый документ
//  * НайденаОрганизация         - Булево - признак, что организация по данным ЭД найдена.
//  * НайденИдентификатор        - Булево - признак, что найден идентификатор документа передачи/возврата между
//                                          организациями в дополнительных данных ЭД.
//
Функция ПолучитьОписаниеДанныхДляОшибки() Экспорт
	
	ДанныеОписанияОшибки = Новый Структура();
	ДанныеОписанияОшибки.Вставить("НомерЭлектронногоДокумента", "");
	ДанныеОписанияОшибки.Вставить("ДатаЭлектронногоДокумента", Дата(1, 1, 1));
	ДанныеОписанияОшибки.Вставить("СпособОбработки", "");
	ДанныеОписанияОшибки.Вставить("СсылкаНаДокумент", Неопределено);
	ДанныеОписанияОшибки.Вставить("НайденаОрганизация", Истина);
	ДанныеОписанияОшибки.Вставить("НайденИдентификатор", Истина);
	
	Возврат ДанныеОписанияОшибки;
	
КонецФункции

// Вызывает исключение при обнаружении ошибки разбора ЭД между организациями.
//
// Параметры:
//  ОписаниеДанныхОшибки - см. ПолучитьОписаниеДанныхДляОшибки.
//  ОписаниеОшибки - Строка - описание ошибки, если не вызываем исключение.
//  ВызыватьИсключение - Булево - вызывать исключение или возвращать описание ошибки.
//
Процедура СообщитьОбОшибкеЗагрузкиИнтеркампани(ОписаниеДанныхОшибки, ОписаниеОшибки, ВызыватьИсключение = Истина) Экспорт
	
	Если (ОписаниеДанныхОшибки.СпособОбработки = "ПередачаТоваровМеждуОрганизациями"
		Или ОписаниеДанныхОшибки.СпособОбработки = "ВозвратТоваровМеждуОрганизациями")
		И (ОписаниеДанныхОшибки.СсылкаНаДокумент = Неопределено
			Или (ЗначениеЗаполнено(ОписаниеДанныхОшибки.СсылкаНаДокумент)
				И Не ОбщегоНазначения.СсылкаСуществует(ОписаниеДанныхОшибки.СсылкаНаДокумент))) Тогда
				
			Если Не ОписаниеДанныхОшибки.НайденаОрганизация Тогда
				ОписаниеОшибки = НСтр("ru = 'Не найдена организация по реквизитам, указанным в электронном документе между организациями.'");
			ИначеЕсли ОписаниеДанныхОшибки.НайденИдентификатор Тогда
				ОписаниеОшибки = НСтр("ru = 'Не найден документ между организациями по уникальному идентификатору.'");
			Иначе
				ОписаниеОшибки = НСтр("ru = 'Не указан уникальный идентификатор документа между организациями.'");
			КонецЕсли;
			
			ШаблонСтроки = НСтр("ru = 'Ошибка загрузки электронной товарной накладной %1 от %2.'");
			ШаблонДаты = Формат(ОписаниеДанныхОшибки.ДатаЭлектронногоДокумента, "ДЛФ=D");
			ТекстИсключения = СтрШаблон(ШаблонСтроки, ОписаниеДанныхОшибки.НомерЭлектронногоДокумента, 
			ШаблонДаты) 
			+ Символы.ПС 
			+ ОписаниеОшибки;
			Если ВызыватьИсключение Тогда
				ВызватьИсключение ТекстИсключения;
			Иначе
				ОписаниеОшибки = ТекстИсключения;
			КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СчетНаОплату_1_01

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПоСчетуНаОплату101.
Процедура ЗаполнитьДанныеПоСчетуНаОплату_1_01(Основание, Настройки, Данные, Описание, Отказ) Экспорт
	
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	Основания = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Основание);
	
	ИмяОбъекта		= Основание.Метаданные().Имя;
	МенеджерОбъекта = ОбщегоНазначенияУТ.ПолучитьМодульЛокализации(ИмяОбъекта);
	
	Если МенеджерОбъекта = Неопределено Тогда
		МенеджерОбъекта = Документы[ИмяОбъекта];
	КонецЕсли;
	
	ДанныеДокументов	= МенеджерОбъекта.ДанныеДокументовДляСчетаНаОплату_1_01(Основания);
	
	ДанныеШапки = ДанныеДокументов.РезультатПоШапке.Выбрать();
	ДанныеШапки.Следующий();
	
	ТоварыДокумента		= ДанныеДокументов.РезультатПоТабличнойЧасти.Выгрузить();
	ЭтапыОплаты			= ДанныеДокументов.РезультатПоЭтапамОплаты.Выгрузить();
	
	ПроверкаФормированияСчетаНаОплату_1_01(ДанныеШапки, ТоварыДокумента, ЭтапыОплаты, Отказ);
	
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	// Заполнение по данным шапки документа.
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "Функция", "0");
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "НомерДокумента", ДанныеШапки.НомерДокумента);
	
	// Заполнение сведений об основаниях.
	Если ЗначениеЗаполнено(ДанныеШапки.ДокументОснование) Тогда
		ОснованияСчета = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(Данные, "Основания");
		
		НоваяСтрока = ОснованияСчета.Добавить();
		НоваяСтрока.Наименование				= ДанныеШапки.НаименованиеОснования;
		НоваяСтрока.Номер						= ?(ЗначениеЗаполнено(ДанныеШапки.НомерОснования),
													ДанныеШапки.НомерОснования,
													НСтр("ru = 'Без номера'"));
		НоваяСтрока.Дата						= ДанныеШапки.ДатаОснования;
		НоваяСтрока.Идентификатор				= Строка(ДанныеШапки.ДокументОснование.УникальныйИдентификатор());
		НоваяСтрока.ИдентификаторГосКонтракта	= ДанныеШапки.ИдентификаторГосКонтракта;
		НоваяСтрока.ДополнительныеСведения		= ДанныеШапки.ДополнительныеСведения;
		
		ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(Данные, ОснованияСчета, "Основания");
	КонецЕсли;
	
	ДатаДокумента = ДанныеШапки.ДатаДокумента;
	
	// Заполнение сведений об участниках операции.
	ПолучательДенежныхСредств = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(ДанныеШапки.ОрганизацияПолучатель,
																					ДанныеШапки.БанковскийСчет,
																					ДатаДокумента);
	
	ЗаполнитьРеквизитыУчастникаСчетаНаОплату_1_01(Данные,
													ПолучательДенежныхСредств,
													"ПолучательДенежныхСредств",
													"Юр",
													ДатаДокумента);
	
	Покупатель = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(ДанныеШапки.Контрагент, Неопределено, ДатаДокумента);
	
	ЗаполнитьРеквизитыУчастникаСчетаНаОплату_1_01(Данные, Покупатель, "Плательщик", "Юр", ДатаДокумента);
	ЗаполнитьРеквизитыУчастникаСчетаНаОплату_1_01(Данные, Покупатель, "Покупатель", "Юр", ДатаДокумента);
	
	Продавец = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(ДанныеШапки.Организация, Неопределено, ДатаДокумента);
	
	ЗаполнитьРеквизитыУчастникаСчетаНаОплату_1_01(Данные, Продавец, "Продавец", "Юр", ДатаДокумента);
	
	Если Не ДанныеШапки.ТолькоУслуги
		И Не ДанныеШапки.ЧастичнаяОплата Тогда
		
		Если ЗначениеЗаполнено(ДанныеШапки.Грузоотправитель) Тогда
			Грузоотправитель = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(ДанныеШапки.Грузоотправитель,
																					Неопределено,
																					ДатаДокумента);
			
			ЗаполнитьРеквизитыУчастникаСчетаНаОплату_1_01(Данные,
															Грузоотправитель,
															"Грузоотправитель",
															"Факт",
															ДатаДокумента);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ДанныеШапки.Грузополучатель) Тогда
			Грузополучатель = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(ДанныеШапки.Грузополучатель,
																					Неопределено,
																					ДатаДокумента);
			
			ЗаполнитьРеквизитыУчастникаСчетаНаОплату_1_01(Данные,
															Грузополучатель,
															"Грузополучатель",
															"Факт",
															ДатаДокумента);
		КонецЕсли;
		
	КонецЕсли;
	
	// Заполнение сведений о товарах.
	ДокументБезНДС		= Истина;
	ВыводитьКодыТНВЭД	= ВыводитьКодыТНВЭД(Покупатель.СтранаРегистрации, ДатаДокумента);
	ОтборСтрок			= Новый Структура("ЭтоЗалогЗаТару", Истина);
	ЭтапыЗалоговойТары	= ЭтапыОплаты.НайтиСтроки(ОтборСтрок);
	ТолькоЗалогЗаТару	= ЭтапыЗалоговойТары.Количество() > 0
							И ЭтапыЗалоговойТары.Количество() = ЭтапыОплаты.Количество();
	
	ПараметрыЗаполненияТаблицы = Новый Структура;
	ПараметрыЗаполненияТаблицы.Вставить("ТолькоЗалогЗаТару",	ТолькоЗалогЗаТару);
	ПараметрыЗаполненияТаблицы.Вставить("ВыводитьКодыТНВЭД",	ВыводитьКодыТНВЭД);
	ПараметрыЗаполненияТаблицы.Вставить("ЗаполнениеКодаТовара",	Настройки.ВариантыЗаполненияПолей.ТоварКод);
	
	ТаблицаТоваров	= ТаблицаТоваровСчетаНаОплату_1_01(Данные,
														ДанныеШапки,
														ТоварыДокумента,
														ДокументБезНДС,
														ПараметрыЗаполненияТаблицы);
	
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(Данные, ТаблицаТоваров, "ТаблицаТоваров");
	
	// Заполнение показателей оплаты.
	ДанныеСуммыНалога = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(Данные,
																							"ВсегоКОплате.СуммаНалога");
	ДанныеСуммыНалога.СуммаНалога = ТаблицаТоваров.Итог("СуммаНалога");
	
	Если ДокументБезНДС Тогда
		ДанныеСуммыНалога.БезНДС = НСтр("ru = 'без НДС'");
	КонецЕсли;
	
	КоличествоТоваров = ТаблицаТоваров.Итог("Количество");
	
	ВсегоКОплате = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(Данные, "ВсегоКОплате");
	ВсегоКОплате.СтоимостьБезНДС	= ТаблицаТоваров.Итог("СтоимостьБезНДС");
	ВсегоКОплате.СтоимостьСНДС		= ТаблицаТоваров.Итог("СтоимостьСНДС");
	ВсегоКОплате.Количество			= ?(КоличествоТоваров = 0,
										1,
										КоличествоТоваров);
	ВсегоКОплате.СуммаСкидки		= ТаблицаТоваров.Итог("СуммаСкидки");
	ВсегоКОплате.СуммаНалога		= ДанныеСуммыНалога;
	
	ЭлектронноеВзаимодействие.ЗагрузитьСтруктуруВГруппуДерева(Данные, ВсегоКОплате, "ВсегоКОплате");
	
	// Заполнение дополнительных сведений счета на оплату.
	ДополнительныеСведения = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(
								Данные,
								"ДополнительныеСведения");
	ЗаполнитьЗначенияСвойств(ДополнительныеСведения, ДанныеШапки);
	
	ДополнительныеСведения.НазначениеПлатежа = НазначениеПлатежаСчетаНаОплату_1_01(ДанныеШапки);
	
	КоличествоЭтаповОплаты = ЭтапыОплаты.Количество();
	
	Если КоличествоЭтаповОплаты >= 1 Тогда
		Если КоличествоЭтаповОплаты = 1 Тогда
			ДополнительныеСведения.ОграничениеПоДатеОплаты = ЭтапыОплаты[0].ДатаПлатежа;
		ИначеЕсли КоличествоЭтаповОплаты > 1 Тогда
			ДополнительныеСведения.ОграничениеПоДатеОплаты = ЭтапыОплаты[КоличествоЭтаповОплаты - 1].ДатаПлатежа;
		КонецЕсли;
		
		// Обход проблемы заполнения условий оплаты в библиотеке БЭД.
		ДополнительныеСведения.УсловияОплаты = УсловияОплатыСчетаНаОплату_1_01(Данные,
																				ДанныеШапки,
																				ТоварыДокумента,
																				ЭтапыОплаты,
																				ПараметрыЗаполненияТаблицы);
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗагрузитьСтруктуруВГруппуДерева(Данные, ДополнительныеСведения, "ДополнительныеСведения");
	
	// Заполнение сведений о денежной единице.
	ДенежнаяЕдиница = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(Данные, "ДенежнаяЕдиница");
	ЗаполнитьЗначенияСвойств(ДенежнаяЕдиница, ДанныеШапки);
	
	КурсВалюты = РаботаСКурсамиВалютУТ.ПолучитьКурсВалюты(ДанныеШапки.Валюта,
															ДатаДокумента,
															ДанныеШапки.ВалютаРегламентированногоУчета);
	
	ДенежнаяЕдиница.КурсВалюты	= КурсВалюты.КурсЧислитель;
	ДенежнаяЕдиница.СуммаНалога	= ДанныеСуммыНалога;
	
	ЭлектронноеВзаимодействие.ЗагрузитьСтруктуруВГруппуДерева(Данные, ДенежнаяЕдиница, "ДенежнаяЕдиница");
	
	ВсегоНаименований = ?(КоличествоТоваров = 0,
							1,
							ТаблицаТоваров.Количество());
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Данные, "ВсегоНаименований", ВсегоНаименований);
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.НайтиСоздатьСчетНаОплату101.
Процедура НайтиСоздатьСчетНаОплату_1_01(ДеревоДанных, ДокументУчета, СпособОбработки, ОписаниеОшибки) Экспорт

	УстановитьПривилегированныйРежим(Истина);

	ДанныеДляЗагрузки = ПодготовитьСтруктуруДляСчетаНаОплату_1_01(ДеревоДанных, ОписаниеОшибки);
	Если ЗначениеЗаполнено(ОписаниеОшибки) Тогда
		Возврат;
	КонецЕсли;
	
	Если СпособОбработки = "ЗаявкаНаРасходованиеДенежныхСредств" Тогда

		ЗаполнитьЗаявкуНаРасходованиеДенежныхСредств(ДокументУчета, ДанныеДляЗагрузки, СпособОбработки, ОписаниеОшибки);

	ИначеЕсли СпособОбработки = "ЗаказПоставщику" Тогда

		Если ДанныеДляЗагрузки.Товары[0].Признак = "5" Тогда // при частичной оплате заказ поставщику не создаем
			ОписаниеОшибки = НСтр("ru = 'Нельзя создать документ ""Заказ поставщику"" на основании счета на частичную оплату.'");
			Возврат;
		КонецЕсли;
		
		ЗаполнитьЗаказПоставщику(ДокументУчета, ДанныеДляЗагрузки, СпособОбработки, ОписаниеОшибки);
		
	ИначеЕсли СпособОбработки = "СписаниеБезналичныхДенежныхСредств" Тогда

		ЗаполнитьДокументСписаниеБезналичныхДенежныхСредств(ДокументУчета, ДанныеДляЗагрузки, СпособОбработки, ОписаниеОшибки);

	ИначеЕсли СпособОбработки = "РасходныйКассовыйОрдер" Тогда

		ЗаполнитьДокументРасходныйКассовыйОрдер(ДокументУчета, ДанныеДляЗагрузки, СпособОбработки, ОписаниеОшибки);

	КонецЕсли;

КонецПроцедуры

#КонецОбласти

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеРеквизитыОрганизации.
Процедура ЗаполнитьДанныеРеквизитыОрганизации(СсылкаНаОбъект, ДеревоДанных, Отказ) Экспорт

	СведенияОбОрганизации = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(СсылкаНаОбъект);
	
	ЗаполнитьДанныеУчастника(ДеревоДанных, СведенияОбОрганизации, "Организация", "Юр", ТекущаяДатаСеанса());
	
	ДанныеРуководителя = ОтветственныеЛицаСервер.ПолучитьДанныеОтветственногоЛица(СсылкаНаОбъект,, Перечисления.ОтветственныеЛицаОрганизаций.Руководитель);
	Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ДанныеРуководителя, "Должность") 
	   И ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ДанныеРуководителя, "ФизическоеЛицо") Тогда
	   
	   	РуководительДолжность = ДанныеРуководителя.Должность;
		ФИОРуководителя = ФизическиеЛицаУТ.ФамилияИмяОтчество(ДанныеРуководителя.ФизическоеЛицо);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Организация.Руководитель.Фамилия", ФИОРуководителя.Фамилия);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Организация.Руководитель.Имя", ФИОРуководителя.Имя);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Организация.Руководитель.Отчество", ФИОРуководителя.Отчество);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Организация.Руководитель.Должность", РуководительДолжность);
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаФормирования", ТекущаяДатаСеанса());
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Наименование", "Реквизиты " + СсылкаНаОбъект.Наименование);

КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПоКаталогуТоваровCML.
Процедура ЗаполнитьДанныеПоКаталогуТоваровCML(Организация, ТоварыКаталога, ДеревоДанных, Отказ) Экспорт

	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "СодержитТолькоИзменения", Истина);
	
	СведенияОбОрганизации = Неопределено;
	СведенияОбОрганизации = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(Организация);
	ЗаполнитьДанныеУчастника(ДеревоДанных, СведенияОбОрганизации, "Владелец", "Юр", ТекущаяДатаСеанса());
	
	ДанныеДляЭД = ПолучитьДанныеПоТоварам(ТоварыКаталога, Организация);
	ДанныеДляЭД.Колонки.Добавить("Сопоставление");
	
	ШтрихкодыКомбинаций = Неопределено;
	ШтрихкодыНоменклатуры = Неопределено;
	НоменклатураПартнеровСервер.ШтрихкодыПоТоварам(ДанныеДляЭД, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры);	
	
	Для Каждого СтрокаТовара Из ДанныеДляЭД Цикл
		
		Сопоставление = Новый Структура;
		Сопоставление.Вставить("Наименование", СтрокаТовара.Наименование);
		Сопоставление.Вставить("Характеристика", СтрокаТовара.ХарактеристикаНаименование);
		Сопоставление.Вставить("ЕдиницаИзмерения", СтрокаТовара.БазоваяЕдиницаНаименование);
		Сопоставление.Вставить("Артикул", СтрокаТовара.Артикул);
		Сопоставление.Вставить("СтавкаНДС", СтрокаТовара.СтавкаНДС);
		Сопоставление.Вставить("НоменклатураИБ", СтрокаТовара.Номенклатура);
		Сопоставление.Вставить("ХарактеристикаИБ", СтрокаТовара.Характеристика);
		Сопоставление.Вставить("УпаковкаИБ", СтрокаТовара.Упаковка);		

		НоменклатураПартнеровСервер.ЗаполнитьШтрихкодыТоваровВСопоставление(Сопоставление, ШтрихкодыНоменклатуры, ШтрихкодыКомбинаций,
				СтрокаТовара.Номенклатура, СтрокаТовара.Характеристика, СтрокаТовара.Упаковка);
		
		СтрокаТовара.Сопоставление = Сопоставление;
		
	КонецЦикла;
	
	ЗаполнитьПараметрыОбработкиОшибокВТаблицеТоваровCML(ДанныеДляЭД);
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ДанныеДляЭД, "Товары");
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПоПрайсЛисту.
Процедура ЗаполнитьДанныеПоПрайсЛисту(СсылкаНаОбъект, ДеревоДокумента, Отказ) Экспорт
	
	Запрос = Новый Запрос;
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	КоммерческоеПредложениеКлиенту.Номер,
	|	КоммерческоеПредложениеКлиенту.Организация,
	|	КоммерческоеПредложениеКлиенту.Дата,
	|	КоммерческоеПредложениеКлиенту.Валюта,
	|	КоммерческоеПредложениеКлиенту.Валюта.Код КАК ВалютаКод,
	|	КоммерческоеПредложениеКлиенту.СрокДействия КАК СрокДействия
	|ИЗ
	|	Документ.КоммерческоеПредложениеКлиенту КАК КоммерческоеПредложениеКлиенту
	|ГДЕ
	|	КоммерческоеПредложениеКлиенту.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	%1 КАК Артикул,
	|	ВЫБОР
	|		КОГДА Товары.Номенклатура.НаименованиеПолное = """"
	|			ТОГДА Товары.Номенклатура.Наименование
	|		ИНАЧЕ Товары.Номенклатура.НаименованиеПолное
	|	КОНЕЦ КАК Наименование,
	|	Товары.Номенклатура,
	|	Товары.Характеристика,
	|	Товары.КоличествоУпаковок КАК Количество,
	|	&ТекстЗапросаКодЕдиницыИзмерения КАК ЕдиницаИзмеренияКодПоОКЕИ,
	|	&ТекстЗапросаНаименованиеЕдиницыИзмерения КАК ЕдиницаИзмеренияНаименование,
	|	ВЫБОР
	|		КОГДА Товары.Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
	|			ТОГДА 1
	|		ИНАЧЕ &ТекстЗапросаКоэффициентУпаковки
	|	КОНЕЦ КАК ЕдиницаИзмеренияКоэффициент,
	|	Товары.Цена,
	|	Товары.СтавкаНДС,
	|	Товары.Количество,
	|	Товары.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,	
	|	Товары.Номенклатура.ЕдиницаИзмерения.Код КАК БазоваяЕдиницаКод,
	|	Товары.Номенклатура.ЕдиницаИзмерения.Наименование КАК БазоваяЕдиницаНаименование,
	|	Товары.Номенклатура.ЕдиницаИзмерения.НаименованиеПолное КАК БазоваяЕдиницаНаименованиеПолное,
	|	Товары.Номенклатура.ЕдиницаИзмерения.МеждународноеСокращение КАК БазоваяЕдиницаМеждународноеСокращение,
	|	Товары.Упаковка,
	|	Товары.Ссылка.Валюта.Код КАК ВалютаЦены
	|ИЗ
	|	Документ.КоммерческоеПредложениеКлиенту.Товары КАК Товары
	|ГДЕ
	|	Товары.Ссылка = &Ссылка
	|	И Товары.Активность
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Товары.ВидЦены КАК ТипЦены,
	|	Товары.ВидЦены.Наименование КАК Наименование,
	|	Товары.Ссылка.Валюта.Код КАК Валюта,
	|	Товары.Ссылка.ЦенаВключаетНДС КАК ВключаетНДС
	|ИЗ
	|	Документ.КоммерческоеПредложениеКлиенту.Товары КАК Товары
	|ГДЕ
	|	Товары.Ссылка = &Ссылка
	|	И Товары.Активность
	|";
	
	ИмяДопКолонки = "";
	ИмяДополнительнойКолонки(ИмяДопКолонки);
	ТекстЗапроса = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					ТекстЗапроса, ?(ЗначениеЗаполнено(ИмяДопКолонки),"Товары.Номенклатура." + ИмяДопКолонки, """"""));
					
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"&ТекстЗапросаКодЕдиницыИзмерения",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаЗначениеРеквизитаЕдиницыИзмерения(
			"Код",
			"Товары.Упаковка",
			"Товары.Номенклатура"));
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"&ТекстЗапросаНаименованиеЕдиницыИзмерения",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаЗначениеРеквизитаЕдиницыИзмерения(
			"Наименование",
			"Товары.Упаковка",
			"Товары.Номенклатура"));
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"&ТекстЗапросаКоэффициентУпаковки",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаКоэффициентаУпаковки(
			"Товары.Упаковка",
			"Товары.Номенклатура"));
	
	Запрос.Текст = ТекстЗапроса;
	
	ВыборкаДляСопоставления = НоменклатураПартнеровСервер.ВыборкаДляСопоставленияНоменклатуры(СсылкаНаОбъект);
	
	Запрос.УстановитьПараметр("Ссылка", СсылкаНаОбъект);
	РезультатЗапроса = Запрос.ВыполнитьПакет();
	
	РеквизитыШапки = РезультатЗапроса[0].Выбрать();
	РеквизитыШапки.Следующий();
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"ДатаФормирования", 
			ТекущаяДатаСеанса());
			
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"ДействительноС", 
			ТекущаяДатаСеанса());
			
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"ДействительноДо", 
			РеквизитыШапки.СрокДействия);
			
	Описание = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Цены по комм. предложению %1 от %2'"),
				ПрефиксацияОбъектовКлиентСервер.НомерНаПечать(РеквизитыШапки.Номер, Ложь, Ложь),
				РеквизитыШапки.Дата);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Описание", 
			Описание);
	
	СведенияОПоставщике = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(РеквизитыШапки.Организация, , РеквизитыШапки.Дата);
	ЗаполнитьДанныеУчастника(ДеревоДокумента, СведенияОПоставщике, "Владелец", "Юр", РеквизитыШапки.Дата);
	
	ТаблицаТоваров = РезультатЗапроса[1].Выгрузить();
	ТаблицаТоваров.Колонки.Добавить("Сопоставление");
	
	ШтрихкодыКомбинаций = Неопределено;
	ШтрихкодыНоменклатуры = Неопределено;
	НоменклатураПартнеровСервер.ШтрихкодыПоТоварам(ТаблицаТоваров, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры);	

	СоответствиеСтавокНДСКонтрагента = Новый Соответствие;
	ЗаполнитьСоответствиеСтавокНДС(СоответствиеСтавокНДСКонтрагента);	
	ТаблицаСопоставления = ВыборкаДляСопоставления.Выгрузить();
	Для Каждого СтрокаТовары Из ТаблицаТоваров Цикл 
		СтрокаТовары.БазоваяЕдиницаКод = СокрЛП(СтрокаТовары.БазоваяЕдиницаКод);
		
		//Сопоставление
		ПараметрыОтбора = Новый Структура;
		ПараметрыОтбора.Вставить("Номенклатура", СтрокаТовары.Номенклатура);
		Если СтрокаТовары.Характеристика <> Неопределено Тогда
			ПараметрыОтбора.Вставить("Характеристика", СтрокаТовары.Характеристика);
		Иначе
			ПараметрыОтбора.Вставить("Характеристика", Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());				
		КонецЕсли;
		ПараметрыОтбора.Вставить("Упаковка", СтрокаТовары.Упаковка);
		СтрокиИзНоменклатурыКонтрагентов = ТаблицаСопоставления.НайтиСтроки(ПараметрыОтбора);
		Если СтрокиИзНоменклатурыКонтрагентов.Количество() Тогда
			НайденнаяСтрока = СтрокиИзНоменклатурыКонтрагентов[0];
			СтрокаТовары.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(НайденнаяСтрока,,,,СоответствиеСтавокНДСКонтрагента);
	    Иначе
			СтрокаТовары.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(СтрокаТовары, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры);
		КонецЕсли;
	КонецЦикла;
	ЗаполнитьПараметрыОбработкиОшибокВТаблицеТоваровCML(ТаблицаТоваров);
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДокумента, ТаблицаТоваров, "Товары");
	
	ТаблицаТипыЦен = РезультатЗапроса[2].Выгрузить();
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДокумента, ТаблицаТипыЦен, "ТипыЦен");
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПоСчету.
Процедура ЗаполнитьДанныеПоСчету(СсылкаНаОбъект, ДеревоДокумента, Отказ) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	ДопустимыеВидыДокументов = Новый Массив;
	ДопустимыеВидыДокументов.Добавить("ЗаказКлиента");
	ДопустимыеВидыДокументов.Добавить("РеализацияТоваровУслуг");
	ДопустимыеВидыДокументов.Добавить("АктВыполненныхРабот");
	ДопустимыеВидыДокументов.Добавить("ОтчетКомиссионера");
	ДопустимыеВидыДокументов.Добавить("ОтчетКомиссионераОСписании");
	ДопустимыеВидыДокументов.Добавить("ОтчетКомитенту");
	ДопустимыеВидыДокументов.Добавить("ОтчетКомитентуОЗакупках");
	ДопустимыеВидыДокументов.Добавить("ЗаявкаНаВозвратТоваровОтКлиента");
	ДопустимыеВидыДокументов.Добавить("ДоговорыКонтрагентов");
	
	ДокументОснование = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СсылкаНаОбъект,"ДокументОснование"); 
	ВидДокумента = ДокументОснование.Метаданные().Имя;
	
	Если ДопустимыеВидыДокументов.Найти(ВидДокумента) = Неопределено Тогда
		ВызватьИсключение 
			СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'ЭД ""Счет на оплату"" не может быть сформирована, т.к. не определено получение данных для основания вида %1'"),
				ВидДокумента);
	КонецЕсли;
	
	Если ВидДокумента <> "ДоговорыКонтрагентов" Тогда
		РеквизитыОснования = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументОснование, 
								"ЦенаВключаетНДС, НалогообложениеНДС, Дата, Номер, СуммаДокумента");
	Иначе
		РеквизитыОснования = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументОснование, 
								"НалогообложениеНДС, Дата, Номер");
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СчетНаОплатуКлиенту.Валюта КАК Валюта,
	|	СчетНаОплатуКлиенту.Валюта.Код КАК ВалютаКод,
	|	СчетНаОплатуКлиенту.Дата,
	|	СчетНаОплатуКлиенту.Номер,
	|	СчетНаОплатуКлиенту.СуммаДокумента,
	|	СчетНаОплатуКлиенту.БанковскийСчет,
	|	СчетНаОплатуКлиенту.НазначениеПлатежа,
	|	СчетНаОплатуКлиенту.ЧастичнаяОплата,
	|	ВЫБОР КОГДА СчетНаОплатуКлиенту.ДокументОснование ССЫЛКА Документ.ОтчетКомитенту
	|				И СчетНаОплатуКлиенту.ДокументОснование.СуммаВознаграждения = 0 ТОГДА
	|		0
	|	КОГДА СчетНаОплатуКлиенту.ДокументОснование ССЫЛКА Документ.ОтчетКомитенту ТОГДА // СуммаВознаграждения <> 0
	|		СчетНаОплатуКлиенту.СуммаДокумента * 100 / СчетНаОплатуКлиенту.ДокументОснование.СуммаВознаграждения
	|	КОГДА СчетНаОплатуКлиенту.ДокументОснование.СуммаДокумента = 0 ТОГДА
	|		0
	|	КОГДА СчетНаОплатуКлиенту.ДокументОснование ССЫЛКА Справочник.ДоговорыКонтрагентов ТОГДА
	|		100
	|	КОГДА (СчетНаОплатуКлиенту.ДокументОснование ССЫЛКА Документ.ЗаказКлиента
	|				ИЛИ СчетНаОплатуКлиенту.ДокументОснование ССЫЛКА Документ.ЗаявкаНаВозвратТоваровОтКлиента)
	|				И СчетНаОплатуКлиенту.ДокументОснование.ТребуетсяЗалогЗаТару ТОГДА
	|		СчетНаОплатуКлиенту.СуммаДокумента * 100 / (СчетНаОплатуКлиенту.ДокументОснование.СуммаДокумента + СчетНаОплатуКлиенту.ДокументОснование.СуммаВозвратнойТары)
	|	КОГДА СчетНаОплатуКлиенту.ДокументОснование ССЫЛКА Документ.ОтчетКомитентуОЗакупках ТОГДА
	|		СчетНаОплатуКлиенту.СуммаДокумента * 100 / (СчетНаОплатуКлиенту.ДокументОснование.СуммаДокумента + СчетНаОплатуКлиенту.ДокументОснование.СуммаВознаграждения)
	|	ИНАЧЕ
	|		СчетНаОплатуКлиенту.СуммаДокумента * 100 / СчетНаОплатуКлиенту.ДокументОснование.СуммаДокумента
	|	КОНЕЦ КАК ПроцентОплаты,
	|	СчетНаОплатуКлиенту.Организация,
	|	СчетНаОплатуКлиенту.Организация.ВалютаРегламентированногоУчета КАК ВалютаРегламентированногоУчета,
	|	СчетНаОплатуКлиенту.Контрагент,
	|	СчетНаОплатуКлиенту.ИдентификаторПлатежа,
	|	СчетНаОплатуКлиенту.ДокументОснование
	|ИЗ
	|	Документ.СчетНаОплатуКлиенту КАК СчетНаОплатуКлиенту
	|ГДЕ
	|	СчетНаОплатуКлиенту.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МАКСИМУМ(СчетЭтапыГрафикаОплаты.ДатаПлатежа) КАК ДатаПлатежа
	|ИЗ
	|	Документ.СчетНаОплатуКлиенту.ЭтапыГрафикаОплаты КАК СчетЭтапыГрафикаОплаты
	|ГДЕ
	|	СчетЭтапыГрафикаОплаты.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЭтапыГрафикаОплаты.ДатаПлатежа КАК ДатаПлатежа,
	|	ЭтапыГрафикаОплаты.ПроцентПлатежа,
	|	ЭтапыГрафикаОплаты.СуммаПлатежа
	|ИЗ
	|	Документ.СчетНаОплатуКлиенту.ЭтапыГрафикаОплаты КАК ЭтапыГрафикаОплаты
	|ГДЕ
	|	ЭтапыГрафикаОплаты.Ссылка = &Ссылка
	|
	|УПОРЯДОЧИТЬ ПО
	|	ДатаПлатежа
	|;
	|
	|";
	
	Если ЗначениеЗаполнено(ВидДокумента) Тогда
		Запрос.УстановитьПараметр("ДокОснование", СсылкаНаОбъект.ДокументОснование);
		
		Если ВидДокумента = "РеализацияТоваровУслуг" Тогда
			ТекстЗапросаТовары = 
			"ВЫБРАТЬ
			|	%1 КАК Артикул,
			|	ВЫБОР
			|		КОГДА Товары.Номенклатура.НаименованиеПолное = """"
			|			ТОГДА Товары.Номенклатура.Наименование
			|		ИНАЧЕ Товары.Номенклатура.НаименованиеПолное
			|	КОНЕЦ КАК Наименование,
			|	Товары.Номенклатура,
			|	Товары.Характеристика,
			|	ВЫБОР
			|		КОГДА Товары.Характеристика.НаименованиеПолное = """"
			|			ТОГДА Товары.Характеристика.Наименование
			|		ИНАЧЕ Товары.Характеристика.НаименованиеПолное
			|	КОНЕЦ КАК НаименованиеХарактеристики,
			|	Товары.КоличествоУпаковок КАК Количество,
			|	&ТекстЗапросаКодЕдиницыИзмерения КАК ЕдиницаИзмеренияКодПоОКЕИ,
			|	&ТекстЗапросаНаименованиеЕдиницыИзмерения КАК ЕдиницаИзмеренияНаименование,
			|	ВЫБОР
			|		КОГДА Товары.Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
			|			ТОГДА 1
			|		ИНАЧЕ &ТекстЗапросаКоэффициентУпаковки
			|	КОНЕЦ КАК ЕдиницаИзмеренияККоэффициент,
			|	Товары.Сумма,
			|	Товары.СтавкаНДС,
			|	Товары.СуммаНДС,
			|	Товары.СуммаСНДС,
			|	ВЫБОР
			|		КОГДА &ОтображатьСкидки ТОГДА
			|			Товары.Цена
			|		ИНАЧЕ Товары.Сумма/Товары.КоличествоУпаковок 
			|	КОНЕЦ КАК Цена,
			|	ВЫБОР
			|		КОГДА &ОтображатьСкидки ТОГДА
			|			Товары.СуммаРучнойСкидки + Товары.СуммаАвтоматическойСкидки
			|		ИНАЧЕ 0 
			|	КОНЕЦ КАК СуммаСкидки,
			|	ВЫБОР
			|		КОГДА
			|			Товары.Ссылка.ВернутьМногооборотнуюТару
			|			И Товары.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара)
			|		ТОГДА
			|			ИСТИНА
			|		ИНАЧЕ
			|			ЛОЖЬ
			|	КОНЕЦ КАК ЭтоВозвратнаяТара,
			|	Товары.Ссылка.ЦенаВключаетНДС КАК НДСУчтеноВСумме,
			|	Товары.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,			
			|	Товары.Номенклатура.ЕдиницаИзмерения.Код КАК БазоваяЕдиницаКод,
			|	Товары.Номенклатура.ЕдиницаИзмерения.Наименование КАК БазоваяЕдиницаНаименование,
			|	Товары.Номенклатура.ЕдиницаИзмерения.НаименованиеПолное КАК БазоваяЕдиницаНаименованиеПолное,
			|	Товары.Номенклатура.ЕдиницаИзмерения.МеждународноеСокращение КАК БазоваяЕдиницаМеждународноеСокращение,
			|	Товары.Упаковка КАК Упаковка
			|ИЗ
			|	Документ.РеализацияТоваровУслуг.Товары КАК Товары
			|ГДЕ
			|	Товары.Ссылка = &ДокОснование
			|			И (Товары.Номенклатура.ТипНоменклатуры <> ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара)
			|				ИЛИ Товары.Ссылка.ТребуетсяЗалогЗаТару
			|				ИЛИ НЕ Товары.Ссылка.ВернутьМногооборотнуюТару)";
			
		ИначеЕсли  ВидДокумента = "АктВыполненныхРабот"  Тогда
			ТекстЗапросаТовары = 
			"ВЫБРАТЬ
			|	%1 КАК Артикул,
			|	ВЫБОР
			|		КОГДА Товары.Номенклатура.НаименованиеПолное = """"
			|			ТОГДА Товары.Номенклатура.Наименование
			|		ИНАЧЕ Товары.Номенклатура.НаименованиеПолное
			|	КОНЕЦ КАК Наименование,
			|	Товары.Номенклатура,
			|	Товары.Характеристика,
			|	ВЫБОР
			|		КОГДА Товары.Характеристика.НаименованиеПолное = """"
			|			ТОГДА Товары.Характеристика.Наименование
			|		ИНАЧЕ Товары.Характеристика.НаименованиеПолное
			|	КОНЕЦ КАК НаименованиеХарактеристики,
			|	Товары.Номенклатура.ЕдиницаИзмерения.Код КАК ЕдиницаИзмеренияКодПоОКЕИ,
			|	Товары.Номенклатура.ЕдиницаИзмерения.Наименование КАК ЕдиницаИзмеренияНаименование,
			|	Товары.Количество КАК Количество,
			|	1 КАК ЕдиницаИзмеренияКоэффициент,
			|	Товары.Сумма,
			|	Товары.СтавкаНДС,
			|	Товары.СуммаНДС,
			|	Товары.СуммаСНДС,
			|	ВЫБОР
			|		КОГДА &ОтображатьСкидки ТОГДА
			|			Товары.Цена
			|		ИНАЧЕ Товары.Сумма/Товары.Количество 
			|	КОНЕЦ КАК Цена,
			|	ВЫБОР
			|		КОГДА &ОтображатьСкидки ТОГДА
			|			Товары.СуммаРучнойСкидки + Товары.СуммаАвтоматическойСкидки
			|		ИНАЧЕ 0 
			|	КОНЕЦ КАК СуммаСкидки,
			|	Товары.Содержание КАК Содержание,
			|	ЛОЖЬ КАК ЭтоВозвратнаяТара,
			|	Товары.Ссылка.ЦенаВключаетНДС КАК НДСУчтеноВСумме,
			|	Товары.Номенклатура.ЕдиницаИзмерения.Код КАК БазоваяЕдиницаКод,
			|	Товары.Номенклатура.ЕдиницаИзмерения.Наименование КАК БазоваяЕдиницаНаименование,
			|	Товары.Номенклатура.ЕдиницаИзмерения.НаименованиеПолное КАК БазоваяЕдиницаНаименованиеПолное,
			|	Товары.Номенклатура.ЕдиницаИзмерения.МеждународноеСокращение КАК БазоваяЕдиницаМеждународноеСокращение,
			|	Товары.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
			|	ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)	КАК Упаковка
			|ИЗ
			|	Документ.АктВыполненныхРабот.Услуги КАК Товары
			|ГДЕ
			|	Товары.Ссылка = &ДокОснование";
			
		ИначеЕсли ВидДокумента = "ЗаказКлиента" Тогда
			ТекстЗапросаТовары = 
			"ВЫБРАТЬ
			|	%1 КАК Артикул,
			|	ВЫБОР
			|		КОГДА Товары.Номенклатура.НаименованиеПолное = """"
			|			ТОГДА Товары.Номенклатура.Наименование
			|		ИНАЧЕ Товары.Номенклатура.НаименованиеПолное
			|	КОНЕЦ КАК Наименование,
			|	Товары.Номенклатура,
			|	Товары.Характеристика,
			|	ВЫБОР
			|		КОГДА Товары.Характеристика.НаименованиеПолное = """"
			|			ТОГДА Товары.Характеристика.Наименование
			|		ИНАЧЕ Товары.Характеристика.НаименованиеПолное
			|	КОНЕЦ КАК НаименованиеХарактеристики,
			|	Товары.КоличествоУпаковок КАК Количество,
			|	&ТекстЗапросаКодЕдиницыИзмерения КАК ЕдиницаИзмеренияКодПоОКЕИ,
			|	&ТекстЗапросаНаименованиеЕдиницыИзмерения КАК ЕдиницаИзмеренияНаименование,
			|	ВЫБОР
			|		КОГДА Товары.Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
			|			ТОГДА 1
			|		ИНАЧЕ &ТекстЗапросаКоэффициентУпаковки
			|	КОНЕЦ КАК ЕдиницаИзмеренияКоэффициент,
			|	Товары.Сумма,
			|	Товары.СтавкаНДС,
			|	Товары.СуммаНДС,
			|	Товары.СуммаСНДС,
			|	ВЫБОР
			|		КОГДА &ОтображатьСкидки ТОГДА
			|			Товары.Цена
			|		ИНАЧЕ Товары.Сумма/Товары.КоличествоУпаковок 
			|	КОНЕЦ КАК Цена,
			|	ВЫБОР
			|		КОГДА &ОтображатьСкидки ТОГДА
			|			Товары.СуммаРучнойСкидки + Товары.СуммаАвтоматическойСкидки
			|		ИНАЧЕ 0 
			|	КОНЕЦ КАК СуммаСкидки,
			|	ВЫБОР
			|		КОГДА
			|			Товары.Ссылка.ВернутьМногооборотнуюТару
			|			И Товары.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара)
			|		ТОГДА
			|			ИСТИНА
			|		ИНАЧЕ
			|			ЛОЖЬ
			|	КОНЕЦ КАК ЭтоВозвратнаяТара,
			|	Товары.Ссылка.ЦенаВключаетНДС КАК НДСУчтеноВСумме,
			|	Товары.Содержание КАК Содержание,
			|	Товары.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,			
			|	Товары.Номенклатура.ЕдиницаИзмерения.Код КАК БазоваяЕдиницаКод,
			|	Товары.Номенклатура.ЕдиницаИзмерения.Наименование КАК БазоваяЕдиницаНаименование,
			|	Товары.Номенклатура.ЕдиницаИзмерения.НаименованиеПолное КАК БазоваяЕдиницаНаименованиеПолное,
			|	Товары.Номенклатура.ЕдиницаИзмерения.МеждународноеСокращение КАК БазоваяЕдиницаМеждународноеСокращение,
			|	Товары.Упаковка КАК Упаковка
			|ИЗ
			|	Документ.ЗаказКлиента.Товары КАК Товары
			|ГДЕ
			|	Товары.Ссылка = &ДокОснование
			|			И (Товары.Отменено = ЛОЖЬ)
			|			И (Товары.Номенклатура.ТипНоменклатуры <> ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара)
			|				ИЛИ Товары.Ссылка.ТребуетсяЗалогЗаТару
			|				ИЛИ НЕ Товары.Ссылка.ВернутьМногооборотнуюТару)";
			
		ИначеЕсли ВидДокумента = "ОтчетКомиссионера" Тогда
			ТекстЗапросаТовары = 
			"ВЫБРАТЬ
			|	%1 КАК Артикул,
			|	ВЫБОР
			|		КОГДА Товары.Номенклатура.НаименованиеПолное = """"
			|			ТОГДА Товары.Номенклатура.Наименование
			|		ИНАЧЕ Товары.Номенклатура.НаименованиеПолное
			|	КОНЕЦ КАК Наименование,
			|	Товары.Номенклатура,
			|	Товары.Характеристика,
			|	ВЫБОР
			|		КОГДА Товары.Характеристика.НаименованиеПолное = """"
			|			ТОГДА Товары.Характеристика.Наименование
			|		ИНАЧЕ Товары.Характеристика.НаименованиеПолное
			|	КОНЕЦ КАК НаименованиеХарактеристики,
			|	Товары.КоличествоУпаковок КАК Количество,
			|	&ТекстЗапросаКодЕдиницыИзмерения КАК ЕдиницаИзмеренияКодПоОКЕИ,
			|	&ТекстЗапросаНаименованиеЕдиницыИзмерения КАК ЕдиницаИзмеренияНаименование,
			|	ВЫБОР
			|		КОГДА Товары.Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
			|			ТОГДА 1
			|		ИНАЧЕ &ТекстЗапросаКоэффициентУпаковки
			|	КОНЕЦ КАК ЕдиницаИзмеренияКоэффициент,
			|	Товары.СуммаПродажи КАК Сумма,
			|	Товары.СтавкаНДС,
			|	Товары.СуммаПродажиНДС КАК СуммаНДС,
			|	Товары.СуммаСНДС,
			|	Товары.ЦенаПродажи КАК Цена,
			|	ЛОЖЬ КАК ЭтоВозвратнаяТара,
			|	Товары.Ссылка.ЦенаВключаетНДС КАК НДСУчтеноВСумме,
			|	Товары.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,			
			|	Товары.Номенклатура.ЕдиницаИзмерения.Код КАК БазоваяЕдиницаКод,
			|	Товары.Номенклатура.ЕдиницаИзмерения.Наименование КАК БазоваяЕдиницаНаименование,
			|	Товары.Номенклатура.ЕдиницаИзмерения.НаименованиеПолное КАК БазоваяЕдиницаНаименованиеПолное,
			|	Товары.Номенклатура.ЕдиницаИзмерения.МеждународноеСокращение КАК БазоваяЕдиницаМеждународноеСокращение,
			|	Товары.Упаковка КАК Упаковка
			|ИЗ
			|	Документ.ОтчетКомиссионера.Товары КАК Товары
			|ГДЕ
			|	Товары.Ссылка = &ДокОснование";
			
		ИначеЕсли ВидДокумента = "ОтчетКомиссионераОСписании" Тогда
			ТекстЗапросаТовары = 
			"ВЫБРАТЬ
			|	%1 КАК Артикул,
			|	ВЫБОР
			|		КОГДА Товары.Номенклатура.НаименованиеПолное = """"
			|			ТОГДА Товары.Номенклатура.Наименование
			|		ИНАЧЕ Товары.Номенклатура.НаименованиеПолное
			|	КОНЕЦ КАК Наименование,
			|	Товары.Номенклатура,
			|	Товары.Характеристика,
			|	ВЫБОР
			|		КОГДА Товары.Характеристика.НаименованиеПолное = """"
			|			ТОГДА Товары.Характеристика.Наименование
			|		ИНАЧЕ Товары.Характеристика.НаименованиеПолное
			|	КОНЕЦ КАК НаименованиеХарактеристики,
			|	Товары.КоличествоУпаковок КАК Количество,
			|	&ТекстЗапросаКодЕдиницыИзмерения КАК ЕдиницаИзмеренияКодПоОКЕИ,
			|	&ТекстЗапросаНаименованиеЕдиницыИзмерения КАК ЕдиницаИзмеренияНаименование,
			|	ВЫБОР
			|		КОГДА Товары.Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
			|			ТОГДА 1
			|		ИНАЧЕ &ТекстЗапросаКоэффициентУпаковки
			|	КОНЕЦ КАК ЕдиницаИзмеренияКоэффициент,
			|	Товары.Сумма,
			|	Товары.СтавкаНДС,
			|	Товары.СуммаНДС,
			|	Товары.СуммаСНДС,
			|	Товары.Цена,
			|	ЛОЖЬ КАК ЭтоВозвратнаяТара,
			|	Товары.Ссылка.ЦенаВключаетНДС КАК НДСУчтеноВСумме,
			|	Товары.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,			
			|	Товары.Номенклатура.ЕдиницаИзмерения.Код КАК БазоваяЕдиницаКод,
			|	Товары.Номенклатура.ЕдиницаИзмерения.Наименование КАК БазоваяЕдиницаНаименование,
			|	Товары.Номенклатура.ЕдиницаИзмерения.НаименованиеПолное КАК БазоваяЕдиницаНаименованиеПолное,
			|	Товары.Номенклатура.ЕдиницаИзмерения.МеждународноеСокращение КАК БазоваяЕдиницаМеждународноеСокращение,
			|	Товары.Упаковка КАК Упаковка
			|ИЗ
			|	Документ.ОтчетКомиссионераОСписании.Товары КАК Товары
			|ГДЕ
			|	Товары.Ссылка = &ДокОснование";
			
		ИначеЕсли ВидДокумента = "ОтчетКомитенту" Тогда
			ТекстЗапросаТовары = 
			"ВЫБРАТЬ
			|	%1 КАК Артикул,
			|	ВЫБОР
			|		КОГДА Товары.Номенклатура.НаименованиеПолное = """"
			|			ТОГДА Товары.Номенклатура.Наименование
			|		ИНАЧЕ Товары.Номенклатура.НаименованиеПолное
			|	КОНЕЦ КАК Наименование,
			|	Товары.Номенклатура,
			|	Товары.Характеристика,
			|	ВЫБОР
			|		КОГДА Товары.Характеристика.НаименованиеПолное = """"
			|			ТОГДА Товары.Характеристика.Наименование
			|		ИНАЧЕ Товары.Характеристика.НаименованиеПолное
			|	КОНЕЦ КАК НаименованиеХарактеристики,
			|	Товары.КоличествоУпаковок КАК Количество,
			|	&ТекстЗапросаКодЕдиницыИзмерения КАК ЕдиницаИзмеренияКодПоОКЕИ,
			|	&ТекстЗапросаНаименованиеЕдиницыИзмерения КАК ЕдиницаИзмеренияНаименование,
			|	ВЫБОР
			|		КОГДА Товары.Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
			|			ТОГДА 1
			|		ИНАЧЕ &ТекстЗапросаКоэффициентУпаковки
			|	КОНЕЦ КАК ЕдиницаИзмеренияКоэффициент,
			|	Товары.Сумма,
			|	Товары.СтавкаНДС,
			|	Товары.СуммаНДС,
			|	Товары.СуммаСНДС,
			|	Товары.Цена,
			|	ЛОЖЬ КАК ЭтоВозвратнаяТара,
			|	Товары.Ссылка.ЦенаВключаетНДС КАК НДСУчтеноВСумме,
			|	Товары.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,			
			|	Товары.Номенклатура.ЕдиницаИзмерения.Код КАК БазоваяЕдиницаКод,
			|	Товары.Номенклатура.ЕдиницаИзмерения.Наименование КАК БазоваяЕдиницаНаименование,
			|	Товары.Номенклатура.ЕдиницаИзмерения.НаименованиеПолное КАК БазоваяЕдиницаНаименованиеПолное,
			|	Товары.Номенклатура.ЕдиницаИзмерения.МеждународноеСокращение КАК БазоваяЕдиницаМеждународноеСокращение,
			|	Товары.Упаковка КАК Упаковка
			|ИЗ
			|	Документ.ОтчетКомитенту.Товары КАК Товары
			|ГДЕ
			|	Товары.Ссылка = &ДокОснование";

		ИначеЕсли ВидДокумента = "ОтчетКомитентуОЗакупках" Тогда
			ТекстЗапросаТовары = 
			"ВЫБРАТЬ
			|	%1 КАК Артикул,
			|	ВЫБОР
			|		КОГДА Товары.Номенклатура.НаименованиеПолное = """"
			|			ТОГДА Товары.Номенклатура.Наименование
			|		ИНАЧЕ Товары.Номенклатура.НаименованиеПолное
			|	КОНЕЦ КАК Наименование,
			|	Товары.Номенклатура,
			|	Товары.Характеристика,
			|	ВЫБОР
			|		КОГДА Товары.Характеристика.НаименованиеПолное = """"
			|			ТОГДА Товары.Характеристика.Наименование
			|		ИНАЧЕ Товары.Характеристика.НаименованиеПолное
			|	КОНЕЦ КАК НаименованиеХарактеристики,
			|	Товары.КоличествоУпаковок КАК Количество,
			|	&ТекстЗапросаКодЕдиницыИзмерения КАК ЕдиницаИзмеренияКодПоОКЕИ,
			|	&ТекстЗапросаНаименованиеЕдиницыИзмерения КАК ЕдиницаИзмеренияНаименование,
			|	ВЫБОР
			|		КОГДА Товары.Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
			|			ТОГДА 1
			|		ИНАЧЕ &ТекстЗапросаКоэффициентУпаковки
			|	КОНЕЦ КАК ЕдиницаИзмеренияКоэффициент,
			|	Товары.Сумма,
			|	Товары.СтавкаНДС,
			|	Товары.СуммаНДС,
			|	Товары.СуммаСНДС,
			|	Товары.Цена,
			|	ЛОЖЬ КАК ЭтоВозвратнаяТара,
			|	Товары.Ссылка.ЦенаВключаетНДС КАК НДСУчтеноВСумме,
			|	Товары.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,			
			|	Товары.Номенклатура.ЕдиницаИзмерения.Код КАК БазоваяЕдиницаКод,
			|	Товары.Номенклатура.ЕдиницаИзмерения.Наименование КАК БазоваяЕдиницаНаименование,
			|	Товары.Номенклатура.ЕдиницаИзмерения.НаименованиеПолное КАК БазоваяЕдиницаНаименованиеПолное,
			|	Товары.Номенклатура.ЕдиницаИзмерения.МеждународноеСокращение КАК БазоваяЕдиницаМеждународноеСокращение,
			|	Товары.Упаковка КАК Упаковка
			|ИЗ
			|	Документ.ОтчетКомитентуОЗакупках.Товары КАК Товары
			|ГДЕ
			|	Товары.Ссылка = &ДокОснование";
			
		ИначеЕсли ВидДокумента = "ЗаявкаНаВозвратТоваровОтКлиента" Тогда
			ТекстЗапросаТовары = 
			"ВЫБРАТЬ
			|	%1 КАК Артикул,
			|	ВЫБОР
			|		КОГДА Товары.Номенклатура.НаименованиеПолное = """"
			|			ТОГДА Товары.Номенклатура.Наименование
			|		ИНАЧЕ Товары.Номенклатура.НаименованиеПолное
			|	КОНЕЦ КАК Наименование,
			|	Товары.Номенклатура,
			|	Товары.Характеристика,
			|	ВЫБОР
			|		КОГДА Товары.Характеристика.НаименованиеПолное = """"
			|			ТОГДА Товары.Характеристика.Наименование
			|		ИНАЧЕ Товары.Характеристика.НаименованиеПолное
			|	КОНЕЦ КАК НаименованиеХарактеристики,
			|	Товары.КоличествоУпаковок КАК Количество,
			|	&ТекстЗапросаКодЕдиницыИзмерения КАК ЕдиницаИзмеренияКодПоОКЕИ,
			|	&ТекстЗапросаНаименованиеЕдиницыИзмерения КАК ЕдиницаИзмеренияНаименование,
			|	ВЫБОР
			|		КОГДА Товары.Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
			|			ТОГДА 1
			|		ИНАЧЕ &ТекстЗапросаКоэффициентУпаковки
			|	КОНЕЦ КАК ЕдиницаИзмеренияКоэффициент,
			|	Товары.Сумма,
			|	Товары.СтавкаНДС,
			|	Товары.СуммаНДС,
			|	Товары.СуммаСНДС,
			|	ВЫБОР
			|		КОГДА &ОтображатьСкидки ТОГДА
			|			Товары.Цена
			|		ИНАЧЕ Товары.Сумма/Товары.КоличествоУпаковок 
			|	КОНЕЦ КАК Цена,
			|	ВЫБОР
			|		КОГДА &ОтображатьСкидки ТОГДА
			|			Товары.СуммаРучнойСкидки + Товары.СуммаАвтоматическойСкидки
			|		ИНАЧЕ 0 
			|	КОНЕЦ КАК СуммаСкидки,
			|	ВЫБОР
			|		КОГДА
			|			Товары.Ссылка.ВернутьМногооборотнуюТару
			|			И Товары.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара)
			|		ТОГДА
			|			ИСТИНА
			|		ИНАЧЕ
			|			ЛОЖЬ
			|	КОНЕЦ КАК ЭтоВозвратнаяТара,
			|	Товары.Ссылка.ЦенаВключаетНДС КАК НДСУчтеноВСумме,
			|	Товары.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,			
			|	Товары.Номенклатура.ЕдиницаИзмерения.Код КАК БазоваяЕдиницаКод,
			|	Товары.Номенклатура.ЕдиницаИзмерения.Наименование КАК БазоваяЕдиницаНаименование,
			|	Товары.Номенклатура.ЕдиницаИзмерения.НаименованиеПолное КАК БазоваяЕдиницаНаименованиеПолное,
			|	Товары.Номенклатура.ЕдиницаИзмерения.МеждународноеСокращение КАК БазоваяЕдиницаМеждународноеСокращение,
			|	Товары.Упаковка КАК Упаковка
			|ИЗ
			|	Документ.ЗаявкаНаВозвратТоваровОтКлиента.ЗаменяющиеТовары	КАК Товары
			|ГДЕ
			|	Товары.Ссылка = &ДокОснование
			|			И (Товары.Отменено = ЛОЖЬ)
			|			И (Товары.Номенклатура.ТипНоменклатуры <> ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара)
			|				ИЛИ Товары.Ссылка.ТребуетсяЗалогЗаТару
			|				ИЛИ НЕ Товары.Ссылка.ВернутьМногооборотнуюТару)";
			
		КонецЕсли;
		
		ИмяДопКолонки = "";
		ИмяДополнительнойКолонки(ИмяДопКолонки);
		ТекстЗапросаТовары = 
			СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				ТекстЗапросаТовары, 
				?(ЗначениеЗаполнено(ИмяДопКолонки),"Товары.Номенклатура." + ИмяДопКолонки, """"""));
		
		ТекстЗапросаТовары = СтрЗаменить(ТекстЗапросаТовары,
			"&ТекстЗапросаКодЕдиницыИзмерения",
			Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаЗначениеРеквизитаЕдиницыИзмерения(
				"Код",
				"Товары.Упаковка",
				"Товары.Номенклатура"));
				
		ТекстЗапросаТовары = СтрЗаменить(ТекстЗапросаТовары,
			"&ТекстЗапросаНаименованиеЕдиницыИзмерения",
			Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаЗначениеРеквизитаЕдиницыИзмерения(
				"Наименование",
				"Товары.Упаковка",
				"Товары.Номенклатура"));
			
		ТекстЗапросаТовары = СтрЗаменить(ТекстЗапросаТовары,
			"&ТекстЗапросаКоэффициентУпаковки",
			Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаКоэффициентаУпаковки(
				"Товары.Упаковка",
				"Товары.Номенклатура"));
	КонецЕсли;   
	
	ОтображатьСкидки = (Константы.ОтображениеСкидокВПечатныхФормахДокументовПродажи.Получить()
		<> Перечисления.ВариантыВыводаСкидокВПечатныхФормах.НеВыводитьСкидки);
	
	Запрос.Текст = Запрос.Текст + ТекстЗапросаТовары;
	
	Если ВидДокумента <> "ДоговорыКонтрагентов" Тогда
		ВыборкаДляСопоставления = НоменклатураПартнеровСервер.ВыборкаДляСопоставленияНоменклатуры(СсылкаНаОбъект.ДокументОснование);
	КонецЕсли;
	
	Запрос.УстановитьПараметр("Ссылка", СсылкаНаОбъект);
	Запрос.УстановитьПараметр("ОтображатьСкидки", ОтображатьСкидки);	
	РезультатЗапроса = Запрос.ВыполнитьПакет();
	
	РеквизитыШапки = РезультатЗапроса[0].Выбрать();
	РеквизитыШапки.Следующий();
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Дата", 
			РеквизитыШапки.Дата);
			
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Номер", 
			ПрефиксацияОбъектовКлиентСервер.НомерНаПечать(РеквизитыШапки.Номер));
			
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"НазначениеПлатежа", 
			РеквизитыШапки.НазначениеПлатежа);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"ЧастичнаяОплата", 
			РеквизитыШапки.ЧастичнаяОплата);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"НалогообложениеНДС", 
			Строка(РеквизитыОснования.НалогообложениеНДС));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Валюта", 
			РеквизитыШапки.ВалютаКод);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Курс", 
			РаботаСКурсамиВалютУТ.ПолучитьКурсВалюты(РеквизитыШапки.Валюта, РеквизитыШапки.Дата, РеквизитыШапки.ВалютаРегламентированногоУчета).КурсЧислитель);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Сумма", 
			РеквизитыШапки.СуммаДокумента);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"ДокументОснования.НомерДокументаОснования", 
			РеквизитыОснования.Номер);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"ДокументОснования.ДатаДокументаОснования", 
			Строка(РеквизитыОснования.Дата));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"ДокументОснования.НаименованиеДокументаОснования", 
			Строка(ДокументОснование));
	
	СведенияОПоставщике = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(РеквизитыШапки.Организация, , РеквизитыШапки.Дата);
	ЗаполнитьДанныеУчастника(ДеревоДокумента, СведенияОПоставщике, "Продавец", "Юр", РеквизитыШапки.Дата);
	
	СведенияОПокупателе = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(РеквизитыШапки.Контрагент, , РеквизитыШапки.Дата);
	ЗаполнитьДанныеУчастника(ДеревоДокумента, СведенияОПокупателе, "Покупатель", "Юр", РеквизитыШапки.Дата);
	
	// Заполняем документ основание
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДокумента, "ДокументыОснования", РеквизитыШапки.ДокументОснование);
	
	ВыборкаСрокПлатежа = РезультатЗапроса[1].Выбрать();
	ВыборкаСрокПлатежа.Следующий();
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"СрокПлатежа", 
			ВыборкаСрокПлатежа.ДатаПлатежа);
	
	ЭтапыГрафикаОплаты = РезультатЗапроса[2].Выгрузить();
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДокумента, ЭтапыГрафикаОплаты, "ГрафикОплаты");
	
	Если ВидДокумента <> "ДоговорыКонтрагентов" Тогда

		ТаблицаТоваров = РезультатЗапроса[3].Выгрузить();
		ТаблицаТоваров.Колонки.Добавить("Сопоставление");
		
		Если ТаблицаТоваров.Колонки.Найти("Содержание") = Неопределено Тогда
			ЕстьСодержание = Ложь;
		Иначе
			ЕстьСодержание = Истина;
		КонецЕсли;
		
		ИспользоватьНаборы = Ложь;
		Если ТаблицаТоваров.Колонки.Найти("ЭтоНабор") <> Неопределено Тогда
			ИспользоватьНаборы = Истина;
		КонецЕсли;
		
		ШтрихкодыКомбинаций = Неопределено;
		ШтрихкодыНоменклатуры = Неопределено;
		НоменклатураПартнеровСервер.ШтрихкодыПоТоварам(ТаблицаТоваров, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры);			
		
		СоответствиеСтавокНДСКонтрагента = Новый Соответствие;
		ЗаполнитьСоответствиеСтавокНДС(СоответствиеСтавокНДСКонтрагента);	
		ТаблицаСопоставления = ВыборкаДляСопоставления.Выгрузить();
		Для Каждого СтрокаТовары Из ТаблицаТоваров Цикл
			
			ПрефиксИПостфикс = НаборыСервер.ПолучитьПрефиксИПостфикс(СтрокаТовары, ИспользоватьНаборы);
				
			ДополнительныеПараметрыПолученияНаименованияДляПечати = НоменклатураКлиентСервер.ДополнительныеПараметрыПредставлениеНоменклатурыДляПечати();
			ДополнительныеПараметрыПолученияНаименованияДляПечати.ВозвратнаяТара = СтрокаТовары.ЭтоВозвратнаяТара;
			ДополнительныеПараметрыПолученияНаименованияДляПечати.КодОсновногоЯзыка = ОбщегоНазначения.КодОсновногоЯзыка();
			Если ЕстьСодержание Тогда
				ДополнительныеПараметрыПолученияНаименованияДляПечати.Содержание = СтрокаТовары.Содержание;
			КонецЕсли;
				
			Товар = ПрефиксИПостфикс.Префикс
					+ НоменклатураКлиентСервер.ПредставлениеНоменклатурыДляПечати(
														СтрокаТовары.Наименование,
														,
														,
														, // Серия
														ДополнительныеПараметрыПолученияНаименованияДляПечати)
					+ ПрефиксИПостфикс.Постфикс;
			СтрокаТовары.Наименование = Товар;
			
			СтрокаТовары.БазоваяЕдиницаКод = СокрЛП(СтрокаТовары.БазоваяЕдиницаКод);
			СтрокаТовары.Цена = Формат(СтрокаТовары.Цена, "ЧЦ=16; ЧДЦ=2");
			
			//Сопоставление
			ПараметрыОтбора = Новый Структура;
			ПараметрыОтбора.Вставить("Номенклатура", СтрокаТовары.Номенклатура);
			Если СтрокаТовары.Характеристика <> Неопределено Тогда
				ПараметрыОтбора.Вставить("Характеристика", СтрокаТовары.Характеристика);
			Иначе
				ПараметрыОтбора.Вставить("Характеристика", Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());				
			КонецЕсли;
			ПараметрыОтбора.Вставить("Упаковка", СтрокаТовары.Упаковка);
			СтрокиИзНоменклатурыКонтрагентов = ТаблицаСопоставления.НайтиСтроки(ПараметрыОтбора);
			Если СтрокиИзНоменклатурыКонтрагентов.Количество() Тогда
				НайденнаяСтрока = СтрокиИзНоменклатурыКонтрагентов[0];
				СтрокаТовары.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(НайденнаяСтрока,,,,СоответствиеСтавокНДСКонтрагента);
		    Иначе
				СтрокаТовары.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(СтрокаТовары, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры);
			КонецЕсли;
		КонецЦикла;	
		ЗаполнитьПараметрыОбработкиОшибокВТаблицеТоваровCML(ТаблицаТоваров);
		ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДокумента, ТаблицаТоваров, "Товары");
		
		Если Не РеквизитыШапки.ЧастичнаяОплата Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
					ДеревоДокумента, 
					"ИтогоПоДокументу.Сумма", 
					ТаблицаТоваров.Итог("Сумма"));
			
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
					ДеревоДокумента, 
					"ИтогоПоДокументу.СуммаНДС", 
					ТаблицаТоваров.Итог("СуммаНДС"));			
			
			СуммаБезСкидки = ТаблицаТоваров.Итог("Сумма");
			СуммаСкидки = 0;
			Если ТаблицаТоваров.Колонки.Найти("СуммаСкидки") <> Неопределено Тогда
				СуммаСкидки = ТаблицаТоваров.Итог("СуммаСкидки");
			КонецЕсли;
		Иначе
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
					ДеревоДокумента, 
					"ИтогоПоДокументу.Сумма", 
					РеквизитыШапки.СуммаДокумента);
					
			СуммаВсегоНДС = 0;
			Если ЗначениеЗаполнено(ТаблицаТоваров.Итог("СуммаНДС")) Тогда
				СуммаВсегоНДС = Окр(ТаблицаТоваров.Итог("СуммаНДС") /100 * РеквизитыШапки.ПроцентОплаты, 2);
			КонецЕсли;
			
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
					ДеревоДокумента, 
					"ИтогоПоДокументу.СуммаНДС", 
					СуммаВсегоНДС);					
				
			СуммаБезСкидки = РеквизитыШапки.СуммаДокумента;
			СуммаСкидки = 0;			
		КонецЕсли;
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДокумента, 
				"ИтогоПоДокументу.ЦенаВключаетНДС", 
				РеквизитыОснования.ЦенаВключаетНДС);		
		СуммаБезСкидки = СуммаБезСкидки + СуммаСкидки;
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДокумента, 
				"ИтогоПоДокументу.СуммаСкидки", 
				СуммаСкидки);
				
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДокумента, 
				"ИтогоПоДокументу.СуммаБезСкидки", 
				СуммаБезСкидки);
				
	Иначе
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДокумента, 
				"ИтогоПоДокументу.Сумма", 
				РеквизитыШапки.СуммаДокумента);
				
		Если ЗначениеЗаполнено(РеквизитыШапки.ДокументОснование.СтавкаНДС) Тогда
			СуммаНДС = ЦенообразованиеКлиентСервер.РассчитатьСуммуНДС(РеквизитыШапки.СуммаДокумента, РеквизитыШапки.ДокументОснование.СтавкаНДС);
		Иначе
			СуммаНДС = 0;
		КонецЕсли;
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДокумента, 
				"ИтогоПоДокументу.СуммаНДС", 
				СуммаНДС);
				
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДокумента, 
				"ИтогоПоДокументу.СуммаБезСкидки", 
				РеквизитыШапки.СуммаДокумента);
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДокумента, 
				"ИтогоПоДокументу.ЦенаВключаетНДС", 
				Истина);
		
	КонецЕсли;
	
	// Заполняем банковский счет
	Если ЗначениеЗаполнено(РеквизитыШапки.БанковскийСчет) Тогда
		БанковскийСчет = РеквизитыБанковскогоСчета("БанковскиеСчетаОрганизаций", РеквизитыШапки.БанковскийСчет);
		ДобавитьВДеревоДанныеСчета(ДеревоДокумента, БанковскийСчет);
	КонецЕсли;
	
	Если РеквизитыШапки.ЧастичнаяОплата Тогда
		ИтоговаяСтрока = НСтр("ru = 'Всего на сумму %СуммаПрописью%'");
		ИтоговаяСтрока = СтрЗаменить(ИтоговаяСтрока, "%СуммаПрописью%", ФормированиеПечатныхФорм.ФорматСумм(РеквизитыШапки.СуммаДокумента, РеквизитыШапки.Валюта));
	Иначе
		ИтоговаяСтрока = НСтр("ru = 'Всего наименований %Количество%, на сумму %Сумма%'");
		ИтоговаяСтрока = СтрЗаменить(ИтоговаяСтрока, "%Количество%", ТаблицаТоваров.Количество());
		ИтоговаяСтрока = СтрЗаменить(ИтоговаяСтрока, "%Сумма%", ФормированиеПечатныхФорм.ФорматСумм(РеквизитыШапки.СуммаДокумента, РеквизитыШапки.Валюта));
	КонецЕсли;
	ИтоговаяСтрока = ИтоговаяСтрока + Символы.ПС + РаботаСКурсамиВалют.СформироватьСуммуПрописью(РеквизитыШапки.СуммаДокумента, РеквизитыШапки.Валюта);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"ИтогиПрописью", 
			ИтоговаяСтрока);
			
	ЗаполнитьУИП(ДеревоДокумента, РеквизитыШапки.ИдентификаторПлатежа);
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПоЗаказуТоваров.
Процедура ЗаполнитьДанныеПоЗаказуТоваров(СсылкаНаОбъект, ДеревоДокумента, Отказ) Экспорт 
	
	Запрос = Новый Запрос;
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	ЗаказПоставщику.Дата КАК Дата,
	|	ЗаказПоставщику.Валюта.Код КАК ВалютаКод,
	|	ЗаказПоставщику.Валюта КАК Валюта,
	|	ЗаказПоставщику.СуммаДокумента КАК СуммаДокумента,
	|	ЗаказПоставщику.ЦенаВключаетНДС КАК ЦенаВключаетНДС,
	|	ЗаказПоставщику.ДополнительнаяИнформация КАК ДополнительнаяИнформация,
	|	ЗаказПоставщику.Номер КАК Номер,
	|	ЗаказПоставщику.Организация КАК Организация,
	|	ЗаказПоставщику.Организация.ВалютаРегламентированногоУчета КАК ВалютаРегламентированногоУчета,
	|	ЗаказПоставщику.Контрагент КАК Контрагент,
	|	ЗаказПоставщику.НомерПоДаннымПоставщика КАК НомерПоДаннымПоставщика,
	|	ЗаказПоставщику.ДатаПоДаннымПоставщика КАК ДатаПоДаннымПоставщика,
	|	ВЫБОР ЗаказПоставщику.СпособДоставки
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.СпособыДоставки.СиламиПоставщикаДоНашегоСклада)
	|			ТОГДА ЗаказПоставщику.АдресДоставкиДляПоставщика
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.СпособыДоставки.СиламиПеревозчикаДоНашегоСклада)
	|			ТОГДА ЗаказПоставщику.АдресДоставкиДляПоставщика
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.СпособыДоставки.СиламиПеревозчикаДоПунктаПередачи)
	|			ТОГДА ЗаказПоставщику.АдресДоставкиПеревозчика
	|		ИНАЧЕ ЗаказПоставщику.АдресДоставки
	|	КОНЕЦ КАК АдресДоставки,
	|	ВЫБОР ЗаказПоставщику.СпособДоставки
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.СпособыДоставки.СиламиПоставщикаДоНашегоСклада)
	|			ТОГДА """"
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.СпособыДоставки.СиламиПеревозчикаДоНашегоСклада)
	|			ТОГДА ЗаказПоставщику.АдресДоставкиПеревозчикаЗначенияПолей
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.СпособыДоставки.СиламиПеревозчикаДоПунктаПередачи)
	|			ТОГДА ЗаказПоставщику.АдресДоставкиПеревозчикаЗначенияПолей
	|		ИНАЧЕ ЗаказПоставщику.АдресДоставкиЗначенияПолей
	|	КОНЕЦ КАК АдресДоставкиЗначенияПолей,
	|	ВЫБОР ЗаказПоставщику.СпособДоставки
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.СпособыДоставки.СиламиПоставщикаДоНашегоСклада)
	|			ТОГДА ""Доставка""
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.СпособыДоставки.СиламиПеревозчикаДоНашегоСклада)
	|			ТОГДА ""Доставка""
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.СпособыДоставки.СиламиПеревозчикаДоПунктаПередачи)
	|			ТОГДА ""Доставка""
	|		ИНАЧЕ ""Самовывоз""
	|	КОНЕЦ КАК СпособДоставки,
	|	ЗаказПоставщику.ДокументОснование КАК ДокументОснование,
	|	ЗаказПоставщику.БанковскийСчет КАК БанковскийСчет,
	|	ЗаказПоставщику.Договор.Дата КАК ДоговорДата,
	|	ЗаказПоставщику.Договор.Номер КАК ДоговорНомер
	|ИЗ
	|	Документ.ЗаказПоставщику КАК ЗаказПоставщику
	|ГДЕ
	|	ЗаказПоставщику.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Товары.Номенклатура.Артикул КАК Артикул,
	|	ВЫБОР
	|		КОГДА Товары.Номенклатура.НаименованиеПолное = """"
	|			ТОГДА Товары.Номенклатура.Наименование
	|		ИНАЧЕ Товары.Номенклатура.НаименованиеПолное
	|	КОНЕЦ КАК Наименование,
	|	Товары.Номенклатура КАК Номенклатура,
	|	Товары.Характеристика КАК Характеристика,
	|	Товары.Характеристика.Наименование КАК НаименованиеХарактеристики,
	|	Товары.КоличествоУпаковок КАК Количество,
	|	&ТекстЗапросаКодЕдиницыИзмерения КАК ЕдиницаИзмеренияКодПоОКЕИ,
	|	&ТекстЗапросаНаименованиеЕдиницыИзмерения КАК ЕдиницаИзмеренияНаименование,
	|	ВЫБОР
	|		КОГДА Товары.Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
	|			ТОГДА 1
	|		ИНАЧЕ &ТекстЗапросаКоэффициентУпаковки
	|	КОНЕЦ КАК ЕдиницаИзмеренияКоэффициент,
	|	Товары.Сумма КАК Сумма,
	|	ВЫБОР
	|		КОГДА Товары.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОблагаетсяНДСУПокупателя)
	|			ТОГДА ""НДС исчисляется налоговым агентом""
	|		ИНАЧЕ Товары.СтавкаНДС
	|	КОНЕЦ КАК СтавкаНДС,
	|	Товары.СуммаНДС КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА Товары.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОблагаетсяНДСУПокупателя)
	|			ТОГДА 0
	|		ИНАЧЕ Товары.СуммаСНДС
	|	КОНЕЦ КАК СуммаСНДС,
	|	Товары.СуммаРучнойСкидки КАК СуммаСкидки,
	|	Товары.ПроцентРучнойСкидки КАК ПроцентСкидки,
	|	Товары.Цена КАК Цена,
	|	Товары.Ссылка.ЦенаВключаетНДС КАК НДСУчтеноВСумме,
	|	Товары.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,	
	|	Товары.Номенклатура.ЕдиницаИзмерения.Код КАК БазоваяЕдиницаКод,
	|	Товары.Номенклатура.ЕдиницаИзмерения.Наименование КАК БазоваяЕдиницаНаименование,
	|	Товары.Номенклатура.ЕдиницаИзмерения.НаименованиеПолное КАК БазоваяЕдиницаНаименованиеПолное,
	|	Товары.Номенклатура.ЕдиницаИзмерения.МеждународноеСокращение КАК БазоваяЕдиницаМеждународноеСокращение,
	|	Товары.Упаковка КАК Упаковка
	|ИЗ
	|	Документ.ЗаказПоставщику.Товары КАК Товары
	|ГДЕ
	|	Товары.Ссылка = &Ссылка
	|	И НЕ Товары.Отменено
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЭтапыГрафикаОплаты.ВариантОплаты КАК ВидОплаты,
	|	ЭтапыГрафикаОплаты.ДатаПлатежа КАК ДатаПлатежа,
	|	ЭтапыГрафикаОплаты.ПроцентПлатежа КАК ПроцентПлатежа,
	|	ЭтапыГрафикаОплаты.СуммаПлатежа КАК СуммаПлатежа
	|ИЗ
	|	Документ.ЗаказПоставщику.ЭтапыГрафикаОплаты КАК ЭтапыГрафикаОплаты
	|ГДЕ
	|	ЭтапыГрафикаОплаты.Ссылка = &Ссылка
	|	И ЭтапыГрафикаОплаты.Ссылка.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщика)
	|
	|УПОРЯДОЧИТЬ ПО
	|	ЭтапыГрафикаОплаты.НомерСтроки";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"&ТекстЗапросаКодЕдиницыИзмерения",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаЗначениеРеквизитаЕдиницыИзмерения(
			"Код",
			"Товары.Упаковка",
			"Товары.Номенклатура"));
			
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"&ТекстЗапросаНаименованиеЕдиницыИзмерения",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаЗначениеРеквизитаЕдиницыИзмерения(
			"Наименование",
			"Товары.Упаковка",
			"Товары.Номенклатура"));
			
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"&ТекстЗапросаКоэффициентУпаковки",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаКоэффициентаУпаковки(
			"Товары.Упаковка",
			"Товары.Номенклатура"));
	
	Запрос.Текст = ТекстЗапроса;
	
	ВыборкаДляСопоставления = НоменклатураПартнеровСервер.ВыборкаДляСопоставленияНоменклатуры(СсылкаНаОбъект);
	
	Запрос.УстановитьПараметр("Ссылка", СсылкаНаОбъект);
	МассивРезультатовЗапроса = Запрос.ВыполнитьПакет();
	
	РеквизитыШапки             = МассивРезультатовЗапроса[0].Выбрать();
	РеквизитыШапки.Следующий();
	ТаблицаЭтаповГрафикаОплаты = МассивРезультатовЗапроса[2].Выгрузить();
	
	СведенияОПоставщике = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(РеквизитыШапки.Контрагент, , РеквизитыШапки.Дата);
	Если ЗначениеЗаполнено(РеквизитыШапки.БанковскийСчет) Тогда
		БанковскийСчет = РеквизитыШапки.БанковскийСчет;
	Иначе
		БанковскийСчет = Неопределено;
	КонецЕсли;	
	СведенияОПокупателе = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(РеквизитыШапки.Организация, БанковскийСчет, РеквизитыШапки.Дата);
	ЗаполнитьДанныеУчастника(ДеревоДокумента, СведенияОПоставщике, "Продавец",   "Юр", РеквизитыШапки.Дата);
	ЗаполнитьДанныеУчастника(ДеревоДокумента, СведенияОПокупателе, "Покупатель", "Юр", РеквизитыШапки.Дата);
	ЗаполнитьДанныеУчастника(ДеревоДокумента, СведенияОПокупателе, "Получатель", "Юр", РеквизитыШапки.Дата);		
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДокумента, "Валюта",	РеквизитыШапки.ВалютаКод);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДокумента, "Курс", 
			РаботаСКурсамиВалютУТ.ПолучитьКурсВалюты(РеквизитыШапки.Валюта, РеквизитыШапки.Дата, РеквизитыШапки.ВалютаРегламентированногоУчета).КурсЧислитель);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДокумента, "Сумма", РеквизитыШапки.СуммаДокумента);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДокумента, "Комментарий", РеквизитыШапки.ДополнительнаяИнформация);
	
	// заполнение полей дерева данных Доставка
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДокумента, "Доставка.СпособДоставки",	РеквизитыШапки.СпособДоставки);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДокумента, "Доставка.АдресДоставки", РеквизитыШапки.АдресДоставки);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДокумента, "Доставка.АдресДоставкиЗначенияПолей",
		РеквизитыШапки.АдресДоставкиЗначенияПолей);
	
	// Номер и дата договора.
	Если ЗначениеЗаполнено(РеквизитыШапки.ДоговорНомер) И ЗначениеЗаполнено(РеквизитыШапки.ДоговорДата) Тогда
		РеквизитыДоговора = Новый ТаблицаЗначений;
		РеквизитыДоговора.Колонки.Добавить("Идентификатор");
		РеквизитыДоговора.Колонки.Добавить("Наименование");
		РеквизитыДоговора.Колонки.Добавить("Номер");
		РеквизитыДоговора.Колонки.Добавить("Дата");
		
		СтрокаРеквизитыДоговора = РеквизитыДоговора.Добавить();
		СтрокаРеквизитыДоговора.Идентификатор = НСтр("ru = 'Договор'");
		СтрокаРеквизитыДоговора.Наименование = НСтр("ru = 'Договор'");
		СтрокаРеквизитыДоговора.Номер = РеквизитыШапки.ДоговорНомер;
		СтрокаРеквизитыДоговора.Дата = РеквизитыШапки.ДоговорДата;
		
		ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДокумента, РеквизитыДоговора, "ДокументыСделки");
	КонецЕсли;
			
	ТаблицаТоваров = МассивРезультатовЗапроса[1].Выгрузить();
	ТаблицаТоваров.Колонки.Добавить("НомерСтроки");
	ТаблицаТоваров.Колонки.Добавить("Сопоставление");
	НомерСтроки = 1;
	
	ШтрихкодыКомбинаций = Неопределено;
	ШтрихкодыНоменклатуры = Неопределено;
	НоменклатураПартнеровСервер.ШтрихкодыПоТоварам(ТаблицаТоваров, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры);			
	
	СоответствиеСтавокНДСКонтрагента = Новый Соответствие;
	ЗаполнитьСоответствиеСтавокНДС(СоответствиеСтавокНДСКонтрагента);	
	ТаблицаСопоставления = ВыборкаДляСопоставления.Выгрузить();
	Для Каждого СтрокаТовары Из ТаблицаТоваров Цикл 
		СтрокаТовары.БазоваяЕдиницаКод = СокрЛП(СтрокаТовары.БазоваяЕдиницаКод);
		СтрокаТовары.ЕдиницаИзмеренияКоэффициент = Формат(СтрокаТовары.ЕдиницаИзмеренияКоэффициент, "ЧЦ=15; ЧДЦ=3");
		СтрокаТовары.НомерСтроки = НомерСтроки;
		НомерСтроки = НомерСтроки + 1;
		
		Если Не ЗначениеЗаполнено(СтрокаТовары.СтавкаНДС) Тогда
			СтрокаТовары.СтавкаНДС = Справочники.СтавкиНДС.БезНДС;
		КонецЕсли;
		
		//Сопоставление
		ПараметрыОтбора = Новый Структура;
		ПараметрыОтбора.Вставить("Номенклатура", СтрокаТовары.Номенклатура);
		Если СтрокаТовары.Характеристика <> Неопределено Тогда
			ПараметрыОтбора.Вставить("Характеристика", СтрокаТовары.Характеристика);
		Иначе
			ПараметрыОтбора.Вставить("Характеристика", Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());				
		КонецЕсли;
		ПараметрыОтбора.Вставить("Упаковка", СтрокаТовары.Упаковка);
		СтрокиИзНоменклатурыКонтрагентов = ТаблицаСопоставления.НайтиСтроки(ПараметрыОтбора);
		Если СтрокиИзНоменклатурыКонтрагентов.Количество() Тогда
			НайденнаяСтрока = СтрокиИзНоменклатурыКонтрагентов[0];
			СтрокаТовары.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(НайденнаяСтрока,,,,СоответствиеСтавокНДСКонтрагента);
	    Иначе
			СтрокаТовары.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(СтрокаТовары, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры);
		КонецЕсли;
	КонецЦикла;
	ЗаполнитьПараметрыОбработкиОшибокВТаблицеТоваровCML(ТаблицаТоваров);
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДокумента, ТаблицаТоваров, "Товары");
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДокумента, "ИтогоПоДокументу.СуммаИтог", ТаблицаТоваров.Итог("Сумма"));
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДокумента, "ИтогоПоДокументу.СуммаНалогаИтог", ТаблицаТоваров.Итог("СуммаНДС"));
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДокумента, "ИтогоПоДокументу.ЦенаВключаетНДС", РеквизитыШапки.ЦенаВключаетНДС);
	
	ИтоговаяСтрока = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						НСтр("ru = 'Всего наименований %1, на сумму %2'"),
						ТаблицаТоваров.Количество(), 
						ФормированиеПечатныхФорм.ФорматСумм(РеквизитыШапки.СуммаДокумента, РеквизитыШапки.Валюта));
	
	СуммаПрописью  = РаботаСКурсамиВалют.СформироватьСуммуПрописью(РеквизитыШапки.СуммаДокумента, РеквизитыШапки.Валюта);
	ИтоговаяСтрока = ИтоговаяСтрока + Символы.ПС + СуммаПрописью;
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДокумента, "ИтогиПрописью", ИтоговаяСтрока);
	
	ТаблицаЭтаповГрафикаОплаты = МассивРезультатовЗапроса[2].Выгрузить();
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДокумента, ТаблицаЭтаповГрафикаОплаты, "ГрафикОплаты");

КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПоОтветуНаЗаказ.
Процедура ЗаполнитьДанныеПоОтветуНаЗаказ(СсылкаНаОбъект, ДеревоДокумента, Отказ) Экспорт
	
	Запрос = Новый Запрос;
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	ЗаказКлиента.Валюта.Код КАК ВалютаКод,
	|	ЗаказКлиента.Валюта КАК Валюта,
	|	ЗаказКлиента.Дата,
	|	ЗаказКлиента.Номер,
	|	ЗаказКлиента.Организация,
	|	ЗаказКлиента.Организация.ВалютаРегламентированногоУчета КАК ВалютаРегламентированногоУчета,
	|	ЗаказКлиента.Контрагент,
	|	ЗаказКлиента.Грузоотправитель,
	|	ЗаказКлиента.Грузополучатель,
	|	ЗаказКлиента.БанковскийСчетГрузоотправителя,
	|	ЗаказКлиента.БанковскийСчетГрузополучателя,
	|	ЗаказКлиента.СуммаДокумента,
	|	ЗаказКлиента.ЦенаВключаетНДС,
	|	ЗаказКлиента.НомерПоДаннымКлиента,
	|	ЗаказКлиента.ДатаПоДаннымКлиента,
	|	ЗаказКлиента.БанковскийСчет,	
	|	ЗаказКлиента.БанковскийСчетКонтрагента,	
	|	ЗаказКлиента.ДополнительнаяИнформация,		
	|	ВЫБОР ЗаказКлиента.СпособДоставки
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.СпособыДоставки.ДоКлиента) ТОГДА
	|			ЗаказКлиента.АдресДоставки
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.СпособыДоставки.КПолучателюОпределяетСлужбаДоставки) ТОГДА
	|			ЗаказКлиента.АдресДоставки
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.СпособыДоставки.СиламиПеревозчика) ТОГДА
	|			ЗаказКлиента.АдресДоставки
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.СпособыДоставки.СиламиПеревозчикаПоАдресу) ТОГДА
	|			ЗаказКлиента.АдресДоставкиПеревозчика
	|	КОНЕЦ	КАК АдресДоставки,
	|	ВЫБОР ЗаказКлиента.СпособДоставки
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.СпособыДоставки.ДоКлиента)
	|			ТОГДА ЗаказКлиента.АдресДоставкиЗначенияПолей
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.СпособыДоставки.КПолучателюОпределяетСлужбаДоставки)
	|			ТОГДА ЗаказКлиента.АдресДоставкиЗначенияПолей
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.СпособыДоставки.СиламиПеревозчика)
	|			ТОГДА ЗаказКлиента.АдресДоставкиЗначенияПолей
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.СпособыДоставки.СиламиПеревозчикаПоАдресу) ТОГДА
	|			ЗаказКлиента.АдресДоставкиПеревозчикаЗначенияПолей
	|	КОНЕЦ КАК АдресДоставкиЗначенияПолей,
	|	ВЫБОР ЗаказКлиента.СпособДоставки
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.СпособыДоставки.ДоКлиента) ТОГДА
	|			""Доставка""
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.СпособыДоставки.СиламиПеревозчика) ТОГДА
	|			""Доставка""
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.СпособыДоставки.СиламиПеревозчикаПоАдресу) ТОГДА
	|			""Доставка""
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.СпособыДоставки.КПолучателюОпределяетСлужбаДоставки) ТОГДА
	|			""Доставка""
	|	КОНЕЦ	КАК СпособДоставки,
	|	ЗаказКлиента.ИдентификаторПлатежа,
	|	ЗаказКлиента.ДокументОснование,
	|	ЗаказКлиента.Договор.Номер КАК ДоговорНомер,
	|	ЗаказКлиента.Договор.Дата КАК ДоговорДата
	|ИЗ
	|	Документ.ЗаказКлиента КАК ЗаказКлиента
	|ГДЕ
	|	ЗаказКлиента.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	%1 КАК Артикул,
	|	ВЫБОР
	|		КОГДА Товары.Номенклатура.НаименованиеПолное = """"
	|			ТОГДА Товары.Номенклатура.Наименование
	|		ИНАЧЕ Товары.Номенклатура.НаименованиеПолное
	|	КОНЕЦ КАК Наименование,
	|	Товары.Номенклатура,
	|	Товары.Характеристика,
	|	Товары.КоличествоУпаковок КАК Количество,
	|	Товары.Упаковка КАК Упаковка,
	|	&ТекстЗапросаКодЕдиницыИзмерения КАК ЕдиницаИзмеренияКодПоОКЕИ,
	|	&ТекстЗапросаНаименованиеЕдиницыИзмерения КАК ЕдиницаИзмеренияНаименование,
	|	ВЫБОР
	|		КОГДА Товары.Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
	|			ТОГДА 1
	|		ИНАЧЕ &ТекстЗапросаКоэффициентУпаковки
	|	КОНЕЦ КАК ЕдиницаИзмеренияКоэффициент,
	|	Товары.Сумма,
	|	ВЫБОР
	|		КОГДА Товары.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОблагаетсяНДСУПокупателя)
	|			ТОГДА ""НДС исчисляется налоговым агентом""
	|		ИНАЧЕ Товары.СтавкаНДС
	|	КОНЕЦ КАК СтавкаНДС,
	|	Товары.СуммаНДС,
	|	Товары.Цена,
	|	Товары.СуммаРучнойСкидки + Товары.СуммаАвтоматическойСкидки КАК СуммаСкидки,
	|	ВЫБОР
	|		КОГДА Товары.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОблагаетсяНДСУПокупателя)
	|			ТОГДА 0
	|		ИНАЧЕ Товары.СуммаСНДС
	|	КОНЕЦ КАК СуммаСНДС,
	|	Товары.ПроцентРучнойСкидки + Товары.ПроцентАвтоматическойСкидки КАК ПроцентСкидки,
	|	Товары.Ссылка.ЦенаВключаетНДС КАК НДСУчтеноВСумме,
	|	Товары.Содержание КАК Описание,
	|	Товары.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,	
	|	Товары.Номенклатура.ЕдиницаИзмерения.Код КАК БазоваяЕдиницаКод,
	|	Товары.Номенклатура.ЕдиницаИзмерения.Наименование КАК БазоваяЕдиницаНаименование,
	|	Товары.Номенклатура.ЕдиницаИзмерения.НаименованиеПолное КАК БазоваяЕдиницаНаименованиеПолное,
	|	Товары.Номенклатура.ЕдиницаИзмерения.МеждународноеСокращение КАК БазоваяЕдиницаМеждународноеСокращение
	|ИЗ
	|	Документ.ЗаказКлиента.Товары КАК Товары
	|
	|ГДЕ
	|	Товары.Ссылка = &Ссылка
	|	И НЕ Товары.Отменено
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЭтапыГрафикаОплаты.ВариантОплаты КАК ВидОплаты,
	|	ЭтапыГрафикаОплаты.ДатаПлатежа,
	|	ЭтапыГрафикаОплаты.ПроцентПлатежа,
	|	ЭтапыГрафикаОплаты.СуммаПлатежа
	|ИЗ
	|	Документ.ЗаказКлиента.ЭтапыГрафикаОплаты КАК ЭтапыГрафикаОплаты
	|ГДЕ
	|	ЭтапыГрафикаОплаты.Ссылка = &Ссылка
	|	И ЭтапыГрафикаОплаты.Ссылка.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиенту)
	|
	|УПОРЯДОЧИТЬ ПО
	|	ЭтапыГрафикаОплаты.НомерСтроки";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"&ТекстЗапросаКодЕдиницыИзмерения",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаЗначениеРеквизитаЕдиницыИзмерения(
			"Код",
			"Товары.Упаковка",
			"Товары.Номенклатура"));
			
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"&ТекстЗапросаНаименованиеЕдиницыИзмерения",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаЗначениеРеквизитаЕдиницыИзмерения(
			"Наименование",
			"Товары.Упаковка",
			"Товары.Номенклатура"));
			
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"&ТекстЗапросаКоэффициентУпаковки",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаКоэффициентаУпаковки(
			"Товары.Упаковка",
			"Товары.Номенклатура"));
		
	ИмяДопКолонки = "";
	ИмяДополнительнойКолонки(ИмяДопКолонки);
	ТекстЗапроса = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						ТекстЗапроса, 
						?(ЗначениеЗаполнено(ИмяДопКолонки), "Товары.Номенклатура." + ИмяДопКолонки, """"""));
	
	Запрос.Текст = ТекстЗапроса;
	
	ВыборкаДляСопоставления = НоменклатураПартнеровСервер.ВыборкаДляСопоставленияНоменклатуры(СсылкаНаОбъект);
	
	Запрос.УстановитьПараметр("Ссылка", СсылкаНаОбъект);
	МассивРезультатовЗапроса = Запрос.ВыполнитьПакет();
	
	РеквизитыШапки = МассивРезультатовЗапроса[0].Выбрать();
	РеквизитыШапки.Следующий();
	
	СведенияОПоставщике = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(РеквизитыШапки.Организация, РеквизитыШапки.БанковскийСчет, РеквизитыШапки.Дата);
	ЗаполнитьДанныеУчастника(ДеревоДокумента, СведенияОПоставщике, "Продавец",   "Юр", РеквизитыШапки.Дата);
	Если ЗначениеЗаполнено(РеквизитыШапки.БанковскийСчет) Тогда
		БанковскийСчет = РеквизитыБанковскогоСчета("БанковскиеСчетаОрганизаций", РеквизитыШапки.БанковскийСчет);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Продавец.БанковскийСчет.НомерСчета", 
			БанковскийСчет.НомерСчета);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Продавец.БанковскийСчет.НаимБанк", 
			БанковскийСчет.Банк.Наименование);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Продавец.БанковскийСчет.БИК", 
			БанковскийСчет.Банк.Код);
			
		ДобавитьВДеревоДанныеСчета(ДеревоДокумента, БанковскийСчет);
	КонецЕсли;
	
	СведенияОПокупателе = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(РеквизитыШапки.Контрагент, РеквизитыШапки.БанковскийСчетКонтрагента, РеквизитыШапки.Дата);
	ЗаполнитьДанныеУчастника(ДеревоДокумента, СведенияОПокупателе, "Покупатель", "Юр", РеквизитыШапки.Дата);
	
	Если ЗначениеЗаполнено(РеквизитыШапки.Грузополучатель) Тогда
		СведенияОГрузополучателе  = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(РеквизитыШапки.Грузополучатель, РеквизитыШапки.БанковскийСчетГрузополучателя, РеквизитыШапки.Дата);
		ЗаполнитьДанныеУчастника(ДеревоДокумента, СведенияОГрузополучателе, "Получатель", "Юр", РеквизитыШапки.Дата);
	Иначе
		ЗаполнитьДанныеУчастника(ДеревоДокумента, СведенияОПокупателе, "Получатель", "Юр", РеквизитыШапки.Дата);		
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Валюта", 
			РеквизитыШапки.ВалютаКод);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Курс", 
			РаботаСКурсамиВалютУТ.ПолучитьКурсВалюты(РеквизитыШапки.Валюта, РеквизитыШапки.Дата, РеквизитыШапки.ВалютаРегламентированногоУчета).КурсЧислитель);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Сумма", 
			РеквизитыШапки.СуммаДокумента);
			
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Комментарий", 
			РеквизитыШапки.ДополнительнаяИнформация);
	
	ТаблицаТоваров = МассивРезультатовЗапроса[1].Выгрузить();
	ТаблицаТоваров.Колонки.Добавить("Сопоставление");
	
	ШтрихкодыКомбинаций = Неопределено;
	ШтрихкодыНоменклатуры = Неопределено;
	НоменклатураПартнеровСервер.ШтрихкодыПоТоварам(ТаблицаТоваров, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры);			
	
	СоответствиеСтавокНДСКонтрагента = Новый Соответствие;
	ЗаполнитьСоответствиеСтавокНДС(СоответствиеСтавокНДСКонтрагента);	
	ТаблицаСопоставления = ВыборкаДляСопоставления.Выгрузить();
	Для Каждого СтрокаТовары Из ТаблицаТоваров Цикл 
		СтрокаТовары.БазоваяЕдиницаКод = СокрЛП(СтрокаТовары.БазоваяЕдиницаКод);
		СтрокаТовары.ЕдиницаИзмеренияКоэффициент = Формат(СтрокаТовары.ЕдиницаИзмеренияКоэффициент, "ЧЦ=15; ЧДЦ=3");
		
		Если Не ЗначениеЗаполнено(СтрокаТовары.СтавкаНДС) Тогда
			СтрокаТовары.СтавкаНДС = Справочники.СтавкиНДС.БезНДС;
		КонецЕсли;
		
		//Сопоставление
		ПараметрыОтбора = Новый Структура;
		ПараметрыОтбора.Вставить("Номенклатура", СтрокаТовары.Номенклатура);
		Если СтрокаТовары.Характеристика <> Неопределено Тогда
			ПараметрыОтбора.Вставить("Характеристика", СтрокаТовары.Характеристика);
		Иначе
			ПараметрыОтбора.Вставить("Характеристика", Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());				
		КонецЕсли;
		ПараметрыОтбора.Вставить("Упаковка", СтрокаТовары.Упаковка);
		СтрокиИзНоменклатурыКонтрагентов = ТаблицаСопоставления.НайтиСтроки(ПараметрыОтбора);
		Если СтрокиИзНоменклатурыКонтрагентов.Количество() Тогда
			НайденнаяСтрока = СтрокиИзНоменклатурыКонтрагентов[0];
			СтрокаТовары.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(НайденнаяСтрока,,,,СоответствиеСтавокНДСКонтрагента);
	    Иначе
			СтрокаТовары.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(СтрокаТовары, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры);
		КонецЕсли;		
	КонецЦикла;	
	ЗаполнитьПараметрыОбработкиОшибокВТаблицеТоваровCML(ТаблицаТоваров);
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДокумента, ТаблицаТоваров, "Товары");
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"ИтогоПоДокументу.СуммаИтог", 
			ТаблицаТоваров.Итог("Сумма"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"ИтогоПоДокументу.СуммаНалогаИтог", 
			ТаблицаТоваров.Итог("СуммаНДС"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"ИтогоПоДокументу.ЦенаВключаетНДС", 
			РеквизитыШапки.ЦенаВключаетНДС);
			
	// заполнение полей дерева данных Доставка
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДокумента, "Доставка.СпособДоставки",	РеквизитыШапки.СпособДоставки);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДокумента, "Доставка.АдресДоставки", РеквизитыШапки.АдресДоставки);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДокумента, "Доставка.АдресДоставкиЗначенияПолей",
		РеквизитыШапки.АдресДоставкиЗначенияПолей);
	
	// Номер и дата договора.
	Если ЗначениеЗаполнено(РеквизитыШапки.ДоговорНомер) И ЗначениеЗаполнено(РеквизитыШапки.ДоговорДата) Тогда
		РеквизитыДоговора = Новый ТаблицаЗначений;
		РеквизитыДоговора.Колонки.Добавить("Идентификатор");
		РеквизитыДоговора.Колонки.Добавить("Наименование");
		РеквизитыДоговора.Колонки.Добавить("Номер");
		РеквизитыДоговора.Колонки.Добавить("Дата");
		
		СтрокаРеквизитыДоговора = РеквизитыДоговора.Добавить();
		СтрокаРеквизитыДоговора.Идентификатор = НСтр("ru = 'Договор'");
		СтрокаРеквизитыДоговора.Наименование = НСтр("ru = 'Договор'");
		СтрокаРеквизитыДоговора.Номер = РеквизитыШапки.ДоговорНомер;
		СтрокаРеквизитыДоговора.Дата = РеквизитыШапки.ДоговорДата;
		
		ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДокумента, РеквизитыДоговора, "ДокументыСделки");
	КонецЕсли;
	
	// Документ основание.
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДокумента, "ДокументыОснования", РеквизитыШапки.ДокументОснование);
	
	ТаблицаЭтаповГрафикаОплаты = МассивРезультатовЗапроса[2].Выгрузить();
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДокумента, ТаблицаЭтаповГрафикаОплаты, "ГрафикОплаты");
	
	ЗаполнитьУИП(ДеревоДокумента, РеквизитыШапки.ИдентификаторПлатежа);

КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПоОтчетуОПродажахКомиссионногоТовара.
Процедура ЗаполнитьДанныеПоОтчетуОПродажахКомиссионногоТовара(СсылкаНаОбъект, ДеревоДокумента, Отказ) Экспорт
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	ОтчетКомитенту.Дата,
	|	ОтчетКомитенту.Валюта,
	|	ОтчетКомитенту.Валюта.Код КАК ВалютаКод,	
	|	ОтчетКомитенту.СуммаДокумента,
	|	ОтчетКомитенту.ЦенаВключаетНДС,
	|	ОтчетКомитенту.СуммаВознаграждения,
	|	ОтчетКомитенту.НалогообложениеНДС,
	|	ОтчетКомитенту.НачалоПериода,
	|	ОтчетКомитенту.КонецПериода,
	|	ОтчетКомитенту.ФормаОплаты,
	|	ОтчетКомитенту.СпособРасчетаВознаграждения,
	|	ОтчетКомитенту.ПроцентВознаграждения,
	|	ОтчетКомитенту.ДатаПлатежа,
	|	ОтчетКомитенту.ИдентификаторПлатежа,
	|	ОтчетКомитенту.СтавкаНДСВознаграждения,
	|	ОтчетКомитенту.СуммаНДСВознаграждения,
	|	ОтчетКомитенту.Контрагент,
	|	ОтчетКомитенту.Организация,
	|	ОтчетКомитенту.Организация КАК Организация1,
	|	ОтчетКомитенту.Организация.ВалютаРегламентированногоУчета КАК ВалютаРегламентированногоУчета,
	|	ОтчетКомитенту.Контрагент КАК Контрагент1
	|ИЗ
	|	Документ.ОтчетКомитенту КАК ОтчетКомитенту
	|ГДЕ
	|	ОтчетКомитенту.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Товары.НомерСтроки КАК НомерСтроки,
	|	Товары.Номенклатура.Артикул КАК Артикул,
	|	ВЫБОР
	|		КОГДА Товары.Номенклатура.НаименованиеПолное = """"
	|			ТОГДА Товары.Номенклатура.Наименование
	|		ИНАЧЕ Товары.Номенклатура.НаименованиеПолное
	|	КОНЕЦ КАК Наименование,
	|	Товары.Номенклатура КАК Номенклатура,
	|	Товары.Характеристика КАК Характеристика,
	|	Товары.Характеристика.Наименование КАК НаименованиеХарактеристики,
	|	Товары.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,	
	|	Товары.Номенклатура.ЕдиницаИзмерения.Код КАК БазоваяЕдиницаКод,
	|	Товары.Номенклатура.ЕдиницаИзмерения.Наименование КАК БазоваяЕдиницаНаименование,
	|	Товары.Номенклатура.ЕдиницаИзмерения.НаименованиеПолное КАК БазоваяЕдиницаНаименованиеПолное,
	|	Товары.Номенклатура.ЕдиницаИзмерения.МеждународноеСокращение КАК БазоваяЕдиницаМеждународноеСокращение,
	|	Товары.КоличествоУпаковок КАК Количество,
	|	&ТекстЗапросаКодЕдиницыИзмерения КАК ЕдиницаИзмеренияКодПоОКЕИ,
	|	&ТекстЗапросаНаименованиеЕдиницыИзмерения КАК ЕдиницаИзмеренияНаименование,
	|	ВЫБОР
	|		КОГДА Товары.Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
	|			ТОГДА 1
	|		ИНАЧЕ &ТекстЗапросаКоэффициентУпаковки
	|	КОНЕЦ КАК ЕдиницаИзмеренияКоэффициент,
	|	Товары.Ссылка.ЦенаВключаетНДС КАК НДСУчтеноВСумме,
	|	Товары.Сумма КАК Сумма,
	|	Товары.СтавкаНДС КАК СтавкаНДС,
	|	Товары.СуммаНДС КАК СуммаНДС,
	|	Товары.СуммаПродажи КАК СуммаПродажи,
	|	Товары.СуммаВознаграждения КАК СуммаВознаграждения,
	|	Товары.СуммаСНДС КАК СуммаСНДС,
	|	Товары.Упаковка КАК Упаковка,
	|	Товары.ДатаСчетаФактуры КАК ДатаПродажи,
	|	Товары.Покупатель КАК Контрагент,
	|	Товары.ЦенаПродажи КАК ЦенаПродажи,
	|	Товары.Цена
	|ИЗ
	|	Документ.ОтчетКомитенту.Товары КАК Товары
	|ГДЕ
	|	Товары.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОтчетКомитентуЭтапыГрафикаОплаты.ДатаПлатежа КАК ДатаПлатежа,
	|	ОтчетКомитентуЭтапыГрафикаОплаты.ПроцентПлатежа,
	|	ОтчетКомитентуЭтапыГрафикаОплаты.СуммаПлатежа
	|ИЗ
	|	Документ.ОтчетКомитенту.ЭтапыГрафикаОплаты КАК ОтчетКомитентуЭтапыГрафикаОплаты
	|ГДЕ
	|	ОтчетКомитентуЭтапыГрафикаОплаты.Ссылка = &Ссылка
	|
	|УПОРЯДОЧИТЬ ПО
	|	ДатаПлатежа
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОтчетКомитенту.Услуга.Код КАК ИД,
	|	ОтчетКомитенту.Услуга.Артикул КАК Артикул,
	|	ОтчетКомитенту.Услуга.Наименование КАК Наименование,
	|	ОтчетКомитенту.Услуга.ЕдиницаИзмерения КАК БазоваяЕдиница,
	|	ОтчетКомитенту.Услуга.ЕдиницаИзмерения.Код КАК БазоваяЕдиницаКод,
	|	ОтчетКомитенту.Услуга.ЕдиницаИзмерения.Наименование КАК БазоваяЕдиницаНаименование,
	|	ОтчетКомитенту.Услуга.ЕдиницаИзмерения.НаименованиеПолное КАК БазоваяЕдиницаНаименованиеПолное,
	|	ОтчетКомитенту.Услуга.ЕдиницаИзмерения.МеждународноеСокращение КАК БазоваяЕдиницаМеждународноеСокращение
	|ИЗ
	|	Документ.ОтчетКомитенту КАК ОтчетКомитенту
	|ГДЕ
	|	ОтчетКомитенту.Ссылка = &Ссылка";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"&ТекстЗапросаКодЕдиницыИзмерения",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаЗначениеРеквизитаЕдиницыИзмерения(
			"Код",
			"Товары.Упаковка",
			"Товары.Номенклатура"));
			
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"&ТекстЗапросаНаименованиеЕдиницыИзмерения",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаЗначениеРеквизитаЕдиницыИзмерения(
			"Наименование",
			"Товары.Упаковка",
			"Товары.Номенклатура"));
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"&ТекстЗапросаКоэффициентУпаковки",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаКоэффициентаУпаковки(
			"Товары.Упаковка",
			"Товары.Номенклатура"));
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	
	ВыборкаДляСопоставления = НоменклатураПартнеровСервер.ВыборкаДляСопоставленияНоменклатуры(СсылкаНаОбъект);
	
	Запрос.УстановитьПараметр("Ссылка", СсылкаНаОбъект);
	РезультатЗапроса = Запрос.ВыполнитьПакет();
	
	РеквизитыШапки = РезультатЗапроса[0].Выбрать();
	РеквизитыШапки.Следующий();
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"ДатаФормирования", 
			ТекущаяДатаСеанса());
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Валюта", 
			РеквизитыШапки.ВалютаКод);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Курс", 
			РаботаСКурсамиВалютУТ.ПолучитьКурсВалюты(РеквизитыШапки.Валюта, РеквизитыШапки.Дата, РеквизитыШапки.ВалютаРегламентированногоУчета).КурсЧислитель);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"НачалоПериода", 
			РеквизитыШапки.НачалоПериода);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"КонецПериода", 
			РеквизитыШапки.КонецПериода);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"ФормаОплаты", 
			Строка(РеквизитыШапки.ФормаОплаты));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"СпособРасчета", 
			Строка(РеквизитыШапки.СпособРасчетаВознаграждения));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"ДатаОплаты", 
			РеквизитыШапки.ДатаПлатежа);
			
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Сумма", 
			РеквизитыШапки.СуммаДокумента);
			
	СведенияОКомитенте = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(РеквизитыШапки.Контрагент, , РеквизитыШапки.Дата);
	ЗаполнитьДанныеУчастника(ДеревоДокумента, СведенияОКомитенте, "Комитент", "Юр", РеквизитыШапки.Дата);
	
	СведенияОКомиссионере = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(РеквизитыШапки.Организация, , РеквизитыШапки.Дата);
	ЗаполнитьДанныеУчастника(ДеревоДокумента, СведенияОКомиссионере, "Комиссионер", "Юр", РеквизитыШапки.Дата);
	
	ТаблицаТоваров = РезультатЗапроса[1].Выгрузить();
	ТаблицаТоваров.Колонки.Добавить("Сопоставление");
	ТаблицаТоваров.Колонки.Добавить("СведенияОПрослеживаемости");
	
	// Получение данных для заполнения прослеживаемости
	ДанныеПоПрослеживаемости = ПолучитьДанныеПоПрослеживаемостиДляКомиссии(СсылкаНаОбъект, ТипЗнч(СсылкаНаОбъект));
	ПрослеживаемыеТовары		= ДанныеПоПрослеживаемости.ПрослеживаемыеТовары;
	ПрослеживаемыеКомплектующие	= ДанныеПоПрослеживаемости.ПрослеживаемыеКомплектующие;
	
	ШтрихкодыКомбинаций = Неопределено;
	ШтрихкодыНоменклатуры = Неопределено;
	НоменклатураПартнеровСервер.ШтрихкодыПоТоварам(ТаблицаТоваров, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры);	

	СоответствиеСтавокНДСКонтрагента = Новый Соответствие;
	ЗаполнитьСоответствиеСтавокНДС(СоответствиеСтавокНДСКонтрагента);	
	ТаблицаСопоставления = ВыборкаДляСопоставления.Выгрузить();
	Для Каждого СтрокаТовары Из ТаблицаТоваров Цикл 
		СтрокаТовары.БазоваяЕдиницаКод = СокрЛП(СтрокаТовары.БазоваяЕдиницаКод);
		
		//Сопоставление
		ПараметрыОтбора = Новый Структура;
		ПараметрыОтбора.Вставить("Номенклатура", СтрокаТовары.Номенклатура);
		Если СтрокаТовары.Характеристика <> Неопределено Тогда
			ПараметрыОтбора.Вставить("Характеристика", СтрокаТовары.Характеристика);
		Иначе
			ПараметрыОтбора.Вставить("Характеристика", Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());
		КонецЕсли;
		ПараметрыОтбора.Вставить("Упаковка", СтрокаТовары.Упаковка);
		СтрокиИзНоменклатурыКонтрагентов = ТаблицаСопоставления.НайтиСтроки(ПараметрыОтбора);
		Если СтрокиИзНоменклатурыКонтрагентов.Количество() Тогда
			НайденнаяСтрока = СтрокиИзНоменклатурыКонтрагентов[0];
			СтрокаТовары.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(НайденнаяСтрока,,,,СоответствиеСтавокНДСКонтрагента);
		Иначе
			СтрокаТовары.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(СтрокаТовары, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры);
		КонецЕсли;
		
		// Заполнение прослеживаемости
		ЗаполнитьСведенияОПрослеживаемостиДляКомиссии(СтрокаТовары, ПрослеживаемыеТовары, ПрослеживаемыеКомплектующие);
		// Конец заполнения прослеживаемости
		
	КонецЦикла;	
	ЗаполнитьПараметрыОбработкиОшибокВТаблицеТоваровCML(ТаблицаТоваров);
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДокумента, ТаблицаТоваров, "Товары");
	
	СтрокаТаблицаТоваров = ДеревоДокумента.Строки.Найти("Товары", "ПолныйПуть");

	Для Каждого Товар Из СтрокаТаблицаТоваров.Строки Цикл
		Покупатель = ТаблицаТоваров[Число(Товар.Значение) - 1].Контрагент;
		
		Если ЗначениеЗаполнено(Покупатель) Тогда
			СведенияОПокупателе = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(Покупатель, , РеквизитыШапки.Дата);
			ЗаполнитьДанныеУчастника(Товар, СведенияОПокупателе, "Товары.НомерСтроки.Покупатель", "Юр", РеквизитыШапки.Дата);
		КонецЕсли;
	КонецЦикла;
	
	ТаблицаЭтаповГрафикаОплаты = РезультатЗапроса[2].Выгрузить();
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДокумента, ТаблицаЭтаповГрафикаОплаты, "ГрафикОплаты");
	
	// Информация по услуге вознаграждения
	
	Услуга = РезультатЗапроса[3].Выбрать();
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Услуга.Артикул", 
			Услуга.Артикул);
			
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Услуга.Наименование", 
			Услуга.Наименование);
			
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Услуга.БазоваяЕдиницаКод", 
			Услуга.БазоваяЕдиницаКод);
			
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Услуга.БазоваяЕдиницаНаименование", 
			Услуга.БазоваяЕдиницаНаименование);
			
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Услуга.БазоваяЕдиницаНаименованиеПолное", 
			Услуга.БазоваяЕдиницаНаименованиеПолное);
			
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Услуга.БазоваяЕдиницаМеждународноеСокращение", 
			Услуга.БазоваяЕдиницаМеждународноеСокращение);
	
	// Итоги документа
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"ИтогоПоДокументу.СуммаДокумента", 
			ТаблицаТоваров.Итог("СуммаПродажи"));
			
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"ИтогоПоДокументу.ЦенаВключаетНДС", 
			РеквизитыШапки.ЦенаВключаетНДС);
			
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"ИтогоПоДокументу.СтавкаНДСВознаграждения", 
			?(РеквизитыШапки.СтавкаНДСВознаграждения = Справочники.СтавкиНДС.ПустаяСсылка(), 
													Справочники.СтавкиНДС.БезНДС, РеквизитыШапки.СтавкаНДСВознаграждения));
			
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"ИтогоПоДокументу.СуммаНДСВознаграждения", 
			РеквизитыШапки.СуммаНДСВознаграждения);

	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"ИтогоПоДокументу.СуммаВознаграждения", 
			ТаблицаТоваров.Итог("СуммаВознаграждения"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"ИтогоПоДокументу.Процент", 
			РеквизитыШапки.ПроцентВознаграждения);
	 
	Если РеквизитыШапки.СуммаДокумента < 0 Тогда
		ТекстИтоговаяСтрока = Нстр("ru = 'Всего возвращено наименований'");
	Иначе
		ТекстИтоговаяСтрока = Нстр("ru = 'Всего продано наименований'");
	КонецЕсли;
	
	ИтоговаяСтрока = ТекстИтоговаяСтрока
		+ " "
		+ ТаблицаТоваров.Количество()
		+ Нстр("ru = ', на сумму'")
		+ " "
		+ ФормированиеПечатныхФорм.ФорматСумм(РеквизитыШапки.СуммаДокумента, РеквизитыШапки.Валюта);
	
	СуммаПрописью = РаботаСКурсамиВалют.СформироватьСуммуПрописью(РеквизитыШапки.СуммаДокумента, РеквизитыШапки.Валюта);
		
	Если РеквизитыШапки.СуммаВознаграждения <> 0 Тогда
		СуммаВознаграждения = Нстр("ru = 'Сумма комиссионного вознаграждения составила'")
			+ " "
			+ ?(РеквизитыШапки.СуммаВознаграждения < 0, Нстр("ru = 'минус'") + " ", "")
			+ РаботаСКурсамиВалют.СформироватьСуммуПрописью(РеквизитыШапки.СуммаВознаграждения, РеквизитыШапки.Валюта);
	КонецЕсли;
	
	ИтоговаяСтрока = ИтоговаяСтрока + Символы.ПС + СуммаПрописью + Символы.ПС + СуммаВознаграждения;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента,
			"ИтогиПрописью",
			ИтоговаяСтрока);
			
	ЗаполнитьУИП(ДеревоДокумента, РеквизитыШапки.ИдентификаторПлатежа);
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПоОтчетуОСписанииКомиссионногоТовара.
Процедура ЗаполнитьДанныеПоОтчетуОСписанииКомиссионногоТовара(СсылкаНаОбъект, ДеревоДокумента, Отказ) Экспорт
	
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	ОтчетКомитентуОСписании.Валюта,
	|	ОтчетКомитентуОСписании.Валюта.Код КАК ВалютаКод,	
	|	ОтчетКомитентуОСписании.Дата,
	|	ОтчетКомитентуОСписании.СуммаДокумента,
	|	ОтчетКомитентуОСписании.НачалоПериода,
	|	ОтчетКомитентуОСписании.КонецПериода,
	|	ОтчетКомитентуОСписании.Организация,
	|	ОтчетКомитентуОСписании.Организация.ВалютаРегламентированногоУчета КАК ВалютаРегламентированногоУчета,
	|	ОтчетКомитентуОСписании.Контрагент
	|ИЗ
	|	Документ.ОтчетКомитентуОСписании КАК ОтчетКомитентуОСписании
	|ГДЕ
	|	ОтчетКомитентуОСписании.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Товары.НомерСтроки КАК НомерСтроки,
	|	Товары.Номенклатура.Артикул КАК Артикул,
	|	ВЫБОР
	|		КОГДА Товары.Номенклатура.НаименованиеПолное = """"
	|			ТОГДА Товары.Номенклатура.Наименование
	|		ИНАЧЕ Товары.Номенклатура.НаименованиеПолное
	|	КОНЕЦ КАК Наименование,
	|	Товары.Номенклатура КАК Номенклатура,
	|	Товары.Характеристика,
	|	Товары.Номенклатура.ЕдиницаИзмерения.Код КАК БазоваяЕдиницаКод,
	|	Товары.КоличествоУпаковок КАК Количество,
	|	&ТекстЗапросаКодЕдиницыИзмерения КАК ЕдиницаИзмеренияКодПоОКЕИ,
	|	&ТекстЗапросаНаименованиеЕдиницыИзмерения КАК ЕдиницаИзмеренияНаименование,
	|	ВЫБОР
	|		КОГДА Товары.Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
	|			ТОГДА 1
	|		ИНАЧЕ &ТекстЗапросаКоэффициентУпаковки
	|	КОНЕЦ КАК ЕдиницаИзмеренияКоэффициент,
	|	Товары.Ссылка.ЦенаВключаетНДС КАК НДСУчтеноВСумме,
	|	Товары.СтавкаНДС КАК СтавкаНДС,
	|	Товары.СуммаНДС КАК СуммаНДС,
	|	Товары.СуммаСНДС КАК Сумма,
	|	Товары.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,	
	|	Товары.Номенклатура.ЕдиницаИзмерения.Наименование КАК БазоваяЕдиницаНаименование,
	|	Товары.Номенклатура.ЕдиницаИзмерения.НаименованиеПолное КАК БазоваяЕдиницаНаименованиеПолное,
	|	Товары.Номенклатура.ЕдиницаИзмерения.МеждународноеСокращение КАК БазоваяЕдиницаМеждународноеСокращение,
	|	Товары.Упаковка КАК Упаковка,
	|	Товары.Цена
	|ИЗ
	|	Документ.ОтчетКомитентуОСписании.Товары КАК Товары
	|ГДЕ
	|	Товары.Ссылка = &Ссылка";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"&ТекстЗапросаКодЕдиницыИзмерения",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаЗначениеРеквизитаЕдиницыИзмерения(
			"Код",
			"Товары.Упаковка",
			"Товары.Номенклатура"));
			
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"&ТекстЗапросаНаименованиеЕдиницыИзмерения",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаЗначениеРеквизитаЕдиницыИзмерения(
			"Наименование",
			"Товары.Упаковка",
			"Товары.Номенклатура"));
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"&ТекстЗапросаКоэффициентУпаковки",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаКоэффициентаУпаковки(
			"Товары.Упаковка",
			"Товары.Номенклатура"));
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	
	ВыборкаДляСопоставления = НоменклатураПартнеровСервер.ВыборкаДляСопоставленияНоменклатуры(СсылкаНаОбъект);
	
	Запрос.УстановитьПараметр("Ссылка", СсылкаНаОбъект);
	РезультатЗапроса = Запрос.ВыполнитьПакет();
	
	РеквизитыШапки = РезультатЗапроса[0].Выбрать();
	РеквизитыШапки.Следующий();
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"ДатаФормирования", 
			ТекущаяДатаСеанса());
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Валюта", 
			РеквизитыШапки.ВалютаКод);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Курс", 
			РаботаСКурсамиВалютУТ.ПолучитьКурсВалюты(РеквизитыШапки.Валюта, РеквизитыШапки.Дата, РеквизитыШапки.ВалютаРегламентированногоУчета).КурсЧислитель);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"НачалоПериода", 
			РеквизитыШапки.НачалоПериода);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"КонецПериода", 
			РеквизитыШапки.КонецПериода);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"Сумма", 
			РеквизитыШапки.СуммаДокумента);
			
	СведенияОКомитенте = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(РеквизитыШапки.Контрагент, , РеквизитыШапки.Дата);
	ЗаполнитьДанныеУчастника(ДеревоДокумента, СведенияОКомитенте, "Комитент", "Юр", РеквизитыШапки.Дата);
	
	СведенияОКомиссионере = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(РеквизитыШапки.Организация, , РеквизитыШапки.Дата);
	ЗаполнитьДанныеУчастника(ДеревоДокумента, СведенияОКомиссионере, "Комиссионер", "Юр", РеквизитыШапки.Дата);

	ТаблицаТоваров = РезультатЗапроса[1].Выгрузить();
	ТаблицаТоваров.Колонки.Добавить("Сопоставление");
	ТаблицаТоваров.Колонки.Добавить("СведенияОПрослеживаемости");
	
	// Получение данных для заполнения прослеживаемости
	ДанныеПоПрослеживаемости = ПолучитьДанныеПоПрослеживаемостиДляКомиссии(СсылкаНаОбъект, ТипЗнч(СсылкаНаОбъект));
	ПрослеживаемыеТовары		= ДанныеПоПрослеживаемости.ПрослеживаемыеТовары;
	ПрослеживаемыеКомплектующие	= ДанныеПоПрослеживаемости.ПрослеживаемыеКомплектующие;
	
	ШтрихкодыКомбинаций = Неопределено;
	ШтрихкодыНоменклатуры = Неопределено;
	НоменклатураПартнеровСервер.ШтрихкодыПоТоварам(ТаблицаТоваров, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры);	

	СоответствиеСтавокНДСКонтрагента = Новый Соответствие;
	ЗаполнитьСоответствиеСтавокНДС(СоответствиеСтавокНДСКонтрагента);
	ТаблицаСопоставления = ВыборкаДляСопоставления.Выгрузить();
	Для Каждого СтрокаТовары Из ТаблицаТоваров Цикл
		СтрокаТовары.БазоваяЕдиницаКод = СокрЛП(СтрокаТовары.БазоваяЕдиницаКод);
		
		//Сопоставление
		ПараметрыОтбора = Новый Структура;
		ПараметрыОтбора.Вставить("Номенклатура", СтрокаТовары.Номенклатура);
		Если СтрокаТовары.Характеристика <> Неопределено Тогда
			ПараметрыОтбора.Вставить("Характеристика", СтрокаТовары.Характеристика);
		Иначе
			ПараметрыОтбора.Вставить("Характеристика", Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());
		КонецЕсли;
		ПараметрыОтбора.Вставить("Упаковка", СтрокаТовары.Упаковка);
		СтрокиИзНоменклатурыКонтрагентов = ТаблицаСопоставления.НайтиСтроки(ПараметрыОтбора);
		Если СтрокиИзНоменклатурыКонтрагентов.Количество() Тогда
			НайденнаяСтрока = СтрокиИзНоменклатурыКонтрагентов[0];
			СтрокаТовары.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(НайденнаяСтрока,,,,СоответствиеСтавокНДСКонтрагента);
		Иначе
			СтрокаТовары.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(СтрокаТовары, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры);
		КонецЕсли;
		
		// Заполнение прослеживаемости
		ЗаполнитьСведенияОПрослеживаемостиДляКомиссии(СтрокаТовары, ПрослеживаемыеТовары, ПрослеживаемыеКомплектующие);
		// Конец заполнения прослеживаемости
		
	КонецЦикла;
	ЗаполнитьПараметрыОбработкиОшибокВТаблицеТоваровCML(ТаблицаТоваров);
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДокумента, ТаблицаТоваров, "Товары");
	
	ИтоговаяСтрока = НСтр("ru = 'Всего списано наименований'")
		+ " "
		+ ТаблицаТоваров.Количество()
		+ ?(РеквизитыШапки.СуммаДокумента <> 0, НСтр("ru = ', на сумму'") + " ", "")
		+ ?(РеквизитыШапки.СуммаДокумента <> 0, ФормированиеПечатныхФорм.ФорматСумм(РеквизитыШапки.СуммаДокумента, РеквизитыШапки.Валюта), "");
	СуммаПрописью = РаботаСКурсамиВалютУТ.СформироватьСуммуПрописью(РеквизитыШапки.СуммаДокумента, РеквизитыШапки.Валюта);
	ИтоговаяСтрока = ИтоговаяСтрока + Символы.ПС + СуммаПрописью;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДокумента, 
			"ИтогиПрописью", 
			ИтоговаяСтрока);
			
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.СохранитьДанныеОбъектаВБД.
Процедура СохранитьДанныеОбъектаВБД(СтрокаДляЗагрузки, ДеревоРазбора, ПараметрыОбработки, ДополнительныеДанные, НайденныйОбъект) Экспорт
	
	ТипыДокументов = ОбменСКонтрагентами.ТипыДокументов();
	
	Если ТипЗнч(ПараметрыОбработки) = Тип("Структура") Тогда
		СсылкаНаВладельца 	= ПараметрыОбработки.СсылкаНаВладельца;
		Записывать 			= ПараметрыОбработки.Записывать;
		СпособОбработки 	= ПараметрыОбработки.СпособОбработки;
	КонецЕсли;
	
	Если СтрокаДляЗагрузки.ВидЭД = ТипыДокументов.ПрайсЛист Тогда		
		НайденныйОбъект = НайтиСоздатьРегистрацияЦен(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца, Записывать);
		
	ИначеЕсли СтрокаДляЗагрузки.ВидЭД = ТипыДокументов.ЗаказТовара Тогда		
		НайденныйОбъект = НайтиСоздатьЗаказКлиента(СтрокаДляЗагрузки, ДеревоРазбора, ДополнительныеДанные, СсылкаНаВладельца, Записывать);
		
	ИначеЕсли СтрокаДляЗагрузки.ВидЭД = ТипыДокументов.ОтветНаЗаказ Тогда
		НайденныйОбъект = НайтиСоздатьЗаказПоставщику(СтрокаДляЗагрузки, ДеревоРазбора, ДополнительныеДанные, СсылкаНаВладельца, Записывать);
		
	ИначеЕсли СтрокаДляЗагрузки.ВидЭД = ТипыДокументов.СчетНаОплату Тогда
		
		Если ДополнительныеДанные.Свойство("СпособОбмена") И ДополнительныеДанные.СпособОбмена = Перечисления.СпособыОбменаЭД.Через1CShare Тогда
			Если ПараметрыОбработки.Свойство("СпособОбработки") Тогда				
				Если ПараметрыОбработки.СпособОбработки = "ЗаявкаНаРасходованиеДенежныхСредств" Тогда
					НайденныйОбъект = НайтиСоздатьЗаявкуНаРасходованиеДенежныхСредств(СтрокаДляЗагрузки, ДеревоРазбора, ДополнительныеДанные, СсылкаНаВладельца, Записывать);
				ИначеЕсли ПараметрыОбработки.СпособОбработки = "ЗаказПоставщику" Тогда
					НайденныйОбъект = НайтиСоздатьЗаказПоставщику(СтрокаДляЗагрузки, ДеревоРазбора, ДополнительныеДанные, СсылкаНаВладельца, Записывать);					
				ИначеЕсли ПараметрыОбработки.СпособОбработки = "СписаниеБезналичныхДенежныхСредств" Тогда
					НайденныйОбъект = НайтиСоздатьСписаниеБезналичныхДенежныхСредств(СтрокаДляЗагрузки, ДеревоРазбора, ДополнительныеДанные, СсылкаНаВладельца, Записывать);				
				КонецЕсли;
			КонецЕсли;
		Иначе	
			НайденныйОбъект = НайтиСоздатьЗаявкуНаРасходованиеДенежныхСредств(СтрокаДляЗагрузки, ДеревоРазбора, ДополнительныеДанные, СсылкаНаВладельца, Записывать);
		КонецЕсли;
		
	ИначеЕсли СтрокаДляЗагрузки.ВидЭД = ТипыДокументов.ТоварнаяНакладная
		И СпособОбработки = "ВозвратТоваровОтКлиента" Тогда
		НайденныйОбъект = НайтиСоздатьВозвратТоваровОтПокупателя(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца, Записывать);
		
	ИначеЕсли СтрокаДляЗагрузки.ВидЭД = ТипыДокументов.ТоварнаяНакладная
		ИЛИ СтрокаДляЗагрузки.ВидЭД = ТипыДокументов.АктНаПередачуПрав Тогда
		ВидОперацииЭД = ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "ВидОперации", Истина, ДеревоРазбора);
		Если ВидОперацииЭД = Перечисления.ВидыОперацийЭД.Исправление Тогда
			НайденныйОбъект = НайтиСоздатьКорректировкуПоступления(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца, Записывать);
		Иначе
			НайденныйОбъект = НайтиСоздатьПриобретениеТоваровУслуг(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца, Записывать);
		КонецЕсли;
		
	ИначеЕсли СтрокаДляЗагрузки.ВидЭД = ТипыДокументов.СчетФактура
		ИЛИ СтрокаДляЗагрузки.ВидЭД = ТипыДокументов.КорректировочныйСчетФактура Тогда
		ВидСчетаФактуры = ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "ВидСчетаФактуры");
		Комиссионер = ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "Комиссионер");
		Если ВидСчетаФактуры = "Авансовый" Тогда
			НайденныйОбъект = НайтиСоздатьСчетФактуруАванс(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца, Записывать);
		ИначеЕсли ЗначениеЗаполнено(Комиссионер) Тогда
			НайденныйОбъект = НайтиСоздатьСчетФактуруКомитента(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца, Записывать);
		Иначе
			НайденныйОбъект = НайтиСоздатьСчетФактуру(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца, Записывать);
		КонецЕсли;
		
	ИначеЕсли СтрокаДляЗагрузки.ВидЭД = ТипыДокументов.ОтчетОПродажахКомиссионногоТовара Тогда
		НайденныйОбъект = НайтиСоздатьОтчетКомиссионера(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца, Записывать);
		
	ИначеЕсли СтрокаДляЗагрузки.ВидЭД = ТипыДокументов.ОтчетОСписанииКомиссионногоТовара Тогда
		НайденныйОбъект = НайтиСоздатьОтчетКомиссионераОСписании(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца, Записывать);
		
	ИначеЕсли СтрокаДляЗагрузки.ВидЭД = ТипыДокументов.РеквизитыОрганизации Тогда
		
		НайденныйОбъект = СоздатьНовогоКонтрагента(СтрокаДляЗагрузки, ДеревоРазбора, ПараметрыОбработки.СсылкаНаВладельца)		
		
	ИначеЕсли СтрокаДляЗагрузки.ВидЭД = ТипыДокументов.АктВыполненныхРабот 
		И СпособОбработки = "ПриобретениеТоваровУслуг" Тогда
		НайденныйОбъект = НайтиСоздатьПриобретениеТоваровУслуг(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца, Записывать);			
		
	ИначеЕсли СтрокаДляЗагрузки.ВидЭД = ТипыДокументов.АктВыполненныхРабот Тогда
		ВидОперацииЭД = ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "ВидОперации", Истина, ДеревоРазбора);
		
		Если ВидОперацииЭД = Перечисления.ВидыОперацийЭД.Исправление Тогда
			НайденныйОбъект = НайтиСоздатьКорректировкуПоступления(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца, Записывать);
		Иначе
			НайденныйОбъект = НайтиСоздатьПоступлениеУслуг(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца, Записывать);
		КонецЕсли;
		
	ИначеЕсли СтрокаДляЗагрузки.ВидЭД = ТипыДокументов.СоглашениеОбИзмененииСтоимости Тогда
		НайденныйОбъект = НайтиСоздатьКорректировкуПоступления(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца, Записывать);
	КонецЕсли;
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.СоздатьОбъектВБД.
Процедура СоздатьОбъектВБД(СтрокаОбъекта, ДеревоРазбора, НовыйЭлемент) Экспорт
	
	НовыйЭлемент = Неопределено;
	Если СтрокаОбъекта.ОписаниеТипа = "СправочникСсылка.НоменклатураКонтрагентов" Тогда
		НовыйЭлемент = СоздатьПерезаполнитьНоменклатуруПоставщика(СтрокаОбъекта, ДеревоРазбора);
	ИначеЕсли СтрокаОбъекта.ОписаниеТипа = "СправочникСсылка.БанковскиеСчетаКонтрагентов" Тогда
		НовыйЭлемент = СоздатьРасчетныйСчет(СтрокаОбъекта,"БанковскийСчетКонтрагента", ДеревоРазбора);
	КонецЕсли;
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьТаблицуПорядкаСозданияТиповОбъектов.
Процедура ЗаполнитьТаблицуПорядкаСозданияТиповОбъектов(Таблица) Экспорт
	
	// БанковскиеСчетаКонтрагентов
	НовСтрока = Таблица.Добавить();
	НовСтрока.ТипОбъекта 	= "БанковскиеСчетаКонтрагентов";
	НовСтрока.Порядок 		= 1;
	// Номенклатура партнера
	НовСтрока = Таблица.Добавить();
	НовСтрока.ТипОбъекта 	= "НоменклатураКонтрагентов";
	НовСтрока.Порядок 		= 2;
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ПодготовитьДанныеПоПередачеТоваровМеждуОрганизациями.
Процедура ПодготовитьДанныеПоПередачеТоваровМеждуОрганизациями(СсылкаНаОбъект, ДеревоЭД, Отказ) Экспорт

	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	ВложенныйЗапрос.Ссылка,
	|	ВложенныйЗапрос.Номенклатура,
	|	ВложенныйЗапрос.Характеристика,
	|	ВложенныйЗапрос.УпаковкаКод,
	|	ВложенныйЗапрос.УпаковкаНаименование,
	|	ВложенныйЗапрос.Коэффициент,
	|	ВложенныйЗапрос.СтавкаНДС,
	|	ВложенныйЗапрос.Цена,
	|	ВложенныйЗапрос.Количество,
	|	ВложенныйЗапрос.КоличествоМест,
	|	ВложенныйЗапрос.Сумма,
	|	ВложенныйЗапрос.СуммаНДС,
	|	ВложенныйЗапрос.НомерСтроки,
	|	ВложенныйЗапрос.Артикул,
	|	ВложенныйЗапрос.СуммаСНДС,
	|	ВложенныйЗапрос.Номенклатура.Наименование КАК Наименование,
	|	ВложенныйЗапрос.Номенклатура.ЕдиницаИзмерения.Код КАК БазоваяЕдиницаКод,
	|	ВложенныйЗапрос.Номенклатура.ЕдиницаИзмерения.Наименование КАК БазоваяЕдиницаНаименование,
	|	ВложенныйЗапрос.Номенклатура.ЕдиницаИзмерения.НаименованиеПолное КАК БазоваяЕдиницаНаименованиеПолное,
	|	ВложенныйЗапрос.Номенклатура.ЕдиницаИзмерения.МеждународноеСокращение КАК БазоваяЕдиницаМеждународноеСокращение,
	|	ВложенныйЗапрос.Упаковка,
	|	ВложенныйЗапрос.Ид КАК Ид
	|ИЗ
	|	(ВЫБРАТЬ
	|		ТаблицаТовары.Ссылка КАК Ссылка,
	|		ТаблицаТовары.Номенклатура КАК Номенклатура,
	|		ТаблицаТовары.Характеристика КАК Характеристика,
	|		&ТекстЗапросаКодЕдиницыИзмерения КАК УпаковкаКод,
	|		&ТекстЗапросаНаименованиеЕдиницыИзмерения КАК УпаковкаНаименование,
	|		ВЫБОР
	|			КОГДА ТаблицаТовары.Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
	|				ТОГДА 1
	|			ИНАЧЕ &ТекстЗапросаКоэффициентУпаковки
	|		КОНЕЦ КАК Коэффициент,
	|		ТаблицаТовары.СтавкаНДС КАК СтавкаНДС,
	|		ТаблицаТовары.Цена КАК Цена,
	|		ТаблицаТовары.КоличествоУпаковок КАК Количество,
	|		ТаблицаТовары.КоличествоУпаковок КАК КоличествоМест,
	|		ТаблицаТовары.Сумма КАК Сумма,
	|		ТаблицаТовары.СуммаНДС КАК СуммаНДС,
	|		ТаблицаТовары.НомерСтроки КАК НомерСтроки,
	|		ТаблицаТовары.Номенклатура.Артикул КАК Артикул,
	|		ТаблицаТовары.СуммаСНДС КАК СуммаСНДС,
	|		ТаблицаТовары.Упаковка КАК Упаковка,
	|		ВЫРАЗИТЬ("""" КАК СТРОКА(110)) КАК Ид
	|	ИЗ
	|		Документ.ПередачаТоваровМеждуОрганизациями.Товары КАК ТаблицаТовары
	|	ГДЕ
	|		ТаблицаТовары.Ссылка = &Ссылка
	|		И ТаблицаТовары.Ссылка.Проведен) КАК ВложенныйЗапрос
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДанныеДокумента.Ссылка КАК Ссылка,
	|	ДанныеДокумента.Номер КАК Номер,
	|	ДанныеДокумента.Дата КАК Дата,
	|	ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие) КАК Партнер,
	|	ДанныеДокумента.ОрганизацияПолучатель КАК Контрагент,
	|	ДанныеДокумента.Организация КАК Организация,
	|	ВЫБОР
	|		КОГДА ДанныеДокумента.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ДанныеДокумента.ОрганизацияПолучатель
	|		ИНАЧЕ ДанныеДокумента.Грузополучатель
	|	КОНЕЦ КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА ДанныеДокумента.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ДанныеДокумента.Организация
	|		ИНАЧЕ ДанныеДокумента.Грузоотправитель
	|	КОНЕЦ КАК Грузоотправитель,
	|	ДанныеДокумента.БанковскийСчетОрганизации КАК БанковскийСчетОрганизации,
	|	ДанныеДокумента.БанковскийСчетОрганизацииПолучателя КАК БанковскийСчетКонтрагента,
	|	ДанныеДокумента.БанковскийСчетГрузоотправителя КАК БанковскийСчетГрузоотправителя,
	|	ДанныеДокумента.БанковскийСчетГрузополучателя КАК БанковскийСчетГрузополучателя,
	|	ДанныеДокумента.АдресДоставки КАК АдресДоставки,
	|	ДанныеДокумента.Валюта КАК Валюта,
	|	ДанныеДокумента.ИдентификаторПлатежа КАК ИдентификаторПлатежа,
	|	ДанныеДокумента.ЦенаВключаетНДС КАК ЦенаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ДанныеДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаНаКомиссиюВДругуюОрганизацию)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЭтоПередачаНаКомиссию,
	|	ДанныеДокумента.СуммаДокумента,
	|	ДанныеДокумента.НалогообложениеНДС КАК НалогообложениеНДС
	|ИЗ
	|	Документ.ПередачаТоваровМеждуОрганизациями КАК ДанныеДокумента
	|ГДЕ
	|	ДанныеДокумента.Ссылка = &Ссылка
	|	И НЕ ДанныеДокумента.РасчетыЧерезОтдельногоКонтрагента
	|	И ДанныеДокумента.Проведен
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДанныеДокумента.Ссылка,
	|	ДанныеДокумента.НомерВходящегоДокумента,
	|	ДанныеДокумента.ДатаВходящегоДокумента,
	|	ДанныеДокумента.Партнер,
	|	ДанныеДокумента.ОрганизацияПолучатель,
	|	ДанныеДокумента.Контрагент,
	|	ВЫБОР
	|		КОГДА ДанныеДокумента.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ДанныеДокумента.ОрганизацияПолучатель
	|		ИНАЧЕ ДанныеДокумента.Грузополучатель
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ДанныеДокумента.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ДанныеДокумента.Контрагент
	|		ИНАЧЕ ДанныеДокумента.Грузоотправитель
	|	КОНЕЦ,
	|	ДанныеДокумента.БанковскийСчетКонтрагента,
	|	ДанныеДокумента.БанковскийСчетОрганизацииПолучателя,
	|	ДанныеДокумента.БанковскийСчетГрузоотправителя,
	|	ДанныеДокумента.БанковскийСчетГрузополучателя,
	|	ДанныеДокумента.АдресДоставки,
	|	ДанныеДокумента.Валюта,
	|	ДанныеДокумента.ИдентификаторПлатежа,
	|	ДанныеДокумента.ЦенаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ДанныеДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаНаКомиссиюВДругуюОрганизацию)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ДанныеДокумента.СуммаДокумента,
	|	ДанныеДокумента.НалогообложениеНДС
	|ИЗ
	|	Документ.ПередачаТоваровМеждуОрганизациями КАК ДанныеДокумента
	|ГДЕ
	|	ДанныеДокумента.Ссылка = &Ссылка
	|	И ДанныеДокумента.РасчетыЧерезОтдельногоКонтрагента
	|	И ДанныеДокумента.ОрганизацияПолучатель <> ЗНАЧЕНИЕ(Справочник.Организации.УправленческаяОрганизация)
	|	И ДанныеДокумента.Проведен
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДанныеДокумента.Ссылка,
	|	ДанныеДокумента.Номер,
	|	ДанныеДокумента.Дата,
	|	ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие),
	|	ДанныеДокумента.Контрагент,
	|	ДанныеДокумента.Организация,
	|	ВЫБОР
	|		КОГДА ДанныеДокумента.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ДанныеДокумента.Контрагент
	|		ИНАЧЕ ДанныеДокумента.Грузополучатель
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ДанныеДокумента.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ДанныеДокумента.Организация
	|		ИНАЧЕ ДанныеДокумента.Грузоотправитель
	|	КОНЕЦ,
	|	ДанныеДокумента.БанковскийСчетОрганизации,
	|	ДанныеДокумента.БанковскийСчетОрганизацииПолучателя,
	|	ДанныеДокумента.БанковскийСчетГрузоотправителя,
	|	ДанныеДокумента.БанковскийСчетГрузополучателя,
	|	ДанныеДокумента.АдресДоставки,
	|	ДанныеДокумента.Валюта,
	|	ДанныеДокумента.ИдентификаторПлатежа,
	|	ДанныеДокумента.ЦенаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ДанныеДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаНаКомиссиюВДругуюОрганизацию)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ДанныеДокумента.СуммаДокумента,
	|	ДанныеДокумента.НалогообложениеНДС
	|ИЗ
	|	Документ.ПередачаТоваровМеждуОрганизациями КАК ДанныеДокумента
	|ГДЕ
	|	ДанныеДокумента.Ссылка = &Ссылка
	|	И ДанныеДокумента.РасчетыЧерезОтдельногоКонтрагента
	|	И ДанныеДокумента.Организация <> ЗНАЧЕНИЕ(Справочник.Организации.УправленческаяОрганизация)
	|	И ДанныеДокумента.Проведен
	|
	|УПОРЯДОЧИТЬ ПО
	|	Ссылка";

	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"&ТекстЗапросаКоэффициентУпаковки",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаКоэффициентаУпаковки(
			"ТаблицаТовары.Упаковка",
			"ТаблицаТовары.Номенклатура"));
			
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"&ТекстЗапросаНаименованиеЕдиницыИзмерения",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаЗначениеРеквизитаЕдиницыИзмерения(
			"Наименование",
			"ТаблицаТовары.Упаковка",
			"ТаблицаТовары.Номенклатура"));
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"&ТекстЗапросаКодЕдиницыИзмерения",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаЗначениеРеквизитаЕдиницыИзмерения(
			"Код",
			"ТаблицаТовары.Упаковка",
			"ТаблицаТовары.Номенклатура"));
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("Ссылка", СсылкаНаОбъект);
	РезультатЗапроса = Запрос.ВыполнитьПакет();
	
	ТаблицаТоваров = РезультатЗапроса[0].Выгрузить();
	ОбработатьТаблицуТоваров(ТаблицаТоваров);

	РеквизитыШапки = РезультатЗапроса[1].Выбрать();
	РеквизитыШапки.Следующий();
	
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(
		ТаблицаТоваров, "Наименование",,, НСтр("ru = 'Не указано наименование товара в табличной части'"));
	
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(
		ТаблицаТоваров, "БазоваяЕдиницаКод",,, НСтр("ru = 'Не заполнен код единицы измерения в справочнике ""Упаковки и единицы измерения"".'"));
		
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоЭД, ТаблицаТоваров, "Товары");
		
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоЭД, "Сумма",               РеквизитыШапки.СуммаДокумента);	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоЭД, "ЦенаВключаетНДС",     РеквизитыШапки.ЦенаВключаетНДС);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоЭД, "Организация",         РеквизитыШапки.Организация);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоЭД, "Контрагент",          РеквизитыШапки.Контрагент);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоЭД, "Грузоотправитель",    ?(ЗначениеЗаполнено(РеквизитыШапки.Грузоотправитель), 
														  										 РеквизитыШапки.Грузоотправитель, РеквизитыШапки.Организация));
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоЭД, "Грузополучатель",     ?(ЗначениеЗаполнено(РеквизитыШапки.Грузополучатель),
														  										 РеквизитыШапки.Грузополучатель, РеквизитыШапки.Контрагент));
	                                                      

КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ПодготовитьДанныеПоВозвратуТоваровМеждуОрганизациями.
Процедура ПодготовитьДанныеПоВозвратуТоваровМеждуОрганизациями(СсылкаНаОбъект, ДеревоЭД, Отказ) Экспорт

	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	ВложенныйЗапрос.Ссылка,
	|	ВложенныйЗапрос.Номенклатура,
	|	ВложенныйЗапрос.Характеристика,
	|	ВложенныйЗапрос.УпаковкаКод,
	|	ВложенныйЗапрос.УпаковкаНаименование,
	|	ВложенныйЗапрос.Коэффициент,
	|	ВложенныйЗапрос.СтавкаНДС,
	|	ВложенныйЗапрос.Цена,
	|	ВложенныйЗапрос.Количество,
	|	ВложенныйЗапрос.КоличествоМест,
	|	ВложенныйЗапрос.Сумма,
	|	ВложенныйЗапрос.СуммаНДС,
	|	ВложенныйЗапрос.НомерСтроки,
	|	ВложенныйЗапрос.Артикул,
	|	ВложенныйЗапрос.СуммаСНДС,
	|	ВложенныйЗапрос.Номенклатура.Наименование КАК Наименование,
	|	ВложенныйЗапрос.Номенклатура.ЕдиницаИзмерения.Код КАК БазоваяЕдиницаКод,
	|	ВложенныйЗапрос.Номенклатура.ЕдиницаИзмерения.Наименование КАК БазоваяЕдиницаНаименование,
	|	ВложенныйЗапрос.Номенклатура.ЕдиницаИзмерения.НаименованиеПолное КАК БазоваяЕдиницаНаименованиеПолное,
	|	ВложенныйЗапрос.Номенклатура.ЕдиницаИзмерения.МеждународноеСокращение КАК БазоваяЕдиницаМеждународноеСокращение,
	|	ВложенныйЗапрос.Ид КАК Ид,
	|	ВложенныйЗапрос.Упаковка
	|ИЗ
	|	(ВЫБРАТЬ
	|		ТаблицаТовары.Ссылка КАК Ссылка,
	|		ТаблицаТовары.Номенклатура КАК Номенклатура,
	|		ТаблицаТовары.Характеристика КАК Характеристика,
	|		ТаблицаТовары.СтавкаНДС КАК СтавкаНДС,
	|		&ТекстЗапросаКодЕдиницыИзмерения КАК УпаковкаКод,
	|		&ТекстЗапросаНаименованиеЕдиницыИзмерения КАК УпаковкаНаименование,
	|		ВЫБОР
	|			КОГДА ТаблицаТовары.Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
	|				ТОГДА 1
	|			ИНАЧЕ &ТекстЗапросаКоэффициентУпаковки
	|		КОНЕЦ КАК Коэффициент,
	|		ВЫБОР
	|			КОГДА ТаблицаТовары.КоличествоУпаковок = 0
	|				ТОГДА ТаблицаТовары.Цена
	|			ИНАЧЕ ТаблицаТовары.Сумма / ТаблицаТовары.КоличествоУпаковок
	|		КОНЕЦ КАК Цена,
	|		ТаблицаТовары.КоличествоУпаковок КАК Количество,
	|		ТаблицаТовары.КоличествоУпаковок КАК КоличествоМест,
	|		ТаблицаТовары.Сумма КАК Сумма,
	|		ТаблицаТовары.СуммаНДС КАК СуммаНДС,
	|		ТаблицаТовары.НомерСтроки КАК НомерСтроки,
	|		ТаблицаТовары.Номенклатура.Артикул КАК Артикул,
	|		ТаблицаТовары.СуммаСНДС КАК СуммаСНДС,
	|		ВЫРАЗИТЬ("""" КАК СТРОКА(110)) КАК Ид,
	|		ТаблицаТовары.Упаковка КАК Упаковка
	|	ИЗ
	|		Документ.ВозвратТоваровМеждуОрганизациями.Товары КАК ТаблицаТовары
	|	ГДЕ
	|		ТаблицаТовары.Ссылка = &Ссылка
	|		И ТаблицаТовары.Ссылка.Проведен) КАК ВложенныйЗапрос
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДанныеДокумента.Ссылка КАК Ссылка,
	|	ДанныеДокумента.Номер КАК Номер,
	|	ДанныеДокумента.Дата КАК Дата,
	|	ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие) КАК Партнер,
	|	ДанныеДокумента.ОрганизацияПолучатель КАК Контрагент,
	|	ДанныеДокумента.Организация КАК Организация,
	|	ВЫБОР
	|		КОГДА ДанныеДокумента.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ДанныеДокумента.ОрганизацияПолучатель
	|		ИНАЧЕ ДанныеДокумента.Грузополучатель
	|	КОНЕЦ КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА ДанныеДокумента.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ДанныеДокумента.Организация
	|		ИНАЧЕ ДанныеДокумента.Грузоотправитель
	|	КОНЕЦ КАК Грузоотправитель,
	|	ДанныеДокумента.БанковскийСчетОрганизации КАК БанковскийСчетОрганизации,
	|	ДанныеДокумента.БанковскийСчетОрганизацииПолучателя КАК БанковскийСчетКонтрагента,
	|	ДанныеДокумента.БанковскийСчетГрузоотправителя КАК БанковскийСчетГрузоотправителя,
	|	ДанныеДокумента.БанковскийСчетГрузополучателя КАК БанковскийСчетГрузополучателя,
	|	ДанныеДокумента.АдресДоставки КАК АдресДоставки,
	|	ДанныеДокумента.Валюта КАК Валюта,
	|	ДанныеДокумента.ЦенаВключаетНДС КАК ЦенаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ДанныеДокумента.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровМеждуОрганизациями)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЭтоПередачаНаКомиссию,
	|	ДанныеДокумента.СуммаДокумента КАК СуммаДокумента,
	|	ДанныеДокумента.НалогообложениеНДС КАК НалогообложениеНДС
	|ИЗ
	|	Документ.ВозвратТоваровМеждуОрганизациями КАК ДанныеДокумента
	|ГДЕ
	|	ДанныеДокумента.Ссылка = &Ссылка
	|	И ДанныеДокумента.Проведен
	|	И НЕ ДанныеДокумента.РасчетыЧерезОтдельногоКонтрагента
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДанныеДокумента.Ссылка,
	|	ДанныеДокумента.НомерВходящегоДокумента,
	|	ДанныеДокумента.ДатаВходящегоДокумента,
	|	ДанныеДокумента.Партнер,
	|	ДанныеДокумента.ОрганизацияПолучатель,
	|	ДанныеДокумента.Контрагент,
	|	ВЫБОР
	|		КОГДА ДанныеДокумента.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ДанныеДокумента.ОрганизацияПолучатель
	|		ИНАЧЕ ДанныеДокумента.Грузополучатель
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ДанныеДокумента.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ДанныеДокумента.Контрагент
	|		ИНАЧЕ ДанныеДокумента.Грузоотправитель
	|	КОНЕЦ,
	|	ДанныеДокумента.БанковскийСчетКонтрагента,
	|	ДанныеДокумента.БанковскийСчетОрганизацииПолучателя,
	|	ДанныеДокумента.БанковскийСчетГрузоотправителя,
	|	ДанныеДокумента.БанковскийСчетГрузополучателя,
	|	ДанныеДокумента.АдресДоставки,
	|	ДанныеДокумента.Валюта,
	|	ДанныеДокумента.ЦенаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ДанныеДокумента.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровМеждуОрганизациями)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ДанныеДокумента.СуммаДокумента,
	|	ДанныеДокумента.НалогообложениеНДС
	|ИЗ
	|	Документ.ВозвратТоваровМеждуОрганизациями КАК ДанныеДокумента
	|ГДЕ
	|	ДанныеДокумента.Ссылка = &Ссылка
	|	И ДанныеДокумента.Проведен
	|	И ДанныеДокумента.РасчетыЧерезОтдельногоКонтрагента
	|	И ДанныеДокумента.ОрганизацияПолучатель <> ЗНАЧЕНИЕ(Справочник.Организации.УправленческаяОрганизация)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДанныеДокумента.Ссылка,
	|	ДанныеДокумента.Номер,
	|	ДанныеДокумента.Дата,
	|	ДанныеДокумента.Партнер,
	|	ДанныеДокумента.Контрагент,
	|	ДанныеДокумента.Организация,
	|	ВЫБОР
	|		КОГДА ДанныеДокумента.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ДанныеДокумента.Контрагент
	|		ИНАЧЕ ДанныеДокумента.Грузополучатель
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ДанныеДокумента.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ДанныеДокумента.Организация
	|		ИНАЧЕ ДанныеДокумента.Грузоотправитель
	|	КОНЕЦ,
	|	ДанныеДокумента.БанковскийСчетОрганизации,
	|	ДанныеДокумента.БанковскийСчетКонтрагента,
	|	ДанныеДокумента.БанковскийСчетГрузоотправителя,
	|	ДанныеДокумента.БанковскийСчетГрузополучателя,
	|	ДанныеДокумента.АдресДоставки,
	|	ДанныеДокумента.Валюта,
	|	ДанныеДокумента.ЦенаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ДанныеДокумента.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровМеждуОрганизациями)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ДанныеДокумента.СуммаДокумента,
	|	ДанныеДокумента.НалогообложениеНДС
	|ИЗ
	|	Документ.ВозвратТоваровМеждуОрганизациями КАК ДанныеДокумента
	|ГДЕ
	|	ДанныеДокумента.Ссылка = &Ссылка
	|	И ДанныеДокумента.Проведен
	|	И ДанныеДокумента.РасчетыЧерезОтдельногоКонтрагента
	|	И ДанныеДокумента.Организация <> ЗНАЧЕНИЕ(Справочник.Организации.УправленческаяОрганизация)
	|
	|УПОРЯДОЧИТЬ ПО
	|	Ссылка";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"&ТекстЗапросаКоэффициентУпаковки",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаКоэффициентаУпаковки(
			"ТаблицаТовары.Упаковка",
			"ТаблицаТовары.Номенклатура"));
			
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"&ТекстЗапросаНаименованиеЕдиницыИзмерения",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаЗначениеРеквизитаЕдиницыИзмерения(
			"Наименование",
			"ТаблицаТовары.Упаковка",
			"ТаблицаТовары.Номенклатура"));
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"&ТекстЗапросаКодЕдиницыИзмерения",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаЗначениеРеквизитаЕдиницыИзмерения(
			"Код",
			"ТаблицаТовары.Упаковка",
			"ТаблицаТовары.Номенклатура"));
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("Ссылка", СсылкаНаОбъект);
	РезультатЗапроса = Запрос.ВыполнитьПакет();
	
	ТаблицаТоваров = РезультатЗапроса[0].Выгрузить();
	РеквизитыШапки = РезультатЗапроса[1].Выбрать();
	РеквизитыШапки.Следующий();
	
	ОбработатьТаблицуТоваров(ТаблицаТоваров);
	
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(
		ТаблицаТоваров, "Наименование",,, НСтр("ru = 'Не указано наименование товара в табличной части'"));
	
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(
		ТаблицаТоваров, "БазоваяЕдиницаКод",,, НСтр("ru = 'Не заполнен код единицы измерения в справочнике ""Упаковки и единицы измерения"".'"));
		
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоЭД, ТаблицаТоваров, "Товары");
		
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоЭД, "Сумма",               РеквизитыШапки.СуммаДокумента);	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоЭД, "ЦенаВключаетНДС",     РеквизитыШапки.ЦенаВключаетНДС);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоЭД, "Организация",         РеквизитыШапки.Организация);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоЭД, "Контрагент",          РеквизитыШапки.Контрагент);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоЭД, "Грузоотправитель",    ?(ЗначениеЗаполнено(РеквизитыШапки.Грузоотправитель), 
														  										 РеквизитыШапки.Грузоотправитель, РеквизитыШапки.Организация));
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоЭД, "Грузополучатель",     ?(ЗначениеЗаполнено(РеквизитыШапки.Грузополучатель),
														  										 РеквизитыШапки.Грузополучатель, РеквизитыШапки.Контрагент));

КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.СпособыОтраженияВУчетеТипаЭлектронногоДокумента.
Процедура СпособыОтраженияВУчетеТипаЭлектронногоДокумента(ТипДокумента, СписокСпособовОбработки) Экспорт 
	
	ТипыДокументов = ОбменСКонтрагентами.ТипыДокументов();
	
	Если ТипДокумента = ТипыДокументов.АктВыполненныхРабот Тогда
		СписокСпособовОбработки.Добавить("ПриобретениеУслугПрочихАктивов", НСтр("ru = 'Приобретение услуг и прочих активов'"), Истина);
		СписокСпособовОбработки.Добавить("ПриобретениеТоваровУслуг", НСтр("ru = 'Приобретение товаров и услуг'"));
		СписокСпособовОбработки.Добавить("КорректировкаПриобретения", НСтр("ru = 'Корректировка приобретения'"));
		Если ПолучитьФункциональнуюОпцию("ИспользоватьКомиссиюПриПродажах") Тогда
			СписокСпособовОбработки.Добавить("ОтчетКомиссионера", НСтр("ru = 'Отчет комиссионера (агента) о продажах'"));
		КонецЕсли;
	ИначеЕсли ТипДокумента = ТипыДокументов.ТоварнаяНакладная Тогда
		СписокСпособовОбработки.Добавить("ПриобретениеТоваровУслуг", НСтр("ru = 'Приобретение товаров и услуг'"), Истина);
		СписокСпособовОбработки.Добавить("ПриобретениеУслугПрочихАктивов", НСтр("ru = 'Приобретение услуг и прочих активов'"));		
		СписокСпособовОбработки.Добавить("ВозвратТоваровОтКлиента", НСтр("ru = 'Возврат товаров от клиента'"));
		СписокСпособовОбработки.Добавить("КорректировкаПриобретения", НСтр("ru = 'Корректировка приобретения'"));
		СписокСпособовОбработки.Добавить("ПередачаТоваровМеждуОрганизациями", НСтр("ru = 'Передача товаров между организациями'"));
		СписокСпособовОбработки.Добавить("ВозвратТоваровМеждуОрганизациями", НСтр("ru = 'Возврат товаров между организациями'"));
	ИначеЕсли ТипДокумента = ТипыДокументов.СоглашениеОбИзмененииСтоимости Тогда
		СписокСпособовОбработки.Добавить("КорректировкаПриобретения", НСтр("ru = 'Корректировка приобретения'"), Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.АктНаПередачуПрав Тогда
		СписокСпособовОбработки.Добавить("ПриобретениеТоваровУслуг", НСтр("ru = 'Акт на передачу прав'"), Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.ПрайсЛист Тогда
		СписокСпособовОбработки.Добавить("РегистрацияЦенНоменклатурыПоставщика", НСтр("ru = 'Регистрация цен номенклатуры поставщика'"), Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.ОтветНаЗаказ Тогда
		СписокСпособовОбработки.Добавить("ЗаказПоставщику", НСтр("ru = 'Заказ поставщику'"), Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.ПередачаТоваровМеждуОрганизациями Тогда	
		СписокСпособовОбработки.Добавить("ПередачаТоваровМеждуОрганизациями", НСтр("ru = 'Передача товаров между организациями'"), Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.ЗаказТовара Тогда
		СписокСпособовОбработки.Добавить("ЗаказКлиента", НСтр("ru = 'Заказ клиента'"),Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.КорректировочныйСчетФактура Тогда
		СписокСпособовОбработки.Добавить("СчетФактураПолученный", НСтр("ru = 'Счет-фактура полученный'"),Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.СчетФактура Тогда
		СписокСпособовОбработки.Добавить("СчетФактураПолученный", НСтр("ru = 'Счет-фактура полученный'"), Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.СчетНаОплату Тогда
		Если ПолучитьФункциональнуюОпцию("ИспользоватьЗаказыПоставщикам") Тогда
			СписокСпособовОбработки.Добавить("ЗаказПоставщику", НСтр("ru = 'Заказ поставщику'"));
		КонецЕсли;
		Если ПолучитьФункциональнуюОпцию("ИспользоватьЗаявкиНаРасходованиеДенежныхСредств") Тогда
			СписокСпособовОбработки.Добавить("ЗаявкаНаРасходованиеДенежныхСредств", НСтр("ru = 'Заявка на расходование денежных средств'"), Истина);
		КонецЕсли;
		СписокСпособовОбработки.Добавить("РасходныйКассовыйОрдер", НСтр("ru = 'Расходный кассовый ордер'"));
		СписокСпособовОбработки.Добавить("СписаниеБезналичныхДенежныхСредств", НСтр("ru = 'Списание безналичных денежных средств'"));
	ИначеЕсли ТипДокумента = ТипыДокументов.ОтчетОПродажахКомиссионногоТовара Тогда
		СписокСпособовОбработки.Добавить("ОтчетКомиссионера", НСтр("ru = 'Отчет комиссионера (агента) о продажах'"), Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.ОтчетОСписанииКомиссионногоТовара Тогда
		СписокСпособовОбработки.Добавить("ОтчетКомиссионераОСписании", НСтр("ru = 'Отчет комиссионера о списании'"), Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.АктОРасхождениях Тогда
		СписокСпособовОбработки.Добавить("АктОРасхожденияхПослеОтгрузки", НСтр("ru = 'Акт о расхождениях после реализации'"), Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.КаталогТоваров Тогда
		СписокСпособовОбработки.Добавить("НоменклатураПоставщиков", НСтр("ru = 'Номенклатура поставщиков'"), Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.СведенияОРеализацииКомиссионером Тогда
		СписокСпособовОбработки.Добавить("РеализацияТоваровУслуг", НСтр("ru = 'Реализация товаров и услуг'"), Истина);
		СписокСпособовОбработки.Добавить("ОтчетКомиссионера", НСтр("ru = 'Отчет комиссионера (агента) о продажах'"), Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.СведенияОЗакупкеКомиссионером Тогда
		СписокСпособовОбработки.Добавить("ПриобретениеТоваровУслуг", НСтр("ru = 'Приобретение товаров и услуг'"), Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.АктСверкиВзаиморасчетов Тогда
		СписокСпособовОбработки.Добавить("СверкаВзаиморасчетов2_5_11", НСтр("ru = 'Сверка взаиморасчетов (2.5.11)'"), Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.ДоговорныйДокумент Тогда	
		СписокСпособовОбработки.Добавить("ДоговорыКонтрагентов", НСтр("ru = 'Договор'"), Истина);
	КонецЕсли;
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.СписокВидовИсходящихДокументов.
Процедура СписокВидовИсходящихДокументов(ТипДокумента, СписокСпособовОбработки) Экспорт
	
	ТипыДокументов = ОбменСКонтрагентами.ТипыДокументов();
	
	Если ТипДокумента = ТипыДокументов.АктВыполненныхРабот Тогда
		СписокСпособовОбработки.Добавить("РеализацияТоваровУслуг", НСтр("ru = 'Реализация товаров и услуг'"), Истина);
		СписокСпособовОбработки.Добавить("РеализацияУслугПрочихАктивов", НСтр("ru = 'Реализация услуг и прочих активов'"), Истина);
		СписокСпособовОбработки.Добавить("КорректировкаРеализации", НСтр("ru = 'Корректировка реализации'"), Истина);
		Если ПолучитьФункциональнуюОпцию("ИспользоватьКомиссиюПриПродажах") Тогда
			СписокСпособовОбработки.Добавить("ОтчетКомитенту", НСтр("ru = 'Отчет комитенту о продажах'"));
		КонецЕсли;
	ИначеЕсли ТипДокумента = ТипыДокументов.ТоварнаяНакладная Тогда
		СписокСпособовОбработки.Добавить("РеализацияТоваровУслуг", НСтр("ru = 'Реализация товаров и услуг'"), Истина);
		СписокСпособовОбработки.Добавить("РеализацияУслугПрочихАктивов", НСтр("ru = 'Реализация услуг и прочих активов'"), Истина);
		СписокСпособовОбработки.Добавить("ВозвратТоваровПоставщику", НСтр("ru = 'Возврат товаров поставщику'"), Истина);
		СписокСпособовОбработки.Добавить("КорректировкаРеализации", НСтр("ru = 'Корректировка реализации'"), Истина);
		СписокСпособовОбработки.Добавить("ПередачаТоваровМеждуОрганизациями", НСтр("ru = 'Передача товаров между организациями'"));
		СписокСпособовОбработки.Добавить("ВозвратТоваровМеждуОрганизациями", НСтр("ru = 'Возврат товаров между организациями'"));
	ИначеЕсли ТипДокумента = ТипыДокументов.СоглашениеОбИзмененииСтоимости Тогда
		СписокСпособовОбработки.Добавить("КорректировкаРеализации", НСтр("ru = 'Корректировка реализации'"), Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.АктНаПередачуПрав Тогда
		СписокСпособовОбработки.Добавить("РеализацияТоваровУслуг", НСтр("ru = 'Акт на передачу прав'"), Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.ПрайсЛист Тогда
		СписокСпособовОбработки.Добавить("КоммерческоеПредложениеКлиенту", НСтр("ru = 'Коммерческое предложение клиенту'"), Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.ОтветНаЗаказ Тогда
		СписокСпособовОбработки.Добавить("ЗаказКлиента", НСтр("ru = 'Заказ клиента'"),Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.ПередачаТоваровМеждуОрганизациями Тогда	
		СписокСпособовОбработки.Добавить("ВозвратТоваровМеждуОрганизациями", НСтр("ru = 'Возврат товаров между организациями'"));
	ИначеЕсли ТипДокумента = ТипыДокументов.ЗаказТовара Тогда
		СписокСпособовОбработки.Добавить("ЗаказПоставщику", НСтр("ru = 'Заказ поставщику'"), Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.КорректировочныйСчетФактура Тогда
		СписокСпособовОбработки.Добавить("СчетФактураВыданный", НСтр("ru = 'Счет-фактура выданный'"),Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.СчетФактура Тогда
		СписокСпособовОбработки.Добавить("СчетФактураВыданный", НСтр("ru = 'Счет-фактура выданный'"), Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.СчетНаОплату Тогда
		Если ПолучитьФункциональнуюОпцию("ИспользоватьЗаказыКлиентов") Тогда
			СписокСпособовОбработки.Добавить("ЗаказКлиента", НСтр("ru = 'Заказ клиента'"),Истина);
		КонецЕсли;
		СписокСпособовОбработки.Добавить("СчетНаОплатуКлиенту", НСтр("ru = 'Счет на оплату клиенту'"));
	ИначеЕсли ТипДокумента = ТипыДокументов.ОтчетОПродажахКомиссионногоТовара Тогда
		СписокСпособовОбработки.Добавить("ОтчетКомитенту", НСтр("ru = 'Отчет комитенту о продажах'"), Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.ОтчетОСписанииКомиссионногоТовара Тогда
		СписокСпособовОбработки.Добавить("ОтчетКомитенту", НСтр("ru = 'Отчет комитенту о списании'"), Истина);	
	ИначеЕсли ТипДокумента = ТипыДокументов.АктОРасхождениях Тогда
		СписокСпособовОбработки.Добавить("АктОРасхожденияхПослеПриемки", НСтр("ru = 'Акт о расхождениях после приемки'"), Истина);	
	ИначеЕсли ТипДокумента = ТипыДокументов.СведенияОРеализацииКомиссионером Тогда
		СписокСпособовОбработки.Добавить("ПриобретениеТоваровУслуг", НСтр("ru = 'Приобретение товаров и услуг'"), Истина);
		СписокСпособовОбработки.Добавить("ОтчетКомитенту", НСтр("ru = 'Отчет комитенту о продажах'"), Истина);		
	ИначеЕсли ТипДокумента = ТипыДокументов.СведенияОЗакупкеКомиссионером Тогда
		СписокСпособовОбработки.Добавить("РеализацияТоваровУслуг", НСтр("ru = 'Реализация товаров и услуг'"), Истина);	
	ИначеЕсли ТипДокумента = ТипыДокументов.АктСверкиВзаиморасчетов Тогда
		СписокСпособовОбработки.Добавить("СверкаВзаиморасчетов2_5_11", НСтр("ru = 'Сверка взаиморасчетов (2.5.11)'"), Истина);
	ИначеЕсли ТипДокумента = ТипыДокументов.ДоговорныйДокумент Тогда	
		СписокСпособовОбработки.Добавить("ДоговорыКонтрагентов", НСтр("ru = 'Договор'"), Истина);
	КонецЕсли;
	
КонецПроцедуры

#Область ПодпискиНаСобытия

// Вызывается из подписки на события ПередЗаписьюНастройкиПолученияЭлектронныхДокументов.
//
// Параметры:
//	Источник  - РегистрСведенийНаборЗаписей.НастройкиПолученияЭлектронныхДокументов - записываемый набор,
//	Отказ 	  - Булево - Признак отказа от проведения документа,
//	Замещение - Булево - Признак замещения при записи.
//
Процедура ПередЗаписьюНастройкиПолученияЭлектронныхДокументовПередЗаписью(Источник, Отказ, Замещение) Экспорт
	
	// Если происходит загрузка данных, то выйти из обработчика.
	Если Источник.ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	Попытка
		
		Отправитель = Источник.Отбор.Найти("Отправитель");
		Если Отправитель <> Неопределено Тогда
			Если ТипЗнч(Отправитель.Значение) = Тип("СправочникСсылка.Организации") Тогда
				Для Каждого СтрокаНастроек Из Источник Цикл
					Если ЗначениеЗаполнено(СтрокаНастроек.ВидДокумента) Тогда
						ТипДокументаЭДО = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтрокаНастроек.ВидДокумента, "ТипДокумента");
							
						Если ТипДокументаЭДО = Перечисления.ТипыДокументовЭДО.ТоварнаяНакладная
							И (СтрокаНастроек.СпособОбработки = "НеОтражать"
								Или СтрокаНастроек.СпособОбработки = "Вручную") Тогда
								СтрокаНастроек.СпособОбработки = "ПередачаТоваровМеждуОрганизациями";
								ТекстСообщения = НСтр("ru = 'Способ обработки для ""Товарной накладной"" изменен на ""Передачу товаров между организациями""'");
								ОбщегоНазначения.СообщитьПользователю(ТекстСообщения);
						ИначеЕсли ТипДокументаЭДО = Перечисления.ТипыДокументовЭДО.СчетФактура
							И (СтрокаНастроек.СпособОбработки = "НеОтражать"
								Или СтрокаНастроек.СпособОбработки = "Вручную") Тогда
								СтрокаНастроек.СпособОбработки = "СчетФактураПолученный";
								ТекстСообщения = НСтр("ru = 'Способ обработки для ""Счета-фактуры"" изменен на ""Счет-фактура полученный""'");
								ОбщегоНазначения.СообщитьПользователю(ТекстСообщения);
						КонецЕсли;
							
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		КонецЕсли;
	
	Исключение
		
		ТекстСообщения = НСтр("ru = 'Произошла ошибка при проверке настроек отражения электронных документов. Необходимо самостоятельно проверить, 
		|что, если обмен идет между организациями, то включен автоматический способ обработки для документов ""Товарной накладной"" 
		|и ""Счета-фактуры"".'");
		
		ОбщегоНазначения.СообщитьПользователю(ТекстСообщения);
		
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область Прочее

// Заполняет соответствующий тип адреса переданными данными.
// Параметры:
//  СтрокаДерева - СтрокаДереваЗначений - Строка дерева, содержащая данные участника
//  АдресУчастника - Структура - содержит данные адреса участника обмена. Имена полей структуры должны совпадать с
//    именами полей структуры выбранного типа адреса:
//    Структурированный - "Индекс, КодРегион, Район, Город, НаселПункт, Улица, Дом, Корпус, Кварт";
//    Произвольный/Иностранный - "КодСтраны, АдресСтрокой" (вынесены в разные элементы списка для того,
//      чтобы правильно заполнить ЭД).
//  ТипАдреса - Строка - один из 3-х вариантов: Структурированный, Произвольный, Иностранный.
//  ВидУчастника - Строка - вид участника как он представлен в дереве данных.
//  КорневойЭлементДерева - Строка - необходимо использовать в случае, если в таблице надо заполнить
//    сложный тип данных (группа, выбор). Например: "Товары.НомерСтроки.Покупатель", Покупатель -
//    является сложным типом данных, тогда КорневойЭлементДерева = "Товары.НомерСтроки".
//
Процедура ЗаполнитьАдресВДереве(ДеревоДанных, АдресУчастника, ТипАдреса, ВидУчастника)
	
	АдресУчастника.Удалить("ПроизвольныйАдрес");		
	
	Если ТипАдреса = "Произвольный" Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".Адрес.Произвольный",
									АдресУчастника.АдрТекст);
	ИначеЕсли ТипАдреса = "Структурированный" ИЛИ ТипАдреса = "Иностранный" Тогда
		Если АдресУчастника.АдресРФ Тогда
			АдресУчастника.Удалить("АдресРФ");
			АдресУчастника.Удалить("КодСтр");
			АдресУчастника.Удалить("КодСтраны");
			АдресУчастника.Удалить("КодРегиона");
			АдресУчастника.Удалить("НаселенныйПункт");
			АдресУчастника.Удалить("Квартира");
			АдресУчастника.Удалить("АдрТекст");
			АдресУчастника.Удалить("АдресТекст");
			АдресУчастника.Удалить("КодГАР");
		Иначе
			АдресУчастника.Удалить("АдресРФ");
			АдресУчастника.Удалить("ПочтовыйИндекс");
			АдресУчастника.Удалить("Индекс");
			АдресУчастника.Удалить("Регион");
			АдресУчастника.Удалить("КодРегиона");
			АдресУчастника.Удалить("КодРегион");
			АдресУчастника.Удалить("Район");
			АдресУчастника.Удалить("Город");
			АдресУчастника.Удалить("НаселенныйПункт");
			АдресУчастника.Удалить("НаселПункт");
			АдресУчастника.Удалить("Улица");
			АдресУчастника.Удалить("Дом");
			АдресУчастника.Удалить("Корпус");
			АдресУчастника.Удалить("Квартира");
			АдресУчастника.Удалить("Кварт");
			АдресУчастника.Удалить("КодГАР");
			
			ПолныйПуть = ВидУчастника + ".Адрес.Иностранный.КодСтраны";
			Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, ПолныйПуть) Тогда
				АдресУчастника.Удалить("КодСтр");
				АдресУчастника.Удалить("АдрТекст");				
			Иначе
				АдресУчастника.Удалить("КодСтраны");
				АдресУчастника.Удалить("АдресТекст");				
			КонецЕсли;			
		КонецЕсли;
		Для Каждого Элемент Из АдресУчастника Цикл
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".Адрес." + ТипАдреса + "." + Элемент.Ключ,
									Элемент.Значение);
		КонецЦикла;
	ИначеЕсли ТипАдреса = "АдресРФ" Тогда
			АдресУчастника.Удалить("АдресРФ");
			АдресУчастника.Удалить("КодСтр");
			АдресУчастника.Удалить("КодСтраны");
			АдресУчастника.Удалить("АдрТекст");
			АдресУчастника.Удалить("АдресТекст");
			АдресУчастника.Удалить("Регион");
			АдресУчастника.Удалить("КодРегион");
			АдресУчастника.Удалить("НаселПункт");
			АдресУчастника.Удалить("Кварт");
			АдресУчастника.Удалить("КодГАР");
			
		Для Каждого Элемент Из АдресУчастника Цикл
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".Адрес." + ТипАдреса + "." + Элемент.Ключ,
									Элемент.Значение);
		КонецЦикла;
	ИначеЕсли ТипАдреса = "АдресИнформация" Тогда
			АдресУчастника.Удалить("АдресРФ");
			АдресУчастника.Удалить("ПочтовыйИндекс");
			АдресУчастника.Удалить("Индекс");
			АдресУчастника.Удалить("Регион");
			АдресУчастника.Удалить("КодРегиона");
			АдресУчастника.Удалить("КодРегион");
			АдресУчастника.Удалить("Район");
			АдресУчастника.Удалить("Город");
			АдресУчастника.Удалить("НаселенныйПункт");
			АдресУчастника.Удалить("НаселПункт");
			АдресУчастника.Удалить("Улица");
			АдресУчастника.Удалить("Дом");
			АдресУчастника.Удалить("Корпус");
			АдресУчастника.Удалить("Квартира");
			АдресУчастника.Удалить("Кварт");
			АдресУчастника.Удалить("КодСтр");
			АдресУчастника.Удалить("АдрТекст");
			АдресУчастника.Удалить("КодГАР");
	
		Для Каждого Элемент Из АдресУчастника Цикл
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".Адрес." + ТипАдреса + "." + Элемент.Ключ,
									Элемент.Значение);
		КонецЦикла;
	ИначеЕсли ТипАдреса = "КодГАР" Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".Адрес.КодГАР",
									Элемент.Значение);
	КонецЕсли;
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.СуммаПрописью.
Процедура СуммаПрописью(СуммаЧислом, КодВалюты, Результат) Экспорт
	
	Валюта = Неопределено;
	Если ЗначениеЗаполнено(КодВалюты) Тогда 
		ЭлектронноеВзаимодействиеПереопределяемый.НайтиСсылкуНаОбъект("Валюты", Валюта, КодВалюты);
		СтрокаСумма = РаботаСКурсамиВалют.СформироватьСуммуПрописью(СуммаЧислом, Валюта);
	Иначе
		ПараметрыПрописи = Новый Структура("ПараметрыПрописиНаРусском", "рубль, рубля, рублей, м, копейка, копейки, копеек, ж, 2");
		СтрокаСумма = ЧислоПрописью(СуммаЧислом, ПараметрыПрописи);
	КонецЕсли;
	Результат = СтрокаСумма;
	
КонецПроцедуры

// Осуществляет разбор файла с реквизитами контрагента
// в ней можно внести изменения в структуру возвращаемых данных.
//
// Параметры:
//  СсылкаНаФайл - Строка - адрес хранилища файла с реквизитами контрагента;
//  СтруктураВозврата - Структура - перечень параметров;
//  РезультатРазбора - Булево - Истина - разбор файла выполнен; Ложь - разбор файла не выполнялся.
//  ОшибкаРазбора - Строка - текст, описание ошибки.
//
Процедура РазобратьФайлРеквизитовКонтрагента(СсылкаНаФайл, СтруктураВозврата, РезультатРазбора, ОшибкаРазбора = "") Экспорт
	
	// Переопределим структуру возврата
	СтруктураВозврата = Новый Структура();
	
	ОбъектXML = Новый ЧтениеXML;
	ДвоичныеДанные = ПолучитьИзВременногоХранилища(СсылкаНаФайл);
	ВремФайл = РаботаСФайламиБЭД.ТекущееИмяВременногоФайла("xml");
	ДвоичныеДанные.Записать(ВремФайл);
	
	Попытка
		ОбъектXML.ОткрытьФайл(ВремФайл);
		ЭД = ФабрикаXDTO.ПрочитатьXML(ОбъектXML);
	Исключение
		ОбъектXML.Закрыть();
		
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке()) + " (" + НСтр("ru = 'подробности см. в Журнале регистрации'") + ").";
		ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействие.ОбработатьОшибку(НСтр("ru = 'Разбор файла с реквизитами контрагента'"), ТекстОшибки, ТекстСообщения);
		
		РезультатРазбора = Ложь;
		Возврат;
		
	КонецПопытки;
	
	Попытка
		
		СвойствоЭД = ЭД.Свойства().Получить("Контакты");
		Если НЕ СвойствоЭД = Неопределено И НЕ ЭД.Контакты = Неопределено Тогда
			Для Каждого ТекКонтакт Из ЭД.Контакты.Контакт Цикл
				Если ТекКонтакт.Тип = "Телефон рабочий" Тогда
					СтруктураВозврата.Вставить("ТелефонПартнера", ТекКонтакт.Значение);
					СтруктураВозврата.Вставить("ТелефонКЛ",       ТекКонтакт.Значение);
					СтруктураВозврата.Вставить("ТелефонПартнераФизЛицо", ТекКонтакт.Значение);
				ИначеЕсли ТекКонтакт.Тип = "Почта" Тогда
					СтруктураВозврата.Вставить("АдресЭППартнера", ТекКонтакт.Значение);
					СтруктураВозврата.Вставить("АдресЭПКЛ",       ТекКонтакт.Значение);
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
		СвойствоЭД = ЭД.Свойства().Получить("РасчетныеСчета");
		Если СвойствоЭД <> Неопределено Тогда
			
			ЗнДанных = ЭД.Получить(СвойствоЭД);
			Если ЗнДанных <> Неопределено Тогда
				Для Каждого ТекСв Из ЗнДанных.РасчетныйСчет Цикл
					
					СтруктураВозврата.Вставить("НомерСчета",         ТекСв.НомерСчета);
					СтруктураВозврата.Вставить("БИКБанка",           ТекСв.Банк.БИК);
					СтруктураВозврата.Вставить("КоррСчетБанка",      ТекСв.Банк.СчетКорреспондентский);
					СтруктураВозврата.Вставить("ПредставлениеБанка", ТекСв.Банк.Наименование);
					СтруктураВозврата.Вставить("УказатьБанковскийСчетКонтрагента", Истина);
					
					Если НЕ ТекСв.БанкКорреспондент = Неопределено Тогда
						СтруктураВозврата.Вставить("БИКБанкаДляРасчетов",           ТекСв.БанкКорреспондент.БИК);
						СтруктураВозврата.Вставить("КоррСчетБанкаДляРасчетов",      ТекСв.БанкКорреспондент.СчетКорреспондентский);
						СтруктураВозврата.Вставить("ПредставлениеБанкаДляРасчетов", ТекСв.БанкКорреспондент.Наименование);
						СтруктураВозврата.Вставить("ИспользуетсяБанкДляРасчетов",   Истина);
					КонецЕсли;
					Прервать;
				КонецЦикла
			КонецЕсли;
		КонецЕсли;
		
		СтруктураВозврата.Вставить("УказыватьЮридическиеРеквизиты", Истина);
		ДопустимыеТипы = "Страна, Регион, Район, Город, Улица, Дом, Корпус, Квартира";
		
		СвойствоЭД = ЭД.Свойства().Получить("ОфициальноеНаименование");
		Если СвойствоЭД <> Неопределено Тогда
			ЗнДанных = ЭД.Получить(СвойствоЭД);
			Если ЗнДанных <> Неопределено Тогда			
				ЭтоЮрЛицо = Истина
			Иначе
				ЭтоЮрЛицо = Ложь
			КонецЕсли;
	
			Если ЭтоЮрЛицо Тогда
				СтруктураВозврата.Вставить("ВидКомпании", 0);
				СвойствоИНН = ЭД.Свойства().Получить("ИНН");
				Если СвойствоИНН <> Неопределено Тогда
					СтруктураВозврата.Вставить("ИНН", ЭД.Получить(СвойствоИНН));
				КонецЕсли;
				СвойствоКПП = ЭД.Свойства().Получить("КПП");
				Если СвойствоКПП <> Неопределено Тогда
					СтруктураВозврата.Вставить("КПП", ЭД.Получить(СвойствоКПП));
				КонецЕсли;
				СвойствоОКПО = ЭД.Свойства().Получить("ОКПО");
				Если СвойствоОКПО <> Неопределено Тогда
					СтруктураВозврата.Вставить("КодПоОКПО", ЭД.Получить(СвойствоОКПО));
				КонецЕсли;
				СвойствоОФНаим = ЭД.Свойства().Получить("ОфициальноеНаименование");
				Если СвойствоОФНаим <> Неопределено Тогда
					СтруктураВозврата.Вставить("ПолноеНаименование", ЭД.Получить(СвойствоОфНаим));
					СтруктураВозврата.Вставить("ПолноеЮридическоеНаименование", ЭД.Получить(СвойствоОфНаим));
				КонецЕсли;
				
				СвойствоЮрАдрес = ЭД.Свойства().Получить("ЮридическийАдрес");
				Если СвойствоЮрАдрес <> Неопределено Тогда
					ЗнЮрАдрес = ЭД.Получить(СвойствоЮрАдрес);
					Если ЗнЮрАдрес <> Неопределено Тогда
						СтруктураВозврата.Вставить("ЮридическийАдрес", ЗнЮрАдрес.Представление);
						ЮридическийАдресЗначенияПолей = Новый СписокЗначений;
						Для Каждого ТекСв Из ЗнЮрАдрес.АдресноеПоле Цикл
							Если ТекСв.Тип = "Почтовый индекс" Тогда
								ЮрАдресЗначения = ЮридическийАдресЗначенияПолей.Добавить();
								ЮрАдресЗначения.Представление =  "Индекс";
								ЮрАдресЗначения.Значение = ТекСв.Значение;
							ИначеЕсли ТекСв.Тип = "Населенный пункт" Тогда
								ЮрАдресЗначения = ЮридическийАдресЗначенияПолей.Добавить();
								ЮрАдресЗначения.Представление = "НаселенныйПункт";
								ЮрАдресЗначения.Значение = ТекСв.Значение;
							ИначеЕсли Найти(ДопустимыеТипы, ТекСв.Тип) > 0 Тогда
								ЮрАдресЗначения = ЮридическийАдресЗначенияПолей.Добавить();
								ЮрАдресЗначения.Представление = ТекСв.Тип;
								ЮрАдресЗначения.Значение = ТекСв.Значение;
							КонецЕсли;
						КонецЦикла;
						
						СтруктураВозврата.Вставить("ЮридическийАдресЗначенияПолей", ЮридическийАдресЗначенияПолей);
					КонецЕсли
				КонецЕсли;
				
				СвойствоРуководитель = ЭД.Свойства().Получить("Руководитель");
				Если СвойствоРуководитель <> Неопределено Тогда
					ЗнРуководитель = ЭД.Получить(СвойствоРуководитель);
					Если ЗнРуководитель <> Неопределено Тогда
						СвойствоФизЛицо = ЗнРуководитель.Свойства().Получить("ФизЛицо");
						Если СвойствоФизЛицо <> Неопределено Тогда
							ФизЛицо = ЗнРуководитель.Получить(СвойствоФизЛицо);
							Если ФизЛицо <> Неопределено Тогда
								СтруктураВозврата.Вставить("УказатьДанныеКонтактногоЛица", Истина);
								ФИО = ФизическиеЛицаКлиентСервер.ЧастиИмени(ФизЛицо.ПолноеНаименование);
								СтруктураВозврата.Вставить("ФамилияКЛ",  ФИО.Фамилия);
								СтруктураВозврата.Вставить("ИмяКЛ",      ФИО.Имя);
								СтруктураВозврата.Вставить("ОтчествоКЛ", ФИО.Отчество);
							КонецЕсли;
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			Иначе
				СтруктураВозврата.Вставить("ВидКомпании", 2);
				
				СвойствоФамилия = ЭД.Свойства().Получить("Фамилия");
				Если СвойствоФамилия <> Неопределено Тогда
					СтруктураВозврата.Вставить("ФамилияПартнера", ЭД.Получить(СвойствоФамилия));
				КонецЕсли;
				
				СвойствоИмя = ЭД.Свойства().Получить("Имя");
				Если СвойствоИмя <> Неопределено Тогда
					СтруктураВозврата.Вставить("ИмяПартнера", ЭД.Получить(СвойствоИмя));
				КонецЕсли;
				
				СвойствоОтчество = ЭД.Свойства().Получить("Отчество");
				Если СвойствоОтчество <> Неопределено Тогда
					СтруктураВозврата.Вставить("ОтчествоПартнера", ЭД.Получить(СвойствоОтчество));
				КонецЕсли;
				
				СвойствоИНН = ЭД.Свойства().Получить("ИНН");
				Если СвойствоИНН <> Неопределено Тогда
					СтруктураВозврата.Вставить("ИНН", ЭД.Получить(СвойствоИНН));
				КонецЕсли;
				
				СвойствоОКПО = ЭД.Свойства().Получить("ОКПО");
				Если СвойствоОКПО <> Неопределено Тогда
					СтруктураВозврата.Вставить("КодПоОКПО", ЭД.Получить(СвойствоОКПО));
				КонецЕсли;
				
				СвойствоОФНаим = ЭД.Свойства().Получить("ПолноеНаименование");
				Если СвойствоОФНаим <> Неопределено Тогда
					СтруктураВозврата.Вставить("ПолноеНаименование", ЭД.Получить(СвойствоОфНаим));
					СтруктураВозврата.Вставить("ПолноеЮридическоеНаименование", ЭД.Получить(СвойствоОфНаим));
				КонецЕсли;
				
				СвойствоЮрАдрес = ЭД.Свойства().Получить("АдресРегистрации");
				Если СвойствоЮрАдрес <> Неопределено Тогда
					
					ЗнЮрАдрес = ЭД.Получить(СвойствоЮрАдрес);
					Если ЗнЮрАдрес <> Неопределено Тогда
						
						СтруктураВозврата.Вставить("ЮридическийАдрес", ЗнЮрАдрес.Представление);
						ЮридическийАдресЗначенияПолей = Новый СписокЗначений;
						Для Каждого ТекСв Из ЗнЮрАдрес.АдресноеПоле Цикл
							Если ТекСв.Тип = "Почтовый индекс" Тогда
								ЮрАдресЗначения = ЮридическийАдресЗначенияПолей.Добавить();
								ЮрАдресЗначения.Представление = "Индекс";
								ЮрАдресЗначения.Значение = ТекСв.Значение;
							ИначеЕсли ТекСв.Тип = "Населенный пункт" Тогда
								ЮрАдресЗначения = ЮридическийАдресЗначенияПолей.Добавить();
								ЮрАдресЗначения.Представление = "НаселенныйПункт";
								ЮрАдресЗначения.Значение = ТекСв.Значение;
							ИначеЕсли Найти(ДопустимыеТипы, ТекСв.Тип) > 0 Тогда
								ЮрАдресЗначения = ЮридическийАдресЗначенияПолей.Добавить();
								ЮрАдресЗначения.Представление = ТекСв.Тип;
								ЮрАдресЗначения.Значение = ТекСв.Значение;
							КонецЕсли;
						КонецЦикла;
						
						СтруктураВозврата.Вставить("ЮридическийАдресЗначенияПолей", ЮридическийАдресЗначенияПолей);
					КонецЕсли
				КонецЕсли;
			КонецЕсли;
		Иначе
			РезультатРазбора = Ложь;
			Возврат;
		КонецЕсли;
		
		СвойствоЭД = ЭД.Свойства().Получить("Наименование");
		Если СвойствоЭД <> Неопределено Тогда
			СтруктураВозврата.Вставить("Название", ЭД.Получить(СвойствоЭД));
		КонецЕсли;
		
		СвойствоЭД = ЭД.Свойства().Получить("Адрес");
		Если СвойствоЭД <> Неопределено Тогда
			ЗнДанных = ЭД.Получить(СвойствоЭД);
			Если ЗнДанных <> Неопределено Тогда
				
				СтруктураВозврата.Вставить("ФактическийАдрес", ЗнДанных.Представление);
				ФактическийАдресЗначенияПолей = Новый СписокЗначений;
				Для Каждого ТекСв Из ЗнДанных.АдресноеПоле Цикл
					Если ТекСв.Тип = "Почтовый индекс" Тогда
						ФактАдресЗначения = ФактическийАдресЗначенияПолей.Добавить();
						ФактАдресЗначения.Представление = "Индекс";
						ФактАдресЗначения.Значение = ТекСв.Значение;
					ИначеЕсли ТекСв.Тип = "Населенный пункт" Тогда
						ФактАдресЗначения = ФактическийАдресЗначенияПолей.Добавить();
						ФактАдресЗначения.Представление = "НаселенныйПункт";
						ФактАдресЗначения.Значение = ТекСв.Значение;
					ИначеЕсли Найти(ДопустимыеТипы, ТекСв.Тип) > 0 Тогда
						ФактАдресЗначения = ФактическийАдресЗначенияПолей.Добавить();
						ФактАдресЗначения.Значение = ТекСв.Значение;
						ФактАдресЗначения.Представление = ТекСв.Тип;
					КонецЕсли;
				КонецЦикла;
				
				СтруктураВозврата.Вставить("ФактическийАдресЗначенияПолей", ФактическийАдресЗначенияПолей);
			КонецЕсли;
		КонецЕсли;
	Исключение
		
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействие.ОбработатьОшибку(НСтр("ru = 'Разбор файла с реквизитами контрагента'"), ТекстОшибки, ТекстСообщения);
		
		РезультатРазбора = Ложь;
		Возврат;
		
	КонецПопытки;
	
	РезультатРазбора = Истина;	
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ПолучитьСоответствиеПеречислений.
Процедура ПолучитьСоответствиеПеречислений(СоответствиеПеречислений) Экспорт
	
	СоответствиеПеречислений.Вставить("НДС", "СтавкиНДС");
	СоответствиеПеречислений.Вставить("ЮрФизЛицо", "ЮрФизЛицо");
	СоответствиеПеречислений.Вставить("ВариантыОплатыКлиентом", "ВариантыКонтроляОплатыКлиентом");
	СоответствиеПеречислений.Вставить("ВариантыОплатыПоставщику", "ВариантыКонтроляОплатыПоставщику");
	СоответствиеПеречислений.Вставить("ФормыОплаты", "ФормыОплаты");
	СоответствиеПеречислений.Вставить("СпособРасчета", "СпособыРасчетаКомиссионногоВознаграждения");
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ПолучитьЗначениеПеречисления.
Процедура ПолучитьЗначениеПеречисления(ИмяПеречисления, ПредставлениеПеречисления, НайденноеЗначение) Экспорт
	
	Если Метаданные.Перечисления.Найти(ИмяПеречисления) = Неопределено Тогда
		НайденноеЗначение = ПредставлениеПеречисления;
		Возврат;
	КонецЕсли;
	
	Для Каждого ЭлПеречисления Из Метаданные.Перечисления[ИмяПеречисления].ЗначенияПеречисления Цикл
		Если Найти(ВРег(ЭлПеречисления.Синоним), ВРег(ПредставлениеПеречисления)) > 0
			ИЛИ Найти(ВРег(ЭлПеречисления.Имя), ВРег(ПредставлениеПеречисления)) > 0 Тогда
			
			НайденноеЗначение = Перечисления[ИмяПеречисления][ЭлПеречисления.Имя];
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	//Особенности ERP
	Если ИмяПеречисления = "ВариантыКонтроляОплатыПоставщику" Тогда
		Если ПредставлениеПеречисления = НСтр("ru = 'Предоплата (до поступления)'") Тогда
			НайденноеЗначение = Перечисления.ВариантыКонтроляОплатыПоставщику.ПредоплатаДоПоступления;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьСоответствиеСтавокНДС.
Процедура ЗаполнитьСоответствиеСтавокНДС(Соответствие) Экспорт
	
	УчетНДСРФ.СоответствиеСтавокНДССтроковымЗначениям(Соответствие);	
	Соответствие.Вставить("НДС исчисляется налоговым агентом", "НДС исчисляется налоговым агентом");
	
	Ставка18 = Справочники.СтавкиНДС.НайтиПоНаименованию("18%");
	Если ЗначениеЗаполнено(Ставка18) Тогда
		ЕстьСтавка18ВСоответствии = Соответствие.Получить(Ставка18);	
		Если Не ЗначениеЗаполнено(ЕстьСтавка18ВСоответствии) Тогда
			Соответствие.Вставить("18", Справочники.СтавкиНДС.НайтиПоНаименованию("18%"));
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры  
	
	// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьСоответствиеВидовДоговоровКонтрагентов.
Процедура ЗаполнитьСоответствиеВидовДоговоровКонтрагентов(Соответствие) Экспорт
	
	Соответствие.Вставить("Закупка", Перечисления.ТипыДоговоров.СПоставщиком);
	Соответствие.Вставить("Реализация", Перечисления.ТипыДоговоров.СПокупателем);
	Соответствие.Вставить("Прием на комиссию", Перечисления.ТипыДоговоров.СКомитентом);
	Соответствие.Вставить("Передача на комиссию",Перечисления.ТипыДоговоров.СКомиссионером);
	Соответствие.Вставить("Поставка под принципала",Перечисления.ТипыДоговоров.СКомитентомНаЗакупку);
	Соответствие.Вставить("Закупка (импорт)", Перечисления.ТипыДоговоров.Импорт);
	Соответствие.Вставить("Закупка (ЕАЭС)", Перечисления.ТипыДоговоров.ВвозИзЕАЭС);
	
	
	Соответствие.Вставить("Прием на ответственное хранение", Перечисления.ТипыДоговоров.СПоклажедателем);
    Соответствие.Вставить("Передача на ответственное хранение", Перечисления.ТипыДоговоров.СХранителем);
	Соответствие.Вставить("Реализация через комиссионера", Перечисления.ТипыДоговоров.РеализацияЧерезКомиссионера);

КонецПроцедуры  

Функция ВидДоговоровКонтрагентовПеречисление(ВидДоговора)
	
	Соответствие = Новый Соответствие;
	ЗаполнитьСоответствиеВидовДоговоровКонтрагентов(Соответствие);
	
	Для Каждого КлючИЗначение Из Соответствие Цикл
		Если КлючИЗначение.Значение = ВидДоговора Тогда
			Значение = КлючИЗначение.Ключ;
			Прервать;
		КонецЕсли;
	КонецЦикла;

	Возврат Значение;
	
КонецФункции

// См. ОбменСКонтрагентамиПереопределяемый.ЗаполнитьСоответствиеВидовДоговоровПротивоположноеЗначениюКонтрагентов.
Процедура ЗаполнитьСоответствиеВидовДоговоровПротивоположноеЗначениюКонтрагентов(Соответствие) Экспорт
	
	Соответствие.Вставить("Реализация через комиссионера",		Перечисления.ТипыДоговоров.СПоставщиком);
	Соответствие.Вставить("Передача на комиссию",				Перечисления.ТипыДоговоров.СКомитентом);
	Соответствие.Вставить("Прием на комиссию",					Перечисления.ТипыДоговоров.СКомиссионером);
	Соответствие.Вставить("Поставка под принципала",			Перечисления.ТипыДоговоров.СПоставщиком);
	Соответствие.Вставить("Прием на ответственное хранение",	Перечисления.ТипыДоговоров.СХранителем);
	Соответствие.Вставить("Реализация",							Перечисления.ТипыДоговоров.СПоставщиком);
	Соответствие.Вставить("Закупка",							Перечисления.ТипыДоговоров.СПокупателем);
	Соответствие.Вставить("Передача на ответственное хранение", Перечисления.ТипыДоговоров.СПоклажедателем);
	
КонецПроцедуры

Функция СтруктураИтоговыеСуммы(ТипЭД)
	
	Структура = Новый Структура;
	ТипыДокументов = ОбменСКонтрагентами.ТипыДокументов();			
	
	// Инициализация итогов по документу.
	Если ТипЭД = ТипыДокументов.АктНаПередачуПрав Тогда
		Структура.Вставить("Количество", 0);
		Структура.Вставить("СуммаНДС", 0);
		Структура.Вставить("СуммаБезНДС", 0);
		Структура.Вставить("СуммаСНДС", 0);
	Иначе
		Структура.Вставить("КоличествоМест", 0);
		Структура.Вставить("МассаНетто", 0);
		Структура.Вставить("МассаБрутто", 0);
		Структура.Вставить("СуммаБезНДС", 0);
		Структура.Вставить("СуммаНДС", 0);
		Структура.Вставить("СуммаСНДС", 0);
		
		Если ТипЭД = ТипыДокументов.СоглашениеОбИзмененииСтоимости Тогда
			Структура.Вставить("МассаНеттоДоКорректировки", 0);
			Структура.Вставить("СуммаБезНДСДоКорректировки", 0);
			Структура.Вставить("СуммаНДСДоКорректировки", 0);
			Структура.Вставить("СуммаСНДСДоКорректировки", 0);
		КонецЕсли;
		
		Структура.Вставить("КоличествоПорядковыхНомеровЗаписей", 0);
		Структура.Вставить("СуммаПрописью", "");
	КонецЕсли;	
		
	Возврат Структура;
	
КонецФункции

Процедура РассчитатьИтоговыеСуммы(ИтоговыеСуммы, ДанныеСтроки, ТипЭД)

	ТипыДокументов = ОбменСКонтрагентами.ТипыДокументов();			
	
	Если ТипЭД = ТипыДокументов.АктНаПередачуПрав Тогда
		ИтоговыеСуммы.Количество	 = ИтоговыеСуммы.Количество + ДанныеСтроки.Количество;
		ИтоговыеСуммы.СуммаНДС       = ИтоговыеСуммы.СуммаНДС + ДанныеСтроки.СуммаНДС;
		ИтоговыеСуммы.СуммаБезНДС    = ИтоговыеСуммы.СуммаБезНДС + ДанныеСтроки.Сумма;
		ИтоговыеСуммы.СуммаСНДС      = ИтоговыеСуммы.СуммаСНДС + ДанныеСтроки.Сумма + ДанныеСтроки.СуммаНДС;
	Иначе
		Если ЗначениеЗаполнено(ДанныеСтроки.КоличествоМест) Тогда
			КоличествоМест = ДанныеСтроки.КоличествоМест;
			Если КоличествоМест <> Цел(КоличествоМест) Тогда
				КоличествоМест = Цел(КоличествоМест) + 1;
			КонецЕсли;
		Иначе
			КоличествоМест = 0;
		КонецЕсли;
		
		ИтоговыеСуммы.КоличествоМест = ИтоговыеСуммы.КоличествоМест + КоличествоМест;
		ИтоговыеСуммы.СуммаБезНДС    = ИтоговыеСуммы.СуммаБезНДС + ДанныеСтроки.СуммаБезНДС;
		ИтоговыеСуммы.СуммаНДС       = ИтоговыеСуммы.СуммаНДС + ДанныеСтроки.СуммаНДС;
		ИтоговыеСуммы.СуммаСНДС      = ИтоговыеСуммы.СуммаСНДС + ДанныеСтроки.СуммаСНДС;
		ИтоговыеСуммы.МассаБрутто    = ИтоговыеСуммы.МассаБрутто + ДанныеСтроки.МассаБрутто;
		ИтоговыеСуммы.МассаНетто     = ИтоговыеСуммы.МассаНетто + ДанныеСтроки.МассаНетто;
		ИтоговыеСуммы.КоличествоПорядковыхНомеровЗаписей = ИтоговыеСуммы.КоличествоПорядковыхНомеровЗаписей + 1;
		
		Если ТипЭД = ТипыДокументов.СоглашениеОбИзмененииСтоимости Тогда
			ИтоговыеСуммы.МассаНеттоДоКорректировки  = ИтоговыеСуммы.МассаНеттоДоКорректировки + ДанныеСтроки.МассаНеттоДоКорректировки;
			ИтоговыеСуммы.СуммаБезНДСДоКорректировки = ИтоговыеСуммы.СуммаБезНДСДоКорректировки + ДанныеСтроки.СуммаБезНДСДоКорректировки;
			ИтоговыеСуммы.СуммаНДСДоКорректировки    = ИтоговыеСуммы.СуммаНДСДоКорректировки + ДанныеСтроки.СуммаНДСДоКорректировки;
			ИтоговыеСуммы.СуммаСНДСДоКорректировки   = ИтоговыеСуммы.СуммаСНДСДоКорректировки 
				+ ДанныеСтроки.СуммаБезНДСДоКорректировки 
				+ ДанныеСтроки.СуммаНДСДоКорректировки;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Функция НайтиДокумент(ТипЭД, Контрагент, РеквизитыИБ = Неопределено, РеквизитыИБКонтрагента = Неопределено)
	
	УстановитьПривилегированныйРежим(Истина);
	
	НайденныйДок = Неопределено;
	ТипыДокументов = ОбменСКонтрагентами.ТипыДокументов();			
	Если ТипЭД = ТипыДокументов.ЗаказТовара Тогда
		Запрос = Новый Запрос;	
		ОсновнойТекстЗапроса = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
		               |	ДокументПоиска.Ссылка КАК Ссылка
		               |ИЗ
		               |	Документ.ЗаказКлиента КАК ДокументПоиска
		               |ГДЕ
		               |	ДокументПоиска.Контрагент = &Контрагент";
		// будем искать по нашим реквизитам
		Если РеквизитыИБ <> Неопределено И РеквизитыИБ.Количество()>0 Тогда
			Запрос.Текст = ОсновнойТекстЗапроса;
			Запрос.УстановитьПараметр("Контрагент", Контрагент);
			Для Каждого ТекЭл Из РеквизитыИБ Цикл
				Если Найти(ВРег(ТекЭл.Ключ), ВРег("Дата"))>0 Тогда
					Запрос.Текст = Запрос.Текст+" И КОНЕЦПЕРИОДА(ДокументПоиска."+ТекЭл.Ключ+", ГОД) =  КОНЕЦПЕРИОДА(&"+ТекЭл.Ключ+", ГОД)";
				Иначе
					Запрос.Текст = Запрос.Текст+" И ДокументПоиска."+ТекЭл.Ключ+" = &"+ТекЭл.Ключ;
				КонецЕсли;
				Запрос.УстановитьПараметр(ТекЭл.Ключ, ТекЭл.Значение);
			КонецЦикла;				   
			
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				НайденныйДок = Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(НайденныйДок) И РеквизитыИБКонтрагента <> Неопределено
			И РеквизитыИБКонтрагента.Количество()>0 Тогда // не нашли по нашим реквизитам, искать будем по данным контрагента
			Запрос.Текст = ОсновнойТекстЗапроса;
			Запрос.УстановитьПараметр("Контрагент", Контрагент);
			Для Каждого ТекЭл Из РеквизитыИБКонтрагента Цикл
				Если Найти(ВРег(ТекЭл.Ключ), ВРег("Дата"))>0 Тогда
					Запрос.Текст = Запрос.Текст+" И КОНЕЦПЕРИОДА(ДокументПоиска."+ТекЭл.Ключ+", ГОД) =  КОНЕЦПЕРИОДА(&"+ТекЭл.Ключ+", ГОД)";
				Иначе	
    				Запрос.Текст = Запрос.Текст+" И ДокументПоиска."+ТекЭл.Ключ+" = &"+ТекЭл.Ключ;
				КонецЕсли;	
				Запрос.УстановитьПараметр(ТекЭл.Ключ, ТекЭл.Значение);
			КонецЦикла;				   
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				НайденныйДок = Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли ТипЭД = ТипыДокументов.ОтветНаЗаказ Тогда
		Запрос = Новый Запрос;	
		ОсновнойТекстЗапроса = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
		               |	ДокументПоиска.Ссылка КАК Ссылка
		               |ИЗ
		               |	Документ.ЗаказПоставщику КАК ДокументПоиска
		               |ГДЕ
		               |	ДокументПоиска.Контрагент = &Контрагент";
		// будем искать по нашим реквизитам
		Если РеквизитыИБ <> Неопределено И РеквизитыИБ.Количество()>0  Тогда
			Запрос.Текст = ОсновнойТекстЗапроса;
			Запрос.УстановитьПараметр("Контрагент", Контрагент);
			Для Каждого ТекЭл Из РеквизитыИБ Цикл
				Если Найти(ВРег(ТекЭл.Ключ), ВРег("Дата"))>0 Тогда
					Запрос.Текст = Запрос.Текст+" И КОНЕЦПЕРИОДА(ДокументПоиска."+ТекЭл.Ключ+", ГОД) =  КОНЕЦПЕРИОДА(&"+ТекЭл.Ключ+", ГОД)";
				Иначе
					Запрос.Текст = Запрос.Текст+" И ДокументПоиска."+ТекЭл.Ключ+" = &"+ТекЭл.Ключ;
				КонецЕсли;
				Запрос.УстановитьПараметр(ТекЭл.Ключ, ТекЭл.Значение);
			КонецЦикла;				   
			
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				НайденныйДок = Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(НайденныйДок) И РеквизитыИБКонтрагента <> Неопределено 
			И РеквизитыИБКонтрагента.Количество()>0 Тогда // не нашли по нашим реквизитам, искать будем по данным контрагента
			Запрос.Текст = ОсновнойТекстЗапроса;
			Запрос.УстановитьПараметр("Контрагент", Контрагент);
			Для Каждого ТекЭл Из РеквизитыИБКонтрагента Цикл
				Если Найти(ВРег(ТекЭл.Ключ), ВРег("Дата"))>0 Тогда
					Запрос.Текст = Запрос.Текст+" И КОНЕЦПЕРИОДА(ДокументПоиска."+ТекЭл.Ключ+", ГОД) =  КОНЕЦПЕРИОДА(&"+ТекЭл.Ключ+", ГОД)";
				Иначе
					Запрос.Текст = Запрос.Текст+" И ДокументПоиска."+ТекЭл.Ключ+" = &"+ТекЭл.Ключ;
				КонецЕсли;
				Запрос.УстановитьПараметр(ТекЭл.Ключ, ТекЭл.Значение);
			КонецЦикла;				   
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				НайденныйДок = Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли ТипЭД = ТипыДокументов.ТоварнаяНакладная Тогда	
		Запрос = Новый Запрос;	
		ОсновнойТекстЗапроса = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
		               |	ДокументПоиска.Ссылка КАК Ссылка
		               |ИЗ
		               |	Документ.РеализацияТоваровУслуг КАК ДокументПоиска
		               |ГДЕ
		               |	ДокументПоиска.Контрагент = &Контрагент";
		// будем искать по нашим реквизитам
		Если РеквизитыИБ <> Неопределено И РеквизитыИБ.Количество()>0  Тогда
			Запрос.Текст = ОсновнойТекстЗапроса;
			Запрос.УстановитьПараметр("Контрагент", Контрагент);
			Для Каждого ТекЭл Из РеквизитыИБ Цикл
				Если Найти(ВРег(ТекЭл.Ключ), ВРег("Дата"))>0 Тогда
					Запрос.Текст = Запрос.Текст+" И КОНЕЦПЕРИОДА(ДокументПоиска."+ТекЭл.Ключ+", ГОД) =  КОНЕЦПЕРИОДА(&"+ТекЭл.Ключ+", ГОД)";
				Иначе
					Запрос.Текст = Запрос.Текст+" И ДокументПоиска."+ТекЭл.Ключ+" = &"+ТекЭл.Ключ;
				КонецЕсли;
				Запрос.УстановитьПараметр(ТекЭл.Ключ, ТекЭл.Значение);
			КонецЦикла;				   
			
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				НайденныйДок = Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(НайденныйДок) И РеквизитыИБКонтрагента <> Неопределено 
			И РеквизитыИБКонтрагента.Количество()>0 Тогда // не нашли по нашим реквизитам, искать будем по данным контрагента
			Запрос.Текст = ОсновнойТекстЗапроса;
			Запрос.УстановитьПараметр("Контрагент", Контрагент);
			Для Каждого ТекЭл Из РеквизитыИБКонтрагента Цикл
				Если Найти(ВРег(ТекЭл.Ключ), ВРег("Дата"))>0 Тогда
					Запрос.Текст = Запрос.Текст+" И КОНЕЦПЕРИОДА(ДокументПоиска."+ТекЭл.Ключ+", ГОД) =  КОНЕЦПЕРИОДА(&"+ТекЭл.Ключ+", ГОД)";
				Иначе
					Запрос.Текст = Запрос.Текст+" И ДокументПоиска."+ТекЭл.Ключ+" = &"+ТекЭл.Ключ;
				КонецЕсли;
				Запрос.УстановитьПараметр(ТекЭл.Ключ, ТекЭл.Значение);
			КонецЦикла;				   
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				НайденныйДок = Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;		
	КонецЕсли;
	
	Возврат НайденныйДок;
	
КонецФункции

Процедура НайтиТаможенныеДекларации(ТаможеннаяДекларация,
									НомерТаможеннойДекларации,
									СтранаПроисхождения,
									НомерРНПТ = Ложь,
									СуммаПоРНПТ = 0,
									ЭтоУПД = Ложь)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	Выборка.Ссылка
	|ИЗ
	|	Справочник.НомераГТД КАК Выборка
	|ГДЕ
	|	Выборка.Код = &НомерТД
	|	И Выборка.ТипНомераГТД = &ТипНомераГТД
	|	И &ОтборПоСтране
	|	И &ОтборПоСуммеПоРНПТ
	|	И НЕ Выборка.ПометкаУдаления";
	
	Запрос.УстановитьПараметр("НомерТД", НомерТаможеннойДекларации);
	Запрос.УстановитьПараметр("ТипНомераГТД", ?(НомерРНПТ,
												Перечисления.ТипыНомеровГТД.НомерРНПТ,
												Перечисления.ТипыНомеровГТД.НомерГТД));
	
	Если СтранаПроисхождения <> Неопределено Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ОтборПоСтране", "Выборка.СтранаПроисхождения = &СтранаПроисхождения");
		Запрос.УстановитьПараметр("СтранаПроисхождения", СтранаПроисхождения);
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ОтборПоСтране", "ИСТИНА");
	КонецЕсли;

	Если ЗначениеЗаполнено(СуммаПоРНПТ) И ЭтоУПД Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ОтборПоСуммеПоРНПТ", "Выборка.СуммаПоРНПТ = &СуммаПоРНПТ");
		Запрос.УстановитьПараметр("СуммаПоРНПТ", СуммаПоРНПТ);
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ОтборПоСуммеПоРНПТ", "ИСТИНА");
	КонецЕсли;
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		ТаможеннаяДекларация = Выборка.Ссылка;
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьСтрокуТЧ(ТЗ, ДанныеЗаполнения, ДеревоРазбора, ЭтоЗаказ = Ложь)
	
	НовСтрока = ТЗ.Добавить();
	Для Каждого ТекСтрока Из ДанныеЗаполнения Цикл
		ИмяРеквизитаВБД = ТекСтрока.Реквизит;
		
		Если ИмяРеквизитаВБД = "Описание" Тогда
			ИмяРеквизитаВБД = "Содержание";
		ИначеЕсли ИмяРеквизитаВБД = "СумНДС" Тогда
			ИмяРеквизитаВБД = "СуммаНДС";
		ИначеЕсли ИмяРеквизитаВБД = "СтТовУчНал" Тогда
			ИмяРеквизитаВБД = "Сумма";
		ИначеЕсли ИмяРеквизитаВБД = "НалСтВел" Тогда
			ИмяРеквизитаВБД = "СтавкаНДС";
		КонецЕсли;
		
		Если ИмяРеквизитаВБД = "СуммаСНДС" Тогда
			Если ЭтоЗаказ Тогда
				НовСтрока.Сумма = ПолучитьЗначениеРеквизитаДерева(ТекСтрока, ИмяРеквизитаВБД, Истина, ДеревоРазбора);
			КонецЕсли;
		КонецЕсли;
		
		Если ИмяРеквизитаВБД = "Сопоставление" Тогда
			Сопоставление = ПолучитьЗначениеРеквизитаДерева(ТекСтрока, ТекСтрока.Реквизит, Истина, ДеревоРазбора);
			Если ТипЗнч(Сопоставление) <> Тип("Структура") Тогда
				Продолжить;
			КонецЕсли;
			Если КолонкаСуществует(ТЗ, "Номенклатура")
				И Сопоставление.Свойство("НоменклатураИБ") Тогда
				Если ЗначениеЗаполнено(Сопоставление.НоменклатураИБ) Тогда
					НовСтрока.Номенклатура = Сопоставление.НоменклатураИБ;
				КонецЕсли;
			КонецЕсли;
			Если КолонкаСуществует(ТЗ, "Характеристика")
				И Сопоставление.Свойство("ХарактеристикаИБ") Тогда
				Если ЗначениеЗаполнено(Сопоставление.ХарактеристикаИБ) Тогда
					НовСтрока.Характеристика = Сопоставление.ХарактеристикаИБ;
				КонецЕсли;
			КонецЕсли;
			Если КолонкаСуществует(ТЗ, "ЕдиницаИзмерения")
				И Сопоставление.Свойство("УпаковкаИБ") Тогда
				Если ЗначениеЗаполнено(Сопоставление.УпаковкаИБ) Тогда
					НовСтрока.ЕдиницаИзмерения = Сопоставление.УпаковкаИБ;
				КонецЕсли;
			КонецЕсли;
			Если КолонкаСуществует(ТЗ, "Упаковка")
				И Сопоставление.Свойство("УпаковкаИБ") Тогда
				Если ЗначениеЗаполнено(Сопоставление.УпаковкаИБ) Тогда
					НовСтрока.Упаковка = Сопоставление.УпаковкаИБ;
				КонецЕсли;
			КонецЕсли;			
		КонецЕсли;
		
		// Заполнение характеристики номенклатуры и упаковки.
		Если ИмяРеквизитаВБД = "НоменклатураПартнера" Тогда
			Если КолонкаСуществует(ТЗ, "Характеристика") Тогда
				НайденноеЗначение = ПолучитьЗначениеРеквизитаДерева(ТекСтрока, ТекСтрока.Реквизит, Истина, ДеревоРазбора);
				Если ЗначениеЗаполнено(НайденноеЗначение) Тогда
					НовСтрока.Характеристика = НайденноеЗначение.Характеристика;	
				КонецЕсли;
			КонецЕсли;
			Если КолонкаСуществует(ТЗ, "Упаковка") Тогда
				НайденноеЗначение = ПолучитьЗначениеРеквизитаДерева(ТекСтрока, ТекСтрока.Реквизит, Истина, ДеревоРазбора);
				Если ЗначениеЗаполнено(НайденноеЗначение) Тогда
					НовСтрока.Упаковка = НайденноеЗначение.Упаковка;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		Если Не КолонкаСуществует(ТЗ, ИмяРеквизитаВБД) Тогда
			Продолжить;
		КонецЕсли;
		
		НайденноеЗначение = ПолучитьЗначениеРеквизитаДерева(ТекСтрока, ТекСтрока.Реквизит, Истина, ДеревоРазбора);
		
		НовСтрока[ИмяРеквизитаВБД] = НайденноеЗначение;
		Если ТекСтрока.Реквизит = "Номенклатура" Тогда
			СтрокаНоменклатура = ДеревоРазбора.Строки.Найти(ТекСтрока.ЗначениеРеквизита, "ИндексСтроки", Истина);
			НайденноеЗначение = ПолучитьЗначениеРеквизитаДерева(СтрокаНоменклатура, "ЕдиницаИзмерения", Истина, ДеревоРазбора);
			Если ЗначениеЗаполнено(НайденноеЗначение) Тогда
				НовСтрока.Упаковка = НайденноеЗначение;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Функция КолонкаСуществует(Таблица, ИмяКолонки)
	
	Результат = Не (Таблица.Колонки.Найти(ИмяКолонки) = Неопределено);
	
	Возврат Результат;
	
КонецФункции

Функция ПодготовитьСтруктуруДляПриобретенияТоваровУслуг(СтрокаДляЗагрузки, ДеревоРазбора)
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеЗаполненияШапки = Новый Структура;
	ТЗ = Документы.ПриобретениеТоваровУслуг.ПустаяСсылка().Товары.ВыгрузитьКолонки();
	ТЗ.Колонки.Добавить("НомерПоДаннымПоставщика");
	ТЗ.Колонки.Добавить("ДатаПоДаннымПоставщика");
	ТЗ.Колонки.Добавить("НомерПоДаннымКлиента");
	ТЗ.Колонки.Добавить("ДатаПоДаннымКлиента");
	Для Каждого СтрокаРеквизита Из СтрокаДляЗагрузки.Строки Цикл
		Если СтрокаРеквизита.Реквизит = "СписокОписаний" Тогда
			СтрокаРеквизитаОписанийРабот = ПолучитьЗначениеРеквизитаДерева(СтрокаРеквизита, СтрокаРеквизита.Реквизит, Истина, ДеревоРазбора);
			Для Каждого СтрокаРеквизитаОписания Из СтрокаРеквизитаОписанийРабот.Строки Цикл
				Если СтрокаРеквизитаОписания.Строки.Количество() = 0 Тогда
					Реквизит = ПолучитьЗначениеРеквизитаДерева(СтрокаРеквизитаОписания, СтрокаРеквизитаОписания.Реквизит, Истина, ДеревоРазбора);
					Если ЗначениеЗаполнено(Реквизит) Тогда
						ДанныеЗаполненияШапки.Вставить(СтрокаРеквизитаОписания.Реквизит, Реквизит);
					КонецЕсли;
				Иначе
					ЗаполнитьСтрокуТЧ(ТЗ, СтрокаРеквизитаОписания.Строки, ДеревоРазбора);
				КонецЕсли;
			КонецЦикла;
		Иначе
			Если СтрокаРеквизита.Строки.Количество() = 0 Тогда // примитивный тип
				Реквизит = ПолучитьЗначениеРеквизитаДерева(СтрокаРеквизита, СтрокаРеквизита.Реквизит, Истина, ДеревоРазбора);
				Если ЗначениеЗаполнено(Реквизит) Тогда
					ДанныеЗаполненияШапки.Вставить(СтрокаРеквизита.Реквизит, Реквизит);
				КонецЕсли;
			Иначе // добавим строку ТЧ
				ЗаполнитьСтрокуТЧ(ТЗ, СтрокаРеквизита.Строки, ДеревоРазбора);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	ДанныеЗаполненияШапки.Вставить("НомерВходящегоДокумента",ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "Номер"));
	ДанныеЗаполненияШапки.Вставить("ДатаВходящегоДокумента", ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "Дата"));
	
	// реквизиты для связки "заказ - поступление"
	ДанныеЗаполненияШапки.Вставить("НомерПоДаннымКлиента", 		ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "НомерПоДаннымКлиента"));
	ДанныеЗаполненияШапки.Вставить("ДатаПоДаннымКлиента",  		ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "ДатаПоДаннымКлиента"));
	ДанныеЗаполненияШапки.Вставить("НомерПоДаннымПоставщика", 	ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "НомерПоДаннымПоставщика"));
	ДанныеЗаполненияШапки.Вставить("ДатаПоДаннымПоставщика",  	ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "ДатаПоДаннымПоставщика"));
	
	// заполним Характеристики и Упаковки по соответствию из НоменклатурыПоставщика,
	//Переносим значения из колонки СуммаСкидки в СуммаРучнойСкидки, т.к. название реквизита табличной части документа
	//не совпадает с названием реквизита СтрокиДляЗагрузки

	Для Каждого ТекСтрока Из ТЗ Цикл 
		ТекСтрока.КоличествоУпаковок = ТекСтрока.Количество;
		// заполним Количество с учетом единиц измерения
		Если ЗначениеЗаполнено(ТекСтрока.Упаковка) Тогда
			ТекКоэффициент = Справочники.УпаковкиЕдиницыИзмерения.КоэффициентУпаковки(ТекСтрока.Упаковка, ТекСтрока.Номенклатура);
		Иначе
			ТекКоэффициент = 1;
		КонецЕсли;
		ТекСтрока.Количество = ТекСтрока.КоличествоУпаковок * ТекКоэффициент;
	КонецЦикла;

	ДанныеДляОбъекта.Вставить("Шапка", 	ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("Товары", ТЗ);
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

Функция ПодготовитьСтруктуруДляСчетаФактуры(СтрокаДляЗагрузки, ДеревоРазбора, Аванс = Ложь)
	
	ДанныеДляОбъекта = Новый Структура;
	
	ДанныеЗаполненияШапки = Новый Структура;
	ДанныеЗаполненияШапки.Вставить("Номер", ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "Номер"));
	ДанныеЗаполненияШапки.Вставить("ДатаСоставления", ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "ДатаСчетаФактуры"));
	НомерСчетаФактуры = ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "НомерСчетаФактуры");
	Если ЗначениеЗаполнено(НомерСчетаФактуры) Тогда
		ДанныеЗаполненияШапки.Вставить("Корректировочный", Истина);
		НомерИсправления = ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "НомерИсправления");
		ДанныеЗаполненияШапки.Вставить("НомерИсправления", НомерИсправления);
		ДатаИсправления = ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "ДатаИсправления");
		ДанныеЗаполненияШапки.Вставить("ДатаИсправления", ДатаИсправления);
		Если ЗначениеЗаполнено(НомерИсправления) 
			 И ЗначениеЗаполнено(ДатаИсправления) Тогда
			ДанныеЗаполненияШапки.Вставить("Исправление", Истина);
		КонецЕсли;
		ДанныеЗаполненияШапки.Вставить("НомерИсходногоДокумента", НомерСчетаФактуры);
		ДанныеЗаполненияШапки.Вставить("ДатаИсходногоДокумента", ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "ДатаСчетаФактуры"));
		ДанныеЗаполненияШапки.Вставить("НомерИсправленияИсходногоДокумента", ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "НомерИсправленияСчетаФактуры"));
		ДанныеЗаполненияШапки.Вставить("ДатаИсправленияИсходногоДокумента", ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "ДатаИсправленияСчетаФактуры"));
	КонецЕсли;
	
	ДанныеЗаполненияШапки.Вставить("Дата", ТекущаяДатаСеанса());
	
	Если ЗначениеЗаполнено(ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "НомерИсправления")) Тогда
		ДанныеЗаполненияШапки.Вставить("Исправление", Истина);
		ДанныеЗаполненияШапки.Вставить("НомерИсправления", ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "НомерИсправления"));
		ДанныеЗаполненияШапки.Вставить("ДатаИсправления", ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки,  "ДатаИсправления"));
	КонецЕсли;
	
	ВалКод = ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "ВалКод");
	Валюта = Неопределено;
	ЭлектронноеВзаимодействиеПереопределяемый.НайтиСсылкуНаОбъект("Валюты", Валюта, ВалКод);
	ДанныеЗаполненияШапки.Вставить("Валюта", Валюта);
	
	// Получим данные по комиссионеру
	Комиссионер = ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "Комиссионер");
	Если ЗначениеЗаполнено(Комиссионер) Тогда
		// Счет-фактура выставлена комитентом
		ИндексОрганизация = ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "Организация");
		СтрокаОрганизация = ДеревоРазбора.Строки.Найти(ИндексОрганизация, "ИндексСтроки", Истина);
		Покупатель = Справочники.Контрагенты.ПустаяСсылка();
		СсылкаНаОбъектПоИННКПП("Контрагенты", 
			ПолучитьЗначениеРеквизитаДерева(СтрокаОрганизация, "ИНН", Истина, ДеревоРазбора), 
			ПолучитьЗначениеРеквизитаДерева(СтрокаОрганизация, "КПП", Истина, ДеревоРазбора),
			Покупатель);
		ДанныеЗаполненияШапки.Вставить("Покупатель", Покупатель);
		ДанныеЗаполненияШапки.Вставить("Организация", Комиссионер);
	Иначе
		// Счет-фактура на поступление
		ДанныеЗаполненияШапки.Вставить("Организация", ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "Организация", Истина, ДеревоРазбора));
		
	КонецЕсли;
	
	// Данные по контрагенту
	ДанныеЗаполненияШапки.Вставить("Контрагент", ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "Контрагент", Истина, ДеревоРазбора));
	ДанныеЗаполненияШапки.Вставить("Партнер",    ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "Партнер", Истина, ДеревоРазбора));

	ИндексКонтрагент = ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "Контрагент");
	СтрокаКонтрагент = ДеревоРазбора.Строки.Найти(ИндексКонтрагент, "ИндексСтроки", Истина);
	ДанныеЗаполненияШапки.Вставить("ИННКонтрагента", ПолучитьЗначениеРеквизитаДерева(СтрокаКонтрагент, "ИНН", Истина, ДеревоРазбора));
	ДанныеЗаполненияШапки.Вставить("КППКонтрагента", ПолучитьЗначениеРеквизитаДерева(СтрокаКонтрагент, "КПП", Истина, ДеревоРазбора));
	
	ДанныеЗаполненияШапки.Вставить("Сумма",       ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "СуммаДокумента", Истина, ДеревоРазбора));
	ДанныеЗаполненияШапки.Вставить("СуммаНДС",    ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "СумНДС", Истина, ДеревоРазбора));
	
	// Получим документы-основания
	СтрокаДокументыОснования = СтрокаДляЗагрузки.Строки.Найти("ДокументыОснования");
	Если СтрокаДокументыОснования <> Неопределено Тогда
		МассивДокументовОснований = Новый Массив;
		Для Каждого Строка Из СтрокаДокументыОснования.Строки Цикл
			Если ЗначениеЗаполнено(Строка.СсылкаНаОбъект) Тогда
				МассивДокументовОснований.Добавить(Строка.СсылкаНаОбъект);
			КонецЕсли;
		КонецЦикла;
		ДанныеЗаполненияШапки.Вставить("ДокументыОснования", МассивДокументовОснований);
	КонецЕсли;
	
	ДанныеЗаполненияШапки.Вставить("ПолученВЭлектронномВиде", Истина);
	
	ДанныеДляОбъекта.Вставить("Шапка", ДанныеЗаполненияШапки);
	
	Если Аванс Тогда
		Авансы = Документы.СчетФактураПолученныйАванс.ПустаяСсылка().Авансы.Выгрузить();
		Отбор = Новый Структура("Реквизит", "СтрокаТЧ");
		СтрокиТЧ = СтрокаДляЗагрузки.Строки.НайтиСтроки(Отбор);
		Для каждого СтрокаТЧ Из СтрокиТЧ Цикл
			ЗаполнитьСтрокуТЧ(Авансы, СтрокаТЧ.Строки, ДеревоРазбора);
		КонецЦикла;
		ДанныеДляОбъекта.Вставить("Авансы", Авансы);
	КонецЕсли;
	
	Если Не Аванс Тогда
		ЗаполнитьСуммыДляСчетаФактуры(ДанныеДляОбъекта, ДеревоРазбора);
	КонецЕсли;
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

Функция ПодготовитьСтруктуруДляПоступленияУслуг(СтрокаДляЗагрузки, ДеревоРазбора)
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеЗаполненияШапки = Новый Структура;
	ТЗ = Документы.ПриобретениеУслугПрочихАктивов.ПустаяСсылка().Расходы.ВыгрузитьКолонки();
	ТЗ.Колонки.Добавить("НоменклатураПартнера");
	Для Каждого СтрокаРеквизита Из СтрокаДляЗагрузки.Строки Цикл
		Если СтрокаРеквизита.Реквизит = "СписокОписаний" Тогда
			СтрокаРеквизитаОписанийРабот = ПолучитьЗначениеРеквизитаДерева(СтрокаРеквизита, СтрокаРеквизита.Реквизит, Истина, ДеревоРазбора);
			Для Каждого СтрокаРеквизитаОписания Из СтрокаРеквизитаОписанийРабот.Строки Цикл
				Если СтрокаРеквизитаОписания.Строки.Количество() = 0 Тогда
					Реквизит = ПолучитьЗначениеРеквизитаДерева(СтрокаРеквизитаОписания, СтрокаРеквизитаОписания.Реквизит, Истина, ДеревоРазбора);
					Если ЗначениеЗаполнено(Реквизит) Тогда
						ДанныеЗаполненияШапки.Вставить(СтрокаРеквизитаОписания.Реквизит, Реквизит);
					КонецЕсли;
				Иначе
					ЗаполнитьСтрокуТЧ(ТЗ, СтрокаРеквизитаОписания.Строки, ДеревоРазбора);
				КонецЕсли;
				
			КонецЦикла;
		Иначе
			Если СтрокаРеквизита.Строки.Количество() = 0 Тогда // примитивный тип
				Реквизит = ПолучитьЗначениеРеквизитаДерева(СтрокаРеквизита, СтрокаРеквизита.Реквизит, Истина, ДеревоРазбора);
				Если ЗначениеЗаполнено(Реквизит) Тогда
					ДанныеЗаполненияШапки.Вставить(СтрокаРеквизита.Реквизит, Реквизит);
				КонецЕсли;
			Иначе // добавим строку ТЧ
				ЗаполнитьСтрокуТЧ(ТЗ, СтрокаРеквизита.Строки, ДеревоРазбора);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	// спец.значения
	Если ЗначениеЗаполнено(ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "НомерСчетаФактуры")) Тогда // указана счет-фактура
		
	Иначе
		ДанныеЗаполненияШапки.Вставить("НомерВходящегоДокумента",ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "Номер"));
		ДанныеЗаполненияШапки.Вставить("ДатаВходящегоДокумента", ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "Дата"));
	КонецЕсли;
	
	// заполним Характеристики и Упаковки по соответствию из НоменклатурыПоставщика,
	// а также НомерСтрокиДокументаПоставщика
	
	Для Каждого ТекСтрока Из ТЗ Цикл
		Если НЕ ЗначениеЗаполнено(ТекСтрока.Содержание) Тогда
			ТекСтрока.Содержание = ТекСтрока.НоменклатураПартнера;
		КонецЕсли;
	КонецЦикла;

	ДанныеДляОбъекта.Вставить("Шапка", ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("Расходы", ТЗ);
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

Функция ПодготовитьСтруктуруДляЗаявкиНаРасходование(СтрокаДляЗагрузки, ДеревоРазбора)
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеЗаполненияШапки = Новый Структура;
	ЧастичнаяОплата = Истина;
	ТЗ = Документы.ЗаявкаНаРасходованиеДенежныхСредств.ПустаяСсылка().РасшифровкаПлатежа.ВыгрузитьКолонки();
	Для Каждого СтрокаРеквизита Из СтрокаДляЗагрузки.Строки Цикл
		Если СтрокаРеквизита.Строки.Количество()=0 Тогда // примитивный тип
			Реквизит = ПолучитьЗначениеРеквизитаДерева(СтрокаРеквизита, СтрокаРеквизита.Реквизит, Истина, ДеревоРазбора);
			Если ЗначениеЗаполнено(Реквизит) Тогда
				ДанныеЗаполненияШапки.Вставить(СтрокаРеквизита.Реквизит, Реквизит);
			КонецЕсли;
		ИначеЕсли СтрокаРеквизита.Реквизит = "СтрокаТЧ" Тогда // добавим строку ТЧ
			ЗаполнитьСтрокуТЧ(ТЗ, СтрокаРеквизита.Строки, ДеревоРазбора, Истина);
		Иначе
			ЧастичнаяОплата = Ложь;
		КонецЕсли;
	КонецЦикла;
	
	// спец.значения
		
	СтрокаСрокПлатежа = СтрокаДляЗагрузки.Строки.Найти("ДатаОкончанияДействияСчета", "Реквизит");
	ДанныеЗаполненияШапки.Вставить("СрокПлатежа", СтрокаСрокПлатежа.ЗначениеРеквизита);
	
	СтрокаСуммаДокумента = СтрокаДляЗагрузки.Строки.Найти("СуммаИтог", 		"Реквизит");
	СтрокаСуммаНДС 		 = СтрокаДляЗагрузки.Строки.Найти("СуммаНалогаИтог","Реквизит");
	
	Если ЧастичнаяОплата И ЗначениеЗаполнено(СтрокаСуммаДокумента.ЗначениеРеквизита) Тогда
		ДанныеЗаполненияШапки.Вставить("СуммаДокумента", СтрокаСуммаДокумента.ЗначениеРеквизита + СтрокаСуммаНДС.ЗначениеРеквизита);
	Иначе
		ДанныеЗаполненияШапки.Вставить("СуммаДокумента", СтрокаСуммаДокумента.ЗначениеРеквизита);
	КонецЕсли;
	
	ДанныеЗаполненияШапки.Вставить("НомерВходящегоДокумента",ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "НомерДокументаОснования"));
	ДанныеЗаполненияШапки.Вставить("ДатаВходящегоДокумента", ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "ДатаДокументаОснования"));
	
	ДанныеДляОбъекта.Вставить("Шапка", 	ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("РасшифровкаПлатежа", ТЗ);
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

Функция ПодготовитьСтруктуруДляРегистрацииЦен(СтрокаДляЗагрузки, ДеревоРазбора)
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеЗаполненияШапки = Новый Структура;
	ТЗ = Документы.РегистрацияЦенНоменклатурыПоставщика.ПустаяСсылка().Товары.ВыгрузитьКолонки();
	Для Каждого СтрокаРеквизита Из СтрокаДляЗагрузки.Строки Цикл
		Если СтрокаРеквизита.Строки.Количество()=0 Тогда // примитивный тип
			Реквизит = ПолучитьЗначениеРеквизитаДерева(СтрокаРеквизита, СтрокаРеквизита.Реквизит, Истина, ДеревоРазбора);
			Если ЗначениеЗаполнено(Реквизит) Тогда
				ДанныеЗаполненияШапки.Вставить(СтрокаРеквизита.Реквизит, Реквизит);
			КонецЕсли;
		Иначе // добавим строку ТЧ
			ЗаполнитьСтрокуТЧ(ТЗ, СтрокаРеквизита.Строки, ДеревоРазбора); 
		КонецЕсли;
	КонецЦикла;
	
	// спец.значения 
	
	// найдем ВидЦеныПоставщика или создадим новый
	ВидЦеныПоставщика = ОпределитьВидЦеныПоставщика(ДанныеЗаполненияШапки.Партнер, СтрокаДляЗагрузки.Строки.Найти("ТипыЦен").ЗначениеРеквизита);
	
	// заполним Характеристики и Упаковки по соответствию из НоменклатурыПоставщика, а также обязательный реквизит ВидЦеныПоставщика
	Для Каждого ТекСтрока Из ТЗ Цикл 
		Если ЗначениеЗаполнено(ТекСтрока.НоменклатураПартнера) И ЗначениеЗаполнено(ТекСтрока.Номенклатура) Тогда
			Если ЗначениеЗаполнено(ТекСтрока.НоменклатураПартнера.Характеристика) Тогда
				ТекСтрока.Характеристика = ТекСтрока.НоменклатураПартнера.Характеристика;
			КонецЕсли;
			Если ЗначениеЗаполнено(ТекСтрока.НоменклатураПартнера.Упаковка) Тогда
				ТекСтрока.Упаковка = ТекСтрока.НоменклатураПартнера.Упаковка;
			КонецЕсли;
		КонецЕсли;
		ТекСтрока.ВидЦеныПоставщика = ВидЦеныПоставщика;
	КонецЦикла;
	
	ДанныеДляОбъекта.Вставить("Шапка", 	ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("Товары", ТЗ);
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

Функция ПодготовитьСтруктуруДляЗаказаКлиента(СтрокаДляЗагрузки, ДеревоРазбора)
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеЗаполненияШапки = Новый Структура;
	ТЗ = Документы.ЗаказКлиента.ПустаяСсылка().Товары.ВыгрузитьКолонки();
	ТЗЭтапыГрафикаОплаты = Документы.ЗаказКлиента.ПустаяСсылка().ЭтапыГрафикаОплаты.ВыгрузитьКолонки();
	ТЗ.Колонки.Добавить("СуммаСкидки");
	Для Каждого СтрокаРеквизита Из СтрокаДляЗагрузки.Строки Цикл
		Если СтрокаРеквизита.Строки.Количество()=0 Тогда // примитивный тип
			Реквизит = ПолучитьЗначениеРеквизитаДерева(СтрокаРеквизита, СтрокаРеквизита.Реквизит, Истина, ДеревоРазбора);
			Если ЗначениеЗаполнено(Реквизит) Тогда
				ДанныеЗаполненияШапки.Вставить(СтрокаРеквизита.Реквизит, Реквизит);
			КонецЕсли;
		ИначеЕсли СтрокаРеквизита.Реквизит = "СтрокаТЧ" Тогда
			ЗаполнитьСтрокуТЧ(ТЗ, СтрокаРеквизита.Строки, ДеревоРазбора, Истина); 
		ИначеЕсли СтрокаРеквизита.Реквизит = "ЭтапыГрафикаОплаты" Тогда	
			ЗаполнитьСтрокуТЧ(ТЗЭтапыГрафикаОплаты, СтрокаРеквизита.Строки, ДеревоРазбора, Истина); 
		КонецЕсли;
    КонецЦикла;
		
	//Переносим значения из колонки СуммаСкидки в СуммаРучнойСкидки, т.к. название реквизита табличной части документа
	//не совпадает с названием реквизита СтрокиДляЗагрузки
	ТЗ.ЗагрузитьКолонку(ТЗ.ВыгрузитьКолонку("СуммаСкидки"),"СуммаРучнойСкидки");
	
	//Заполним значения по умолчанию в ТЧ
	ТЗ.ЗаполнитьЗначения(Перечисления.ВариантыОбеспечения.НеТребуется, "ВариантОбеспечения");
	ТЗ.ЗаполнитьЗначения(ТекущаяДатаСеанса(), "ДатаОтгрузки");
	
	ДанныеДляОбъекта.Вставить("Шапка", 	ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("Товары", ТЗ);
	ДанныеДляОбъекта.Вставить("ЭтапыГрафикаОплаты",ТЗЭтапыГрафикаОплаты); 
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

Функция ПодготовитьСтруктуруДляЗаказаПоставщику(СтрокаДляЗагрузки, ДеревоРазбора)
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеЗаполненияШапки = Новый Структура;
	ТЗ = Документы.ЗаказПоставщику.ПустаяСсылка().Товары.ВыгрузитьКолонки();
	ТЗЭтапыГрафикаОплаты = Документы.ЗаказПоставщику.ПустаяСсылка().ЭтапыГрафикаОплаты.ВыгрузитьКолонки();
	ТЗ.Колонки.Добавить("СуммаСкидки");
	Для Каждого СтрокаРеквизита Из СтрокаДляЗагрузки.Строки Цикл
		Если СтрокаРеквизита.Строки.Количество()=0 Тогда // примитивный тип
			Реквизит = ПолучитьЗначениеРеквизитаДерева(СтрокаРеквизита, СтрокаРеквизита.Реквизит, Истина, ДеревоРазбора);
			Если ЗначениеЗаполнено(Реквизит) Тогда
				ДанныеЗаполненияШапки.Вставить(СтрокаРеквизита.Реквизит, Реквизит);
			КонецЕсли;
		ИначеЕсли СтрокаРеквизита.Реквизит = "СтрокаТЧ" Тогда // добавим строку ТЧ
			ЗаполнитьСтрокуТЧ(ТЗ, СтрокаРеквизита.Строки, ДеревоРазбора, Истина); 
		ИначеЕсли СтрокаРеквизита.Реквизит = "ЭтапыГрафикаОплаты" Тогда	
			ЗаполнитьСтрокуТЧ(ТЗЭтапыГрафикаОплаты, СтрокаРеквизита.Строки, ДеревоРазбора, Истина); 
		КонецЕсли;
	КонецЦикла;
	
	//Переносим значения из колонки СуммаСкидки в СуммаРучнойСкидки, т.к. название реквизита табличной части документа
	//не совпадает с названием реквизита СтрокиДляЗагрузки
	ТЗ.ЗагрузитьКолонку(ТЗ.ВыгрузитьКолонку("СуммаСкидки"),"СуммаРучнойСкидки");
	// заполним Характеристики и Упаковки по соответствию из НоменклатурыПоставщика
	Для Каждого ТекСтрока Из ТЗ Цикл 
		Если ЗначениеЗаполнено(ТекСтрока.НоменклатураПартнера) И ЗначениеЗаполнено(ТекСтрока.Номенклатура) Тогда
			Если ЗначениеЗаполнено(ТекСтрока.НоменклатураПартнера.Характеристика) Тогда
				ТекСтрока.Характеристика = ТекСтрока.НоменклатураПартнера.Характеристика;
			КонецЕсли;
			Если ЗначениеЗаполнено(ТекСтрока.НоменклатураПартнера.Упаковка) Тогда
				ТекСтрока.Упаковка = ТекСтрока.НоменклатураПартнера.Упаковка;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	ДанныеДляОбъекта.Вставить("Шапка", 			   ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("Товары",			   ТЗ);
	ДанныеДляОбъекта.Вставить("ЭтапыГрафикаОплаты",ТЗЭтапыГрафикаОплаты); 
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

Функция ПодготовитьСтруктуруДляОтчетаКомиссионера(СтрокаДляЗагрузки, ДеревоРазбора)
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеЗаполненияШапки = Новый Структура;
	ТЗ = Документы.ОтчетКомиссионера.ПустаяСсылка().Товары.ВыгрузитьКолонки();
	ПараметрыЗаполненияСтрокиТоваров = ПараметрыЗаполненияСтрокиТоваровОтчетаКомиссионераСведениямиОПрослеживаемости();
	ТЗЭтапыГрафикаОплаты = Документы.ОтчетКомиссионера.ПустаяСсылка().ЭтапыГрафикаОплаты.ВыгрузитьКолонки();
	Для Каждого СтрокаРеквизита Из СтрокаДляЗагрузки.Строки Цикл
		Если СтрокаРеквизита.Строки.Количество()=0 Тогда // примитивный тип
			Реквизит = ПолучитьЗначениеРеквизитаДерева(СтрокаРеквизита, СтрокаРеквизита.Реквизит, Истина, ДеревоРазбора);
			Если ЗначениеЗаполнено(Реквизит) Тогда
				ДанныеЗаполненияШапки.Вставить(СтрокаРеквизита.Реквизит, Реквизит);
			КонецЕсли;
		ИначеЕсли СтрокаРеквизита.Реквизит = "СтрокаТЧ" Тогда // добавим строку ТЧ
			
			НоваяСтрока = ТЗ.Добавить();
			ДанныеПокупателя = Новый Структура("Наименование, ИНН, КПП, ЮрАдрес, ФактАдрес");
			
			Для Каждого ТекСтрока Из СтрокаРеквизита.Строки Цикл
				
				ИмяРеквизитаВБД = ТекСтрока.Реквизит;
				
				Если ИмяРеквизитаВБД = "ПокупательНаименование" Тогда	
					
					НайденноеЗначение = ПолучитьЗначениеРеквизитаДерева(ТекСтрока, ТекСтрока.Реквизит, Истина, ДеревоРазбора);
					ДанныеПокупателя.Наименование = НайденноеЗначение;
					
				ИначеЕсли ИмяРеквизитаВБД = "ПокупательИНН" Тогда	
					
					НайденноеЗначение = ПолучитьЗначениеРеквизитаДерева(ТекСтрока, ТекСтрока.Реквизит, Истина, ДеревоРазбора);
					ДанныеПокупателя.ИНН = НайденноеЗначение;
					
				ИначеЕсли ИмяРеквизитаВБД = "ПокупательКПП" Тогда	
					
					НайденноеЗначение = ПолучитьЗначениеРеквизитаДерева(ТекСтрока, ТекСтрока.Реквизит, Истина, ДеревоРазбора);
					ДанныеПокупателя.КПП = НайденноеЗначение;
					
				ИначеЕсли ИмяРеквизитаВБД = "ПокупательЮрАдрес" Тогда	
					
					НайденноеЗначение = ПолучитьЗначениеРеквизитаДерева(ТекСтрока, ТекСтрока.Реквизит, Истина, ДеревоРазбора);
					ДанныеПокупателя.ЮрАдрес = НайденноеЗначение;
					
				ИначеЕсли ИмяРеквизитаВБД = "ПокупательФактАдрес" Тогда	
					
					НайденноеЗначение = ПолучитьЗначениеРеквизитаДерева(ТекСтрока, ТекСтрока.Реквизит, Истина, ДеревоРазбора);
					ДанныеПокупателя.ФактАдрес = НайденноеЗначение;
					
				ИначеЕсли ИмяРеквизитаВБД = "Сопоставление" Тогда
					
					Сопоставление = ПолучитьЗначениеРеквизитаДерева(ТекСтрока, ТекСтрока.Реквизит, Истина, ДеревоРазбора);
					Если ТипЗнч(Сопоставление) <> Тип("Структура") Тогда
						Продолжить;
					КонецЕсли;
					Если КолонкаСуществует(ТЗ, "Номенклатура")
						И Сопоставление.Свойство("НоменклатураИБ") Тогда
						Если ЗначениеЗаполнено(Сопоставление.НоменклатураИБ) Тогда
							НоваяСтрока.Номенклатура = Сопоставление.НоменклатураИБ;
						КонецЕсли;
					КонецЕсли;
					Если КолонкаСуществует(ТЗ, "Характеристика")
						И Сопоставление.Свойство("ХарактеристикаИБ") Тогда
						Если ЗначениеЗаполнено(Сопоставление.ХарактеристикаИБ) Тогда
							НоваяСтрока.Характеристика = Сопоставление.ХарактеристикаИБ;
						КонецЕсли;
					КонецЕсли;
					Если КолонкаСуществует(ТЗ, "ЕдиницаИзмерения")
						И Сопоставление.Свойство("УпаковкаИБ") Тогда
						Если ЗначениеЗаполнено(Сопоставление.УпаковкаИБ) Тогда
							НоваяСтрока.ЕдиницаИзмерения = Сопоставление.УпаковкаИБ;
						КонецЕсли;
					КонецЕсли;
					
				ИначеЕсли ИмяРеквизитаВБД = "СведенияОПрослеживаемости" Тогда
					СведенияОПрослеживаемости = ПолучитьЗначениеРеквизитаДерева(ТекСтрока, ТекСтрока.Реквизит, Истина, ДеревоРазбора);
					
				ИначеЕсли ТЗ.Колонки.Найти(ИмяРеквизитаВБД) <> Неопределено Тогда
					НайденноеЗначение = ПолучитьЗначениеРеквизитаДерева(ТекСтрока, ТекСтрока.Реквизит, Истина, ДеревоРазбора);
					НоваяСтрока[ИмяРеквизитаВБД] = НайденноеЗначение;
				КонецЕсли;
				
			КонецЦикла;
			
			// Попробуем найти среди существующих
			Покупатель = Справочники.Контрагенты.ПустаяСсылка();
			СсылкаНаОбъектПоИННКПП("Контрагенты", ДанныеПокупателя.ИНН, ДанныеПокупателя.КПП, Покупатель);
			
			Если НЕ ЗначениеЗаполнено(Покупатель) Тогда
				Покупатель = СоздатьКонтрагентаВБД(ДанныеПокупателя)
			КонецЕсли;
			
			НоваяСтрока.Покупатель = Покупатель;
			
			ЗаполнитьСтрокуТоваровОтчетаКомиссионераСведениямиОПрослеживаемости(НоваяСтрока,
																				ТЗ,
																				СведенияОПрослеживаемости,
																				ПараметрыЗаполненияСтрокиТоваров);
			
		ИначеЕсли СтрокаРеквизита.Реквизит = "ЭтапыГрафикаОплаты" Тогда	
			ЗаполнитьСтрокуТЧ(ТЗЭтапыГрафикаОплаты, СтрокаРеквизита.Строки, ДеревоРазбора);
		КонецЕсли;
	КонецЦикла;
	
	ДанныеЗаполненияШапки.Вставить("НомерВходящегоДокумента",ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "Номер"));
	ДанныеЗаполненияШапки.Вставить("ДатаВходящегоДокумента", ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "Дата"));

	Для Каждого ТекСтрока Из ТЗ Цикл 
		// заполним Количество с учетом единиц измерения
		Если НЕ ЗначениеЗаполнено(ТекСтрока.Количество) Тогда
			Если ЗначениеЗаполнено(ТекСтрока.Упаковка) Тогда
				ТекКоэффициент = Справочники.УпаковкиЕдиницыИзмерения.КоэффициентУпаковки(ТекСтрока.Упаковка, ТекСтрока.Номенклатура);
			Иначе
				ТекКоэффициент = 1;
			КонецЕсли;
			ТекСтрока.Количество = ТекСтрока.КоличествоУпаковок*ТекКоэффициент;
		КонецЕсли;
		
		ТекущийПроцентНДС = УчетНДСУПКлиентСервер.ЗначениеСтавкиНДС(ТекСтрока.СтавкаНДС);
		ТекСтрока.СуммаПродажиНДС = Окр(ТекСтрока.СуммаПродажи * ТекущийПроцентНДС / (100 + ТекущийПроцентНДС), 2, РежимОкругления.Окр15как20);
		
	КонецЦикла;
	
	Если ТЗ.Итог("СуммаПродажиНДС") > 0 Тогда
		ДанныеЗаполненияШапки.Вставить("НалогообложениеНДС", Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС);
	Иначе
		ДанныеЗаполненияШапки.Вставить("НалогообложениеНДС", Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС);
	КонецЕсли;
	
	ТЗ.ЗагрузитьКолонку(ТЗ.ВыгрузитьКолонку("Сумма"), "СуммаСНДС");
	ТЗ.Колонки.Удалить("Сумма");
	ДанныеДляОбъекта.Вставить("Шапка", 	ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("Товары", ТЗ);
	ДанныеДляОбъекта.Вставить("ЭтапыГрафикаОплаты",ТЗЭтапыГрафикаОплаты); 
	
	Возврат ДанныеДляОбъекта;

КонецФункции

Функция ПодготовитьСтруктуруДляОтчетаКомиссионераОСписании(СтрокаДляЗагрузки, ДеревоРазбора)
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеЗаполненияШапки = Новый Структура;
	ТЗ = Документы.ОтчетКомиссионераОСписании.ПустаяСсылка().Товары.ВыгрузитьКолонки();
	ПараметрыЗаполненияСтрокиТоваров = ПараметрыЗаполненияСтрокиТоваровОтчетаКомиссионераСведениямиОПрослеживаемости();
	ПараметрыЗаполненияСтрокиТоваров.ЭтоОтчетКомиссионераОПродажах = Ложь;
	
	Для Каждого СтрокаРеквизита Из СтрокаДляЗагрузки.Строки Цикл
		Если СтрокаРеквизита.Строки.Количество()=0 Тогда // примитивный тип
			Реквизит = ПолучитьЗначениеРеквизитаДерева(СтрокаРеквизита, СтрокаРеквизита.Реквизит, Истина, ДеревоРазбора);
			Если ЗначениеЗаполнено(Реквизит) Тогда
				ДанныеЗаполненияШапки.Вставить(СтрокаРеквизита.Реквизит, Реквизит);
			КонецЕсли;
		ИначеЕсли СтрокаРеквизита.Реквизит = "СтрокаТЧ" Тогда // добавим строку ТЧ
			
			НоваяСтрока = ТЗ.Добавить();
			Для Каждого ТекСтрока Из СтрокаРеквизита.Строки Цикл
				
				ИмяРеквизитаВБД = ТекСтрока.Реквизит;
				
				Если ТЗ.Колонки.Найти(ИмяРеквизитаВБД) <> Неопределено Тогда
					НайденноеЗначение = ПолучитьЗначениеРеквизитаДерева(ТекСтрока, ТекСтрока.Реквизит, Истина, ДеревоРазбора);
					НоваяСтрока[ИмяРеквизитаВБД] = НайденноеЗначение;
				КонецЕсли;
				
				// Читаем данные для прослеживаемости
				Если ИмяРеквизитаВБД = "СведенияОПрослеживаемости" Тогда
					СведенияОПрослеживаемости = ПолучитьЗначениеРеквизитаДерева(ТекСтрока, ТекСтрока.Реквизит, Истина, ДеревоРазбора);
				КонецЕсли;
				
			КонецЦикла;
			
			ЗаполнитьСтрокуТоваровОтчетаКомиссионераСведениямиОПрослеживаемости(НоваяСтрока,
																				ТЗ,
																				СведенияОПрослеживаемости,
																				ПараметрыЗаполненияСтрокиТоваров);
			
		КонецЕсли;
	КонецЦикла;
	
	ДанныеЗаполненияШапки.Вставить("НомерВходящегоДокумента",ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "Номер"));
	ДанныеЗаполненияШапки.Вставить("ДатаВходящегоДокумента", ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "Дата"));

	Для Каждого ТекСтрока Из ТЗ Цикл 
		// заполним Количество с учетом единиц измерения
		Если НЕ ЗначениеЗаполнено(ТекСтрока.Количество) Тогда
			Если ЗначениеЗаполнено(ТекСтрока.Упаковка) Тогда
				ТекКоэффициент = Справочники.УпаковкиЕдиницыИзмерения.КоэффициентУпаковки(ТекСтрока.Упаковка, ТекСтрока.Номенклатура);
			Иначе
				ТекКоэффициент = 1;
			КонецЕсли;
			ТекСтрока.Количество = ТекСтрока.КоличествоУпаковок*ТекКоэффициент;
		КонецЕсли;
	КонецЦикла;
	
	ДанныеДляОбъекта.Вставить("Шапка", 	ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("Товары", ТЗ);
	
	Возврат ДанныеДляОбъекта;

КонецФункции

Функция ПодготовитьСтруктуруДляКорректировкиПоступления(СтрокаДляЗагрузки, ДеревоРазбора)
	
	ДанныеДляОбъекта = Новый Структура();
	ДанныеЗаполнения = Новый Структура();
	Товары = Документы.КорректировкаПриобретения.ПустаяСсылка().Товары.ВыгрузитьКолонки();
	ШтрихкодыУпаковок = ЭлектронноеВзаимодействиеИСМП.НоваяТаблицаШтрихкодыУпаковок();
	
	Для Каждого СтрокаРеквизита Из СтрокаДляЗагрузки.Строки Цикл
		
		Если СтрокаРеквизита.Реквизит = "СписокОписаний" Тогда
			СтрокаРеквизитаОписанийРабот = ПолучитьЗначениеРеквизитаДерева(СтрокаРеквизита, СтрокаРеквизита.Реквизит, Истина, ДеревоРазбора);
			Для Каждого СтрокаРеквизитаОписания Из СтрокаРеквизитаОписанийРабот.Строки Цикл
				Если СтрокаРеквизитаОписания.Строки.Количество() = 0 Тогда
					Реквизит = ПолучитьЗначениеРеквизитаДерева(СтрокаРеквизитаОписания, СтрокаРеквизитаОписания.Реквизит, Истина, ДеревоРазбора);
					Если ЗначениеЗаполнено(Реквизит) Тогда
						ДанныеЗаполнения.Вставить(СтрокаРеквизитаОписания.Реквизит, Реквизит);
					КонецЕсли;
				Иначе
					ЗаполнитьСтрокуТЧ(Товары, СтрокаРеквизитаОписания.Строки, ДеревоРазбора);
				КонецЕсли;
				
			КонецЦикла;
		Иначе
			Если СтрокаРеквизита.Строки.Количество() = 0 Тогда
				Реквизит = ПолучитьЗначениеРеквизитаДерева(СтрокаРеквизита, СтрокаРеквизита.Реквизит, Истина, ДеревоРазбора);
				Если ЗначениеЗаполнено(Реквизит) Тогда
					Если СтрокаРеквизита.Реквизит = "Основание" Тогда
						ИмяРеквизита = "ДокументОснование";
					Иначе
						ИмяРеквизита = СтрокаРеквизита.Реквизит;
					КонецЕсли;
					ДанныеЗаполнения.Вставить(ИмяРеквизита, Реквизит);
				КонецЕсли;
				
			Иначе // добавим строку ТЧ
				ЗаполнитьСтрокуТЧ(Товары, СтрокаРеквизита.Строки, ДеревоРазбора); 
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	ДанныеЗаполнения.Вставить("НомерВходящегоДокумента",ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "Номер"));
	ДанныеЗаполнения.Вставить("ДатаВходящегоДокумента", ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "Дата"));
	
	// Дополним ДанныеЗаполнения реквизитами основания
	ДокументОснование = Неопределено;
	Если ДанныеЗаполнения.Свойство("ДокументОснование") И ЗначениеЗаполнено(ДанныеЗаполнения.ДокументОснование) Тогда
		
		ДокументОснование = ДанныеЗаполнения.ДокументОснование; 
		
		ТекстЗапроса = "";
		Если ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.ПриобретениеТоваровУслуг") Тогда 
			
			ТекстЗапроса = 
			"ВЫБРАТЬ
			|	ДанныеДокумента.Соглашение			 КАК Соглашение,
			|	ДанныеДокумента.Договор				 КАК Договор,
			|	ДанныеДокумента.Склад				 КАК Склад,
			|	ДанныеДокумента.Валюта				 КАК Валюта,
			|	ДанныеДокумента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
			|	ДанныеДокумента.НалогообложениеНДС	 КАК НалогообложениеНДС,
			|	ДанныеДокумента.Подразделение		 КАК Подразделение,
			|	ДанныеДокумента.Сделка				 КАК Сделка,
			|	ДанныеДокумента.ЦенаВключаетНДС		 КАК ЦенаВключаетНДС,
			|	ДанныеДокумента.ПоступлениеПоЗаказам КАК ПоступлениеПоЗаказам
			|ИЗ
			|	Документ.ПриобретениеТоваровУслуг КАК ДанныеДокумента
			|ГДЕ
			|	ДанныеДокумента.Ссылка = &ДокументОснование";
			
		ИначеЕсли ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.ПриобретениеУслугПрочихАктивов") Тогда 
			
			ТекстЗапроса =
			"ВЫБРАТЬ
			|	ДанныеДокумента.Ссылка				 КАК ДокументОснование,
			|	ДанныеДокумента.Партнер				 КАК Партнер,
			|	ДанныеДокумента.Контрагент			 КАК Контрагент,
			|	ДанныеДокумента.Соглашение			 КАК Соглашение,
			|	ДанныеДокумента.Организация			 КАК Организация,
			|	ДанныеДокумента.Договор				 КАК Договор,
			|	ДанныеДокумента.Валюта				 КАК Валюта,
			|	ДанныеДокумента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
			|	ДанныеДокумента.НалогообложениеНДС	 КАК НалогообложениеНДС,
			|	ДанныеДокумента.Подразделение		 КАК Подразделение,
			|	ДанныеДокумента.ЦенаВключаетНДС		 КАК ЦенаВключаетНДС,
			|	Ложь								 КАК ПоступлениеПоЗаказам
			|
			|ИЗ
			|	Документ.ПриобретениеУслугПрочихАктивов КАК ДанныеДокумента
			|ГДЕ
			|	ДанныеДокумента.Ссылка = &ДокументОснование";
			
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ТекстЗапроса) Тогда
			
			Запрос = Новый Запрос();
			Запрос.УстановитьПараметр("ДокументОснование", ДокументОснование);
			Запрос.Текст = ТекстЗапроса;
			
			РезультатЗапроса = Запрос.Выполнить();
			
			Для Каждого Колонка Из РезультатЗапроса.Колонки Цикл
				ДанныеЗаполнения.Вставить(Колонка.Имя);
			КонецЦикла;
			
			Выборка = РезультатЗапроса.Выбрать();
			Если Выборка.Следующий() Тогда
				ЗаполнитьЗначенияСвойств(ДанныеЗаполнения, Выборка);
			КонецЕсли;
			
		КонецЕсли;
		
	Иначе
		
		Если Товары.Итог("СуммаНДС") > 0 Тогда
			ДанныеЗаполнения.Вставить("НалогообложениеНДС", Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС);
		Иначе	
			ДанныеЗаполнения.Вставить("НалогообложениеНДС", Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС);
		КонецЕсли;
		ДанныеЗаполнения.Вставить("ЦенаВключаетНДС", Ложь);
		
	КонецЕсли;
	
	// Вид операции ЭД определяет хоз. операцию документа
	ВидОперацииЭД = ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "ВидОперации", Истина, ДеревоРазбора);
	Если ВидОперацииЭД = Перечисления.ВидыОперацийЭД.Исправление Тогда
		ДанныеЗаполнения.Вставить("ХозяйственнаяОперация", Перечисления.ХозяйственныеОперации.ИсправлениеОшибок);
	Иначе
		ДанныеЗаполнения.Вставить("ХозяйственнаяОперация", Перечисления.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон);
	КонецЕсли;
	
	ЭтоКорректировкаПриобретенияУслуг = (ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.ПриобретениеУслугПрочихАктивов"));
	Для Каждого ТекСтрока Из Товары Цикл 
		ТекСтрока.КоличествоУпаковок = ТекСтрока.Количество;
		// Заполним Количество с учетом единиц измерения
		Если ЗначениеЗаполнено(ТекСтрока.Упаковка) Тогда
			ТекКоэффициент = Справочники.УпаковкиЕдиницыИзмерения.КоэффициентУпаковки(ТекСтрока.Упаковка, ТекСтрока.Номенклатура);
		Иначе
			ТекКоэффициент = 1;
		КонецЕсли;
		ТекСтрока.Количество = ТекСтрока.КоличествоУпаковок * ТекКоэффициент;
		
		Если ЭтоКорректировкаПриобретенияУслуг Тогда
			ТекСтрока.Содержание = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ТекСтрока.НоменклатураПартнера, "Наименование");
			ТекСтрока.НоменклатураПартнера = Неопределено;
		КонецЕсли;
		
	КонецЦикла;
	
	ДанныеДляОбъекта.Вставить("Шапка",  ДанныеЗаполнения);
	ДанныеДляОбъекта.Вставить("Товары", Товары);
	ДанныеДляОбъекта.Вставить("ШтрихкодыУпаковок", ШтрихкодыУпаковок);
	
	Возврат ДанныеДляОбъекта;

КонецФункции

Функция ПараметрыМассыПрописью(Масса, КоэффициентПересчетаВТонны)
	
	МассаТонны = Масса * КоэффициентПересчетаВТонны;
	Если МассаТонны > 1 Тогда
		Коэффициент = 1;
		СтрокаФормат = "т, т, т, ж, кг, кг, кг, м, " + ?(Окр(МассаТонны) = МассаТонны, "0", "3");
	ИначеЕсли МассаТонны * 1000 > 1 Тогда
		Коэффициент = 1000;
		СтрокаФормат = "кг, кг, кг, м, г, г, г, м, " + ?(Окр(МассаТонны * Коэффициент) = МассаТонны * Коэффициент, "0", "3");
	Иначе
		Коэффициент = 1000000;
		СтрокаФормат = "г, г, г, м, г, г, г, м, 0";
	КонецЕсли;
	
	Возврат Новый Структура("Формат, Коэффициент", СтрокаФормат, Коэффициент * КоэффициентПересчетаВТонны);
	
КонецФункции

Функция НайтиПеречисление(Наименование, ПредставлениеПеречисления)
	
	НайденноеЗначение = Неопределено;
	Если Наименование = "НДС" Тогда
		ИмяПеречисления = "СтавкиНДС";
		Если НЕ ТипЗнч(ПредставлениеПеречисления)=Тип("СправочникСсылка.СтавкиНДС") Тогда // определяем по числу		
			Соответствие = Новый Соответствие;
			ЗаполнитьСоответствиеСтавокНДС(Соответствие);
			Значение = Неопределено;
			Если ЗначениеЗаполнено(ПредставлениеПеречисления) Тогда
				Значение = Соответствие.Получить(ПредставлениеПеречисления);
			КонецЕсли;
			
			Возврат Значение;
		Иначе
			Возврат ПредставлениеПеречисления
		КонецЕсли;
	ИначеЕсли Наименование = "ТипНоменклатуры" Тогда
		ИмяПеречисления = "ТипыНоменклатуры";
	ИначеЕсли Наименование = "ТипыНалогообложенияНДС" Тогда
		ИмяПеречисления = "ТипыНалогообложенияНДС";	
	ИначеЕсли Наименование = "СпособыРасчетаКомиссионногоВознаграждения" Тогда
		ИмяПеречисления = "СпособыРасчетаКомиссионногоВознаграждения";	
	ИначеЕсли Наименование = "ВариантыКонтроляОплатыКлиентом" Тогда
		ИмяПеречисления = "ВариантыКонтроляОплатыКлиентом";	
	ИначеЕсли Наименование = "ВариантыКонтроляОплатыПоставщику" Тогда
		ИмяПеречисления = "ВариантыКонтроляОплатыПоставщику";			
	ИначеЕсли Наименование = "ФормыОплаты" Тогда
		ИмяПеречисления = "ФормыОплаты";	
	ИначеЕсли Наименование = "СпособРасчета" Тогда
		ИмяПеречисления = "СпособыРасчетаКомиссионногоВознаграждения";	
		Если ПредставлениеПеречисления = "От суммы" Тогда
			ПредставлениеПеречисления = НСтр("ru = 'Процент от суммы продажи'");
		ИначеЕсли ПредставлениеПеречисления = "От разницы" Тогда
			ПредставлениеПеречисления = НСтр("ru = 'Процент от разности суммы продажи и суммы комитента'");
		КонецЕсли;	
	Иначе
		Возврат НайденноеЗначение;
	КонецЕсли;
	
	Для Каждого ЭлПеречисления Из Метаданные.Перечисления[ИмяПеречисления].ЗначенияПеречисления Цикл
		Если Врег(ЭлПеречисления.Синоним) = Врег(ПредставлениеПеречисления) тогда
			НайденноеЗначение = Перечисления[ИмяПеречисления][ЭлПеречисления.Имя];
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Возврат НайденноеЗначение;
	
КонецФункции

Функция ПолучитьДанныеПривязкиСтрокЗаказов(Товары)
	
	УстановитьПривилегированныйРежим(Истина);
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Товары.Номенклатура КАК Номенклатура,
	|	Товары.Количество КАК Количество,
	|	Товары.ЗаказПоставщику КАК ЗаказПоставщику
	|ПОМЕСТИТЬ Товары
	|ИЗ
	|	&Товары КАК Товары
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ТаблицаЗаказы.ЗаказПоставщику КАК ЗаказПоставщику,
	|	ТаблицаЗаказы.Номенклатура КАК Номенклатура,
	|	ТаблицаЗаказы.Характеристика КАК Характеристика,
	|	ТаблицаЗаказы.КодСтроки КАК КодСтроки,
	|	ТаблицаЗаказы.Склад КАК Склад,
	|	ТаблицаЗаказы.КОформлению КАК КОформлениюОстаток
	|ПОМЕСТИТЬ ЗаказыПоставщикам
	|ИЗ
	|	(ВЫБРАТЬ
	|		ЗаказыОстатки.ЗаказПоставщику КАК ЗаказПоставщику,
	|		ЗаказыОстатки.Номенклатура КАК Номенклатура,
	|		ЗаказыОстатки.Характеристика КАК Характеристика,
	|		ЗаказыОстатки.КодСтроки КАК КодСтроки,
	|		ЗаказыОстатки.Склад КАК Склад,
	|		ЗаказыОстатки.КОформлениюОстаток КАК КОформлению
	|	ИЗ
	|		РегистрНакопления.ЗаказыПоставщикам.Остатки(
	|				,
	|				(Номенклатура, ЗаказПоставщику) В
	|					(ВЫБРАТЬ
	|						Товары.Номенклатура КАК Номенклатура,
	|						Товары.ЗаказПоставщику КАК ЗаказПоставщику
	|					ИЗ
	|						Товары КАК Товары)) КАК ЗаказыОстатки
	|	ГДЕ
	|		ЗаказыОстатки.КОформлениюОстаток > 0) КАК ТаблицаЗаказы
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Товары.Номенклатура,
	|	Товары.Количество,
	|	Товары.ЗаказПоставщику,
	|	ЗаказыПоставщикам.КодСтроки,
	|	ЗаказыПоставщикам.Склад,
	|	ЗаказыПоставщикам.Характеристика
	|ИЗ
	|	Товары КАК Товары
	|		ЛЕВОЕ СОЕДИНЕНИЕ ЗаказыПоставщикам КАК ЗаказыПоставщикам
	|		ПО Товары.Номенклатура = ЗаказыПоставщикам.Номенклатура
	|			И Товары.ЗаказПоставщику = ЗаказыПоставщикам.ЗаказПоставщику
	|			И Товары.Количество <= ЗаказыПоставщикам.КОформлениюОстаток";
	Запрос.УстановитьПараметр("Товары", Товары);
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции	

Функция НайтиОбъектВДереве(ДеревоРазбора, ИндексИскомойСтроки)
	
	СсылкаНаОбъект = Неопределено;
	
	Если ЗначениеЗаполнено(ИндексИскомойСтроки) Тогда
		НайденнаяСтрока = ДеревоРазбора.Строки.Найти(ИндексИскомойСтроки, "ИндексСтроки", Истина); // строка с объектом
	КонецЕсли;
	
	Если НайденнаяСтрока <> Неопределено Тогда
		Если ЗначениеЗаполнено(НайденнаяСтрока.СсылкаНаОбъект) Тогда // есть ссылка на объект БД
			СсылкаНаОбъект = НайденнаяСтрока.СсылкаНаОбъект;
		КонецЕсли;
	КонецЕсли;
	
	Возврат СсылкаНаОбъект;
	
КонецФункции

Процедура ПерезаполнениеЗначенийРеквизитовШапки(ТекущийОбъект, ДанныеЗаполнения)
	
	МетаданныеОбъекта = ТекущийОбъект.Метаданные();
	
	Для Каждого Строка Из ДанныеЗаполнения Цикл
		
		Если ЗначениеЗаполнено(Строка.Ключ) 
			 И МетаданныеОбъекта.Реквизиты.Найти(Строка.Ключ) <> Неопределено
			 И ЗначениеЗаполнено(Строка.Значение)
			 И ТекущийОбъект[Строка.Ключ] <> Строка.Значение Тогда
			ТекущийОбъект[Строка.Ключ] = Строка.Значение;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ЗаполнитьРеквизитыОбъектаПоСоответствиюИмен(СтрокаМассива, ОбъектМетаданных)
		
	Для Каждого ТекСтрока Из СтрокаМассива.Строки Цикл
		Если НЕ ЗначениеЗаполнено(ТекСтрока.ЗначениеРеквизита) Тогда
			Продолжить;
		КонецЕсли;
		
		Если ОбщегоНазначения.ЭтоСтандартныйРеквизит(ОбъектМетаданных.Метаданные().СтандартныеРеквизиты, ТекСтрока.Реквизит) Тогда
			ОбъектМетаданных[ТекСтрока.Реквизит] = ТекСтрока.ЗначениеРеквизита;
		ИначеЕсли ОбъектМетаданных.Метаданные().Реквизиты.Найти(ТекСтрока.Реквизит) <> Неопределено Тогда
			Если ЗначениеЗаполнено(ТекСтрока.СсылкаНаОбъект) Тогда
				ОбъектМетаданных[ТекСтрока.Реквизит] = ТекСтрока.СсылкаНаОбъект;
			Иначе
				ОбъектМетаданных[ТекСтрока.Реквизит] = ТекСтрока.ЗначениеРеквизита;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Функция ОпределитьВидЦеныПоставщика(Партнер, ТипыЦен)
	
	ПараметрыЦены = ТипыЦен[0];
	ИспользоватьНесколькоВалют = Константы.ИспользоватьНесколькоВалют.Получить();
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ВидыЦенПоставщиков.Ссылка
	               |ИЗ
	               |	Справочник.ВидыЦенПоставщиков КАК ВидыЦенПоставщиков
	               |ГДЕ
	               |	ВидыЦенПоставщиков.Владелец = &Владелец
	               |	И ВидыЦенПоставщиков.ЦенаВключаетНДС = &ЦенаВключаетНДС";
				   
	Запрос.УстановитьПараметр("Владелец", 		 Партнер);	
	Запрос.УстановитьПараметр("Валюта", 		 ПараметрыЦены.Валюта);
	Запрос.УстановитьПараметр("ЦенаВключаетНДС", ПараметрыЦены.ВключаетНДС);
	
	Если ИспользоватьНесколькоВалют Тогда
		Запрос.Текст = Запрос.Текст + " И ВидыЦенПоставщиков.Валюта.Код = &Валюта";
	КонецЕсли;
	
	Результат = Запрос.Выполнить().Выбрать();
	
	Если Результат.Следующий() Тогда
		ТипЦенДляТЧ = Результат.Ссылка;
	Иначе
		ТипЦенДляТЧ = Справочники.ВидыЦенПоставщиков.СоздатьЭлемент();
		ТипЦенДляТЧ.Наименование =    "Основной";
		ТипЦенДляТЧ.Владелец = 		  Партнер;
		ТипЦенДляТЧ.ЦенаВключаетНДС = ПараметрыЦены.ВключаетНДС;
		Если ИспользоватьНесколькоВалют Тогда
			ТипЦенДляТЧ.Валюта =  	  Справочники.Валюты.НайтиПоКоду(ПараметрыЦены.Валюта);
		КонецЕсли;
		
		Попытка
			ТипЦенДляТЧ.Записать();
		Исключение
			Текст = НСтр("ru = 'Создание элемента справочника ""Виды цен поставщиков"".'", ОбщегоНазначения.КодОсновногоЯзыка());
			ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка,,,ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
			ВызватьИсключение;
		КонецПопытки;
	КонецЕсли;
	
	Возврат ТипЦенДляТЧ.Ссылка
	
КонецФункции

Процедура ЗаполнитьСоглашениеПоСтатистике(Объект)
	
	ОписаниеРеквизитов = Новый Структура;
	Параметры = ЗаполнениеОбъектовПоСтатистике.ПараметрыЗаполняемыхРеквизитов();
	Параметры.РазрезыСбораСтатистики.ИспользоватьТолькоЗаполненные = "Партнер, Валюта, ЦенаВключаетНДС";
	ЗаполнениеОбъектовПоСтатистике.ДобавитьОписаниеЗаполняемыхРеквизитов(ОписаниеРеквизитов, "Соглашение", Параметры);
	ЗаполнениеОбъектовПоСтатистике.ЗаполнитьРеквизитыОбъекта(Объект, Неопределено, ОписаниеРеквизитов);
	
КонецПроцедуры

Функция ПолучитьДатуВремяИзСтроки(ДатаВремя)
	
	Результат = Неопределено;
	ДатаВремя = СтрЗаменить(ДатаВремя, "-", "");
	ДатаВремя = СтрЗаменить(ДатаВремя, ":", "");
	Если СтрДлина(ДатаВремя) - СтрНайти(ДатаВремя, " ") = 5 Тогда // время в формате Ч:ММ:СС
		ДатаВремя = СтрЗаменить(ДатаВремя, " ", "0");
	ИначеЕсли СтрНайти(ДатаВремя, "T") > 0 Тогда //время в формате ГГГГММДДTЧЧММСС
		ДатаВремя = СтрЗаменить(ДатаВремя, "T", "");
	Иначе // время в формате ЧЧ:ММ:СС
		ДатаВремя = СтрЗаменить(ДатаВремя, " ", "");
	КонецЕсли;
	
	ОписаниеТипа = Новый ОписаниеТипов("Дата");
	Результат = ОписаниеТипа.ПривестиЗначение(ДатаВремя);  // дата и время в виде "ГГГГММДДЧЧММСС"
	Если Не ЗначениеЗаполнено(Результат) Тогда
		Результат = ОписаниеТипа.ПривестиЗначение(Лев(ДатаВремя, 8));  // только дата "ГГГГММДД"
	КонецЕсли;

	Возврат Результат;
	
КонецФункции

Функция ГруппаДоступаПартнера()
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
	|	Партнеры.Ссылка,
	|	Партнеры.ГруппаДоступа
	|ИЗ
	|	Справочник.Партнеры КАК Партнеры
	|ГДЕ
	|	НЕ Партнеры.ПометкаУдаления
	|	И НЕ Партнеры.ГруппаДоступа = ЗНАЧЕНИЕ(Справочник.ГруппыДоступаПартнеров.ПустаяСсылка)");
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат Справочники.ГруппыДоступаПартнеров.ПустаяСсылка();
	КонецЕсли;
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	Возврат Выборка.ГруппаДоступа;
	
КонецФункции

Функция ОпределитьПризнакТовара(Товар, ДокументОтгрузки)
	
	Если ТипЗнч(ДокументОтгрузки) = Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда
		Если ДокументОтгрузки.ВариантОформленияПродажи = Перечисления.ВариантыОформленияПродажи.АктНаПередачуПрав Тогда
			Возврат "4"; // Имущественные права;
		КонецЕсли;
	КонецЕсли;
	Если ЗначениеЗаполнено(Товар) Тогда
		Если Товар.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Товар Тогда
			Возврат "1"; // Имущество
		ИначеЕсли Товар.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Работа Тогда
			Возврат "2"; // Работа			
		ИначеЕсли Товар.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Услуга Тогда
			Возврат "3"; // Услуга
		Иначе
			Возврат "5"; // Иное
		КонецЕсли;
	Иначе
		Возврат "5"; // Иное
	КонецЕсли;
	
КонецФункции

Процедура ЗаполнитьПрослеживаемостьДляРеализацииАктивов(Приемник, Источник, ДанныеПрослеживаемости, ВыводитьКодыТНВЭД)

	ПараметрыПоиска = Новый Структура();
	ПараметрыПоиска.Вставить("СчетФактура", Источник.Ссылка);
	
	Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(Источник, "НомерСтрокиИсходногоСФ") Тогда
		ПараметрыПоиска.Вставить("НомерСтрокиСФ", ?(ЗначениеЗаполнено(Источник.НомерСтрокиИсходногоСФ),
													Источник.НомерСтрокиИсходногоСФ,
													Источник.НомерСтроки));
	Иначе
		ПараметрыПоиска.Вставить("НомерСтрокиСФ", Источник.НомерСтроки);
	КонецЕсли;
	
	ТаблицаДанныхПрослеживаемости = ДанныеПрослеживаемости.Выгрузить();
	СтрокиДанных = ТаблицаДанныхПрослеживаемости.НайтиСтроки(ПараметрыПоиска);
	
	СведенияОТаможеннойДекларации	= ПустаяТаблицаСведенияОТаможеннойДекларации();
	СведенияОПрослеживаемости		= ПустаяТаблицаСведенияОПрослеживаемостиУПД();
	
	КодВидаТовара = "";
	
	Для Каждого СтрокаДанных Из СтрокиДанных Цикл
		Если ЗначениеЗаполнено(СтрокаДанных.КодТНВЭД) Тогда
			КодВидаТовара = СтрокаДанных.КодТНВЭД;
		КонецЕсли;
		
		СтрокаТД = СведенияОТаможеннойДекларации.Добавить();
		СтрокаТД.ТаможеннаяДекларацияНомер = СокрЛП(Строка(СтрокаДанных.НомерГТД));
		
		Если ЗначениеЗаполнено(СтрокаДанных.СтранаПроисхожденияКод) Тогда
			СтрокаТД.СтранаПроисхожденияКод = СтрокаДанных.СтранаПроисхожденияКод;
		КонецЕсли;
		
		СтрокаПрослеживаемости = СведенияОПрослеживаемости.Добавить();
		СтрокаПрослеживаемости.НомерТовара					= СокрЛП(Строка(СтрокаДанных.НомерТовара));
		СтрокаПрослеживаемости.ЕдиницаИзмеренияКод			= СокрЛП(СтрокаДанных.ЕдиницаИзмеренияКод);
		СтрокаПрослеживаемости.ЕдиницаИзмеренияНаименование	= СокрЛП(СтрокаДанных.ЕдиницаИзмеренияНаименование);
		СтрокаПрослеживаемости.Количество					= СтрокаДанных.Количество;
		СтрокаПрослеживаемости.СтоимостьБезНДС				= Окр(СтрокаДанных.СуммаПоРНПТ, 2);
	КонецЦикла;
	
	Если ЗначениеЗаполнено(КодВидаТовара)
		И ВыводитьКодыТНВЭД Тогда
		
		Приемник.КодВидаТовара = КодВидаТовара;
		
	КонецЕсли;

	Если Не ЗначениеЗаполнено(Приемник.СведенияОТаможеннойДекларации) Тогда
		Приемник.СведенияОТаможеннойДекларации = СведенияОТаможеннойДекларации;
		
		ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(
			Приемник.СведенияОТаможеннойДекларации,
			"СтранаПроисхожденияКод",
			,
			,
			НСтр("ru = 'Не заполнен код страны происхождения'"));
	КонецЕсли;
	
	Приемник.СведенияОПрослеживаемости = СведенияОПрослеживаемости;
	
КонецПроцедуры

Функция ИнициализацияТаблицыРеквизитовОбъектов()
	
	ТаблицаРеквизитов = Новый ТаблицаЗначений;
	
	Колонки = ТаблицаРеквизитов.Колонки;
	Колонки.Добавить("Порядок",                    Новый ОписаниеТипов("Число"));
	Колонки.Добавить("ИмяОбъекта",                 Новый ОписаниеТипов("Строка"));
	Колонки.Добавить("ИмяТабличнойЧасти",          Новый ОписаниеТипов("Строка"));
	Колонки.Добавить("РеквизитыОбъекта",           Новый ОписаниеТипов("Строка"));
	Колонки.Добавить("СтруктураРеквизитовОбъекта", Новый ОписаниеТипов("Структура"));
	
	ТаблицаРеквизитов.Индексы.Добавить("ИмяОбъекта");
	
	Возврат ТаблицаРеквизитов;
	
КонецФункции

Процедура ДобавитьДопополнительныеДанныеВДерево(ДеревоДанных, Идентификатор, Значение, ПутьВДереве)
	
	ТекстоваяИнформация = Новый ТаблицаЗначений;
	ТекстоваяИнформация.Колонки.Добавить("Идентификатор");
	ТекстоваяИнформация.Колонки.Добавить("Значение");
	
	НоваяСтрока = ТекстоваяИнформация.Добавить();
	НоваяСтрока.Идентификатор = Идентификатор;
	НоваяСтрока.Значение      = Значение;
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ТекстоваяИнформация, ПутьВДереве);

КонецПроцедуры

// Получает ключевые реквизиты объекта по текстовому представлению.
//
// Параметры:
//  ИмяОбъекта - Строка - текстовое представление объекта, ключевые реквизиты которого необходимо получить.
//  СтруктураКлючевыхРеквизитов - Структура - перечень параметров объекта.
//
Процедура ПолучитьСтруктуруКлючевыхРеквизитовОбъекта(ИмяОбъекта, СтруктураКлючевыхРеквизитов)
	
	Если ИмяОбъекта = "Документ.КоммерческоеПредложениеКлиенту" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, Валюта, СуммаДокумента, Клиент, ЦенаВключаетНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		// Табличная часть
		СтрокаРеквизитовОбъекта = ("Количество, Номенклатура, Характеристика, Цена, Сумма, СуммаНДС, СтавкаНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Товары", СтрокаРеквизитовОбъекта);
		
	ИначеЕсли ИмяОбъекта = "Документ.РеализацияТоваровУслуг" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, Валюта, СуммаДокумента, Партнер, Контрагент, ЦенаВключаетНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		// Табличная часть
		СтрокаРеквизитовОбъекта = ("Количество, Номенклатура, Характеристика, Цена, Сумма, СуммаНДС, СтавкаНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Товары", СтрокаРеквизитовОбъекта);

	ИначеЕсли ИмяОбъекта = "Документ.РеализацияУслугПрочихАктивов" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, Валюта, СуммаДокумента, Партнер, Контрагент, ЦенаВключаетНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		// Табличная часть
		СтрокаРеквизитовОбъекта = ("Количество, Содержание, Цена, Сумма, СуммаНДС, СтавкаНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Доходы", СтрокаРеквизитовОбъекта);
		
	ИначеЕсли ИмяОбъекта = "Документ.ПриобретениеТоваровУслуг" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, Валюта, СуммаДокумента, Партнер, Контрагент, ЦенаВключаетНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		// Табличная часть
		СтрокаРеквизитовОбъекта = ("Количество, Номенклатура, Характеристика, Цена, Сумма, СуммаНДС, СтавкаНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Товары", СтрокаРеквизитовОбъекта);
		
	ИначеЕсли ИмяОбъекта = "Документ.ВозвратТоваровОтКлиента" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, Валюта, СуммаДокумента, Партнер, Контрагент, ЦенаВключаетНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		// Табличная часть
		СтрокаРеквизитовОбъекта = ("Количество, Номенклатура, Характеристика, Цена, Сумма, СуммаНДС, СтавкаНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Товары", СтрокаРеквизитовОбъекта);
		
	ИначеЕсли ИмяОбъекта = "Документ.ЗаказКлиента" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, Валюта, СуммаДокумента, Партнер, Контрагент, ЦенаВключаетНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		// Табличная часть
		СтрокаРеквизитовОбъекта = ("Количество, Номенклатура, Характеристика, Цена, Сумма, СуммаНДС, СтавкаНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Товары", СтрокаРеквизитовОбъекта);
		//ЭтапыГрафикаОплаты
		СтрокаРеквизитовОбъекта = ("ВариантОплаты, ДатаПлатежа, ПроцентПлатежа, СуммаПлатежа");
		СтруктураКлючевыхРеквизитов.Вставить("ЭтапыГрафикаОплаты", СтрокаРеквизитовОбъекта);
		
	ИначеЕсли ИмяОбъекта = "Документ.ЗаказПоставщику" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, Валюта, СуммаДокумента, Партнер, Контрагент, ЦенаВключаетНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		// Табличная часть
		СтрокаРеквизитовОбъекта = ("Количество, НоменклатураПартнера, Номенклатура, Характеристика, Цена, Сумма, СуммаНДС, СтавкаНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Товары", СтрокаРеквизитовОбъекта);
		
	ИначеЕсли ИмяОбъекта = "Документ.СчетФактураВыданный" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, Контрагент, ДокументОснование");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		
	ИначеЕсли ИмяОбъекта = "Документ.СчетФактураВыданныйАванс" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, Контрагент, ДокументОснование");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		
		// Авансы
		СтрокаРеквизитовОбъекта = ("Номенклатура, Сумма, СтавкаНДС, СуммаНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Авансы", СтрокаРеквизитовОбъекта);
		
	ИначеЕсли ИмяОбъекта = "Документ.СчетФактураКомиссионеру" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, Комиссионер, ДокументОснование");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		
		// Покупатели
		СтрокаРеквизитовОбъекта = ("Покупатель, НомерСчетаФактуры");
		СтруктураКлючевыхРеквизитов.Вставить("Покупатели", СтрокаРеквизитовОбъекта);
		
	ИначеЕсли ИмяОбъекта = "Документ.ПроизвольныйЭД" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, Контрагент, Партнер, Сообщение");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		
	ИначеЕсли ИмяОбъекта = "Документ.СчетНаОплатуКлиенту" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, Валюта, СуммаДокумента, Партнер, Контрагент, БанковскийСчет");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		//ЭтапыГрафикаОплаты
		СтрокаРеквизитовОбъекта = ("ДатаПлатежа, ПроцентПлатежа, СуммаПлатежа");
		СтруктураКлючевыхРеквизитов.Вставить("ЭтапыГрафикаОплаты", СтрокаРеквизитовОбъекта);
		
	ИначеЕсли ИмяОбъекта = "Документ.ОтчетКомитенту" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, Валюта, СуммаДокумента, Партнер, Контрагент, ЦенаВключаетНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		// Табличная часть
		СтрокаРеквизитовОбъекта = ("Количество, НоменклатураПартнера, Цена, Сумма, СуммаНДС, СтавкаНДС, СуммаПродажи, СуммаВознаграждения");
		СтруктураКлючевыхРеквизитов.Вставить("Товары", СтрокаРеквизитовОбъекта);
		//ЭтапыГрафикаОплаты
		СтрокаРеквизитовОбъекта = ("ДатаПлатежа, ПроцентПлатежа, СуммаПлатежа");
		СтруктураКлючевыхРеквизитов.Вставить("ЭтапыГрафикаОплаты", СтрокаРеквизитовОбъекта);
		
	ИначеЕсли ИмяОбъекта = "Документ.ОтчетКомитентуОСписании" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, Валюта, СуммаДокумента, Партнер, Контрагент, ЦенаВключаетНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		// Табличная часть
		СтрокаРеквизитовОбъекта = ("Количество, НоменклатураПартнера, Цена, Сумма, СуммаНДС, СтавкаНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Товары", СтрокаРеквизитовОбъекта);
		
	ИначеЕсли ИмяОбъекта = "Документ.АктВыполненныхРабот" Тогда 
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Организация, Валюта, СуммаДокумента, Партнер, Контрагент, ЦенаВключаетНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		// Табличная часть
		СтрокаРеквизитовОбъекта = ("Количество, Номенклатура, Характеристика, Цена, Сумма, СуммаНДС, СтавкаНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Услуги", СтрокаРеквизитовОбъекта);
		
	ИначеЕсли ИмяОбъекта = "Документ.ПередачаТоваровМеждуОрганизациями" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, Валюта, СуммаДокумента, ОрганизацияПолучатель, 
			|ЦенаВключаетНДС, РасчетыЧерезОтдельногоКонтрагента");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		// Табличная часть
		СтрокаРеквизитовОбъекта = ("Количество, Номенклатура, Характеристика, Цена, Сумма, СуммаНДС, СтавкаНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Товары", СтрокаРеквизитовОбъекта);
		
	ИначеЕсли ИмяОбъекта = "Документ.ВозвратТоваровМеждуОрганизациями" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, Валюта, СуммаДокумента, ОрганизацияПолучатель, 
			|ЦенаВключаетНДС, РасчетыЧерезОтдельногоКонтрагента");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		// Табличная часть
		СтрокаРеквизитовОбъекта = ("Количество, Номенклатура, Характеристика, Цена, Сумма, СуммаНДС, СтавкаНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Товары", СтрокаРеквизитовОбъекта);
		
	ИначеЕсли ИмяОбъекта = "Документ.ЗаявкаНаРасходованиеДенежныхСредств" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, Валюта, СуммаДокумента, Контрагент");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		// Табличная часть
		СтрокаРеквизитовОбъекта = ("Партнер, Сумма");
		СтруктураКлючевыхРеквизитов.Вставить("РасшифровкаПлатежа", СтрокаРеквизитовОбъекта);
		
	ИначеЕсли ИмяОбъекта = "Документ.КорректировкаРеализации" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, Валюта, СуммаДокумента, Партнер, Контрагент, ЦенаВключаетНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		// Табличная часть
		СтрокаРеквизитовОбъекта = ("Количество, Номенклатура, Характеристика, Цена, Сумма, СуммаНДС, СтавкаНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Товары", СтрокаРеквизитовОбъекта);
		
	ИначеЕсли ИмяОбъекта = "Документ.СписаниеБезналичныхДенежныхСредств" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, БанковскийСчет, ТипПлатежногоДокумента, ХозяйственнаяОперация,
			|СуммаДокумента, Контрагент, БанковскийСчетКонтрагента, БанковскийСчетПолучатель, ПодотчетноеЛицо,
			|НазначениеПлатежа, Валюта, ВидПлатежа, ОчередностьПлатежа, ПеречислениеВБюджет, ВидПеречисленияВБюджет,
			|СтатусСоставителя, КодБК, КодОКАТО, ПоказательОснования, ПоказательПериода, ПоказательНомера, ПоказательДаты");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		
	ИначеЕсли ИмяОбъекта = "Документ.ПоступлениеБезналичныхДенежныхСредств" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, БанковскийСчет, ТипПлатежногоДокумента, ХозяйственнаяОперация,
			|СуммаДокумента, Контрагент, БанковскийСчетКонтрагента, БанковскийСчетОтправитель, ПодотчетноеЛицо,
			|НазначениеПлатежа, Валюта");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
	
	ИначеЕсли ИмяОбъекта = "Документ.АктОРасхожденияхПослеПриемки" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, Валюта, Партнер, Контрагент, ЦенаВключаетНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		// Табличная часть
		СтрокаРеквизитовОбъекта = ("Количество, Номенклатура, Характеристика, Цена, Сумма, СуммаНДС, СтавкаНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Товары", СтрокаРеквизитовОбъекта);
		
	ИначеЕсли ИмяОбъекта = "Документ.АктОРасхожденияхПослеОтгрузки" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, Валюта, Партнер, Контрагент, ЦенаВключаетНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		// Табличная часть
		СтрокаРеквизитовОбъекта = ("Количество, Номенклатура, Характеристика, Цена, Сумма, СуммаНДС, СтавкаНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Товары", СтрокаРеквизитовОбъекта);
		
	ИначеЕсли ИмяОбъекта = "Документ.ВозвратТоваровПоставщику" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, Валюта, Партнер, Контрагент, ЦенаВключаетНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		// Табличная часть
		СтрокаРеквизитовОбъекта = ("Количество, Номенклатура, Характеристика, Цена, Сумма, СуммаНДС, СтавкаНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Товары", СтрокаРеквизитовОбъекта);

	ИначеЕсли ИмяОбъекта = "Документ.ВыкупТоваровХранителем" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, Валюта, Партнер, Контрагент, ЦенаВключаетНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		// Табличная часть
		СтрокаРеквизитовОбъекта = ("Количество, Номенклатура, Характеристика, Цена, Сумма, СуммаНДС, СтавкаНДС");
		СтруктураКлючевыхРеквизитов.Вставить("Товары", СтрокаРеквизитовОбъекта);

	ИначеЕсли ИмяОбъекта = "Документ.СверкаВзаиморасчетов2_5_11" Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация, Валюта, Партнер, Контрагент, РежимСверкиИтоговВзаиморасчетов");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		
	ИначеЕсли ИмяОбъекта = "Справочник.ДоговорыКонтрагентов" Тогда
		// Реквизиты объекта.
		СтрокаРеквизитовОбъекта = "ВалютаВзаиморасчетов, Дата, ДатаНачалаДействия, ДатаОкончанияДействия,
			|Номер, Организация, Контрагент, Сумма, СтавкаНДС,
			|БанковскийСчет, БанковскийСчетКонтрагента";
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		
	ИначеЕсли ДокументПоддерживаетВнутреннийЭДО(ИмяОбъекта) Тогда
		// Реквизиты объекта
		СтрокаРеквизитовОбъекта = ("Дата, Номер, Организация");
		СтруктураКлючевыхРеквизитов.Вставить("Шапка", СтрокаРеквизитовОбъекта);
		
	КонецЕсли;
	
КонецПроцедуры

Функция ДокументПоддерживаетВнутреннийЭДО(ИмяОбъекта)
	
	Результат = Ложь;
	Если ИмяОбъекта = "Документ.ИнвентаризационнаяОпись"
			Или ИмяОбъекта = "Документ.ОприходованиеИзлишковТоваров"
			Или ИмяОбъекта = "Документ.ВнутреннееПотребление"
			Или ИмяОбъекта = "Документ.ПеремещениеТоваров"
			Или ИмяОбъекта = "Документ.ПересортицаТоваров"
			Или ИмяОбъекта = "Документ.СписаниеНедостачТоваров"
			Или ИмяОбъекта = "Документ.ЛистКассовойКниги"
			Или ИмяОбъекта = "Документ.ПриходныйКассовыйОрдер"
			Или ИмяОбъекта = "Документ.РасходныйКассовыйОрдер"
			Или ИмяОбъекта = "Документ.АвансовыйОтчет"
			Или ИмяОбъекта = "Документ.ДоверенностьВыданная"
			Или ИмяОбъекта = "Документ.ИнвентаризацияНаличныхДенежныхСредств"
			Или ИмяОбъекта = "Документ.ПоступлениеТоваровНаСклад"
			Или ИмяОбъекта = "Документ.СборкаТоваров"
			Или ИмяОбъекта = "Документ.ПриемкаТоваровНаХранение"
		Тогда
			Результат = Истина;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Функция РеквизитыРегистрацииТабличнойЧастиПослеИзменения(Объект, СтрокаТаблицыРеквизитовРегистрации)
	
	ТаблицаРеквизитовРегистрации = Объект[СтрокаТаблицыРеквизитовРегистрации.ИмяТабличнойЧасти].Выгрузить(,
		СтрокаТаблицыРеквизитовРегистрации.РеквизитыОбъекта);
		
	Возврат ТаблицаРеквизитовРегистрации;
	
КонецФункции

Функция РеквизитыРегистрацииТабличнойЧастиДоИзменения(Объект, СтрокаТаблицыРеквизитовРегистрации)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ "+ СтрокаТаблицыРеквизитовРегистрации.РеквизитыОбъекта + " ИЗ "
	+ СтрокаТаблицыРеквизитовРегистрации.ИмяОбъекта + "." + СтрокаТаблицыРеквизитовРегистрации.ИмяТабличнойЧасти
	+ " КАК ТекущийОбъектИмяТабличнойЧасти
	|ГДЕ
	|	ТекущийОбъектИмяТабличнойЧасти.Ссылка = &Ссылка";
	Запрос.УстановитьПараметр("Ссылка", Объект.Ссылка);
	
	Возврат Запрос.Выполнить().Выгрузить();
		
КонецФункции

Функция РеквизитыРегистрацииШапкиПослеИзменения(Объект, СтрокаТаблицыРеквизитовРегистрации)
	
	ТаблицаРеквизитовРегистрации = Новый ТаблицаЗначений;
	
	СтруктураРеквизитовРегистрации = СтрокаТаблицыРеквизитовРегистрации.СтруктураРеквизитовОбъекта;
	Для Каждого РеквизитРегистрации Из СтруктураРеквизитовРегистрации Цикл
		ТаблицаРеквизитовРегистрации.Колонки.Добавить(РеквизитРегистрации.Ключ);
	КонецЦикла;
	
	СтрокаТаблицы = ТаблицаРеквизитовРегистрации.Добавить();
	Для Каждого РеквизитРегистрации Из СтруктураРеквизитовРегистрации Цикл
		
		СтрокаТаблицы[РеквизитРегистрации.Ключ] = Объект[РеквизитРегистрации.Ключ];
	КонецЦикла;
	
	Возврат ТаблицаРеквизитовРегистрации;
	
КонецФункции

Функция РеквизитыРегистрацииШапкиДоИзменения(Объект, СтрокаТаблицыРеквизитовРегистрации)

	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ " + СтрокаТаблицыРеквизитовРегистрации.РеквизитыОбъекта + " ИЗ "
	+ СтрокаТаблицыРеквизитовРегистрации.ИмяОбъекта + " КАК ТекущийОбъект
	|ГДЕ
	|	ТекущийОбъект.Ссылка = &Ссылка";
	Запрос.УстановитьПараметр("Ссылка", Объект.Ссылка);
	
	Возврат Запрос.Выполнить().Выгрузить();
		
КонецФункции

// Проверяет переданные таблицы реквизитов на совпадения.
//
// Параметры:
//  Таблица1 - ТаблицаЗначений - первая таблица проверки, реквизиты, которые надо проверить на совпадение.
//  Таблица2 - ТаблицаЗначений - вторая таблица проверки.
//  РеквизитыОбъекта - Строка - реквизиты, перечисленные через запятую.
//  ДопПараметры - Структура - структура дополнительных параметров, по которым надо проводить сравнение.
//
Функция ТаблицыРеквизитовОбъектовОдинаковые(Таблица1, Таблица2, РеквизитыОбъекта, ДопПараметры = Неопределено)
	
	ДобавитьИтераторТаблице(Таблица1, +1);
	ДобавитьИтераторТаблице(Таблица2, -1);
	
	ТаблицаРезультат = Таблица1.Скопировать();
	
	ОбщегоНазначенияКлиентСервер.ДополнитьТаблицу(Таблица2, ТаблицаРезультат);
	
	ТаблицаРезультат.Свернуть(РеквизитыОбъекта, "ИтераторТаблицыРеквизитовОбъекта");
	
	КоличествоОдинаковыхСтрок = ТаблицаРезультат.НайтиСтроки(Новый Структура("ИтераторТаблицыРеквизитовОбъекта", 0)).Количество();
	
	КоличествоСтрокТаблицы = ТаблицаРезультат.Количество();
	ПризнакСовпадения = КоличествоОдинаковыхСтрок = КоличествоСтрокТаблицы;
	
	Если НЕ ПризнакСовпадения И ЗначениеЗаполнено(ДопПараметры) Тогда
		Если ДопПараметры.Свойство("ИмяТабличнойЧасти") Тогда
			ИмяТабличнойЧасти = ДопПараметры.ИмяТабличнойЧасти;
		КонецЕсли;
		Если ДопПараметры.Свойство("СтрокаДереваСравнения") Тогда
			СтрокаДереваСравнения = ДопПараметры.СтрокаДереваСравнения;
		КонецЕсли;
		
		Если ИмяТабличнойЧасти = "Шапка" Тогда
			
			НовСтрокаДереваМесто = СтрокаДереваСравнения.Строки.Добавить();
			НовСтрокаДереваМесто.Место = НСтр("ru = 'Реквизиты шапки'");
			Для Каждого ТекСтрокаТаб1 Из Таблица1 Цикл
				Для Каждого ТекКолонка Из Таблица1.Колонки Цикл
					ИмяКолонки = ТекКолонка.Имя;
					Если ИмяКолонки = "ИтераторТаблицыРеквизитовОбъекта" Тогда
						Продолжить;
					КонецЕсли;
					НайденнаяСтрокаТаб2 = Таблица2.Найти( - ТекСтрокаТаб1.ИтераторТаблицыРеквизитовОбъекта,
						"ИтераторТаблицыРеквизитовОбъекта");
					Если НЕ ЗначениеЗаполнено(НайденнаяСтрокаТаб2) 
						ИЛИ	НайденнаяСтрокаТаб2[ИмяКолонки] = ТекСтрокаТаб1[ИмяКолонки] Тогда
						Продолжить;
					КонецЕсли;
					НовСтрокаДереваРеквизита = НовСтрокаДереваМесто.Строки.Добавить();
					НовСтрокаДереваРеквизита.Реквизит  = ИмяКолонки;
					НовСтрокаДереваЗнч            = НовСтрокаДереваРеквизита.Строки.Добавить();
					НовСтрокаДереваЗнч.ЗначениеБД = ТекСтрокаТаб1[ИмяКолонки];
					НовСтрокаДереваЗнч.ЗначениеЭД = НайденнаяСтрокаТаб2[ИмяКолонки];
					
				КонецЦикла;
			КонецЦикла;
		Иначе
			НовСтрокаДереваМесто = СтрокаДереваСравнения.Строки.Добавить();
			НовСтрокаДереваМесто.Место = СтрШаблон(НСтр("ru = 'Табличная часть <%1>'"), ИмяТабличнойЧасти);
			НовСтрокаДереваРеквизита = НовСтрокаДереваМесто.Строки.Добавить();
			НовСтрокаДереваРеквизита.Реквизит = "<Изменена>";
		КонецЕсли;
	КонецЕсли;
	
	Возврат ПризнакСовпадения;
	
КонецФункции

Процедура ДобавитьИтераторТаблице(Таблица, ЗначениеИтератора)
	
	Таблица.Колонки.Добавить("ИтераторТаблицыРеквизитовОбъекта");
	Таблица.ЗаполнитьЗначения(ЗначениеИтератора, "ИтераторТаблицыРеквизитовОбъекта");
	
КонецПроцедуры

// Возращает сведения по прослеживаемым товарам.
//
// Параметры:
//	ДокументСсылка - ДокументСсылка - ссылка на документ, для которого необходимо получить данные.
//	ТипДокумента - Тип - Тип документа.
//
// Возвращаемое значение:
//	Структура - коллекция сведений по прослеживаемым товарам, содержащая следующие свойства:
//		* ПрослеживаемыеТовары - см. ПрослеживаемыеТоварыДляКомиссии
//		* ПрослеживаемыеКомплектующие - см. УчетПрослеживаемыхТоваровЛокализация.ПрослеживаемыеКомплектующиеДляПечатиДанных
//
Функция ПолучитьДанныеПоПрослеживаемостиДляКомиссии(ДокументСсылка, ТипДокумента) Экспорт
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	ВидыЗапасов.НомерСтроки					КАК НомерСтроки,
	|	ВидыЗапасов.Ссылка						КАК Ссылка,
	|	Аналитика.Номенклатура					КАК Номенклатура,
	|	Аналитика.Характеристика				КАК Характеристика,
	|	ВидыЗапасов.Количество					КАК КоличествоУпаковок,
	|	ВидыЗапасов.КоличествоПоРНПТ			КАК Количество,
	|	ВидыЗапасов.НомерГТД					КАК НомерГТД,
	|	ЕСТЬNULL(ВидыЗапасов.НомерГТД.ТипНомераГТД, НЕОПРЕДЕЛЕНО) КАК ТипНомераГТД,
	|	ЕСТЬNULL(ВидыЗапасов.НомерГТД.Код, НЕОПРЕДЕЛЕНО) КАК НомерТовара,
	|	ВидыЗапасов.АналитикаУчетаНоменклатуры	КАК АналитикаУчетаНоменклатуры,
	|	ЕСТЬNULL(СпрНоменклатура.ЕдиницаИзмеренияТНВЭД.Код, НЕОПРЕДЕЛЕНО) КАК ЕдиницаИзмеренияКод,
	|	ЕСТЬNULL(СпрНоменклатура.ЕдиницаИзмеренияТНВЭД.Наименование, НЕОПРЕДЕЛЕНО) КАК ЕдиницаИзмеренияНаименование
	|ИЗ
	|	&ТипДокумента КАК ВидыЗапасов
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ВидыЗапасов.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|	
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
	|		ПО СпрНоменклатура.Ссылка = Аналитика.Номенклатура
	|
	|ГДЕ
	|	ВидыЗапасов.Ссылка = &Ссылка
	|	И ЕСТЬNULL(Аналитика.Номенклатура.ПрослеживаемыйТовар, ЛОЖЬ)
	|	И ЕСТЬNULL(Аналитика.Номенклатура.ВестиУчетПоГТД, ЛОЖЬ)
	|	И ВидыЗапасов.КоличествоПоРНПТ <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ТаблицаДокумента.Ссылка								КАК Ссылка,
	|	ТаблицаДокумента.НомерГТД							КАК НомерГТД,
	|	Комплектующие.НомерРНПТ								КАК НомерРНПТ,
	|	ВЫБОР
	|		КОГДА Комплектующие.НомерРНПТ.РегистрационныйНомер = """"
	|			ТОГДА Комплектующие.НомерРНПТ
	|		ИНАЧЕ Комплектующие.НомерРНПТ.РегистрационныйНомер
	|	КОНЕЦ												КАК НомерТовара,
	|	НомераГТД.СуммаПоРНПТ								КАК ОбщаяСуммаПоКомплекту,
	|	Комплектующие.СуммаПоРНПТ							КАК СуммаПоРНПТ,
	|	Комплектующие.КоличествоПоРНПТ						КАК Количество,
	|	Комплектующие.ЕдиницаИзмеренияТНВЭД					КАК ЕдиницаИзмерения,
	|	Комплектующие.ЕдиницаИзмеренияТНВЭД.Код				КАК ЕдиницаИзмеренияКод,
	|	Комплектующие.ЕдиницаИзмеренияТНВЭД.Представление	КАК ЕдиницаИзмеренияНаименование
	|ИЗ
	|	&ТипДокумента КАК ТаблицаДокумента
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.НомераГТД.ПрослеживаемыеКомплектующие КАК Комплектующие
	|		ПО ТаблицаДокумента.НомерГТД = Комплектующие.Ссылка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.НомераГТД КАК НомераГТД
	|		ПО ТаблицаДокумента.НомерГТД = НомераГТД.Ссылка
	|ГДЕ
	|	ТаблицаДокумента.Ссылка = &Ссылка";
	
	Если ТипДокумента = Тип("ДокументСсылка.ОтчетКомитенту") Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ТипДокумента", "Документ.ОтчетКомитенту.ВидыЗапасов");
	Иначе
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ТипДокумента", "Документ.ОтчетКомитентуОСписании.ВидыЗапасов");
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("Ссылка", ДокументСсылка);
	
	МассивРезультатов			= Запрос.ВыполнитьПакет();
	ПрослеживаемыеТовары		= ПрослеживаемыеТоварыДляКомиссии(МассивРезультатов[0]);
	ПрослеживаемыеКомплектующие	= УчетПрослеживаемыхТоваровЛокализация.ПрослеживаемыеКомплектующиеДляПечатиДанных(
									МассивРезультатов[1]);
	
	ДанныеПоПрослеживаемости = Новый Структура;
	ДанныеПоПрослеживаемости.Вставить("ПрослеживаемыеТовары",			ПрослеживаемыеТовары);
	ДанныеПоПрослеживаемости.Вставить("ПрослеживаемыеКомплектующие",	ПрослеживаемыеКомплектующие);
	
	Возврат ДанныеПоПрослеживаемости;
	
КонецФункции

Функция РаспоряжениеДляПолученияВариантаПриемкиТоваров(ДокументОбъект)
	
	ВариантПриемкиТоваровДоговор = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОбъект.Договор, "ВариантПриемкиТоваров");
	ВариантПриемкиТоваровСоглашение = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОбъект.Соглашение, "ВариантПриемкиТоваров");

	СкладыТаблицы = ДокументОбъект.Товары.Выгрузить(,"Склад").ВыгрузитьКолонку("Склад");
	ОрдернаяСхемаПриПриемке = СкладыСервер.ЕстьОрдерныйНаПоступлениеСклад(СкладыТаблицы, ДокументОбъект.Дата, ДокументОбъект.Склад);
	
	Если Справочники.ДоговорыКонтрагентов.ДоговорИспользуетсяПриПриемке(ВариантПриемкиТоваровДоговор)
		И ОрдернаяСхемаПриПриемке Тогда
		Возврат ДокументОбъект.Договор;
	ИначеЕсли Справочники.СоглашенияСПоставщиками.СоглашениеИспользуетсяПриПриемке(ВариантПриемкиТоваровСоглашение)
		И ОрдернаяСхемаПриПриемке Тогда
		Возврат ДокументОбъект.Соглашение;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

#Область НастройкиФормированияДокумента

Функция ЗапросКонструктораДополнительныхПолейШапкиУПД()
	
	ТекстЗапроса = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
		|	СчетФактураВыданныйДокументыОснования.Ссылка КАК Ссылка,
		|	СчетФактураВыданныйДокументыОснования.Ссылка.Номер КАК Номер,
		|	СчетФактураВыданныйДокументыОснования.Ссылка.Дата КАК Дата,
		|	СчетФактураВыданныйДокументыОснования.Ссылка.Организация КАК Организация,
		|	СчетФактураВыданныйДокументыОснования.Ссылка.Контрагент КАК Контрагент,
		|	СчетФактураВыданныйДокументыОснования.Ссылка.СчетФактураОснование КАК СчетФактураОснование,
		|	СчетФактураВыданныйДокументыОснования.Ссылка.СтрокаПлатежноРасчетныеДокументы КАК СтрокаПлатежноРасчетныеДокументы,
		|	СчетФактураВыданныйДокументыОснования.Ссылка.Исправление КАК Исправление,
		|	СчетФактураВыданныйДокументыОснования.Ссылка.НомерИсправления КАК НомерИсправления,
		|	СчетФактураВыданныйДокументыОснования.Ссылка.Корректировочный КАК Корректировочный,
		|	СчетФактураВыданныйДокументыОснования.Ссылка.Валюта КАК Валюта,
		|	СчетФактураВыданныйДокументыОснования.Ссылка.ВыставленВЭлектронномВиде КАК ВыставленВЭлектронномВиде,
		|	СчетФактураВыданныйДокументыОснования.Ссылка.ДатаВыставления КАК ДатаВыставления,
		|	СчетФактураВыданныйДокументыОснования.Ссылка.КодВидаОперации КАК КодВидаОперации,
		|	СчетФактураВыданныйДокументыОснования.Ссылка.ИдентификаторПлатежа КАК ИдентификаторПлатежа,
		|	СчетФактураВыданныйДокументыОснования.Ссылка.КППКонтрагента КАК КППКонтрагента,
		|	СчетФактураВыданныйДокументыОснования.Ссылка.КодВидаОперацииНаУменьшение КАК КодВидаОперацииНаУменьшение,
		|	СчетФактураВыданныйДокументыОснования.Ссылка.Подразделение КАК Подразделение,
		|	СчетФактураВыданныйДокументыОснования.Ссылка.Ответственный КАК Ответственный,
		|	СчетФактураВыданныйДокументыОснования.Ссылка.СводныйКорректировочный КАК СводныйКорректировочный,
		|	СчетФактураВыданныйДокументыОснования.Ссылка.ИННКонтрагента КАК ИННКонтрагента,
		|	СчетФактураВыданныйДокументыОснования.Ссылка.ИдентификаторГосКонтракта КАК ИдентификаторГосКонтракта,
		|	СчетФактураВыданныйДокументыОснования.ДокументОснование КАК ДокументОснование
		|ИЗ
		|	Документ.СчетФактураВыданный.ДокументыОснования КАК СчетФактураВыданныйДокументыОснования
		|ГДЕ
		|	СчетФактураВыданныйДокументыОснования.Ссылка = &Ссылка
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ 
		|	СчетФактураВыданныйАванс.Ссылка,
		|	СчетФактураВыданныйАванс.Номер,
		|	СчетФактураВыданныйАванс.Дата,
		|	СчетФактураВыданныйАванс.Организация,
		|	СчетФактураВыданныйАванс.Контрагент,
		|	СчетФактураВыданныйАванс.СчетФактураОснование,
		|	СчетФактураВыданныйАванс.СтрокаПлатежноРасчетныеДокументы,
		|	СчетФактураВыданныйАванс.Исправление,
		|	СчетФактураВыданныйАванс.НомерИсправления,
		|	СчетФактураВыданныйАванс.Корректировочный,
		|	NULL,
		|	СчетФактураВыданныйАванс.ВыставленВЭлектронномВиде,
		|	СчетФактураВыданныйАванс.ДатаВыставления,
		|	СчетФактураВыданныйАванс.КодВидаОперации,
		|	NULL,
		|	СчетФактураВыданныйАванс.КППКонтрагента,
		|	NULL,
		|	СчетФактураВыданныйАванс.Подразделение,
		|	СчетФактураВыданныйАванс.Ответственный,
		|	СчетФактураВыданныйАванс.СводныйКорректировочный,
		|	СчетФактураВыданныйАванс.ИННКонтрагента,
		|	СчетФактураВыданныйАванс.ИдентификаторГосКонтракта,
		|	СчетФактураВыданныйАванс.ДокументОснование
		|ИЗ
		|	Документ.СчетФактураВыданныйАванс КАК СчетФактураВыданныйАванс
		|ГДЕ
		|	СчетФактураВыданныйАванс.Ссылка = &Ссылка";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ЗапросКонструктораДополнительныхПолейШапкиСчетаФактуры()
	
	ТекстЗапроса = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	СчетФактураВыданный.Ссылка КАК Ссылка,
		|	СчетФактураВыданный.Номер КАК Номер,
		|	СчетФактураВыданный.Дата КАК Дата,
		|	СчетФактураВыданный.Организация КАК Организация,
		|	СчетФактураВыданный.Контрагент КАК Контрагент,
		|	СчетФактураВыданный.ДокументОснование КАК ДокументОснование,
		|	СчетФактураВыданный.СчетФактураОснование КАК СчетФактураОснование,
		|	СчетФактураВыданный.СтрокаПлатежноРасчетныеДокументы КАК СтрокаПлатежноРасчетныеДокументы,
		|	СчетФактураВыданный.Исправление КАК Исправление,
		|	СчетФактураВыданный.НомерИсправления КАК НомерИсправления,
		|	СчетФактураВыданный.Корректировочный КАК Корректировочный,
		|	СчетФактураВыданный.Валюта КАК Валюта,
		|	СчетФактураВыданный.ВыставленВЭлектронномВиде КАК ВыставленВЭлектронномВиде,
		|	СчетФактураВыданный.ДатаВыставления КАК ДатаВыставления,
		|	СчетФактураВыданный.КодВидаОперации КАК КодВидаОперации,
		|	СчетФактураВыданный.ИдентификаторПлатежа КАК ИдентификаторПлатежа,
		|	СчетФактураВыданный.КППКонтрагента КАК КППКонтрагента,
		|	СчетФактураВыданный.КодВидаОперацииНаУменьшение КАК КодВидаОперацииНаУменьшение,
		|	СчетФактураВыданный.Подразделение КАК Подразделение,
		|	СчетФактураВыданный.Ответственный КАК Ответственный,
		|	СчетФактураВыданный.СводныйКорректировочный КАК СводныйКорректировочный,
		|	СчетФактураВыданный.ИННКонтрагента КАК ИННКонтрагента,
		|	СчетФактураВыданный.ИдентификаторГосКонтракта КАК ИдентификаторГосКонтракта
		|ИЗ
		|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
		|ГДЕ
		|	СчетФактураВыданный.Ссылка = &Ссылка
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ 
		|	СчетФактураВыданныйАванс.Ссылка,
		|	СчетФактураВыданныйАванс.Номер,
		|	СчетФактураВыданныйАванс.Дата,
		|	СчетФактураВыданныйАванс.Организация,
		|	СчетФактураВыданныйАванс.Контрагент,
		|	СчетФактураВыданныйАванс.ДокументОснование,
		|	СчетФактураВыданныйАванс.СчетФактураОснование,
		|	СчетФактураВыданныйАванс.СтрокаПлатежноРасчетныеДокументы,
		|	СчетФактураВыданныйАванс.Исправление,
		|	СчетФактураВыданныйАванс.НомерИсправления,
		|	СчетФактураВыданныйАванс.Корректировочный,
		|	NULL,
		|	СчетФактураВыданныйАванс.ВыставленВЭлектронномВиде,
		|	СчетФактураВыданныйАванс.ДатаВыставления,
		|	СчетФактураВыданныйАванс.КодВидаОперации,
		|	NULL,
		|	СчетФактураВыданныйАванс.КППКонтрагента,
		|	NULL,
		|	СчетФактураВыданныйАванс.Подразделение,
		|	СчетФактураВыданныйАванс.Ответственный,
		|	СчетФактураВыданныйАванс.СводныйКорректировочный,
		|	СчетФактураВыданныйАванс.ИННКонтрагента,
		|	СчетФактураВыданныйАванс.ИдентификаторГосКонтракта
		|ИЗ
		|	Документ.СчетФактураВыданныйАванс КАК СчетФактураВыданныйАванс
		|ГДЕ
		|	СчетФактураВыданныйАванс.Ссылка = &Ссылка";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ЗапросКонструктораДополнительныхПолейШапкиРеализации()
	
	ТекстЗапроса = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	РеализацияТоваровУслуг.Ссылка КАК Ссылка,
		|	РеализацияТоваровУслуг.Номер КАК Номер,
		|	РеализацияТоваровУслуг.Дата КАК Дата,
		|	РеализацияТоваровУслуг.АдресДоставки КАК АдресДоставки,
		|	РеализацияТоваровУслуг.БанковскийСчетОрганизации КАК БанковскийСчетОрганизации,
		|	РеализацияТоваровУслуг.БанковскийСчетКонтрагента КАК БанковскийСчетКонтрагента,
		|	РеализацияТоваровУслуг.БанковскийСчетГрузоотправителя КАК БанковскийСчетГрузоотправителя,
		|	РеализацияТоваровУслуг.БанковскийСчетГрузополучателя КАК БанковскийСчетГрузополучателя,
		|	РеализацияТоваровУслуг.Валюта КАК Валюта,
		|	РеализацияТоваровУслуг.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
		|	РеализацияТоваровУслуг.Грузоотправитель КАК Грузоотправитель,
		|	РеализацияТоваровУслуг.Грузополучатель КАК Грузополучатель,
		|	РеализацияТоваровУслуг.Дата КАК ДатаРаспоряжения,
		|	РеализацияТоваровУслуг.ДоверенностьВыдана КАК ДоверенностьВыдана,
		|	РеализацияТоваровУслуг.ДоверенностьДата КАК ДоверенностьДата,
		|	РеализацияТоваровУслуг.ДоверенностьЛицо КАК ДоверенностьЛицо,
		|	РеализацияТоваровУслуг.ДоверенностьНомер КАК ДоверенностьНомер,
		|	РеализацияТоваровУслуг.ЗаказКлиента КАК ЗаказКлиента,
		|	РеализацияТоваровУслуг.Организация КАК Организация,
		|	РеализацияТоваровУслуг.Контрагент КАК Контрагент,
		|	РеализацияТоваровУслуг.Менеджер КАК Менеджер,
		|	РеализацияТоваровУслуг.НалогообложениеНДС КАК НалогообложениеНДС,
		|	РеализацияТоваровУслуг.СуммаДокумента КАК СуммаДокумента,
		|	РеализацияТоваровУслуг.Партнер КАК Партнер,
		|	РеализацияТоваровУслуг.Подразделение КАК Подразделение,
		|	РеализацияТоваровУслуг.Сделка КАК Сделка,
		|	РеализацияТоваровУслуг.СкидкиРассчитаны КАК СкидкиРассчитаны,
		|	РеализацияТоваровУслуг.Склад КАК Склад,
		|	РеализацияТоваровУслуг.Согласован КАК Согласован,
		|	РеализацияТоваровУслуг.Соглашение КАК Соглашение,
		|	РеализацияТоваровУслуг.СуммаВзаиморасчетов КАК СуммаВзаиморасчетов,
		|	РеализацияТоваровУслуг.ФормаОплаты КАК ФормаОплаты,
		|	РеализацияТоваровУслуг.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
		|	РеализацияТоваровУслуг.ЦенаВключаетНДС КАК ЦенаВключаетНДС,
		|	РеализацияТоваровУслуг.Касса КАК Касса,
		|	РеализацияТоваровУслуг.Отпустил КАК Отпустил,
		|	РеализацияТоваровУслуг.ОтпустилДолжность КАК ОтпустилДолжность,
		|	РеализацияТоваровУслуг.РеализацияПоЗаказам КАК РеализацияПоЗаказам,
		|	РеализацияТоваровУслуг.ГруппаФинансовогоУчета КАК ГруппаФинансовогоУчета,
		|	РеализацияТоваровУслуг.КартаЛояльности КАК КартаЛояльности,
		|	РеализацияТоваровУслуг.Договор КАК Договор,
		|	РеализацияТоваровУслуг.Основание КАК Основание,
		|	РеализацияТоваровУслуг.Статус КАК Статус,
		|	РеализацияТоваровУслуг.Автор КАК Автор,
		|	РеализацияТоваровУслуг.СпособДоставки КАК СпособДоставки,
		|	РеализацияТоваровУслуг.ЗонаДоставки КАК ЗонаДоставки,
		|	РеализацияТоваровУслуг.ПеревозчикПартнер КАК ПеревозчикПартнер,
		|	РеализацияТоваровУслуг.ВремяДоставкиС КАК ВремяДоставкиС,
		|	РеализацияТоваровУслуг.ВремяДоставкиПо КАК ВремяДоставкиПо,
		|	РеализацияТоваровУслуг.АдресДоставкиПеревозчика КАК АдресДоставкиПеревозчика,
		|	РеализацияТоваровУслуг.КонтактноеЛицо КАК КонтактноеЛицо,
		|	РеализацияТоваровУслуг.Руководитель КАК Руководитель,
		|	РеализацияТоваровУслуг.ГлавныйБухгалтер КАК ГлавныйБухгалтер,
		|	РеализацияТоваровУслуг.ПорядокРасчетов КАК ПорядокРасчетов,
		|	РеализацияТоваровУслуг.ВернутьМногооборотнуюТару КАК ВернутьМногооборотнуюТару,
		|	РеализацияТоваровУслуг.ДатаВозвратаМногооборотнойТары КАК ДатаВозвратаМногооборотнойТары,
		|	РеализацияТоваровУслуг.СостояниеЗаполненияМногооборотнойТары КАК СостояниеЗаполненияМногооборотнойТары,
		|	РеализацияТоваровУслуг.ВидыЗапасовУказаныВручную КАК ВидыЗапасовУказаныВручную,
		|	РеализацияТоваровУслуг.ТребуетсяЗалогЗаТару КАК ТребуетсяЗалогЗаТару,
		|	РеализацияТоваровУслуг.ОснованиеДата КАК ОснованиеДата,
		|	РеализацияТоваровУслуг.ОснованиеНомер КАК ОснованиеНомер,
		|	РеализацияТоваровУслуг.ДопоставкаПоРеализации КАК ДопоставкаПоРеализации,
		|	РеализацияТоваровУслуг.ДатаПереходаПраваСобственности КАК ДатаПереходаПраваСобственности,
		|	РеализацияТоваровУслуг.ВариантОформленияПродажи КАК ВариантОформленияПродажи,
		|	РеализацияТоваровУслуг.ИдентификаторПлатежа КАК ИдентификаторПлатежа,
		|	РеализацияТоваровУслуг.ОсобыеУсловияПеревозки КАК ОсобыеУсловияПеревозки,
		|	РеализацияТоваровУслуг.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	РеализацияТоваровУслуг.КурсЧислитель КАК КурсЧислитель,
		|	РеализацияТоваровУслуг.КурсЗнаменатель КАК КурсЗнаменатель,
		|	РеализацияТоваровУслуг.ОплатаВВалюте КАК ОплатаВВалюте,
		|	РеализацияТоваровУслуг.ЕстьМаркируемаяПродукцияГИСМ КАК ЕстьМаркируемаяПродукцияГИСМ,
		|	РеализацияТоваровУслуг.СуммаВзаиморасчетовПоТаре КАК СуммаВзаиморасчетовПоТаре
		|ИЗ
		|	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
		|ГДЕ
		|	РеализацияТоваровУслуг.Ссылка = &Ссылка
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ 
		|	КорректировкаРеализации.Ссылка,
		|	КорректировкаРеализации.Номер,
		|	КорректировкаРеализации.Дата,
		|	КорректировкаРеализации.АдресДоставки,
		|	КорректировкаРеализации.БанковскийСчетОрганизации,
		|	КорректировкаРеализации.БанковскийСчетКонтрагента,
		|	КорректировкаРеализации.БанковскийСчетГрузоотправителя,
		|	КорректировкаРеализации.БанковскийСчетГрузополучателя,
		|	КорректировкаРеализации.Валюта,
		|	КорректировкаРеализации.ВалютаВзаиморасчетов,
		|	КорректировкаРеализации.Грузополучатель,
		|	КорректировкаРеализации.Грузоотправитель,
		|	NULL,
		|	КорректировкаРеализации.ДоверенностьВыдана,
		|	КорректировкаРеализации.ДоверенностьДата,
		|	КорректировкаРеализации.ДоверенностьЛицо,
		|	КорректировкаРеализации.ДоверенностьНомер,
		|	NULL,
		|	КорректировкаРеализации.Организация,
		|	КорректировкаРеализации.Контрагент,
		|	КорректировкаРеализации.Менеджер,
		|	КорректировкаРеализации.НалогообложениеНДС,
		|	КорректировкаРеализации.СуммаДокумента,	
		|	КорректировкаРеализации.Партнер,
		|	КорректировкаРеализации.Подразделение,
		|	КорректировкаРеализации.Сделка,
		|	NULL,
		|	КорректировкаРеализации.Склад,
		|	КорректировкаРеализации.Согласован,
		|	КорректировкаРеализации.Соглашение,
		|	КорректировкаРеализации.СуммаВзаиморасчетов,
		|	КорректировкаРеализации.ФормаОплаты,
		|	NULL,
		|	КорректировкаРеализации.ЦенаВключаетНДС,
		|	NULL,
		|	КорректировкаРеализации.Отпустил,
		|	КорректировкаРеализации.ОтпустилДолжность,
		|	КорректировкаРеализации.ПродажаПоЗаказам,
		|	NULL,
		|	NULL,		
		|	КорректировкаРеализации.Договор,
		|	КорректировкаРеализации.Основание,
		|	NULL,
		|	NULL,		
		|	NULL,		
		|	NULL,
		|	NULL,		
		|	NULL,		
		|	NULL,		
		|	NULL,		
		|	NULL,		
		|	КорректировкаРеализации.Руководитель,
		|	КорректировкаРеализации.ГлавныйБухгалтер,
		|	КорректировкаРеализации.ПорядокРасчетов,
		|	NULL,
		|	NULL,		
		|	NULL,		
		|	NULL,		
		|	NULL,		
		|	КорректировкаРеализации.ОснованиеДата,
		|	КорректировкаРеализации.ОснованиеНомер,
		|	NULL,		
		|	NULL,		
		|	КорректировкаРеализации.ВариантОформленияПродажи,
		|	NULL,		
		|	NULL,		
		|	КорректировкаРеализации.НаправлениеДеятельности,
		|	КорректировкаРеализации.КурсЧислитель,
		|	КорректировкаРеализации.КурсЗнаменатель,
		|	NULL,		
		|	NULL,		
		|	NULL		
		|ИЗ
		|	Документ.КорректировкаРеализации КАК КорректировкаРеализации
		|ГДЕ
		|	КорректировкаРеализации.Ссылка = &Ссылка";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ЗапросКонструктораДополнительныхПолейШапкиАкта()
	
	ТекстЗапроса = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АктВыполненныхРабот.Ссылка КАК Ссылка,
		|	АктВыполненныхРабот.Номер КАК Номер,
		|	АктВыполненныхРабот.Дата КАК Дата,
		|	АктВыполненныхРабот.АктПоЗаказам КАК АктПоЗаказам,
		|	АктВыполненныхРабот.БанковскийСчетКонтрагента КАК БанковскийСчетКонтрагента,
		|	АктВыполненныхРабот.БанковскийСчетОрганизации КАК БанковскийСчетОрганизации,
		|	АктВыполненныхРабот.Валюта КАК Валюта,
		|	АктВыполненныхРабот.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
		|	АктВыполненныхРабот.ДополнительнаяИнформация КАК ДополнительнаяИнформация,
		|	АктВыполненныхРабот.ДополнительнаяИнформацияШапки КАК ДополнительнаяИнформацияШапки,
		|	АктВыполненныхРабот.ЗаказКлиента КАК ЗаказКлиента,
		|	АктВыполненныхРабот.Касса КАК Касса,
		|	АктВыполненныхРабот.Комментарий КАК Комментарий,
		|	АктВыполненныхРабот.Контрагент КАК Контрагент,
		|	АктВыполненныхРабот.Менеджер КАК Менеджер,
		|	АктВыполненныхРабот.НалогообложениеНДС КАК НалогообложениеНДС,
		|	АктВыполненныхРабот.Организация КАК Организация,
		|	АктВыполненныхРабот.Партнер КАК Партнер,
		|	АктВыполненныхРабот.Подразделение КАК Подразделение,
		|	АктВыполненныхРабот.Сделка КАК Сделка,
		|	АктВыполненныхРабот.СкидкиРассчитаны КАК СкидкиРассчитаны,
		|	АктВыполненныхРабот.Согласован КАК Согласован,
		|	АктВыполненныхРабот.Соглашение КАК Соглашение,
		|	АктВыполненныхРабот.СуммаВзаиморасчетов КАК СуммаВзаиморасчетов,
		|	АктВыполненныхРабот.СуммаДокумента КАК СуммаДокумента,
		|	АктВыполненныхРабот.ФормаОплаты КАК ФормаОплаты,
		|	АктВыполненныхРабот.ЦенаВключаетНДС КАК ЦенаВключаетНДС,
		|	АктВыполненныхРабот.ГруппаФинансовогоУчета КАК ГруппаФинансовогоУчета,
		|	АктВыполненныхРабот.КартаЛояльности КАК КартаЛояльности,
		|	АктВыполненныхРабот.Договор КАК Договор,
		|	АктВыполненныхРабот.Автор КАК Автор,
		|	АктВыполненныхРабот.КонтактноеЛицо КАК КонтактноеЛицо,
		|	АктВыполненныхРабот.Руководитель КАК Руководитель,
		|	АктВыполненныхРабот.ГлавныйБухгалтер КАК ГлавныйБухгалтер,
		|	АктВыполненныхРабот.ПорядокРасчетов КАК ПорядокРасчетов,
		|	АктВыполненныхРабот.ИдентификаторПлатежа КАК ИдентификаторПлатежа,
		|	АктВыполненныхРабот.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	АктВыполненныхРабот.КурсЧислитель КАК КурсЧислитель,
		|	АктВыполненныхРабот.КурсЗнаменатель КАК КурсЗнаменатель,
		|	АктВыполненныхРабот.ОплатаВВалюте КАК ОплатаВВалюте,
		|	АктВыполненныхРабот.Основание КАК Основание,
		|	АктВыполненныхРабот.ОснованиеДата КАК ОснованиеДата,
		|	АктВыполненныхРабот.ОснованиеНомер КАК ОснованиеНомер
		|ИЗ
		|	Документ.АктВыполненныхРабот КАК АктВыполненныхРабот
		|ГДЕ
		|	АктВыполненныхРабот.Ссылка = &Ссылка
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ 
		|	КорректировкаРеализации.Ссылка,
		|	КорректировкаРеализации.Номер,
		|	КорректировкаРеализации.Дата,
		|	КорректировкаРеализации.ПродажаПоЗаказам,
		|	КорректировкаРеализации.БанковскийСчетОрганизации,
		|	КорректировкаРеализации.БанковскийСчетКонтрагента,
		|	КорректировкаРеализации.Валюта,
		|	КорректировкаРеализации.ВалютаВзаиморасчетов,
		|	NULL,
		|	NULL,		
		|	NULL,		
		|	NULL,		
		|	КорректировкаРеализации.Комментарий,
		|	КорректировкаРеализации.Контрагент,
		|	КорректировкаРеализации.Менеджер,
		|	КорректировкаРеализации.НалогообложениеНДС,
		|	КорректировкаРеализации.Организация,
		|	КорректировкаРеализации.Партнер,
		|	КорректировкаРеализации.Подразделение,
		|	КорректировкаРеализации.Сделка,
		|	NULL,
		|	КорректировкаРеализации.Согласован,
		|	КорректировкаРеализации.Соглашение,
		|	КорректировкаРеализации.СуммаВзаиморасчетов,
		|	КорректировкаРеализации.СуммаДокумента,	
		|	КорректировкаРеализации.ФормаОплаты,
		|	КорректировкаРеализации.ЦенаВключаетНДС,
		|	NULL,
		|	NULL,
		|	КорректировкаРеализации.Договор,
		|	NULL,
		|	NULL,
		|	КорректировкаРеализации.Руководитель,
		|	КорректировкаРеализации.ГлавныйБухгалтер,
		|	КорректировкаРеализации.ПорядокРасчетов,
		|	NULL,
		|	КорректировкаРеализации.НаправлениеДеятельности,
		|	КорректировкаРеализации.КурсЧислитель,
		|	КорректировкаРеализации.КурсЗнаменатель,
		|	NULL,
		|	КорректировкаРеализации.Основание,
		|	КорректировкаРеализации.ОснованиеДата,
		|	КорректировкаРеализации.ОснованиеНомер	
		|ИЗ
		|	Документ.КорректировкаРеализации КАК КорректировкаРеализации
		|ГДЕ
		|	КорректировкаРеализации.Ссылка = &Ссылка";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ЗапросКонструктораДополнительныхПолейШапкиКорректировкиРеализации()
	
	ТекстЗапроса = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	КорректировкаРеализации.Ссылка КАК Ссылка,
		|	КорректировкаРеализации.Номер КАК Номер,
		|	КорректировкаРеализации.Дата КАК Дата,
		|	КорректировкаРеализации.ДокументОснование КАК ДокументОснование,
		|	КорректировкаРеализации.Партнер КАК Партнер,
		|	КорректировкаРеализации.Контрагент КАК Контрагент,
		|	КорректировкаРеализации.Соглашение КАК Соглашение,
		|	КорректировкаРеализации.Организация КАК Организация,
		|	КорректировкаРеализации.Договор КАК Договор,
		|	КорректировкаРеализации.Склад КАК Склад,
		|	КорректировкаРеализации.Подразделение КАК Подразделение,
		|	КорректировкаРеализации.Сделка КАК Сделка,
		|	КорректировкаРеализации.Валюта КАК Валюта,
		|	КорректировкаРеализации.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
		|	КорректировкаРеализации.Менеджер КАК Менеджер,
		|	КорректировкаРеализации.СуммаДокумента КАК СуммаДокумента,
		|	КорректировкаРеализации.ДатаПлатежа КАК ДатаПлатежа,
		|	КорректировкаРеализации.ФормаОплаты КАК ФормаОплаты,
		|	КорректировкаРеализации.ЦенаВключаетНДС КАК ЦенаВключаетНДС,
		|	КорректировкаРеализации.НалогообложениеНДС КАК НалогообложениеНДС,
		|	КорректировкаРеализации.ПродажаПоЗаказам КАК ПродажаПоЗаказам,
		|	КорректировкаРеализации.ПодразделениеДоходы КАК ПодразделениеДоходы,
		|	КорректировкаРеализации.СтатьяДоходов КАК СтатьяДоходов,
		|	КорректировкаРеализации.АналитикаДоходов КАК АналитикаДоходов,
		|	КорректировкаРеализации.ПодразделениеРасходы КАК ПодразделениеРасходы,
		|	КорректировкаРеализации.СтатьяРасходов КАК СтатьяРасходов,
		|	КорректировкаРеализации.АналитикаРасходов КАК АналитикаРасходов,
		|	КорректировкаРеализации.Согласован КАК Согласован,
		|	КорректировкаРеализации.Отпустил КАК Отпустил,
		|	КорректировкаРеализации.ОтпустилДолжность КАК ОтпустилДолжность,
		|	КорректировкаРеализации.Основание КАК Основание,
		|	КорректировкаРеализации.Грузополучатель КАК Грузополучатель,
		|	КорректировкаРеализации.Грузоотправитель КАК Грузоотправитель,
		|	КорректировкаРеализации.БанковскийСчетОрганизации КАК БанковскийСчетОрганизации,
		|	КорректировкаРеализации.БанковскийСчетКонтрагента КАК БанковскийСчетКонтрагента,
		|	КорректировкаРеализации.БанковскийСчетГрузоотправителя КАК БанковскийСчетГрузоотправителя,
		|	КорректировкаРеализации.БанковскийСчетГрузополучателя КАК БанковскийСчетГрузополучателя,
		|	КорректировкаРеализации.АдресДоставки КАК АдресДоставки,
		|	КорректировкаРеализации.ДоверенностьНомер КАК ДоверенностьНомер,
		|	КорректировкаРеализации.ДоверенностьДата КАК ДоверенностьДата,
		|	КорректировкаРеализации.ДоверенностьВыдана КАК ДоверенностьВыдана,
		|	КорректировкаРеализации.ДоверенностьЛицо КАК ДоверенностьЛицо,
		|	КорректировкаРеализации.Комментарий КАК Комментарий,
		|	КорректировкаРеализации.Руководитель КАК Руководитель,
		|	КорректировкаРеализации.ГлавныйБухгалтер КАК ГлавныйБухгалтер,
		|	КорректировкаРеализации.ПорядокРасчетов КАК ПорядокРасчетов,
		|	КорректировкаРеализации.ВидКорректировки КАК ВидКорректировки,
		|	КорректировкаРеализации.СуммаВзаиморасчетов КАК СуммаВзаиморасчетов,
		|	КорректировкаРеализации.ОснованиеДата КАК ОснованиеДата,
		|	КорректировкаРеализации.ОснованиеНомер КАК ОснованиеНомер,
		|	КорректировкаРеализации.АктОРасхожденияхПослеОтгрузкиОснование КАК АктОРасхожденияхПослеОтгрузкиОснование,
		|	КорректировкаРеализации.ВариантОформленияПродажи КАК ВариантОформленияПродажи,
		|	КорректировкаРеализации.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	КорректировкаРеализации.КурсЧислитель КАК КурсЧислитель,
		|	КорректировкаРеализации.КурсЗнаменатель КАК КурсЗнаменатель
		|ИЗ
		|	Документ.КорректировкаРеализации КАК КорректировкаРеализации
		|ГДЕ
		|	КорректировкаРеализации.Ссылка = &Ссылка";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ЗапросКонструктораДополнительныхПолейШапкиСведенийОРеализацииКомиссионером()
	
	ТекстЗапроса = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
		|	ОтчетКомитенту.Ссылка КАК Ссылка,
		|	ОтчетКомитенту.ВерсияДанных КАК ВерсияДанных,
		|	ОтчетКомитенту.ПометкаУдаления КАК ПометкаУдаления,
		|	ОтчетКомитенту.Номер КАК Номер,
		|	ОтчетКомитенту.Дата КАК Дата,
		|	ОтчетКомитенту.Проведен КАК Проведен,
		|	ОтчетКомитенту.Организация КАК Организация,
		|	ОтчетКомитенту.Партнер КАК Партнер,
		|	ОтчетКомитенту.Контрагент КАК Контрагент,
		|	ОтчетКомитенту.Соглашение КАК Соглашение,
		|	ОтчетКомитенту.Валюта КАК Валюта,
		|	ОтчетКомитенту.СуммаДокумента КАК СуммаДокумента,
		|	ОтчетКомитенту.Подразделение КАК Подразделение,
		|	ОтчетКомитенту.Менеджер КАК Менеджер,
		|	ОтчетКомитенту.НалогообложениеНДС КАК НалогообложениеНДС,
		|	ОтчетКомитенту.ЦенаВключаетНДС КАК ЦенаВключаетНДС,
		|	ОтчетКомитенту.СпособРасчетаВознаграждения КАК СпособРасчетаВознаграждения,
		|	ОтчетКомитенту.ПроцентВознаграждения КАК ПроцентВознаграждения,
		|	ОтчетКомитенту.СуммаВознаграждения КАК СуммаВознаграждения,
		|	ОтчетКомитенту.СтавкаНДСВознаграждения КАК СтавкаНДСВознаграждения,
		|	ОтчетКомитенту.СуммаНДСВознаграждения КАК СуммаНДСВознаграждения,
		|	ОтчетКомитенту.УдержатьВознаграждение КАК УдержатьВознаграждение,
		|	ОтчетКомитенту.Услуга КАК Услуга,
		|	ОтчетКомитенту.ФормаОплаты КАК ФормаОплаты,
		|	ОтчетКомитенту.БанковскийСчет КАК БанковскийСчет,
		|	ОтчетКомитенту.Касса КАК Касса,
		|	ОтчетКомитенту.ДатаПлатежа КАК ДатаПлатежа,
		|	ОтчетКомитенту.НачалоПериода КАК НачалоПериода,
		|	ОтчетКомитенту.КонецПериода КАК КонецПериода,
		|	ОтчетКомитенту.Комментарий КАК Комментарий,
		|	ОтчетКомитенту.ГруппаФинансовогоУчета КАК ГруппаФинансовогоУчета,
		|	ОтчетКомитенту.Договор КАК Договор,
		|	ОтчетКомитенту.КонтактноеЛицо КАК КонтактноеЛицо,
		|	ОтчетКомитенту.Руководитель КАК Руководитель,
		|	ОтчетКомитенту.ГлавныйБухгалтер КАК ГлавныйБухгалтер,
		|	ОтчетКомитенту.ПорядокРасчетов КАК ПорядокРасчетов,
		|	ОтчетКомитенту.ВидыЗапасовУказаныВручную КАК ВидыЗапасовУказаныВручную,
		|	ОтчетКомитенту.ИдентификаторПлатежа КАК ИдентификаторПлатежа,
		|	ОтчетКомитенту.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	ОтчетКомитенту.ОплатаВВалюте КАК ОплатаВВалюте,
		|	ОтчетКомитенту.ОбъектРасчетов КАК ОбъектРасчетов,
		|	ОтчетКомитенту.ОбъектРасчетовВознаграждение КАК ОбъектРасчетовВознаграждение,
		|	ОтчетКомитенту.ИдентификаторДокумента КАК ИдентификаторДокумента,
		|	ОтчетКомитенту.Автор КАК Автор,
		|	ОтчетКомитенту.ДокументПродажи КАК ДокументПродажи
		|ИЗ
		|	Документ.ОтчетКомитенту КАК ОтчетКомитенту
		|ГДЕ
		|	ОтчетКомитенту.Ссылка = &Ссылка";
	
	Возврат ТекстЗапроса;
	
КонецФункции

#КонецОбласти

Процедура ЗаполнитьСуммыДляСчетаФактуры(ДанныеДляОбъекта, ДеревоДанных)
	
	Суммы = Документы.СчетФактураПолученный.ПустаяСсылка().ДокументыОснования.ВыгрузитьКолонки();
	
	СведенияОТоварах = ДеревоДанных.Строки.Найти("СведенияОТоварах", "ПолныйПуть");
	Для Каждого СведенияОТоваре Из СведенияОТоварах.Строки Цикл
		
		НоваяСтрока = Суммы.Добавить();
		НоваяСтрока.ДокументОснование = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.ДокументОснование");
		
		СтавкаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.НалоговаяСтавка");
		НоваяСтрока.СтавкаНДС = ?(СтавкаНДС = "НДС исчисляется налоговым агентом", УчетНДСУП.СтавкаНДСПоУмолчанию(ДанныеДляОбъекта.Шапка.Организация, ТекущаяДатаСеанса(), Истина), СтавкаНДС);
		НоваяСтрока.Сумма = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогом");
		НоваяСтрока.СуммаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,  "СведенияОТоварах.НомерСтроки.СуммаНалога");
		
	КонецЦикла;
	
	// Свернем суммы по реквизитам табличной части ДокументыОснования.
	Суммы.Свернуть("ДокументОснование,ХозяйственнаяОперация,ИсходныйДокумент,СтавкаНДС", "Сумма,СуммаНДС");
	ДанныеДляОбъекта.Вставить("Суммы", Суммы);
	
КонецПроцедуры

Процедура ЗаполнитьСуммыДляКорректировочногоСчетаФактуры(ДанныеДляОбъекта, ДеревоДанных)
	
	Суммы = Документы.СчетФактураПолученный.ПустаяСсылка().ДокументыОснования.ВыгрузитьКолонки();
	
	СведенияОТоварах = ДеревоДанных.Строки.Найти("СведенияОТоварах", "ПолныйПуть");
	Для Каждого СведенияОТоваре Из СведенияОТоварах.Строки Цикл
		
		НоваяСтрока = Суммы.Добавить();
		НоваяСтрока.ДокументОснование = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.ДокументОснование");
		
		СтавкаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.НалоговаяСтавка");
		НоваяСтрока.СтавкаНДС = ?(СтавкаНДС = "НДС исчисляется налоговым агентом", УчетНДСУП.СтавкаНДСПоУмолчанию(ДанныеДляОбъекта.Шапка.Организация, ТекущаяДатаСеанса(), Истина), СтавкаНДС);
		НоваяСтрока.Сумма = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогом");
		НоваяСтрока.СуммаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,  "СведенияОТоварах.НомерСтроки.СуммаНалога");
		НоваяСтрока.СуммаУвеличение = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогомУвеличение");
		НоваяСтрока.СуммаУменьшение = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогомУменьшение");
		НоваяСтрока.СуммаНДСУвеличение = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СуммаНалогаУвеличение");
		НоваяСтрока.СуммаНДСУменьшение = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СуммаНалогаУменьшение");
		
	КонецЦикла;
	
	// Свернем суммы по реквизитам табличной части ДокументыОснования.
	Суммы.Свернуть("ДокументОснование,ХозяйственнаяОперация,ИсходныйДокумент,СтавкаНДС", "Сумма,СуммаНДС,СуммаУвеличение,СуммаУменьшение,СуммаНДСУвеличение,СуммаНДСУменьшение");
	ДанныеДляОбъекта.Вставить("Суммы", Суммы);
	
КонецПроцедуры

#Область АктОРасхождениях

Функция РеквизитыУчастникаАктаОРасхождениях(Знач Участник)
	
	Реквизиты = Новый Структура("ИНН,КПП,Наименование");
	
	Если Участник.ТипУчастника.Свойство("ЮЛ") Тогда
		
		Реквизиты.ИНН = Участник.ТипУчастника.ЮЛ.ИНН;
		Реквизиты.КПП = Участник.ТипУчастника.ЮЛ.КПП;
		Реквизиты.Наименование = Участник.ТипУчастника.ЮЛ.НаименованиеОрганизации;
		
	ИначеЕсли Участник.ТипУчастника.Свойство("ИЛ") Тогда
		
		Реквизиты.Наименование = Участник.ТипУчастника.ИЛ.НаименованиеОрганизации;
		
	ИначеЕсли Участник.ТипУчастника.Свойство("ИП") Тогда
		
		Реквизиты.ИНН = Участник.ТипУчастника.ИП.ИНН;
		
	ИначеЕсли Участник.ТипУчастника.Свойство("ФЛ") Тогда
		
		Реквизиты.ИНН = Участник.ТипУчастника.ФЛ.ИНН;
		ЧастиФИО = Новый Массив;
		Если ЗначениеЗаполнено(Участник.ТипУчастника.ФЛ.Фамилия) Тогда
			ЧастиФИО.Добавить(Участник.ТипУчастника.ФЛ.Фамилия);
		КонецЕсли;
		Если ЗначениеЗаполнено(Участник.ТипУчастника.ФЛ.Имя) Тогда
			ЧастиФИО.Добавить(Участник.ТипУчастника.ФЛ.Имя);
		КонецЕсли;
		Если ЗначениеЗаполнено(Участник.ТипУчастника.ФЛ.Отчество) Тогда
			ЧастиФИО.Добавить(Участник.ТипУчастника.ФЛ.Отчество);
		КонецЕсли;
		Реквизиты.Наименование = СтрСоединить(ЧастиФИО);
		
	КонецЕсли;
	
	Возврат Реквизиты;
	
КонецФункции

Функция РеквизитыПриемщикаАктаОРасхождениях(Знач Приемщик)
	
	Реквизиты = Новый Структура("ФИО,Представление,Должность");
	Реквизиты.ФИО = Новый Структура("Фамилия,Имя,Отчество");
	
	Если Приемщик.Свойство("РаботникОрганизацииПокупателя") Тогда
		
		Работник = Приемщик.РаботникОрганизацииПокупателя;
		Реквизиты.ФИО.Фамилия = Работник.Фамилия;
		Реквизиты.ФИО.Имя = Работник.Имя;
		Реквизиты.ФИО.Отчество = Работник.Отчество;
		Реквизиты.Представление = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(Реквизиты.ФИО);
		Реквизиты.Должность = Работник.Должность;
		
	ИначеЕсли Приемщик.Свойство("ИноеЛицо") Тогда
		
		Если Приемщик.ИноеЛицо.Свойство("ПредставительОрганизации") Тогда
			
			Представитель = Приемщик.ИноеЛицо.ПредставительОрганизации;
			Реквизиты.ФИО.Фамилия = Представитель.Фамилия;
			Реквизиты.ФИО.Имя = Представитель.Имя;
			Реквизиты.ФИО.Отчество = Представитель.Отчество;
			Реквизиты.Представление = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(Реквизиты.ФИО);
			Реквизиты.Должность = Представитель.Должность;
			
		ИначеЕсли Приемщик.ИноеЛицо.Свойство("ФизическоеЛицо") Тогда
			
			ФизическоеЛицо = Приемщик.ИноеЛицо.ФизическоеЛицо;
			Реквизиты.ФИО.Фамилия = ФизическоеЛицо.Фамилия;
			Реквизиты.ФИО.Имя = ФизическоеЛицо.Имя;
			Реквизиты.ФИО.Отчество = ФизическоеЛицо.Отчество;
			Реквизиты.Представление = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(Реквизиты.ФИО);
			Реквизиты.Должность = ФизическоеЛицо.ОснованиеПолномочий;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Реквизиты;
	
КонецФункции

Функция НайтиРеализациюТоваровУслуг(Знач Организация, Знач НомерДокумента, Знач ДатаДокумента)
	
	Результат = Неопределено;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ДанныеПервичныхДокументов.Документ КАК СФ,
	|	ДанныеПервичныхДокументов.Документ.ДокументОснование КАК Документ
	|ИЗ
	|	РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|ГДЕ
	|	ДанныеПервичныхДокументов.Организация = &Организация
	|	И ДанныеПервичныхДокументов.Номер В (&НомерДокумента)
	|	И НАЧАЛОПЕРИОДА(ДанныеПервичныхДокументов.Дата, ДЕНЬ) = &ДатаДокумента
	|	И ТИПЗНАЧЕНИЯ(ДанныеПервичныхДокументов.Документ) = ТИП(Документ.СчетФактураВыданный) 
    |
    |ОБЪЕДИНИТЬ ВСЕ
    |
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	ДанныеПервичныхДокументов.Документ КАК СФ,
	|	ТЧСФ.ДокументОснование КАК Документ
	|ИЗ
	|	РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученный.ДокументыОснования КАК ТЧСФ
	|		ПО ТЧСФ.Ссылка = ДанныеПервичныхДокументов.Документ
	|ГДЕ
	|	ДанныеПервичныхДокументов.Организация = &Организация
	|	И ДанныеПервичныхДокументов.Номер В (&НомерДокумента)
	|	И НАЧАЛОПЕРИОДА(ДанныеПервичныхДокументов.Дата, ДЕНЬ) = &ДатаДокумента
	|	И ТИПЗНАЧЕНИЯ(ДанныеПервичныхДокументов.Документ) = ТИП(Документ.СчетФактураПолученный)
	|
    |ОБЪЕДИНИТЬ ВСЕ
    |
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	Неопределено КАК СФ,
	|	ДанныеПервичныхДокументов.Документ КАК Документ
	|ИЗ
	|	РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|ГДЕ
	|	ДанныеПервичныхДокументов.Организация = &Организация
	|	И ДанныеПервичныхДокументов.Номер В (&НомерДокумента)
	|	И НАЧАЛОПЕРИОДА(ДанныеПервичныхДокументов.Дата, ДЕНЬ) = &ДатаДокумента
	|	И ТИПЗНАЧЕНИЯ(ДанныеПервичныхДокументов.Документ) В (ТИП(Документ.РеализацияТоваровУслуг),ТИП(Документ.ВозвратТоваровПоставщику))";
	
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("ДатаДокумента", НачалоДня(ДатаДокумента));
	
	НомерДокументаБезПрефикса = ПрефиксацияОбъектовКлиентСервер.НомерНаПечать(НомерДокумента, Истина, Истина);
	МассивНомеров = Новый Массив;
	МассивНомеров.Добавить(НомерДокумента);
	МассивНомеров.Добавить(НомерДокументаБезПрефикса);
	Запрос.УстановитьПараметр("НомерДокумента", МассивНомеров);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Результат = Выборка.Документ;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Процедура ЗаполнитьНаОсновании(Основание, ДокументОбъект)
	
	Запрос = Новый Запрос;
	Если ТипЗнч(Основание) = Тип("ДокументСсылка.ВозвратТоваровПоставщику") Тогда
		ДокументОбъект.ТипОснованияАктаОРасхождении = Перечисления.ТипыОснованияАктаОРасхождении.ВозвратПоставщику;
		Запрос.Текст = ТекстЗапросаПоОснованиюВозврату();
	Иначе
		ДокументОбъект.ТипОснованияАктаОРасхождении = Перечисления.ТипыОснованияАктаОРасхождении.РеализацияТоваровУслуг;
		Запрос.Текст = ТекстЗапросаПоОснованиюРеализации();
	КонецЕсли;
	
	Запрос.УстановитьПараметр("Основание", Основание);
	РезультатЗапроса = Запрос.ВыполнитьПакет();
	
	РеквизитыОснования = РезультатЗапроса[0].Выбрать();
	РеквизитыОснования.Следующий();
	
	МассивДопустимыхСтатусов = Новый Массив;
	МассивДопустимыхСтатусов.Добавить(Перечисления.СтатусыРеализацийТоваровУслуг.Отгружено);
	
	ОбщегоНазначенияУТ.ПроверитьВозможностьВводаНаОсновании(
		РеквизитыОснования.РеализацияТоваровУслуг,
		РеквизитыОснования.СтатусДокумента,
		РеквизитыОснования.ЕстьОшибкиПроведен,
		РеквизитыОснования.ЕстьОшибкиСтатус,
		МассивДопустимыхСтатусов,
		РеквизитыОснования.СоглашениеДоступноВнешнимПользователям);
	
	// Заполнение шапки
	ЗаполнитьЗначенияСвойств(ДокументОбъект, РеквизитыОснования);
	
	ДокументОбъект.Товары.Загрузить(РезультатЗапроса[1].Выгрузить());
	ДокументОбъект.Серии.Загрузить(РезультатЗапроса[2].Выгрузить());
	
КонецПроцедуры

Функция ТекстЗапросаПоОснованиюРеализации()

	Возврат "
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	НЕ РеализацияТоваровУслуг.Проведен КАК ЕстьОшибкиПроведен,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслуг.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыРеализацийТоваровУслуг.Отгружено)
	|			ИЛИ РеализацияТоваровУслуг.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыРеализацийТоваровУслуг.ПустаяСсылка)
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ЕстьОшибкиСтатус,
	|	РеализацияТоваровУслуг.Ссылка КАК РеализацияТоваровУслуг,
	|	РеализацияТоваровУслуг.Статус КАК СтатусДокумента,
	|	РеализацияТоваровУслуг.Организация,
	|	РеализацияТоваровУслуг.Контрагент,
	|	РеализацияТоваровУслуг.Менеджер,
	|	РеализацияТоваровУслуг.НалогообложениеНДС,
	|	РеализацияТоваровУслуг.Партнер,
	|	РеализацияТоваровУслуг.Валюта,
	|	ПРЕДСТАВЛЕНИЕ(РеализацияТоваровУслуг.Грузоотправитель) КАК Грузоотправитель,
	|	РеализацияТоваровУслуг.ХозяйственнаяОперация,
	|	РеализацияТоваровУслуг.ЦенаВключаетНДС,
	|	РеализацияТоваровУслуг.Договор,
	|	РеализацияТоваровУслуг.КонтактноеЛицо,
	|	РеализацияТоваровУслуг.Соглашение,
	|	РеализацияТоваровУслуг.Подразделение,
	|	РеализацияТоваровУслуг.Соглашение.ДоступноВнешнимПользователям КАК СоглашениеДоступноВнешнимПользователям
	|ИЗ
	|	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	|ГДЕ
	|	РеализацияТоваровУслуг.Ссылка = &Основание
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	РеализацияТоваровУслугТовары.Номенклатура,
	|	РеализацияТоваровУслугТовары.Характеристика,
	|	РеализацияТоваровУслугТовары.Серия,
	|	РеализацияТоваровУслугТовары.Назначение,
	|	РеализацияТоваровУслугТовары.Упаковка,
	|	РеализацияТоваровУслугТовары.КоличествоУпаковок,
	|	РеализацияТоваровУслугТовары.Количество,
	|	РеализацияТоваровУслугТовары.ВидЦены,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.КоличествоУпаковок = 0
	|			ТОГДА РеализацияТоваровУслугТовары.Цена
	|		ИНАЧЕ
	|			ВЫРАЗИТЬ(РеализацияТоваровУслугТовары.Сумма / РеализацияТоваровУслугТовары.КоличествоУпаковок КАК ЧИСЛО(31,2))
	|	КОНЕЦ КАК Цена,
	|	РеализацияТоваровУслугТовары.Сумма,
	|	РеализацияТоваровУслугТовары.СтавкаНДС,
	|	РеализацияТоваровУслугТовары.Склад,
	|	РеализацияТоваровУслугТовары.СуммаНДС,
	|	РеализацияТоваровУслугТовары.СуммаСНДС,
	|	РеализацияТоваровУслугТовары.СтатусУказанияСерий,
	|	РеализацияТоваровУслугТовары.Ссылка КАК Реализация,
	|	РеализацияТоваровУслугТовары.ЗаказКлиента КАК ЗаказКлиента,
	|	РеализацияТоваровУслугТовары.КодСтроки КАК КодСтроки,
	|	ИСТИНА КАК ЗаполненоПоРеализации,
	|	РеализацияТоваровУслугТовары.КоличествоУпаковок КАК КоличествоУпаковокПоДокументу,
	|	РеализацияТоваровУслугТовары.Количество КАК КоличествоПоДокументу,
	|	РеализацияТоваровУслугТовары.Сумма КАК СуммаПоДокументу,
	|	РеализацияТоваровУслугТовары.СуммаНДС КАК СуммаНДСПоДокументу,
	|	РеализацияТоваровУслугТовары.СуммаСНДС КАК СуммаСНДСПоДокументу
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|ГДЕ
	|	РеализацияТоваровУслугТовары.Ссылка = &Основание
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	РеализацияТоваровУслугСерии.Серия          КАК Серия,
	|	РеализацияТоваровУслугСерии.Количество     КАК Количество,
	|	РеализацияТоваровУслугСерии.Количество     КАК КоличествоПоДокументу,
	|	РеализацияТоваровУслугСерии.Номенклатура   КАК Номенклатура,
	|	РеализацияТоваровУслугСерии.Характеристика КАК Характеристика,
	|	РеализацияТоваровУслугСерии.Назначение     КАК Назначение,
	|	РеализацияТоваровУслугСерии.Склад          КАК Склад,
	|	РеализацияТоваровУслугСерии.Ссылка         КАК Реализация,
	|	ИСТИНА                                     КАК ЗаполненоПоРеализации
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Серии КАК РеализацияТоваровУслугСерии
	|ГДЕ
	|	РеализацияТоваровУслугСерии.Ссылка = &Основание
	|";

КонецФункции 

Функция ТекстЗапросаПоОснованиюВозврату()

	Возврат "
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	НЕ ВозвратТоваровПоставщику.Проведен КАК ЕстьОшибкиПроведен,
	|	ЛОЖЬ КАК ЕстьОшибкиСтатус,
	|	ВозвратТоваровПоставщику.Ссылка КАК РеализацияТоваровУслуг,
	|	НЕОПРЕДЕЛЕНО КАК СтатусДокумента,
	|	ВозвратТоваровПоставщику.Организация,
	|	ВозвратТоваровПоставщику.Контрагент,
	|	ВозвратТоваровПоставщику.Менеджер,
	|	ВозвратТоваровПоставщику.НалогообложениеНДС,
	|	ВозвратТоваровПоставщику.Партнер,
	|	ВозвратТоваровПоставщику.Валюта,
	|	ПРЕДСТАВЛЕНИЕ(ВозвратТоваровПоставщику.Грузоотправитель) КАК Грузоотправитель,
	|	ВозвратТоваровПоставщику.ХозяйственнаяОперация,
	|	ВозвратТоваровПоставщику.ЦенаВключаетНДС,
	|	ВозвратТоваровПоставщику.Договор,
	|	ВозвратТоваровПоставщику.КонтактноеЛицо,
	|	ВозвратТоваровПоставщику.Соглашение,
	|	ВозвратТоваровПоставщику.Подразделение,
	|	ЛОЖЬ КАК СоглашениеДоступноВнешнимПользователям
	|ИЗ
	|	Документ.ВозвратТоваровПоставщику КАК ВозвратТоваровПоставщику
	|ГДЕ
	|	ВозвратТоваровПоставщику.Ссылка = &Основание
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ВозвратТоваровПоставщикуТовары.Номенклатура,
	|	ВозвратТоваровПоставщикуТовары.Характеристика,
	|	ВозвратТоваровПоставщикуТовары.Серия,
	|	ВозвратТоваровПоставщикуТовары.Назначение,
	|	ВозвратТоваровПоставщикуТовары.Упаковка,
	|	ВозвратТоваровПоставщикуТовары.КоличествоУпаковок,
	|	ВозвратТоваровПоставщикуТовары.Количество,
	|	ВозвратТоваровПоставщикуТовары.Цена КАК Цена,
	|	ВозвратТоваровПоставщикуТовары.Сумма,
	|	ВозвратТоваровПоставщикуТовары.СтавкаНДС,
	|	ВозвратТоваровПоставщикуТовары.Ссылка.Склад,
	|	ВозвратТоваровПоставщикуТовары.СуммаНДС,
	|	ВозвратТоваровПоставщикуТовары.СуммаСНДС,
	|	ВозвратТоваровПоставщикуТовары.СтатусУказанияСерий,
	|	ВозвратТоваровПоставщикуТовары.Ссылка КАК Реализация,
	|	ЗНАЧЕНИЕ(Документ.ЗаказКлиента.ПустаяСсылка) КАК ЗаказКлиента,
	|	ИСТИНА КАК ЗаполненоПоРеализации,
	|	ВозвратТоваровПоставщикуТовары.КоличествоУпаковок КАК КоличествоУпаковокПоДокументу,
	|	ВозвратТоваровПоставщикуТовары.Количество КАК КоличествоПоДокументу,
	|	ВозвратТоваровПоставщикуТовары.Сумма КАК СуммаПоДокументу,
	|	ВозвратТоваровПоставщикуТовары.СуммаНДС КАК СуммаНДСПоДокументу,
	|	ВозвратТоваровПоставщикуТовары.СуммаСНДС КАК СуммаСНДСПоДокументу,
	|	ВозвратТоваровПоставщикуТовары.ДокументПоступления
	|ИЗ
	|	Документ.ВозвратТоваровПоставщику.Товары КАК ВозвратТоваровПоставщикуТовары
	|ГДЕ
	|	ВозвратТоваровПоставщикуТовары.Ссылка = &Основание
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ВозвратТоваровПоставщикуСерии.Серия КАК Серия,
	|	ВозвратТоваровПоставщикуСерии.Количество КАК Количество,
	|	ВозвратТоваровПоставщикуСерии.Количество КАК КоличествоПоДокументу,
	|	ВозвратТоваровПоставщикуСерии.Номенклатура КАК Номенклатура,
	|	ВозвратТоваровПоставщикуСерии.Характеристика КАК Характеристика,
	|	ВозвратТоваровПоставщикуСерии.Назначение КАК Назначение,
	|	ВозвратТоваровПоставщикуСерии.Ссылка.Склад КАК Склад,
	|	ВозвратТоваровПоставщикуСерии.Ссылка КАК Реализация,
	|	ИСТИНА КАК ЗаполненоПоРеализации
	|ИЗ
	|	Документ.ВозвратТоваровПоставщику.Серии КАК ВозвратТоваровПоставщикуСерии
	|ГДЕ
	|	ВозвратТоваровПоставщикуСерии.Ссылка = &Основание";

КонецФункции

#КонецОбласти

#Область ВспомогательныеМетоды_АктСверкиВзаиморасчетов

Процедура ЗаполнитьОтправителяПолучателяАктСверкиВзаиморасчетов(ДеревоДанных,
																СсылкаНаОтправителяПолучателя,
																СсылкаНаДокумент,
																ДатаДокумента,
																ЭтоОтправитель = Истина)
	
	// В том случае, если ОГРН не известен, требуется указать нули.
	ОГРНИП = "000000000000000";
	ОГРНЮЛ = "0000000000000";
	
	ОтправительПолучатель	= Неопределено;
	РеквизитДерева			= ?(ЭтоОтправитель, "Отправитель", "Получатель");
	ПутьКДанным				= ?(ЭтоОтправитель, "Объект.Организация", "Объект.Контрагент");
	
	Если ЗначениеЗаполнено(СсылкаНаОтправителяПолучателя) Тогда
		ОтправительПолучатель = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(СсылкаНаОтправителяПолучателя,
																					Неопределено,
																					ДатаДокумента);
		
		Если Не ЗначениеЗаполнено(ОтправительПолучатель.ОГРН) Тогда
			ОтправительПолучатель.ОГРН = ?(ОтправительПолучатель.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ИндивидуальныйПредприниматель,
											ОГРНИП,
											ОГРНЮЛ);
		КонецЕсли;
		
		ЗаполнитьДанныеУчастникаАктаСверкиВзаиморасчетов(ДеревоДанных,
														ОтправительПолучатель,
														РеквизитДерева,
														"Юр",
														ДатаДокумента);
	Иначе
		ПараметрыОбработкиОшибок = ЭлектронноеВзаимодействиеКлиентСервер.НовыеПараметрыОбработкиОшибки(
									СсылкаНаДокумент,
									ПутьКДанным);
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
																	РеквизитДерева,
																	ОтправительПолучатель,
																	ПараметрыОбработкиОшибок);
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьДанныеУчастникаАктаСверкиВзаиморасчетов(ДеревоДанных,
															СведенияОбУчастнике,
															ВидУчастника,
															ВидАдреса = "Юр",
															ДатаКИ = Неопределено)
	
	// Заполнение сведений о типе участника.
	Если СведенияОбУчастнике.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ЮрЛицо Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ЮЛ.НаименованиеОрганизации",
			СведенияОбУчастнике.ПолноеНаименование);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ЮЛ.ИНН",
			СведенияОбУчастнике.ИНН);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ЮЛ.КПП",
			СведенияОбУчастнике.КПП);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ЮЛ.ОГРН",
			СведенияОбУчастнике.ОГРН);
	ИначеЕсли СведенияОбУчастнике.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ЮрЛицоНеРезидент Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ИЛ.НаименованиеОрганизации",
			СведенияОбУчастнике.ПолноеНаименование);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ИЛ.ИдентификаторОрганизации",
			СведенияОбУчастнике.НалоговыйНомерВСтранеРегистрации);
	ИначеЕсли СведенияОбУчастнике.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ИндивидуальныйПредприниматель Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ИП.ИНН",
			СведенияОбУчастнике.ИНН);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ИП.ОГРН",
			СведенияОбУчастнике.ОГРН);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ИП.Фамилия",
			СведенияОбУчастнике.Фамилия);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ИП.Имя",
			СведенияОбУчастнике.Имя);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ИП.Отчество",
			СведенияОбУчастнике.Отчество);
	Иначе
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ФЛ.ИНН",
			СведенияОбУчастнике.ИНН);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ФЛ.Фамилия",
			СведенияОбУчастнике.Фамилия);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ФЛ.Имя",
			СведенияОбУчастнике.Имя);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ФЛ.Отчество",
			СведенияОбУчастнике.Отчество);
	КонецЕсли;
	
	// Заполнение сведений об адресе.
	Если ТипЗнч(СведенияОбУчастнике.Ссылка) = Тип("СправочникСсылка.Организации") Тогда
		ВидКонтактнойИнформации = Справочники.ВидыКонтактнойИнформации[ВидАдреса + "АдресОрганизации"];
	ИначеЕсли ТипЗнч(СведенияОбУчастнике.Ссылка) = Тип("СправочникСсылка.Контрагенты") Тогда
		ВидКонтактнойИнформации = Справочники.ВидыКонтактнойИнформации[ВидАдреса + "АдресКонтрагента"];
	Иначе
		ВидКонтактнойИнформации = Неопределено;
	КонецЕсли;
	
	ОбъектКонтактнойИнформации	= СведенияОбУчастнике.Ссылка;
	АдресКонтрагентаЗаполнен	= Истина;
	
	Если ТипЗнч(СведенияОбУчастнике.Ссылка) = Тип("СправочникСсылка.Контрагенты") Тогда
		ПроверкаЗаполненностиАдреса	= УправлениеКонтактнойИнформацией.КонтактнаяИнформацияОбъекта(
										ОбъектКонтактнойИнформации,
										ВидКонтактнойИнформации,
										ТекущаяДатаСеанса());
		АдресКонтрагентаЗаполнен	= ЗначениеЗаполнено(ПроверкаЗаполненностиАдреса);
	КонецЕсли;
	
	Если Не АдресКонтрагентаЗаполнен
		И ПолучитьФункциональнуюОпцию("ИспользоватьПартнеровКакКонтрагентов") Тогда
		
		ВидКонтактнойИнформации		= Справочники.ВидыКонтактнойИнформации["АдресПартнера"];
		ОбъектКонтактнойИнформации	= ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СведенияОбУчастнике.Ссылка, "Партнер");
		
	КонецЕсли;

	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		ДеревоДанных,
		ВидУчастника + ".Адрес.АвтоматическиЗаполняемый.ОбъектКонтактнойИнформации",
		ОбъектКонтактнойИнформации);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		ДеревоДанных,
		ВидУчастника + ".Адрес.АвтоматическиЗаполняемый.ВидКонтактнойИнформации",
		ВидКонтактнойИнформации);
	
	АдресУчастника = Новый Структура;
	
	СведенияОбУчастнике.Вставить("ДатаКИ", ДатаКИ);
	
	ПолучитьАдресСтруктурой(АдресУчастника, СведенияОбУчастнике, "Ссылка", ВидАдреса);
	
	// Заполнение информации о контактных сведениях.
	Если ЗначениеЗаполнено(СведенияОбУчастнике.Телефоны) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".КонтактныеСведения.Телефон",
			СведенияОбУчастнике.Телефоны);
	КонецЕсли;

	Если ЗначениеЗаполнено(СведенияОбУчастнике.ЭлектроннаяПочта) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".КонтактныеСведения.ЭлектроннаяПочта",
			СведенияОбУчастнике.ЭлектроннаяПочта);
	КонецЕсли;
	
КонецПроцедуры

// Возвращает структуру, заполненную по данным ЭД отправителя, используемую для заполнения документа
// 'СверкаВзаиморасчетов2_5_11'.
//
// Параметры:
//	ДеревоДанных - ДеревоЗначений - данные электронного документа в виде заполненного макета
//									см. Обработка.ОбменСКонтрагентами.Макет.АктСверкиВзаиморасчетов_ИнформацияОтправителя_5_01.
//
// Возвращаемое значение:
//	Структура - см. ОписаниеДанныхДляЗаполненияАктаСверкиВзаиморасчетовПоДаннымЭД.
//
Функция ПодготовитьСтруктуруДляАктаСверкиВзаиморасчетовПоДаннымОтправителя(ДеревоДанных)
	
	ДанныеДляЗаполнения	= ОписаниеДанныхДляЗаполненияАктаСверкиВзаиморасчетовПоДаннымЭД();
	ДанныеЭД			= ДанныеВходящегоЭД(ДеревоДанных);
	
	// Заполнение шапки документа.
	ДанныеДляЗаполнения.ДанныеШапки = ДанныеШапкиАктаСверкиВзаиморасчетовПоДаннымОтправителя(ДеревоДанных, ДанныеЭД);
	
	// Заполнение сведений табличных частей.
	ЗаполнитьТаблицыДанныхДляЗаполненияАктаСверкиВзаиморасчетовПоДаннымЭД(ДанныеДляЗаполнения,
																			ДанныеЭД.СведенияОтправителя);
	
	Возврат ДанныеДляЗаполнения;
	
КонецФункции

// Возвращает структуру, заполненную по данным ЭД и используемую для заполнения документа 'СверкаВзаиморасчетов2_5_11'.
//
// Возвращаемое значение:
//	Структура - коллекция данных ЭД, используемая для заполнения документа 'СверкаВзаиморасчетов2_5_11', содержащая следующие свойства:
//		* ДанныеШапки - Структура - см. ДанныеШапкиАктаСверкиВзаиморасчетовПоДаннымОтправителя или см. ДанныеШапкиАктаСверкиВзаиморасчетовПоДаннымПолучателя.
//		* ИтоговыеЗаписи - см. ОписаниеТаблицыИтоговыеЗаписиАктаСверкиВзаиморасчетов.
//		* ДетальныеЗаписи - см. ОписаниеТаблицыДетальныеЗаписиАктаСверкиВзаиморасчетов.
//
Функция ОписаниеДанныхДляЗаполненияАктаСверкиВзаиморасчетовПоДаннымЭД()
	
	ДанныеДляЗаполнения = Новый Структура;
	ДанныеДляЗаполнения.Вставить("ДанныеШапки",		Новый Структура);
	ДанныеДляЗаполнения.Вставить("ИтоговыеЗаписи",	ОписаниеТаблицыИтоговыеЗаписиАктаСверкиВзаиморасчетов());
	ДанныеДляЗаполнения.Вставить("ДетальныеЗаписи",	ОписаниеТаблицыДетальныеЗаписиАктаСверкиВзаиморасчетов());
	
	Возврат ДанныеДляЗаполнения;
	
КонецФункции

// Возвращает структуру, полученную при конвертации дерева значений данных ЭД, где ключом выступает значение
// колонки 'ПолныйПуть', а значением данные строк.
//
// Параметры:
//	ДеревоДанных - ДеревоЗначений - данные электронного документа в виде заполненного макета
//									см. Обработка.ОбменСКонтрагентами.Макет.АктСверкиВзаиморасчетов_ИнформацияОтправителя_5_01.
//
// Возвращаемое значение:
//	Структура - данные дерева значений ЭД.
//
Функция ДанныеВходящегоЭД(ДеревоДанных)
	
	ДанныеЭД = Новый Структура;
	
	Для Каждого СтрокаДерева Из ДеревоДанных.Строки Цикл
		Путь = СтрокаДерева.ПолныйПуть;
		ДанныеСтроки = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(ДеревоДанных, Путь);
		
		ДанныеЭД.Вставить(Путь, ДанныеСтроки);
	КонецЦикла;
	
	Возврат ДанныеЭД;
	
КонецФункции

// Возвращает структуру, описывающую данные шапки документа 'СверкаВзаиморасчетов2_5_11'.
//
// Параметры:
//	ДеревоДанных - ДеревоЗначений - данные электронного документа в виде заполненного макета
//									см. Обработка.ОбменСКонтрагентами.Макет.АктСверкиВзаиморасчетов_ИнформацияОтправителя_5_01.
//	ДанныеЭД - см. ДанныеВходящегоЭД.
//
// Возвращаемое значение:
//	Структура - коллекция описывающая сведения шапки документа 'СверкаВзаиморасчетов2_5_11', содержащая следующие свойства:
//		* НомерКонтрагента - Строка - номер входящего документа Акта сверки взаиморасчетов по данным контрагента.
//		* НачалоПериода - Дата - дата начала периода сверки.
//		* КонецПериода - Дата - дата окончания периода сверки.
//		* Организация - СправочникСсылка.Организации, Неопределено - организация от имени которой составлен документ.
//		* Контрагент - СправочникСсылка.Контрагенты, СправочникСсылка.Организации, Неопределено - отправитель Акта сверки взаиморасчетов.
//		* Партнер - СправочникСсылка.Партнеры, Неопределено - партнер контрагента.
//		* Валюта - СправочникСсылка.Валюты, Неопределено - валюта документа.
//
Функция ДанныеШапкиАктаСверкиВзаиморасчетовПоДаннымОтправителя(ДеревоДанных, ДанныеЭД)
	
	НомерКонтрагента = ДанныеЭД.НомерДокумента; // Строка -
	
	НачалоПериода	= ДанныеЭД.ДатаНачалаПериодаСверки; // Дата -
	КонецПериода	= ДанныеЭД.ДатаОкончанияПериодаСверки; // Дата -
	
	Контрагент	= КонтрагентПоДаннымЭД(ДеревоДанных, "Отправитель"); // СправочникСсылка.Контрагенты, Неопределено - 
	
	Если Контрагент = Неопределено Тогда		
		ОрганизацияОтправитель = ОрганизацияПоДаннымЭД(ДеревоДанных, "Отправитель"); // СправочникСсылка.Организация, Неопределено - 
		Партнер = Неопределено;
		Отправитель = ОрганизацияОтправитель;		
	Иначе
		Партнер		= ?(ЗначениеЗаполнено(Контрагент),
						ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Контрагент, "Партнер"),
						Неопределено); // СправочникСсылка.Партнеры, Неопределено - 
		Отправитель = Контрагент;		
	КонецЕсли;
	
	Валюта = Неопределено;
	ЭлектронноеВзаимодействиеПереопределяемый.НайтиСсылкуНаОбъект("Валюты", Валюта, ДанныеЭД.КодВалюты);
	
	ДанныеШапки = Новый Структура;
	ДанныеШапки.Вставить("НомерКонтрагента",	НомерКонтрагента);
	ДанныеШапки.Вставить("НачалоПериода",		НачалоПериода);
	ДанныеШапки.Вставить("КонецПериода",		КонецПериода);
	ДанныеШапки.Вставить("Организация",			ОрганизацияПоДаннымЭД(ДеревоДанных, "Получатель"));
	ДанныеШапки.Вставить("Контрагент",			Отправитель);
	ДанныеШапки.Вставить("Партнер",				Партнер);
	ДанныеШапки.Вставить("Валюта",				Валюта);
	
	Возврат ДанныеШапки;
	
КонецФункции

// Заполняет таблицы по данным ЭД, используемые при заполнении табличных частей документа 'СверкаВзаиморасчетов2_5_11'.
//
// Параметры:
//	ДанныеДляЗаполнения - см. ОписаниеДанныхДляЗаполненияАктаСверкиВзаиморасчетовПоДаннымЭД.
//	ДанныеЭД - см. ДанныеВходящегоЭД.
//
Процедура ЗаполнитьТаблицыДанныхДляЗаполненияАктаСверкиВзаиморасчетовПоДаннымЭД(ДанныеДляЗаполнения, ДанныеЭД)
	
	ИтоговыеЗаписи	= ДанныеДляЗаполнения.ИтоговыеЗаписи;
	ДетальныеЗаписи	= ДанныеДляЗаполнения.ДетальныеЗаписи;
	
	Для Каждого СтрокаДоговора Из ДанныеЭД.СведенияПоДоговорам Цикл
		СтрокаИтогов = ИтоговыеЗаписи.Добавить();
		ЗаполнитьСтрокуТаблицыИтоговыеЗаписиАктаСверкиВзаиморасчетов(СтрокаИтогов, СтрокаДоговора);
		
		Для Каждого СтрокаДокумента Из СтрокаДоговора.СведенияПоДокументам Цикл
			Для Каждого СтрокаОперации Из СтрокаДокумента.СведенияПоОперациям Цикл
				Если СтрокаОперации.СуммаДебет = 0
					И СтрокаОперации.СуммаКредит = 0 Тогда
					
					Продолжить;
					
				КонецЕсли;
				
				СтрокаЗаписи = ДетальныеЗаписи.Добавить();
				ЗаполнитьСтрокуТаблицыДетальныеЗаписиАктаСверкиВзаиморасчетов(СтрокаЗаписи,
																				СтрокаДоговора,
																				СтрокаДокумента,
																				СтрокаОперации);
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;
	
КонецПроцедуры

// Возвращает таблицу, описывающую табличную часть 'ИтоговыеЗаписи' документа 'СверкаВзаиморасчетов2_5_11'.
//
// Возвращаемое значение:
//	ТаблицаЗначений - таблица, описывающую табличную часть 'ИтоговыеЗаписи' документа 'СверкаВзаиморасчетов2_5_11', содержащая следующие колонки:
//		* ИдентификаторОбъекта - Строка - идентификатор договора.
//		* НомерДоговора - Строка - номер договора.
//		* НомерДоговораКонтрагент - Строка - номер договора по данным контрагента.
//		* ДатаДоговора - Дата - дата оформления договора.
//		* ДатаДоговораКонтрагент - Дата - дата оформления договора по данным контрагента.
//		* НаименованиеДоговора - Строка - наименование договора.
//		* НаименованиеДоговораКонтрагент - Строка - наименование договора по данным контрагента.
//		* НачальноеСальдоДтКонтрагент - Число - начальное сальдо Дт взаиморасчетов по договору по данным контрагента.
//		* НачальноеСальдоКтКонтрагент - Число - начальное сальдо Кт взаиморасчетов по договору по данным контрагента.
//		* ОборотДтКонтрагент - Число - оборот взаиморасчетов по Дт в рамках договора по данным контрагента.
//		* ОборотКтКонтрагент - Число - оборот взаиморасчетов по Кт в рамках договора по данным контрагента.
//		* КонечноеСальдоДтКонтрагент - Число -  конечное сальдо Дт взаиморасчетов по договору по данным контрагента.
//		* КонечноеСальдоКтКонтрагент - Число -  конечное сальдо Кт взаиморасчетов по договору по данным контрагента.
//
Функция ОписаниеТаблицыИтоговыеЗаписиАктаСверкиВзаиморасчетов()
	
	ИменаКолонок = Новый Массив;
	ИменаКолонок.Добавить("НомерДоговора");
	ИменаКолонок.Добавить("НомерДоговораКонтрагент");
	ИменаКолонок.Добавить("ДатаДоговора");
	ИменаКолонок.Добавить("ДатаДоговораКонтрагент");
	ИменаКолонок.Добавить("НаименованиеДоговора");
	ИменаКолонок.Добавить("НаименованиеДоговораКонтрагент");
	ИменаКолонок.Добавить("НачальноеСальдоДтКонтрагент");
	ИменаКолонок.Добавить("НачальноеСальдоКтКонтрагент");
	ИменаКолонок.Добавить("ОборотДтКонтрагент");
	ИменаКолонок.Добавить("ОборотКтКонтрагент");
	ИменаКолонок.Добавить("КонечноеСальдоДтКонтрагент");
	ИменаКолонок.Добавить("КонечноеСальдоКтКонтрагент");
	
	ТабличнаяЧасть	= Метаданные.Документы.СверкаВзаиморасчетов2_5_11.ТабличныеЧасти.ИтоговыеЗаписи;
	ИтоговыеЗаписи	= ОписаниеТаблицыАктаСверкиВзаиморасчетов(ТабличнаяЧасть, ИменаКолонок);
	
	ДобавитьКолонкуИдентификатораВТаблицуАктаСверкиВзаиморасчетов(ИтоговыеЗаписи);
	
	Возврат ИтоговыеЗаписи;
	
КонецФункции

// Возвращает таблицу, описывающую табличную часть 'ДетальныеЗаписи' документа 'СверкаВзаиморасчетов2_5_11'.
//
// Возвращаемое значение:
//	ТаблицаЗначений - таблица, описывающую табличную часть 'ДетальныеЗаписи' документа 'СверкаВзаиморасчетов2_5_11', содержащая следующие колонки:
//		* ИдентификаторОбъекта - Строка - идентификатор договора.
//		* НомерДокумента - Строка - номер документа.
//		* НомерДокументаКонтрагент - Строка - номер документа по данным контрагента.
//		* ДатаДокумента - Дата - дата оформления документа.
//		* ДатаДокументаКонтрагент - Дата - дата оформления документа по данным контрагента.
//		* НаименованиеДокумента - Строка - наименование документа.
//		* НаименованиеДокументаКонтрагент - Строка - наименование документа по данным контрагента.
//		* СуммаДебет - Число - сумма Дт взаиморасчетов по документу.
//		* СуммаДебетКонтрагент - Число - сумма Дт взаиморасчетов по документу по данным контрагента.
//		* СуммаКредит - Число - сумма Кт взаиморасчетов по документу.
//		* СуммаКредитКонтрагент - Число - сумма Кт взаиморасчетов по документу по данным контрагента.
//
Функция ОписаниеТаблицыДетальныеЗаписиАктаСверкиВзаиморасчетов()
	
	ИменаКолонок = Новый Массив;
	ИменаКолонок.Добавить("НомерДокумента");
	ИменаКолонок.Добавить("НомерДокументаКонтрагент");
	ИменаКолонок.Добавить("ДатаДокумента");
	ИменаКолонок.Добавить("ДатаДокументаКонтрагент");
	ИменаКолонок.Добавить("НаименованиеДокумента");
	ИменаКолонок.Добавить("НаименованиеДокументаКонтрагент");
	ИменаКолонок.Добавить("СуммаДебет");
	ИменаКолонок.Добавить("СуммаДебетКонтрагент");
	ИменаКолонок.Добавить("СуммаКредит");
	ИменаКолонок.Добавить("СуммаКредитКонтрагент");
	
	ТабличнаяЧасть	= Метаданные.Документы.СверкаВзаиморасчетов2_5_11.ТабличныеЧасти.ДетальныеЗаписи;
	ДетальныеЗаписи	= ОписаниеТаблицыАктаСверкиВзаиморасчетов(ТабличнаяЧасть, ИменаКолонок);
	
	ДобавитьКолонкуИдентификатораВТаблицуАктаСверкиВзаиморасчетов(ДетальныеЗаписи);
	ДобавитьКолонкиДоговораВТаблицуАктаСверкиВзаиморасчетов(ДетальныеЗаписи);
	
	Возврат ДетальныеЗаписи;
	
КонецФункции

// Возвращает таблицу, описывающую табличную часть документа 'СверкаВзаиморасчетов2_5_11', по переданному списку имен
// колонок. Если второй параметр не указан, тогда возвращается таблица с описанием всех колонок табличной части.
//
// Параметры:
//	ТабличнаяЧастьДокумента - ТабличнаяЧасть - табличная часть документа 'СверкаВзаиморасчетов2_5_11'.
//	ИменаКолонок - Массив Из Строка, Неопределено - коллекция, содержащая имена колонок создаваемой таблицы.
//	
//
// Возвращаемое значение:
//	ТаблицаЗначений - таблица, описывающая табличную часть документа 'СверкаВзаиморасчетов2_5_11'.
//
Функция ОписаниеТаблицыАктаСверкиВзаиморасчетов(ТабличнаяЧастьДокумента, ИменаКолонок = Неопределено)
	
	ТЗ = Новый ТаблицаЗначений;
	
	Если ИменаКолонок = Неопределено Тогда
		Для Каждого РеквизитТЧ Из ТабличнаяЧастьДокумента.Реквизиты Цикл
			ТЗ.Колонки.Добавить(РеквизитТЧ.Имя, РеквизитТЧ.Тип);
		КонецЦикла;
	Иначе
		Для Каждого ИмяКолонки Из ИменаКолонок Цикл
			РеквизитТЧ = ТабличнаяЧастьДокумента.Реквизиты.Найти(ИмяКолонки);
			
			Если РеквизитТЧ <> Неопределено Тогда
				ТЗ.Колонки.Добавить(РеквизитТЧ.Имя, РеквизитТЧ.Тип);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Возврат ТЗ;
	
КонецФункции

// Добавляет в таблицу колонку, которая хранит данные об идентификаторе ключевого свойства строки.
//
// Параметры:
//	ТаблицаАкта - ТаблицаЗначений - таблица документа.
//
Процедура ДобавитьКолонкуИдентификатораВТаблицуАктаСверкиВзаиморасчетов(ТаблицаАкта)
	
	ОписаниеТипаИдентификатора = Новый ОписаниеТипов("Строка", Новый КвалификаторыСтроки(100));
	
	ТаблицаАкта.Колонки.Добавить("ИдентификаторОбъекта", ОписаниеТипаИдентификатора);
	
КонецПроцедуры

Процедура ДобавитьКолонкиДоговораВТаблицуАктаСверкиВзаиморасчетов(ТаблицаАкта)
	
	ТаблицаАкта.Колонки.Добавить("НомерДоговораКонтрагент", Новый ОписаниеТипов("Строка", Новый КвалификаторыСтроки(128)));
	ТаблицаАкта.Колонки.Добавить("ДатаДоговораКонтрагент", Новый ОписаниеТипов("Дата", , , Новый КвалификаторыДаты(ЧастиДаты.Дата)));
	
КонецПроцедуры
	

// Заполняет строку таблицы Итогов документа 'СверкаВзаиморасчетов2_5_11'.
//
// Параметры:
//	СтрокаРасчета - СтрокаТаблицыЗначений из см. ОписаниеТаблицыИтоговыеЗаписиАктаСверкиВзаиморасчетов.
//	ДанныеДоговора - Структура - коллекция, содержащая сведения о договоре взаиморасчетов по данным контрагента.
//
Процедура ЗаполнитьСтрокуТаблицыИтоговыеЗаписиАктаСверкиВзаиморасчетов(СтрокаРасчета, ДанныеДоговора)
	
	ЗаполнитьЗначенияСвойств(СтрокаРасчета, ДанныеДоговора);
	
	НомерДоговора = СокрЛП(ДанныеДоговора.НомерДоговора);
	
	СтрокаРасчета.ИдентификаторОбъекта				= ДанныеДоговора.ИдентификаторДоговора;
	СтрокаРасчета.НомерДоговора						= НомерДоговора;
	СтрокаРасчета.НомерДоговораКонтрагент			= НомерДоговора;
	СтрокаРасчета.ДатаДоговораКонтрагент			= ДанныеДоговора.ДатаДоговора;
	СтрокаРасчета.НаименованиеДоговора				= ДанныеДоговора.ОписаниеДоговора;
	СтрокаРасчета.НаименованиеДоговораКонтрагент	= ДанныеДоговора.ОписаниеДоговора;
	СтрокаРасчета.НачальноеСальдоДтКонтрагент		= ДанныеДоговора.СальдоНаНачалоПериодаКредит;
	СтрокаРасчета.НачальноеСальдоКтКонтрагент		= ДанныеДоговора.СальдоНаНачалоПериодаДебет;
	СтрокаРасчета.ОборотДтКонтрагент				= ДанныеДоговора.ОборотПоКредиту;
	СтрокаРасчета.ОборотКтКонтрагент				= ДанныеДоговора.ОборотПоДебету;
	СтрокаРасчета.КонечноеСальдоДтКонтрагент		= ДанныеДоговора.СальдоНаКонецПериодаКредит;
	СтрокаРасчета.КонечноеСальдоКтКонтрагент		= ДанныеДоговора.СальдоНаКонецПериодаДебет;
	
КонецПроцедуры

// Заполняет строку таблицы Итогов документа 'СверкаВзаиморасчетов2_5_11'.
//
// Параметры:
//	СтрокаЗаписи - СтрокаТаблицыЗначений из см. ОписаниеТаблицыДетальныеЗаписиАктаСверкиВзаиморасчетов.
//	ДанныеДоговора - Структура - коллекция, содержащая сведения о договоре взаиморасчетов по данным контрагента.
//	ДанныеДокумента - Структура - коллекция, содержащая сведения о документе взаиморасчетов по данным контрагента.
//	ДанныеОперации - Структура - коллекция, содержащая сведения об операции взаиморасчетов по данным контрагента.
//
Процедура ЗаполнитьСтрокуТаблицыДетальныеЗаписиАктаСверкиВзаиморасчетов(СтрокаЗаписи, ДанныеДоговора, ДанныеДокумента, ДанныеОперации)
	
	ЗаполнитьЗначенияСвойств(СтрокаЗаписи, ДанныеДокумента);
	
	НомерДокумента = ПрефиксацияОбъектовКлиентСервер.НомерНаПечать(ДанныеДокумента.НомерДокумента);
	
	СтрокаЗаписи.НомерДоговораКонтрагент			= ДанныеДоговора.НомерДоговора;
	СтрокаЗаписи.ДатаДоговораКонтрагент				= ДанныеДоговора.ДатаДоговора;
	СтрокаЗаписи.ИдентификаторОбъекта				= ДанныеДокумента.ИдентификаторДокумента;
	СтрокаЗаписи.НомерДокумента						= НомерДокумента;
	СтрокаЗаписи.НомерДокументаКонтрагент			= НомерДокумента;
	СтрокаЗаписи.ДатаДокументаКонтрагент			= ДанныеДокумента.ДатаДокумента;
	СтрокаЗаписи.НаименованиеДокументаКонтрагент	= ДанныеДокумента.НаименованиеДокумента;
	СтрокаЗаписи.СуммаДебет							= ДанныеОперации.СуммаКредит;
	СтрокаЗаписи.СуммаДебетКонтрагент				= ДанныеОперации.СуммаКредит;
	СтрокаЗаписи.СуммаКредит						= ДанныеОперации.СуммаДебет;
	СтрокаЗаписи.СуммаКредитКонтрагент				= ДанныеОперации.СуммаДебет;
	
КонецПроцедуры

// Заполняет документа 'СверкаВзаиморасчетов2_5_11' по подготовленным данным, полученным от отправителя.
//
// Параметры:
//	ДокументУчета - ОпределяемыйТип.ОснованияЭлектронныхДокументовЭДО - ссылка на документ учета, если он уже
//																		прикреплен к электронному документу.
//	ДанныеДляЗаполнения - см. ОписаниеДанныхДляЗаполненияАктаСверкиВзаиморасчетовПоДаннымЭД.
//	ОписаниеОшибки - Строка - описание ошибки создания учетного документа. Может быть выведена пользователю.
//
Процедура ЗаполнитьДокументАктаСверкиВзаиморасчетовПоДаннымОтправителя(ДокументУчета,
																		ДанныеДляЗаполнения,
																		ОписаниеОшибки)
	
	// Инициализация реквизитов шапки документа.
	Если ЗначениеЗаполнено(ДокументУчета) Тогда
		Попытка
			Блокировка = Новый БлокировкаДанных;
			ЭлементБлокировки = Блокировка.Добавить("Документ.СверкаВзаиморасчетов2_5_11");
			ЭлементБлокировки.УстановитьЗначение("Ссылка", ДокументУчета);
			Блокировка.Заблокировать();
			
			ДокументОбъект = ДокументУчета.ПолучитьОбъект();
		Исключение
			ТекстСообщения = НСтр("ru = 'Не удалось изменить данные документа ""%1"".
									|Возможно, документ редактируется другим пользователем'");
			ТекстСообщения = СтрШаблон(ТекстСообщения, Строка(ДокументОбъект.Ссылка));
			
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
	Иначе
		ДокументОбъект = Документы.СверкаВзаиморасчетов2_5_11.СоздатьДокумент();
		ДокументОбъект.Дата = ТекущаяДатаСеанса();
		
		ДокументОбъект.УстановитьНовыйНомер();
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(ДокументОбъект, ДанныеДляЗаполнения.ДанныеШапки);
	ДокументОбъект.ИнициализироватьДокумент();
	
	ВалютаРегламентированногоУчета = ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(
										ДокументОбъект.Организация);
	
	ДокументОбъект.СверкаВВалюте = ЗначениеЗаполнено(ВалютаРегламентированногоУчета)
									И ДокументОбъект.Валюта <> ВалютаРегламентированногоУчета;
	ДокументОбъект.РежимСверкиИтоговВзаиморасчетов = Перечисления.РежимСверкиИтоговВзаиморасчетов.ПоДоговорам;
	
	// Инициализация табличных частей документа по данным шапки.
	Документы.СверкаВзаиморасчетов2_5_11.ЗаполнитьДанныеПоРасчетам(ДокументОбъект);
	
	// Заполнение табличных частей по данным отправителя.
	ИтоговыеЗаписи = ДокументОбъект.ИтоговыеЗаписи.Выгрузить();
	ДобавитьКолонкиСортировкиТаблицыИтоговАктаСверкиВзаиморасчетов(ИтоговыеЗаписи);
	
	ДанныеШапкиПоУмолчанию = Новый Структура("Партнер");
	ЗаполнитьЗначенияСвойств(ДанныеШапкиПоУмолчанию, ДокументОбъект);
	
	ЕстьРасхождения = ИтоговыеЗаписи.Количество() > ДанныеДляЗаполнения.ИтоговыеЗаписи.Количество();
	
	ИсключаемыеСвойства = "НомерДоговора, ДатаДоговора, НаименованиеДоговора";
	
	СопоставлятьСтрокиПустыхИтогов = СопоставлятьСтрокиПустыхИтоговАктаСверкиВзаиморасчетов(
										ИтоговыеЗаписи,
										ДанныеДляЗаполнения.ИтоговыеЗаписи);
	
	Для Каждого СтрокаИтогов Из ДанныеДляЗаполнения.ИтоговыеЗаписи Цикл
		ОтборСтрокПоИтогу		= ДанныеПоискаСведенийДоговораАктаСверкиВзаиморасчетов(СтрокаИтогов);
		ДанныеОтбораЗаполнены	= ДанныеПоискаСведенийТаблицыАктаСверкиВзаиморасчетовЗаполнены(ОтборСтрокПоИтогу);
		СтрокиТаблицыПоОтбору	= ИтоговыеЗаписи.НайтиСтроки(ОтборСтрокПоИтогу);
		
		Если ДанныеОтбораЗаполнены
			Или СопоставлятьСтрокиПустыхИтогов Тогда
			
			Если СтрокиТаблицыПоОтбору.Количество() = 1 Тогда
				СтрокаТаблицы = СтрокиТаблицыПоОтбору[0];
			Иначе
				СтрокаТаблицы = ИтоговыеЗаписи.Добавить();
				ЗаполнитьЗначенияСвойств(СтрокаТаблицы, ДанныеШапкиПоУмолчанию);
				
				ЕстьРасхождения = Истина;
			КонецЕсли;
			
		Иначе
			СтрокаТаблицы = ИтоговыеЗаписи.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаТаблицы, ДанныеШапкиПоУмолчанию);
			
			ЕстьРасхождения = Истина;
		КонецЕсли;
		
		ЗаполнитьЗначенияСвойств(СтрокаТаблицы, СтрокаИтогов, Неопределено, ИсключаемыеСвойства);
	КонецЦикла;
	
	Для Каждого СтрокаТаблицы Из ИтоговыеЗаписи Цикл
		ЗаполнитьКолонкиСортировкиСтрокиТаблицыИтоговАктаСверкиВзаиморасчетов(СтрокаТаблицы);
	КонецЦикла;
	
	ИтоговыеЗаписи.Сортировать("СтрокаСопоставлена Убыв, ОбщаяДата, ОбщийОборотДт, ОбщийОборотКт, ОборотДт, ОборотДтКонтрагент, ОборотКт, ОборотКтКонтрагент");
	
	ДетальныеЗаписи = ДокументОбъект.ДетальныеЗаписи.Выгрузить();
	ДобавитьКолонкиСортировкиТаблицыЗаписейАктаСверкиВзаиморасчетов(ДетальныеЗаписи);
	
	Если Не ЕстьРасхождения Тогда
		ЕстьРасхождения = ДетальныеЗаписи.Количество() > ДанныеДляЗаполнения.ДетальныеЗаписи.Количество();
	КонецЕсли;
	
	ЗаполняемыеСвойства = "НомерДокументаКонтрагент, ДатаДокументаКонтрагент, НаименованиеДокументаКонтрагент,
							|СуммаДебетКонтрагент, СуммаКредитКонтрагент";
	СвойстваДоговора = "ТипРасчетов,Договор,Партнер";
	Для Каждого СтрокаДетальнойЗаписи Из ДанныеДляЗаполнения.ДетальныеЗаписи Цикл
		ОтборСтрокПоЗаписи		= ДанныеПоискаСведенийДокументаАктаСверкиВзаиморасчетов(СтрокаДетальнойЗаписи);
		СтрокиТаблицыПоОтбору	= ДетальныеЗаписи.НайтиСтроки(ОтборСтрокПоЗаписи);
		
		Если СтрокиТаблицыПоОтбору.Количество() = 0 Тогда
			СуммаДебет = ОтборСтрокПоЗаписи.СуммаДебет;
			ОтборСтрокПоЗаписи.СуммаДебет = -ОтборСтрокПоЗаписи.СуммаКредит;
			ОтборСтрокПоЗаписи.СуммаКредит = -СуммаДебет;
			СтрокиТаблицыПоОтбору = ДетальныеЗаписи.НайтиСтроки(ОтборСтрокПоЗаписи);
		КонецЕсли;
		
		Если СтрокиТаблицыПоОтбору.Количество() = 1 Тогда
			СтрокаЗаписи = СтрокиТаблицыПоОтбору[0];
		Иначе
			СтрокаЗаписи = ДетальныеЗаписи.Добавить();
			
			ОтборСтрокПоИтогу = ДанныеПоискаСведенийДоговораКонтрагентаАктаСверкиВзаиморасчетов(СтрокаДетальнойЗаписи);
			СтрокиТаблицыИтогов = ИтоговыеЗаписи.НайтиСтроки(ОтборСтрокПоИтогу);
			Если СтрокиТаблицыИтогов.Количество() = 1 Тогда
				ЗаполнитьЗначенияСвойств(СтрокаЗаписи, СтрокиТаблицыИтогов[0], СвойстваДоговора);
			КонецЕсли;
			
			ЕстьРасхождения = Истина;
		КонецЕсли;
		
		ЗаполнитьЗначенияСвойств(СтрокаЗаписи, СтрокаДетальнойЗаписи, ЗаполняемыеСвойства);
	КонецЦикла;
	
	Для Каждого СтрокаЗаписи Из ДетальныеЗаписи Цикл
		ЗаполнитьКолонкиСортировкиСтрокиТаблицыЗаписейАктаСверкиВзаиморасчетов(СтрокаЗаписи);
	КонецЦикла;
	
	ДетальныеЗаписи.Сортировать("СтрокаСопоставлена Убыв, ОбщаяДата, ОбщаяСуммаДт, ОбщаяСуммаКт, СуммаДебет, СуммаКредит");
	
	ДокументОбъект.ИтоговыеЗаписи.Загрузить(ИтоговыеЗаписи);
	ДокументОбъект.ДетальныеЗаписи.Загрузить(ДетальныеЗаписи);
	
	ДокументОбъект.Статус			= Перечисления.СтатусыСверокВзаиморасчетов2_5_11.НаСверке;
	ДокументОбъект.ЕстьРасхождения	= ЕстьРасхождения;
	
	// Отражение документа в учете.
	РежимЗаписи		= РежимЗаписиДокумента.Проведение;
	ТекстСообщения	= ?(ДокументОбъект.Проведен,
						НСтр("ru = 'Операция возможна только для непроведенных документов'"),
						"");
	
	ЗаписатьАктСверкиВзаиморасчетов(ДокументОбъект, РежимЗаписи, ДокументУчета, ТекстСообщения);
	
КонецПроцедуры

// Добавляет в таблицу, описывающую табличную часть 'ИтоговыеЗаписи' документа 'СверкаВзаиморасчетов2_5_11' колонки,
// используемые для сортировки данных.
//
// Параметры:
//	ТаблицаАкта - ТаблицаЗначений - выгруженная табличная часть 'ИтоговыеЗаписи' документа 'СверкаВзаиморасчетов2_5_11'.
//
Процедура ДобавитьКолонкиСортировкиТаблицыИтоговАктаСверкиВзаиморасчетов(ТаблицаАкта)
	
	ОписаниеТаблицы	= Метаданные.Документы.СверкаВзаиморасчетов2_5_11.ТабличныеЧасти.ИтоговыеЗаписи;
	КолонкиТаблицы	= ТаблицаАкта.Колонки;
	
	КолонкиТаблицы.Добавить("ОбщаяДата",			ОписаниеТаблицы.Реквизиты.ДатаДоговора.Тип);
	КолонкиТаблицы.Добавить("СтрокаСопоставлена",	Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(1)));
	КолонкиТаблицы.Добавить("ОбщийОборотДт",		ОписаниеТаблицы.Реквизиты.ОборотДт.Тип);
	КолонкиТаблицы.Добавить("ОбщийОборотКт",		ОписаниеТаблицы.Реквизиты.ОборотКт.Тип);
	
КонецПроцедуры

// Возвращает признак необходимости сопоставления пустых строк таблицы 'ИтоговыеЗаписи' документа
// 'СверкаВзаиморасчетов2_5_11' с пустыми строками таблицы загружаемых данных ЭД.
//
// Параметры:
//	ИтоговыеЗаписи - ТаблицаЗначений - выгруженная табличная часть 'ИтоговыеЗаписи' документа 'СверкаВзаиморасчетов2_5_11'.
//	ЗагружаемыеИтоговыеЗаписи - см. ОписаниеТаблицыИтоговыеЗаписиАктаСверкиВзаиморасчетов.
//
// Возвращаемое значение:
//	Булево - Истина, если необходимо сопоставлять пустые строки таблиц.
//
Функция СопоставлятьСтрокиПустыхИтоговАктаСверкиВзаиморасчетов(ИтоговыеЗаписи, ЗагружаемыеИтоговыеЗаписи)
	
	ОтборПустыхИтогов = Новый Структура;
	ОтборПустыхИтогов.Вставить("ДатаДоговора",	Дата(1, 1, 1));
	ОтборПустыхИтогов.Вставить("НомерДоговора", "");
	
	КоличествоСтрокПустыхИтогов				= КоличествоПустыхСтрокИтоговАктаСверкиВзаиморасчетов(
												ИтоговыеЗаписи,
												ОтборПустыхИтогов);
	КоличествоСтрокПустыхЗагружаемыхИтогов	= КоличествоПустыхСтрокИтоговАктаСверкиВзаиморасчетов(
												ЗагружаемыеИтоговыеЗаписи,
												ОтборПустыхИтогов);
	
	СопоставлятьСтрокиПустыхИтогов = КоличествоСтрокПустыхИтогов = 1
										И КоличествоСтрокПустыхЗагружаемыхИтогов = 1;
	
	Возврат СопоставлятьСтрокиПустыхИтогов;
	
КонецФункции

// Возвращает количество пустых строк таблицы 'ИтоговыеЗаписи' документа 'СверкаВзаиморасчетов2_5_11'.
//
// Параметры:
//	ИтоговыеЗаписи - ТаблицаЗначений - выгруженная табличная часть 'ИтоговыеЗаписи' документа 'СверкаВзаиморасчетов2_5_11'.
//	ОтборПустыхИтогов - Структура - коллекция, на основании которой осуществляется поиск пустых строк в таблице.
//
// Возвращаемое значение:
//	Число -  количество пустых строк таблицы 'ИтоговыеЗаписи' документа 'СверкаВзаиморасчетов2_5_11'.
//
Функция КоличествоПустыхСтрокИтоговАктаСверкиВзаиморасчетов(ИтоговыеЗаписи, ОтборПустыхИтогов)
	
	ПустыеИтоги = ИтоговыеЗаписи.НайтиСтроки(ОтборПустыхИтогов);
	
	Возврат ПустыеИтоги.Количество();
	
КонецФункции

// Возвращает результат проверки заполнения свойств переданной структуры.
//
// Параметры:
//	ДанныеПоиска - Структура - коллекция, используемая в качестве отбора строк в таблице документа.
//
// Возвращаемое значение:
//	Булево - Истина, если все свойства коллекции заполнены.
//
Функция ДанныеПоискаСведенийТаблицыАктаСверкиВзаиморасчетовЗаполнены(ДанныеПоиска)
	
	ДанныеЗаполнены = Ложь;
	
	Для Каждого КлючИЗначение Из ДанныеПоиска Цикл
		Если ЗначениеЗаполнено(КлючИЗначение.Значение) Тогда
			ДанныеЗаполнены = Истина;
			
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Возврат ДанныеЗаполнены;
	
КонецФункции

// Возвращает структуру, используемую для поиска сведений в таблице 'ИтоговыеЗаписи' документа
// 'СверкаВзаиморасчетов2_5_11'.
//
// Параметры:
//	ДанныеДоговора - Структура - коллекция сведений о договоре взаиморасчетов по данным контрагента, содержащая следующие свойства:
//						* ДатаДоговора - Дата - дата оформления договора по данным контрагента.
//						* НомерДоговора - Строка - номер договора по данным контрагент.
//
// Возвращаемое значение:
//	Структура - коллекция для отбора строк в таблице, содержащая следующие свойства:
//		* ДатаДоговора - Дата - дата искомого договора.
//		* НомерДоговора - Строка - номер искомого договора.
//
Функция ДанныеПоискаСведенийДоговораАктаСверкиВзаиморасчетов(ДанныеДоговора)
	
	ДанныеПоиска = Новый Структура;
	ДанныеПоиска.Вставить("ДатаДоговора",	Дата(1, 1, 1));
	ДанныеПоиска.Вставить("НомерДоговора",	"");
	
	ЗаполнитьЗначенияСвойств(ДанныеПоиска, ДанныеДоговора);
	
	Возврат ДанныеПоиска;
	
КонецФункции

// Возвращает структуру, используемую для поиска сведений в таблице 'ИтоговыеЗаписи' строки договора контрагента
// 'СверкаВзаиморасчетов2_5_11'.
//
// Параметры:
//	ДанныеДоговора - Структура - коллекция сведений о договоре взаиморасчетов по данным контрагента, содержащая следующие свойства:
//						* ДатаДоговораКонтрагента - Дата - дата оформления договора по данным контрагента.
//						* НомерДоговораКонтрагента - Строка - номер договора по данным контрагент.
//
// Возвращаемое значение:
//	Структура - коллекция для отбора строк в таблице, содержащая следующие свойства:
//		* ДатаДоговораКонтрагента - Дата - дата искомого договора.
//		* НомерДоговораКонтрагента - Строка - номер искомого договора.
//
Функция ДанныеПоискаСведенийДоговораКонтрагентаАктаСверкиВзаиморасчетов(ДанныеДоговора)
	
	ДанныеПоиска = Новый Структура;
	ДанныеПоиска.Вставить("ДатаДоговораКонтрагент",	Дата(1, 1, 1));
	ДанныеПоиска.Вставить("НомерДоговораКонтрагент",	"");
	
	ЗаполнитьЗначенияСвойств(ДанныеПоиска, ДанныеДоговора);
	
	Возврат ДанныеПоиска;
	
КонецФункции

// Заполняет колонки, используемые для сортировки данных в строке таблицы 'ИтоговыеЗаписи' документа
// 'СверкаВзаиморасчетов2_5_11'.
//
// Параметры:
//	СтрокаТЧ - СтрокаТаблицыЗначений из см. ОписаниеТаблицыИтоговыеЗаписиАктаСверкиВзаиморасчетов.
//
Процедура ЗаполнитьКолонкиСортировкиСтрокиТаблицыИтоговАктаСверкиВзаиморасчетов(СтрокаТЧ)

	СтрокаТЧ.ОбщаяДата = ?(ЗначениеЗаполнено(СтрокаТЧ.ДатаДоговора),
							СтрокаТЧ.ДатаДоговора,
							СтрокаТЧ.ДатаДоговораКонтрагент);
	
	Если (ЗначениеЗаполнено(СтрокаТЧ.ДатаДоговора)
			И ЗначениеЗаполнено(СтрокаТЧ.ДатаДоговораКонтрагент))
		Или (ЗначениеЗаполнено(СтрокаТЧ.НомерДоговора)
			И ЗначениеЗаполнено(СтрокаТЧ.НомерДоговораКонтрагент))
		Или (СтрокаТЧ.НачальноеСальдоДт <> 0
			И СтрокаТЧ.НачальноеСальдоДтКонтрагент <> 0)
		Или (СтрокаТЧ.НачальноеСальдоКт <> 0
			И СтрокаТЧ.НачальноеСальдоКтКонтрагент <> 0)
		Или (СтрокаТЧ.ОборотДт <> 0
			И СтрокаТЧ.ОборотДтКонтрагент <> 0)
		Или (СтрокаТЧ.ОборотКт <> 0
			И СтрокаТЧ.ОборотКтКонтрагент <> 0)
		Или (СтрокаТЧ.КонечноеСальдоДт <> 0
			И СтрокаТЧ.КонечноеСальдоДтКонтрагент <> 0)
		Или (СтрокаТЧ.КонечноеСальдоКт <> 0
			И СтрокаТЧ.КонечноеСальдоКтКонтрагент <> 0) Тогда
		
		СтрокаТЧ.СтрокаСопоставлена = 1;
		
	КонецЕсли;
	
	СтрокаТЧ.ОбщийОборотДт = ?(СтрокаТЧ.ОборотДт <> 0
									Или СтрокаТЧ.СтрокаСопоставлена = 1,
								СтрокаТЧ.ОборотДт,
								СтрокаТЧ.ОборотДтКонтрагент);
	
	СтрокаТЧ.ОбщийОборотКт = ?(СтрокаТЧ.ОборотКт <> 0
									Или СтрокаТЧ.СтрокаСопоставлена = 1,
								СтрокаТЧ.ОборотКт,
								СтрокаТЧ.ОборотКтКонтрагент);
	
КонецПроцедуры

// Добавляет в таблицу, описывающую табличную часть 'ДетальныеЗаписи' документа 'СверкаВзаиморасчетов2_5_11' колонки,
// используемые для сортировки данных.
//
// Параметры:
//	ТаблицаАкта - ТаблицаЗначений - выгруженная табличная часть 'ДетальныеЗаписи' документа 'СверкаВзаиморасчетов2_5_11'.
//
Процедура ДобавитьКолонкиСортировкиТаблицыЗаписейАктаСверкиВзаиморасчетов(ТаблицаАкта)
	
	ОписаниеТаблицы	= Метаданные.Документы.СверкаВзаиморасчетов2_5_11.ТабличныеЧасти.ДетальныеЗаписи;
	КолонкиТаблицы	= ТаблицаАкта.Колонки;
	
	КолонкиТаблицы.Добавить("ОбщаяДата",			ОписаниеТаблицы.Реквизиты.ДатаДокумента.Тип);
	КолонкиТаблицы.Добавить("СтрокаСопоставлена",	Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(1)));
	КолонкиТаблицы.Добавить("ОбщаяСуммаДт",			ОписаниеТаблицы.Реквизиты.СуммаДебет.Тип);
	КолонкиТаблицы.Добавить("ОбщаяСуммаКт",			ОписаниеТаблицы.Реквизиты.СуммаКредит.Тип);
	
КонецПроцедуры

// Возвращает структуру, используемую для поиска сведений в таблице 'ДетальныеЗаписи' документа
// 'СверкаВзаиморасчетов2_5_11'.
//
// Параметры:
//	ДанныеДокумента - Структура - коллекция сведений о документе взаиморасчетов по данным контрагента, содержащая следующие свойства:
//						* ДатаДокумента - Дата - дата оформления документа по данным контрагента.
//						* НомерДокумента - Строка - номер документа по данным контрагент.
//						* СуммаДебет - Число - сумма Дт взаиморасчетов по документу.
//						* СуммаКредит - Число - сумма Кт взаиморасчетов по документу.
//
// Возвращаемое значение:
//	Структура - коллекция для отбора строк в таблице, содержащая следующие свойства:
//		* ДатаДокумента - Дата - дата искомого документа.
//		* НомерДокумента - Строка - номер искомого документа.
//		* СуммаДебет - Число - сумма Дт искомого документа.
//		* СуммаКредит - Число - сумма Кт искомого документа.
//
Функция ДанныеПоискаСведенийДокументаАктаСверкиВзаиморасчетов(ДанныеДокумента)
	
	ДанныеПоиска = Новый Структура;
	ДанныеПоиска.Вставить("ДатаДокумента",	Дата(1, 1, 1));
	ДанныеПоиска.Вставить("НомерДокумента",	"");
	ДанныеПоиска.Вставить("СуммаДебет",		0);
	ДанныеПоиска.Вставить("СуммаКредит",	0);
	
	ЗаполнитьЗначенияСвойств(ДанныеПоиска, ДанныеДокумента);
	
	Возврат ДанныеПоиска;
	
КонецФункции

// Заполняет колонки, используемые для сортировки данных в строке таблицы 'ДетальныеЗаписи' документа
// 'СверкаВзаиморасчетов2_5_11'.
//
// Параметры:
//	СтрокаТЧ - СтрокаТаблицыЗначений из см. ОписаниеТаблицыДетальныеЗаписиАктаСверкиВзаиморасчетов.
//
Процедура ЗаполнитьКолонкиСортировкиСтрокиТаблицыЗаписейАктаСверкиВзаиморасчетов(СтрокаТЧ)

	СтрокаТЧ.ОбщаяДата = ?(ЗначениеЗаполнено(СтрокаТЧ.ДатаДокумента),
							СтрокаТЧ.ДатаДокумента,
							СтрокаТЧ.ДатаДокументаКонтрагент);
	
	Если (СтрокаТЧ.СуммаДебет <> 0
			И СтрокаТЧ.СуммаДебетКонтрагент <> 0)
		Или (СтрокаТЧ.СуммаКредит <> 0
			И СтрокаТЧ.СуммаКредитКонтрагент <> 0) Тогда
		
		СтрокаТЧ.СтрокаСопоставлена = 1;
		
	КонецЕсли;
	
	СтрокаТЧ.ОбщаяСуммаДт = ?(СтрокаТЧ.СуммаДебет <> 0
									Или СтрокаТЧ.СтрокаСопоставлена = 1,
								СтрокаТЧ.СуммаДебет,
								СтрокаТЧ.СуммаДебетКонтрагент);
	
	СтрокаТЧ.ОбщаяСуммаКт = ?(СтрокаТЧ.СуммаКредит <> 0
									Или СтрокаТЧ.СтрокаСопоставлена = 1,
								СтрокаТЧ.СуммаКредит,
								СтрокаТЧ.СуммаКредитКонтрагент);
	
КонецПроцедуры

// Выполняет запись документа 'СверкаВзаиморасчетов2_5_11' в ИБ.
//
// Параметры:
//	ДокументОбъект - ДокументОбъект.СверкаВзаиморасчетов2_5_11 - объект, записываемого документа.
//	РежимЗаписи - РежимЗаписиДокумента - позволяет определить выполняется запись, проведение или отмена проведения.
//											Изменение значения параметра позволяет изменить режим записи.
//	ДокументУчета - ДокументСсылка.СверкаВзаиморасчетов2_5_11 - ссылка записываемый документ в ИБ.
//	ТекстОшибки - ДокументСсылка.СверкаВзаиморасчетов2_5_11 - текст ошибки исключения.
//
Процедура ЗаписатьАктСверкиВзаиморасчетов(ДокументОбъект, РежимЗаписи, ДокументУчета, ТекстОшибки = "")
	
	// Документ записывается дважды:
	// Первый раз запись происходит с установкой признака ОбменДанными.Загрузка = Истина
	// Второй раз запись выполняется без установленного признака ОбменДанными.Загрузка
	
	Отказ = Ложь;
	
	Попытка
		ВерсионированиеОбъектовСобытия.ЗаписатьВерсиюДокумента(ДокументОбъект,
																Отказ,
																РежимЗаписи,
																РежимПроведенияДокумента.Неоперативный);
		
		ДокументОбъект.ОбменДанными.Загрузка = Истина;
		ДокументОбъект.Записать();
		
	Исключение
		ТекстСообщения = НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка());
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстСообщения, ТекстОшибки);
		
		ЗаписьЖурналаРегистрации(ТекстСообщения,
								УровеньЖурналаРегистрации.Ошибка,
								ДокументОбъект.Метаданные(),
								ДокументУчета,
								ОбработкаОшибок.ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;
	
	Попытка
		ДокументОбъект.ОбменДанными.Загрузка = Ложь;
		ДокументОбъект.Записать(РежимЗаписи);
		ДокументОбъект.Разблокировать();
		
		ДокументУчета = ДокументОбъект.Ссылка;
	Исключение
		ТекстСообщения = НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка());
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстСообщения, ТекстОшибки);
		
		ЗаписьЖурналаРегистрации(ТекстСообщения,
								УровеньЖурналаРегистрации.Ошибка,
								ДокументОбъект.Метаданные(),
								ДокументУчета,
								ОбработкаОшибок.ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;
	
КонецПроцедуры

// Возвращает структуру, заполненную по данным ЭД получателя, используемую для заполнения документа
// 'СверкаВзаиморасчетов2_5_11'.
//
// Параметры:
//	ДанныеДокумента - см. ФорматыЭДО.ДанныеЭлектронногоДокумента.
//	ОбъектыУчета - Массив Из ОпределяемыйТип.ОснованияЭлектронныхДокументовЭДО - коллекция ссылок на учетные документы ИБ.
//
// Возвращаемое значение:
//	Структура - см. ОписаниеДанныхДляЗаполненияАктаСверкиВзаиморасчетовПоДаннымЭД.
//
Функция ПодготовитьСтруктуруДляАктаСверкиВзаиморасчетовПоДаннымПолучателя(ДанныеДокумента, ОбъектыУчета)
	
	ДанныеДляЗаполнения = ОписаниеДанныхДляЗаполненияАктаСверкиВзаиморасчетовПоДаннымЭД();
	
	Если ОбъектыУчета.Количество() = 0 Тогда
		Возврат ДанныеДляЗаполнения;
	КонецЕсли;
	
	АктСверки = ОбъектыУчета[0];
	
	Если Не ЗначениеЗаполнено(АктСверки) Тогда
		Возврат ДанныеДляЗаполнения;
	КонецЕсли;
	
	ДанныеЭД = ДанныеВходящегоЭД(ДанныеДокумента.НовыйЭД.ЗначениеРеквизита);
	
	// Заполнение шапки документа.
	ДанныеШапки = ДанныеШапкиАктаСверкиВзаиморасчетовПоДаннымПолучателя(АктСверки, ДанныеЭД);
	
	ДанныеДляЗаполнения.ДанныеШапки = ДанныеШапки;
	
	Если Не ДанныеЭД.ПризнакНаличияРазногласий Тогда
		Возврат ДанныеДляЗаполнения;
	КонецЕсли;
	
	// Заполнение сведений табличных частей.
	ЗаполнитьТаблицыДанныхДляЗаполненияАктаСверкиВзаиморасчетовПоДаннымЭД(ДанныеДляЗаполнения,
																			ДанныеЭД.СведенияПолучателя);
	
	Возврат ДанныеДляЗаполнения;
	
КонецФункции

// Возвращает структуру, описывающую данные шапки документа 'СверкаВзаиморасчетов2_5_11'.
//
// Параметры:
//	АктСверки -  ОпределяемыйТип.ОснованияЭлектронныхДокументовЭДО - ссылка на документ в ИБ.
//	ДанныеЭД - см. ДанныеВходящегоЭД.
//
// Возвращаемое значение:
//	Структура - коллекция описывающая сведения шапки документа 'СверкаВзаиморасчетов2_5_11', содержащая следующие свойства:
//		* АктСверки -  ОпределяемыйТип.ОснованияЭлектронныхДокументовЭДО - ссылка на документ в ИБ.
//		* Статус - ПеречислениеСсылка.СтатусыСверокВзаиморасчетов2_5_11 - статус документа.
//		* ЕстьРасхождения - Булево - Истина, если есть расхождения по результатам сверки данных документа.
//
Функция ДанныеШапкиАктаСверкиВзаиморасчетовПоДаннымПолучателя(АктСверки, ДанныеЭД)
	
	ЕстьРасхождения = ДанныеЭД.ПризнакНаличияРазногласий; // Булево -
	Статус			= ?(ЕстьРасхождения,
						Перечисления.СтатусыСверокВзаиморасчетов2_5_11.СверенаСРазногласиями,
						Перечисления.СтатусыСверокВзаиморасчетов2_5_11.СверенаБезРазногласий);
	
	ДанныеШапки = Новый Структура;
	ДанныеШапки.Вставить("АктСверки",		АктСверки);
	ДанныеШапки.Вставить("Статус",			Статус);
	ДанныеШапки.Вставить("ЕстьРасхождения",	ЕстьРасхождения);
	
	Возврат ДанныеШапки;
	
КонецФункции

// Заполняет документа 'СверкаВзаиморасчетов2_5_11' по подготовленным данным, полученным от получателя.
//
// Параметры:
//	ДанныеДляЗаполнения - см. ОписаниеДанныхДляЗаполненияАктаСверкиВзаиморасчетовПоДаннымЭД.
//
Процедура ЗаполнитьДокументАктаСверкиВзаиморасчетовПоДаннымПолучателя(ДанныеДляЗаполнения)
	
	ДанныеШапки = ДанныеДляЗаполнения.ДанныеШапки;
	
	Если Не ЗначениеЗаполнено(ДанныеШапки) Тогда
		Возврат;
	КонецЕсли;
	
	// Инициализация реквизитов шапки документа.
	ДокументОбъект = ДанныеШапки.АктСверки.ПолучитьОбъект();
	ЗаполнитьЗначенияСвойств(ДокументОбъект, ДанныеШапки);
	
	// Заполнение табличных частей по данным получателя.
	ИтоговыеЗаписи = ДокументОбъект.ИтоговыеЗаписи.Выгрузить();
	ДобавитьКолонкиСортировкиТаблицыИтоговАктаСверкиВзаиморасчетов(ИтоговыеЗаписи);
	ДобавитьКолонкуИдентификатораВТаблицуАктаСверкиВзаиморасчетов(ИтоговыеЗаписи);
	ЗаполнитьКолонкуИдентификатораТаблицыАктаСверкиВзаиморасчетов(ИтоговыеЗаписи,
																	"Договор",
																	"ДатаДоговора, НомерДоговора");
	
	ИсключаемыеСвойства = "НомерДоговора, ДатаДоговора, НаименованиеДоговора";
	
	ДанныеШапкиПоУмолчанию = Новый Структура("Партнер");
	ЗаполнитьЗначенияСвойств(ДанныеШапкиПоУмолчанию, ДокументОбъект);
	
	СопоставлятьСтрокиПустыхИтогов = СопоставлятьСтрокиПустыхИтоговАктаСверкиВзаиморасчетов(
										ИтоговыеЗаписи,
										ДанныеДляЗаполнения.ИтоговыеЗаписи);
	
	Для Каждого СтрокаИтогов Из ДанныеДляЗаполнения.ИтоговыеЗаписи Цикл
		ОтборСтрокПоИтогу	= ДанныеПоискаСведенийДоговораАктаСверкиВзаиморасчетов(СтрокаИтогов);
		СтрокаИтоговПоИд	= СтрокаТаблицыАктаСверкиВзаиморасчетовПоИд(ИтоговыеЗаписи,
																		СтрокаИтогов.ИдентификаторОбъекта,
																		ОтборСтрокПоИтогу);
		СтрокаТаблицы		= СтрокаТаблицыАктаСверкиВзаиморасчетовПоДаннымЭД(ИтоговыеЗаписи,
																				СтрокаИтоговПоИд,
																				ОтборСтрокПоИтогу,
																				СопоставлятьСтрокиПустыхИтогов);
		
		ЗаполнитьЗначенияСвойств(СтрокаТаблицы, СтрокаИтогов, Неопределено, ИсключаемыеСвойства);
		
		Для Каждого КлючИЗначение Из ДанныеШапкиПоУмолчанию Цикл
			Если Не ЗначениеЗаполнено(СтрокаТаблицы[КлючИЗначение.Ключ]) Тогда
				СтрокаТаблицы[КлючИЗначение.Ключ] = КлючИЗначение.Значение;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	Для Каждого СтрокаТаблицы Из ИтоговыеЗаписи Цикл
		ЗаполнитьКолонкиСортировкиСтрокиТаблицыИтоговАктаСверкиВзаиморасчетов(СтрокаТаблицы);
	КонецЦикла;
	
	ИтоговыеЗаписи.Сортировать("СтрокаСопоставлена Убыв, ОбщаяДата, ОбщийОборотДт, ОбщийОборотКт, ОборотДт, ОборотДтКонтрагент, ОборотКт, ОборотКтКонтрагент");
	
	ДетальныеЗаписи	= ДокументОбъект.ДетальныеЗаписи.Выгрузить();
	ДобавитьКолонкиСортировкиТаблицыЗаписейАктаСверкиВзаиморасчетов(ДетальныеЗаписи);
	ДобавитьКолонкуИдентификатораВТаблицуАктаСверкиВзаиморасчетов(ДетальныеЗаписи);
	ЗаполнитьКолонкуИдентификатораТаблицыАктаСверкиВзаиморасчетов(ДетальныеЗаписи,
																	"РасчетныйДокумент",
																	"ДатаДокумента, НомерДокумента");
	
	ИсключаемыеСвойства = "НомерДокумента, ДатаДокумента, НаименованиеДокумента";
	
	Для Каждого СтрокаДетальнойЗаписи Из ДанныеДляЗаполнения.ДетальныеЗаписи Цикл
		ОтборСтрокПоЗаписи	= ДанныеПоискаСведенийДокументаАктаСверкиВзаиморасчетов(СтрокаДетальнойЗаписи);
		СтрокаЗаписиПоИд	= СтрокаТаблицыАктаСверкиВзаиморасчетовПоИд(ДетальныеЗаписи,
																		СтрокаДетальнойЗаписи.ИдентификаторОбъекта,
																		ОтборСтрокПоЗаписи);
		СтрокаЗаписи		= СтрокаТаблицыАктаСверкиВзаиморасчетовПоДаннымЭД(ДетальныеЗаписи,
																				СтрокаЗаписиПоИд,
																				ОтборСтрокПоЗаписи);
		
		ЗаполнитьЗначенияСвойств(СтрокаЗаписи, СтрокаДетальнойЗаписи, , ИсключаемыеСвойства);
	КонецЦикла;
	
	Для Каждого СтрокаЗаписи Из ДетальныеЗаписи Цикл
		ЗаполнитьКолонкиСортировкиСтрокиТаблицыЗаписейАктаСверкиВзаиморасчетов(СтрокаЗаписи);
	КонецЦикла;
	
	ДетальныеЗаписи.Сортировать("СтрокаСопоставлена Убыв, ОбщаяДата, ОбщаяСуммаДт, ОбщаяСуммаКт, СуммаДебет, СуммаКредит");
	
	ДокументОбъект.ИтоговыеЗаписи.Загрузить(ИтоговыеЗаписи);
	ДокументОбъект.ДетальныеЗаписи.Загрузить(ДетальныеЗаписи);
	
	// Отражение документа в учете.
	РежимЗаписи = ?(ДокументОбъект.Проведен, РежимЗаписиДокумента.Проведение, РежимЗаписиДокумента.Запись);
	
	ЗаписатьАктСверкиВзаиморасчетов(ДокументОбъект, РежимЗаписи, ДанныеШапки.АктСверки);
	
КонецПроцедуры

// Заполняет колонку, хранящую сведения об идентификаторе ключевого свойства строки таблицы документа, а также
// устанавливает индексы поиска данных, в зависимости от объема таблицы.
//
// Параметры:
//	ТаблицаАкта - ТаблицаЗначений - таблица документа.
//	ИмяПоля - Строка - имя заполняемой колонки.
//	ПоляПоиска - Строка - имена колонок, используемых для поиска данных.
//
Процедура ЗаполнитьКолонкуИдентификатораТаблицыАктаСверкиВзаиморасчетов(ТаблицаАкта, ИмяПоля, ПоляПоиска)
	
	Для Каждого СтрокаТЧ Из ТаблицаАкта Цикл
		Если Не ЗначениеЗаполнено(СтрокаТЧ[ИмяПоля]) Тогда
			Продолжить;
		КонецЕсли;
		
		СтрокаТЧ.ИдентификаторОбъекта = Строка(СтрокаТЧ[ИмяПоля].УникальныйИдентификатор());
	КонецЦикла;
	
	Если ТаблицаАкта.Количество() > 500 Тогда
		ТаблицаАкта.Индексы.Добавить("ИдентификаторОбъекта");
		ТаблицаАкта.Индексы.Добавить(ПоляПоиска);
	КонецЕсли;
	
КонецПроцедуры

// Возвращает строку таблицы документа, найденную по идентификатору ключевого свойства строки, в противном случае
// возвращается Неопределено.
//
// Параметры:
//	ТаблицаАкта - ТаблицаЗначений - таблица документа.
//	ИдОбъекта - Строка - идентификатор ключевого свойства строки.
//	ОтборПоСтрокеЭД - Структура - коллекция, на основании которой осуществляется поиск строк в таблице.
//
Функция СтрокаТаблицыАктаСверкиВзаиморасчетовПоИд(ТаблицаАкта, ИдОбъекта, ОтборПоСтрокеЭД)
	
	СтрокаТаблицыПоИд = Неопределено;
	
	Если ЗначениеЗаполнено(ИдОбъекта) Тогда
		ОтборСтрокПоИд	= Новый Структура("ИдентификаторОбъекта", ИдОбъекта);
		СтрокиТаблицы	= ТаблицаАкта.НайтиСтроки(ОтборСтрокПоИд);
		
		Если СтрокиТаблицы.Количество() = 1 Тогда
			СтрокаТаблицыПоИд = СтрокиТаблицы[0];
			
			Для Каждого КоллекцияОтбора Из ОтборПоСтрокеЭД Цикл
				Если КоллекцияОтбора.Значение <> СтрокаТаблицыПоИд[КоллекцияОтбора.Значение] Тогда
					СтрокаТаблицыПоИд = Неопределено;
					
					Прервать;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	Возврат СтрокаТаблицыПоИд;
	
КонецФункции

// Возвращает строку таблицы документа.
//
// Параметры:
//	ТаблицаАкта - ТаблицаЗначений - таблица документа.
//	СтрокаТаблицыПоИд - СтрокаТаблицыЗначений - строка таблицы документа, сопоставленная по идентификатору.
//	ОтборПоСтрокеЭД - Структура - коллекция, на основании которой осуществляется поиск строк в таблице.
//	СопоставлятьПустыеСтроки - Булево - Истина, признак необходимости осуществлять поиск по пустым строкам.
//
Функция СтрокаТаблицыАктаСверкиВзаиморасчетовПоДаннымЭД(ТаблицаАкта,
														СтрокаТаблицыПоИд,
														ОтборПоСтрокеЭД,
														СопоставлятьПустыеСтроки = Истина)
	
	Если СтрокаТаблицыПоИд = Неопределено Тогда
		ДанныеОтбораЗаполнены	= ДанныеПоискаСведенийТаблицыАктаСверкиВзаиморасчетовЗаполнены(ОтборПоСтрокеЭД);
		СтрокиТаблицы			= ТаблицаАкта.НайтиСтроки(ОтборПоСтрокеЭД);
		
		Если ДанныеОтбораЗаполнены
			Или СопоставлятьПустыеСтроки Тогда
			
			Если СтрокиТаблицы.Количество() = 1 Тогда
				СтрокаТаблицы = СтрокиТаблицы[0];
			Иначе
				СтрокаТаблицы = ТаблицаАкта.Добавить();
			КонецЕсли;
			
		Иначе
			СтрокаТаблицы = ТаблицаАкта.Добавить();
		КонецЕсли;
	Иначе
		СтрокаТаблицы = СтрокаТаблицыПоИд;
	КонецЕсли;
	
	Возврат СтрокаТаблицы;
	
КонецФункции

#КонецОбласти

#Область ВспомогательныеМетоды_СчетаНаОплату_1_01

Процедура ПроверкаФормированияСчетаНаОплату_1_01(ДанныеШапки, ТоварыДокумента, ЭтапыОплаты, Отказ);
	
	ТекстОшибки		= "";
	ТекстСообщения	= "";
	
	ДопустимыеТипыОснований = Новый Массив;
	ДопустимыеТипыОснований.Добавить(Тип("ДокументСсылка.АктВыполненныхРабот"));
	ДопустимыеТипыОснований.Добавить(Тип("ДокументСсылка.ЗаказКлиента"));
	ДопустимыеТипыОснований.Добавить(Тип("ДокументСсылка.ОтчетКомитенту"));
	ДопустимыеТипыОснований.Добавить(Тип("ДокументСсылка.ОтчетКомитентуОЗакупках"));
	ДопустимыеТипыОснований.Добавить(Тип("ДокументСсылка.РеализацияТоваровУслуг"));
	ДопустимыеТипыОснований.Добавить(Тип("СправочникСсылка.ДоговорыКонтрагентов"));
	
	Если ТипЗнч(ДанныеШапки.Ссылка) = Тип("ДокументСсылка.СчетНаОплатуКлиенту")
		И ДопустимыеТипыОснований.Найти(ТипЗнч(ДанныеШапки.ДокументОснование)) = Неопределено Тогда
		
		Отказ = Истина;
		
		ПредставлениеОбъекта = ОбщегоНазначения.ПредставлениеОбъекта(ДанныеШапки.ДокументОснование.Метаданные());
		
		ТекстОшибки	= НСтр("ru = 'Создание счета на оплату в электронной форме не поддерживается на основании документа типа ""%1""'");
		ТекстОшибки	= СтрШаблон(ТекстОшибки, ПредставлениеОбъекта);
		
	ИначеЕсли ТипЗнч(ДанныеШапки.Ссылка) = Тип("ДокументСсылка.ОтчетКомитенту") Тогда
		
		Если ТоварыДокумента.Количество() = 0 Тогда
			Отказ = Истина;
			
			ТекстОшибки	= НСтр("ru = 'В документе %1 отсутствует сумма вознаграждения или она отрицательная'");
			ТекстОшибки	= СтрШаблон(ТекстОшибки, ДанныеШапки.НаименованиеОснования);
		ИначеЕсли ЭтапыОплаты.Количество() = 0 Тогда
			Отказ = Истина;
			
			ТекстОшибки	= НСтр("ru = 'В документе %1 удержано вознаграждение'");
			ТекстОшибки	= СтрШаблон(ТекстОшибки, ДанныеШапки.НаименованиеОснования);
		КонецЕсли;
		
	ИначеЕсли ТоварыДокумента.Количество() = 0 Тогда
		
		Отказ = Истина;
		
		ТекстОшибки	= НСтр("ru = 'Основание %1 не содержит сведений об оплачиваемых товарах и услугах'");
		ТекстОшибки	= СтрШаблон(ТекстОшибки, ДанныеШапки.НаименованиеОснования);
		
	ИначеЕсли ЭтапыОплаты.Количество() = 0 Тогда
		Отказ = Истина;
		
		ТекстОшибки	= НСтр("ru = 'В документе %1 отсутствуют этапы оплаты'");
		ТекстОшибки	= СтрШаблон(ТекстОшибки, Строка(ДанныеШапки.Ссылка));
	КонецЕсли;
	
	Если Отказ Тогда
		
		ТекстСообщения	= НСтр("ru = '%1. Формирование ЭД не требуется.'");
		ТекстСообщения	= СтрШаблон(ТекстСообщения, ТекстОшибки);
		
		ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, ДанныеШапки.Ссылка);
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьРеквизитыУчастникаСчетаНаОплату_1_01(ДеревоДанных,
														СведенияОбУчастнике,
														ВидУчастника,
														ВидАдреса = "Юр",
														ДатаКИ = Неопределено)
	
	// Заполнение сведений о коде по ОКПО.
	Если СведенияОбУчастнике.Свойство("КодПоОКПО")
		И ЗначениеЗаполнено(СведенияОбУчастнике.КодПоОКПО) Тогда
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".КодОКПО",
			СведенияОбУчастнике.КодПоОКПО);
		
	КонецЕсли;
	
	// Заполнение сведений о типе участника.
	Если СведенияОбУчастнике.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ЮрЛицо Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ЮЛ.НаименованиеОрганизации",
			СведенияОбУчастнике.ПолноеНаименование);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ЮЛ.ИНН",
			СведенияОбУчастнике.ИНН);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ЮЛ.КПП",
			СведенияОбУчастнике.КПП);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ЮЛ.ОГРН",
			СведенияОбУчастнике.ОГРН);
	ИначеЕсли СведенияОбУчастнике.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ЮрЛицоНеРезидент Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ИЛ.НаименованиеОрганизации",
			СведенияОбУчастнике.ПолноеНаименование);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ИЛ.ИдентификаторОрганизации",
			СведенияОбУчастнике.НалоговыйНомерВСтранеРегистрации);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ИЛ.ОКСМ",
			ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СведенияОбУчастнике.СтранаРегистрации, "Код"));
	ИначеЕсли СведенияОбУчастнике.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ИндивидуальныйПредприниматель Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ИП.ИНН",
			СведенияОбУчастнике.ИНН);
		
		Если ЗначениеЗаполнено(СведенияОбУчастнике.СвидетельствоСерияНомер) Тогда
			Свидетельство = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
								НСтр("ru = 'Свидетельство №%1 от %2'"),
								СведенияОбУчастнике.СвидетельствоСерияНомер,
								Формат(СведенияОбУчастнике.СвидетельствоДатаВыдачи, "ДЛФ=D"));
			
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДанных,
				ВидУчастника + ".ТипУчастника.ИП.СвидетельствоГосударственнойРегистрации",
				Свидетельство);
		КонецЕсли;
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ИП.ОГРН",
			СведенияОбУчастнике.ОГРН);
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ИП.ФИО.Фамилия",
			СведенияОбУчастнике.Фамилия);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ИП.ФИО.Имя",
			СведенияОбУчастнике.Имя);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ИП.ФИО.Отчество",
			СведенияОбУчастнике.Отчество);
	Иначе
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ФЛ.ИНН",
			СведенияОбУчастнике.ИНН);
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ФЛ.ФИО.Фамилия",
			СведенияОбУчастнике.Фамилия);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ФЛ.ФИО.Имя",
			СведенияОбУчастнике.Имя);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".ТипУчастника.ФЛ.ФИО.Отчество",
			СведенияОбУчастнике.Отчество);
	КонецЕсли;
	
	// Заполнение сведений о банке.
	Если СведенияОбУчастнике.Свойство("НомерСчета")
		И ЗначениеЗаполнено(СведенияОбУчастнике.НомерСчета) Тогда
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".БанковскиеРеквизиты.НомерСчета",
			СведенияОбУчастнике.НомерСчета);
		
		Если СведенияОбУчастнике.Свойство("Банк")
			И ЗначениеЗаполнено(СведенияОбУчастнике.Банк) Тогда
			
			Если ТипЗнч(СведенияОбУчастнике.Банк) = Тип("Строка") Тогда
				Банк = СведенияОбУчастнике.Банк;
			Иначе
				Банк = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СведенияОбУчастнике.Банк, "Наименование");
			КонецЕсли;
			
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДанных,
				ВидУчастника + ".БанковскиеРеквизиты.НаименованиеБанка",
				Банк);
			
		КонецЕсли;
		
		Если СведенияОбУчастнике.Свойство("БИК")
			И ЗначениеЗаполнено(СведенияОбУчастнике.БИК) Тогда
			
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДанных,
				ВидУчастника + ".БанковскиеРеквизиты.БИКБанка",
				СведенияОбУчастнике.БИК);
		Иначе
			ЭлектронноеВзаимодействие.ДобавитьВРеквизитОбработкуОшибки(ДеревоДанных,
				ВидУчастника + ".БанковскиеРеквизиты.БИКБанка", НСтр("ru = 'Не заполнен БИК банка'"));
		КонецЕсли;
		
		Если СведенияОбУчастнике.Свойство("КоррСчет")
			И ЗначениеЗаполнено(СведенияОбУчастнике.КоррСчет) Тогда
			
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДанных,
				ВидУчастника + ".БанковскиеРеквизиты.КорреспондентскийСчетБанка",
				СведенияОбУчастнике.КоррСчет);
		Иначе
			ЭлектронноеВзаимодействие.ДобавитьВРеквизитОбработкуОшибки(ДеревоДанных,
				ВидУчастника + ".БанковскиеРеквизиты.КорреспондентскийСчетБанка", НСтр("ru = 'Не заполнен корреспондентский счет банка'"));
		КонецЕсли;
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".БанковскиеРеквизиты.РасчетныйСчет",
			СведенияОбУчастнике.НомерСчета);
		
	КонецЕсли;
	
	// Заполнение сведений об адресе.
	Если ТипЗнч(СведенияОбУчастнике.Ссылка) = Тип("СправочникСсылка.Организации") Тогда
		ВидКонтактнойИнформации = Справочники.ВидыКонтактнойИнформации[ВидАдреса + "АдресОрганизации"];
	ИначеЕсли ТипЗнч(СведенияОбУчастнике.Ссылка) = Тип("СправочникСсылка.Контрагенты") Тогда
		ВидКонтактнойИнформации = Справочники.ВидыКонтактнойИнформации[ВидАдреса + "АдресКонтрагента"];
	Иначе
		ВидКонтактнойИнформации = Неопределено;
	КонецЕсли;
	
	ОбъектКонтактнойИнформации	= СведенияОбУчастнике.Ссылка;
	АдресКонтрагентаЗаполнен	= Истина;
	
	Если ТипЗнч(СведенияОбУчастнике.Ссылка) = Тип("СправочникСсылка.Контрагенты") Тогда
		ПроверкаЗаполненностиАдреса	= УправлениеКонтактнойИнформацией.КонтактнаяИнформацияОбъекта(
										ОбъектКонтактнойИнформации,
										ВидКонтактнойИнформации,
										ТекущаяДатаСеанса());
		АдресКонтрагентаЗаполнен	= ЗначениеЗаполнено(ПроверкаЗаполненностиАдреса);
	КонецЕсли;
	
	Если Не АдресКонтрагентаЗаполнен
		И ПолучитьФункциональнуюОпцию("ИспользоватьПартнеровКакКонтрагентов") Тогда
		
		ВидКонтактнойИнформации		= Справочники.ВидыКонтактнойИнформации["АдресПартнера"];
		ОбъектКонтактнойИнформации	= ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СведенияОбУчастнике.Ссылка, "Партнер");
		
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		ДеревоДанных,
		ВидУчастника + ".Адрес.АвтоматическиЗаполняемый.ОбъектКонтактнойИнформации",
		ОбъектКонтактнойИнформации);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
		ДеревоДанных,
		ВидУчастника + ".Адрес.АвтоматическиЗаполняемый.ВидКонтактнойИнформации",
		ВидКонтактнойИнформации);
	
	АдресУчастника = Новый Структура;
	
	СведенияОбУчастнике.Вставить("ДатаКИ", ДатаКИ);
	
	ПолучитьАдресСтруктурой(АдресУчастника, СведенияОбУчастнике, "Ссылка", ВидАдреса);
	
	Если АдресУчастника.Свойство("АдресРФ") Тогда
		АдресУчастника.АдресРФ = Истина;
		
		ЗаполнитьАдресВДереве(ДеревоДанных, АдресУчастника, "АдресРФ", ВидУчастника);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СведенияОбУчастнике.Телефоны) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".КонтактныеСведения.Телефоны.НомерСтроки.Телефон",
			СведенияОбУчастнике.Телефоны);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СведенияОбУчастнике.ЭлектроннаяПочта) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
			ДеревоДанных,
			ВидУчастника + ".КонтактныеСведения.ЭлектронныеПочты.НомерСтроки.ЭлектроннаяПочта",
			СведенияОбУчастнике.ЭлектроннаяПочта);
	КонецЕсли;
	
КонецПроцедуры

Функция ТаблицаТоваровСчетаНаОплату_1_01(Данные, ДанныеШапки, ТоварыДокумента, ДокументБезНДС, ПараметрыЗаполнения)
	
	ТаблицаТоваров = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(Данные, "ТаблицаТоваров");
	ТаблицаТоваров.Колонки.Добавить("СуммаНалога",	Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19, 2)));
	
	СоответствиеСтавокНДС = Новый Соответствие;
	ЗаполнитьСоответствиеСтавокНДС(СоответствиеСтавокНДС);
	
	Если ДанныеШапки.ЧастичнаяОплата
		Или ТипЗнч(ДанныеШапки.ДокументОснование) = Тип("ДокументСсылка.ОтчетКомитенту") Тогда
		
		НазначениеПлатежа = ?(Не ПустаяСтрока(ДанныеШапки.НазначениеПлатежа),
								ДанныеШапки.НазначениеПлатежа,
								Документы.СчетНаОплатуКлиенту.СформироватьНазначениеПлатежа(ДанныеШапки.НомерДокумента,
																							ДанныеШапки.ДокументОснование));
		
		Если ДанныеШапки.УчитыватьНДС
			И Не ПараметрыЗаполнения.ТолькоЗалогЗаТару
			И Не ДанныеШапки.ОперацияОблагаетсяНДСУПокупателя Тогда
			
			СуммыПоСтавкамНДС	= Новый Соответствие;
			ПроцентОплаты		= ДанныеШапки.ПроцентОплаты;
			ИспользоватьНаборы	= ТоварыДокумента.Колонки.Найти("ЭтоНабор") <> Неопределено;
			
			НазначениеПлатежа = НазначениеПлатежаСчетаНаОплату_1_01(ДанныеШапки);
			
			Для Каждого СтрокаТовары Из ТоварыДокумента Цикл
				
				Если ИспользоватьНаборы Тогда
					Если СтрокаТовары.ЭтоНабор
						И СтрокаТовары.ВариантПредставленияНабораВПечатныхФормах <> Перечисления.ВариантыПредставленияНаборовВПечатныхФормах.ТолькоНабор Тогда
						
						Продолжить;
						
					КонецЕсли;
				КонецЕсли;
				
				ДанныеПоСтавке = СуммыПоСтавкамНДС[СтрокаТовары.СтавкаНДС];
				
				Если ДанныеПоСтавке = Неопределено Тогда
					ДанныеСуммыНДС = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(
										Данные,
										"ТаблицаТоваров.НомерСтроки.СуммаНДС");
					
					Если СтрокаТовары.СтавкаНДС = Справочники.СтавкиНДС.БезНДС Тогда
						ДанныеСуммыНДС.БезНДС = НСтр("ru = 'без НДС'");
					Иначе
						ДанныеСуммыНДС.СуммаНалога = Окр(СтрокаТовары.СуммаНДС, 2);
					КонецЕсли;
					
					ДанныеПоСтавке = Новый Структура;
					ДанныеПоСтавке.Вставить("ДанныеСуммыНДС",			ДанныеСуммыНДС);
					ДанныеПоСтавке.Вставить("ДанныеСуммыНДСБезСкидки",	ДанныеСуммыНДС);
					ДанныеПоСтавке.Вставить("СтоимостьСНДС",			Окр(СтрокаТовары.СтоимостьСНДС, 2));
					ДанныеПоСтавке.Вставить("СтоимостьБезНДС",			Окр(СтрокаТовары.СтоимостьБезНДС, 2));
				Иначе
					ДанныеСуммыНДС = ДанныеПоСтавке.ДанныеСуммыНДС;
					
					Если СтрокаТовары.СтавкаНДС <> Справочники.СтавкиНДС.БезНДС Тогда
						ДанныеСуммыНДС.СуммаНалога = ДанныеСуммыНДС.СуммаНалога + Окр(СтрокаТовары.СуммаНДС, 2);
					КонецЕсли;
					
					ДанныеПоСтавке.СтоимостьСНДС	= ДанныеПоСтавке.СтоимостьСНДС + Окр(СтрокаТовары.СтоимостьСНДС, 2);
					ДанныеПоСтавке.СтоимостьБезНДС	= ДанныеПоСтавке.СтоимостьБезНДС + Окр(СтрокаТовары.СтоимостьБезНДС, 2);
				КонецЕсли;
				
				СуммыПоСтавкамНДС.Вставить(СтрокаТовары.СтавкаНДС, ДанныеПоСтавке);
				
			КонецЦикла;
			
			Для Каждого ДанныеПоСтавке Из СуммыПоСтавкамНДС Цикл
				ДанныеСуммыНДС = ДанныеПоСтавке.Значение.ДанныеСуммыНДС;
				
				Если ДанныеПоСтавке.Ключ <> Справочники.СтавкиНДС.БезНДС Тогда
					ДокументБезНДС = Ложь;
					
					ДанныеСуммыНДС.СуммаНалога = Окр(ПроцентОплаты * ДанныеСуммыНДС.СуммаНалога / 100, 2);
				КонецЕсли;
				
				НоваяСтрокаТоваров = ТаблицаТоваров.Добавить();
				НоваяСтрокаТоваров.Наименование				= НазначениеПлатежа;
				НоваяСтрокаТоваров.СтоимостьБезНДС			= Окр(ПроцентОплаты * ДанныеПоСтавке.Значение.СтоимостьБезНДС / 100, 2);
				НоваяСтрокаТоваров.СтавкаНДС				= ПредставлениеСтавкиНДССчетаНаОплату_1_01(ДанныеПоСтавке.Ключ,
																										СоответствиеСтавокНДС);
				НоваяСтрокаТоваров.СтоимостьСНДС			= Окр(ПроцентОплаты * ДанныеПоСтавке.Значение.СтоимостьСНДС / 100, 2);
				НоваяСтрокаТоваров.СтоимостьБезНДСБезСкидки	= НоваяСтрокаТоваров.СтоимостьБезНДС;
				НоваяСтрокаТоваров.СтоимостьСНДСБезСкидки	= НоваяСтрокаТоваров.СтоимостьСНДС;
				НоваяСтрокаТоваров.СуммаНДС					= ДанныеСуммыНДС;
				НоваяСтрокаТоваров.СуммаНДСБезСкидки		= ДанныеСуммыНДС;
				НоваяСтрокаТоваров.СуммаНалога				= ДанныеСуммыНДС.СуммаНалога;
				
				ДополнительныеСведения = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(
											Данные,
											"ТаблицаТоваров.НомерСтроки.ДополнительныеСведения");
				ДополнительныеСведения.Признак = "5";
				
				НоваяСтрокаТоваров.ДополнительныеСведения = ДополнительныеСведения;
			КонецЦикла;
			
		Иначе
			
			ДанныеСуммыНДС = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(
								Данные,
								"ТаблицаТоваров.НомерСтроки.СуммаНДС");
			
			СтавкаНДС = ?(ДанныеШапки.ОперацияОблагаетсяНДСУПокупателя,
							НСтр("ru = 'НДС исчисляется налоговым агентом'"),
							Справочники.СтавкиНДС.БезНДС);
			
			Если СтавкаНДС = Справочники.СтавкиНДС.БезНДС Тогда
				ДанныеСуммыНДС.БезНДС = НСтр("ru = 'без НДС'");
			Иначе
				ДокументБезНДС = Ложь;
			КонецЕсли;
			
			НоваяСтрокаТоваров = ТаблицаТоваров.Добавить();
			НоваяСтрокаТоваров.Наименование				= НазначениеПлатежа;
			НоваяСтрокаТоваров.СтоимостьБезНДС			= Окр(ДанныеШапки.СтоимостьСНДС, 2);
			НоваяСтрокаТоваров.СтавкаНДС				= ПредставлениеСтавкиНДССчетаНаОплату_1_01(СтавкаНДС,
																									СоответствиеСтавокНДС);
			НоваяСтрокаТоваров.СтоимостьСНДС			= Окр(ДанныеШапки.СтоимостьСНДС, 2);
			НоваяСтрокаТоваров.СтоимостьБезНДСБезСкидки	= Окр(ДанныеШапки.СтоимостьСНДС, 2);
			НоваяСтрокаТоваров.СтоимостьСНДСБезСкидки	= Окр(ДанныеШапки.СтоимостьСНДС, 2);
			НоваяСтрокаТоваров.СуммаНДС					= ДанныеСуммыНДС;
			НоваяСтрокаТоваров.СуммаНДСБезСкидки		= ДанныеСуммыНДС;
			
			ДополнительныеСведения = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(
										Данные,
										"ТаблицаТоваров.НомерСтроки.ДополнительныеСведения");
			ДополнительныеСведения.Признак = "5";
			
			НоваяСтрокаТоваров.ДополнительныеСведения = ДополнительныеСведения;
			
		КонецЕсли;
		
	Иначе
		
		ИспользоватьНаборы = ТоварыДокумента.Колонки.Найти("ЭтоНабор") <> Неопределено;
		
		СоответствиеСтавокНДСКонтрагента	= Новый Соответствие;
		ТаблицаСопоставления				= Неопределено;
		ШтрихкодыКомбинаций					= Неопределено;
		ШтрихкодыНоменклатуры				= Неопределено;
		
		ЗаполнятьСопоставление = ТипЗнч(ДанныеШапки.ДокументОснование) <> Тип("СправочникСсылка.ДоговорыКонтрагентов");
		
		Если ЗаполнятьСопоставление Тогда
			ЗаполнитьСоответствиеСтавокНДС(СоответствиеСтавокНДСКонтрагента);
			
			ВыборкаДляСопоставления	= НоменклатураПартнеровСервер.ВыборкаДляСопоставленияНоменклатуры(
										ДанныеШапки.ДокументОснование);
			ТаблицаСопоставления	= ВыборкаДляСопоставления.Выгрузить();
			
			НоменклатураПартнеровСервер.ШтрихкодыПоТоварам(ТоварыДокумента, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры);
		КонецЕсли;
		
		ВариантОформленияПродажи	= ?(ТипЗнч(ДанныеШапки.ДокументОснование) = Тип("ДокументСсылка.РеализацияТоваровУслуг"),
										ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДанныеШапки.ДокументОснование,
																					"ВариантОформленияПродажи"),
										Неопределено);
		ЗаполнениеКодаТовара		= ПараметрыЗаполнения.ЗаполнениеКодаТовара;
		
		Для Каждого СтрокаТовары Из ТоварыДокумента Цикл
			
			Если ИспользоватьНаборы Тогда
				Если СтрокаТовары.ЭтоНабор
					И СтрокаТовары.ВариантПредставленияНабораВПечатныхФормах <> Перечисления.ВариантыПредставленияНаборовВПечатныхФормах.ТолькоНабор Тогда
					
					Продолжить;
					
				КонецЕсли;
			КонецЕсли;
			
			ПараметрыПредставления = НоменклатураКлиентСервер.ДополнительныеПараметрыПредставлениеНоменклатурыДляПечати();
			ПараметрыПредставления.ВозвратнаяТара		= СтрокаТовары.ЭтоВозвратнаяТара;
			ПараметрыПредставления.КодОсновногоЯзыка	= ОбщегоНазначения.КодОсновногоЯзыка();
			
			НоваяСтрокаТоваров = ТаблицаТоваров.Добавить();
			НоваяСтрокаТоваров.Наименование = НоменклатураКлиентСервер.ПредставлениеНоменклатурыДляПечати(
												СтрокаТовары.НоменклатураНаименование,
												СтрокаТовары.ХарактеристикаНаименование,
												Неопределено,
												Неопределено,
												ПараметрыПредставления);
			
			НоваяСтрокаТоваров.КодЕдиницыИзмерения			= СокрЛП(СтрокаТовары.КодЕдиницыИзмерения);
			НоваяСтрокаТоваров.НаименованиеЕдиницыИзмерения	= СокрЛП(СтрокаТовары.НаименованиеЕдиницыИзмерения);
			
			НоваяСтрокаТоваров.Количество = СтрокаТовары.Количество;
			
			НоваяСтрокаТоваров.ЦенаЗаЕдиницуИзмерения	= Окр(СтрокаТовары.Цена, 2);
			НоваяСтрокаТоваров.СтоимостьБезНДС			= Окр(СтрокаТовары.СтоимостьБезНДС, 2);
			НоваяСтрокаТоваров.СуммаСкидки				= Окр(СтрокаТовары.СуммаСкидки, 2);
			НоваяСтрокаТоваров.ЦенаБезСкидки			= Окр(СтрокаТовары.ЦенаБезСкидки, 2);
			НоваяСтрокаТоваров.СтоимостьБезНДСБезСкидки	= Окр(СтрокаТовары.СтоимостьБезНДСБезСкидки, 2);
			НоваяСтрокаТоваров.СтоимостьСНДС			= Окр(СтрокаТовары.СтоимостьСНДС, 2);
			НоваяСтрокаТоваров.СтоимостьСНДСБезСкидки	= Окр(СтрокаТовары.СтоимостьСНДСБезСкидки, 2);
			
			ДанныеСуммыНДС			= ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(
										Данные,
										"ТаблицаТоваров.НомерСтроки.СуммаНДС");
			ДанныеСуммыНДСБезСкидки	= ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(
										Данные,
										"ТаблицаТоваров.НомерСтроки.СуммаНДСБезСкидки");
			
			Если Не ДанныеШапки.ОперацияОблагаетсяНДСУПокупателя Тогда
				Если СтрокаТовары.СтавкаНДС = Справочники.СтавкиНДС.БезНДС Тогда
					ДанныеСуммыНДС.БезНДС			= НСтр("ru = 'без НДС'");
					ДанныеСуммыНДСБезСкидки.БезНДС	= НСтр("ru = 'без НДС'");
				Иначе
					ДокументБезНДС = Ложь;
					
					ДанныеСуммыНДС.СуммаНалога = Окр(СтрокаТовары.СуммаНДС, 2);
					
					Если НоваяСтрокаТоваров.СуммаСкидки <> 0 Тогда
						ДанныеСуммыНДСБезСкидки.СуммаНалога =
							Окр(УчетНДСУПКлиентСервер.РассчитатьСуммуНДС(СтрокаТовары.СтоимостьБезНДСБезСкидки,
																		СтрокаТовары.СтавкаНДС,
																		Ложь),
								2);
					Иначе
						ДанныеСуммыНДСБезСкидки.СуммаНалога = ДанныеСуммыНДС.СуммаНалога;
					КонецЕсли;
				КонецЕсли;
				
				НоваяСтрокаТоваров.СтавкаНДС			= ПредставлениеСтавкиНДССчетаНаОплату_1_01(СтрокаТовары.СтавкаНДС,
																									СоответствиеСтавокНДС);
				НоваяСтрокаТоваров.СуммаНДС				= ДанныеСуммыНДС;
				НоваяСтрокаТоваров.СуммаНДСБезСкидки	= ДанныеСуммыНДСБезСкидки;
				НоваяСтрокаТоваров.СуммаНалога			= ДанныеСуммыНДС.СуммаНалога;
			Иначе
				ДокументБезНДС = Ложь;
				
				НоваяСтрокаТоваров.СтавкаНДС			= НСтр("ru = 'НДС исчисляется налоговым агентом'");
				НоваяСтрокаТоваров.СуммаНДС				= ДанныеСуммыНДС;
				НоваяСтрокаТоваров.СуммаНДСБезСкидки	= ДанныеСуммыНДСБезСкидки;
			КонецЕсли;
			
			// Заполнение дополнительных сведений товара.
			ДополнительныеСведения = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(
										Данные,
										"ТаблицаТоваров.НомерСтроки.ДополнительныеСведения");
			ЗаполнитьЗначенияСвойств(ДополнительныеСведения, СтрокаТовары);
			
			ДополнительныеСведения.Признак			= ПризнакТовараСчетаНаОплату_1_01(СтрокаТовары.ТипНоменклатуры,
																						ВариантОформленияПродажи);
			ДополнительныеСведения.КодВидаТовара	= ?(ПараметрыЗаполнения.ВыводитьКодыТНВЭД,
														СтрокаТовары.КодВидаТовара,
														"");
			
			// Заполнение сведений о сопоставлении.
			Если ЗаполнятьСопоставление Тогда
				Характеристика	= ?(ЗначениеЗаполнено(СтрокаТовары.Характеристика),
									СтрокаТовары.Характеристика,
									Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());
				Упаковка		= ?(ЗначениеЗаполнено(СтрокаТовары.ЕдиницаИзмерения),
									СтрокаТовары.ЕдиницаИзмерения,
									Справочники.УпаковкиЕдиницыИзмерения.ПустаяСсылка());
				
				Если ЗначениеЗаполнено(СтрокаТовары.Упаковка) Тогда
					Упаковка = СтрокаТовары.Упаковка;
				КонецЕсли;
				
				ПараметрыОтбора = Новый Структура;
				ПараметрыОтбора.Вставить("Номенклатура",	СтрокаТовары.Номенклатура);
				ПараметрыОтбора.Вставить("Характеристика",	Характеристика);
				ПараметрыОтбора.Вставить("Упаковка",		Упаковка);
				
				СтрокиСопоставления = ТаблицаСопоставления.НайтиСтроки(ПараметрыОтбора);
				
				Если СтрокиСопоставления.Количество() > 0 Тогда
					СтрокаСопоставления = СтрокиСопоставления[0];
					
					НоваяСтрокаТоваров.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(СтрокаСопоставления,
																							Неопределено,
																							Неопределено,
																							Неопределено,
																							СоответствиеСтавокНДСКонтрагента);
				Иначе
					НоваяСтрокаТоваров.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(СтрокаТовары,
																							ШтрихкодыКомбинаций,
																							ШтрихкодыНоменклатуры,
																							Упаковка);
				КонецЕсли;
				
				Если ЗаполнениеКодаТовара = "Штрихкод"
					И НоваяСтрокаТоваров.Сопоставление.Свойство("ШтрихкодКомбинации") Тогда
					
					ДополнительныеСведения.ТоварКод = НоваяСтрокаТоваров.Сопоставление.ШтрихкодКомбинации;
					
				ИначеЕсли ЗаполнениеКодаТовара = "Штрихкод"
					И НоваяСтрокаТоваров.Сопоставление.Свойство("ШтрихкодыНоменклатуры")
					И НоваяСтрокаТоваров.Сопоставление.ШтрихкодыНоменклатуры.Количество() > 0 Тогда
					
					ДополнительныеСведения.ТоварКод = НоваяСтрокаТоваров.Сопоставление.ШтрихкодыНоменклатуры[0];
					
				КонецЕсли;
			КонецЕсли;
			
			НоваяСтрокаТоваров.ДополнительныеСведения = ДополнительныеСведения;
			
		КонецЦикла;
		
	КонецЕсли;
	
	Возврат ТаблицаТоваров;
	
КонецФункции

// Возвращает строковое представление прикладного значения ставки НДС.
//
// Параметры:
//	СтавкаНДС - СправочникСсылка.СтавкиНДС - значение ставки НДС.
//	СоответствиеСтавокНДС - см. ЗаполнитьСоответствиеСтавокНДС.
//
// Возвращаемое значение:
//	Строка - строковое представление прикладного значения ставки НДС.
//
Функция ПредставлениеСтавкиНДССчетаНаОплату_1_01(СтавкаНДС, СоответствиеСтавокНДС)
	
	Для Каждого КлючИЗначение Из СоответствиеСтавокНДС Цикл
		Если КлючИЗначение.Значение = СтавкаНДС Тогда
			ПредставлениеСтавки = КлючИЗначение.Ключ;
			
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Если ПредставлениеСтавки = "0"
		Или ПредставлениеСтавки = "10"
		Или ПредставлениеСтавки = "18"
		Или ПредставлениеСтавки = "20" Тогда
		
		ПредставлениеСтавки = ПредставлениеСтавки + "%";
		
	КонецЕсли;
	
	Возврат ПредставлениеСтавки;
	
КонецФункции

Функция УсловияОплатыСчетаНаОплату_1_01(Данные, ДанныеШапки, ТоварыДокумента, ЭтапыОплаты, ПараметрыЗаполнения)
	
	СуммыНалогаПоСтавкамНДС	= Новый Соответствие;
	
	Если ДанныеШапки.УчитыватьНДС
		И Не ПараметрыЗаполнения.ТолькоЗалогЗаТару
		И Не ДанныеШапки.ОперацияОблагаетсяНДСУПокупателя Тогда
		
		ИспользоватьНаборы	= ТоварыДокумента.Колонки.Найти("ЭтоНабор") <> Неопределено;
		ПоляГруппировки		= ?(ИспользоватьНаборы,
								"ЭтоНабор, ВариантПредставленияНабораВПечатныхФормах, СтавкаНДС",
								"СтавкаНДС");
		
		ТаблицаТоваров = ТоварыДокумента.Скопировать();
		ТаблицаТоваров.Свернуть(ПоляГруппировки, "СуммаНДС");
		
		Для Каждого СтрокаТовары Из ТаблицаТоваров Цикл
			Если ИспользоватьНаборы Тогда
				Если СтрокаТовары.ЭтоНабор
					И СтрокаТовары.ВариантПредставленияНабораВПечатныхФормах <> Перечисления.ВариантыПредставленияНаборовВПечатныхФормах.ТолькоНабор Тогда
					
					Продолжить;
					
				КонецЕсли;
			КонецЕсли;
			
			СуммаНалога = СуммыНалогаПоСтавкамНДС[СтрокаТовары.СтавкаНДС];
			
			Если СуммаНалога = Неопределено Тогда
				СуммаНалога = Окр(СтрокаТовары.СуммаНДС, 2);
			Иначе
				СуммаНалога = СуммаНалога + Окр(СтрокаТовары.СуммаНДС, 2);
			КонецЕсли;
			
			СуммыНалогаПоСтавкамНДС.Вставить(СтрокаТовары.СтавкаНДС, СуммаНалога);
		КонецЦикла;
		
	КонецЕсли;
	
	УсловияОплаты = ЭлектронноеВзаимодействие.ДанныеЭлементаДереваЭлектронногоДокумента(
						Данные,
						"ДополнительныеСведения.УсловияОплаты");
	
	УсловиеОплатыШаблон		= НСтр("ru = 'Оплата %1 суммы платежа на %2 в размере %3 %4. %5'");
	УсловиеОплатыТарыШаблон	= НСтр("ru = 'Оплата на %1 в размере %2 %3. %4'");
	
	Для Каждого СтрокаЭтапОплаты Из ЭтапыОплаты Цикл
		Если СтрокаЭтапОплаты.ЭтоЗалогЗаТару Тогда
			УсловиеОплатыТекст = СтрШаблон(УсловиеОплатыТарыШаблон,
											Формат(СтрокаЭтапОплаты.ДатаПлатежа, "ДЛФ=D"),
											Окр(СтрокаЭтапОплаты.СуммаПлатежа, 2),
											СокрЛП(ДанныеШапки.Валюта),
											НСтр("ru='Залог за тару. Без налога (НДС).'"));
		Иначе
			Если ДанныеШапки.ОперацияОблагаетсяНДСУПокупателя Тогда
				ТекстНДС = НСтр("ru = 'НДС исчисляется налоговым агентом.'");
			Иначе
				ТекстНДС = ФормированиеПечатныхФорм.СформироватьТекстНДСЭтапаОплаты(СуммыНалогаПоСтавкамНДС,
																					СтрокаЭтапОплаты.ПроцентПлатежа);
			КонецЕсли;
			
			УсловиеОплатыТекст = СтрШаблон(УсловиеОплатыШаблон,
											Строка(СтрокаЭтапОплаты.ПроцентПлатежа) + " %",
											Формат(СтрокаЭтапОплаты.ДатаПлатежа, "ДЛФ=D"),
											Окр(СтрокаЭтапОплаты.СуммаПлатежа, 2),
											СокрЛП(ДанныеШапки.Валюта),
											ТекстНДС);
		КонецЕсли;
		
		НоваяСтрока = УсловияОплаты.Добавить();
		НоваяСтрока.УсловиеОплаты = УсловиеОплатыТекст;
	КонецЦикла;
	
	Возврат УсловияОплаты;
	
КонецФункции

Функция НазначениеПлатежаСчетаНаОплату_1_01(ДанныеШапки)
	
	НазначениеПлатежа = ?(Не ПустаяСтрока(ДанныеШапки.НазначениеПлатежа),
							ДанныеШапки.НазначениеПлатежа,
							Документы.СчетНаОплатуКлиенту.СформироватьНазначениеПлатежа(ДанныеШапки.НомерДокумента,
																						ДанныеШапки.ДокументОснование));
	
	Возврат НазначениеПлатежа;
	
КонецФункции

Функция ПризнакТовараСчетаНаОплату_1_01(ТипНоменклатуры, ВариантОформленияПродажи)
	
	Если ВариантОформленияПродажи = Перечисления.ВариантыОформленияПродажи.АктНаПередачуПрав Тогда
		Возврат "4"; // Имущественные права;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ТипНоменклатуры) Тогда
		Если ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Товар Тогда
			Возврат "1"; // Имущество
		ИначеЕсли ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Работа Тогда
			Возврат "2"; // Работа
		ИначеЕсли ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Услуга Тогда
			Возврат "3"; // Услуга
		Иначе
			Возврат "5"; // Иное
		КонецЕсли;
	Иначе
		Возврат "5"; // Иное
	КонецЕсли;
	
КонецФункции

Функция ФорматСчетНаОплату101ИспользуетсяВНастройках(Организация, Контрагент, Договор)
	
	ВидДокумента = ЭлектронныеДокументыЭДО.ВидДокументаПоТипу(Перечисления.ТипыДокументовЭДО.СчетНаОплату);
	
	КлючНастроекОтправки = Новый Структура;
	КлючНастроекОтправки.Вставить("ВидДокумента", ВидДокумента);
	КлючНастроекОтправки.Вставить("Договор", Договор);
	КлючНастроекОтправки.Вставить("Отправитель", Организация);
	КлючНастроекОтправки.Вставить("Получатель", Контрагент);
	
	Настройки = НастройкиЭДО.НастройкиОтправки(КлючНастроекОтправки);
	
	Возврат ?(Настройки = Неопределено, Ложь, Настройки.Формат = "ON_CHETOP_1_998_01_01_01")
	
КонецФункции

Функция ОписаниеДанныхПриЗагрузкеСчетаНаОплату_1_01()
	
	ОписаниеОбъекта = Новый Структура;
	// Общие реквизиты шапки.
	ОписаниеОбъекта.Вставить("НомерВходящегоДокумента", "");
	ОписаниеОбъекта.Вставить("ДатаВходящегоДокумента", Дата(1, 1, 1));
	ОписаниеОбъекта.Вставить("Организация", Справочники.Организации.ПустаяСсылка());
	ОписаниеОбъекта.Вставить("ХозяйственнаяОперация", Перечисления.ХозяйственныеОперации.ПустаяСсылка());
	ОписаниеОбъекта.Вставить("Контрагент", Справочники.Контрагенты.ПустаяСсылка());
	ОписаниеОбъекта.Вставить("Партнер", Справочники.Партнеры.ПустаяСсылка());
	ОписаниеОбъекта.Вставить("БанковскийСчет", Справочники.БанковскиеСчетаОрганизаций.ПустаяСсылка());
	ОписаниеОбъекта.Вставить("БанковскийСчетКонтрагента", Справочники.БанковскиеСчетаКонтрагентов.ПустаяСсылка());
	
	// Финансовые реквизиты шапки.
	ОписаниеОбъекта.Вставить("Валюта", Справочники.Валюты.ПустаяСсылка());
	ОписаниеОбъекта.Вставить("Курс", 0);
	ОписаниеОбъекта.Вставить("ДатаОкончанияДействияСчета", Дата(1, 1, 1));
	ОписаниеОбъекта.Вставить("СрокПлатежа", Дата(1, 1, 1));
	ОписаниеОбъекта.Вставить("СтоимостьБезНДС", 0);
	ОписаниеОбъекта.Вставить("СтоимостьСНДС", 0);
	ОписаниеОбъекта.Вставить("СуммаНалога", 0);
	ОписаниеОбъекта.Вставить("СуммаСкидки", 0);
	ОписаниеОбъекта.Вставить("СуммаДокумента", 0);
	ОписаниеОбъекта.Вставить("НазначениеПлатежа", "");
	ОписаниеОбъекта.Вставить("ИдентификаторПлатежа", "");
	ОписаниеОбъекта.Вставить("СпособОплаты", "");
	ОписаниеОбъекта.Вставить("НалогообложениеНДС", Перечисления.ТипыНалогообложенияНДС.ПустаяСсылка());
	
	// Реквизиты шапки, не присутствующие в формате обмена.
	ОписаниеОбъекта.Вставить("Склад", Справочники.Склады.ПустаяСсылка());
	ОписаниеОбъекта.Вставить("Автор", Справочники.Пользователи.ПустаяСсылка());
	
	// Служебные реквизиты
	ОписаниеОбъекта.Вставить("ОблагаетсяНДСУПокупателя", Ложь);
	
	// Табличная часть товары
	ТаблицаТовары = Новый ТаблицаЗначений();
	ТаблицаТовары.Колонки.Добавить("НомерСтроки", Новый ОписаниеТипов("Число"));
	ТаблицаТовары.Колонки.Добавить("Номенклатура", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	ТаблицаТовары.Колонки.Добавить("НоменклатураПартнера", Новый ОписаниеТипов("СправочникСсылка.НоменклатураКонтрагентов"));
	ТаблицаТовары.Колонки.Добавить("Характеристика", Новый ОписаниеТипов("СправочникСсылка.ХарактеристикиНоменклатуры"));
	ТаблицаТовары.Колонки.Добавить("Упаковка", Новый ОписаниеТипов("СправочникСсылка.УпаковкиЕдиницыИзмерения"));
	ТаблицаТовары.Колонки.Добавить("Признак", Новый ОписаниеТипов("Строка"));
	СписокТипов = Новый Массив;
	СписокТипов.Добавить(Тип("Строка"));
	СписокТипов.Добавить(Тип("СправочникСсылка.СтавкиНДС"));
	ТаблицаТовары.Колонки.Добавить("СтавкаНДС", Новый ОписаниеТипов(СписокТипов));
	ТаблицаТовары.Колонки.Добавить("Количество", Новый ОписаниеТипов("Число"));
	ТаблицаТовары.Колонки.Добавить("КоличествоУпаковок", Новый ОписаниеТипов("Число"));
	ТаблицаТовары.Колонки.Добавить("Цена", Новый ОписаниеТипов("Число"));
	ТаблицаТовары.Колонки.Добавить("Сумма", Новый ОписаниеТипов("Число"));
	ТаблицаТовары.Колонки.Добавить("СуммаСНДС", Новый ОписаниеТипов("Число"));
	ТаблицаТовары.Колонки.Добавить("СуммаНДС", Новый ОписаниеТипов("Число"));
	ТаблицаТовары.Колонки.Добавить("СуммаСкидки", Новый ОписаниеТипов("Число"));
	ТаблицаТовары.Колонки.Добавить("ПроцентРучнойСкидки", Новый ОписаниеТипов("Число"));
	ТаблицаТовары.Колонки.Добавить("СуммаРучнойСкидки", Новый ОписаниеТипов("Число"));
	
	ОписаниеОбъекта.Вставить("Товары", ТаблицаТовары);
	
	// Этапы графика оплаты
	ТаблицаЭтапы = Новый ТаблицаЗначений();
	ТаблицаЭтапы.Колонки.Добавить("ВариантОплаты", Новый ОписаниеТипов("ПеречислениеСсылка.ВариантыКонтроляОплатыПоставщику"));
	ТаблицаЭтапы.Колонки.Добавить("ДатаПлатежа", Новый ОписаниеТипов("Дата"));
	ТаблицаЭтапы.Колонки.Добавить("ПроцентПлатежа", Новый ОписаниеТипов("Число"));
	ТаблицаЭтапы.Колонки.Добавить("СуммаПлатежа", Новый ОписаниеТипов("Число"));
	ТаблицаЭтапы.Колонки.Добавить("Сдвиг", Новый ОписаниеТипов("Число"));
	ТаблицаЭтапы.Колонки.Добавить("ВариантОтсчета", Новый ОписаниеТипов("ПеречислениеСсылка.ВариантыОтсчетаДатыПлатежа"));
	
	ОписаниеОбъекта.Вставить("ЭтапыГрафикаОплаты", ТаблицаЭтапы);
	
	// Расшифровка платежа
	РасшифровкаПлатежа = Новый ТаблицаЗначений();
	РасшифровкаПлатежа.Колонки.Добавить("Организация", Новый ОписаниеТипов("СправочникСсылка.Организации"));
	РасшифровкаПлатежа.Колонки.Добавить("Партнер", Новый ОписаниеТипов("СправочникСсылка.Партнеры"));
	РасшифровкаПлатежа.Колонки.Добавить("Сумма", Новый ОписаниеТипов("Число"));
	РасшифровкаПлатежа.Колонки.Добавить("ВалютаВзаиморасчетов", Новый ОписаниеТипов("СправочникСсылка.Валюты"));
	РасшифровкаПлатежа.Колонки.Добавить("СуммаВзаиморасчетов", Новый ОписаниеТипов("Число"));
	РасшифровкаПлатежа.Колонки.Добавить("СуммаНДС", Новый ОписаниеТипов("Число"));
	РасшифровкаПлатежа.Колонки.Добавить("КурсЧислительВзаиморасчетов", Новый ОписаниеТипов("Число"));
	РасшифровкаПлатежа.Колонки.Добавить("КурсЗнаменательВзаиморасчетов", Новый ОписаниеТипов("Число"));
	СписокТипов = Новый Массив;
	СписокТипов.Добавить(Тип("Строка"));
	СписокТипов.Добавить(Тип("СправочникСсылка.СтавкиНДС"));
	РасшифровкаПлатежа.Колонки.Добавить("СтавкаНДС", Новый ОписаниеТипов(СписокТипов));

	ОписаниеОбъекта.Вставить("РасшифровкаПлатежа", РасшифровкаПлатежа);

	Возврат ОписаниеОбъекта;
	
КонецФункции

Функция ПодготовитьСтруктуруДляСчетаНаОплату_1_01(ДеревоДанных, ОписаниеОшибки)
	
	ОписаниеОбъекта = ОписаниеДанныхПриЗагрузкеСчетаНаОплату_1_01();
	
	ДанныеЭД = ДанныеВходящегоЭД(ДеревоДанных);
	
	// Реквизиты шапки
	ОписаниеОбъекта.НомерВходящегоДокумента = ДанныеЭД.НомерДокумента;
	ОписаниеОбъекта.ДатаВходящегоДокумента = ДанныеЭД.ДатаДокумента;
	ОписаниеОбъекта.Организация = ОрганизацияПоДаннымЭД(ДеревоДанных, "Покупатель");
	ОписаниеОбъекта.Контрагент = КонтрагентПоДаннымЭД(ДеревоДанных, "Продавец");
	Если ЗначениеЗаполнено(ОписаниеОбъекта.Контрагент) Тогда
		ОписаниеОбъекта.Партнер = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ОписаниеОбъекта.Контрагент, "Партнер");
	КонецЕсли;
	
	// Валюта
	Валюта = Неопределено;
	ЭлектронноеВзаимодействиеПереопределяемый.НайтиСсылкуНаОбъект("Валюты", Валюта, ДанныеЭД.ДенежнаяЕдиница.КодВалюты);
	ОписаниеОбъекта.Валюта = Валюта;
	ОписаниеОбъекта.Курс = ДанныеЭД.ДенежнаяЕдиница.КурсВалюты;
	Если Не ЗначениеЗаполнено(Валюта) Тогда
		ОписаниеОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'В базе данных не удалось найти валюту с кодом ""%1""'"),
			ДанныеЭД.ДенежнаяЕдиница.КодВалюты);
	КонецЕсли;

	// Банковский счет организации
	НомерСчетаОрганизации = ДанныеЭД.Плательщик.БанковскиеРеквизиты.НомерСчета;
	БанковскийСчетОрганизации = НайтиСсылкуНаОбъектПоРеквизиту(
		"БанковскиеСчетаОрганизаций", "НомерСчета", НомерСчетаОрганизации, ОписаниеОбъекта.Организация);
	Если ЗначениеЗаполнено(БанковскийСчетОрганизации) Тогда
		ОписаниеОбъекта.БанковскийСчет = БанковскийСчетОрганизации;
	Иначе
		БанковскийСчетОрганизации = 
			Справочники.БанковскиеСчетаОрганизаций.ПолучитьБанковскийСчетОрганизацииПоУмолчанию(ОписаниеОбъекта.Организация, Валюта);
	КонецЕсли;
	
	// Банковский счет контрагента
	НомерСчетаКонтрагента = ДанныеЭД.ПолучательДенежныхСредств.БанковскиеРеквизиты.НомерСчета;
	БанковскийСчетКонтрагента = НайтиСсылкуНаОбъектПоРеквизиту(
		"БанковскиеСчетаКонтрагентов", "НомерСчета", НомерСчетаКонтрагента, ОписаниеОбъекта.Контрагент);
	Если ЗначениеЗаполнено(БанковскийСчетКонтрагента) Тогда
		ОписаниеОбъекта.БанковскийСчетКонтрагента = БанковскийСчетКонтрагента;
	Иначе
		БанковскийСчетКонтрагента = 
			Справочники.БанковскиеСчетаКонтрагентов.ПолучитьБанковскийСчетПоУмолчанию(ОписаниеОбъекта.Контрагент, Валюта);
	КонецЕсли;
	
	// Дополнительные сведения
	ОписаниеОбъекта.ДатаОкончанияДействияСчета = ДанныеЭД.ДополнительныеСведения.ОграничениеПоДатеОплаты;
	ОписаниеОбъекта.СрокПлатежа = ДанныеЭД.ДополнительныеСведения.ОграничениеПоДатеОплаты;
	ОписаниеОбъекта.НазначениеПлатежа = ДанныеЭД.ДополнительныеСведения.НазначениеПлатежа;
	ОписаниеОбъекта.ИдентификаторПлатежа = ДанныеЭД.ДополнительныеСведения.ИнформацияДляОплаты;
	ОписаниеОбъекта.СпособОплаты = ДанныеЭД.ДополнительныеСведения.СпособОплаты;
	
	// Суммы по документу
	ОписаниеОбъекта.СтоимостьБезНДС = ДанныеЭД.ВсегоКОплате.СтоимостьСНДС;
	ОписаниеОбъекта.СтоимостьСНДС = ДанныеЭД.ВсегоКОплате.СтоимостьСНДС;
	ОписаниеОбъекта.СуммаНалога = ДанныеЭД.ВсегоКОплате.СуммаНалога.СуммаНалога;
	ОписаниеОбъекта.СуммаСкидки = ДанныеЭД.ВсегоКОплате.СуммаСкидки;
	ОписаниеОбъекта.СуммаДокумента = ДанныеЭД.ВсегоКОплате.СтоимостьСНДС;
	
	// Товары
	Для Каждого СведенияОТоваре Из ДанныеЭД.ТаблицаТоваров Цикл
		НоваяСтрока = ОписаниеОбъекта.Товары.Добавить();
		
		Если СведенияОТоваре.Сопоставление <> Неопределено Тогда
			
			Идентификатор = СведенияОТоваре.Сопоставление.Идентификатор;
			Если ЗначениеЗаполнено(Идентификатор) Тогда
				НоменклатураПартнера = НоменклатураПартнеровСервер.НайтиСсылкуНаНоменклатуруПартнераПоИдентификатору(Идентификатор);
				Если ЗначениеЗаполнено(НоменклатураПартнера) Тогда
					НоваяСтрока.НоменклатураПартнера = НоменклатураПартнера;
				КонецЕсли;
			КонецЕсли;
			
			Номенклатура = СведенияОТоваре.Сопоставление.НоменклатураИБ;
			Если ЗначениеЗаполнено(Номенклатура) Тогда
				НоваяСтрока.Номенклатура = Номенклатура;
			КонецЕсли;
			
			Характеристика = СведенияОТоваре.Сопоставление.ХарактеристикаИБ;
			Если ЗначениеЗаполнено(Характеристика) Тогда
				ИспользованиеХарактеристик = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НоваяСтрока.Номенклатура, "ИспользованиеХарактеристик");
				Если ИспользованиеХарактеристик <> Перечисления.ВариантыИспользованияХарактеристикНоменклатуры.НеИспользовать Тогда
					НоваяСтрока.Характеристика = Характеристика;
				КонецЕсли;
			КонецЕсли;
			
			Упаковка = СведенияОТоваре.Сопоставление.УпаковкаИБ;
			Если ЗначениеЗаполнено(Упаковка) Тогда
				ИспользоватьУпаковки = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НоваяСтрока.Номенклатура, "ИспользоватьУпаковки");
				Если ИспользоватьУпаковки Тогда
					НоваяСтрока.Упаковка = Упаковка;
				КонецЕсли;
			КонецЕсли;

		КонецЕсли;
		
		НоваяСтрока.Признак = СведенияОТоваре.ДополнительныеСведения.Признак;
		
		НоваяСтрока.Сумма = СведенияОТоваре.СтоимостьБезНДС;
		НоваяСтрока.СуммаСНДС = СведенияОТоваре.СтоимостьСНДС;
		НоваяСтрока.СуммаНДС = СведенияОТоваре.СуммаНДС.СуммаНалога;
		НоваяСтрока.СуммаСкидки = СведенияОТоваре.СуммаСкидки;
		НоваяСтрока.СуммаРучнойСкидки = СведенияОТоваре.СуммаСкидки;
		НоваяСтрока.ПроцентРучнойСкидки = 
			?((НоваяСтрока.Сумма + НоваяСтрока.СуммаСкидки) = 0, 0, НоваяСтрока.СуммаСкидки *100 / (НоваяСтрока.Сумма + НоваяСтрока.СуммаСкидки));
		
		НоваяСтрока.СтавкаНДС = ?(
			СведенияОТоваре.СтавкаНДС = "НДС исчисляется налоговым агентом",
			Справочники.СтавкиНДС.БезНДС,
			СведенияОТоваре.СтавкаНДС);
			
		Если Не ОписаниеОбъекта.ОблагаетсяНДСУПокупателя И СведенияОТоваре.СтавкаНДС = "НДС исчисляется налоговым агентом" Тогда
			ОписаниеОбъекта.ОблагаетсяНДСУПокупателя = Истина;
		КонецЕсли;
		
		НоваяСтрока.КоличествоУпаковок = СведенияОТоваре.Количество;
		НоваяСтрока.Цена = (НоваяСтрока.Сумма + НоваяСтрока.СуммаСкидки) / ?(НоваяСтрока.Количество = 0, 1, НоваяСтрока.Количество);
		
		Если ЗначениеЗаполнено(НоваяСтрока.Номенклатура) Тогда
			СтруктураДействий = Новый Структура();
			СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");
			ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(НоваяСтрока, СтруктураДействий, Неопределено);
		КонецЕсли;
		
	КонецЦикла;
	
	// Налогообложение НДС
	Если ОписаниеОбъекта.ОблагаетсяНДСУПокупателя Тогда
		ОписаниеОбъекта.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ОблагаетсяНДСУПокупателя;
	ИначеЕсли ОписаниеОбъекта.Товары.Итог("СуммаНДС") = 0 Тогда 
		ОписаниеОбъекта.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС;
	Иначе
		ОписаниеОбъекта.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС;
	КонецЕсли;
	
	// Этапы оплаты
	СтрокаОплаты = ОписаниеОбъекта.ЭтапыГрафикаОплаты.Добавить();
	СтрокаОплаты.ВариантОплаты = Перечисления.ВариантыКонтроляОплатыПоставщику.КредитПослеПоступления;
	СтрокаОплаты.ДатаПлатежа = ОписаниеОбъекта.СрокПлатежа;
	СтрокаОплаты.ПроцентПлатежа = 100;
	СтрокаОплаты.СуммаПлатежа = ОписаниеОбъекта.СтоимостьСНДС;
	СтрокаОплаты.ВариантОтсчета = Перечисления.ВариантыОтсчетаДатыПлатежа.ОтДатыЗаказа;
	
	// Расшифровка платежа
	ТаблицаНДС = ОписаниеОбъекта.Товары.Скопировать();
	ТаблицаНДС.Свернуть("СтавкаНДС", "СуммаСНДС, СуммаНДС");
	Для Каждого Строка Из ТаблицаНДС Цикл
		СтрокаРасшифровкаПлатежа = ОписаниеОбъекта.РасшифровкаПлатежа.Добавить();
		СтрокаРасшифровкаПлатежа.Организация = ОписаниеОбъекта.Организация;
		СтрокаРасшифровкаПлатежа.Партнер = ОписаниеОбъекта.Партнер;
		СтрокаРасшифровкаПлатежа.СтавкаНДС = Строка.СтавкаНДС;
		СтрокаРасшифровкаПлатежа.Сумма = Строка.СуммаСНДС;
		СтрокаРасшифровкаПлатежа.ВалютаВзаиморасчетов = Валюта;
		СтрокаРасшифровкаПлатежа.СуммаВзаиморасчетов = Строка.СуммаСНДС;
		СтрокаРасшифровкаПлатежа.СуммаНДС = Строка.СуммаНДС;
		СтрокаРасшифровкаПлатежа.КурсЧислительВзаиморасчетов = ОписаниеОбъекта.Курс;
		СтрокаРасшифровкаПлатежа.КурсЗнаменательВзаиморасчетов = 1;
	КонецЦикла;
	
	Возврат ОписаниеОбъекта;
	
КонецФункции

Процедура ЗаполнитьЗаказПоставщику(ДокументУчета, ДанныеДляЗагрузки, ИмяДокумента, ОписаниеОшибки)
	
	РежимЗаписи = РежимЗаписиДокумента.Запись;
	ДокументОбъект = ПолучитьОбъектДляЗаполненияДаннымиЭД(ДокументУчета, ДанныеДляЗагрузки, ИмяДокумента, РежимЗаписи, ОписаниеОшибки);
	Если ДокументОбъект = Неопределено Или ЗначениеЗаполнено(ОписаниеОшибки) Тогда
		Возврат;
	КонецЕсли;
	
	// заполнение реквизитов шапки
	ПерезаполнениеЗначенийРеквизитовШапки(ДокументОбъект, ДанныеДляЗагрузки);
	ДокументОбъект.НомерПоДаннымПоставщика = ДанныеДляЗагрузки.НомерВходящегоДокумента;
	ДокументОбъект.ДатаПоДаннымПоставщика = ДанныеДляЗагрузки.ДатаВходящегоДокумента;
	
	Если ПолучитьФункциональнуюОпцию("ИспользоватьСтатусыЗаказовПоставщикам") Тогда
		ДокументОбъект.Статус = Перечисления.СтатусыЗаказовПоставщикам.НеСогласован;
	КонецЕсли;
	
	// заполнение реквизита ЗакупкаПодДеятельность
	ПараметрыЗаполнения = Документы.ЗаказПоставщику.ПараметрыЗаполненияВидаДеятельностиНДС(ДокументОбъект);
	УчетНДСУП.ЗаполнитьВидДеятельностиНДС(ДокументОбъект.ЗакупкаПодДеятельность, ПараметрыЗаполнения);
	
	// заполнение соглашения по статистике
	Если Не ЗначениеЗаполнено(ДокументОбъект.Соглашение) Тогда
		ЗаполнитьСоглашениеПоСтатистике(ДокументОбъект);
		
		// признак "Цена включает НДС" заполняем из соглашения
		Если ЗначениеЗаполнено(ДокументОбъект.Соглашение) Тогда
			ДокументОбъект.ЦенаВключаетНДС = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОбъект.Соглашение, "ЦенаВключаетНДС");
		КонецЕсли;
	КонецЕсли;
	
	// заполнение договора
	Если ЗначениеЗаполнено(ДокументОбъект.Контрагент) И ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСПоставщиками") Тогда
		ДопПараметры = ЗакупкиСервер.ДополнительныеПараметрыОтбораДоговоров();
		ДопПараметры.ВалютаВзаиморасчетов = ДанныеДляЗагрузки.Валюта;
		Если ЗначениеЗаполнено(ДокументОбъект.ХозяйственнаяОперация) Тогда
			ХозяйственнаяОперацияДоговора = ДокументОбъект.ХозяйственнаяОперация;
		Иначе
			ХозяйственнаяОперацияДоговора = Перечисления.ХозяйственныеОперации.ЗакупкаУПоставщика
		КонецЕсли;
		ДокументОбъект.Договор = ЗакупкиСервер.ПолучитьДоговорПоУмолчанию(ДокументОбъект, ХозяйственнаяОперацияДоговора, ДопПараметры);
	КонецЕсли;

	// заполнение таблицы Товары
	ДокументОбъект.Товары.Загрузить(ДанныеДляЗагрузки.Товары);
	
	Для Каждого Строка Из ДокументОбъект.Товары Цикл 
		Если ДокументОбъект.ЦенаВключаетНДС И Строка.Сумма <> Строка.СуммаСНДС Тогда
			Строка.Сумма = Строка.СуммаСНДС;
			Строка.ПроцентРучнойСкидки = 
				?((Строка.Сумма + Строка.СуммаРучнойСкидки) = 0, 0, Строка.СуммаРучнойСкидки *100 / (Строка.Сумма + Строка.СуммаРучнойСкидки));
			Строка.Цена = (Строка.Сумма + Строка.СуммаРучнойСкидки) / ?(Строка.Количество = 0, 1, Строка.Количество);
		КонецЕсли;
	КонецЦикла;
	
	ДокументОбъект.ЭтапыГрафикаОплаты.Загрузить(ДанныеДляЗагрузки.ЭтапыГрафикаОплаты);
	
	// склады в таблице товары
	СкладГруппа = Справочники.Склады.ЭтоГруппаИСкладыИспользуютсяВТЧДокументовЗакупки(ДокументОбъект.Склад);
	СкладыСервер.ЗаполнитьСкладыВТабличнойЧасти(ДокументОбъект.Склад, СкладГруппа, ДокументОбъект.Товары, Истина);
	
	// сумма документа
	ДокументОбъект.СуммаДокумента = ЦенообразованиеКлиентСервер.ПолучитьСуммуДокумента(ДокументОбъект.Товары, ДокументОбъект.ЦенаВключаетНДС);
	
	ЗаписатьУчетныйДокумент(ДокументОбъект, ДокументУчета, РежимЗаписи, ОписаниеОшибки);
	
КонецПроцедуры

Процедура ЗаполнитьЗаявкуНаРасходованиеДенежныхСредств(ДокументУчета, ДанныеДляЗагрузки, ИмяДокумента, ОписаниеОшибки)
	
	РежимЗаписи = РежимЗаписиДокумента.Запись;
	ДокументОбъект = ПолучитьОбъектДляЗаполненияДаннымиЭД(ДокументУчета, ДанныеДляЗагрузки, ИмяДокумента, РежимЗаписи, ОписаниеОшибки);
	Если ДокументОбъект = Неопределено Или ЗначениеЗаполнено(ОписаниеОшибки) Тогда
		Возврат;
	КонецЕсли;
	
	ПерезаполнениеЗначенийРеквизитовШапки(ДокументОбъект, ДанныеДляЗагрузки);
	ДокументОбъект.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ОплатаПоставщику;
	ДокументОбъект.СтатьяДвиженияДенежныхСредств = 
		Справочники.СтатьиДвиженияДенежныхСредств.СтатьяДвиженияДенежныхСредствПоХозяйственнойОперации(ДокументОбъект.ХозяйственнаяОперация);
	ДокументОбъект.ВидПеречисленияВБюджет = Перечисления.ВидыПеречисленийВБюджет.ИнойПлатеж;

	Если ДанныеДляЗагрузки.Свойство("СрокПлатежа") Тогда 
		ДокументОбъект.ЖелательнаяДатаПлатежа = ДанныеДляЗагрузки.СрокПлатежа;
	КонецЕсли;
	ДокументОбъект.РасшифровкаПлатежа.Загрузить(ДанныеДляЗагрузки.РасшифровкаПлатежа);

	Если ЗначениеЗаполнено(ДокументОбъект.РасшифровкаПлатежа[0].ОбъектРасчетов) Тогда
		ДокументОбъект.КонтролироватьОплатуПоОбъектамРасчетов = Истина;
	КонецЕсли;
	
	ЗаписатьУчетныйДокумент(ДокументОбъект, ДокументУчета, РежимЗаписи, ОписаниеОшибки);
	
КонецПроцедуры

Процедура ЗаполнитьДокументСписаниеБезналичныхДенежныхСредств(ДокументУчета, ДанныеДляЗагрузки, ИмяДокумента, ОписаниеОшибки)
	
	РежимЗаписи = РежимЗаписиДокумента.Запись;
	ДокументОбъект = ПолучитьОбъектДляЗаполненияДаннымиЭД(ДокументУчета, ДанныеДляЗагрузки, ИмяДокумента, РежимЗаписи, ОписаниеОшибки);
	Если ДокументОбъект = Неопределено Или ЗначениеЗаполнено(ОписаниеОшибки) Тогда
		Возврат;
	КонецЕсли;
	
	ПерезаполнениеЗначенийРеквизитовШапки(ДокументОбъект, ДанныеДляЗагрузки);
	ДокументОбъект.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ОплатаПоставщику;
	ДокументОбъект.СтатьяДвиженияДенежныхСредств = 
		Справочники.СтатьиДвиженияДенежныхСредств.СтатьяДвиженияДенежныхСредствПоХозяйственнойОперации(ДокументОбъект.ХозяйственнаяОперация);
		
	Если ЗначениеЗаполнено(ДокументОбъект.БанковскийСчет) Тогда
		РазрешеныПлатежиБезУказанияЗаявок =
			ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОбъект.БанковскийСчет, "РазрешитьПлатежиБезУказанияЗаявок")
			Или Не ПолучитьФункциональнуюОпцию("ИспользоватьЗаявкиНаРасходованиеДенежныхСредств");
		Если Не РазрешеныПлатежиБезУказанияЗаявок Тогда
			ДокументОбъект.ОплатаПоЗаявкам = Истина;
		КонецЕсли;
	КонецЕсли;
	
	ДокументОбъект.РасшифровкаПлатежа.Загрузить(ДанныеДляЗагрузки.РасшифровкаПлатежа);

	ЗаписатьУчетныйДокумент(ДокументОбъект, ДокументУчета, РежимЗаписи, ОписаниеОшибки);
	
КонецПроцедуры

Процедура ЗаполнитьДокументРасходныйКассовыйОрдер(ДокументУчета, ДанныеДляЗагрузки, ИмяДокумента, ОписаниеОшибки)
	
	РежимЗаписи = РежимЗаписиДокумента.Запись;
	ДокументОбъект = ПолучитьОбъектДляЗаполненияДаннымиЭД(ДокументУчета, ДанныеДляЗагрузки, ИмяДокумента, РежимЗаписи, ОписаниеОшибки);
	Если ДокументОбъект = Неопределено Или ЗначениеЗаполнено(ОписаниеОшибки) Тогда
		Возврат;
	КонецЕсли;
	
	ПерезаполнениеЗначенийРеквизитовШапки(ДокументОбъект, ДанныеДляЗагрузки);
	ДокументОбъект.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ОплатаПоставщику;
	ДокументОбъект.СтатьяДвиженияДенежныхСредств = 
		Справочники.СтатьиДвиженияДенежныхСредств.СтатьяДвиженияДенежныхСредствПоХозяйственнойОперации(ДокументОбъект.ХозяйственнаяОперация);
	ДокументОбъект.Касса = Справочники.Кассы.ПолучитьКассуПоУмолчанию(ДокументОбъект.Организация, ДокументОбъект.Валюта);
	
	Если ЗначениеЗаполнено(ДокументОбъект.Касса) Тогда
		РазрешеныПлатежиБезУказанияЗаявок =
			ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОбъект.Касса, "РазрешитьПлатежиБезУказанияЗаявок")
			Или Не ПолучитьФункциональнуюОпцию("ИспользоватьЗаявкиНаРасходованиеДенежныхСредств");
		Если Не РазрешеныПлатежиБезУказанияЗаявок Тогда
			ДокументОбъект.ОплатаПоЗаявкам = Истина;
		КонецЕсли;
	КонецЕсли;
	
	ДокументОбъект.РасшифровкаПлатежа.Загрузить(ДанныеДляЗагрузки.РасшифровкаПлатежа);
	
	ЗаписатьУчетныйДокумент(ДокументОбъект, ДокументУчета, РежимЗаписи, ОписаниеОшибки);
	
КонецПроцедуры

Функция ПолучитьОбъектДляЗаполненияДаннымиЭД(Документ, ДанныеДляЗагрузки, ИмяДокумента, РежимЗаписи = Неопределено, Текст)
	
	// Если в параметре РежимЗаписи передано РежимЗаписиДокумента.Запись учетный документ не должен быть проведен
	ТолькоЗапись = Ложь;
	Если РежимЗаписи = РежимЗаписиДокумента.Запись Тогда
		ТолькоЗапись = Истина;
	ИначеЕсли РежимЗаписи = Неопределено Тогда
		РежимЗаписи = РежимЗаписиДокумента.Запись;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Документ) Тогда // получены изменения по существующему документу
		ДокументОбъект = Документ.ПолучитьОбъект();
		//Попытка заблокировать документ
		Попытка
			ДокументОбъект.Заблокировать();
		Исключение
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить данные документа ""%1"".
				|Возможно, документ редактируется другим пользователем'"),
				Строка(ДокументОбъект.Ссылка));
			ВызватьИсключение ТекстСообщения;
		КонецПопытки;
		//конец попытки заблокировать документ
		Если ДокументОбъект.Проведен Тогда 
			РежимЗаписи = РежимЗаписиДокумента.Проведение;
			Если ТолькоЗапись Тогда
				Текст = НСтр("ru = 'Операция возможна только для непроведенных документов.'");
				ОбщегоНазначения.СообщитьПользователю(Текст);
				Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Заполнение документа на основе ЭД.%1'", ОбщегоНазначения.КодОсновногоЯзыка()), Текст);
				ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка, ДокументОбъект.Метаданные(), Документ,Текст);
				Возврат Неопределено;
			КонецЕсли;
		КонецЕсли;
		Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ДокументОбъект, "РасшифровкаПлатежа") Тогда
			ДокументОбъект.РасшифровкаПлатежа.Очистить();
		КонецЕсли;
	Иначе // создаем новый
		ДокументОбъект = Документы[ИмяДокумента].СоздатьДокумент();
		ДокументОбъект.Дата = ТекущаяДатаСеанса();
		ДокументОбъект.Автор = Пользователи.АвторизованныйПользователь();
		ДокументОбъект.Заполнить(ДанныеДляЗагрузки);
		ДокументОбъект.УстановитьНовыйНомер();
	КонецЕсли;
	
	Возврат ДокументОбъект
	
КонецФункции

Процедура ЗаписатьУчетныйДокумент(ДокументОбъект, ДокументУчета, РежимЗаписи, Текст)
	
	Если ЗначениеЗаполнено(Текст) Тогда
		Возврат;
	КонецЕсли;
	
	ПредставлениеДокумента = Строка(ДокументУчета);
	
	Попытка
		// запись версии создаваемого документа в подсистеме версионирования
		ДокументОбъект.ОбменДанными.Загрузка = Ложь;
		ВерсионированиеОбъектовСобытия.ЗаписатьВерсиюДокумента(ДокументОбъект, Ложь, РежимЗаписи, РежимПроведенияДокумента.Неоперативный);
		ДокументОбъект.ОбменДанными.Загрузка = Истина;
		// запись версии конец
		
		Если РежимЗаписи = РежимЗаписиДокумента.Проведение Тогда
			ДокументОбъект.ОбменДанными.Загрузка = Ложь;
		КонецЕсли;
		
		ДокументОбъект.Записать(РежимЗаписи);
		ДокументОбъект.Разблокировать();
		ДокументУчета = ДокументОбъект.Ссылка;
		
		//Запись в Реестр документов
		Если РегистрыСведений.РеестрДокументов.ОбъектВключенВСоставДанныхРеестра(ДокументОбъект) Тогда
			ТаблицыДанных = ПроведениеДокументов.ДанныеДокументаДляПроведения(ДокументУчета, "РеестрДокументов");
			РегистрыСведений.РеестрДокументов.ЗаписатьДанные(ТаблицыДанных, ДокументУчета, Неопределено, Ложь);
		КонецЕсли;
		
	Исключение
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'Заполнение документа на основе ЭД.%1'",
			ОбщегоНазначения.КодОсновногоЯзыка()), Текст);
		ЗаписьЖурналаРегистрации(Текст, УровеньЖурналаРегистрации.Ошибка, ДокументОбъект.Метаданные(), ПредставлениеДокумента,
			ОбработкаОшибок.ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти

Процедура ЗаполнитьДанныеПервичногоДокументаУКД_2020(СтруктураДанных, СтруктураЭД, ДеревоДанных, Настройки)
	
	УстановитьПривилегированныйРежим(Истина);
	
	ДанныеШапки = СтруктураДанных.РезультатПоШапке.Выбрать();
	ДанныеШапки.Следующий();
	
	НДСИсчисляетсяНалоговымАгентом = Ложь;
	ОблагаетсяНДССМежценовойРазницы = Ложь;
	Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ДанныеШапки, "НалогообложениеНДС") Тогда
		НДСИсчисляетсяНалоговымАгентом = (ДанныеШапки.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ОблагаетсяНДСУПокупателя);
		ОблагаетсяНДССМежценовойРазницы = (ДанныеШапки.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ОблагаетсяНДССМежценовойРазницы);
	КонецЕсли;
	
	Если ТипЗнч(ДанныеШапки.Ссылка) = Тип("ДокументСсылка.СчетФактураВыданный") 
			или ТипЗнч(ДанныеШапки.Ссылка) = Тип("ДокументСсылка.СчетФактураКомиссионеру") Тогда
		ДокументИсправления = ДанныеШапки.Ссылка.ДокументОснование;
		СчетФактура = ДанныеШапки.Ссылка;	
	Иначе
		ДокументИсправления = ДанныеШапки.Ссылка;
		СчетФактура = Неопределено;
	КонецЕсли;

	Если ДокументИсправления = Неопределено Тогда
		ВидОперации = НСтр("ru = 'Формирование ЭД'");
		ПодробныйТекстОшибки = НСтр("ru = 'Ошибка при формирование ЭД. Для данного основания счета-фактуры формирование ЭД не предусмотрено.'");
		ТекстСообщения = НСтр("ru = 'Для данного основания счета-фактуры формирование ЭД не предусмотрено.'");
		ЭлектронноеВзаимодействие.ОбработатьОшибку(ВидОперации, ПодробныйТекстОшибки, ТекстСообщения);
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	ОпцииПечати = Новый Структура;
	ОпцииПечати.Вставить("НомерСформированВСчетеФактуре", СтруктураДанных.Свойство("НомерСформированВСчетеФактуре"));
	
	Если ОпцииПечати.НомерСформированВСчетеФактуре Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "НомерДокумента",  ДанныеШапки.Номер);		
	Иначе
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, 
			"НомерДокумента",  НомерСчетаФактурыНаПечать(ДанныеШапки.Номер, ДанныеШапки.ИндексПодразделения));
	КонецЕсли;	
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокумента", ДанныеШапки.Дата);	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "СодержаниеОперации", НСтр("ru = 'Предлагаю изменить стоимость'"));
	
	Если ДанныеШапки.Исправление Тогда
		Если ЗначениеЗаполнено(ДанныеШапки.НомерИсправления) И ЗначениеЗаполнено(ДанныеШапки.ДатаИсправления) Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления", Число(ДанныеШапки.НомерИсправления));	
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсправления", ДанныеШапки.ДатаИсправления);
		КонецЕсли;	
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ВидДокумента", "Корректировка");
	
	Если ТипЗнч(ДокументИсправления) = Тип("ДокументСсылка.ВозвратТоваровМеждуОрганизациями") Тогда 
		ДокументРеализации = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументИсправления, "ДокументПередачи");
		
		ДопДанныеДокументаОтгрузки = ДеревоДанных.Строки.Найти("ДопДанныеСчетаФактуры", "ПолныйПуть");
		Если Не ДопДанныеДокументаОтгрузки = Неопределено Тогда
			
			ДопДанныеДокументаОтгрузки.Значение = Истина;
			
			ТекстоваяИнформация = Новый ТаблицаЗначений;
			ТекстоваяИнформация.Колонки.Добавить("Идентификатор");
			ТекстоваяИнформация.Колонки.Добавить("Значение");
			
			НоваяСтрока = ТекстоваяИнформация.Добавить();
			НоваяСтрока.Идентификатор = "ИдентификаторСЧФ";
			НоваяСтрока.Значение = Строка(СчетФактура.УникальныйИдентификатор());
			
			НоваяСтрока = ТекстоваяИнформация.Добавить();
			НоваяСтрока.Идентификатор = "ИдентификаторПередачи";
			НоваяСтрока.Значение = Строка(ДокументИсправления.УникальныйИдентификатор());
			
			ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ТекстоваяИнформация, "ДопДанныеСчетаФактуры.ТекстоваяИнформация");
			
		КонецЕсли;
	ИначеЕсли ТипЗнч(ДокументИсправления) = Тип("ДокументСсылка.СчетФактураВыданный")
		И ТипЗнч(ДокументИсправления.Контрагент) = Тип("СправочникСсылка.Организации") Тогда
		ДопДанныеДокументаОтгрузки = ДеревоДанных.Строки.Найти("ДопДанныеСчетаФактуры", "ПолныйПуть");
		Если Не ДопДанныеДокументаОтгрузки = Неопределено Тогда
			
			ДопДанныеДокументаОтгрузки.Значение = Истина;
			
			ТекстоваяИнформация = Новый ТаблицаЗначений;
			ТекстоваяИнформация.Колонки.Добавить("Идентификатор");
			ТекстоваяИнформация.Колонки.Добавить("Значение");
			
			НоваяСтрока = ТекстоваяИнформация.Добавить();
			НоваяСтрока.Идентификатор = "ИдентификаторСЧФ";
			НоваяСтрока.Значение = Строка(СчетФактура.УникальныйИдентификатор());
			
			ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ТекстоваяИнформация, "ДопДанныеСчетаФактуры.ТекстоваяИнформация");
			
		КонецЕсли;
		
	ИначеЕсли ТипЗнч(ДокументИсправления) = Тип("ДокументСсылка.ВозвратТоваровОтКлиента") Тогда
		ДокументРеализации = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументИсправления, "ДокументРеализации");
	Иначе
		ДокументРеализации = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументИсправления, "ДокументОснование");
	КонецЕсли;
	ДокументыОснования = Новый Массив;
	Если СчетФактура <> Неопределено Тогда
		ТаблицаИсходныхДокументов = СчетФактура.Товары.Выгрузить();
		ТаблицаИсходныхДокументов.Свернуть("ПредыдущийСчетФактура");
	Иначе
		ТаблицаИсходныхДокументов = Неопределено;
	КонецЕсли;
	
	Если СтруктураЭД.Функция = "КСЧФ"
		Или СтруктураЭД.Функция = "КСЧФДИС" Тогда

		Если ТаблицаИсходныхДокументов <> Неопределено Тогда
			Для Каждого СтрокаТЧ Из ТаблицаИсходныхДокументов Цикл
				Если ЗначениеЗаполнено(СтрокаТЧ.ПредыдущийСчетФактура) Тогда
					ДокументыОснования.Добавить(СтрокаТЧ.ПредыдущийСчетФактура);
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
		Для Каждого СтрокаТЧ Из СчетФактура.ДокументыОснования Цикл
			ОснованиеСчетаФактуры = СтрокаТЧ.ДокументОснование;
			Если ЗначениеЗаполнено(ОснованиеСчетаФактуры) Тогда
				ДокументыОснования.Добавить(ОснованиеСчетаФактуры);
			КонецЕсли;
		КонецЦикла;	
		
	Иначе
		Если ЗначениеЗаполнено(ДокументРеализации) Тогда
			ДокументыОснования.Добавить(ДокументРеализации);
		КонецЕсли;
	КонецЕсли;
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументыОснованияСчетаФактуры", ДокументыОснования);

	Если ТипЗнч(ДокументРеализации) = Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда
		ВнестиСведенияОВыбытииМаркированныхТоваровВДеревоУПДУКД(ДеревоДанных, ДокументРеализации.ВариантВыбытияМаркируемойПродукции);
	КонецЕсли;
	
	// ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС
	ЭтоЭлектронноеАктированиеЕИС = Ложь;
	ДанныеПриложенияЕИС = Неопределено;
	Если СтруктураДанных.Свойство("ДанныеЭлектронногоАктирования") Тогда		
		ЭтоЭлектронноеАктированиеЕИС = Истина;
		ДанныеПриложенияЕИС = ЭлектронноеАктированиеЕИС.НовыеДанныеПриложенияКТитулуПродавцаУКД();
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
			"ДанныеЭлектронногоАктированияЕИС.ДанныеПриложения", ДанныеПриложенияЕИС);
		ДанныеЭлектронногоАктированияЕИС = СтруктураДанных.ДанныеЭлектронногоАктирования;  
		
		ЭлектронноеАктированиеЕИСУТ.ЗаполнитьДанныеДереваДляЭлектронногоАктированияЕИС(ДеревоДанных,
			ДанныеЭлектронногоАктированияЕИС,
			ДанныеШапки,
			ДанныеПриложенияЕИС,
			ДокументРеализации,
			Истина);			
	Иначе
		ЭлектронноеАктированиеЕИСУТ.ПроверитьДоговорЭД(Настройки, ДокументИсправления, ДеревоДанных, Истина);
	КонецЕсли;
	// Конец ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС
	
	ИсходныеДокументы = Новый ТаблицаЗначений;
	ИсходныеДокументы.Колонки.Добавить("НомерИсходногоДокумента");
	ИсходныеДокументы.Колонки.Добавить("ДатаИсходногоДокумента");
	ИсходныеДокументы.Колонки.Добавить("ИсправленияИсходногоДокумента"); 
	
	Если СчетФактура <> Неопределено И Не ТипЗнч(ДокументРеализации) = Тип("ДокументСсылка.ПервичныйДокумент") Тогда
		Для Каждого СтрокаТЧ Из ТаблицаИсходныхДокументов Цикл
			Если Не ЗначениеЗаполнено(СтрокаТЧ.ПредыдущийСчетФактура) Тогда
				Продолжить;
			КонецЕсли;
			
			ИсходныйДокумент = СтрокаТЧ.ПредыдущийСчетФактура;
			НомерИсходногоДокумента = ИсходныйДокумент.ПредставлениеНомера;
			ДатаИсходногоДокумента = ?(ИсходныйДокумент.Исправление, ИсходныйДокумент.СчетФактураОснование.Дата, ИсходныйДокумент.Дата);
			НомерИсправленияИсходногоДокумента = ?(ЗначениеЗаполнено(ИсходныйДокумент.НомерИсправления), Число(ИсходныйДокумент.НомерИсправления), "");
			ДатаИсправленияИсходногоДокумента = ?(ИсходныйДокумент.Исправление, ИсходныйДокумент.Дата, Дата(1,1,1));
			
			ИсходныйДокументСтрока = ИсходныеДокументы.Добавить();
			ИсходныйДокументСтрока.НомерИсходногоДокумента = НомерИсходногоДокумента;
			ИсходныйДокументСтрока.ДатаИсходногоДокумента = ДатаИсходногоДокумента;

			ИсправленияИсходногоДокумента = Новый ТаблицаЗначений;
			ИсправленияИсходногоДокумента.Колонки.Добавить("НомерИсправленияИсходногоДокумента");
			ИсправленияИсходногоДокумента.Колонки.Добавить("ДатаИсправленияИсходногоДокумента");
			
			Если ЗначениеЗаполнено(НомерИсправленияИсходногоДокумента) Тогда
				ИсправлениеИсходногоДокумента = ИсправленияИсходногоДокумента.Добавить();
				ИсправлениеИсходногоДокумента.НомерИсправленияИсходногоДокумента = НомерИсправленияИсходногоДокумента;
				ИсправлениеИсходногоДокумента.ДатаИсправленияИсходногоДокумента = ДатаИсправленияИсходногоДокумента; 				
			КонецЕсли;
		
			Если ИсправленияИсходногоДокумента.Количество() > 0 Тогда
				ИсходныйДокументСтрока.ИсправленияИсходногоДокумента = ИсправленияИсходногоДокумента;
			КонецЕсли;
		
		КонецЦикла;
	Иначе
		Основание = ДокументИсправления.ДокументОснование;
		
		ИсходныйДокументСтрока = ИсходныеДокументы.Добавить();
		ИсходныйДокументСтрока.НомерИсходногоДокумента = НомерСчетаФактурыНаПечать(Основание.Номер, ДанныеШапки.ИндексПодразделения);
		ИсходныйДокументСтрока.ДатаИсходногоДокумента = Основание.Дата;
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ИсходныеДокументы, "ИсходныеДокументы");
		
	ТекстОшибки = НСтр("ru = 'Не удалось заполнить код валюты документа. Проверьте, что:
	|	- в документе указана валюта,
	|	- для нее заполнен код по Общероссийскому классификатору валют.'");
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод", "643", ТекстОшибки);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ДополнительныеСведенияОбУчастниках.ВалютаНаименование", "Российский рубль");
	
	Если СчетФактура <> Неопределено Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ТолькоУслуги", ДанныеШапки.ТолькоУслуги);
	Иначе
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ТолькоУслуги", Ложь);
	КонецЕсли;
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаНаправленияНаСогласование", ДанныеШапки.Дата);
	
	Если ЗначениеЗаполнено(ДанныеШапки.БанковскийСчетОрганизации) Тогда
		БанковскийСчетОрганизации = ДанныеШапки.БанковскийСчетОрганизации;
	Иначе
		БанковскийСчетОрганизации = Неопределено;
	КонецЕсли;
	СведенияОПоставщике = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(ДанныеШапки.Организация, БанковскийСчетОрганизации, ДанныеШапки.Дата);
	Если ЗначениеЗаполнено(ДанныеШапки.КПППоставщика) Тогда
		СведенияОПоставщике.КПП = ДанныеШапки.КПППоставщика;
	КонецЕсли;
	

	// ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС
	Если ЭтоЭлектронноеАктированиеЕИС Тогда
		Если ДанныеЭлектронногоАктированияЕИС.ДанныеГосконтракта.Количество() = 0 Тогда
			ТекстОшибки = НСтр("ru = 'Не указан гос.контракт или не выбран этап гос.контракта.'");
			ЭлектронноеАктированиеЕИС.ДобавитьОшибкуЗаполненияПриложения(
				ДанныеПриложенияЕИС, ТекстОшибки);		
		Иначе
			НаименованиеПоставщикаДляЕИС = ДанныеЭлектронногоАктированияЕИС.ДанныеГосконтракта[0].ПолноеНаименованиеПоставщика;
			СведенияОПоставщике.ПолноеНаименование = НаименованиеПоставщикаДляЕИС;
		КонецЕсли;
	КонецЕсли;
	// Конец ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС

	
	ЗаполнитьДанныеУчастникаУПД(ДеревоДанных, СведенияОПоставщике, "СведенияОПродавце", "Юр", ДанныеШапки.Дата);
	// Заполняем структурное подразделение
	ЗаполнитьСтруктурноеПодразделение(ДеревоДанных, "СведенияОПродавце", ДанныеШапки.Ссылка.Подразделение);
	
	СоставительДокументаНаименование = СведенияОПоставщике.ПолноеНаименование
		+ ?(ЗначениеЗаполнено(СведенияОПоставщике.КПП),
			СтрШаблон(НСтр("ru = ', ИНН/КПП %1/%2'"), СведенияОПоставщике.ИНН, СведенияОПоставщике.КПП),
			СтрШаблон(НСтр("ru = ', ИНН %1'"), СведенияОПоставщике.ИНН)); 	


	// ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС
	Если ЭтоЭлектронноеАктированиеЕИС Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
			"СоставительДокументаНаименование", НаименованиеПоставщикаДляЕИС);
	Иначе
	// Конец ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС

		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
			"СоставительДокументаНаименование", СоставительДокументаНаименование);

	// ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС
	КонецЕсли;
	// Конец ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС

	
	Если ЗначениеЗаполнено(ДанныеШапки.БанковскийСчетКонтрагента) Тогда
		БанковскийСчетКонтрагента = ДанныеШапки.БанковскийСчетКонтрагента;
	Иначе
		БанковскийСчетКонтрагента = Неопределено;
	КонецЕсли;	
	СведенияОПокупателе = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(ДанныеШапки.Контрагент, БанковскийСчетКонтрагента, ДанныеШапки.Дата);
	Если ЗначениеЗаполнено(ДанныеШапки.КПППокупателя) Тогда	
		СведенияОПокупателе.КПП = ДанныеШапки.КПППокупателя;
	КонецЕсли;
	ЗаполнитьДанныеУчастникаУПД(ДеревоДанных, СведенияОПокупателе, "СведенияОПокупателе", "Юр", ДанныеШапки.Дата);
	
	ОснованиеКорректировки = Новый ТаблицаЗначений;
	ОснованиеКорректировки.Колонки.Добавить("ДокументНаименование");
	ОснованиеКорректировки.Колонки.Добавить("ДокументНомер");
	ОснованиеКорректировки.Колонки.Добавить("ДокументДата");
	ОснованиеКорректировки.Колонки.Добавить("ДокументДопСведения");
	
	Если ЗначениеЗаполнено(ДанныеШапки.Основание)
		И ЗначениеЗаполнено(ДанныеШапки.ОснованиеДата) Тогда
		НоваяСтрока = ОснованиеКорректировки.Добавить();
		Если СтрНайти(ДанныеШапки.Основание, "№") Тогда
			СтрокаНаименование = Лев(ДанныеШапки.Основание, СтрНайти(ДанныеШапки.Основание, "№") - 2);
			Если ПустаяСтрока(СтрокаНаименование) Тогда
				СтрокаНаименование = "Договор";
			КонецЕсли;
		Иначе
			СтрокаНаименование = ДанныеШапки.Основание;
		КонецЕсли;
		НоваяСтрока.ДокументНаименование = СтрокаНаименование;
		НоваяСтрока.ДокументНомер = ДанныеШапки.ОснованиеНомер;
		НоваяСтрока.ДокументДата = ДанныеШапки.ОснованиеДата;
		
		ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(НоваяСтрока, "ДокументДата",,,
			НСтр("ru = 'Необходимо указать дату договора.'"));
		
		Если ЗначениеЗаполнено(СтрокаНаименование) Тогда
			ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ОснованиеКорректировки, "ОснованиеКорректировки");
		КонецЕсли;
	КонецЕсли;
	
	ПередаточныйДокумент = Новый ТаблицаЗначений;
	ПередаточныйДокумент.Колонки.Добавить("ДокументНаименование");
	ПередаточныйДокумент.Колонки.Добавить("ДокументНомер");
	ПередаточныйДокумент.Колонки.Добавить("ДокументДата");
	
	РезультатПоИсходнымДанным = СтруктураДанных.РезультатПоИсходнымДанным.Выбрать();
	Пока РезультатПоИсходнымДанным.Следующий() Цикл
		Если ЗначениеЗаполнено(РезультатПоИсходнымДанным.НомерСчетаФактуры)
			И ЗначениеЗаполнено(РезультатПоИсходнымДанным.ДатаСчетаФактуры) Тогда
			
			ОписаниеОснования = СтрШаблон(НСтр("ru = 'Универсальный передаточный документ № %1 от %2'"),
				РезультатПоИсходнымДанным.НомерСчетаФактуры, Формат(РезультатПоИсходнымДанным.ДатаСчетаФактуры, "ДЛФ=D"));
				
			Если ЗначениеЗаполнено(РезультатПоИсходнымДанным.НомерИсправленияСчетаФактуры)
				И ЗначениеЗаполнено(РезультатПоИсходнымДанным.ДатаИсправленияСчетаФактуры) Тогда
				
				ОписаниеОснования = ОписаниеОснования + ", " + СтрШаблон(НСтр("ru = 'с учетом исправления № %1 от %2'"),
					РезультатПоИсходнымДанным.НомерИсправленияСчетаФактуры,
					Формат(РезультатПоИсходнымДанным.ДатаИсправленияСчетаФактуры, "ДЛФ=D"));
					
			КонецЕсли;
			
			НоваяСтрока = ПередаточныйДокумент.Добавить();
			НоваяСтрока.ДокументНаименование = ОписаниеОснования;
			НоваяСтрока.ДокументНомер = РезультатПоИсходнымДанным.НомерСчетаФактуры;
			НоваяСтрока.ДокументДата = РезультатПоИсходнымДанным.ДатаСчетаФактуры;
			
		КонецЕсли;
	КонецЦикла;
	
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ПередаточныйДокумент, "ПередаточныйДокумент");
	
	ТаблицаТоваров = Новый ТаблицаЗначений;
	ТаблицаТоваров.Колонки.Добавить("НомерСтроки", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(6)));
	ТаблицаТоваров.Колонки.Добавить("НомерСтрокиИсходногоДокумента");
	ТаблицаТоваров.Колонки.Добавить("ТоварНаименование");
	ТаблицаТоваров.Колонки.Добавить("ЕдиницаИзмеренияКодДоКорректировки");
	ТаблицаТоваров.Колонки.Добавить("ЕдиницаИзмеренияКод");
	ТаблицаТоваров.Колонки.Добавить("КоличествоДоКорректировки", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(26,11)));
	ТаблицаТоваров.Колонки.Добавить("Количество", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(26,11)));
	ТаблицаТоваров.Колонки.Добавить("ЦенаЗаЕдиницуИзмеренияДоКорректировки", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(26,11)));
	ТаблицаТоваров.Колонки.Добавить("ЦенаЗаЕдиницуИзмерения", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(26,11)));
	ТаблицаТоваров.Колонки.Добавить("СтоимостьТоваровБезНалогаДоКорректировки", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СтоимостьТоваровБезНалога", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СтоимостьТоваровБезНалогаУвеличение", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СтоимостьТоваровБезНалогаУменьшение", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("НалоговаяСтавкаДоКорректировки");
	ТаблицаТоваров.Колонки.Добавить("НалоговаяСтавка");
	ТаблицаТоваров.Колонки.Добавить("СуммаНалогаДоКорректировки", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СуммаНалога", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СуммаНалогаУвеличение");
	ТаблицаТоваров.Колонки.Добавить("СуммаНалогаУменьшение");
	ТаблицаТоваров.Колонки.Добавить("СуммаАкцизаДоКорректировки", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СуммаАкциза", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СуммаАкцизаУвеличение");
	ТаблицаТоваров.Колонки.Добавить("СуммаАкцизаУменьшение");
	ТаблицаТоваров.Колонки.Добавить("СтоимостьТоваровСНалогомДоКорректировки", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СтоимостьТоваровСНалогом", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СтоимостьТоваровСНалогомУвеличение", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СтоимостьТоваровСНалогомУменьшение", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("ХарактеристикаОписаниеТовара", Новый ОписаниеТипов("Строка", Новый КвалификаторыСтроки(1000)));
	ТаблицаТоваров.Колонки.Добавить("СортТовара", Новый ОписаниеТипов("Строка", Новый КвалификаторыСтроки(10)));
	ТаблицаТоваров.Колонки.Добавить("АртикулТовара", Новый ОписаниеТипов("Строка", Новый КвалификаторыСтроки(50)));
	ТаблицаТоваров.Колонки.Добавить("КодТовара", Новый ОписаниеТипов("Строка", Новый КвалификаторыСтроки(100)));
	ТаблицаТоваров.Колонки.Добавить("НаименованиеЕдиницыИзмеренияДоКорректировки", Новый ОписаниеТипов("Строка", Новый КвалификаторыСтроки(255)));
	ТаблицаТоваров.Колонки.Добавить("НаименованиеЕдиницыИзмеренияПослеКорректировки", Новый ОписаниеТипов("Строка", Новый КвалификаторыСтроки(255)));
	ТаблицаТоваров.Колонки.Добавить("КодВидаТовара", Новый ОписаниеТипов("Строка", Новый КвалификаторыСтроки(10)));
	ТаблицаТоваров.Колонки.Добавить("ТоварИдентификатор", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(255)));
	ТаблицаТоваров.Колонки.Добавить("Сопоставление");
	ТаблицаТоваров.Колонки.Добавить("СведенияОПрослеживаемости");
	ТаблицаТоваров.Колонки.Добавить("СведенияОТаможеннойДекларации");
	
	// Маркировка
	ТаблицаТоваров.Колонки.Добавить("СведенияОМаркировкеДо");
	ТаблицаТоваров.Колонки.Добавить("СведенияОМаркировкеПосле");

	СтруктураЗаполненияСтроки = Новый Структура;
	Для Каждого КолонкиТаблицы Из ТаблицаТоваров.Колонки Цикл
		СтруктураЗаполненияСтроки.Вставить(КолонкиТаблицы.Имя); 
	КонецЦикла;

	ВыборкаПоДокументам = СтруктураДанных.РезультатПоТабличнойЧасти.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	ВыборкаПоДокументам.Следующий();
	СтрокаТовары = ВыборкаПоДокументам.Выбрать();
	
	ИспользоватьНаборы = Ложь;
	Если ОбщегоНазначенияУТКлиентСервер.ЕстьРеквизитОбъекта(ВыборкаПоДокументам, "ЭтоНабор") Тогда
		ИспользоватьНаборы = Истина;
	КонецЕсли;
	
	НомерСтроки = 1;
	
	ШтрихкодыКомбинаций = Неопределено;
	ШтрихкодыНоменклатуры = Неопределено;
	НоменклатураПартнеровСервер.ШтрихкодыПоТоварам(СтрокаТовары, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры);	

	Если ЗначениеЗаполнено(СведенияОПокупателе) Тогда
		ВыводитьКодыТНВЭД = ВыводитьКодыТНВЭД(СведенияОПокупателе.СтранаРегистрации, ДанныеШапки.Дата);
	Иначе
		ВыводитьКодыТНВЭД = Ложь;
	КонецЕсли;
	
	ВыборкаДляСопоставления = НоменклатураПартнеровСервер.ВыборкаДляСопоставленияНоменклатуры(ДокументИсправления);
	СоответствиеСтавокНДСКонтрагента = Новый Соответствие;
	ЗаполнитьСоответствиеСтавокНДС(СоответствиеСтавокНДСКонтрагента);	
	ТаблицаСопоставления = ВыборкаДляСопоставления.Выгрузить();
	
	// Маркировка
	ТаблицаКодовМаркировкиДо = Неопределено;
	СтруктураДанных.Свойство("МаркировкаДо", ТаблицаКодовМаркировкиДо);
	ТаблицаКодовМаркировкиПосле = Неопределено;
	СтруктураДанных.Свойство("Маркировка", ТаблицаКодовМаркировкиПосле);
	Если ТаблицаКодовМаркировкиДо <> Неопределено И ТаблицаКодовМаркировкиДо.Количество() > 0 Тогда
		Отказ = Ложь;
		ПроверитьШтрихкодыУпаковок(ТаблицаКодовМаркировкиДо, Отказ);
		ПроверитьШтрихкодыУпаковок(ТаблицаКодовМаркировкиПосле, Отказ);
		Если Отказ = Истина Тогда
			ВызватьИсключение НСтр("ru = 'Возникла ошибка при заполнении кодов маркировки.
			|	Формирование электронного документа прервано.'");
		КонецЕсли;
		ЭлектронноеВзаимодействиеИСМП.ЗаполнитьРасхожденияКодовМаркировкиУКД(ТаблицаКодовМаркировкиДо, ТаблицаКодовМаркировкиПосле);
	КонецЕсли;
	
	// Получение данных о прослеживаемых комплектующих
	ПрослеживаемыеКомплектующие = Неопределено;
	СтруктураДанных.Свойство("ПрослеживаемыеКомплектующие", ПрослеживаемыеКомплектующие);

	ВыводитьСерии = Константы.ВыводитьСерииВПечатныхФормах.Получить() 
					И СтруктураДанных.РезультатПоТабличнойЧасти.Колонки.Найти("СерияНаименование") <> Неопределено;
	
	Пока СтрокаТовары.Следующий() Цикл
		
		НовСтрока = ОбщегоНазначения.СкопироватьРекурсивно(СтруктураЗаполненияСтроки);
		ЗаполнитьЗначенияСвойств(НовСтрока, СтрокаТовары);
		НовСтрока.НомерСтроки = НомерСтроки;
		Если СтруктураЭД.Функция <> "ДИС" Тогда
			Если Не ТипЗнч(ДокументРеализации) = Тип("ДокументСсылка.АктВыполненныхРабот") Тогда
				НовСтрока.НомерСтрокиИсходногоДокумента = СтрокаТовары.НомерСтрокиИсходногоСФ;
			Иначе
				НовСтрока.НомерСтрокиИсходногоДокумента = НомерСтроки;
			КонецЕсли;
		Иначе
			НовСтрока.НомерСтрокиИсходногоДокумента = 0;
		КонецЕсли;
		НомерСтроки = НомерСтроки + 1;

		СерияНаименование = Неопределено;
		Если ВыводитьСерии Тогда
			СерияНаименование = СтрокаТовары.СерияНаименование;
		КонецЕсли;
		
		НовСтрока.ТоварНаименование  = НоменклатураКлиентСервер.ПредставлениеНоменклатурыДляПечати(
			СтрокаТовары.НоменклатураНаименование,
			СтрокаТовары.ХарактеристикаНаименование
			,
			СерияНаименование
			) + ?(СтрокаТовары.ЭтоВозвратнаяТара, НСтр("ru = '(возвратная тара)'"), "");
			
		НовСтрока.ТоварИдентификатор 						= Строка(СтрокаТовары.Номенклатура.УникальныйИдентификатор());
		Если ЗначениеЗаполнено(СтрокаТовары.СтавкаНДС) Тогда
			Если ОблагаетсяНДССМежценовойРазницы Тогда 
				НовСтрока.НалоговаяСтавкаДоКорректировки 		= УчетНДСРФВызовСервера.СтавкаНДСПоЗначениюПеречисления(СтрокаТовары.СтавкаНДС.ПеречислениеСтавкаНДС, Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС);
				НовСтрока.НалоговаяСтавка						= УчетНДСРФВызовСервера.СтавкаНДСПоЗначениюПеречисления(СтрокаТовары.СтавкаНДС.ПеречислениеСтавкаНДС, Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС);
			Иначе
				НовСтрока.НалоговаяСтавкаДоКорректировки 		= СтрокаТовары.СтавкаНДС;
				НовСтрока.НалоговаяСтавка						= СтрокаТовары.СтавкаНДС;
			КонецЕсли;
		Иначе
			НовСтрока.НалоговаяСтавкаДоКорректировки 		= Справочники.СтавкиНДС.БезНДС;
			НовСтрока.НалоговаяСтавка						= Справочники.СтавкиНДС.БезНДС;
		КонецЕсли;
		
		Если НаборыСервер.ВыводитьТолькоЗаголовок(СтрокаТовары, ИспользоватьНаборы) Тогда
			НовСтрока.СтоимостьТоваровСНалогом  = 0;
			НовСтрока.СуммаНалога  = 0;
			НовСтрока.СтоимостьТоваровСНалогомДоКорректировки  = 0;
			НовСтрока.СуммаНалогаДоКорректировки  = 0;
			Продолжить;	
		КонецЕсли;
		
		НовСтрока.ЕдиницаИзмеренияКодДоКорректировки		= СокрЛП(СтрокаТовары.ЕдиницаИзмеренияКод);
		НовСтрока.ЕдиницаИзмеренияКод               		= СокрЛП(СтрокаТовары.ЕдиницаИзмеренияКод);
		НовСтрока.КоличествоДоКорректировки					= СтрокаТовары.КоличествоДо;
		НовСтрока.Количество                				= СтрокаТовары.Количество;
		НовСтрока.ЦенаЗаЕдиницуИзмеренияДоКорректировки 	= Окр(СтрокаТовары.ЦенаДо, 2);
		НовСтрока.ЦенаЗаЕдиницуИзмерения                	= Окр(СтрокаТовары.Цена, 2);
		НовСтрока.СтоимостьТоваровБезНалогаДоКорректировки 	= Окр(СтрокаТовары.СуммаБезНДСДо, 2);
		НовСтрока.СтоимостьТоваровБезНалога                	= Окр(СтрокаТовары.СуммаБезНДС, 2);
		НовСтрока.СтоимостьТоваровБезНалогаУвеличение      	= Окр(СтрокаТовары.РазницаБезНДСУвеличение, 2);
		НовСтрока.СтоимостьТоваровБезНалогаУменьшение      	= Окр(СтрокаТовары.РазницаБезНДСУменьшение, 2);
		НовСтрока.СуммаНалогаДоКорректировки 				= Окр(СтрокаТовары.СуммаНДСДо, 2);
		НовСтрока.СуммаНалога                				= Окр(СтрокаТовары.СуммаНДС, 2);
		НовСтрока.СуммаНалогаУвеличение      				= Окр(СтрокаТовары.РазницаНДСУвеличение, 2);
		НовСтрока.СуммаНалогаУменьшение      				= Окр(СтрокаТовары.РазницаНДСУменьшение, 2);
		НовСтрока.СтоимостьТоваровСНалогомДоКорректировки 	= Окр(СтрокаТовары.СуммаСНДСДо, 2);
		НовСтрока.СтоимостьТоваровСНалогом                	= Окр(СтрокаТовары.СуммаСНДС, 2);
		НовСтрока.СтоимостьТоваровСНалогомУвеличение      	= Окр(СтрокаТовары.РазницаСНДСУвеличение, 2);
		НовСтрока.СтоимостьТоваровСНалогомУменьшение      	= Окр(СтрокаТовары.РазницаСНДСУменьшение, 2);
	
		Если НДСИсчисляетсяНалоговымАгентом Тогда
			НовСтрока.НалоговаяСтавка                         = "НДС исчисляется налоговым агентом";
			НовСтрока.НалоговаяСтавкаДоКорректировки          = "НДС исчисляется налоговым агентом";
			НовСтрока.СуммаНалога                             = 0;
			НовСтрока.СуммаНалогаДоКорректировки              = 0;
			НовСтрока.СуммаНалогаУвеличение                   = 0;
			НовСтрока.СуммаНалогаУменьшение                   = 0;
			НовСтрока.СтоимостьТоваровСНалогом                = 0;
			НовСтрока.СтоимостьТоваровСНалогомДоКорректировки = 0;
			НовСтрока.СтоимостьТоваровСНалогомУвеличение      = 0;
			НовСтрока.СтоимостьТоваровСНалогомУменьшение      = 0;
		КонецЕсли;
		
		Если НовСтрока.Количество = 0 И НовСтрока.ЦенаЗаЕдиницуИзмерения = 0 Тогда
			НовСтрока.ЦенаЗаЕдиницуИзмерения = НовСтрока.ЦенаЗаЕдиницуИзмеренияДоКорректировки;	
		КонецЕсли;
		
		НовСтрока.ХарактеристикаОписаниеТовара = ?(СтрокаТовары.ХарактеристикаНаименование = Null, "", СтрокаТовары.ХарактеристикаНаименование);
		НовСтрока.КодТовара = СтрокаТовары.НоменклатураКод;
		НовСтрока.СортТовара = "";
		НовСтрока.НаименованиеЕдиницыИзмеренияДоКорректировки = СтрокаТовары.ЕдиницаИзмеренияНаименование;
		НовСтрока.НаименованиеЕдиницыИзмеренияПослеКорректировки = СтрокаТовары.ЕдиницаИзмеренияНаименование;
		Если ЗначениеЗаполнено(СтрокаТовары.КодТНВЭД) И ВыводитьКодыТНВЭД Тогда			 
			НовСтрока.КодВидаТовара = СтрокаТовары.КодТНВЭД.Код;
		Иначе
			НовСтрока.КодВидаТовара =  "-         ";			
		КонецЕсли;	
		
		УпаковкаИзДокумента = Неопределено;
		Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(СтрокаТовары, "Упаковка") И ЗначениеЗаполнено(СтрокаТовары.Упаковка) Тогда
			УпаковкаИзДокумента = СтрокаТовары.Упаковка;
		Иначе
			УпаковкаИзДокумента = ЭлектронноеВзаимодействиеУТВызовСервера.ЕдиницаХраненияНоменклатуры(СтрокаТовары.Номенклатура)
		КонецЕсли;
		
		// Сопоставление.
		ПараметрыОтбора = Новый Структура;
		ПараметрыОтбора.Вставить("Номенклатура", СтрокаТовары.Номенклатура);
		Если СтрокаТовары.Характеристика <> Неопределено Тогда
			ПараметрыОтбора.Вставить("Характеристика", СтрокаТовары.Характеристика);
		Иначе
			ПараметрыОтбора.Вставить("Характеристика", Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());
		КонецЕсли;
		ПараметрыОтбора.Вставить("Упаковка", УпаковкаИзДокумента);
		СтрокиИзНоменклатурыКонтрагентов = ТаблицаСопоставления.НайтиСтроки(ПараметрыОтбора);
		Если СтрокиИзНоменклатурыКонтрагентов.Количество() Тогда
			НайденнаяСтрока = СтрокиИзНоменклатурыКонтрагентов[0];
			НовСтрока.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(НайденнаяСтрока,,,,СоответствиеСтавокНДСКонтрагента);
	    Иначе
			НовСтрока.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(СтрокаТовары, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры, УпаковкаИзДокумента);
		КонецЕсли;
		
		Если ОблагаетсяНДССМежценовойРазницы
			И ТипЗнч(НовСтрока.Сопоставление.СтавкаНДС) = Тип("СправочникСсылка.СтавкиНДС") Тогда
			НовСтрока.Сопоставление.СтавкаНДС = УчетНДСРФВызовСервера.СтавкаНДСПоЗначениюПеречисления(НовСтрока.Сопоставление.СтавкаНДС.ПеречислениеСтавкаНДС, Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС);
		КонецЕсли;
			
		//Заполнение Таможенной декларации
		ЗаполнитьСведенияОТаможеннойДекларации(НовСтрока, СтрокаТовары);
		//Конец заполнения Таможенной декларации
		
		// Заполнение прослеживаемости
		Если ЗначениеЗаполнено(СтрокаТовары.КоличествоПоРНПТ) или ЗначениеЗаполнено(СтрокаТовары.КоличествоПоРНПТДо) Тогда
			ЗаполнитьСведенияОПрослеживаемостиУКД(НовСтрока, СтрокаТовары, ПрослеживаемыеКомплектующие);
		КонецЕсли;
		// Конец заполнения прослеживаемости
		
		// Маркировка
		ЭлектронноеВзаимодействиеИСМП.ЗаполнитьСведенияОМаркировкеУКД2020(НовСтрока, СтрокаТовары, ТаблицаКодовМаркировкиДо, ТаблицаКодовМаркировкиПосле);
		
		// Не передавать в УКД строку без расхождений
		Если НовСтрока.КоличествоДоКорректировки <> НовСтрока.Количество
			Или НовСтрока.СтоимостьТоваровБезНалогаДоКорректировки <> НовСтрока.СтоимостьТоваровБезНалога
			Или НовСтрока.СуммаНалогаДоКорректировки <> НовСтрока.СуммаНалога
			Или НовСтрока.СтоимостьТоваровСНалогомДоКорректировки <> НовСтрока.СтоимостьТоваровСНалогом
			Или ЗначениеЗаполнено(НовСтрока.СведенияОМаркировкеДо) Или ЗначениеЗаполнено(НовСтрока.СведенияОМаркировкеПосле) Тогда
			НоваяСтрокаТоваров = ТаблицаТоваров.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрокаТоваров, НовСтрока);
		КонецЕсли;
		
		// ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС
		Если ЭтоЭлектронноеАктированиеЕИС Тогда
			ЭлектронноеАктированиеЕИСУТ.ЗаполнитьДанныеПоСтрокеТоваровУКД(НовСтрока, СтрокаТовары, СтруктураДанных, ДанныеПриложенияЕИС);
		КонецЕсли;
		// Конец ЭлектронноеВзаимодействие.ЭлектронноеАктированиеЕИС

	КонецЦикла;
	
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
		"Количество",,, НСтр("ru = 'Не указано количество товара в табличной части'"));
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
		"ЕдиницаИзмеренияКодДоКорректировки",,, НСтр("ru = 'Не заполнено наименование единицы измерения в справочнике ""Упаковки и единицы измерения"".'"));
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
		"ЕдиницаИзмеренияКод",,, НСтр("ru = 'Не заполнен код единицы измерения в справочнике ""Упаковки и единицы измерения"".'"));
	
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ТаблицаТоваров, "СведенияОТоварах");
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровБезНалогаУвеличение", ТаблицаТоваров.Итог("СтоимостьТоваровБезНалогаУвеличение"));
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровСНалогомУвеличение", ТаблицаТоваров.Итог("СтоимостьТоваровСНалогомУвеличение"));
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ВсегоИзмененияСтоимости.ВсегоСуммаНалогаУвеличение", ТаблицаТоваров.Итог("СуммаНалогаУвеличение"));
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровБезНалогаУменьшение", ТаблицаТоваров.Итог("СтоимостьТоваровБезНалогаУменьшение"));
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровСНалогомУменьшение", ТаблицаТоваров.Итог("СтоимостьТоваровСНалогомУменьшение"));
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ВсегоИзмененияСтоимости.ВсегоСуммаНалогаУменьшение", ТаблицаТоваров.Итог("СуммаНалогаУменьшение"));
	
	Если ТипЗнч(ДокументРеализации) = Тип("ДокументСсылка.ПервичныйДокумент") Тогда
		ПутьВДереве = "ДопДанныеСчетаФактуры.ТекстоваяИнформация";
		ДобавитьДопополнительныеДанныеВДерево(ДеревоДанных, "ДокументОснованиеПервичныйДокумент", Истина, ПутьВДереве);		
	КонецЕсли;
			
КонецПроцедуры

Процедура ЗаполнитьДанныеПервичногоДокументаУКД(СтруктураДанных, Настройки, СтруктураЭД, ДеревоДанных)
	
	УстановитьПривилегированныйРежим(Истина);

	ВсеВидыДокументов = ОбменСКонтрагентами.ТипыДокументов();
	ВидДокумента = Настройки.ТипДокумента;
	
	ДанныеШапки = СтруктураДанных.РезультатПоШапке.Выбрать();
	ДанныеШапки.Следующий();
	
	НДСИсчисляетсяНалоговымАгентом = Ложь;
	Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ДанныеШапки, "НалогообложениеНДС") Тогда
		НДСИсчисляетсяНалоговымАгентом = (ДанныеШапки.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ОблагаетсяНДСУПокупателя);
	КонецЕсли;
	
	Если ТипЗнч(ДанныеШапки.Ссылка) = Тип("ДокументСсылка.СчетФактураВыданный") 
			или ТипЗнч(ДанныеШапки.Ссылка) = Тип("ДокументСсылка.СчетФактураКомиссионеру") Тогда
		ДокументИсправления = ДанныеШапки.Ссылка.ДокументОснование;
		СчетФактура = ДанныеШапки.Ссылка;	
	Иначе
		ДокументИсправления = ДанныеШапки.Ссылка;
		СчетФактура = Неопределено;
	КонецЕсли;
	
	ОпцииПечати = Новый Структура;
	ОпцииПечати.Вставить("НомерСформированВСчетеФактуре", СтруктураДанных.Свойство("НомерСформированВСчетеФактуре"));
	
	Если ОпцииПечати.НомерСформированВСчетеФактуре Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "НомерДокумента",  ДанныеШапки.Номер);		
	Иначе
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, 
			"НомерДокумента",  НомерСчетаФактурыНаПечать(ДанныеШапки.Номер, ДанныеШапки.ИндексПодразделения));
	КонецЕсли;	
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокумента", ДанныеШапки.Дата);	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "СодержаниеОперации", НСтр("ru = 'Предлагаю изменить стоимость'"));
	
	Если ДанныеШапки.Исправление Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления", Число(ДанныеШапки.НомерИсправления));	
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсправления", ДанныеШапки.ДатаИсправления);
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ВидДокумента", "Корректировка");
	
	ДокументыОснования = Новый Массив;
	Если СтруктураЭД.Функция = "КСЧФ"
		Или СтруктураЭД.Функция = "КСЧФДИС" Тогда
		
		ТаблицаИсходныхДокументов = СчетФактура.Товары.Выгрузить();
		ТаблицаИсходныхДокументов.Свернуть("ПредыдущийСчетФактура");
		Для Каждого СтрокаТЧ Из ТаблицаИсходныхДокументов Цикл
			Если ЗначениеЗаполнено(СтрокаТЧ.ПредыдущийСчетФактура) Тогда
				ДокументыОснования.Добавить(СтрокаТЧ.ПредыдущийСчетФактура);
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого СтрокаТЧ Из СчетФактура.ДокументыОснования Цикл
			ОснованиеСчетаФактуры = СтрокаТЧ.ДокументОснование;
			Если ЗначениеЗаполнено(ОснованиеСчетаФактуры) Тогда
				ДокументыОснования.Добавить(ОснованиеСчетаФактуры);
			КонецЕсли;
		КонецЦикла;	
		
	Иначе
		Если ТипЗнч(ДокументИсправления) <> Тип("ДокументСсылка.ВозвратТоваровОтКлиента") Тогда 
			ДокументРеализации = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументИсправления, "ДокументОснование");
		Иначе
			ДокументРеализации = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументИсправления, "ДокументРеализации");
		КонецЕсли;
		Если ЗначениеЗаполнено(ДокументРеализации) Тогда
			ДокументыОснования.Добавить(ДокументРеализации);
		КонецЕсли;
	КонецЕсли;
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументыОснованияСчетаФактуры", ДокументыОснования);

	Если СчетФактура <> Неопределено Тогда
		Для Каждого СтрокаТЧ Из СчетФактура.Товары Цикл
			Если Не ЗначениеЗаполнено(СтрокаТЧ.ПредыдущийСчетФактура) Тогда
				Продолжить;
			КонецЕсли;
			
			ИсходныйДокумент = СтрокаТЧ.ПредыдущийСчетФактура.ПолучитьОбъект();
			НомерИсходногоДокумента = ИсходныйДокумент.ПредставлениеНомера;
			ДатаИсходногоДокумента = ?(ИсходныйДокумент.Исправление, ИсходныйДокумент.СчетФактураОснование.Дата, ИсходныйДокумент.Дата);
			НомерИсправленияИсходногоДокумента = ?(ЗначениеЗаполнено(ИсходныйДокумент.НомерИсправления), Число(ИсходныйДокумент.НомерИсправления), "");
			ДатаИсправленияИсходногоДокумента = ?(ИсходныйДокумент.Исправление, ИсходныйДокумент.Дата, Дата(1,1,1));
			
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсходногоДокумента", НомерИсходногоДокумента);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсходногоДокумента", ДатаИсходногоДокумента);
			
			ПредставлениеИсходногоДокумента = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						НСтр("ru = 'Универсальный передаточный документ № %1 от %2'"),
						НомерИсходногоДокумента,
						ДатаИсходногоДокумента);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ПредставлениеИсходногоДокумента", ПредставлениеИсходногоДокумента);
			
			Если ЗначениеЗаполнено(НомерИсправленияИсходногоДокумента) Тогда
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправленияИсходногоДокумента",
					Число(НомерИсправленияИсходногоДокумента));
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсправленияИсходногоДокумента",
					ДатаИсправленияИсходногоДокумента);
			КонецЕсли;
			
			Прервать;
		КонецЦикла;
	Иначе
		Основание = ДокументИсправления.ДокументОснование;
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсходногоДокумента", Основание.Номер);
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсходногоДокумента", Основание.Дата);
		
		Если ОпцииПечати.НомерСформированВСчетеФактуре Тогда
			НомерСчетаФактурыБезПрефикса = Основание.Номер;
		Иначе
			НомерСчетаФактурыБезПрефикса = НомерСчетаФактурыНаПечать(Основание.Номер, ДанныеШапки.ИндексПодразделения, Истина);
		КонецЕсли;
		
		ПредставлениеИсходногоДокумента = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Универсальный передаточный документ № %1 от %2'"),
				НомерСчетаФактурыБезПрефикса,
				Формат(Основание.Дата, "ДЛФ=D; ДП=--"));
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ПредставлениеИсходногоДокумента", ПредставлениеИсходногоДокумента);
	КонецЕсли;
		
	ОснованиеКорректировки = Новый ТаблицаЗначений;
	ОснованиеКорректировки.Колонки.Добавить("ДокументНаименование");
	ОснованиеКорректировки.Колонки.Добавить("ДокументНомер");
	ОснованиеКорректировки.Колонки.Добавить("ДокументДата");
	ОснованиеКорректировки.Колонки.Добавить("ДокументДопСведения");
	
	Если ЗначениеЗаполнено(ДанныеШапки.Основание)
		И ЗначениеЗаполнено(ДанныеШапки.ОснованиеДата) Тогда
		НоваяСтрока = ОснованиеКорректировки.Добавить();
		Если СтрНайти(ДанныеШапки.Основание, "№") Тогда
			СтрокаНаименование = Лев(ДанныеШапки.Основание, СтрНайти(ДанныеШапки.Основание, "№") - 2);
			Если ПустаяСтрока(СтрокаНаименование) Тогда
				СтрокаНаименование = "Договор";
			КонецЕсли;
		Иначе
			СтрокаНаименование = ДанныеШапки.Основание;
		КонецЕсли;
		НоваяСтрока.ДокументНаименование = СтрокаНаименование;
		НоваяСтрока.ДокументНомер = ДанныеШапки.ОснованиеНомер;
		НоваяСтрока.ДокументДата = ДанныеШапки.ОснованиеДата;
		
		ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(НоваяСтрока, "ДокументДата",,,
			НСтр("ru = 'Необходимо указать дату договора.'"));
		
		Если ЗначениеЗаполнено(СтрокаНаименование) Тогда
			ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ОснованиеКорректировки, "ОснованиеКорректировки");
		КонецЕсли;
	КонецЕсли;
	
	ТекстОшибки = НСтр("ru = 'Не удалось заполнить код валюты документа. Проверьте, что:
	|	- в документе указана валюта,
	|	- для нее заполнен код по Общероссийскому классификатору валют.'");
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод", "643", ТекстОшибки);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ДополнительныеСведенияОбУчастниках.ВалютаНаименование", "Российский рубль");
	
	Если СчетФактура <> Неопределено Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ТолькоУслуги", ДанныеШапки.ТолькоУслуги);
	Иначе
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ТолькоУслуги", Ложь);
	КонецЕсли;
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаНаправленияНаСогласование", ДанныеШапки.Дата);
	
	СведенияОПоставщике = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(ДанныеШапки.Организация, , ДанныеШапки.Дата);
	Если ЗначениеЗаполнено(ДанныеШапки.КПППоставщика) Тогда
		СведенияОПоставщике.КПП = ДанныеШапки.КПППоставщика;
	КонецЕсли;	
	ЗаполнитьДанныеУчастникаУПД(ДеревоДанных, СведенияОПоставщике, "СведенияОПродавце", "Юр", ДанныеШапки.Дата);
	// Заполняем структурное подразделение
	ЗаполнитьСтруктурноеПодразделение(ДеревоДанных, "СведенияОПродавце", ДанныеШапки.Ссылка.Подразделение);
	
	СоставительДокументаНаименование = СведенияОПоставщике.ПолноеНаименование
		+ ?(ЗначениеЗаполнено(СведенияОПоставщике.КПП),
			СтрШаблон(НСтр("ru = ', ИНН/КПП %1/%2'"), СведенияОПоставщике.ИНН, СведенияОПоставщике.КПП),
			СтрШаблон(НСтр("ru = ', ИНН %1'"), СведенияОПоставщике.ИНН));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"СоставительДокументаНаименование", СоставительДокументаНаименование);
	
	СведенияОПокупателе = ЭлектронноеВзаимодействиеУТ.ПолучитьДанныеЮрФизЛица(ДанныеШапки.Контрагент, , ДанныеШапки.Дата);
	Если ЗначениеЗаполнено(ДанныеШапки.КПППокупателя) Тогда
		СведенияОПокупателе.КПП = ДанныеШапки.КПППокупателя;
	КонецЕсли;
	ЗаполнитьДанныеУчастникаУПД(ДеревоДанных, СведенияОПокупателе, "СведенияОПокупателе", "Юр", ДанныеШапки.Дата);
		
	ТаблицаТоваров = Новый ТаблицаЗначений;
	ТаблицаТоваров.Колонки.Добавить("ТоварНаименование");
	ТаблицаТоваров.Колонки.Добавить("ЕдиницаИзмеренияКодДоКорректировки");
	ТаблицаТоваров.Колонки.Добавить("ЕдиницаИзмеренияКод");
	ТаблицаТоваров.Колонки.Добавить("КоличествоДоКорректировки", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(26,11)));
	ТаблицаТоваров.Колонки.Добавить("Количество", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(26,11)));
	ТаблицаТоваров.Колонки.Добавить("ЦенаЗаЕдиницуИзмеренияДоКорректировки", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(26,11)));
	ТаблицаТоваров.Колонки.Добавить("ЦенаЗаЕдиницуИзмерения", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(26,11)));
	ТаблицаТоваров.Колонки.Добавить("СтоимостьТоваровБезНалогаДоКорректировки", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СтоимостьТоваровБезНалога", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СтоимостьТоваровБезНалогаУвеличение", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СтоимостьТоваровБезНалогаУменьшение", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("НалоговаяСтавкаДоКорректировки");
	ТаблицаТоваров.Колонки.Добавить("НалоговаяСтавка");
	ТаблицаТоваров.Колонки.Добавить("СуммаНалогаДоКорректировки", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СуммаНалога", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СуммаНалогаУвеличение", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СуммаНалогаУменьшение", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СуммаАкцизаДоКорректировки", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СуммаАкциза", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СуммаАкцизаУвеличение", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СуммаАкцизаУменьшение", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СтоимостьТоваровСНалогомДоКорректировки", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СтоимостьТоваровСНалогом", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СтоимостьТоваровСНалогомУвеличение", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("СтоимостьТоваровСНалогомУменьшение", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(19,2)));
	ТаблицаТоваров.Колонки.Добавить("ТоварИдентификатор", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(255)));
	ТаблицаТоваров.Колонки.Добавить("Сопоставление");
	
	// ГосИС УКД
	ТаблицаТоваров.Колонки.Добавить("СведенияОМаркировкеДо");
	ТаблицаТоваров.Колонки.Добавить("СведенияОМаркировкеПосле");
	
	ВыборкаПоДокументам = СтруктураДанных.РезультатПоТабличнойЧасти.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	ВыборкаПоДокументам.Следующий();
	СтрокаТовары = ВыборкаПоДокументам.Выбрать();
	
	ИспользоватьНаборы = Ложь;
	Если ОбщегоНазначенияУТКлиентСервер.ЕстьРеквизитОбъекта(ВыборкаПоДокументам, "ЭтоНабор") Тогда
		ИспользоватьНаборы = Истина;
	КонецЕсли;

	ШтрихкодыКомбинаций = Неопределено;
	ШтрихкодыНоменклатуры = Неопределено;
	НоменклатураПартнеровСервер.ШтрихкодыПоТоварам(СтрокаТовары, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры);	

	ВыборкаДляСопоставления = НоменклатураПартнеровСервер.ВыборкаДляСопоставленияНоменклатуры(ДокументИсправления);
	СоответствиеСтавокНДСКонтрагента = Новый Соответствие;
	ЗаполнитьСоответствиеСтавокНДС(СоответствиеСтавокНДСКонтрагента);	
	ТаблицаСопоставления = ВыборкаДляСопоставления.Выгрузить();
	
	// ГосИС УКД только cis, cis_до, sscc, sscc_до
	ТаблицаКодовМаркировкиДо = Неопределено;
	СтруктураДанных.Свойство("МаркировкаДо", ТаблицаКодовМаркировкиДо);
	ТаблицаКодовМаркировкиПосле = Неопределено;
	СтруктураДанных.Свойство("Маркировка", ТаблицаКодовМаркировкиПосле);

	ВыводитьСерии = Константы.ВыводитьСерииВПечатныхФормах.Получить() 
					И СтруктураДанных.РезультатПоТабличнойЧасти.Колонки.Найти("СерияНаименование") <> Неопределено;
	
	Пока СтрокаТовары.Следующий() Цикл
		
		НовСтрока = ТаблицаТоваров.Добавить();
		ЗаполнитьЗначенияСвойств(НовСтрока, СтрокаТовары);

		СерияНаименование = Неопределено;
		Если ВыводитьСерии Тогда
			СерияНаименование = СтрокаТовары.СерияНаименование;
		КонецЕсли;
		
		НовСтрока.ТоварНаименование  = НоменклатураКлиентСервер.ПредставлениеНоменклатурыДляПечати(
			СтрокаТовары.НоменклатураНаименование,
			СтрокаТовары.ХарактеристикаНаименование
			,
			СерияНаименование
			) + ?(СтрокаТовары.ЭтоВозвратнаяТара, НСтр("ru = ' (возвратная тара)'"), "");
			
		НовСтрока.ТоварИдентификатор 						= Строка(СтрокаТовары.Номенклатура.УникальныйИдентификатор());
		Если ЗначениеЗаполнено(СтрокаТовары.СтавкаНДС) Тогда
			НовСтрока.НалоговаяСтавкаДоКорректировки 		= СтрокаТовары.СтавкаНДС;
			НовСтрока.НалоговаяСтавка						= СтрокаТовары.СтавкаНДС;
		Иначе
			НовСтрока.НалоговаяСтавкаДоКорректировки 		= Справочники.СтавкиНДС.БезНДС;
			НовСтрока.НалоговаяСтавка						= Справочники.СтавкиНДС.БезНДС;
		КонецЕсли;
		
		Если НаборыСервер.ВыводитьТолькоЗаголовок(СтрокаТовары, ИспользоватьНаборы) Тогда
			НовСтрока.СтоимостьТоваровСНалогом  = 0;
			НовСтрока.СуммаНалога  = 0;
			НовСтрока.СтоимостьТоваровСНалогомДоКорректировки  = 0;
			НовСтрока.СуммаНалогаДоКорректировки  = 0;
			Продолжить;	
		КонецЕсли;
		
		НовСтрока.ЕдиницаИзмеренияКодДоКорректировки		= СокрЛП(СтрокаТовары.ЕдиницаИзмеренияКод);
		НовСтрока.ЕдиницаИзмеренияКод               		= СокрЛП(СтрокаТовары.ЕдиницаИзмеренияКод);
		НовСтрока.КоличествоДоКорректировки					= СтрокаТовары.КоличествоДо;
		НовСтрока.Количество                				= СтрокаТовары.Количество;
		НовСтрока.ЦенаЗаЕдиницуИзмеренияДоКорректировки 	= Окр(СтрокаТовары.ЦенаДо, 2);
		НовСтрока.ЦенаЗаЕдиницуИзмерения                	= Окр(СтрокаТовары.Цена, 2);
		НовСтрока.СтоимостьТоваровБезНалогаДоКорректировки 	= Окр(СтрокаТовары.СуммаБезНДСДо, 2);
		НовСтрока.СтоимостьТоваровБезНалога                	= Окр(СтрокаТовары.СуммаБезНДС, 2);
		НовСтрока.СтоимостьТоваровБезНалогаУвеличение      	= Окр(СтрокаТовары.РазницаБезНДСУвеличение, 2);
		НовСтрока.СтоимостьТоваровБезНалогаУменьшение      	= Окр(СтрокаТовары.РазницаБезНДСУменьшение, 2);
		НовСтрока.СуммаНалогаДоКорректировки 				= Окр(СтрокаТовары.СуммаНДСДо, 2);
		НовСтрока.СуммаНалога                				= Окр(СтрокаТовары.СуммаНДС, 2);
		НовСтрока.СуммаНалогаУвеличение      				= Окр(СтрокаТовары.РазницаНДСУвеличение, 2);
		НовСтрока.СуммаНалогаУменьшение      				= Окр(СтрокаТовары.РазницаНДСУменьшение, 2);
		НовСтрока.СтоимостьТоваровСНалогомДоКорректировки 	= Окр(СтрокаТовары.СуммаСНДСДо, 2);
		НовСтрока.СтоимостьТоваровСНалогом                	= Окр(СтрокаТовары.СуммаСНДС, 2);
		НовСтрока.СтоимостьТоваровСНалогомУвеличение      	= Окр(СтрокаТовары.РазницаСНДСУвеличение, 2);
		НовСтрока.СтоимостьТоваровСНалогомУменьшение      	= Окр(СтрокаТовары.РазницаСНДСУменьшение, 2);
	
		Если НДСИсчисляетсяНалоговымАгентом Тогда
			НовСтрока.НалоговаяСтавка                         = "НДС исчисляется налоговым агентом";
			НовСтрока.НалоговаяСтавкаДоКорректировки          = "НДС исчисляется налоговым агентом";
			НовСтрока.СуммаНалога                             = 0;
			НовСтрока.СуммаНалогаДоКорректировки              = 0;
			НовСтрока.СуммаНалогаУвеличение                   = 0;
			НовСтрока.СуммаНалогаУменьшение                   = 0;
			НовСтрока.СтоимостьТоваровСНалогом                = 0;
			НовСтрока.СтоимостьТоваровСНалогомДоКорректировки = 0;
			НовСтрока.СтоимостьТоваровСНалогомУвеличение      = 0;
			НовСтрока.СтоимостьТоваровСНалогомУменьшение      = 0;
		КонецЕсли;

		УпаковкаИзДокумента = Неопределено;
		Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(СтрокаТовары, "Упаковка") И ЗначениеЗаполнено(СтрокаТовары.Упаковка) Тогда
			УпаковкаИзДокумента = СтрокаТовары.Упаковка;
		Иначе
			УпаковкаИзДокумента = ЭлектронноеВзаимодействиеУТВызовСервера.ЕдиницаХраненияНоменклатуры(СтрокаТовары.Номенклатура)
		КонецЕсли;
		
		// Сопоставление.
		ПараметрыОтбора = Новый Структура;
		ПараметрыОтбора.Вставить("Номенклатура", СтрокаТовары.Номенклатура);
		Если СтрокаТовары.Характеристика <> Неопределено Тогда
			ПараметрыОтбора.Вставить("Характеристика", СтрокаТовары.Характеристика);
		Иначе
			ПараметрыОтбора.Вставить("Характеристика", Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());				
		КонецЕсли;
		ПараметрыОтбора.Вставить("Упаковка", УпаковкаИзДокумента);
		СтрокиИзНоменклатурыКонтрагентов = ТаблицаСопоставления.НайтиСтроки(ПараметрыОтбора);
		Если СтрокиИзНоменклатурыКонтрагентов.Количество() Тогда
			НайденнаяСтрока = СтрокиИзНоменклатурыКонтрагентов[0];
			НовСтрока.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(НайденнаяСтрока,,,,СоответствиеСтавокНДСКонтрагента);
	    Иначе
			НовСтрока.Сопоставление = ЗаполнитьСопоставлениеНоменклатуры(СтрокаТовары, ШтрихкодыКомбинаций, ШтрихкодыНоменклатуры, УпаковкаИзДокумента);
		КонецЕсли;
		
		// ГосИС УКД
		ЭлектронноеВзаимодействиеИСМП.ЗаполнитьСведенияОМаркировкеУКД(НовСтрока, СтрокаТовары, ТаблицаКодовМаркировкиДо, ТаблицаКодовМаркировкиПосле);
		
	КонецЦикла;
	
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
		"Количество",,, НСтр("ru = 'Не указано количество товара в табличной части'"));
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
		"ЕдиницаИзмеренияКодДоКорректировки",,, НСтр("ru = 'Не заполнено наименование единицы измерения в справочнике ""Упаковки и единицы измерения"".'"));
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
		"ЕдиницаИзмеренияКод",,, НСтр("ru = 'Не заполнен код единицы измерения в справочнике ""Упаковки и единицы измерения"".'"));
	
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ТаблицаТоваров, "СведенияОТоварах");
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровБезНалогаУвеличение", ТаблицаТоваров.Итог("СтоимостьТоваровБезНалогаУвеличение"));
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровСНалогомУвеличение", ТаблицаТоваров.Итог("СтоимостьТоваровСНалогомУвеличение"));
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ВсегоИзмененияСтоимости.ВсегоСуммаНалогаУвеличение", ТаблицаТоваров.Итог("СуммаНалогаУвеличение"));
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровБезНалогаУменьшение", ТаблицаТоваров.Итог("СтоимостьТоваровБезНалогаУменьшение"));
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровСНалогомУменьшение", ТаблицаТоваров.Итог("СтоимостьТоваровСНалогомУменьшение"));
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ВсегоИзмененияСтоимости.ВсегоСуммаНалогаУменьшение", ТаблицаТоваров.Итог("СуммаНалогаУменьшение"));
	
	Если ТипЗнч(ДанныеШапки.Контрагент) = Тип("СправочникСсылка.Организации") Тогда
		
		ИдентификаторСЧФ = Строка(ДанныеШапки.Ссылка.УникальныйИдентификатор());
		ДобавитьДопополнительныеДанныеВДерево(ДеревоДанных, "ИдентификаторСЧФ", ИдентификаторСЧФ, "ДопДанныеСчетаФактуры.ТекстоваяИнформация");
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьДанныеСчетаФактурыУКД(СтруктураДанных, СтруктураЭД, ДеревоДанных)
	
	УстановитьПривилегированныйРежим(Истина);
	
	ДанныеШапки = СтруктураДанных.РезультатПоШапке.Выбрать();
	ДанныеШапки.Следующий();
	
	СчетФактура = ДанныеШапки.Ссылка;	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "СсылкаКорректировочногоСчетаФактуры",	СчетФактура);	
	Если ДанныеШапки.ПредставлениеДокумента <> "счет-фактура комиссионера" Тогда
		Если ЗначениеЗаполнено(ДанныеШапки.ИдентификаторГосКонтракта) Тогда
			ЭтоГОЗ = Истина;
			Если СтруктураДанных.Свойство("ДанныеЭлектронногоАктирования") Тогда
				ЭтоГОЗ = Ложь;
				ДанныеЭлектронногоАктированияЕИС = СтруктураДанных.ДанныеЭлектронногоАктирования;
				Если ДанныеЭлектронногоАктированияЕИС.ДанныеГосконтракта.Количество() Тогда
					ДанныеКонтракта = ДанныеЭлектронногоАктированияЕИС.ДанныеГосконтракта[0];
					Если ЗначениеЗаполнено(ДанныеКонтракта) Тогда
						ТипНаправленияДеятельности = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДанныеКонтракта.Ссылка, "ТипНаправленияДеятельности");
						ЭтоГОЗ = (ТипНаправленияДеятельности = Перечисления.ТипыНаправленийДеятельности.КонтрактГОЗ);
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			Если ЭтоГОЗ Тогда 
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДополнительныеСведенияОбУчастниках.ИдентификаторГосКонтракта", ДанныеШапки.ИдентификаторГосКонтракта);
			КонецЕсли;	
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьДанныеДляДОПИнформацияПродавцаФНС_2019(Основание, Настройки, СтруктураЭД, ДеревоДанных, Отказ, КоличествоЗаписей) 
	
	УстановитьПривилегированныйРежим(Истина);
	
	ВсеВидыДокументов = ОбменСКонтрагентами.ТипыДокументов();
	ТипДокумента = Настройки.ТипДокумента;

	МассивОбъектов = Новый Массив;
	МассивОбъектов.Добавить(Основание);
	ПараметрыПечати = Новый Структура();
	ПараметрыПечати.Вставить("ЗаполнениеЭлектронногоДокумента");
	
	Если ТипДокумента = ВсеВидыДокументов.СведенияОРеализацииКомиссионером Тогда
		ПараметрыПечати.Вставить("ВыводитьТовары", Истина);
	ИначеЕсли ТипДокумента = ВсеВидыДокументов.СведенияОЗакупкеКомиссионером Тогда
		ПараметрыПечати.Вставить("ВыводитьТовары", Истина);
	КонецЕсли;
	
	Если ТипДокумента = ВсеВидыДокументов.АктВыполненныхРабот Тогда
		Если ТипЗнч(Основание) = Тип("ДокументСсылка.КорректировкаРеализации") Тогда
			СтруктураДанных = КорректировкаРеализацииЛокализация.ПолучитьДанныеДляПечатнойФормыУПД(ПараметрыПечати, МассивОбъектов);
		Иначе
			СтруктураДанных = АктВыполненныхРаботЛокализация.ПолучитьДанныеДляПечатнойФормыУПД(ПараметрыПечати, МассивОбъектов);
		КонецЕсли;
	Иначе
		ИмяОбъекта = Основание.Метаданные().Имя;
		МенеджерОбъекта = ОбщегоНазначенияУТ.ПолучитьМодульЛокализации(ИмяОбъекта);
		Если МенеджерОбъекта = Неопределено Тогда
			МенеджерОбъекта = Документы[ИмяОбъекта];
		КонецЕсли;
		Если ТипЗнч(Основание) = Тип("ДокументСсылка.ВозвратТоваровМеждуОрганизациями") Тогда
			ПараметрыПечати.Вставить("НеВыводитьОсновнойУПД", Истина);
		КонецЕсли;
		СтруктураДанных = МенеджерОбъекта.ПолучитьДанныеДляПечатнойФормыУПД(ПараметрыПечати, МассивОбъектов);
	КонецЕсли;
	
	ЗаполнитьДанныеПервичногоДокументаУПД_2019(СтруктураДанных, СтруктураЭД, ДеревоДанных, Настройки, Отказ, КоличествоЗаписей)

КонецПроцедуры

Процедура ЗаполнитьДанныеДляДИСИнформацияПродавцаФНС_2020(Основание, Настройки, СтруктураЭД, ДеревоДанных) 
	
	УстановитьПривилегированныйРежим(Истина);
	
	ВсеВидыДокументов = ОбменСКонтрагентами.ТипыДокументов();
	ТипДокумента = Настройки.ТипДокумента;

	МассивОбъектов = Новый Массив;
	МассивОбъектов.Добавить(Основание);
	ПараметрыПечати = Новый Структура();

	// Маркировка
	ПараметрыПечати.Вставить("ЗаполнитьДанныеШтрихкодовДляУКДДо", Истина);
	ПараметрыПечати.Вставить("ЗаполнениеЭлектронногоДокумента");
	
	Если ТипДокумента = ВсеВидыДокументов.СоглашениеОбИзмененииСтоимости Тогда
		СтруктураДанных = КорректировкаРеализацииЛокализация.ПолучитьДанныеДляПечатнойФормыУКД(ПараметрыПечати, МассивОбъектов);
	Иначе
		УстановитьПривилегированныйРежим(Истина);
		ИмяОбъекта = Основание.Метаданные().Имя;
		МенеджерОбъекта = ОбщегоНазначенияУТ.ПолучитьМодульЛокализации(ИмяОбъекта);
		Если МенеджерОбъекта = Неопределено Тогда
			МенеджерОбъекта = Документы[ИмяОбъекта];
		КонецЕсли;
		СтруктураДанных = МенеджерОбъекта.ПолучитьДанныеДляПечатнойФормыУКД(ПараметрыПечати, МассивОбъектов);
	КонецЕсли;
	
	ЗаполнитьДанныеПервичногоДокументаУКД_2020(СтруктураДанных, СтруктураЭД, ДеревоДанных, Настройки);		

КонецПроцедуры

Процедура НайтиСоздатьКорректировкуПоступленияУКД(ДеревоДанных, СсылкаНаВладельца, Записывать = Истина)
	
	УстановитьПривилегированныйРежим(Истина);
	
	ДанныеДляЗагрузки = ПодготовитьСтруктуруДляКорректировкиПоступленияУКД(ДеревоДанных);
	ЗаполнитьДокументКорректировкиПоступления(СсылкаНаВладельца, ДанныеДляЗагрузки, Записывать);
	
КонецПроцедуры

Процедура НайтиСоздатьКорректировочныйСчетФактуруУКД(ДеревоДанных, СсылкаНаВладельца, Записывать = Истина)
	
	УстановитьПривилегированныйРежим(Истина);
	
	НайтиДокументСчетФактураВыданныйМеждуОрганизациями(СсылкаНаВладельца, ДеревоДанных, Истина, "КСЧФДИС");
	
	ДанныеДляЗагрузки = ПодготовитьСтруктуруДляСчетаФактурыУКД(ДеревоДанных);
	ДанныеДляЗагрузки.Шапка.Вставить("Корректировочный", Истина);

	Если ДанныеДляЗагрузки.Шапка.Свойство("ДокументыОснования") Тогда
		Для Каждого ДокументОснование Из ДанныеДляЗагрузки.Шапка.ДокументыОснования Цикл
			Если ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.КорректировкаПриобретения") или
			  ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.КорректировкаРеализации") Тогда
				Корректировка = ДокументОснование.Ссылка;
				ДокументОснование = Корректировка.ДокументОснование;
			Иначе
				ДокументОснование = ДокументОснование.Ссылка;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	ТаблицаСчетаФактуры = УчетНДСУП.СчетаФактурыПолученныеПоДокументамОснованиям(ДокументОснование, Ложь);
	Если ТаблицаСчетаФактуры.Количество() = 0 Тогда
		СчетФактураОснование = Неопределено;
	Иначе
		СчетФактураОснование = ТаблицаСчетаФактуры[0].Ссылка;
	КонецЕсли;
	ДанныеДляЗагрузки.Шапка.Вставить("СчетФактураОснование", СчетФактураОснование);
	
	ЗаполнитьДокументСчетФактура(СсылкаНаВладельца, ДанныеДляЗагрузки, Записывать);
	
КонецПроцедуры

Процедура НайтиСоздатьПриобретениеТоваровУслугУПД(ДеревоДанных, СсылкаНаВладельца, Записывать = Истина, СпособОбработки = "")
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если ТипЗнч(СпособОбработки) = Тип("Строка") Тогда
		СпособОбработкиСтрокой = СпособОбработки;
	Иначе
		СпособОбработкиСтрокой = СпособОбработки.ПервичныйДокумент;
	КонецЕсли;
	
	Если СпособОбработкиСтрокой = "ПриобретениеУслугПрочихАктивов" Тогда
		ДанныеДляЗагрузки = ПодготовитьСтруктуруДляПоступленияУслугУПД(ДеревоДанных);		
		ЗаполнитьДокументПоступленияУслуг(СсылкаНаВладельца, ДанныеДляЗагрузки, Записывать);
	Иначе
		ДанныеДляЗагрузки = ПодготовитьСтруктуруДляПриобретенияТоваровУслугУПД(ДеревоДанных);
		Если СпособОбработкиСтрокой = "ВозвратТоваровОтКлиента" Тогда
			ЗаполнитьДокументВозвратаТоваровОтПокупателя(СсылкаНаВладельца, ДанныеДляЗагрузки, Записывать);		
		Иначе
			ЗаполнитьДокументПриобретенияТоваровУслуг(СсылкаНаВладельца, ДанныеДляЗагрузки, Записывать);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура НайтиСоздатьСчетФактуруУПД(ДеревоДанных, СсылкаНаВладельца, Записывать = Истина)
	
	УстановитьПривилегированныйРежим(Истина);
	
	ДанныеДляЗагрузки = ПодготовитьСтруктуруДляСчетаФактурыУПД(ДеревоДанных);
	ЗаполнитьДокументСчетФактура(СсылкаНаВладельца, ДанныеДляЗагрузки, Записывать);
	
КонецПроцедуры

Функция НайтиПоступлениеТоваровУслуг(Знач Организация, Знач НомерДокумента, Знач ДатаДокумента, ТипДокумента = "ДокументСсылка.ПриобретениеТоваровУслуг")
	
	Результат = Неопределено;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ДанныеПервичныхДокументов.Документ КАК Документ
	|ИЗ
	|	РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|ГДЕ
	|	ДанныеПервичныхДокументов.Организация = &Организация
	|	И ДанныеПервичныхДокументов.Номер = &НомерДокумента
	|	И НАЧАЛОПЕРИОДА(ДанныеПервичныхДокументов.Дата, ДЕНЬ) = &ДатаДокумента
	|	И ТИПЗНАЧЕНИЯ(ДанныеПервичныхДокументов.Документ) = &ТипДокумента
	|	И ДанныеПервичныхДокументов.Документ.Проведен";
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("НомерДокумента", НомерДокумента);
	Запрос.УстановитьПараметр("ДатаДокумента", НачалоДня(ДатаДокумента));
	Запрос.УстановитьПараметр("ТипДокумента", ТИП(ТипДокумента));
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Результат = Выборка.Документ;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Функция ПолучитьДанныеПоТоварам(ТоварыКаталога, Организация)

	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ТаблицаТоваров.Номенклатура КАК Номенклатура,
	|	ТаблицаТоваров.Характеристика КАК Характеристика
	|ПОМЕСТИТЬ ВТ_Товары
	|ИЗ
	|	&ТаблицаТоваров КАК ТаблицаТоваров
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Товары.Номенклатура.Артикул КАК Артикул,
	|	ВЫБОР
	|		КОГДА ВТ_Товары.Номенклатура.НаименованиеПолное = """"
	|			ТОГДА ВТ_Товары.Номенклатура.Наименование
	|		ИНАЧЕ ВТ_Товары.Номенклатура.НаименованиеПолное
	|	КОНЕЦ КАК Наименование,
	|	ВТ_Товары.Номенклатура КАК Номенклатура,
	|	ЕСТЬNULL(ЕдиницыИзмерения.Код, """") КАК БазоваяЕдиницаКод,
	|	ЕСТЬNULL(ЕдиницыИзмерения.Наименование, """") КАК БазоваяЕдиницаНаименование,
	|	ЕСТЬNULL(ЕдиницыИзмерения.НаименованиеПолное, """") КАК БазоваяЕдиницаНаименованиеПолное,
	|	ЕСТЬNULL(ЕдиницыИзмерения.МеждународноеСокращение, """") КАК БазоваяЕдиницаМеждународноеСокращение,
	|	1 КАК ЕдиницаХраненияОстатковКоэффициент,
	|	ВТ_Товары.Номенклатура.ЕдиницаИзмерения КАК Упаковка,
	|	ЕСТЬNULL(ВТ_Товары.Характеристика.Наименование, """") КАК ХарактеристикаНаименование,
	|	ВТ_Товары.Характеристика КАК Характеристика,
	|	ВТ_Товары.Номенклатура.Марка.Наименование КАК ТорговаяМарка,
	|	ЕСТЬNULL(СтавкиНДСНоменклатуры.СтавкаНДС, ЕСТЬNULL(ОсновныеСтавкиНДС.СтавкаНДС,
	|		ЗНАЧЕНИЕ(Справочник.СтавкиНДС.ПустаяСсылка))) КАК СтавкаНДС
	|ИЗ
	|	ВТ_Товары КАК ВТ_Товары
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.УпаковкиЕдиницыИзмерения КАК ЕдиницыИзмерения
	|		ПО ВТ_Товары.Номенклатура.ЕдиницаИзмерения = ЕдиницыИзмерения.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СтавкиНДСНоменклатуры.СрезПоследних(&Период,
	|			Страна = &СтранаРегистрации ИЛИ Страна = ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка)) КАК СтавкиНДСНоменклатуры
	|		ПО ВТ_Товары.Номенклатура = СтавкиНДСНоменклатуры.Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОсновныеСтавкиНДС.СрезПоследних(&Период, Страна = &СтранаРегистрации) КАК ОсновныеСтавкиНДС
	|		ПО (ИСТИНА)
	|
	|";
	
	Запрос.УстановитьПараметр("ТаблицаТоваров", ТоварыКаталога);
	Запрос.УстановитьПараметр("Период", ТекущаяДатаСеанса());
	Запрос.УстановитьПараметр("СтранаРегистрации", ЗначениеНастроекКлиентСерверПовтИсп.СтранаРегистрацииОрганизации(Организация));
	
	МассивРезультатов = Запрос.ВыполнитьПакет();
	
	Возврат МассивРезультатов[1].Выгрузить();
	
КонецФункции

Функция СоздатьНовогоКонтрагента(СтрокаДляЗагрузки, ДеревоРазбора, СсылкаНаВладельца)
	
	КонтрагентСсылка = Неопределено;
	Партнер   = Неопределено;
	БанковскийСчет = Неопределено;
	
	ИНН = ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "ИНН", Истина, ДеревоРазбора);
	КПП = ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "КПП", Истина, ДеревоРазбора);
	ЮрФизЛицо = ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "ЮрФизЛицо", Истина, ДеревоРазбора);	
	ЮрАдресСтруктурой = ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "АдресРегистрации", Истина, ДеревоРазбора);
	
	ОфициальноеНаименование = ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "ОфициальноеНаименование", Истина, ДеревоРазбора);
	
	Если ПустаяСтрока(ОфициальноеНаименование) Тогда
		ОфициальноеНаименование = ПолучитьЗначениеРеквизитаДерева(СтрокаДляЗагрузки, "ПолноеНаименование", Истина, ДеревоРазбора);
	КонецЕсли;
	
	НачатьТранзакцию();
	
	Если СсылкаНаВладельца = Неопределено Тогда
		Контрагент = Справочники.Контрагенты.СоздатьЭлемент();
	Иначе
		Попытка
			Блокировка = Новый БлокировкаДанных;
			ЭлементБлокировки = Блокировка.Добавить("Справочник.Контрагенты");
			ЭлементБлокировки.УстановитьЗначение("Ссылка", СсылкаНаВладельца);
			Блокировка.Заблокировать();
			
			Контрагент = СсылкаНаВладельца.ПолучитьОбъект();
		Исключение
			ТекстИсключенияЗаписи = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Не удалось изменить контрагента ""%1"".
			|Возможно, контрагент редактируется другим пользователем'"),
			Контрагент.Наименование);			
			ВызватьИсключение ТекстИсключенияЗаписи;
		КонецПопытки;	
			
	КонецЕсли;
		
	Контрагент.Наименование = ОфициальноеНаименование;
	Контрагент.НаименованиеПолное = ОфициальноеНаименование;
	Контрагент.ИНН = ИНН;
	Контрагент.КПП = КПП;	
	Контрагент.ЮридическоеФизическоеЛицо = ?(ЮрФизЛицо = Неопределено, Перечисления.ЮридическоеФизическоеЛицо.ЮридическоеЛицо, ЮрФизЛицо.ЗначениеРеквизита);
	
	// Контактная информация
	Если ЮрАдресСтруктурой <> Неопределено Тогда
		
		УправлениеКонтактнойИнформацией.ДобавитьКонтактнуюИнформацию(Контрагент, ЮрАдресСтруктурой.ЗначениеРеквизита,
			Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента);
		
		УправлениеКонтактнойИнформацией.ДобавитьКонтактнуюИнформацию(Контрагент, ЮрАдресСтруктурой.ЗначениеРеквизита,
			Справочники.ВидыКонтактнойИнформации.ФактАдресКонтрагента);
			
	КонецЕсли;
	
	КонтрагентСсылка = Контрагент.Ссылка;
	
	Отбор = Новый Структура("Реквизит", "СтрокаТЧРасчетныйСчет");
	МассивСчетов = СтрокаДляЗагрузки.Строки.НайтиСтроки(Отбор);
	
	Для Каждого ЭлементМассива Из МассивСчетов Цикл
		
		НомерСчета = ПолучитьЗначениеРеквизитаДерева(ЭлементМассива, "НомерСчета", Истина, ДеревоРазбора);
		Если Не ЗначениеЗаполнено(НомерСчета) Тогда
			Продолжить;
		КонецЕсли;
		
		БанковскийСчет = Неопределено;
		БанковскийСчет = НайтиСсылкуНаОбъектПоРеквизиту("БанковскиеСчета", "НомерСчета",
			НомерСчета, КонтрагентСсылка);
		
		Если БанковскийСчет = Неопределено Тогда
			БанковскийСчет = Справочники.БанковскиеСчетаКонтрагентов.СоздатьЭлемент();
			БанковскийСчет.Владелец = КонтрагентСсылка;
			БанковскийСчет.НомерСчета = НомерСчета;
		Иначе
			БанковскийСчет = БанковскийСчет.ПолучитьОбъект();
			БанковскийСчет.Владелец = КонтрагентСсылка;
		КонецЕсли;
		НаименованиеСчета = ПолучитьЗначениеРеквизитаДерева(ЭлементМассива, "Комментарий", Истина, ДеревоРазбора);
		Если ЗначениеЗаполнено(НаименованиеСчета) Тогда
			БанковскийСчет.Наименование = НаименованиеСчета;
		Иначе
			БанковскийСчет.Наименование = НомерСчета;
		КонецЕсли;
		
		БанкБИК = ПолучитьЗначениеРеквизитаДерева(ЭлементМассива, "БанкБИК", Истина, ДеревоРазбора);
		Если ЗначениеЗаполнено(БанкБИК) Тогда
			
			Банк = Справочники.КлассификаторБанков.НайтиПоКоду(БанкБИК);
			
			Если Не ЗначениеЗаполнено(Банк) Тогда
				Банк = Справочники.КлассификаторБанков.СоздатьЭлемент();
				Банк.Наименование =  ПолучитьЗначениеРеквизитаДерева(ЭлементМассива, "БанкНаименование", Истина, ДеревоРазбора);
				Банк.Код = БанкБИК;
			Иначе
				Банк = Банк.ПолучитьОбъект();
			КонецЕсли;
			
			Банк.КоррСчет = ПолучитьЗначениеРеквизитаДерева(ЭлементМассива, "БанкСчетКорр", Истина, ДеревоРазбора);
			Банк.Записать();
			
			БанковскийСчет.Банк = Банк.Ссылка;
		КонецЕсли;
		
	КонецЦикла;
	
	Если ПолучитьФункциональнуюОпцию("ИспользоватьПартнеровИКонтрагентов") Тогда
		// Заполним реквизиты партнера
		
		Если Контрагент.ЭтоНовый() Тогда
			Партнер = Справочники.Партнеры.СоздатьЭлемент();
			СсылкаНовогоПартнера = Справочники.Партнеры.ПолучитьСсылку();
			Партнер.УстановитьСсылкуНового(СсылкаНовогоПартнера);
			Контрагент.Партнер = СсылкаНовогоПартнера;
		Иначе
			Партнер = Контрагент.Партнер.ПолучитьОбъект();
			Попытка 
				Партнер.Заблокировать();
			Исключение
				ТекстИсключенияЗаписи = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось изменить партнера ""%1"".
				|Возможно, партнер редактируется другим пользователем'"),
				Партнер.Наименование);			
				ВызватьИсключение ТекстИсключенияЗаписи;
			КонецПопытки;			
		КонецЕсли;
		
		Партнер.Наименование = Контрагент.Наименование;
		
	КонецЕсли;
	
	Попытка
		Контрагент.Записать();
		Контрагент.Разблокировать();
		Если Партнер <> Неопределено Тогда
			Партнер.Записать();
			Партнер.Разблокировать();			
		КонецЕсли;
		Если БанковскийСчет <> Неопределено Тогда		
			БанковскийСчет.Записать();
		    БанковскийСчет.Разблокировать();
		КонецЕсли;		
		КонтрагентСсылка = Контрагент.Ссылка;		
		ЗафиксироватьТранзакцию();
	Исключение
		ОтменитьТранзакцию();
		ТекстОшибки = НСтр("ru = 'Не удалось загрузить контрагента'");
		ЗаписьЖурналаРегистрации(
				ТекстОшибки,
				УровеньЖурналаРегистрации.Ошибка,,,
				ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
	КонецПопытки;
	
	Возврат КонтрагентСсылка;	
	
КонецФункции

Процедура ВнестиСведенияОВыбытииМаркированныхТоваровВДеревоУПДУКД(ДеревоДанных, ВариантВыбытияМаркируемойПродукции)

	СведенияОВыбытииМаркированныхТоваров = "";
	Если ВариантВыбытияМаркируемойПродукции = Перечисления.ВариантыВыбытияМаркируемойПродукции.ИспользованиеПокупателемДляСобственныхНужд Тогда
		СведенияОВыбытииМаркированныхТоваров = "1";
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СведенияОВыбытииМаркированныхТоваров) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, 
			"СведенияОВыбытииМаркированныхТоваров", 	СведенияОВыбытииМаркированныхТоваров);
	КонецЕсли;
	
КонецПроцедуры

// Возвращает имя прикладного справочника по имени справочника библиотеки электронных документов.
//
// Параметры:
//  ИмяСправочника - строка - название справочника из библиотеки БЭД.
//
// Возвращаемое значение:
//  Строка - строковое имя прикладного справочника.
//
Функция ИмяПрикладногоСправочника(ИмяСправочника) Экспорт
	
	СоответствиеСправочников = Новый Соответствие;
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьСоответствиеСправочников(СоответствиеСправочников);
	
	ИмяПрикладногоСправочника = СоответствиеСправочников.Получить(ИмяСправочника);
	
	Возврат ИмяПрикладногоСправочника;
	
КонецФункции

// Заполняет структуру, содержащую информацию об адресе участника ЭДО.
//
// Параметры:
//  СтруктураАдреса - структура - информация об адресе;
//   * Поля структуры для адреса РФ.
//    ** АдресРФ - Булево - признак, что адрес РФ;
//    ** Индекс - Строка - почтовый индекс организации;
//    ** Регион - Строка - код региона организации;
//    ** Район - Строка;
//    ** Город - Строка;
//    ** НаселенныйПункт - Строка - населенный пункт расположения организации;
//    ** Улица - Строка;
//    ** Дом - Строка;
//    ** Корпус - Строка;
//    ** Квартира - Строка;
//    ** Поля структуры для иностранного адреса или адреса РФ строкой.
//   * КодСтраны - Строка - код страны;
//    ** АдресТекст - Строка - представление адреса;
//  СтруктураПараметров - Структура - содержит ссылки на элементы справочника;
//  ВидКонтрагента - Строка - имя метаданных справочника;
//  ВидАдреса - Строка - "Факт" или "Юр";
//  ТекстОшибки - Строка - описание ошибки.
//
Процедура ПолучитьАдресСтруктурой(СтруктураАдреса, СтруктураПараметров, ВидКонтрагента = "Контрагент", ВидАдреса = "Юр", ТекстОшибки = "") Экспорт
	
	//++ НЕ ГОСИС
	Адрес = ПолучитьАдресИзКонтактнойИнформации(СтруктураПараметров[ВидКонтрагента], ВидАдреса, СтруктураПараметров.ДатаКИ);
	
	Параметр1 = СтруктураПараметров[ВидКонтрагента];
	Параметр2 = ?(ВидАдреса="Юр", НСтр("ru = 'юридический'"), НСтр("ru = 'фактический'"));
	
	Если НЕ ЗначениеЗаполнено(Адрес.Представление) Тогда
		
		Ошибка = НСтр("ru = 'Для %1 необходимо указать %2 адрес.'");
		ТекстОшибки = ТекстОшибки + Символы.ПС + Нстр("ru='" + СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(Ошибка, Параметр1, Параметр2) + "'"); 
		Возврат
		
	ИначеЕсли НЕ ЗначениеЗаполнено(Адрес.ЗначенияПолей) Тогда
		Ошибка =  НСтр("ru = 'Для %1 необходимо заполнить %2 адрес по классификатору.'");
		ТекстОшибки = ТекстОшибки + Символы.ПС + Нстр("ru='" + СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(Ошибка, Параметр1, Параметр2) + "'"); 
		Возврат
		
	КонецЕсли;
	
	СтруктураРезультата = Новый Структура("КодСтраны, Индекс, Регион, КодРегиона, Район, РайонСокращение, Город,
											|ГородСокращение, НаселенныйПункт, НаселенныйПунктСокращение, Улица,
											|УлицаСокращение, Здание, Корпуса, Помещения");
	ЗаполнитьЗначенияСвойств(СтруктураРезультата, РаботаСАдресами.СведенияОбАдресе(Адрес.ЗначенияПолей));
	
	РайонПредставление				= ПредставлениеАдресногоЭлемента(СтруктураРезультата.Район,
																	СтруктураРезультата.РайонСокращение);
	ГородПредставление				= ПредставлениеАдресногоЭлемента(СтруктураРезультата.Город,
																	СтруктураРезультата.ГородСокращение);
	НаселенныйПунктПредставление	= ПредставлениеАдресногоЭлемента(СтруктураРезультата.НаселенныйПункт,
																	СтруктураРезультата.НаселенныйПунктСокращение);
	УлицаПредставление				= ПредставлениеАдресногоЭлемента(СтруктураРезультата.Улица,
																	СтруктураРезультата.УлицаСокращение);
	ДомПредставление				= ПредставлениеАдресногоЭлемента(НРег(СтруктураРезультата.Здание.ТипЗдания),
																	"№",
																	СтруктураРезультата.Здание.Номер);
	
	КорпусПредставление = "";
	
	Если СтруктураРезультата.Корпуса.Количество() > 0 Тогда
		КорпусПредставление = ПредставлениеАдресногоЭлемента(НРег(СтруктураРезультата.Корпуса[0].ТипКорпуса),
															СтруктураРезультата.Корпуса[0].Номер);
	КонецЕсли;
	
	ПомещениеПредставление = "";
	
	Если СтруктураРезультата.Помещения.Количество() > 0 Тогда
		ПомещениеПредставление = ПредставлениеАдресногоЭлемента(НРег(СтруктураРезультата.Помещения[0].ТипПомещения),
																СтруктураРезультата.Помещения[0].Номер);
	КонецЕсли;
	
	АдресРФ = Ложь;
	
	Если ЗначениеЗаполнено(СтруктураРезультата.КодСтраны) Тогда
		СтруктураАдреса.Вставить("ПроизвольныйАдрес", Ложь);
	Иначе
		СтруктураАдреса.Вставить("ПроизвольныйАдрес", Истина);
	КонецЕсли;
	СтруктураАдреса.Вставить("АдресРФ",			АдресРФ);
	СтруктураАдреса.Вставить("Индекс",			СтруктураРезультата.Индекс);
	СтруктураАдреса.Вставить("КодРегион",		СтруктураРезультата.КодРегиона);
	СтруктураАдреса.Вставить("КодРегиона",		СтруктураРезультата.КодРегиона);
	СтруктураАдреса.Вставить("Район",			РайонПредставление);
	СтруктураАдреса.Вставить("Город",			ГородПредставление);
	СтруктураАдреса.Вставить("НаселПункт",		НаселенныйПунктПредставление);
	СтруктураАдреса.Вставить("НаселенныйПункт",	НаселенныйПунктПредставление);
	СтруктураАдреса.Вставить("Улица",			УлицаПредставление);
	СтруктураАдреса.Вставить("Дом",				ДомПредставление);
	СтруктураАдреса.Вставить("Корпус",			КорпусПредставление);
	СтруктураАдреса.Вставить("Кварт",			ПомещениеПредставление);
	СтруктураАдреса.Вставить("Квартира",		ПомещениеПредставление);
	Если Не АдресРФ Тогда
		СтруктураАдреса.Вставить("КодСтр",		СтруктураРезультата.КодСтраны);
		СтруктураАдреса.Вставить("КодСтраны",	СтруктураРезультата.КодСтраны);
		СтруктураАдреса.Вставить("АдрТекст",	Адрес.Представление);
		СтруктураАдреса.Вставить("АдресТекст",	Адрес.Представление);
	КонецЕсли;
	СтруктураАдреса.Вставить("КодГАР",	"");
	//-- НЕ ГОСИС
	
КонецПроцедуры

Функция ПредставлениеАдресногоЭлемента(ПервыйЭлемент = "", ВторойЭлемент = "", ТретийЭлемент = "")

	МассивСоставляющих = Новый Массив;
	Если ЗначениеЗаполнено(ПервыйЭлемент) Тогда
		МассивСоставляющих.Добавить(ПервыйЭлемент);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ВторойЭлемент) Тогда
		МассивСоставляющих.Добавить(ВторойЭлемент);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ТретийЭлемент) Тогда
		МассивСоставляющих.Добавить(ТретийЭлемент);
	КонецЕсли;
	
	Возврат СтрСоединить(МассивСоставляющих, " ");

КонецФункции

// Определяет имя дополнительной колонки, которая выводится в печатных формах электронных документов Счет на оплату,
// Заказ клиента, Заказ поставщику, Отчет о списании комиссионного товара, Отчет о продажах комиссионного товара.
// В качестве дополнительной колонки могут выступать "Код", "Артикул".
//
// Параметры:
//  Результат - Строка - доступные значения: "Код", "Артикул".
//
Процедура ИмяДополнительнойКолонки(Результат) Экспорт
	
	//++ НЕ ГОСИС
	Результат = ФормированиеПечатныхФорм.ДополнительнаяКолонкаПечатныхФормДокументов().ИмяКолонки;
	//-- НЕ ГОСИС
	
КонецПроцедуры

// Подготавливает данные для обработки ошибок заполнения обязательных полей.
//
// Параметры:
//  ТаблицаТоваров   - ТаблицаЗначений - сведения о товарах для формирования электронного документа.
//  СсылкаНаДокумент - ДокументСсылка - Ссылка на основание электронного документа.
//
Процедура ЗаполнитьПараметрыОбработкиОшибокВТаблицеТоваровCML(ТаблицаТоваров, СсылкаНаДокумент = Неопределено) Экспорт

	// Обработка ошибки через механизм сообщений пользователю.
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
		"Артикул", "Номенклатура", "Объект.Артикул");
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
		"Наименование", "Номенклатура", "Объект.Наименование");
	
	Если ЗначениеЗаполнено(СсылкаНаДокумент) Тогда		
		Если ТаблицаТоваров.Колонки.Найти("Количество") <> Неопределено Тогда
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
				"Количество", СсылкаНаДокумент, "Объект.Товары.Количество",, "НомерСтроки");
		КонецЕсли;
		
		Если ТаблицаТоваров.Колонки.Найти("Цена") <> Неопределено Тогда
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
				"Цена", СсылкаНаДокумент, "Объект.Товары.Количество",, "НомерСтроки");
		КонецЕсли;
		
		Если ТаблицаТоваров.Колонки.Найти("Сумма") <> Неопределено Тогда
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
				"Сумма", СсылкаНаДокумент, "Объект.Товары.Сумма",, "НомерСтроки");
		КонецЕсли;
		
		Если ТаблицаТоваров.Колонки.Найти("СуммаСкидки") <> Неопределено Тогда
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
				"СуммаСкидки", СсылкаНаДокумент, "Объект.Товары.Сумма",, "НомерСтроки");
		КонецЕсли;
		
		Если ТаблицаТоваров.Колонки.Найти("СуммаСкидки") <> Неопределено Тогда
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
				"СуммаСкидки", СсылкаНаДокумент, "Объект.Товары.Сумма",, "НомерСтроки");
		КонецЕсли;
	КонецЕсли;
	
	Если ТаблицаТоваров.Колонки.Найти("ЕдиницаИзмеренияКодПоОКЕИ") <> Неопределено Тогда
		ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
			"ЕдиницаИзмеренияКодПоОКЕИ", "ЕдиницаИзмерения", "Объект.Код");
		
		// Если единица пустая, надо ссылаться на незаполненность самой единицы, а не ее полей.
		СтрокиСПустойЕдиницей = ТаблицаТоваров.НайтиСтроки(Новый Структура("ЕдиницаИзмерения", Справочники.УпаковкиЕдиницыИзмерения.ПустаяСсылка()));
		Если СтрокиСПустойЕдиницей.Количество() Тогда
			Если СсылкаНаДокумент <> Неопределено Тогда
				// Для документов берем единицу прямо из документа.
				ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокиСПустойЕдиницей,
					"ЕдиницаИзмеренияКодПоОКЕИ", СсылкаНаДокумент, "Объект.Товары.ЕдиницаИзмерения",, "НомерСтроки");
			Иначе
				// Иначе ссылаемся на незаполненность единицы в самой номенклатуре.
				ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокиСПустойЕдиницей,
					"ЕдиницаИзмеренияКодПоОКЕИ", "Номенклатура", "Объект.ЕдиницаИзмерения");
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
		"БазоваяЕдиницаКод", "Упаковка", "Объект.Код");
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
		"БазоваяЕдиницаМеждународноеСокращение", "Упаковка", "Объект.МеждународноеСокращение");
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
		"БазоваяЕдиницаНаименование", "Упаковка", "Объект.Наименование");
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
		"БазоваяЕдиницаНаименованиеПолное", "Упаковка", "Объект.НаименованиеПолное");
	
	// Если единица пустая, надо ссылаться на незаполненность самой единицы, а не ее полей.
	СтрокиСПустойЕдиницей = ТаблицаТоваров.НайтиСтроки(Новый Структура("Упаковка", Справочники.УпаковкиЕдиницыИзмерения.ПустаяСсылка()));
	Если СтрокиСПустойЕдиницей.Количество() Тогда
		Если СсылкаНаДокумент <> Неопределено Тогда
			// Для документов берем единицу прямо из документа.
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокиСПустойЕдиницей,
				"БазоваяЕдиницаКод", СсылкаНаДокумент, "Объект.Товары.ЕдиницаИзмерения",, "НомерСтроки");
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокиСПустойЕдиницей,
				"БазоваяЕдиницаМеждународноеСокращение", СсылкаНаДокумент, "Объект.Товары.ЕдиницаИзмерения",, "НомерСтроки");
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокиСПустойЕдиницей,
				"БазоваяЕдиницаНаименование", СсылкаНаДокумент, "Объект.Товары.ЕдиницаИзмерения",, "НомерСтроки");
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокиСПустойЕдиницей,
				"БазоваяЕдиницаНаименованиеПолное", СсылкаНаДокумент, "Объект.Товары.ЕдиницаИзмерения",, "НомерСтроки");
		Иначе
			// Это каталог товаров - для него единица берется из номенклатуры.
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокиСПустойЕдиницей,
				"БазоваяЕдиницаКод", "Номенклатура", "Объект.ЕдиницаИзмерения");
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокиСПустойЕдиницей,
				"БазоваяЕдиницаМеждународноеСокращение", "Номенклатура", "Объект.ЕдиницаИзмерения");
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокиСПустойЕдиницей,
				"БазоваяЕдиницаНаименование", "Номенклатура", "Объект.ЕдиницаИзмерения");
			ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокиСПустойЕдиницей,
				"БазоваяЕдиницаНаименованиеПолное", "Номенклатура", "Объект.ЕдиницаИзмерения");
		КонецЕсли;
	КонецЕсли;
	
	Если ТаблицаТоваров.Колонки.Найти("ВалютаЦены") <> Неопределено Тогда
		ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(ТаблицаТоваров,
			"ВалютаЦены", "Валюта", "Объект.Код");
		
		// Если валюта пустая, надо ссылаться на незаполненность самой валюты, а не ее полей.
		СтрокиСПустойВалютой = ТаблицаТоваров.НайтиСтроки(Новый Структура("Валюта", Справочники.Валюты.ПустаяСсылка()));
		Если СтрокиСПустойВалютой.Количество() И СсылкаНаДокумент <> Неопределено Тогда
			Если СсылкаНаДокумент <> Неопределено Тогда
				// Для документов берем валюту прямо из документа.
				ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(СтрокиСПустойВалютой,
					"ВалютаЦены", СсылкаНаДокумент, "Объект.Валюта");
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры

#Область ОбновлениеИнформационнойБазы

// Регистрирует данные для обработчика обновления
// 
// Параметры:
//  Параметры - Структура - параметры.
//
Процедура ЗарегистрироватьДанныеКОбработкеДляПереходаНаНовуюВерсию(Параметры) Экспорт
	
	// Регистрация не требуется
	Возврат;
	
КонецПроцедуры

// Обработчик обновления.
// 
// Параметры:
//  Параметры - Структура - параметры.
//
Процедура ОбработатьДанныеДляПереходаНаНовуюВерсию(Параметры) Экспорт
	
	Если НЕ Константы.ИспользоватьОбменЭД.Получить() Тогда
		Если НЕ Константы.ИспользоватьЭлектронныеПодписи.Получить() Тогда
			МенеджерЗначенияИспользоватьЭП = Константы.ИспользоватьЭлектронныеПодписи.СоздатьМенеджерЗначения();
			МенеджерЗначенияИспользоватьЭП.Значение = Истина;
			ОбновлениеИнформационнойБазы.ЗаписатьДанные(МенеджерЗначенияИспользоватьЭП);			
		КонецЕсли;
		МенеджерЗначенияИспользоватьЭД = Константы.ИспользоватьОбменЭД.СоздатьМенеджерЗначения();
		МенеджерЗначенияИспользоватьЭД.Значение = Истина;
		ОбновлениеИнформационнойБазы.ЗаписатьДанные(МенеджерЗначенияИспользоватьЭД);
	КонецЕсли;
	
	Параметры.ОбработкаЗавершена = Истина;
	
КонецПроцедуры

// см. ОбновлениеИнформационнойБазыБСП.ПриДобавленииОбработчиковОбновления
Процедура ПриДобавленииОбработчиковОбновления(Обработчики) Экспорт

#Область ОбработатьДанныеДляПереходаНаНовуюВерсию

	Обработчик = Обработчики.Добавить();
	Обработчик.Процедура = "ОбменСКонтрагентамиУТ.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	Обработчик.Версия = "2.5.3.45";
	Обработчик.РежимВыполнения = "Отложенно";
	Обработчик.Идентификатор = Новый УникальныйИдентификатор("e066b75c-d71d-48d9-9948-4141f6d17783");
	Обработчик.ПроцедураЗаполненияДанныхОбновления = "ОбменСКонтрагентамиУТ.ЗарегистрироватьДанныеКОбработкеДляПереходаНаНовуюВерсию";
	Обработчик.ПроцедураПроверки = "ОбновлениеИнформационнойБазы.ДанныеОбновленыНаНовуюВерсиюПрограммы";
	Обработчик.Комментарий = НСтр("ru = 'Устанавливает константу ""Использовать обмен электронными документами"".'");
	
	Читаемые = Новый Массив;
	Читаемые.Добавить(Метаданные.Константы.ИспользоватьОбменЭД.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Константы.ИспользоватьЭлектронныеПодписи.ПолноеИмя());
	Обработчик.ЧитаемыеОбъекты = СтрСоединить(Читаемые, ",");
	
	Изменяемые = Новый Массив;
	Изменяемые.Добавить(Метаданные.Константы.ИспользоватьОбменЭД.ПолноеИмя());
	Изменяемые.Добавить(Метаданные.Константы.ИспользоватьЭлектронныеПодписи.ПолноеИмя());
	Обработчик.ИзменяемыеОбъекты = СтрСоединить(Изменяемые, ",");
	
	Блокируемые = Новый Массив;
	Блокируемые.Добавить(Метаданные.Константы.ИспользоватьОбменЭД.ПолноеИмя());
	Блокируемые.Добавить(Метаданные.Константы.ИспользоватьЭлектронныеПодписи.ПолноеИмя());
	Обработчик.БлокируемыеОбъекты = СтрСоединить(Блокируемые, ",");	
	
	Обработчик.ПриоритетыВыполнения = ОбновлениеИнформационнойБазы.ПриоритетыВыполненияОбработчика();

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "НастройкиЭДОСлужебный.ВключитьУтверждениеВходящихДокументов";
	НоваяСтрока.Порядок = "До";

#КонецОбласти

КонецПроцедуры

#КонецОбласти

Функция ВыводитьКодыТНВЭД(СтранаРегистрации, ДатаПроверки)
	
	Выводить = Ложь;
	
	Выводить = УчетНДСРФ.СтранаЯвляетсяЧленомТаможенногоСоюза(СтранаРегистрации, ДатаПроверки)
		И ДатаПроверки >= УчетНДСУП.НастройкиУчета().ДатаРазделенияЭкспорта;
	
	Возврат Выводить;
	
КонецФункции

// Возвращает пустую таблицу сведений о таможенной декларации.
//
// Возвращаемое значение:
//	ТаблицаЗначений - сведений о таможенной декларации, со следующими колонками:
//		* СтранаПроисхожденияКод - Строка - код страны происхождения.
//		* ТаможеннаяДекларацияНомер - Строка - номер таможенной декларации.
//
Функция ПустаяТаблицаСведенияОТаможеннойДекларации()
	
	ОписаниеТипаСтранаПроисхожденияКод		= Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(3));
	ОписаниеТипаТаможеннаяДекларацияНомер	= Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(29));
	
	СведенияОТаможеннойДекларации = Новый ТаблицаЗначений;
	СведенияОТаможеннойДекларации.Колонки.Добавить("СтранаПроисхожденияКод", ОписаниеТипаСтранаПроисхожденияКод);
	СведенияОТаможеннойДекларации.Колонки.Добавить("ТаможеннаяДекларацияНомер", ОписаниеТипаТаможеннаяДекларацияНомер);
	
	Возврат СведенияОТаможеннойДекларации;
	
КонецФункции

Процедура ЗаполнитьСведенияОТаможеннойДекларации(ПриемникДанныхТовара, ИсточникДанныхТовара)
	
	Если Не ЗначениеЗаполнено(ИсточникДанныхТовара.НомерГТД) Тогда
		Возврат;
	КонецЕсли;
	
	СведенияОТаможеннойДекларации = ПустаяТаблицаСведенияОТаможеннойДекларации();
	
	СтрокаТД = СведенияОТаможеннойДекларации.Добавить();
	Если ИсточникДанныхТовара.ТипНомераГТД = Перечисления.ТипыНомеровГТД.НомерРНПТКомплекта Тогда
		СтрокаТД.ТаможеннаяДекларацияНомер = СокрЛП(Строка(ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ИсточникДанныхТовара.НомерГТДСсылка, "Код")));
	Иначе
		СтрокаТД.ТаможеннаяДекларацияНомер = СокрЛП(Строка(ИсточникДанныхТовара.НомерГТД));
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ИсточникДанныхТовара.СтранаПроисхожденияКод) Тогда
		СтрокаТД.СтранаПроисхожденияКод = ИсточникДанныхТовара.СтранаПроисхожденияКод;
	КонецЕсли;
	
	ПриемникДанныхТовара.СведенияОТаможеннойДекларации = СведенияОТаможеннойДекларации;
	
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(
		ПриемникДанныхТовара.СведенияОТаможеннойДекларации,
		"СтранаПроисхожденияКод",
		,
		,
		НСтр("ru = 'Не заполнен код страны происхождения'"));
	
КонецПроцедуры

// Возвращает пустую таблицу сведений о прослеживаемости УКД.
//
// Возвращаемое значение:
//	ТаблицаЗначений - сведений о таможенной декларации, со следующими колонками:
//		* НомерТовара - Строка - регистрационный номер товара.
//		* ЕдиницаИзмеренияКод - Строка - код единицы измерения прослеживаемости.
//		* ЕдиницаИзмеренияНаименование - Строка - наименование единицы измерения прослеживаемости.
//		* Количество - Число - количество прослеживаемых товаров.
//		* СуммаПоРНПТ - Число - стоимость прослеживаемого товара/комплекта.
//
Функция ПустаяТаблицаСведенияОПрослеживаемостиУПД()
	
	КоличествоПоРНПТОпианиеТипа = Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(26, 11));
	
	СведенияОПрослеживаемости = Новый ТаблицаЗначений;
	СведенияОПрослеживаемости.Колонки.Добавить("НомерТовара");
	СведенияОПрослеживаемости.Колонки.Добавить("ЕдиницаИзмеренияКод");
	СведенияОПрослеживаемости.Колонки.Добавить("ЕдиницаИзмеренияНаименование");
	СведенияОПрослеживаемости.Колонки.Добавить("Количество", КоличествоПоРНПТОпианиеТипа);
	СведенияОПрослеживаемости.Колонки.Добавить("КоличествоУчетное", КоличествоПоРНПТОпианиеТипа);
	СведенияОПрослеживаемости.Колонки.Добавить("СтоимостьБезНДС");
	
	Возврат СведенияОПрослеживаемости;
	
КонецФункции

Процедура ЗаполнитьСведенияОПрослеживаемостиУПД(ПриемникДанныхТовара, ИсточникДанныхТовара, ПрослеживаемыеКомплектующие)
	
	Если Не ЗначениеЗаполнено(ИсточникДанныхТовара.КоличествоПоРНПТ) Тогда
		Возврат;
	КонецЕсли;
	
	СведенияОПрослеживаемости = ПустаяТаблицаСведенияОПрослеживаемостиУПД();
	
	Если ИсточникДанныхТовара.ТипНомераГТД = Перечисления.ТипыНомеровГТД.НомерРНПТ Тогда
		НоваяСтрока = СведенияОПрослеживаемости.Добавить();
		НоваяСтрока.НомерТовара						= СокрЛП(Строка(ИсточникДанныхТовара.НомерГТД));
		НоваяСтрока.ЕдиницаИзмеренияКод				= СокрЛП(ИсточникДанныхТовара.ЕдиницаИзмеренияТНВЭДКод);
		НоваяСтрока.ЕдиницаИзмеренияНаименование	= СокрЛП(ИсточникДанныхТовара.ЕдиницаИзмеренияТНВЭДНаименование);
		НоваяСтрока.Количество						= ИсточникДанныхТовара.КоличествоПоРНПТ;
		НоваяСтрока.СтоимостьБезНДС					= Окр(ИсточникДанныхТовара.СуммаБезНДС, 2);
	Иначе
		// Заполнение сведений номеров РНПТ комплекта
		ОтборСтрок = Новый Структура("НомерГТД", ИсточникДанныхТовара.НомерГТДСсылка);
		Комплектующие = ПрослеживаемыеКомплектующие.НайтиСтроки(ОтборСтрок);
		
		ЗаполняемыеСвойства = "НомерТовара, ЕдиницаИзмеренияКод, ЕдиницаИзмеренияНаименование";
		
		Для Каждого СтрокаКомплекта Из Комплектующие Цикл
			НоваяСтрока = СведенияОПрослеживаемости.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаКомплекта, ЗаполняемыеСвойства);
			
			НоваяСтрока.Количество = СтрокаКомплекта.Количество * ИсточникДанныхТовара.КоличествоПоРНПТ;
			НоваяСтрока.КоличествоУчетное = НоваяСтрока.Количество;
			НоваяСтрока.СтоимостьБезНДС = СтоимостьПоРНПТСтрокиКомплекта(ИсточникДанныхТовара.СуммаБезНДС, СтрокаКомплекта.ОбщаяСуммаПоКомплекту,
				СтрокаКомплекта.СуммаПоРНПТ);
		КонецЦикла;
	КонецЕсли;
	
	ПриемникДанныхТовара.СведенияОПрослеживаемости = СведенияОПрослеживаемости;
	
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(
		ПриемникДанныхТовара.СведенияОПрослеживаемости,
		"НомерТовара",
		,
		,
		НСтр("ru = 'Не заполнен номер ГТД'"));
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(
		ПриемникДанныхТовара.СведенияОПрослеживаемости,
		"ЕдиницаИзмеренияКод",
		,
		,
		НСтр("ru = 'Не заполнена единица измерения ТН ВЭД'"));
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(
		ПриемникДанныхТовара.СведенияОПрослеживаемости,
		"ЕдиницаИзмеренияНаименование",
		,
		,
		НСтр("ru = 'Не заполнена единица измерения ТН ВЭД'"));
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(
		ПриемникДанныхТовара.СведенияОПрослеживаемости,
		"Количество",
		,
		,
		НСтр("ru = 'Не заполнено количество в единицах прослеживаемости'"));
	
КонецПроцедуры

Функция СтоимостьПоРНПТСтрокиКомплекта(Знач СуммаБезНДС, Знач ОбщаяСуммаПоКомплекту, Знач СуммаПоРНПТ)
	
	Стоимость = 0;
	
	Если ОбщаяСуммаПоКомплекту = 0 Тогда
		Возврат Стоимость;	
	КонецЕсли;
	
	Стоимость = (СуммаБезНДС / ОбщаяСуммаПоКомплекту) * СуммаПоРНПТ;	
	Стоимость = Окр(Стоимость, 2);
	
    Возврат Стоимость;
	
КонецФункции

// Возвращает пустую таблицу сведений о прослеживаемости УКД.
//
// Возвращаемое значение:
//	ТаблицаЗначений - сведений о таможенной декларации, со следующими колонками:
//		* НомерТовара - Строка - регистрационный номер товара.
//		* ЕдиницаИзмеренияКод - Строка - код единицы измерения прослеживаемости.
//		* ЕдиницаИзмеренияНаименование - Строка - наименование единицы измерения прослеживаемости.
//		* КоличествоТовараДоИзменения - Число - количество прослеживаемых товаров до изменения.
//		* КоличествоТовараПослеИзменения - Число - количество прослеживаемых товаров после изменения.
//		* КоличествоТовараУвеличение - Число - количество прослеживаемых товаров на которое осуществлено увеличение.
//		* КоличествоТовараУменьшение - Число - количество прослеживаемых товаров на которое осуществлено уменьшение.
//		* СуммаПоРНПТ - Число - стоимость прослеживаемого товара/комплекта.
//
Функция ПустаяТаблицаСведенияОПрослеживаемостиУКД()
	
	КоличествоПоРНПТОпианиеТипа = Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(26, 11));
	
	СведенияОПрослеживаемости = Новый ТаблицаЗначений;
	СведенияОПрослеживаемости.Колонки.Добавить("НомерТовара");
	СведенияОПрослеживаемости.Колонки.Добавить("ЕдиницаИзмеренияКод");
	СведенияОПрослеживаемости.Колонки.Добавить("ЕдиницаИзмеренияНаименование");
	СведенияОПрослеживаемости.Колонки.Добавить("КоличествоТовараДоИзменения", КоличествоПоРНПТОпианиеТипа);
	СведенияОПрослеживаемости.Колонки.Добавить("КоличествоТовараПослеИзменения", КоличествоПоРНПТОпианиеТипа);
	СведенияОПрослеживаемости.Колонки.Добавить("КоличествоТовараУвеличение", КоличествоПоРНПТОпианиеТипа);
	СведенияОПрослеживаемости.Колонки.Добавить("КоличествоТовараУменьшение", КоличествоПоРНПТОпианиеТипа);
	СведенияОПрослеживаемости.Колонки.Добавить("КоличествоТовараУчетноеПослеИзменения", КоличествоПоРНПТОпианиеТипа);
	СведенияОПрослеживаемости.Колонки.Добавить("СтоимостьБезНДСДоИзменения", КоличествоПоРНПТОпианиеТипа);
	СведенияОПрослеживаемости.Колонки.Добавить("СтоимостьБезНДСПослеИзменения");
	СведенияОПрослеживаемости.Колонки.Добавить("СтоимостьБезНДСУвеличение");
	СведенияОПрослеживаемости.Колонки.Добавить("СтоимостьБезНДСУменьшение");
	
	Возврат СведенияОПрослеживаемости;
	
КонецФункции

Процедура ЗаполнитьСведенияОПрослеживаемостиУКД(ПриемникДанныхТовара, ИсточникДанныхТовара, ПрослеживаемыеКомплектующие)
	
	СведенияОПрослеживаемости = ПустаяТаблицаСведенияОПрослеживаемостиУКД();
	
	Если ИсточникДанныхТовара.ТипНомераГТД = Перечисления.ТипыНомеровГТД.НомерРНПТ Тогда
		НоваяСтрока = СведенияОПрослеживаемости.Добавить();
		НоваяСтрока.НомерТовара						= СокрЛП(Строка(ИсточникДанныхТовара.НомерГТД));
		НоваяСтрока.ЕдиницаИзмеренияКод				= СокрЛП(ИсточникДанныхТовара.ЕдиницаИзмеренияТНВЭДКод);
		НоваяСтрока.ЕдиницаИзмеренияНаименование	= СокрЛП(ИсточникДанныхТовара.ЕдиницаИзмеренияТНВЭДНаименование);
		НоваяСтрока.КоличествоТовараПослеИзменения	= ИсточникДанныхТовара.КоличествоПоРНПТ;
		НоваяСтрока.КоличествоТовараДоИзменения		= ИсточникДанныхТовара.КоличествоПоРНПТДо;
		
		Если НоваяСтрока.КоличествоТовараПослеИзменения >= НоваяСтрока.КоличествоТовараДоИзменения Тогда
			НоваяСтрока.КоличествоТовараУвеличение = НоваяСтрока.КоличествоТовараПослеИзменения
														- НоваяСтрока.КоличествоТовараДоИзменения;
		Иначе
			НоваяСтрока.КоличествоТовараУвеличение = 0;
		КонецЕсли;
		
		Если НоваяСтрока.КоличествоТовараПослеИзменения < НоваяСтрока.КоличествоТовараДоИзменения Тогда
			НоваяСтрока.КоличествоТовараУменьшение = -(НоваяСтрока.КоличествоТовараПослеИзменения
														- НоваяСтрока.КоличествоТовараДоИзменения);
		Иначе
			НоваяСтрока.КоличествоТовараУменьшение = 0;
		КонецЕсли;
		
		НоваяСтрока.СтоимостьБезНДСДоИзменения = Окр(ИсточникДанныхТовара.СуммаБезНДСДо, 2);
		НоваяСтрока.СтоимостьБезНДСПослеИзменения = Окр(ИсточникДанныхТовара.СуммаБезНДС, 2);
		НоваяСтрока.СтоимостьБезНДСУвеличение = Окр(ИсточникДанныхТовара.РазницаБезНДСУвеличение, 2);
		НоваяСтрока.СтоимостьБезНДСУменьшение = Окр(ИсточникДанныхТовара.РазницаБезНДСУменьшение, 2);
		
	Иначе
		// Заполнение сведений номеров РНПТ комплекта
		ОтборСтрок = Новый Структура("НомерГТД", ИсточникДанныхТовара.НомерГТДСсылка);
		Комплектующие = ПрослеживаемыеКомплектующие.НайтиСтроки(ОтборСтрок);
		
		Для Каждого СтрокаКомплекта Из Комплектующие Цикл
			НоваяСтрока = СведенияОПрослеживаемости.Добавить();
			НоваяСтрока.НомерТовара						= СокрЛП(Строка(СтрокаКомплекта.НомерТовара));
			НоваяСтрока.ЕдиницаИзмеренияКод				= СокрЛП(СтрокаКомплекта.ЕдиницаИзмеренияКод);
			НоваяСтрока.ЕдиницаИзмеренияНаименование	= СокрЛП(СтрокаКомплекта.ЕдиницаИзмеренияНаименование);
			НоваяСтрока.КоличествоТовараПослеИзменения	= СтрокаКомплекта.Количество
															* ИсточникДанныхТовара.КоличествоПоРНПТ;
			НоваяСтрока.КоличествоТовараДоИзменения		= СтрокаКомплекта.Количество
															* ИсточникДанныхТовара.КоличествоПоРНПТДо;
			
			Если НоваяСтрока.КоличествоТовараПослеИзменения >= НоваяСтрока.КоличествоТовараДоИзменения Тогда
				НоваяСтрока.КоличествоТовараУвеличение = НоваяСтрока.КоличествоТовараПослеИзменения
															- НоваяСтрока.КоличествоТовараДоИзменения;
			Иначе
				НоваяСтрока.КоличествоТовараУвеличение = 0;
			КонецЕсли;
			
			Если НоваяСтрока.КоличествоТовараПослеИзменения < НоваяСтрока.КоличествоТовараДоИзменения Тогда
				НоваяСтрока.КоличествоТовараУменьшение = -(НоваяСтрока.КоличествоТовараПослеИзменения
															- НоваяСтрока.КоличествоТовараДоИзменения);
			Иначе
				НоваяСтрока.КоличествоТовараУменьшение = 0;
			КонецЕсли;

			НоваяСтрока.КоличествоТовараУчетноеПослеИзменения = НоваяСтрока.КоличествоТовараПослеИзменения;
			
			НоваяСтрока.СтоимостьБезНДСДоИзменения = СтоимостьПоРНПТСтрокиКомплекта(ИсточникДанныхТовара.СуммаБезНДСДо, 
				СтрокаКомплекта.ОбщаяСуммаПоКомплекту, СтрокаКомплекта.СуммаПоРНПТ);
			НоваяСтрока.СтоимостьБезНДСПослеИзменения = СтоимостьПоРНПТСтрокиКомплекта(ИсточникДанныхТовара.СуммаБезНДС, 
				СтрокаКомплекта.ОбщаяСуммаПоКомплекту, СтрокаКомплекта.СуммаПоРНПТ);
			НоваяСтрока.СтоимостьБезНДСУвеличение = СтоимостьПоРНПТСтрокиКомплекта(ИсточникДанныхТовара.РазницаБезНДСУвеличение, 
				СтрокаКомплекта.ОбщаяСуммаПоКомплекту, СтрокаКомплекта.СуммаПоРНПТ);
			НоваяСтрока.СтоимостьБезНДСУменьшение = СтоимостьПоРНПТСтрокиКомплекта(ИсточникДанныхТовара.РазницаБезНДСУменьшение, 
				СтрокаКомплекта.ОбщаяСуммаПоКомплекту, СтрокаКомплекта.СуммаПоРНПТ);
			
		КонецЦикла;
	КонецЕсли;
	
	ПриемникДанныхТовара.СведенияОПрослеживаемости = СведенияОПрослеживаемости;
	
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(
		ПриемникДанныхТовара.СведенияОПрослеживаемости,
		"НомерТовара",
		,
		,
		НСтр("ru = 'Не заполнен номер ГТД'"));
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(
		ПриемникДанныхТовара.СведенияОПрослеживаемости,
		"ЕдиницаИзмеренияКод",
		,
		,
		НСтр("ru = 'Не заполнена единица измерения ТН ВЭД'"));
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(
		ПриемникДанныхТовара.СведенияОПрослеживаемости,
		"ЕдиницаИзмеренияНаименование",
		,
		,
		НСтр("ru = 'Не заполнена единица измерения ТН ВЭД'"));
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(
		ПриемникДанныхТовара.СведенияОПрослеживаемости,
		"Количество",
		,
		,
		НСтр("ru = 'Не заполнено количество в единицах прослеживаемости'"));
	
КонецПроцедуры

// Возвращает описание таблицы сведений о прослеживаемых комиссионных товарах.
//
//
// Возвращаемое значение:
//	ТаблицаЗначений - описание таблицы сведений о прослеживаемых комиссионных товарах, со следующими колонками:
//		* НомерСтроки - Число - номер строки товара.
//		* Ссылка - ДокументСсылка, Неопределено - ссылка на документ в информационной базе.
//		* Номенклатура - СправочникСсылка.Номенклатура - прослеживаемая номенклатура.
//		* Характеристика - СправочникСсылка.ХарактеристикиНоменклатуры - характеристику номенклатуры.
//		* Количество - Число - количество товара в единице измерения прослеживаемости в соотвествеии с кодом ТН ВЭД.
//		* КоличествоУпаковок - Число - количество товара в единице хранение.
//		* НомерГТД - СправочникСсылка.НомераГТД - номер ГТД товара.
//		* ТипНомераГТД - ПеречислениеСсылка.ТипыНомеровГТД, Неопределено - тип номера ГТД.
//		* НомерТовара - Строка - регистрационный номер ТД товара.
//		* АналитикаУчетаНоменклатуры - СправочникСсылка.КлючиАналитикиУчетаНоменклатуры - ключ аналитики учета номенклатуры.
//		* ЕдиницаИзмеренияКод - Строка - код единицы измерения по ОКЕИ.
//		* ЕдиницаИзмеренияНаименование - Строка - наименование единицы измерения.
//
Функция ПустаяТаблицаПрослеживаемыеТоварыДляКомиссии() Экспорт
	
	КоличествоПоРНПТОпианиеТипа				= Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(26, 11));
	ЧислоОписаниеТипа						= Новый ОписаниеТипов("Число");
	НоменклатураОписаниеТипа				= Новый ОписаниеТипов("СправочникСсылка.Номенклатура");
	ХарактеристикаНоменклатурыОписаниеТипа	= Новый ОписаниеТипов("СправочникСсылка.ХарактеристикиНоменклатуры");
	НомерГТДОписаниеТипа					= Новый ОписаниеТипов("СправочникСсылка.НомераГТД");
	АналитикаУчетаНоменклатурыОписаниеТипа	= Новый ОписаниеТипов("СправочникСсылка.КлючиАналитикиУчетаНоменклатуры");
	СтрокаОписаниеТипа						= Новый ОписаниеТипов("Строка");
	
	ПрослеживаемыеТовары = Новый ТаблицаЗначений;
	ПрослеживаемыеТовары.Колонки.Добавить("НомерСтроки", ЧислоОписаниеТипа);
	ПрослеживаемыеТовары.Колонки.Добавить("Ссылка");
	ПрослеживаемыеТовары.Колонки.Добавить("Номенклатура", НоменклатураОписаниеТипа);
	ПрослеживаемыеТовары.Колонки.Добавить("Характеристика", ХарактеристикаНоменклатурыОписаниеТипа);
	ПрослеживаемыеТовары.Колонки.Добавить("Количество", КоличествоПоРНПТОпианиеТипа);
	ПрослеживаемыеТовары.Колонки.Добавить("КоличествоУпаковок", ЧислоОписаниеТипа);
	ПрослеживаемыеТовары.Колонки.Добавить("НомерГТД", НомерГТДОписаниеТипа);
	ПрослеживаемыеТовары.Колонки.Добавить("ТипНомераГТД");
	ПрослеживаемыеТовары.Колонки.Добавить("НомерТовара", СтрокаОписаниеТипа);
	ПрослеживаемыеТовары.Колонки.Добавить("АналитикаУчетаНоменклатуры", АналитикаУчетаНоменклатурыОписаниеТипа);
	ПрослеживаемыеТовары.Колонки.Добавить("ЕдиницаИзмеренияКод", СтрокаОписаниеТипа);
	ПрослеживаемыеТовары.Колонки.Добавить("ЕдиницаИзмеренияНаименование", СтрокаОписаниеТипа);
	
	Возврат ПрослеживаемыеТовары;
	
КонецФункции

// Возвращает таблицу сведений о прослеживаемых комиссионных товарах.
//
// Параметры:
//	ПрослеживаемыеТовары - РезультатЗапроса - сведения о прослеживаемых товарах.
//
// Возвращаемое значение:
//	см. ПустаяТаблицаПрослеживаемыеТоварыДляКомиссии
//
Функция ПрослеживаемыеТоварыДляКомиссии(ПрослеживаемыеТовары) Экспорт
	
	Выборка = ПрослеживаемыеТовары.Выбрать();
	ТаблицаТовары = ПустаяТаблицаПрослеживаемыеТоварыДляКомиссии();
	
	ИсключаемыеСвойства = "НомерТовара, ЕдиницаИзмеренияКод, ЕдиницаИзмеренияНаименование";
	
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = ТаблицаТовары.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка, , ИсключаемыеСвойства);
		
		НоваяСтрока.НомерТовара						= СокрЛП(Строка(Выборка.НомерТовара));
		НоваяСтрока.ЕдиницаИзмеренияКод				= СокрЛП(Выборка.ЕдиницаИзмеренияКод);
		НоваяСтрока.ЕдиницаИзмеренияНаименование	= СокрЛП(Выборка.ЕдиницаИзмеренияНаименование);
	КонецЦикла;
	
	Возврат ТаблицаТовары;
	
КонецФункции

// Возвращает пустую таблицу сведений о прослеживаемости для комиссии.
//
// Возвращаемое значение:
//	ТаблицаЗначений - сведений о таможенной декларации, со следующими колонками:
//		* НомерТовара - Строка - регистрационный номер товара.
//		* ЕдиницаИзмеренияКод - Строка - код единицы измерения прослеживаемости.
//		* ЕдиницаИзмеренияНаименование - Строка - наименование единицы измерения прослеживаемости.
//		* Количество - Число - количество прослеживаемых товаров.
//		* КоличествоУчетное - Число - количество товаров в единице хранения.
//		* СуммаПоРНПТ - Число - стоимость прослеживаемого товара/комплекта.
//
Функция ПустаяТаблицаСведенияОПрослеживаемостиДляКомиссии()
	
	КоличествоПоРНПТОпианиеТипа = Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(26, 11));
	
	СведенияОПрослеживаемости = Новый ТаблицаЗначений;
	СведенияОПрослеживаемости.Колонки.Добавить("НомерТовара");
	СведенияОПрослеживаемости.Колонки.Добавить("ЕдиницаИзмеренияКод");
	СведенияОПрослеживаемости.Колонки.Добавить("ЕдиницаИзмеренияНаименование");
	СведенияОПрослеживаемости.Колонки.Добавить("Количество", КоличествоПоРНПТОпианиеТипа);
	СведенияОПрослеживаемости.Колонки.Добавить("КоличествоУчетное");
	
	Возврат СведенияОПрослеживаемости;
	
КонецФункции

Процедура ЗаполнитьСведенияОПрослеживаемостиДляКомиссии(ПриемникДанныхТовара,
														ПрослеживаемыеТовары,
														ПрослеживаемыеКомплектующие)
	
	Если ПрослеживаемыеТовары.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	ПрослеживаемыйТовар = ПрослеживаемыеТовары.Найти(ПриемникДанныхТовара.НомерСтроки, "НомерСтроки");
	
	Если ПрослеживаемыйТовар = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	СведенияОПрослеживаемости = ПустаяТаблицаСведенияОПрослеживаемостиДляКомиссии();
	
	Если ПрослеживаемыйТовар.ТипНомераГТД = Перечисления.ТипыНомеровГТД.НомерРНПТ Тогда
		НоваяСтрока = СведенияОПрослеживаемости.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, ПрослеживаемыйТовар);
		
		НоваяСтрока.КоличествоУчетное = ПрослеживаемыйТовар.КоличествоУпаковок;
	Иначе
		// Заполнение сведений номеров РНПТ комплекта
		ОтборСтрок = Новый Структура("НомерГТД", ПрослеживаемыйТовар.НомерГТД);
		Комплектующие = ПрослеживаемыеКомплектующие.НайтиСтроки(ОтборСтрок);
		
		Для Каждого СтрокаКомплекта Из Комплектующие Цикл
			НоваяСтрока = СведенияОПрослеживаемости.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаКомплекта, , "Количество");
			
			НоваяСтрока.Количество = СтрокаКомплекта.Количество * ПрослеживаемыйТовар.Количество;
		КонецЦикла;
	КонецЕсли;
	
	ПриемникДанныхТовара.СведенияОПрослеживаемости = СведенияОПрослеживаемости;
	
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(
		ПриемникДанныхТовара.СведенияОПрослеживаемости,
		"НомерТовара",
		,
		,
		НСтр("ru = 'Не заполнен номер ГТД'"));
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(
		ПриемникДанныхТовара.СведенияОПрослеживаемости,
		"ЕдиницаИзмеренияКод",
		,
		,
		НСтр("ru = 'Не заполнена единица измерения ТН ВЭД'"));
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(
		ПриемникДанныхТовара.СведенияОПрослеживаемости,
		"ЕдиницаИзмеренияНаименование",
		,
		,
		НСтр("ru = 'Не заполнена единица измерения ТН ВЭД'"));
	ЭлектронноеВзаимодействие.ДобавитьВТаблицуОбработкуОшибкиЧерезСообщениеПользователю(
		ПриемникДанныхТовара.СведенияОПрослеживаемости,
		"Количество",
		,
		,
		НСтр("ru = 'Не заполнено количество в единицах прослеживаемости'"));
	
КонецПроцедуры

// Возвращает параметры заполнения строки товаров сведениями о прослеживаемости.
//
// Возвращаемое значение:
//	Структура - коллекция параметров. содержащая следующие свойства:
//		* СопоставлениеСтранМира - Соответствие Из КлючИЗначение - коллекция, содержащая сведения о странах мира:
//			** Ключ - Строка - код страны мира.
//			** Значение - СправочникСсылка.СтраныМира, Неопределено - ссылка страны мира.
//		* СопоставлениеЕдиницИзмерения - Соответствие Из КлючИЗначение - коллекция, содержащая сведения о единицах измерения:
//			** Ключ - Строка - код единицы измерения.
//			** Значение - СправочникСсылка.УпаковкиЕдиницыИзмерения, Неопределено - ссылка единицы измерения.
//		* ИмяПоляКоличествоПоРНПТ - Строка - имя поля, содержащее данные о количестве прослеживаемости в коллекции
//												сведений о прослеживаемости.
//		* СуммаПоРНПТ - Строка - имя поля, содержащее данные о сумме прослеживаемости в коллекции
//												сведений о прослеживаемости.
//
Функция ПараметрыЗаполненияСтрокиТоваровСведениямиОПрослеживаемости()
	
	ПараметрыЗаполнения = Новый Структура;
	ПараметрыЗаполнения.Вставить("СопоставлениеСтранМира",			Новый Соответствие);
	ПараметрыЗаполнения.Вставить("СопоставлениеЕдиницИзмерения",	Новый Соответствие);
	ПараметрыЗаполнения.Вставить("ИмяПоляКоличествоПоРНПТ",			"Количество");
	ПараметрыЗаполнения.Вставить("ИмяПоляКоличествоУчетноеПоРНПТ",	"КоличествоУчетное");
	ПараметрыЗаполнения.Вставить("ИмяПоляСтоимостьБезНДС",			"СтоимостьБезНДС");
	
	Возврат ПараметрыЗаполнения;
	
КонецФункции

// Заполняет строку таблицы товаров сведениями о прослеживаемости.
//
// Параметры:
//	ТекущаяСтрока - СтрокаТабличнойЧасти - строка таблицы товаров.
//	Товары - ТабличнаяЧасть, ТаблицаЗначений - таблица товаров, в которой осуществляется заполнение строки.
//	СведенияОПрослеживаемости - ДеревоЗначений - сведения о прослеживаемости.
//	СведенияОТаможеннойДекларации - ДеревоЗначений - сведения о таможенной декларации.
//	ПараметрыЗаполнения - см. ПараметрыЗаполненияСтрокиТоваровСведениямиОПрослеживаемости
//
Процедура ЗаполнитьСтрокуТоваровСведениямиОПрослеживаемости(ТекущаяСтрока,
															Товары,
															СведенияОПрослеживаемости,
															СведенияОТаможеннойДекларации,
															ПараметрыЗаполнения = Неопределено)
	
	Если СведенияОПрослеживаемости = Неопределено Тогда
		Возврат;
	ИначеЕсли СведенияОПрослеживаемости.Строки.Количество() = 0 Тогда
		Возврат;
	ИначеЕсли СведенияОПрослеживаемости.Строки.Количество() = 1 Тогда
		НомерТовара = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
								СведенияОПрослеживаемости.Строки[0],
								"СведенияОТоварах.НомерСтроки.СведенияОПрослеживаемости.НомерСтроки.НомерТовара");
		Если Не ЗначениеЗаполнено(НомерТовара) Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	Если ПараметрыЗаполнения = Неопределено Тогда
		ПараметрыЗаполнения = ПараметрыЗаполненияСтрокиТоваровСведениямиОПрослеживаемости();
	КонецЕсли;
	
	СопоставлениеСтранМира			= ПараметрыЗаполнения.СопоставлениеСтранМира;
	СопоставлениеЕдиницИзмерения	= ПараметрыЗаполнения.СопоставлениеЕдиницИзмерения;
	ИмяПоляКоличествоПоРНПТ			= ПараметрыЗаполнения.ИмяПоляКоличествоПоРНПТ;
	ИмяПоляКоличествоУчетноеПоРНПТ	= ПараметрыЗаполнения.ИмяПоляКоличествоУчетноеПоРНПТ;
	ИмяПоляСтоимостьБезНДС			= ПараметрыЗаполнения.ИмяПоляСтоимостьБезНДС;	
	ЭтоУПД 							= ПараметрыЗаполнения.ЭтоУПД_2019;	
	
	ПутьНомераСтрокиПрослеживаемости		= "СведенияОТоварах.НомерСтроки.СведенияОПрослеживаемости.НомерСтроки";
	ПутьНомераСтрокиТаможеннойДекларации	= "СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации.НомерСтроки";
	
	ЕстьСведенияОТаможеннойДекларации = СведенияОТаможеннойДекларации <> Неопределено
										И СведенияОТаможеннойДекларации.Строки.Количество() > 0;

	ЭтоРНПТКомплекта = Истина;
	Если СведенияОПрослеживаемости.Строки.Количество() = 1 Тогда
		ЭтоРНПТКомплекта = Ложь;
		СтоимостьБезНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
											СведенияОПрослеживаемости.Строки[0],
											ПутьНомераСтрокиПрослеживаемости + "." + ИмяПоляСтоимостьБезНДС);
		СтоимостьБезНДС = ?(СтоимостьБезНДС = Неопределено, 0, СтоимостьБезНДС);
		
		// Загружаем комплект из 1 шт, когда есть неявная часть из непрослеживаемой суммы -
		// стоимость из СведенияОТоваре не равна стоимости из СведенияОПрослеживаемости.
		Если ТекущаяСтрока.Сумма <> СтоимостьБезНДС Тогда
			ЭтоРНПТКомплекта = Истина;
		КонецЕсли;
	КонецЕсли;
	
	Если Не ЭтоРНПТКомплекта Тогда
		КоличествоПоРНПТ = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
											СведенияОПрослеживаемости.Строки[0],
											ПутьНомераСтрокиПрослеживаемости + "." + ИмяПоляКоличествоПоРНПТ);
		ТекущаяСтрока.КоличествоПоРНПТ = КоличествоПоРНПТ;
		
		Если ЕстьСведенияОТаможеннойДекларации Тогда
			НомерТаможеннойДекларации	= ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
											СведенияОТаможеннойДекларации.Строки[0],
											ПутьНомераСтрокиТаможеннойДекларации + "." + "ТаможеннаяДекларацияНомер");
			СуммаПоРНПТ	= ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
											СведенияОПрослеживаемости.Строки[0],
											ПутьНомераСтрокиПрослеживаемости + "." + ИмяПоляСтоимостьБезНДС);
			КодСтраныПроисхождения		= ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
											СведенияОТаможеннойДекларации.Строки[0],
											ПутьНомераСтрокиТаможеннойДекларации + "." + "СтранаПроисхожденияКод");
			СтранаПроисхождения			= СсылкаНаОбъектПоКоду("СтраныМира",
																КодСтраныПроисхождения,
																СопоставлениеСтранМира);
			ЕдиницаИзмеренияКод			= ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
											СведенияОПрослеживаемости.Строки[0],
											ПутьНомераСтрокиПрослеживаемости + "." + "ЕдиницаИзмеренияКод");
			ЕдиницаИзмерения			= СсылкаНаОбъектПоКоду("ЕдиницыИзмерения",
											ЕдиницаИзмеренияКод,
											СопоставлениеЕдиницИзмерения);
			
			ТекущаяСтрока.НомерГТД = НомерГТДПоСведениямТаможеннойДекларации(НомерТаможеннойДекларации,
																			СтранаПроисхождения,
																			ТекущаяСтрока.КоличествоПоРНПТ > 0,
																			СуммаПоРНПТ,
																			ЭтоУПД,
																			ЕдиницаИзмерения);
		КонецЕсли;
	Иначе
		ТекущаяСтрока.КоличествоПоРНПТ = ТекущаяСтрока.Количество;
		
		СтранаПроисхождения = Неопределено;
		
		Если ЕстьСведенияОТаможеннойДекларации Тогда
			КодСтраныПроисхождения	= ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
											СведенияОТаможеннойДекларации.Строки[0],
											ПутьНомераСтрокиТаможеннойДекларации + "." + "СтранаПроисхожденияКод");
			СтранаПроисхождения		= СсылкаНаОбъектПоКоду("СтраныМира", КодСтраныПроисхождения, СопоставлениеСтранМира);
		КонецЕсли;
		
		ТаблицаКомплектующих = ТаблицаПрослеживаемыхКомплектующихНомераГТД();
		ЗаполнитьТаблицуПрослеживаемыхКомплектующихНомераГТД(ТаблицаКомплектующих,
															СведенияОПрослеживаемости,
															СтранаПроисхождения,
															ПараметрыЗаполнения);
		
		НоменклатураДляЗаполнения = Новый Структура("Номенклатура");
		ЗаполнитьЗначенияСвойств(НоменклатураДляЗаполнения, ТекущаяСтрока);
		
		ПараметрыСоздания = ЗакупкиСервер.ПараметрыПоискаИлиСозданияСоставныхПрослеживаемыхКомплектов();
		ПараметрыСоздания.НоменклатураШапки = НоменклатураДляЗаполнения.Номенклатура;
		ПараметрыСоздания.СуммаПоРНПТ = ТекущаяСтрока.СуммаСНДС - ТекущаяСтрока.СуммаНДС;
		ПараметрыСоздания.ВсегдаИспользоватьСуммаПоРНПТДляСтоимостиКомплекта = Истина;
		ПараметрыСоздания.НормироватьСуммуПоРНПТПриСозданииСоставногоКомплекта = Истина;
		ПараметрыСоздания.РасширитьКлючПоискаНомеровГТДСуммойПоРНПТ = ЭтоУПД;
		
		ДанныеРНПТКомплекта = ЗакупкиСервер.НайтиИлиСоздатьСоставныеПрослеживаемыеНомераГТД(
									ТаблицаКомплектующих,
									ТекущаяСтрока.Количество,
									Дата(2399, 1, 1),
									Ложь,
									ПараметрыСоздания);
		
		ОбработатьУказаниеРНПТКомплектаВСтрокеТоваров(ТекущаяСтрока, Товары, ДанныеРНПТКомплекта);
	КонецЕсли;
	
КонецПроцедуры

// Заполняет строку расхождений в корректировке приобретения сведениями о прослеживаемости.
//
// Параметры:
//	ТекущаяСтрока - СтрокаТабличнойЧасти - строка таблицы товаров.
//	Товары - ТабличнаяЧасть, ТаблицаЗначений - таблица товаров, в которой осуществляется заполнение строки.
//	СведенияОТоваре - ДеревоЗначений - сведения о товаре.
//	СведенияОПрослеживаемости - ДеревоЗначений - сведения о прослеживаемости.
//	СведенияОТаможеннойДекларации - ДеревоЗначений - сведения о таможенной декларации.
//	ПараметрыЗаполнения - см. ПараметрыЗаполненияСтрокиТоваровСведениямиОПрослеживаемости
//
Процедура ЗаполнитьСтрокуРасхожденийСведениямиОПрослеживаемости(ТекущаяСтрока,
															Товары,
															СведенияОТоваре,
															СведенияОПрослеживаемости,
															СведенияОТаможеннойДекларации,
															ПараметрыЗаполнения = Неопределено)
	
	Если СведенияОПрослеживаемости = Неопределено Тогда
		Возврат;
	ИначеЕсли СведенияОПрослеживаемости.Строки.Количество() = 0 Тогда
		Возврат;
	ИначеЕсли СведенияОПрослеживаемости.Строки.Количество() = 1 Тогда
		НомерТовара = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
								СведенияОПрослеживаемости.Строки[0],
								"СведенияОТоварах.НомерСтроки.СведенияОПрослеживаемости.НомерСтроки.НомерТовара");
		Если Не ЗначениеЗаполнено(НомерТовара) Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	Если ПараметрыЗаполнения = Неопределено Тогда
		ПараметрыЗаполнения = ПараметрыЗаполненияСтрокиТоваровСведениямиОПрослеживаемости();
	КонецЕсли;
	
	СопоставлениеСтранМира			= ПараметрыЗаполнения.СопоставлениеСтранМира;
	СопоставлениеЕдиницИзмерения	= ПараметрыЗаполнения.СопоставлениеЕдиницИзмерения;
	ИмяПоляКоличествоПоРНПТ			= ПараметрыЗаполнения.ИмяПоляКоличествоПоРНПТ;
	ИмяПоляКоличествоУчетноеПоРНПТ	= ПараметрыЗаполнения.ИмяПоляКоличествоУчетноеПоРНПТ;
	ИмяПоляСтоимостьБезНДС			= ПараметрыЗаполнения.ИмяПоляСтоимостьБезНДС;	
	
	ПутьНомераСтрокиПрослеживаемости		= "СведенияОТоварах.НомерСтроки.СведенияОПрослеживаемости.НомерСтроки";
	ПутьНомераСтрокиТаможеннойДекларации	= "СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации.НомерСтроки";
	
	ЕстьСведенияОТаможеннойДекларации = СведенияОТаможеннойДекларации <> Неопределено
										И СведенияОТаможеннойДекларации.Строки.Количество() > 0;

	ЭтоРНПТКомплекта = Истина;
	Если СведенияОПрослеживаемости.Строки.Количество() = 1 Тогда
		ЭтоРНПТКомплекта = Ложь;
		СтоимостьБезНалога = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
											СведенияОПрослеживаемости.Строки[0],
											ПутьНомераСтрокиПрослеживаемости + "." + "СтоимостьБезНДСПослеИзменения");
		ТоварыСтоимостьБезНалога = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
											СведенияОТоваре,
											"СведенияОТоварах.НомерСтроки.СтоимостьТоваровБезНалога");
		СтоимостьБезНалога = ?(СтоимостьБезНалога = Неопределено, 0, СтоимостьБезНалога);
		ТоварыСтоимостьБезНалога = ?(ТоварыСтоимостьБезНалога = Неопределено, 0, ТоварыСтоимостьБезНалога);
		
		// Загружаем комплект из 1 шт, когда есть неявная часть из непрослеживаемой суммы -
		// стоимость из СведенияОТоваре не равна стоимости из СведенияОПрослеживаемости.
		Если СтоимостьБезНалога <> ТоварыСтоимостьБезНалога Тогда
			ЭтоРНПТКомплекта = Истина;
		КонецЕсли;
	КонецЕсли;
	
	Если Не ЭтоРНПТКомплекта Тогда
		КоличествоПоРНПТДо = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
											СведенияОПрослеживаемости.Строки[0],
											ПутьНомераСтрокиПрослеживаемости + ".КоличествоТовараДоИзменения");
		КоличествоПоРНПТПосле = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
											СведенияОПрослеживаемости.Строки[0],
											ПутьНомераСтрокиПрослеживаемости + "." + ИмяПоляКоличествоПоРНПТ);
		Если ЗначениеЗаполнено(КоличествоПоРНПТПосле) И ЗначениеЗаполнено(КоличествоПоРНПТДо) Тогда
			ТекущаяСтрока.КоличествоПоРНПТ = КоличествоПоРНПТПосле - КоличествоПоРНПТДо;
		КонецЕсли;
		
		Если ЕстьСведенияОТаможеннойДекларации Тогда
			ЭтоНомерРНПТ				= ЗначениеЗаполнено(КоличествоПоРНПТДо)
											И ЗначениеЗаполнено(КоличествоПоРНПТПосле);
			НомерТаможеннойДекларации	= ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
											СведенияОТаможеннойДекларации.Строки[0],
											ПутьНомераСтрокиТаможеннойДекларации + "." + "ТаможеннаяДекларацияНомер");
			КодСтраныПроисхождения		= ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
											СведенияОТаможеннойДекларации.Строки[0],
											ПутьНомераСтрокиТаможеннойДекларации + "." + "СтранаПроисхожденияКод");
			СтранаПроисхождения			= СсылкаНаОбъектПоКоду("СтраныМира",
																КодСтраныПроисхождения,
																СопоставлениеСтранМира);
			СуммаПоРНПТ	= ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
											СведенияОПрослеживаемости.Строки[0],
											ПутьНомераСтрокиПрослеживаемости + "." + ИмяПоляСтоимостьБезНДС);
			ЕдиницаИзмеренияКод			= ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
											СведенияОПрослеживаемости.Строки[0],
											ПутьНомераСтрокиПрослеживаемости + "." + "ЕдиницаИзмеренияКод");
			ЕдиницаИзмерения			= СсылкаНаОбъектПоКоду("ЕдиницыИзмерения",
											ЕдиницаИзмеренияКод,
											СопоставлениеЕдиницИзмерения);
			
			ТекущаяСтрока.НомерГТД = НомерГТДПоСведениямТаможеннойДекларации(НомерТаможеннойДекларации,
																			СтранаПроисхождения,
																			ЭтоНомерРНПТ,
																			СуммаПоРНПТ,
																			Ложь,
																			ЕдиницаИзмерения);
		КонецЕсли;
	Иначе
		ТекущаяСтрока.КоличествоПоРНПТ = ТекущаяСтрока.Количество;
		
		СтранаПроисхождения = Неопределено;
		
		Если ЕстьСведенияОТаможеннойДекларации Тогда
			КодСтраныПроисхождения	= ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
											СведенияОТаможеннойДекларации.Строки[0],
											ПутьНомераСтрокиТаможеннойДекларации + "." + "СтранаПроисхожденияКод");
			СтранаПроисхождения		= СсылкаНаОбъектПоКоду("СтраныМира", КодСтраныПроисхождения, СопоставлениеСтранМира);
		КонецЕсли;
		
		ТаблицаКомплектующих = ТаблицаПрослеживаемыхКомплектующихНомераГТД();
		ЗаполнитьТаблицуПрослеживаемыхКомплектующихНомераГТД(ТаблицаКомплектующих,
															СведенияОПрослеживаемости,
															СтранаПроисхождения,
															ПараметрыЗаполнения);
		
		НоменклатураДляЗаполнения = Новый Структура("Номенклатура");
		ЗаполнитьЗначенияСвойств(НоменклатураДляЗаполнения, ТекущаяСтрока);
		
		ПараметрыСоздания = ЗакупкиСервер.ПараметрыПоискаИлиСозданияСоставныхПрослеживаемыхКомплектов();
		ПараметрыСоздания.НоменклатураШапки = НоменклатураДляЗаполнения.Номенклатура;
		ПараметрыСоздания.СуммаПоРНПТ = ТекущаяСтрока.СуммаСНДС - ТекущаяСтрока.СуммаНДС;
		
		ДанныеРНПТКомплекта = ЗакупкиСервер.НайтиИлиСоздатьСоставныеПрослеживаемыеНомераГТД(
									ТаблицаКомплектующих,
									КомпоновкаДанныхСервер.МодульЧисла(ТекущаяСтрока.Количество),
									Дата(2399, 1, 1),
									Ложь,
									ПараметрыСоздания);
		
		ОбработатьУказаниеРНПТКомплектаВСтрокеТоваров(ТекущаяСтрока, Товары, ДанныеРНПТКомплекта);
	КонецЕсли;
	
КонецПроцедуры

// Заполняет строку таблицы товаров сведениями о таможенной декларации.
//
// Параметры:
//	ТекущаяСтрока - СтрокаТабличнойЧасти - строка таблицы товаров.
//	СведенияОТаможеннойДекларации - ДеревоЗначений - сведения о таможенной декларации.
//	ПараметрыЗаполнения - см. ПараметрыЗаполненияСтрокиТоваровСведениямиОПрослеживаемости
//
Процедура ЗаполнитьСтрокуТоваровСведениямиОТаможеннойДекларации(ТекущаяСтрока,
																СведенияОТаможеннойДекларации,
																ПараметрыЗаполнения = Неопределено)
	
	Если ЗначениеЗаполнено(ТекущаяСтрока.НомерГТД) Тогда
		Возврат;
	КонецЕсли;
	
	Если СведенияОТаможеннойДекларации = Неопределено Тогда
		Возврат;
	ИначеЕсли СведенияОТаможеннойДекларации.Строки.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Если ПараметрыЗаполнения = Неопределено Тогда
		ПараметрыЗаполнения = ПараметрыЗаполненияСтрокиТоваровСведениямиОПрослеживаемости();
	КонецЕсли;
	
	СопоставлениеСтранМира = ПараметрыЗаполнения.СопоставлениеСтранМира;
	ПутьНомераСтрокиТаможеннойДекларации = "СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации.НомерСтроки";
	
	НомерТаможеннойДекларации	= ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
									СведенияОТаможеннойДекларации.Строки[0],
									ПутьНомераСтрокиТаможеннойДекларации + "." + "ТаможеннаяДекларацияНомер");
	КодСтраныПроисхождения		= ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
									СведенияОТаможеннойДекларации.Строки[0],
									ПутьНомераСтрокиТаможеннойДекларации + "." + "СтранаПроисхожденияКод");
	СтранаПроисхождения			= СсылкаНаОбъектПоКоду("СтраныМира",
														КодСтраныПроисхождения,
														СопоставлениеСтранМира);
	
	ТекущаяСтрока.НомерГТД = НомерГТДПоСведениямТаможеннойДекларации(НомерТаможеннойДекларации,
																	СтранаПроисхождения,
																	ТекущаяСтрока.КоличествоПоРНПТ > 0);
	
КонецПроцедуры

// Возвращает ссылку на объект по ее коду.
//
// Параметры:
//	ИмяОбъекта - Строка - имя ссылочного объекта метаданных.
//	КодОбъекта - Строка - код объекта.
//	СопоставлениеКодаИСсылки - Соответствие Из КлючИЗначение - коллекция, содержащая сведения о сопоставлении кода объекта и ссылки на объект:
//		* Ключ - Строка - код объекта.
//		* Значение - ЛюбаяСсылка, Неопределено - ссылка на объект.
//
// Возвращаемое значение:
//	ЛюбаяСсылка, Неопределено - ссылка на объект.
//
Функция СсылкаНаОбъектПоКоду(ИмяОбъекта, КодОбъекта, СопоставлениеКодаИСсылки)
	
	СсылкаНаОбъект = Неопределено;
	
	Если Не ЗначениеЗаполнено(КодОбъекта) Тогда
		Возврат СсылкаНаОбъект;
	КонецЕсли;
	
	СсылкаНаОбъект = СопоставлениеКодаИСсылки.Получить(КодОбъекта);
	
	Если СсылкаНаОбъект = Неопределено Тогда
		ЭлектронноеВзаимодействиеПереопределяемый.НайтиСсылкуНаОбъект(ИмяОбъекта, СсылкаНаОбъект, КодОбъекта);
		СопоставлениеКодаИСсылки.Вставить(КодОбъекта, СсылкаНаОбъект);
	КонецЕсли;
	
	Возврат СсылкаНаОбъект;
	
КонецФункции

Процедура ПроверитьШтрихкодыУпаковок(ТаблицаУпаковок, Отказ) Экспорт

	Если ТаблицаУпаковок = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ВыведенныеСообщения = Новый Соответствие;
	Для Каждого СтрокаТаблицы Из ТаблицаУпаковок Цикл
		Если ЗначениеЗаполнено(СтрокаТаблицы.ТекстОшибкиИС) Тогда
			Если ВыведенныеСообщения.Получить(СтрокаТаблицы.Номенклатура) = Неопределено Тогда
				ВыведенныеСообщения.Вставить(СтрокаТаблицы.Номенклатура, Новый Соответствие);
			КонецЕсли;
			Если ВыведенныеСообщения.Получить(СтрокаТаблицы.Номенклатура).Получить(СтрокаТаблицы.Характеристика) = Неопределено Тогда
				ВыведенныеСообщения.Получить(СтрокаТаблицы.Номенклатура).Вставить(СтрокаТаблицы.Характеристика, Истина);
				ОбщегоНазначения.СообщитьПользователю(
					СтрШаблон(НСтр("ru = 'Не удалось распределить коды маркировки для номенклатуры %1 %2 по строкам электронного документа по причине:
						|	%3'"),
						СтрокаТаблицы.Номенклатура,
						СтрокаТаблицы.Характеристика,
						СтрокаТаблицы.ТекстОшибкиИС),,,,
					Отказ);
			КонецЕсли;
		КонецЕсли;		
	КонецЦикла;
	
КонецПроцедуры

// Возвращает значение номера ГТД по указанным параметрам.
//
// Параметры:
//	НомерТаможеннойДекларации - Строка - номер таможенной декларации.
//	СтранаПроисхождения - СправочникСсылка.СтраныМира - страна происхождения импортного товара.
//	НомерРНПТ - Булево - признак того, что является ли тип элемента номером РНПТ.
//	СуммаПоРНПТ - Число - требуется для прослеживаемых товаров.
//	ЭтоУПД - Булево -
//	ЕдиницаИзмерения - СправочникСсылка.УпаковкиЕдиницыИзмерения - единица измерения прослеживаемого товара
//
// Возвращаемое значение:
//	СправочникСсылка.НомераГТД - номер ГТД.
//
Функция НомерГТДПоСведениямТаможеннойДекларации(НомерТаможеннойДекларации,
	СтранаПроисхождения,
	НомерРНПТ,
	СуммаПоРНПТ = 0,
	ЭтоУПД = Ложь,
	ЕдиницаИзмерения = Неопределено)
	
	НомерГТД = Справочники.НомераГТД.ПустаяСсылка();
	
	Если Не ЗначениеЗаполнено(НомерТаможеннойДекларации) Тогда
		Возврат НомерГТД;
	КонецЕсли;
	
	НайтиТаможенныеДекларации(НомерГТД, НомерТаможеннойДекларации, СтранаПроисхождения, НомерРНПТ, СуммаПоРНПТ, ЭтоУПД);
	
	Если Не ЗначениеЗаполнено(НомерГТД) Тогда
		ПараметрыДляЗаполнения = Справочники.НомераГТД.ПараметрыДляЗаполненияЭлемента(НомерТаможеннойДекларации,
																						СтранаПроисхождения);
		ПараметрыДляЗаполнения.ЗаполнитьПорядковыйНомерТовараАвтоматически = Истина;
		ПараметрыДляЗаполнения.ТипНомераГТД = ?(НомерРНПТ,
												Перечисления.ТипыНомеровГТД.НомерРНПТ,
												Перечисления.ТипыНомеровГТД.НомерГТД);
		
		НомерГТДОбъект = Справочники.НомераГТД.СоздатьЭлемент();
		ПараметрыДляЗаполнения.СуммаПоРНПТ = СуммаПоРНПТ;
		НомерГТДОбъект.Заполнить(ПараметрыДляЗаполнения);
		Если НомерРНПТ И Не ЕдиницаИзмерения = Неопределено Тогда
			НомерГТДОбъект.ЕдиницаИзмерения = ЕдиницаИзмерения;
		КонецЕсли;
		
		РеквизитыГТД = Справочники.НомераГТД.РегистрационныйНомерИСтранаВвоза(НомерТаможеннойДекларации,
																				НомерГТДОбъект.ТипНомераГТД);
		ЗаполняемыеСвойства = "РегистрационныйНомер, СтранаВвозаНеРФ, ПорядковыйНомерТовара";
		
		ЗаполнитьЗначенияСвойств(НомерГТДОбъект, РеквизитыГТД, ЗаполняемыеСвойства);
		
		НомерГТДОбъект.Записать();
		НомерГТД = НомерГТДОбъект.Ссылка;
	КонецЕсли;
	
	Возврат НомерГТД;
	
КонецФункции

// Возвращает пустую таблицу прослеживаемых комплектующих номера ГТД.
//
// Возвращаемое значение:
//	ТаблицаЗначений - сведений о прослеживаемых комплектующих номера ГТД, со следующими колонками:
//		* Номенклатура - СправочникСсылка.Номенклатура - номенклатура копмлекта.
//		* НомерГТД - СправочникСсылка.НомераГТД - номер РНПТ комплекта.
//		* КоличествоПоРНПТ - Число - количество номеров РНПТ в единице измерения прослеживаемости.
//		* ЕдиницаИзмерения - СправочникСсылка.УпаковкиЕдиницыИзмерения - единица измерения прослеживаемости.
//		* СуммаПоРНПТ - Число - стоимость комплектующей по РНПТ.
//
Функция ТаблицаПрослеживаемыхКомплектующихНомераГТД()
	
	ОписаниеТипаНоменклатура		= Новый ОписаниеТипов("СправочникСсылка.Номенклатура");
	ОписаниеТипаНомераГТД			= Новый ОписаниеТипов("СправочникСсылка.НомераГТД");
	ОписаниеТипаЧисло				= Новый ОписаниеТипов("Число",
											Новый КвалификаторыЧисла(23, 11, ДопустимыйЗнак.Неотрицательный));
	ОписаниеТипаЕдиницаИзмерения	= Новый ОписаниеТипов("СправочникСсылка.УпаковкиЕдиницыИзмерения");
	ОписаниеТипаЧислоДенежныйТип	= Метаданные.ОпределяемыеТипы.ДенежнаяСуммаНеотрицательная.Тип;
	
	ТаблицаКомплектующих = Новый ТаблицаЗначений;
	ТаблицаКомплектующих.Колонки.Добавить("Номенклатура",		ОписаниеТипаНоменклатура);
	ТаблицаКомплектующих.Колонки.Добавить("НомерГТД",			ОписаниеТипаНомераГТД);
	ТаблицаКомплектующих.Колонки.Добавить("КоличествоПоРНПТ",	ОписаниеТипаЧисло);
	ТаблицаКомплектующих.Колонки.Добавить("ЕдиницаИзмерения",	ОписаниеТипаЕдиницаИзмерения);
	ТаблицаКомплектующих.Колонки.Добавить("СуммаПоРНПТ",		ОписаниеТипаЧислоДенежныйТип);
	
	Возврат ТаблицаКомплектующих;
	
КонецФункции

// Заполняет таблицу прослеживаемых комплектующих по сведениям о прослеживаемости.
//
// Параметры:
//	ТаблицаКомплектующих - см. ТаблицаПрослеживаемыхКомплектующихНомераГТД
//	СведенияОПрослеживаемости - ДеревоЗначений - сведения о прослеживаемости.
//	СтранаПроисхождения - СправочникСсылка.СтраныМира, Неопределено - страна происхождения комплектующих.
//	ПараметрыЗаполнения - см. ПараметрыЗаполненияСтрокиТоваровСведениямиОПрослеживаемости
//
Процедура ЗаполнитьТаблицуПрослеживаемыхКомплектующихНомераГТД(ТаблицаКомплектующих,
																СведенияОПрослеживаемости,
																СтранаПроисхождения,
																ПараметрыЗаполнения = Неопределено)
	
	Если ПараметрыЗаполнения = Неопределено Тогда
		ПараметрыЗаполнения = ПараметрыЗаполненияСтрокиТоваровСведениямиОПрослеживаемости();
	КонецЕсли;
	
	СопоставлениеЕдиницИзмерения	= ПараметрыЗаполнения.СопоставлениеЕдиницИзмерения;
	ИмяПоляКоличествоПоРНПТ			= ПараметрыЗаполнения.ИмяПоляКоличествоПоРНПТ;
	
	ПутьНомераСтроки = "СведенияОТоварах.НомерСтроки.СведенияОПрослеживаемости.НомерСтроки";
	
	Для Каждого СтрокаПрослеживаемости Из СведенияОПрослеживаемости.Строки Цикл
		НомерТаможеннойДекларации	= ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
										СтрокаПрослеживаемости,
										ПутьНомераСтроки + "." + "НомерТовара");
		ЕдиницаИзмеренияКод			= ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
										СтрокаПрослеживаемости,
										ПутьНомераСтроки + "." + "ЕдиницаИзмеренияКод");
		ЕдиницаИзмерения			= СсылкаНаОбъектПоКоду("ЕдиницыИзмерения",
															ЕдиницаИзмеренияКод,
															СопоставлениеЕдиницИзмерения);
		
		СтрокаКомплектующей = ТаблицаКомплектующих.Добавить();
		
		СуммаПоРНПТ			= ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
													СтрокаПрослеживаемости,
													ПутьНомераСтроки + "." + "СтоимостьБезНДС",
													Ложь);
		
		Если СуммаПоРНПТ = Неопределено Тогда
			СуммаПоРНПТ = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
				СтрокаПрослеживаемости,
				ПутьНомераСтроки + "." + "СтоимостьБезНДСПослеИзменения");
		КонецЕсли;
		
		СтрокаКомплектующей.СуммаПоРНПТ = СуммаПоРНПТ;
		
		СтрокаКомплектующей.НомерГТД			= НомерГТДПоСведениямТаможеннойДекларации(НомерТаможеннойДекларации,
																							СтранаПроисхождения,
																							Истина,
																							СтрокаКомплектующей.СуммаПоРНПТ,
																							Ложь,
																							ЕдиницаИзмерения);
		
		СтрокаКомплектующей.КоличествоПоРНПТ	= ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(
													СтрокаПрослеживаемости,
													ПутьНомераСтроки + "." + ИмяПоляКоличествоПоРНПТ);
		СтрокаКомплектующей.ЕдиницаИзмерения	= ЕдиницаИзмерения;
	КонецЦикла;
	
	ТаблицаКомплектующих.Свернуть("Номенклатура, НомерГТД, ЕдиницаИзмерения", "КоличествоПоРНПТ, СуммаПоРНПТ");
	
КонецПроцедуры

// Заполняет номер РНПТ комплекта в строке таблицы товаров.
//
// Параметры:
//	ТекущаяСтрока - СтрокаТабличнойЧасти - строка таблицы товаров.
//	Товары - ТабличнаяЧасть, ТаблицаЗначений - таблица товаров, в которой осуществляется заполнение строки.
//	ДанныеРНПТКомплекта - см. ЗакупкиСервер.НайтиИлиСоздатьСоставныеПрослеживаемыеНомераГТД
//
Процедура ОбработатьУказаниеРНПТКомплектаВСтрокеТоваров(ТекущаяСтрока, Товары, ДанныеРНПТКомплекта)
	
	ТекущаяСтрока.НомерГТД = ДанныеРНПТКомплекта.ОсновнойСоставнойНомерГТД;
	
	Если ДанныеРНПТКомплекта.ОстаточныйСоставнойНомерГТД <> Неопределено Тогда
		ДанныеТекущейСтроки = Новый Структура("Количество, Сумма, СуммаНДС, СуммаСНДС");
		ЗаполнитьЗначенияСвойств(ДанныеТекущейСтроки, ТекущаяСтрока);
		
		НоваяСтрока = Товары.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, ТекущаяСтрока);
		
		ОбработкаТабличнойЧастиКлиентСервер.ПересчитатьКоличествоУпаковокПриПодбореНомераГТД(
			ТекущаяСтрока,
			НоваяСтрока,
			"Количество");
		
		ТекущаяСтрока.КоличествоПоРНПТ	= ТекущаяСтрока.Количество;
		ТекущаяСтрока.Сумма				= ТекущаяСтрока.Цена * ТекущаяСтрока.Количество;
		ТекущаяСтрока.СуммаСНДС			= ?(ДанныеТекущейСтроки.Количество <> 0,
											Окр(ТекущаяСтрока.Количество * ТекущаяСтрока.СуммаСНДС / ДанныеТекущейСтроки.Количество, 2, 1),
											0);
		ТекущаяСтрока.СуммаНДС			= ?(ДанныеТекущейСтроки.СуммаСНДС <> 0,
											Окр(ТекущаяСтрока.СуммаСНДС * ДанныеТекущейСтроки.СуммаНДС / ДанныеТекущейСтроки.СуммаСНДС, 2, 1),
											0);
		
		НоваяСтрока.КоличествоПоРНПТ	= НоваяСтрока.Количество;
		НоваяСтрока.Сумма				= ДанныеТекущейСтроки.Сумма - ТекущаяСтрока.Сумма;
		НоваяСтрока.СуммаСНДС			= ДанныеТекущейСтроки.СуммаСНДС - ТекущаяСтрока.СуммаСНДС;
		НоваяСтрока.СуммаНДС			= ДанныеТекущейСтроки.СуммаНДС - ТекущаяСтрока.СуммаНДС;
		НоваяСтрока.НомерГТД			= ДанныеРНПТКомплекта.ОстаточныйСоставнойНомерГТД;
	КонецЕсли;
	
КонецПроцедуры

// Возвращает параметры заполнения строки товаров сведениями о прослеживаемости.
//
// Возвращаемое значение:
//	Структура - коллекция параметров. содержащая следующие свойства:
//		* СопоставлениеСтранМира - Соответствие Из КлючИЗначение - коллекция, содержащая сведения о странах мира:
//			** Ключ - Строка - код страны мира.
//			** Значение - СправочникСсылка.СтраныМира, Неопределено - ссылка страны мира.
//		* СопоставлениеЕдиницИзмерения - Соответствие Из КлючИЗначение - коллекция, содержащая сведения о единицах измерения:
//			** Ключ - Строка - код единицы измерения.
//			** Значение - СправочникСсылка.УпаковкиЕдиницыИзмерения, Неопределено - ссылка единицы измерения.
//		* ИмяПоляКоличествоПоРНПТ - Строка - имя поля, содержащее данные о количестве прослеживаемости в коллекции
//												сведений о прослеживаемости.
//		* ЭтоОтчетКомиссионераОПродажах - Булево - признак того, что заполняемая строка является строкой табличной части
//													отчета о продажах.
//
Функция ПараметрыЗаполненияСтрокиТоваровОтчетаКомиссионераСведениямиОПрослеживаемости()
	
	ПараметрыЗаполнения = Новый Структура;
	ПараметрыЗаполнения.Вставить("СопоставлениеСтранМира",			Новый Соответствие);
	ПараметрыЗаполнения.Вставить("СопоставлениеЕдиницИзмерения",	Новый Соответствие);
	ПараметрыЗаполнения.Вставить("ИмяПоляКоличествоПоРНПТ",			"Количество");
	ПараметрыЗаполнения.Вставить("ЭтоОтчетКомиссионераОПродажах",	Истина);
	
	Возврат ПараметрыЗаполнения;
	
КонецФункции

// Заполняет строку таблицы товаров сведениями о прослеживаемости.
//
// Параметры:
//	ТекущаяСтрока - СтрокаТабличнойЧасти - строка таблицы товаров.
//	Товары - ТабличнаяЧасть, ТаблицаЗначений - таблица товаров, в которой осуществляется заполнение строки.
//	СведенияОПрослеживаемости - ТаблицаЗначений - сведения о прослеживаемости.
//	ПараметрыЗаполнения - см. ПараметрыЗаполненияСтрокиТоваровСведениямиОПрослеживаемости
//
Процедура ЗаполнитьСтрокуТоваровОтчетаКомиссионераСведениямиОПрослеживаемости(ТекущаяСтрока,
																				Товары,
																				СведенияОПрослеживаемости,
																				ПараметрыЗаполнения = Неопределено)
	
	Если СведенияОПрослеживаемости = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если ПараметрыЗаполнения = Неопределено Тогда
		ПараметрыЗаполнения = ПараметрыЗаполненияСтрокиТоваровОтчетаКомиссионераСведениямиОПрослеживаемости();
	КонецЕсли;
	
	СтранаПроисхождения = Неопределено;
	СопоставлениеЕдиницИзмерения	= ПараметрыЗаполнения.СопоставлениеЕдиницИзмерения;
	ИмяПоляКоличествоПоРНПТ			= ПараметрыЗаполнения.ИмяПоляКоличествоПоРНПТ;
	
	Если СведенияОПрослеживаемости.Количество() = 1 Тогда
		НомерТаможеннойДекларации = СведенияОПрослеживаемости[0].НомерТовара;
		ЕдиницаИзмеренияКод = СведенияОПрослеживаемости[0].ЕдиницаИзмеренияКод;
		ЕдиницаИзмерения = СсылкаНаОбъектПоКоду("ЕдиницыИзмерения", ЕдиницаИзмеренияКод, СопоставлениеЕдиницИзмерения);
		ТекущаяСтрока.КоличествоПоРНПТ	= СведенияОПрослеживаемости[0][ИмяПоляКоличествоПоРНПТ];
		ТекущаяСтрока.НомерГТД			= НомерГТДПоСведениямТаможеннойДекларации(НомерТаможеннойДекларации,
																					СтранаПроисхождения,
																					ТекущаяСтрока.КоличествоПоРНПТ > 0,
																					0,
																					Ложь,
																					ЕдиницаИзмерения);
	Иначе
		ТекущаяСтрока.КоличествоПоРНПТ = ТекущаяСтрока.КоличествоУпаковок;
		
		ТаблицаКомплектующих = ТаблицаПрослеживаемыхКомплектующихНомераГТД();
		ЗаполнитьТаблицуПрослеживаемыхКомплектующихНомераГТДОтчетаКомиссионера(ТаблицаКомплектующих,
																		СведенияОПрослеживаемости,
																		СтранаПроисхождения,
																		ПараметрыЗаполнения);
		
		ДанныеРНПТКомплекта = ЗакупкиСервер.НайтиИлиСоздатьСоставныеПрослеживаемыеНомераГТД(
								ТаблицаКомплектующих,
								ТекущаяСтрока.КоличествоУпаковок,
								Дата(2399, 1, 1));
		
		ОбработатьУказаниеРНПТКомплектаВСтрокеТоваровОтчетаКомиссионера(
			ТекущаяСтрока,
			Товары,
			ДанныеРНПТКомплекта,
			ПараметрыЗаполнения.ЭтоОтчетКомиссионераОПродажах);
	КонецЕсли;
	
КонецПроцедуры

// Заполняет таблицу прослеживаемых комплектующих по сведениям о прослеживаемости.
//
// Параметры:
//	ТаблицаКомплектующих - см. ТаблицаПрослеживаемыхКомплектующихНомераГТД
//	СведенияОПрослеживаемости - ДеревоЗначений - сведения о прослеживаемости.
//	СтранаПроисхождения - СправочникСсылка.СтраныМира, Неопределено - страна происхождения комплектующих.
//	ПараметрыЗаполнения - см. ПараметрыЗаполненияСтрокиТоваровСведениямиОПрослеживаемости
//
Процедура ЗаполнитьТаблицуПрослеживаемыхКомплектующихНомераГТДОтчетаКомиссионера(ТаблицаКомплектующих,
																					СведенияОПрослеживаемости,
																					СтранаПроисхождения,
																					ПараметрыЗаполнения = Неопределено)
	
	Если ПараметрыЗаполнения = Неопределено Тогда
		ПараметрыЗаполнения = ПараметрыЗаполненияСтрокиТоваровСведениямиОПрослеживаемости();
	КонецЕсли;
	
	СопоставлениеЕдиницИзмерения	= ПараметрыЗаполнения.СопоставлениеЕдиницИзмерения;
	ИмяПоляКоличествоПоРНПТ			= ПараметрыЗаполнения.ИмяПоляКоличествоПоРНПТ;
	
	Для Каждого СтрокаПрослеживаемости Из СведенияОПрослеживаемости Цикл
		НомерТаможеннойДекларации	= СтрокаПрослеживаемости.НомерТовара;
		ЕдиницаИзмеренияКод			= СтрокаПрослеживаемости.ЕдиницаИзмеренияКод;
		ЕдиницаИзмерения			= СсылкаНаОбъектПоКоду("ЕдиницыИзмерения",
															ЕдиницаИзмеренияКод,
															СопоставлениеЕдиницИзмерения);
		
		СтрокаКомплектующей = ТаблицаКомплектующих.Добавить();
		СтрокаКомплектующей.НомерГТД			= НомерГТДПоСведениямТаможеннойДекларации(НомерТаможеннойДекларации,
																							СтранаПроисхождения,
																							Истина,
																							0,
																							Ложь,
																							ЕдиницаИзмерения);
		СтрокаКомплектующей.КоличествоПоРНПТ	= СтрокаПрослеживаемости[ИмяПоляКоличествоПоРНПТ];
		СтрокаКомплектующей.ЕдиницаИзмерения	= ЕдиницаИзмерения;
	КонецЦикла;
	
	ТаблицаКомплектующих.Свернуть("Номенклатура, НомерГТД, ЕдиницаИзмерения", "КоличествоПоРНПТ");
	
КонецПроцедуры

// Заполняет номер РНПТ комплекта в строке таблицы товаров.
//
// Параметры:
//	ТекущаяСтрока - СтрокаТабличнойЧасти - строка таблицы товаров.
//	Товары - ТабличнаяЧасть, ТаблицаЗначений - таблица товаров, в которой осуществляется заполнение строки.
//	ДанныеРНПТКомплекта - см. ЗакупкиСервер.НайтиИлиСоздатьСоставныеПрослеживаемыеНомераГТД
//	ОтчетОПродажах - Булево - признак того, что заполняемая строка является строкой табличной части отчета о продажах.
//
Процедура ОбработатьУказаниеРНПТКомплектаВСтрокеТоваровОтчетаКомиссионера(ТекущаяСтрока,
																			Товары,
																			ДанныеРНПТКомплекта,
																			ОтчетОПродажах)
	
	ТекущаяСтрока.НомерГТД = ДанныеРНПТКомплекта.ОсновнойСоставнойНомерГТД;
	
	Если ДанныеРНПТКомплекта.ОстаточныйСоставнойНомерГТД <> Неопределено Тогда
		ИменаПолей = "Количество, КоличествоУпаковок, СуммаНДС";
		Если ОтчетОПродажах Тогда
			ИменаПолей = ИменаПолей + ", " + "СуммаПродажи, СуммаВознаграждения, СуммаНДСВознаграждения";
		Иначе
			ИменаПолей = ИменаПолей + ", " + "Сумма, СуммаСНДС";
		КонецЕсли;
		
		ДанныеТекущейСтроки = Новый Структура(ИменаПолей);
		ЗаполнитьЗначенияСвойств(ДанныеТекущейСтроки, ТекущаяСтрока);
		
		НоваяСтрока = Товары.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, ТекущаяСтрока);
		
		ОбработкаТабличнойЧастиКлиентСервер.ПересчитатьКоличествоУпаковокПриПодбореНомераГТД(
			ТекущаяСтрока,
			НоваяСтрока,
			"КоличествоУпаковок");
		
		ТекущаяСтрока.Количество		= ТекущаяСтрока.КоличествоУпаковок * ДанныеТекущейСтроки.Количество
											/ ДанныеТекущейСтроки.КоличествоУпаковок;
		ТекущаяСтрока.КоличествоПоРНПТ	= ТекущаяСтрока.КоличествоУпаковок;
		
		НоваяСтрока.Количество			= ДанныеТекущейСтроки.Количество - ТекущаяСтрока.Количество;
		НоваяСтрока.КоличествоПоРНПТ	= НоваяСтрока.КоличествоУпаковок;
		НоваяСтрока.НомерГТД			= ДанныеРНПТКомплекта.ОстаточныйСоставнойНомерГТД;
		
		Если ОтчетОПродажах Тогда
			ТекущаяСтрока.СуммаПродажи				= ТекущаяСтрока.ЦенаПродажи * ТекущаяСтрока.КоличествоУпаковок; 
			ТекущаяСтрока.СуммаНДС					= ?(ДанныеТекущейСтроки.СуммаПродажи <> 0,
														Окр(ТекущаяСтрока.СуммаПродажи * ДанныеТекущейСтроки.СуммаНДС / ДанныеТекущейСтроки.СуммаПродажи, 2, 1),
														0);
			ТекущаяСтрока.СуммаВознаграждения		= ?(ДанныеТекущейСтроки.КоличествоУпаковок <> 0,
														Окр(ТекущаяСтрока.КоличествоУпаковок * ТекущаяСтрока.СуммаВознаграждения / ДанныеТекущейСтроки.КоличествоУпаковок, 2, 1),
														0);
			ТекущаяСтрока.СуммаНДСВознаграждения	= ?(ДанныеТекущейСтроки.СуммаВознаграждения <> 0,
														Окр(ТекущаяСтрока.СуммаНДСВознаграждения * ТекущаяСтрока.СуммаНДСВознаграждения / ДанныеТекущейСтроки.СуммаВознаграждения, 2, 1),
														0);
			
			НоваяСтрока.СуммаПродажи			= ДанныеТекущейСтроки.СуммаПродажи - ТекущаяСтрока.СуммаПродажи;
			НоваяСтрока.СуммаНДС				= ДанныеТекущейСтроки.СуммаНДС - ТекущаяСтрока.СуммаНДС;
			НоваяСтрока.СуммаВознаграждения		= ДанныеТекущейСтроки.СуммаВознаграждения - ТекущаяСтрока.СуммаВознаграждения;
			НоваяСтрока.СуммаНДСВознаграждения	= ДанныеТекущейСтроки.СуммаНДСВознаграждения - ТекущаяСтрока.СуммаНДСВознаграждения;
		Иначе
			ТекущаяСтрока.Сумма				= ТекущаяСтрока.Цена * ТекущаяСтрока.КоличествоУпаковок;
			ТекущаяСтрока.СуммаСНДС			= ?(ДанныеТекущейСтроки.КоличествоУпаковок <> 0,
												Окр(ТекущаяСтрока.КоличествоУпаковок * ТекущаяСтрока.СуммаСНДС / ДанныеТекущейСтроки.КоличествоУпаковок, 2, 1),
												0);
			ТекущаяСтрока.СуммаНДС			= ?(ДанныеТекущейСтроки.СуммаСНДС <> 0,
												Окр(ТекущаяСтрока.СуммаСНДС * ДанныеТекущейСтроки.СуммаНДС / ДанныеТекущейСтроки.СуммаСНДС, 2, 1),
												0);
			
			НоваяСтрока.Сумма				= ДанныеТекущейСтроки.Сумма - ТекущаяСтрока.Сумма;
			НоваяСтрока.СуммаСНДС			= ДанныеТекущейСтроки.СуммаСНДС - ТекущаяСтрока.СуммаСНДС;
			НоваяСтрока.СуммаНДС			= ДанныеТекущейСтроки.СуммаНДС - ТекущаяСтрока.СуммаНДС;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьРасхожденияДляПервичногоДокумента(Организация, СведенияОТоварах, Расхождения, ПараметрыЗаполненияСтрокиТоваров)
	
	Для Каждого СведенияОТоваре Из СведенияОТоварах.Строки Цикл
		
		НоваяСтрока = Расхождения.Добавить();
	
		СтавкаНДС = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.НалоговаяСтавка");
		НоваяСтрока.СтавкаНДС = ?(СтавкаНДС = "НДС исчисляется налоговым агентом", УчетНДСУП.СтавкаНДСПоУмолчанию(Организация, ТекущаяДатаСеанса(), Истина), СтавкаНДС);
		
		СуммаНДСДо = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СуммаНалогаДоКорректировки");
		СуммаНДСПосле = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СуммаНалога");
		КоличествоДо = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.КоличествоДоКорректировки");
		КоличествоПосле = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.Количество");
		СуммаДо = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровБезНалогаДоКорректировки");
		СуммаПосле = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровБезНалога");
		СуммаСНДСДо = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогомДоКорректировки");
		СуммаСНДСПосле = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогом");
		
		НоваяСтрока.Цена = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре, "СведенияОТоварах.НомерСтроки.ЦенаЗаЕдиницуИзмерения");		
		Если ЗначениеЗаполнено(СуммаНДСПосле) И ЗначениеЗаполнено(СуммаНДСДо) Тогда
			НоваяСтрока.СуммаНДС = СуммаНДСПосле - СуммаНДСДо;
		КонецЕсли;
		НоваяСтрока.Количество = КоличествоПосле - КоличествоДо;
		НоваяСтрока.Сумма = СуммаПосле - СуммаДо;
		НоваяСтрока.СуммаСНДС = СуммаСНДСПосле - СуммаСНДСДо;
		
		Сопоставление = СведенияОТоваре.Строки.Найти(
			"СведенияОТоварах.НомерСтроки.Сопоставление", "ПолныйПуть", Истина);
		Если Сопоставление <> Неопределено Тогда
			
			Номенклатура = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.Сопоставление.НоменклатураИБ");
			Если ЗначениеЗаполнено(Номенклатура) Тогда
				НоваяСтрока.Номенклатура = Номенклатура;
			КонецЕсли;
			
			Характеристика = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.Сопоставление.ХарактеристикаИБ");
			Если ЗначениеЗаполнено(Характеристика) Тогда
				НоваяСтрока.Характеристика = Характеристика;
			КонецЕсли;
			
			Упаковка = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(СведенияОТоваре,
				"СведенияОТоварах.НомерСтроки.Сопоставление.УпаковкаИБ");
			Если ЗначениеЗаполнено(Упаковка) Тогда
				НоваяСтрока.Упаковка = Упаковка;
			КонецЕсли;
			
		КонецЕсли;

		ЭтоИмущество = Истина;
		
		ТипНоменклатуры = НоваяСтрока.Номенклатура.ТипНоменклатуры;
		Если ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Услуга") Тогда
			НоваяСтрока.СписатьНаРасходы = Истина;
			ЭтоИмущество = Ложь;
		КонецЕсли;
		
		Если ОбщегоНазначения.ЗначениеРеквизитаОбъекта(НоваяСтрока.Номенклатура, "ВестиУчетПоГТД") = Истина Тогда
			ВестиУчетПоГТД = Истина;
		Иначе
			ВестиУчетПоГТД = Ложь;
		КонецЕсли;
		
		Если ЭтоИмущество
			И ВестиУчетПоГТД Тогда
			
			СведенияОПрослеживаемости		= СведенияОТоваре.Строки.Найти(
												"СведенияОТоварах.НомерСтроки.СведенияОПрослеживаемости",
												"ПолныйПуть",
												Истина);
			СведенияОТаможеннойДекларации	= СведенияОТоваре.Строки.Найти(
												"СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации",
												"ПолныйПуть",
												Истина);
			
			ЗаполнитьСтрокуРасхожденийСведениямиОПрослеживаемости(НоваяСтрока,
																Расхождения,
																СведенияОТоваре,
																СведенияОПрослеживаемости,
																СведенияОТаможеннойДекларации,
																ПараметрыЗаполненияСтрокиТоваров);
			
			ЗаполнитьСтрокуТоваровСведениямиОТаможеннойДекларации(НоваяСтрока,
																	СведенияОТаможеннойДекларации,
																	ПараметрыЗаполненияСтрокиТоваров);
			
		КонецЕсли;
		
	КонецЦикла;
	
	// заполним Характеристики и Упаковки по соответствию из НоменклатурыПоставщика,
	//Переносим значения из колонки СуммаСкидки в СуммаРучнойСкидки, т.к. название реквизита табличной части документа
	//не совпадает с названием реквизита СтрокиДляЗагрузки

	Для Каждого ТекСтрока Из Расхождения Цикл 
		ТекСтрока.КоличествоУпаковок = ТекСтрока.Количество;
		// заполним Количество с учетом единиц измерения
		Если ЗначениеЗаполнено(ТекСтрока.Упаковка) Тогда
			ТекКоэффициент = Справочники.УпаковкиЕдиницыИзмерения.КоэффициентУпаковки(ТекСтрока.Упаковка, ТекСтрока.Номенклатура);
		Иначе
			ТекКоэффициент = 1;
		КонецЕсли;
		ТекСтрока.Количество = ТекСтрока.КоличествоУпаковок * ТекКоэффициент;
	КонецЦикла;
	
КонецПроцедуры

// Проверяет наличие товаров ОСУ в документе.
//
// Параметры:
//  ДокументРеализации - ДокументСсылка.РеализацияТоваровУслуг - ссылка на документ, по которому необходимо проверить наличие товаров ОСУ.
//
// Возвращаемое значение:
//  Булево - результат проверки, если Истина, то есть товары ОСУ.
//
Функция ЕстьТоварыОСУ(ДокументРеализации) Экспорт
	
	Запрос = Новый Запрос;
	
	Запрос.Текст = "ВЫБРАТЬ
	|	ТаблицаДокумента.Ссылка КАК Ссылка,
	|	ТаблицаДокумента.ШтрихкодУпаковки КАК Штрихкод
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.ШтрихкодыУпаковок КАК ТаблицаДокумента
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтгрузкаТоваровИСМП КАК ДокументыПрямогоОбмена
	|		ПО ТаблицаДокумента.Ссылка = ДокументыПрямогоОбмена.ДокументОснование
	|		И НЕ ДокументыПрямогоОбмена.ПометкаУдаления
	|ГДЕ
	|	ТаблицаДокумента.Ссылка = &ДокументРеализации
	|	И ДокументыПрямогоОбмена.Ссылка ЕСТЬ NULL
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РеализацияТоваровУслугТовары.Номенклатура,
	|	РеализацияТоваровУслугТовары.Характеристика,
	|	РеализацияТоваровУслугТовары.Количество,
	|	РеализацияТоваровУслугТовары.Ссылка
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтгрузкаТоваровИСМП КАК ДокументыПрямогоОбмена
	|		ПО РеализацияТоваровУслугТовары.Ссылка = ДокументыПрямогоОбмена.ДокументОснование
	|		И НЕ ДокументыПрямогоОбмена.ПометкаУдаления
	|ГДЕ
	|	РеализацияТоваровУслугТовары.Ссылка = &ДокументРеализации
	|	И ДокументыПрямогоОбмена.Ссылка ЕСТЬ NULL";
	
	Запрос.УстановитьПараметр("ДокументРеализации", ДокументРеализации);
	Пакет = Запрос.ВыполнитьПакет();
	ШтрихкодыУпаковок = Пакет[0].Выгрузить();
	Товары = Пакет[1].Выгрузить();
	ТаблицаУпаковокСТоварнымиДанными = ЭлектронноеВзаимодействиеИСМП.ЧастичноеСодержимоеИКодыОСУ(
		ШтрихкодыУпаковок, Товары, ШтрихкодированиеОбщегоНазначенияИС.ПараметрыСканирования(ДокументРеализации));

	Для Каждого СтрокаТаблицы Из ТаблицаУпаковокСТоварнымиДанными Цикл
		Если СтрокаТаблицы.ВидУпаковки = Перечисления.ВидыУпаковокИС.ОбъемноСортовойУчет Тогда
			Возврат Истина;
		КонецЕсли;
	КонецЦикла;
		
	Возврат Ложь;
	
КонецФункции

Процедура ЗаписатьСправочник(СправочникОбъект)
	
	СправочникОбъект.ДополнительныеСвойства.Вставить("ПроверитьЗаполнениеБезВыводаОшибок");
	
	Если СправочникОбъект.ЭтоНовый() И СправочникОбъект.ПроверитьЗаполнение() Тогда
		СправочникОбъект.ОбменДанными.Загрузка = Ложь;
		СправочникОбъект.Записать();
	Иначе
		СправочникОбъект.ОбменДанными.Загрузка = Истина;
		СправочникОбъект.Записать();
	КонецЕсли;
	СправочникОбъект.Разблокировать();
	
КонецПроцедуры

#Область ВспомогательныеМетоды_ДоговорнойДокумент101

Процедура СтавкаНДСПоДаннымДоговорногоДокумента101(СтавкаНДС, СтрокаОбщейИнформацииПредмета)
	
	Если ЗначениеЗаполнено(СтрокаОбщейИнформацииПредмета.СтавкаНДС) Тогда
		
		СоответствиеСтавокНДС = Новый Соответствие;
		ЗаполнитьСоответствиеСтавокНДС(СоответствиеСтавокНДС);
		
		СтавкаНДС = СоответствиеСтавокНДС.Получить(СтрЗаменить(СтрокаОбщейИнформацииПредмета.СтавкаНДС, "%", ""));
		
	ИначеЕсли СтрокаОбщейИнформацииПредмета.БезНДС Тогда
		
		СтавкаНДС =  Перечисления.СтавкиНДС.БезНДС;
		
	КонецЕсли;
	
КонецПроцедуры

Функция ОрганизацияПоДаннымДоговорногоДокумента101(Данные, ТипыСторон)
	
	Организация = Неопределено;
	
	Если ТипЗнч(Данные) = ТипыСторон.Предприниматель Тогда
		
		ИНН = Данные.ИНН;
		Запрос = Новый Запрос();
		Запрос.Текст = 
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
			|	Организации.Ссылка
			|ИЗ
			|	Справочник.Организации КАК Организации
			|ГДЕ
			|	Организации.ИНН = &ИНН
			|	И НЕ Организации.ПометкаУдаления";
		Запрос.УстановитьПараметр("ИНН", ИНН);
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			Организация = Выборка.Ссылка;
		КонецЕсли;
		
	ИначеЕсли ТипЗнч(Данные) = ТипыСторон.ИностранноеЛицо Тогда

		НаименованиеПолное = Данные.НаименованиеПолное;
		Если ЗначениеЗаполнено(НаименованиеПолное) Тогда
			Запрос = Новый Запрос();
			Запрос.Текст = 
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
				|	Организации.Ссылка КАК Ссылка
				|ИЗ
				|	Справочник.Организации КАК Организации
				|ГДЕ
				|	Организации.НаименованиеПолное = &НаименованиеПолное
				|	И НЕ Организации.ПометкаУдаления";
			Запрос.УстановитьПараметр("НаименованиеПолное", НаименованиеПолное);
			
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				Организация = Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
		
	ИначеЕсли ТипЗнч(Данные) = ТипыСторон.Организация Тогда
		
		ИНН = Данные.ИНН;
		Если Данные.КПП.Количество() > 0 Тогда
			КПП = Данные.КПП[0];
		Иначе
			КПП = "";
		КонецЕсли;
		
		Запрос = Новый Запрос();
		Запрос.Текст = 
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
			|	Организации.Ссылка
			|ИЗ
			|	Справочник.Организации КАК Организации
			|ГДЕ
			|	Организации.ИНН = &ИНН
			|	И Организации.КПП = &КПП
			|	И НЕ Организации.ПометкаУдаления";
		Запрос.УстановитьПараметр("ИНН", ИНН);
		Запрос.УстановитьПараметр("КПП", КПП);
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			Организация = Выборка.Ссылка;
		КонецЕсли;
		
	ИначеЕсли ТипЗнч(Данные) = ТипыСторон.ФизическоеЛицо Тогда

		ИНН = Данные.ИНН;
		ПолноеНаименование = ПолучитьПолноеНаименованиеФизЛицаДоговорногоДокумента101(Данные.ФИО);

		Если ЗначениеЗаполнено(ИНН) Или ЗначениеЗаполнено(НаименованиеПолное) Тогда 
			Запрос = Новый Запрос();
			Запрос.Текст = 
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
				|	Организации.Ссылка КАК Ссылка
				|ИЗ
				|	Справочник.Организации КАК Организации
				|ГДЕ
				|	Организации.ИНН = &ИНН";
			Если ЗначениеЗаполнено(ИНН) Тогда
				Запрос.УстановитьПараметр("ИНН", ИНН);
			Иначе
				Запрос.Текст = СтрЗаменить(Запрос.Текст, "Организации.ИНН = &ИНН",
					"Организации.НаименованиеПолное = &НаименованиеПолное");
				Запрос.УстановитьПараметр("НаименованиеПолное", ПолноеНаименование);
			КонецЕсли;
			
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				Организация = Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Организация;
	
КонецФункции

Функция КонтрагентПоДаннымДоговорногоДокумента101(Данные, ТипыСторон)
	
	Контрагент = Неопределено;
	
	Если ТипЗнч(Данные) = ТипыСторон.Предприниматель Тогда
		
		ИНН = Данные.ИНН;
		Запрос = Новый Запрос();
		Запрос.Текст = 
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
			|	Контрагенты.Ссылка
			|ИЗ
			|	Справочник.Контрагенты КАК Контрагенты
			|ГДЕ
			|	Контрагенты.ИНН = &ИНН
			|	И НЕ Контрагенты.ПометкаУдаления";
		Запрос.УстановитьПараметр("ИНН", ИНН);
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			Контрагент = Выборка.Ссылка;
		КонецЕсли;
		
	ИначеЕсли ТипЗнч(Данные) = ТипыСторон.ИностранноеЛицо Тогда

		НаименованиеПолное = Данные.НаименованиеПолное;
		Если ЗначениеЗаполнено(НаименованиеПолное) Тогда
			Запрос = Новый Запрос();
			Запрос.Текст = 
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
				|	Контрагенты.Ссылка КАК Ссылка
				|ИЗ
				|	Справочник.Контрагенты КАК Контрагенты
				|ГДЕ
				|	Контрагенты.НаименованиеПолное = &НаименованиеПолное
				|	И НЕ Контрагенты.ПометкаУдаления";
			Запрос.УстановитьПараметр("НаименованиеПолное", НаименованиеПолное);
			
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				Контрагент = Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
		
	ИначеЕсли ТипЗнч(Данные) = ТипыСторон.Организация Тогда
		
		ИНН = Данные.ИНН;
		Если Данные.КПП.Количество() > 0 Тогда
			КПП = Данные.КПП[0];
		Иначе
			КПП = "";
		КонецЕсли;
		
		Запрос = Новый Запрос();
		Запрос.Текст = 
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
			|	Контрагенты.Ссылка
			|ИЗ
			|	Справочник.Контрагенты КАК Контрагенты
			|ГДЕ
			|	Контрагенты.ИНН = &ИНН
			|	И Контрагенты.КПП = &КПП
			|	И НЕ Контрагенты.ПометкаУдаления";
		Запрос.УстановитьПараметр("ИНН", ИНН);
		Запрос.УстановитьПараметр("КПП", КПП);
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			Контрагент = Выборка.Ссылка;
		КонецЕсли;
		
	ИначеЕсли ТипЗнч(Данные) = ТипыСторон.ФизическоеЛицо Тогда

		ИНН = Данные.ИНН;
		ПолноеНаименование = ПолучитьПолноеНаименованиеФизЛицаДоговорногоДокумента101(Данные.ФИО);
		
		Если ЗначениеЗаполнено(ИНН) Или ЗначениеЗаполнено(НаименованиеПолное) Тогда 
			Запрос = Новый Запрос();
			Запрос.Текст = 
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
				|	Контрагенты.Ссылка КАК Ссылка
				|ИЗ
				|	Справочник.Контрагенты КАК Контрагенты
				|ГДЕ
				|	Контрагенты.ИНН = &ИНН";
			Если ЗначениеЗаполнено(ИНН) Тогда
				Запрос.УстановитьПараметр("ИНН", ИНН);
			Иначе
				Запрос.Текст = СтрЗаменить(Запрос.Текст, "Контрагенты.ИНН = &ИНН",
					"Контрагенты.НаименованиеПолное = &НаименованиеПолное");
				Запрос.УстановитьПараметр("НаименованиеПолное", ПолноеНаименование);
			КонецЕсли;
			
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				Контрагент = Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Контрагент;

КонецФункции

Функция ОрганизацияПоДаннымДоговорногоДокумента101XML(ИНН, КПП, ОГРН, ОКПО, НаименованиеПолное)
	
	Организация = Неопределено;
		
	Запрос = Новый Запрос();
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
		|	Организации.Ссылка
		|ИЗ
		|	Справочник.Организации КАК Организации
		|ГДЕ
		|	(&ИНН = Неопределено ИЛИ Организации.ИНН = &ИНН)
		|	И (&КПП = Неопределено ИЛИ Организации.КПП = &КПП)
		|	И (&ОГРН = Неопределено ИЛИ Организации.ОГРН = &ОГРН)
		|	И (&ОКПО = Неопределено ИЛИ Организации.КодПоОКПО = &ОКПО)
		|	И (&НаименованиеПолное = Неопределено ИЛИ Организации.НаименованиеПолное = &НаименованиеПолное)
		|	И НЕ Организации.ПометкаУдаления";
	
	Запрос.УстановитьПараметр("ИНН", ИНН);
	Запрос.УстановитьПараметр("КПП", КПП);
	Запрос.УстановитьПараметр("ОГРН", ОГРН);
    Запрос.УстановитьПараметр("ОКПО", ОКПО);
	Запрос.УстановитьПараметр("НаименованиеПолное", НаименованиеПолное);

	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Организация = Выборка.Ссылка;
	КонецЕсли;
			
	Возврат Организация;
	
КонецФункции

Функция КонтрагентПоДаннымДоговорногоДокумента101XML(ИНН, КПП, ОГРН, ОКПО, НаименованиеПолное)
	
	Контрагент = Неопределено;
		
	Запрос = Новый Запрос();
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
		|	Контрагенты.Ссылка
		|ИЗ
		|	Справочник.Контрагенты КАК Контрагенты
		|ГДЕ
		|	(&ИНН = Неопределено ИЛИ Контрагенты.ИНН = &ИНН)
		|	И (&КПП = Неопределено ИЛИ Контрагенты.КПП = &КПП)
		|	И (&ОГРН = Неопределено ИЛИ Контрагенты.РегистрационныйНомер = &ОГРН)
		|	И (&ОКПО = Неопределено ИЛИ Контрагенты.КодПоОКПО = &ОКПО)
		|	И (&НаименованиеПолное = Неопределено ИЛИ Контрагенты.НаименованиеПолное = &НаименованиеПолное)
		|	И НЕ Контрагенты.ПометкаУдаления";
	
	Запрос.УстановитьПараметр("ИНН", ИНН);
	Запрос.УстановитьПараметр("КПП", КПП);
	Запрос.УстановитьПараметр("ОГРН", ОГРН);
	Запрос.УстановитьПараметр("ОКПО", ОКПО);
	Запрос.УстановитьПараметр("НаименованиеПолное", НаименованиеПолное);

	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Контрагент = Выборка.Ссылка;
	КонецЕсли;
			
	Возврат Контрагент;
	
КонецФункции

Функция БанковскийСчетПоДаннымДоговорногоДокумента101(Данные, Организация)
	
	БанковскийСчет = Неопределено;
		
	Если Организация = Неопределено Тогда
		Возврат БанковскийСчет; 
	КонецЕсли; 
	
	ИНН = Данные.ИНН;
	НомерСчета = Данные.НомерСчета;
	Наименование = Данные.Наименование;
	БИКБанка = Данные.БИК;
	КорреспондентскийСчет = Данные.КорреспондентскийСчет;
	
	Запрос = Новый Запрос;
	ТекстЗапроса =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
	|	БанковскиеСчета.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.БанковскиеСчетаОрганизаций КАК БанковскиеСчета
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Организации КАК СправочникВладелец
	|		ПО БанковскиеСчета.Владелец = СправочникВладелец.Ссылка
	|ГДЕ
	|	БанковскиеСчета.Владелец = &ВладелецСчета
	|	И БанковскиеСчета.ПометкаУдаления = ЛОЖЬ
	|	И БанковскиеСчета.НомерСчета = &НомерСчета
	|	И БанковскиеСчета.НаименованиеБанка = &Наименование
	|	И БанковскиеСчета.БИКБанка = &БИКБанка
	|	И БанковскиеСчета.КоррСчетБанка = &КорреспондентскийСчет
	|	И БанковскиеСчета.Банк.ИНН = &ИНН";
	
	Запрос.УстановитьПараметр("ВладелецСчета", Организация);
	Запрос.УстановитьПараметр("НомерСчета", НомерСчета); 
	Запрос.УстановитьПараметр("Наименование", Наименование); 
	Запрос.УстановитьПараметр("БИКБанка", БИКБанка); 
	Запрос.УстановитьПараметр("КорреспондентскийСчет", КорреспондентскийСчет);
	Запрос.УстановитьПараметр("ИНН", ИНН);
	
	Запрос.Текст = ТекстЗапроса;
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		БанковскийСчет = Выборка.Ссылка;
	КонецЕсли;
					
	Возврат БанковскийСчет;
	
КонецФункции

Функция БанковскийСчетКонтрагентаПоДаннымДоговорногоДокумента101(Данные, Контрагент)
	
	БанковскийСчет = Неопределено;
		
	Если Контрагент = Неопределено Тогда
		Возврат БанковскийСчет; 
	КонецЕсли; 
	
	ИНН = Данные.ИНН;
    НомерСчета = Данные.НомерСчета;
	Наименование = Данные.Наименование;
	БИКБанка = Данные.БИК;
	КорреспондентскийСчет = Данные.КорреспондентскийСчет;
	
	Запрос = Новый Запрос;
	ТекстЗапроса =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
	|	БанковскиеСчета.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.БанковскиеСчетаКонтрагентов КАК БанковскиеСчета
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК СправочникВладелец
	|		ПО БанковскиеСчета.Владелец = СправочникВладелец.Ссылка
	|ГДЕ
	|	БанковскиеСчета.Владелец = &ВладелецСчета
	|	И БанковскиеСчета.ПометкаУдаления = ЛОЖЬ
	|	И БанковскиеСчета.НомерСчета = &НомерСчета
	|	И БанковскиеСчета.НаименованиеБанка = &Наименование
	|	И БанковскиеСчета.БИКБанка = &БИКБанка
	|	И БанковскиеСчета.КоррСчетБанка = &КорреспондентскийСчет
	|	И БанковскиеСчета.Банк.ИНН = &ИНН";
	
	Запрос.УстановитьПараметр("ВладелецСчета", Контрагент);
	Запрос.УстановитьПараметр("НомерСчета", НомерСчета); 
	Запрос.УстановитьПараметр("Наименование", Наименование); 
	Запрос.УстановитьПараметр("БИКБанка", БИКБанка); 
	Запрос.УстановитьПараметр("КорреспондентскийСчет", КорреспондентскийСчет);
	Запрос.УстановитьПараметр("ИНН", ИНН);
	
	Запрос.Текст = ТекстЗапроса;
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		БанковскийСчет = Выборка.Ссылка;
	КонецЕсли;
					
	Возврат БанковскийСчет;
	
КонецФункции

Функция БанковскийСчетПоДаннымДоговорногоДокумента101XML(Организация, НомерСчета, Наименование, НаименованиеИн, БИКБанка, БИКИнБанка, КоррСчет)
	
	БанковскийСчет = Неопределено;
		
	Если Организация = Неопределено Тогда
		Возврат БанковскийСчет; 
	КонецЕсли; 
		
	Запрос = Новый Запрос;
	ТекстЗапроса =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
	|	БанковскиеСчета.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.БанковскиеСчетаОрганизаций КАК БанковскиеСчета
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Организации КАК СправочникВладелец
	|		ПО БанковскиеСчета.Владелец = СправочникВладелец.Ссылка
	|ГДЕ
	|	БанковскиеСчета.Владелец = &ВладелецСчета
	|	И БанковскиеСчета.ПометкаУдаления = ЛОЖЬ
	|	И (&НомерСчета = Неопределено ИЛИ БанковскиеСчета.НомерСчета = &НомерСчета)  
	|	И (&Наименование = Неопределено ИЛИ БанковскиеСчета.НаименованиеБанка = &Наименование)
	|	И (&НаименованиеИн = Неопределено ИЛИ БанковскиеСчета.НаименованиеБанкаМеждународное = &НаименованиеИн)
    |	И (&БИКБанка = Неопределено ИЛИ БанковскиеСчета.БИКБанка = &БИКБанка)
	|	И (&БИКИнБанка = Неопределено ИЛИ БанковскиеСчета.СВИФТБанка = &БИКИнБанка)
    |	И (&КоррСчет = Неопределено ИЛИ БанковскиеСчета.КоррСчетБанка = &КоррСчет)";
	
	Запрос.УстановитьПараметр("ВладелецСчета", Организация);
	Запрос.УстановитьПараметр("НомерСчета", НомерСчета); 
	Запрос.УстановитьПараметр("Наименование", Наименование); 
	Запрос.УстановитьПараметр("НаименованиеИн", НаименованиеИн);
	Запрос.УстановитьПараметр("БИКБанка", БИКБанка); 
	Запрос.УстановитьПараметр("БИКИнБанка", БИКИнБанка); 
	Запрос.УстановитьПараметр("КоррСчет", КоррСчет);
	
	Запрос.Текст = ТекстЗапроса;
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		БанковскийСчет = Выборка.Ссылка;
	КонецЕсли;
					
	Возврат БанковскийСчет;
	
КонецФункции

Функция БанковскийСчетКонтрагентаПоДаннымДоговорногоДокумента101XML(Контрагент, НомерСчета, Наименование, НаименованиеИн, БИКБанка, БИКИнБанка, КоррСчет)
	
	БанковскийСчет = Неопределено;
		
	Если Контрагент = Неопределено Тогда
		Возврат БанковскийСчет; 
	КонецЕсли; 
		
	Запрос = Новый Запрос;
	ТекстЗапроса =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
	|	БанковскиеСчета.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.БанковскиеСчетаКонтрагентов КАК БанковскиеСчета
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК СправочникВладелец
	|		ПО БанковскиеСчета.Владелец = СправочникВладелец.Ссылка
	|ГДЕ
	|	БанковскиеСчета.Владелец = &ВладелецСчета
	|	И БанковскиеСчета.ПометкаУдаления = ЛОЖЬ
	|	И (&НомерСчета = Неопределено ИЛИ БанковскиеСчета.НомерСчета = &НомерСчета)  
	|	И (&Наименование = Неопределено ИЛИ БанковскиеСчета.НаименованиеБанка = &Наименование)
	|	И (&НаименованиеИн = Неопределено ИЛИ БанковскиеСчета.НаименованиеБанкаМеждународное = &НаименованиеИн)
    |	И (&БИКБанка = Неопределено ИЛИ БанковскиеСчета.БИКБанка = &БИКБанка)
	|	И (&БИКИнБанка = Неопределено ИЛИ БанковскиеСчета.СВИФТБанка = &БИКИнБанка)
    |	И (&КоррСчет = Неопределено ИЛИ БанковскиеСчета.КоррСчетБанка = &КоррСчет)";
	
	Запрос.УстановитьПараметр("ВладелецСчета", Контрагент);
	Запрос.УстановитьПараметр("НомерСчета", НомерСчета); 
	Запрос.УстановитьПараметр("Наименование", Наименование); 
	Запрос.УстановитьПараметр("НаименованиеИн", НаименованиеИн);
	Запрос.УстановитьПараметр("БИКБанка", БИКБанка); 
	Запрос.УстановитьПараметр("БИКИнБанка", БИКИнБанка); 
	Запрос.УстановитьПараметр("КоррСчет", КоррСчет);
	
	Запрос.Текст = ТекстЗапроса;
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		БанковскийСчет = Выборка.Ссылка;
	КонецЕсли;
					
	Возврат БанковскийСчет;
	
КонецФункции

Функция ПолучитьПолноеНаименованиеФизЛицаДоговорногоДокумента101(ДанныеФИО)
	
	Если ЗначениеЗаполнено(ДанныеФИО) Тогда
		Фамилия  = ДанныеФИО.Фамилия;
		Имя      = ДанныеФИО.Имя;
		Отчество = ДанныеФИО.Отчество;
		
		ЭлементыИмени = Новый Массив;
		Если ЗначениеЗаполнено(Фамилия) Тогда
			ЭлементыИмени.Добавить(Фамилия);
		КонецЕсли;
		Если ЗначениеЗаполнено(Имя) Тогда
			ЭлементыИмени.Добавить(Имя);
		КонецЕсли;
		Если ЗначениеЗаполнено(Отчество) Тогда
			ЭлементыИмени.Добавить(Отчество);
		КонецЕсли;
		ПолноеНаименование = СтрСоединить(ЭлементыИмени, " ");
	Иначе
		ПолноеНаименование = "";
	КонецЕсли;
	
	Возврат ПолноеНаименование;
	
КонецФункции

Процедура ПроверитьУстановитьВалютуПоДаннымДоговорногоДокумента101(ПолеВалюта, КодВалютыПоиска)
	
	ЭлектронноеВзаимодействиеПереопределяемый.НайтиСсылкуНаОбъект("Валюты", ПолеВалюта, КодВалютыПоиска);
	
КонецПроцедуры

Процедура ЗаполнитьСоответствиеПорядковРасчетов(Соответствие)
	
	Соответствие.Вставить("По договорам", Перечисления.ПорядокРасчетов.ПоДоговорамКонтрагентов);
	Соответствие.Вставить("Аванс по договорам, долг по накладным", Перечисления.ПорядокРасчетов.ПоДоговорамНакладным);
	Соответствие.Вставить("По заказам", Перечисления.ПорядокРасчетов.ПоЗаказам);
	Соответствие.Вставить("Аванс по заказам, долг по накладным", Перечисления.ПорядокРасчетов.ПоЗаказамНакладным);
	Соответствие.Вставить("По расчетным документам", Перечисления.ПорядокРасчетов.ПоНакладным);
	
КонецПроцедуры

Функция ОписаниеДанныхПриЗагрузкеДоговорногоДокумента101()
	
	ДанныеЗаполнения = Новый Структура;
	ДанныеЗаполнения.Вставить("Дата", Дата(1, 1, 1));
	ДанныеЗаполнения.Вставить("Номер", "");
	ДанныеЗаполнения.Вставить("ДатаНачалаДействия", Дата(1, 1, 1));
	ДанныеЗаполнения.Вставить("ДатаОкончанияДействия", Дата(1, 1, 1));
	ДанныеЗаполнения.Вставить("Наименование", "");
	ДанныеЗаполнения.Вставить("Статус", Перечисления.СтатусыДоговоровКонтрагентов.ПустаяСсылка());
	ДанныеЗаполнения.Вставить("Организация", Справочники.Организации.ПустаяСсылка());
	ДанныеЗаполнения.Вставить("Контрагент", Справочники.Контрагенты.ПустаяСсылка());
	ДанныеЗаполнения.Вставить("ТипДоговора", Перечисления.ТипыДоговоров.ПустаяСсылка());
	ДанныеЗаполнения.Вставить("ХозяйственнаяОперация", Перечисления.ХозяйственныеОперации.ПустаяСсылка());
	ДанныеЗаполнения.Вставить("БанковскийСчет", Справочники.БанковскиеСчетаОрганизаций.ПустаяСсылка());
	ДанныеЗаполнения.Вставить("БанковскийСчетКонтрагента", Справочники.БанковскиеСчетаКонтрагентов.ПустаяСсылка());
	ДанныеЗаполнения.Вставить("ВалютаВзаиморасчетов", Справочники.Валюты.ПустаяСсылка());
	ДанныеЗаполнения.Вставить("ВариантКурсаДоговора", Перечисления.ВариантыКурсаДоговора.ПустаяСсылка());
	ДанныеЗаполнения.Вставить("СтавкаНДС", Справочники.СтавкиНДС.ПустаяСсылка());
	ДанныеЗаполнения.Вставить("Сумма", 0);
	ДанныеЗаполнения.Вставить("Менеджер", Справочники.Пользователи.ПустаяСсылка());
	ДанныеЗаполнения.Вставить("ПорядокРасчетов", Перечисления.ПорядокРасчетов.ПустаяСсылка());
	ДанныеЗаполнения.Вставить("СрокОплаты", 0);
	ДанныеЗаполнения.Вставить("СпособДоставки", Перечисления.СпособыДоставки.ПустаяСсылка());

	Возврат ДанныеЗаполнения;
	
КонецФункции

#КонецОбласти

#Область СервисShare

// Заполняет присоединенные файлы к загруженному учетному документу через сервис 1С:Share.
// Возможна загрузка исходного файла электронного документа и его дополнительных файлов.
//
// Параметры:
//  СсылкаНаДокумент - ОпределяемыйТип.ОснованияЭлектронныхДокументовЭДО - ссылка на объект учета.
//  ДополнительныеДанные - см. ИнтеграцияShare.НовыеПараметрыДляЗагрузкиДокументаВОбъектУчета.
//
Процедура ЗаписатьПрисоединенныеФайлыКДокументуЧерезСервисShare(СсылкаНаДокумент, Знач ДополнительныеДанные)
	
	Если ДополнительныеДанные = Неопределено
		Или Не ДополнительныеДанные.Свойство("СпособОбмена")
		Или ДополнительныеДанные.СпособОбмена <> ИнтеграцияShare.СпособОбмена() Тогда
		Возврат;
	КонецЕсли;
	
	ДанныеОсновногоФайла = Неопределено;
	Если Не ДополнительныеДанные.Свойство("ДанныеОсновногоФайла", ДанныеОсновногоФайла) Тогда
		Возврат;
	КонецЕсли;
	
	Если ТипЗнч(ДанныеОсновногоФайла.ДвоичныеДанные) = Тип("ДвоичныеДанные")
		И ЗначениеЗаполнено(ДанныеОсновногоФайла.ИмяФайла) Тогда
		
		ДвоичныеДанныеФайла = ДанныеОсновногоФайла.ДвоичныеДанные;
		ПараметрыФайла = РаботаСФайлами.ПараметрыДобавленияФайла();
		ПараметрыФайла.ВладелецФайлов              = СсылкаНаДокумент;
		ПараметрыФайла.ВремяИзмененияУниверсальное = ТекущаяУниверсальнаяДата();
		ПараметрыФайла.Автор                       = Пользователи.АвторизованныйПользователь();
		
		ДанныеФайла = ОбщегоНазначенияКлиентСервер.РазложитьПолноеИмяФайла(ДанныеОсновногоФайла.ИмяФайла);
		ПараметрыФайла.ИмяБезРасширения   = ДанныеФайла.ИмяБезРасширения;
		ПараметрыФайла.РасширениеБезТочки = ОбщегоНазначенияКлиентСервер.РасширениеБезТочки(
			ДанныеФайла.Расширение);

		АдресДанныхДокумента = ПоместитьВоВременноеХранилище(ДвоичныеДанныеФайла);
		РаботаСФайлами.ДобавитьФайл(ПараметрыФайла, АдресДанныхДокумента);
		
	КонецЕсли;
	
	ДополнительныеФайлыДокумента = Неопределено;
	Если Не ДополнительныеДанные.Свойство("ДополнительныеФайлыДокумента", ДополнительныеФайлыДокумента) Тогда
		Возврат;
	КонецЕсли;
	
	Для Каждого СтрокаФайл Из ДополнительныеФайлыДокумента Цикл
		
		ПараметрыФайла = РаботаСФайлами.ПараметрыДобавленияФайла();
		ПараметрыФайла.ВладелецФайлов              = СсылкаНаДокумент;
		ПараметрыФайла.ВремяИзмененияУниверсальное = ТекущаяУниверсальнаяДата();
		ПараметрыФайла.Автор                       = Пользователи.АвторизованныйПользователь();
		ПараметрыФайла.ИмяБезРасширения            = СтрокаФайл.ИмяБезРасширения;
		ПараметрыФайла.РасширениеБезТочки          = СтрокаФайл.РасширениеБезТочки;
		
		АдресДанныхДокумента = ПоместитьВоВременноеХранилище(СтрокаФайл.ДвоичныеДанныеФайла);
		РаботаСФайлами.ДобавитьФайл(ПараметрыФайла, АдресДанныхДокумента);
		
	КонецЦикла;

	ФайлыВизуализации = Неопределено;
	Если Не ДополнительныеДанные.Свойство("ФайлыВизуализации", ФайлыВизуализации) Тогда
		Возврат;
	КонецЕсли;
	
	Для Каждого СтрокаФайл Из ФайлыВизуализации Цикл
		
		ПараметрыФайла = РаботаСФайлами.ПараметрыДобавленияФайла();
		ПараметрыФайла.ВладелецФайлов              = СсылкаНаДокумент;
		ПараметрыФайла.ВремяИзмененияУниверсальное = ТекущаяУниверсальнаяДата();
		ПараметрыФайла.Автор                       = Пользователи.АвторизованныйПользователь();
		Если ЗначениеЗаполнено(СтрокаФайл.Представление) Тогда
			ПараметрыФайла.ИмяБезРасширения        = СтрокаФайл.Представление;			
		Иначе
			ПараметрыФайла.ИмяБезРасширения        = СтрокаФайл.ИмяБезРасширения;
		КонецЕсли;
		ПараметрыФайла.РасширениеБезТочки          = ОбщегоНазначенияКлиентСервер.РасширениеБезТочки(СтрокаФайл.Расширение);
		
		АдресДанныхДокумента = ПоместитьВоВременноеХранилище(СтрокаФайл.ДвоичныеДанныеФайла);
		РаботаСФайлами.ДобавитьФайл(ПараметрыФайла, АдресДанныхДокумента);
		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область Диагностика

// см. ОбменСКонтрагентамиПереопределяемый.ПриОпределенииОбъектовМетаданныхСПоддержкойДиагностикиОшибок
Процедура ПриОпределенииОбъектовМетаданныхСПоддержкойДиагностикиОшибок(СписокДокументов) Экспорт
	
	СписокДокументов.Добавить(Метаданные.Документы.АктВыполненныхРабот);
	СписокДокументов.Добавить(Метаданные.Документы.ВозвратТоваровМеждуОрганизациями);
	СписокДокументов.Добавить(Метаданные.Документы.ВозвратТоваровОтКлиента);
	СписокДокументов.Добавить(Метаданные.Документы.ЗаказКлиента);
	СписокДокументов.Добавить(Метаданные.Документы.ЗаказПоставщику);
	СписокДокументов.Добавить(Метаданные.Документы.ЗапросКоммерческогоПредложенияОтКлиента);
	СписокДокументов.Добавить(Метаданные.Документы.ЗаявкаНаРасходованиеДенежныхСредств);
	СписокДокументов.Добавить(Метаданные.Документы.КоммерческоеПредложениеКлиенту);
	СписокДокументов.Добавить(Метаданные.Документы.КорректировкаПриобретения);
	СписокДокументов.Добавить(Метаданные.Документы.КорректировкаРеализации);
	СписокДокументов.Добавить(Метаданные.Документы.ОтчетКомиссионера);
	СписокДокументов.Добавить(Метаданные.Документы.ОтчетКомиссионераОСписании);
	СписокДокументов.Добавить(Метаданные.Документы.ОтчетКомитенту);
	СписокДокументов.Добавить(Метаданные.Документы.ОтчетКомитентуОСписании);
	СписокДокументов.Добавить(Метаданные.Документы.ПередачаТоваровМеждуОрганизациями);
	СписокДокументов.Добавить(Метаданные.Документы.ПриобретениеТоваровУслуг);
	СписокДокументов.Добавить(Метаданные.Документы.ПриобретениеУслугПрочихАктивов);
	СписокДокументов.Добавить(Метаданные.Документы.РеализацияТоваровУслуг);
	СписокДокументов.Добавить(Метаданные.Документы.РеализацияУслугПрочихАктивов);
	СписокДокументов.Добавить(Метаданные.Документы.РегистрацияЦенНоменклатурыПоставщика);
	СписокДокументов.Добавить(Метаданные.Документы.СчетНаОплатуКлиенту);
	СписокДокументов.Добавить(Метаданные.Документы.СчетФактураВыданный);
	СписокДокументов.Добавить(Метаданные.Документы.СчетФактураВыданныйАванс);
	СписокДокументов.Добавить(Метаданные.Документы.СчетФактураКомиссионеру);
	СписокДокументов.Добавить(Метаданные.Документы.СчетФактураКомитента);
	СписокДокументов.Добавить(Метаданные.Документы.СчетФактураПолученный);
	СписокДокументов.Добавить(Метаданные.Документы.СчетФактураПолученныйАванс);
	СписокДокументов.Добавить(Метаданные.Документы.СчетФактураПолученныйНалоговыйАгент);
	СписокДокументов.Добавить(Метаданные.Документы.СверкаВзаиморасчетов2_5_11);      
	СписокДокументов.Добавить(Метаданные.Справочники.ДоговорыКонтрагентов);

	
КонецПроцедуры

// см. ОбменСКонтрагентамиПереопределяемый.ПриОпределенииПечатныхФормЗапрещенныхДляФормированияДокумента
Процедура ПриОпределенииПечатныхФормЗапрещенныхДляФормированияДокумента(СписокИдентификаторов) Экспорт

	СписокИдентификаторов.Добавить("АктСверкиВзаимныхРасчетов");
	
КонецПроцедуры

Процедура ПриПроверкеИспользованияУведомлений(Используется) Экспорт
	
	Используется = Истина

КонецПроцедуры

#КонецОбласти

#Область ПрямойОбмен

Процедура ИспользоватьПрямойОбмен(Использовать) Экспорт
	
	Использовать = Истина;
	
КонецПроцедуры

#КонецОбласти
