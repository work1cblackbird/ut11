////////////////////////////////////////////////////////////////////////////////
// Подсистема "Рассылки и оповещения клиентам".
//
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
//  Содержит общие серверные процедуры и предназначенные для настройки, а также 
//  формирования сообщений по рассылкам и оповещениям.
//

#Область СлужебныйПрограммныйИнтерфейс

#Область РаботаСВложениями

// Формирует перед записью объекта ТекстHTML из форматированного документа.
// Картинки ФД будут сохранены как присоединенные файлы объекта.
//
// Параметры:
//  ФорматированныйДокумент  - ФорматированныйДокумент -  который будет преобразован в HTML.
//  ТекстHTML                - Строка - в ней будет сохранен получившийся HTML.
//  ТипТекстаПисьма          - ПеречислениеСсылка.СпособыРедактированияЭлектронныхПисем - для определения необходимости выполнения преобразований.
//  ТаблицаСоответствийИменВложенийИдентификаторам  - ТаблицаЗначений - позволяет определить какому вложению
//                                                                      соответствует какая картинка.
//
Процедура ФорматированныйДокументВHTMLПередЗаписью(ФорматированныйДокумент, ТекстHTML, ТипТекстаПисьма, ТаблицаСоответствийИменВложенийИдентификаторам) Экспорт

	// Подготовим документ HTML из содержимого форматированного документа
	Если ТипТекстаПисьма = Перечисления.СпособыРедактированияЭлектронныхПисем.HTML Тогда
		
		ТаблицаСоответствийИменВложенийИдентификаторам.Очистить();
		
		СтруктураВложений = Новый Структура;
		ФорматированныйДокумент.ПолучитьHTML(ТекстHTML, СтруктураВложений);
		Для каждого Вложение Из СтруктураВложений Цикл
			
			НоваяСтрока = ТаблицаСоответствийИменВложенийИдентификаторам.Добавить();
			НоваяСтрока.ИмяФайла = Вложение.Ключ;
			НоваяСтрока.ИдентификаторФайлаДляHTML = Новый УникальныйИдентификатор;
			НоваяСтрока.Картинка = Вложение.Значение;
			
		КонецЦикла;
		
		Если ТаблицаСоответствийИменВложенийИдентификаторам.Количество() > 0 Тогда
			
			ДокументHTML = Взаимодействия.ПолучитьОбъектДокументHTMLИзТекстаHTML(ТекстHTML);
			Взаимодействия.ЗаменитьИменаКартинокНаИдентификаторыПочтовыхВложенийВHTML( ДокументHTML, ТаблицаСоответствийИменВложенийИдентификаторам.Выгрузить());
			ТекстHTML = Взаимодействия.ПолучитьТекстHTMLИзОбъектаДокументHTML(ДокументHTML);
			
		Иначе
			
			Если ПустаяСтрока(ФорматированныйДокумент.ПолучитьТекст()) Тогда
				ТекстHTML = "";
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;

КонецПроцедуры

// Добавляет в список вложений к удалению вложения, которые соответствовали картинкам тела письма.
//
// Параметры:
//  Ссылка            - ДокументСсылка - ссылка на владельца присоединенных файлов.
//  УдаленныеВложения - Массив - массив вложений к удалению.
//
Процедура ДобавитьВСписокУдаляемыхВложенияСНепустымИД(Ссылка, УдаленныеВложения) Экспорт
	
	ТаблицаВложенийКартинокФорматированногоДокумента = Взаимодействия.ПолучитьВложенияПисьмаСНеПустымИД(Ссылка);
	Для каждого Вложение Из ТаблицаВложенийКартинокФорматированногоДокумента Цикл
		УдаленныеВложения.Добавить(Вложение.Ссылка);
	КонецЦикла;
	
КонецПроцедуры

// Удаляет вложения согласно переданному массиву вложений.
//
// Параметры:
//  УдаленныеВложения  - СписокЗначений из СправочникСсылка - массив вложений к удалению.
//
Процедура УдалитьВложения(УдаленныеВложения) Экспорт
	
	Для Каждого УдаленноеВложение Из УдаленныеВложения Цикл
		ОбъектВложение = УдаленноеВложение.Значение.ПолучитьОбъект(); 
		ОбъектВложение.Удалить();
	КонецЦикла;
	
	УдаленныеВложения.Очистить();
	
КонецПроцедуры

// Сохраняет картинки форматированного документа как присоединенные файлы объекта.
//
// Параметры:
//  Ссылка                                          - ДокументСсылка - ссылка на владельца присоединенных файлов.
//  ТипТекстаПисьма                                 - ПеречислениеСсылка.СпособыРедактированияЭлектронныхПисем - для определения необходимости выполнения преобразований.
//  ТаблицаСоответствийИменВложенийИдентификаторам  - ТаблицаЗначений - позволяет определить какому вложению
//                                                                      соответствует какая картинка.
//  УникальныйИдентификатор                         - УникальныйИдентификатор - уникальный идентификатор формы из которого выполняется сохранение.
//
Процедура СохранитьКартинкиФорматированногоДокументаКакПрисоединенныеФайлы(Ссылка,
	                                                                        ТипТекстаПисьма,
	                                                                        ТаблицаСоответствийИменВложенийИдентификаторам,
	                                                                        УникальныйИдентификатор) Экспорт
	
	Если ТипТекстаПисьма = Перечисления.СпособыРедактированияЭлектронныхПисем.HTML Тогда
		
		Для каждого Вложение Из ТаблицаСоответствийИменВложенийИдентификаторам Цикл
			
			ДвоичныеДанныеКартинки = Вложение.Картинка.ПолучитьДвоичныеДанные();
			АдресКартинкиВоВременномХранилище = ПоместитьВоВременноеХранилище(ДвоичныеДанныеКартинки, УникальныйИдентификатор);
			
			ПараметрыВложения = Новый Структура;
			ПараметрыВложения.Вставить("ИмяФайла", "_" + СтрЗаменить(Вложение.ИдентификаторФайлаДляHTML, "-", "_"));
			ПараметрыВложения.Вставить("Размер", ДвоичныеДанныеКартинки.Размер());
			ПараметрыВложения.Вставить("ИДФайлаЭлектронногоПисьма", Вложение.ИдентификаторФайлаДляHTML);
			
			ПрисоединенныйФайл = УправлениеЭлектроннойПочтой.ЗаписатьВложениеЭлектронногоПисьмаИзВременногоХранилища(
			Ссылка,
			АдресКартинкиВоВременномХранилище,
			ПараметрыВложения);
			
			Если ПрисоединенныйФайл <> Неопределено Тогда
				ПрисоединенныйФайлОбъект = ПрисоединенныйФайл.ПолучитьОбъект(); // СправочникОбъект.ЭлектронноеПисьмоВходящееПрисоединенныеФайлы
				ПрисоединенныйФайлОбъект.ИДФайлаЭлектронногоПисьма = Вложение.ИдентификаторФайлаДляHTML;
				ПрисоединенныйФайлОбъект.Записать();
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

// Сохраняет вложения объекта как присоединенные файлы.
//
// Параметры:
//  Ссылка                   - ДокументСсылка - ссылка на владельца присоединенных файлов.
//  Вложения                 - ТаблицаЗначений - таблица вложений.
//  УникальныйИдентификатор  - УникальныйИдентификатор - уникальный идентификатор формы из которого выполняется сохранение.
//
Процедура СохранитьВложения(Ссылка, Вложения, УникальныйИдентификатор) Экспорт
	
	Для Каждого СтрокаТаблицыВложений Из Вложения Цикл
		
		Размер = 0;
		ИмяФайла = СтрокаТаблицыВложений.ИмяФайла;
		
		Если СтрокаТаблицыВложений["Расположение"] = 4 Тогда
			
			ПараметрыВложения = Новый Структура;
			ПараметрыВложения.Вставить("ИмяФайла", ИмяФайла);
			ПараметрыВложения.Вставить("Размер",Размер);
			
			// из временного хранилища
			СтрокаТаблицыВложений["Ссылка"] = УправлениеЭлектроннойПочтой.ЗаписатьВложениеЭлектронногоПисьмаИзВременногоХранилища(
							Ссылка, СтрокаТаблицыВложений.ИмяФайлаНаКомпьютере, ПараметрыВложения);
			
		ИначеЕсли СтрокаТаблицыВложений["Расположение"] = 1 Тогда
			
			СтрокаТаблицыВложений["Ссылка"] = УправлениеЭлектроннойПочтой.ЗаписатьВложениеЭлектронногоПисьмаСкопировавВложениеДругогоПисьма(
			Ссылка, СтрокаТаблицыВложений["Ссылка"], УникальныйИдентификатор);
			
		КонецЕсли;
		
		СтрокаТаблицыВложений["Расположение"] = 0;
		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область РегламентныеЗадания

// Выполняет анализ данных для оповещений клиентам и выполняет запись в очередь оповещений.
// 
// Параметры:
//   ВидОповещения - СправочникСсылка.ВидыОповещенийКлиентам - Вид оповещения, данные по которому должны быть проанализированы.
//
Процедура АнализДанныхДляОповещенийКлиентам(ВидОповещения) Экспорт
	
	ОбщегоНазначения.ПриНачалеВыполненияРегламентногоЗадания(Метаданные.РегламентныеЗадания.АнализДанныхДляОповещенийКлиентам);
	
	Если ТипЗнч(ВидОповещения) <> Тип("СправочникСсылка.ВидыОповещенийКлиентам") ИЛИ ВидОповещения.Пустая() Тогда
		Возврат;
	КонецЕсли;
	
	Реквизиты = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ВидОповещения, "ТипСобытия");
	ТипСобытия = Реквизиты.ТипСобытия;
	
	Если ТипСобытия.Пустая() Тогда
		Возврат;
	КонецЕсли;
	
	ОбщегоНазначения.ПриНачалеВыполненияРегламентногоЗадания();
	
	Если ТипСобытия = Перечисления.ТипыСобытийОповещений.ПоздравлениеСДнемРождения Тогда
		АнализДанныхПоздравленияСДнемРождения(ВидОповещения);
	ИначеЕсли ТипСобытия = Перечисления.ТипыСобытийОповещений.ПросроченнаяЗадолженность Тогда
		АнализПросроченнаяЗадолженность(ВидОповещения);
	ИначеЕсли ТипСобытия = Перечисления.ТипыСобытийОповещений.ПлановыеПлатежи Тогда
		АнализПлановыеПлатежи(ВидОповещения);
	ИначеЕсли ТипСобытия = Перечисления.ТипыСобытийОповещений.ПлановыеОтгрузки Тогда
		АнализПлановыеОтгрузки(ВидОповещения);
	ИначеЕсли ТипСобытия = Перечисления.ТипыСобытийОповещений.ОкончаниеОпроса Тогда
		АнализОкончаниеОпроса(ВидОповещения);
	Иначе
		МодификацияКонфигурацииПереопределяемый.АнализДанныхДляВидаОповещения(ВидОповещения);
	КонецЕсли;

КонецПроцедуры

// Формирует документы "Сообщение SMS" и "Электронное письмо исходящее" по данным РС "ОчередьСобытийДляОповещенийКлиентам".
// За собственно отправку подготовленных сообщений отвечают регламентные задания
// "Получение и отправка электронных писем" и "Отправка SMS".
//
Процедура ФормированиеСообщенийПоОповещениямКлиентов() Экспорт
	
	ОбщегоНазначения.ПриНачалеВыполненияРегламентногоЗадания(Метаданные.РегламентныеЗадания.ФормированиеСообщенийПоОповещениямКлиентов);
	
	УстановитьПривилегированныйРежим(Истина);
	
	ТекстЗаписи = НСтр("ru = 'Начало формирования сообщений по очереди оповещений для клиентов'",
	                   ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
	
	ВыполнитьЗаписьЖурналаРегистрации(ТекстЗаписи, УровеньЖурналаРегистрации.Информация);
	ДатаОбработки = ТекущаяДатаСеанса(); 
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |	ОчередьСобытийДляОповещенийКлиентам.ВидОповещения КАК ВидОповещения
	               |ИЗ
	               |	РегистрСведений.ОчередьСобытийДляОповещенийКлиентам КАК ОчередьСобытийДляОповещенийКлиентам
	               |ГДЕ
	               |	ОчередьСобытийДляОповещенийКлиентам.Период < &ДатаОбработки";
	
	Запрос.УстановитьПараметр("ДатаОбработки", ДатаОбработки);
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		НачатьТранзакцию();
		
		Попытка
			
			ОбработатьОчередьСообщенийПоВидуОповещения(Выборка.ВидОповещения, ДатаОбработки);
			РегистрыСведений.ОчередьСобытийДляОповещенийКлиентам.УдалитьЗаписиПоВидуОповещенияИзОчереди(Выборка.ВидОповещения, ДатаОбработки);
			ЗафиксироватьТранзакцию();
			
		Исключение
			
			ОтменитьТранзакцию();
			ТекстЗаписи = НСтр("ru = 'Ошибка при формировании сообщений по оповещениям клиентов'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()) + " : ";
			ТекстЗаписи = ТекстЗаписи + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			ВыполнитьЗаписьЖурналаРегистрации(ТекстЗаписи ,УровеньЖурналаРегистрации.Ошибка);
			Продолжить;
		
		КонецПопытки;
			
	КонецЦикла;
	
	ТекстЗаписи = НСтр("ru = 'Окончание формирования сообщений по рассылкам клиентов'",
	                   ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
	ВыполнитьЗаписьЖурналаРегистрации(ТекстЗаписи ,УровеньЖурналаРегистрации.Информация);
	
КонецПроцедуры

// Формирует документы "Сообщение SMS" и "Электронное письмо исходящее" по документам "Рассылка клиентам",
// находящимся в статусе "К отправке". За собственно отправку подготовленных сообщений отвечают регламентные задания
// "Получение и отправка электронных писем" и "Отправка SMS".
//
Процедура ФормированиеСообщенийПоРассылкамКлиентам() Экспорт
	
	ОбщегоНазначения.ПриНачалеВыполненияРегламентногоЗадания(Метаданные.РегламентныеЗадания.ФормированиеСообщенийПоРассылкамКлиентам);
	
	УстановитьПривилегированныйРежим(Истина);
	
	ТекстЗаписи = НСтр("ru = 'Начало формирования сообщений по рассылкам клиентов'",
	                   ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
	ВыполнитьЗаписьЖурналаРегистрации(ТекстЗаписи ,УровеньЖурналаРегистрации.Информация);
	
	КоличествоОбработанныхРассылок = 0;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	РассылкаКлиентам.Ссылка,
	|	РассылкаКлиентам.ДатаРассылки,
	|	РассылкаКлиентам.ДатаАктуальности,
	|	РассылкаКлиентам.ГруппаРассылокИОповещений,
	|	РассылкаКлиентам.ПредназначенаДляЭлектронныхПисем,
	|	РассылкаКлиентам.ПредназначенаДляSMS,
	|	РассылкаКлиентам.Тема,
	|	РассылкаКлиентам.ТекстПисьма,
	|	РассылкаКлиентам.ТекстПисьмаHTML,
	|	РассылкаКлиентам.ТекстSMS,
	|	РассылкаКлиентам.ОтборАдресатов,
	|	РассылкаКлиентам.ТипТекстаПисьма,
	|	РассылкаКлиентам.ОтправлятьВТранслите,
	|	ГруппыРассылокИОповещений.Принудительная,
	|	ГруппыРассылокИОповещений.ОтправлятьПартнеру,
	|	ГруппыРассылокИОповещений.ОтправлятьКонтактнымЛицамРоли,
	|	ГруппыРассылокИОповещений.ОтправлятьКонтактномуЛицуОбъектаОповещения,
	|	ГруппыРассылокИОповещений.ВидКонтактнойИнформацииПартнераДляПисем,
	|	ГруппыРассылокИОповещений.ВидКонтактнойИнформацииПартнераДляSMS,
	|	ГруппыРассылокИОповещений.ВидКонтактнойИнформацииКонтактногоЛицаДляПисем,
	|	ГруппыРассылокИОповещений.ВидКонтактнойИнформацииКонтактногоЛицаДляSMS,
	|	ГруппыРассылокИОповещений.РольКонтактногоЛица,
	|	РассылкаКлиентам.Ответственный,
	|	РассылкаКлиентам.Номер,
	|	РассылкаКлиентам.Дата,
	|	ГруппыРассылокИОповещений.УчетнаяЗапись,
	|	ЕСТЬNULL(УчетныеЗаписиЭлектроннойПочты.АдресЭлектроннойПочты, """") КАК УчетнаяЗаписьАдресЭлектроннойПочты,
	|	ЕСТЬNULL(УчетныеЗаписиЭлектроннойПочты.ИмяПользователя, """") КАК УчетнаяЗаписьИмяПользователя,
	|	ЕСТЬNULL(НастройкиУчетныхЗаписейЭлектроннойПочты.УдалятьПисьмаПослеОтправки, ЛОЖЬ) КАК УдалятьПослеОтправки,
	|	РассылкаКлиентам.Основание,
	|	РассылкаКлиентам.ЕстьВложения
	|ИЗ
	|	Документ.РассылкаКлиентам КАК РассылкаКлиентам
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ГруппыРассылокИОповещений КАК ГруппыРассылокИОповещений
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.УчетныеЗаписиЭлектроннойПочты КАК УчетныеЗаписиЭлектроннойПочты
	|				ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.НастройкиУчетныхЗаписейЭлектроннойПочты КАК НастройкиУчетныхЗаписейЭлектроннойПочты
	|				ПО УчетныеЗаписиЭлектроннойПочты.Ссылка = НастройкиУчетныхЗаписейЭлектроннойПочты.УчетнаяЗаписьЭлектроннойПочты
	|			ПО ГруппыРассылокИОповещений.УчетнаяЗапись = УчетныеЗаписиЭлектроннойПочты.Ссылка
	|		ПО РассылкаКлиентам.ГруппаРассылокИОповещений = ГруппыРассылокИОповещений.Ссылка
	|ГДЕ
	|	НЕ РассылкаКлиентам.ПометкаУдаления
	|	И РассылкаКлиентам.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыРассылокКлиентам.КОтправке)
	|	И РассылкаКлиентам.ДатаРассылки < &ДатаРассылокКПодготовке
	|	И ВЫБОР
	|			КОГДА РассылкаКлиентам.ДатаАктуальности = ДАТАВРЕМЯ(1, 1, 1)
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ВЫБОР
	|					КОГДА РассылкаКлиентам.ДатаАктуальности > &ДатаРассылокКПодготовке
	|						ТОГДА ИСТИНА
	|					ИНАЧЕ ЛОЖЬ
	|				КОНЕЦ
	|		КОНЕЦ";
	
	Запрос.УстановитьПараметр("ДатаРассылокКПодготовке", ТекущаяДатаСеанса() + 3600);
	
	ВыборкаРассылки = Запрос.Выполнить().Выбрать();
	
	Пока ВыборкаРассылки.Следующий() Цикл
		
		НачатьТранзакцию();
		
		Попытка
			
			ДокументОбъект        = ВыборкаРассылки.Ссылка.ПолучитьОбъект(); // ДокументОбъект.РассылкаКлиентам
			ДокументОбъект.Статус = Перечисления.СтатусыРассылокКлиентам.КОтправке;
			ДокументОбъект.Записать();
			
			МассивСозданныхВзаимодействий = Новый Массив;
			Если ТипЗнч(ВыборкаРассылки.Основание) = Тип("ДокументСсылка.НазначениеОпросов") И ЗначениеЗаполнено(ВыборкаРассылки.Основание) Тогда
				ДанныеОснования = ДанныеОснованияНазначениеОпросов(ВыборкаРассылки.Основание);
			Иначе
				ДанныеОснования = Неопределено;
			КонецЕсли;
			
			ВыборкаАдресатовРассылки = ВыборкаАдресатовРассылки(ВыборкаРассылки, ДанныеОснования);
			
			Если ВыборкаРассылки.ПредназначенаДляЭлектронныхПисем Тогда
				СоздатьПисьмаДляРассылки(ВыборкаРассылки, ВыборкаАдресатовРассылки, МассивСозданныхВзаимодействий, ДанныеОснования);
			Иначе
				СоздатьSMSДляРассылки(ВыборкаРассылки, ВыборкаАдресатовРассылки, МассивСозданныхВзаимодействий , ДанныеОснования);
			КонецЕсли;
			
			ДокументОбъект.Статус = Перечисления.СтатусыРассылокКлиентам.Выполнена;
			ДокументОбъект.Записать();
			
			Взаимодействия.РассчитатьРассмотреноПоПредметам(МассивСозданныхВзаимодействий);
			Взаимодействия.РассчитатьРассмотреноПоКонтактам(МассивСозданныхВзаимодействий);
			
			КоличествоОбработанныхРассылок = КоличествоОбработанныхРассылок + 1;
			
			ЗафиксироватьТранзакцию();
			
		Исключение
			
			ОтменитьТранзакцию();
			
			ТекстЗаписи = НСтр("ru = 'Ошибка при формировании сообщений по рассылкам клиентов'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()) + " : ";
			ТекстЗаписи = ТекстЗаписи + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			ВыполнитьЗаписьЖурналаРегистрации(ТекстЗаписи ,УровеньЖурналаРегистрации.Ошибка);
			Возврат;
			
		КонецПопытки;
		
	КонецЦикла;
	
	ТекстЗаписи = НСтр("ru = 'Окончание формирования сообщений по рассылкам клиентов. Обработано рассылок %1.'",
	                   ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
	ТекстЗаписи = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстЗаписи, Строка(КоличествоОбработанныхРассылок));
	ВыполнитьЗаписьЖурналаРегистрации(ТекстЗаписи ,УровеньЖурналаРегистрации.Информация);
	
КонецПроцедуры

// Удаляет документы взаимодействий по рассылкам и оповещениям у которых истек срок хранения.
//
Процедура УдалениеВзаимодействийПоРассылкамИОповещениям() Экспорт
	
	ОбщегоНазначения.ПриНачалеВыполненияРегламентногоЗадания(Метаданные.РегламентныеЗадания.УдалениеВзаимодействийПоРассылкамИОповещениям);
	
	УстановитьПривилегированныйРежим(Истина);
	
	ТекстЗаписи = НСтр("ru = 'Начало установки пометки удаления для взаимодействий по рассылке клиентам'",
	                   ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
	ВыполнитьЗаписьЖурналаРегистрации(ТекстЗаписи ,УровеньЖурналаРегистрации.Информация);
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Взаимодействия.Ссылка
	|ИЗ
	|	ЖурналДокументов.Взаимодействия КАК Взаимодействия
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РассылкаКлиентам КАК РассылкаКлиентам
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ГруппыРассылокИОповещений КАК ГруппыРассылокИОповещений
	|			ПО РассылкаКлиентам.ГруппаРассылокИОповещений = ГруппыРассылокИОповещений.Ссылка
	|		ПО Взаимодействия.ВзаимодействиеОснование = РассылкаКлиентам.Ссылка
	|ГДЕ
	|	РассылкаКлиентам.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыРассылокКлиентам.Выполнена)
	|	И НЕ Взаимодействия.ПометкаУдаления
	|	И ГруппыРассылокИОповещений.СрокХраненияСообщений <> 0
	|	И ВЫБОР
	|			КОГДА Взаимодействия.ДатаАктуальностиОтправки > Взаимодействия.Дата
	|				ТОГДА ДОБАВИТЬКДАТЕ(Взаимодействия.ДатаАктуальностиОтправки, ДЕНЬ, ГруппыРассылокИОповещений.СрокХраненияСообщений) < &ТекущаяДата
	|			ИНАЧЕ ДОБАВИТЬКДАТЕ(Взаимодействия.Дата, ДЕНЬ, ГруппыРассылокИОповещений.СрокХраненияСообщений) < &ТекущаяДата
	|		КОНЕЦ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Взаимодействия.Ссылка
	|ИЗ
	|	ЖурналДокументов.Взаимодействия КАК Взаимодействия
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыОповещенийКлиентам КАК ВидыОповещенийКлиентам
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ГруппыРассылокИОповещений КАК ГруппыРассылокИОповещений
	|			ПО ВидыОповещенийКлиентам.ГруппаРассылокИОповещений = ГруппыРассылокИОповещений.Ссылка
	|		ПО Взаимодействия.ВзаимодействиеОснование = ВидыОповещенийКлиентам.Ссылка
	|ГДЕ
	|	НЕ Взаимодействия.ПометкаУдаления
	|	И ГруппыРассылокИОповещений.СрокХраненияСообщений <> 0
	|	И ВЫБОР
	|			КОГДА Взаимодействия.ДатаАктуальностиОтправки > Взаимодействия.Дата
	|				ТОГДА ДОБАВИТЬКДАТЕ(Взаимодействия.ДатаАктуальностиОтправки, ДЕНЬ, ГруппыРассылокИОповещений.СрокХраненияСообщений) < &ТекущаяДата
	|			ИНАЧЕ ДОБАВИТЬКДАТЕ(Взаимодействия.Дата, ДЕНЬ, ГруппыРассылокИОповещений.СрокХраненияСообщений) < &ТекущаяДата
	|		КОНЕЦ";
	
	Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДатаСеанса());
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ДокументОбъект = Выборка.Ссылка.ПолучитьОбъект();
		ДокументОбъект.УстановитьПометкуУдаления(Истина);
		ДокументОбъект.Записать();
		
	КонецЦикла;
	
	ТекстЗаписи = НСтр("ru = 'Начало установки пометки удаления для взаимодействий по рассылке клиентам'",
	                   ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
	ВыполнитьЗаписьЖурналаРегистрации(ТекстЗаписи ,УровеньЖурналаРегистрации.Информация);
	
КонецПроцедуры

#КонецОбласти

#Область ОбработкаИзмененияДанныхДляОповещенийКлиентов

// Обработчик подписки на событие "Перед записью" регистров сведения и накопления
//  для формирования очереди оповещений клиентов. Выступает маршрутизатором для различных типов источников.
//
// Параметры:
//  Источник  - РегистрСведенийНаборЗаписей, РегистрНакопленияНаборЗаписей - набор записей, данные которого
//                                                                           анализируются до записи.
//  Отказ     - Булево - возможность отказаться от записи набора записей.
//
Процедура ИсточникОповещенияПередЗаписьюРегистры(Источник, Отказ) Экспорт
	
	Если Источник.ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если ТипЗнч(Источник) = Тип("РегистрНакопленияНаборЗаписей.БонусныеБаллы") Тогда
		
		ОбработатьИзменениеБонусныхБаллов(Источник, "ПередЗаписью");
		
	ИначеЕсли ТипЗнч(Источник) = Тип("РегистрСведенийНаборЗаписей.СостоянияЗаказовКлиентов") Тогда
		
		ОбработатьИзменениеСостоянияЗаказовКлиента(Источник, "ПередЗаписью");
		
	КонецЕсли;
	
	МодификацияКонфигурацииПереопределяемый.ИсточникОповещенияПередЗаписью(Источник, Отказ, Неопределено, Неопределено);
	
КонецПроцедуры

// Обработчик подписки на событие "При записи" регистров сведения и накопления
//  для формирования очереди оповещений клиентов. Выступает маршрутизатором для различных типов источников.
//
// Параметры:
//  Источник  - РегистрСведенийНаборЗаписей, РегистрНакопленияНаборЗаписей - набор записей, данные которого
//                                                                           анализируются при записи.
//  Отказ     - Булево - возможность отказаться от записи набора записей.
//
Процедура ИсточникОповещенияПриЗаписиРегистры(Источник, Отказ) Экспорт
	
	Если Источник.ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если ТипЗнч(Источник) = Тип("РегистрНакопленияНаборЗаписей.БонусныеБаллы") Тогда
		
		ОбработатьИзменениеБонусныхБаллов(Источник, "ПриЗаписи");
		
	ИначеЕсли ТипЗнч(Источник) = Тип("РегистрСведенийНаборЗаписей.СостоянияЗаказовКлиентов") Тогда
		
		ОбработатьИзменениеСостоянияЗаказовКлиента(Источник, "ПриЗаписи");
		
	КонецЕсли;
	
	МодификацияКонфигурацииПереопределяемый.ИсточникОповещенияПриЗаписи(Источник, Отказ);
	
КонецПроцедуры

// Обработчик подписки на событие "Перед записью" документов для формирования очереди
// оповещений клиентов. Выступает маршрутизатором для различных типов источников.
//
// Параметры:
//  Источник        - ДокументСсылка - документ, данные которого анализируются до записи.
//  Отказ           - Булево - возможность отказаться от записи документа.
//  РежимЗаписи     - РежимЗаписиДокумента - режим записи документа.
//  РежимПроведения - РежимПроведенияДокумента - режим проведения документа.
//
Процедура ИсточникОповещенияПередЗаписьюДокументы(Источник, Отказ, РежимЗаписи, РежимПроведения) Экспорт
	
	Если Источник.ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если ТипЗнч(Источник) = Тип("ДокументОбъект.СчетНаОплатуКлиенту") Тогда
		
		ОбработатьИзменениеСчетаНаОплату(Источник, "ПередЗаписью", РежимЗаписи);
		
	ИначеЕсли ТипЗнч(Источник) = Тип("ДокументОбъект.ПриходныйКассовыйОрдер")
			Или ТипЗнч(Источник) = Тип("ДокументОбъект.ПоступлениеБезналичныхДенежныхСредств")
			Или ТипЗнч(Источник) = Тип("ДокументОбъект.ОперацияПоПлатежнойКарте") Тогда
			
			ОбработатьИзменениеПоступленияОплаты(Источник, "ПередЗаписью", РежимЗаписи);
	
	КонецЕсли;
	
	МодификацияКонфигурацииПереопределяемый.ИсточникОповещенияПередЗаписью(Источник, Отказ, РежимЗаписи, РежимПроведения);
	
КонецПроцедуры

// Обработчик подписки на событие "При записи" документов для формирования очереди
// оповещений клиентов. Выступает маршрутизатором для различных типов источников.
//
// Параметры:
//  Источник  - ДокументОбъект - документ, данные которого анализируются при записи.
//  Отказ     - Булево - возможность отказаться от записи документа.
//
Процедура ИсточникОповещенияПриЗаписиДокументы(Источник, Отказ) Экспорт
	
	Если Источник.ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если ТипЗнч(Источник) = Тип("ДокументОбъект.СчетНаОплатуКлиенту") Тогда
		
		ОбработатьИзменениеСчетаНаОплату(Источник, "ПриЗаписи", Неопределено);
		
	ИначеЕсли ТипЗнч(Источник) = Тип("ДокументОбъект.ПриходныйКассовыйОрдер")
			Или ТипЗнч(Источник) = Тип("ДокументОбъект.ПоступлениеБезналичныхДенежныхСредств")
			Или ТипЗнч(Источник) = Тип("ДокументОбъект.ОперацияПоПлатежнойКарте") Тогда
			
			ОбработатьИзменениеПоступленияОплаты(Источник, "ПриЗаписи", Неопределено);
		
	КонецЕсли;
	
	МодификацияКонфигурацииПереопределяемый.ИсточникОповещенияПриЗаписи(Источник, Отказ);
	
КонецПроцедуры

#КонецОбласти

// Получает данные документа "Назначение опросов", основания рассылки клиентам
//
// Параметры:
//  Основание  - ДокументСсылка.НазначениеОпросов - документ, данные которого получаются.
//
// Возвращаемое значение:
//   ВыборкаИзРезультатаЗапроса, Неопределено - данные документа "Назначение опросов", содержит:
//    * Ссылка          - ДокументСсылка.НазначениеОпросов - 
//    * ДатаНачала      - Дата - 
//    * ДатаОкончания   - Дата - 
//    * Наименование    - Строка -
//    * СвободныйОпрос  - Булево -
//    * ТипРеспондентов - Строка -
//
Функция ДанныеОснованияНазначениеОпросов(Основание) Экспорт

	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	НазначениеОпросов.Ссылка,
	|	НазначениеОпросов.ДатаНачала,
	|	НазначениеОпросов.ДатаОкончания,
	|	НазначениеОпросов.Наименование,
	|	НазначениеОпросов.СвободныйОпрос,
	|	НазначениеОпросов.ТипРеспондентов
	|ИЗ
	|	Документ.НазначениеОпросов КАК НазначениеОпросов
	|ГДЕ
	|	НазначениеОпросов.Ссылка = &Основание";
	
	Запрос.УстановитьПараметр("Основание", Основание);
	
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		Возврат Неопределено;
	Иначе
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Возврат Выборка;
	КонецЕсли;

КонецФункции

// Устанавливает видимость на форме документа информационного сообщения, предлагающего менеджеру подписать
// клиента на оповещения по данному документу.
//
// Параметры:
//  ГруппаПодпискаНаОповещения  - ГруппаФормы - группа формы, на которой расположены страницы с сообщением и пустой страницей.
//  Партнер                     - СправочникСсылка.Партнеры - партнер, для которого будет оформлена подписка.
//  ТипСобытия                  - ПеречислениеСсылка.ТипыСобытийОповещений, Массив - типы событий оповещений для которых будут найдены
//    группы рассылок и оповещений и будет предложено оформить на них подписку.
//
Процедура УстановитьВидимостьПодпискиНаОповещенияВОбъекте(ГруппаПодпискаНаОповещения, Партнер, ТипСобытия) Экспорт
		
	ПоказыватьПодпискиНаОповещения = РассылкиИОповещенияКлиентамВызовСервера.ПоказыватьПодпискиНаОповещенияВОбъекте(
		Партнер,
		ТипСобытия);
		
	Если ПоказыватьПодпискиНаОповещения Тогда
		ГруппаПодпискаНаОповещения.Видимость = Истина;
	Иначе
		ГруппаПодпискаНаОповещения.Видимость = Ложь;
	КонецЕсли;
	
КонецПроцедуры

// Формирует запрос, помещающий партнеров, согласно настройке отбора во временную таблицу.
//
// Параметры:
//  Данные  - Структура - содержит следующие свойства:
//    * ОтборАдресатов - ХранилищеЗначения - содержит настройки компоновки данных с отбором по партнеру.
//    * Основание      - ДокументСсылка - основание рассылки клиентам.
//  УстановленОтборПоОснованию - Булево - в него записывается признак того,
//                                        что в в настройках компоновки установлен отбор по основанию рассылки.
// Возвращаемое значение:
//   Запрос - запрос по отбору партнеров
//
Функция ЗапросОтборПоКомпоновке(Данные, УстановленОтборПоОснованию) Экспорт
	
	Настройки = Данные.ОтборАдресатов.Получить();
	
	НаОснованииОпроса = ЗначениеЗаполнено(Данные.Основание) 
	                    И ТипЗнч(Данные.Основание) = Тип("ДокументСсылка.НазначениеОпросов");
	
	ИмяМакета = ?(НаОснованииОпроса, "ОтборПартнеровНазначениеОпросов", "ОтборПартнеров");
	
	// Формирование запроса
	СхемаОтбора = Обработки.ПодборПартнеровПоОтбору.ПолучитьМакет(ИмяМакета);
	
	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных();
	КомпоновщикНастроекРасчета = Новый КомпоновщикНастроекКомпоновкиДанных;
	КомпоновщикНастроекРасчета.Инициализировать(Новый ИсточникДоступныхНастроекКомпоновкиДанных(СхемаОтбора));
	КомпоновщикНастроекРасчета.ЗагрузитьНастройки(Настройки);
	
	МакетКомпоновкиДанных = КомпоновщикМакета.Выполнить(СхемаОтбора, КомпоновщикНастроекРасчета.ПолучитьНастройки(),,,
	                                                    Тип("ГенераторМакетаКомпоновкиДанныхДляКоллекцииЗначений"));
	
	Макет = Документы.РассылкаКлиентам.ПолучитьМакет("СостояниеРассылки");
	
	ЕстьОтборПоКомпоновке = Ложь;
	Если МакетКомпоновкиДанных.ЗначенияПараметров.Количество() > 0 Тогда
		Если НЕ (НаОснованииОпроса 
			И МакетКомпоновкиДанных.ЗначенияПараметров.Количество() = 1 
			И МакетКомпоновкиДанных.ЗначенияПараметров[0].Значение = Данные.Основание) Тогда
			ЕстьОтборПоКомпоновке = Истина;
		КонецЕсли;
	КонецЕсли;
	
	Для Каждого ЗначениеПараметров Из МакетКомпоновкиДанных.ЗначенияПараметров Цикл
		Если ЗначениеПараметров.Значение = Данные.Основание Тогда
			УстановленОтборПоОснованию = Истина;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Запрос = Новый Запрос;
	
	Если ЕстьОтборПоКомпоновке Тогда
		
		Запрос.Текст = МакетКомпоновкиДанных.НаборыДанных.ОсновнойНаборДанных.Запрос;
		
		Для каждого Параметр Из МакетКомпоновкиДанных.ЗначенияПараметров Цикл
			Запрос.Параметры.Вставить(Параметр.Имя, Параметр.Значение);
		КонецЦикла;
		
		ТекстПоместить = "ПОМЕСТИТЬ ОтборПартнеров";
		ПозицияВставки =  СтрНайти(Запрос.Текст, "Справочник.Партнеры КАК Партнеры") - 5;
		ЛеваяЧасть     = ЛЕВ(Запрос.Текст, ПозицияВставки);
		ПраваяЧасть    = Прав(Запрос.Текст, СтрДлина(Запрос.Текст) -ПозицияВставки);
		Запрос.Текст = ЛеваяЧасть + ТекстПоместить + Символы.ПС + ПраваяЧасть;
		Запрос.Текст = Запрос.Текст + "
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////";
		
	КонецЕсли;
	
	Возврат Запрос;
	
КонецФункции

// Устанавливает параметры динамических списков для текстового представления вида сообщений.
//
// Параметры:
//  Список  - ДинамическийСписок - список, в который помещаются параметры.
//
Процедура ГруппыРассылокОповещенийУстановитьПараметрыДинамическогоСписка(Список) Экспорт

	ОбщегоНазначенияКлиентСервер.УстановитьПараметрДинамическогоСписка(Список,
	                                                                   "ДляПисемИSMS",
	                                                                   НСтр("ru = 'Email и SMS'"));
	ОбщегоНазначенияКлиентСервер.УстановитьПараметрДинамическогоСписка(Список,
	                                                                   "ДляПисем",
	                                                                   НСтр("ru = 'Email'"));
	ОбщегоНазначенияКлиентСервер.УстановитьПараметрДинамическогоСписка(Список,
	                                                                   "ДляSMS",
	                                                                   НСтр("ru = 'SMS'"));
	ОбщегоНазначенияКлиентСервер.УстановитьПараметрДинамическогоСписка(Список,
	                                                                   "ИспользоватьПрочиеВзаимодействия",
	                                                                   ПолучитьФункциональнуюОпцию("ИспользоватьПрочиеВзаимодействия"));
	
КонецПроцедуры

// Инициализирует компоновщик настроек СКД, предварительно помещая СКД во временное хранилище.
//
// Параметры:
//  МакетСКД  - СхемаКомпоновкиДанных - СКД, компоновщик настроек которой будет инициализирован.
//  УникальныйИдентификатор  - УникальныйИдентификатор - уникальный идентификатор формы, для помещения СКД во временное хранилище.
//  
// Возвращаемое значение:
//   КомпоновщикНастроекКомпоновкиДанных - инициализированный компоновщик настроек СКД
//
Функция ИнициализироватьСКД(МакетСКД, УникальныйИдентификатор) Экспорт

	АдресСхемы = ПоместитьВоВременноеХранилище(МакетСКД,УникальныйИдентификатор);
	КомпоновщикНастроек = Новый КомпоновщикНастроекКомпоновкиДанных;
	КомпоновщикНастроек.Инициализировать(Новый ИсточникДоступныхНастроекКомпоновкиДанных(АдресСхемы));
	
	Возврат КомпоновщикНастроек;

КонецФункции 

// Заполняет реквизиты формы по группе рассылок и оповещений.
//
// Параметры:
//  Форма  - ФормаКлиентскогоПриложения - форма, реквизиты которой будут заполнены.
//  ГруппаРассылокИОповещений  - СправочникСсылка.ГруппыРассылокИОповещений - по ее данным будут заполнены реквизиты формы.
//
Процедура ЗаполнитьРеквизитыФормыПоГруппеРассылокИОповещений(Форма, ГруппаРассылокИОповещений) Экспорт

	РеквизитыГруппы = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ГруппаРассылокИОповещений,
	    "ПредназначенаДляЭлектронныхПисем, ПредназначенаДляSMS, ВидКонтактнойИнформацииПартнераДляПисем,
		|ВидКонтактнойИнформацииПартнераДляSMS, ВидКонтактнойИнформацииКонтактногоЛицаДляSMS,
		|ВидКонтактнойИнформацииКонтактногоЛицаДляПисем, Принудительная");
	ЗаполнитьЗначенияСвойств(Форма, РеквизитыГруппы);

КонецПроцедуры

// Добавляет значение в массив, если оно отсутствует в массиве.
//
// Параметры:
//  МассивДляДобавления - Массив - массив, в который происходит добавление.
//  ДобавляемоеЗначение - Произвольный - значение, которое будет добавлено в массив, если отсутствует.
//
Процедура ДобавитьВМассив(МассивДляДобавления, ДобавляемоеЗначение) Экспорт

	Если Не ЗначениеЗаполнено(ДобавляемоеЗначение) Тогда
		Возврат;
	КонецЕсли;
	
	Если МассивДляДобавления.Найти(ДобавляемоеЗначение) = Неопределено Тогда
		МассивДляДобавления.Добавить(ДобавляемоеЗначение);
	КонецЕсли;

КонецПроцедуры

// Формирует строку адресов из массива адресов, добавляя разделитель между элементами массива.
//
// Параметры:
//  МассивАдресов - Массив - массив, содержащий адреса.
//  Разделитель - Строка - разделитель, который будет добавлен между адресов в результирующей строке.
//
// Возвращаемое значение:
//   Строка   - сформированная строка.
//
Функция СтрокаАдресовИзМассива(МассивАдресов, Разделитель) Экспорт

	СтрокаКВозврату = "";
	
	Для Каждого ЭлементМассива Из МассивАдресов Цикл
		СтрокаКВозврату = СтрокаКВозврату + ?(ПустаяСтрока(СтрокаКВозврату),"" , Разделитель) + ЭлементМассива;
	КонецЦикла;
	
	Возврат СтрокаКВозврату;

КонецФункции

// Формирует структуру списков выбора КИ. Используется в форме "Группы рассылок и оповещений" и "Подписки".
//
// Параметры:
//  <Параметр1>  - <Тип.Вид> - <описание параметра>
//                 <продолжение описания параметра>
//  <Параметр2>  - <Тип.Вид> - <описание параметра>
//                 <продолжение описания параметра>.
//
// Возвращаемое значение:
//   Структура   - содержит следующие свойства: 
//      ПартнерыАдресЭлектроннойПочты - виды КИ партнера типа "Адрес электронной почты".
//      ПартнерыТелефон - виды КИ партнера типа "Телефон".
//      КонтактныеЛицаАдресЭлектроннойПочты - виды КИ контактного лица типа "Адрес электронной почты".
//      КонтактныеЛицаТелефон - виды КИ контактного лица типа "Телефон".
//
Функция СтруктураСписковВыбораКИ() Экспорт

	СтруктураСписковВыбора = Новый Структура;
	
	СтруктураСписковВыбора = Новый Структура;
	СтруктураСписковВыбора.Вставить("ПартнерыАдресЭлектроннойПочты",       Новый СписокЗначений);
	СтруктураСписковВыбора.Вставить("ПартнерыТелефон",                     Новый СписокЗначений);
	СтруктураСписковВыбора.Вставить("КонтактныеЛицаАдресЭлектроннойПочты", Новый СписокЗначений);
	СтруктураСписковВыбора.Вставить("КонтактныеЛицаТелефон",               Новый СписокЗначений);
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ВидыКонтактнойИнформации.Ссылка,
	|	ВидыКонтактнойИнформации.Наименование,
	|	ВидыКонтактнойИнформации.Родитель КАК Родитель,
	|	ВидыКонтактнойИнформации.Тип КАК Тип
	|ИЗ
	|	Справочник.ВидыКонтактнойИнформации КАК ВидыКонтактнойИнформации
	|ГДЕ
	|	(ВидыКонтактнойИнформации.Родитель = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.СправочникПартнеры)
	|			ИЛИ ВидыКонтактнойИнформации.Родитель = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.СправочникКонтактныеЛицаПартнеров))
	|	И (ВидыКонтактнойИнформации.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Телефон)
	|			ИЛИ ВидыКонтактнойИнформации.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.АдресЭлектроннойПочты))
	|ИТОГИ ПО
	|	Родитель,
	|	Тип";
	
	ВыборкаРодитель = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Пока ВыборкаРодитель.Следующий() Цикл
		
		ВыборкаТип = ВыборкаРодитель.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		
		Пока ВыборкаТип.Следующий() Цикл
			
			Если ВыборкаТип.Родитель = Справочники.ВидыКонтактнойИнформации.СправочникПартнеры Тогда
				Если ВыборкаТип.Тип = Перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты Тогда
					ИмяКлюча = "ПартнерыАдресЭлектроннойПочты";
				Иначе
					ИмяКлюча = "ПартнерыТелефон";
				КонецЕсли;
			Иначе
				Если ВыборкаТип.Тип = Перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты Тогда
					ИмяКлюча = "КонтактныеЛицаАдресЭлектроннойПочты";
				Иначе
					ИмяКлюча = "КонтактныеЛицаТелефон";
				КонецЕсли;
			КонецЕсли;
			
			ВыборкаДетали = ВыборкаТип.Выбрать();
			
			СписокВидовКИ = Новый СписокЗначений;
			
			Пока ВыборкаДетали.Следующий() Цикл
				
				СписокВидовКИ.Добавить(ВыборкаДетали.Ссылка, ВыборкаДетали.Наименование);
				
			КонецЦикла;
			
			СтруктураСписковВыбора.Вставить(ИмяКлюча, СписокВидовКИ);
			
		КонецЦикла;
		
	КонецЦикла;
	
	Возврат СтруктураСписковВыбора;

КонецФункции

// Копирует значения одного списка значений в другой
//
// Параметры:
//  Приемник  - СписокЗначений - список значений, в который будут скопированы элементы.
//  Источник  - СписокЗначений - список значений, из которого будут скопированы элементы.
//
Процедура СкопироватьЗначенияСпискаЗначений(Приемник, Источник) Экспорт

	Приемник.Очистить();
	
	Для Инд = 0 По Источник.Количество() - 1 Цикл 
		
		ЭлементСписка = Источник.Получить(Инд);
		Приемник.Добавить(ЭлементСписка.Значение, ЭлементСписка.Представление);
		
	КонецЦикла;

КонецПроцедуры

// Формирует текст контекстной справки для настройки "Отправлять контактному лицу объекта оповещения".
//
// Возвращаемое значение:
//   Строка   - текст контекстной подсказки.
//
Функция ТекстПоясненияКонтактноеЛицоОбъектаОповещения() Экспорт
	
	Возврат НСтр("ru = 'Когда это возможно, оповещение будет отправлено контактному лицу, указанному в объекте, являющемся
	                   |источником оповещения. Например, оповещение по изменившемуся состоянию ""Заказа клиента"" будет 
	                   |послано контактному лицу, указанному в документе.'");
	
КонецФункции

// Формирует строку с информацией о адресатах подписки.
//
// Параметры:
//  Данные          - Структура - содержит информацию о подписке.
//  Принудительная  - Булево - признак, того что, сообщения будет отравляться в принудительном порядке.
//
// Возвращаемое значение:
//   Строка   - строку с информацией о адресатах подписки.
//
Функция ТекстКомуБудутОтправленыСообщения(Данные, Принудительная = Ложь) Экспорт

	ТекстАдресаты = "";
	Если Данные.ОтправлятьПартнеру Тогда
		ТекстАдресаты = НСтр("ru = 'Партнер'");
	КонецЕсли;
	
	Если Данные.ОтправлятьКонтактномуЛицуОбъектаОповещения Тогда
		ДобавитьЗапятуюЕслиНеПустойТекст(ТекстАдресаты);
		ТекстАдресаты = ТекстАдресаты + НСтр("ru = 'контактное лицо объекта оповещения'");
	КонецЕсли;
	
	Если Принудительная Тогда
		
		Если Данные.ОтравлятьКонтактнымЛицаРоли Тогда
			ДобавитьЗапятуюЕслиНеПустойТекст(ТекстАдресаты);
			ТекстКЛ = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'контактные лица роли ""%1""'"),
			Данные.НаименованиеРолиКонтактногоЛица);
			ТекстАдресаты = ТекстАдресаты + ТекстКЛ;
		КонецЕсли;
		
	Иначе
		
		Если Данные.КоличествоДопАдресатов Тогда
			
			ДобавитьЗапятуюЕслиНеПустойТекст(ТекстАдресаты);
			ТекстКЛ = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'контактные лица - %1 чел'"),
			Данные.КоличествоДопАдресатов);
			ТекстАдресаты = ТекстАдресаты + ТекстКЛ;
			
		КонецЕсли;
		
	КонецЕсли;
	
	ТекстАдресаты = ТекстАдресаты + ?(ПустаяСтрока(ТекстАдресаты), "", ".");
	ТекстАдресаты = ВРег(Лев(ТекстАдресаты, 1)) + Прав(ТекстАдресаты, СтрДлина(ТекстАдресаты) - 1);
	
	Возврат ТекстАдресаты;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область АнализДанныхДляОповещенийКлиентов

Процедура АнализДанныхПоздравленияСДнемРождения(ВидОповещения)

	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ВидыОповещенийКлиентам.ГруппаРассылокИОповещений,
	|	ГруппыРассылокИОповещений.Принудительная,
	|	ГруппыРассылокИОповещений.ОтправлятьКонтактномуЛицуОбъектаОповещения
	|ИЗ
	|	Справочник.ВидыОповещенийКлиентам КАК ВидыОповещенийКлиентам
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ГруппыРассылокИОповещений КАК ГруппыРассылокИОповещений
	|		ПО ВидыОповещенийКлиентам.ГруппаРассылокИОповещений = ГруппыРассылокИОповещений.Ссылка
	|ГДЕ
	|	ВидыОповещенийКлиентам.Ссылка = &ВидОповещения";
	
	Запрос.УстановитьПараметр("ВидОповещения", ВидОповещения);
	
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	
	Запрос = Новый Запрос;
	
	Если Выборка.Принудительная Тогда
		
		Если Не Выборка.ОтправлятьКонтактномуЛицуОбъектаОповещения Тогда
			Возврат;
		КонецЕсли;
		
		Запрос.Текст = "
		|ВЫБРАТЬ
		|	КонтактныеЛицаПартнеров.Ссылка КАК ИсточникОповещения,
		|	НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, 1), ДЕНЬ) КАК ДатаОтправки,
		|	НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, 2), ДЕНЬ) КАК ДатаАктуальностиОтправки,
		|	КонтактныеЛицаПартнеров.Владелец КАК Подписчик
		|ИЗ
		|	Справочник.КонтактныеЛицаПартнеров КАК КонтактныеЛицаПартнеров
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОчередьСобытийДляОповещенийКлиентам КАК ОчередьСобытийДляОповещенийКлиентам
		|		ПО КонтактныеЛицаПартнеров.Ссылка = ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения
		|			И (ОчередьСобытийДляОповещенийКлиентам.ВидОповещения = &ВидОповещения)
		|ГДЕ
		|	НЕ КонтактныеЛицаПартнеров.ПометкаУдаления
		|	И КонтактныеЛицаПартнеров.ДатаРождения <> ДАТАВРЕМЯ(1, 1, 1)
		|	И ДЕНЬ(КонтактныеЛицаПартнеров.ДатаРождения) = ДЕНЬ(ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, 1))
		|	И МЕСЯЦ(КонтактныеЛицаПартнеров.ДатаРождения) = МЕСЯЦ(ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, 1))
		|	И ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения ЕСТЬ NULL ";
		
	Иначе
		
		Запрос.Текст = "
		|ВЫБРАТЬ
		|	КонтактныеЛицаПартнеров.Ссылка КАК ИсточникОповещения,
		|	НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, 1), ДЕНЬ) КАК ДатаОтправки,
		|	НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, 2), ДЕНЬ) КАК ДатаАктуальностиОтправки,
		|	КонтактныеЛицаПартнеров.Владелец КАК Подписчик
		|ИЗ
		|	Справочник.КонтактныеЛицаПартнеров КАК КонтактныеЛицаПартнеров
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОчередьСобытийДляОповещенийКлиентам КАК ОчередьСобытийДляОповещенийКлиентам
		|		ПО КонтактныеЛицаПартнеров.Ссылка = ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения
		|			И (ОчередьСобытийДляОповещенийКлиентам.ВидОповещения = &ВидОповещения)
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПодпискиНаРассылкиИОповещенияКлиентам КАК ПодпискиНаРассылкиИОповещенияКлиентам
		|		ПО КонтактныеЛицаПартнеров.Владелец = ПодпискиНаРассылкиИОповещенияКлиентам.Владелец
		|			И (ПодпискиНаРассылкиИОповещенияКлиентам.ПодпискаДействует)
		|			И (ПодпискиНаРассылкиИОповещенияКлиентам.ОтправлятьКонтактномуЛицуОбъектаОповещения)
		|			И (НЕ ПодпискиНаРассылкиИОповещенияКлиентам.ПометкаУдаления)
		|			И (ПодпискиНаРассылкиИОповещенияКлиентам.ГруппаРассылокИОповещений = &ГруппаРассылокИОповещений)
		|ГДЕ
		|	НЕ КонтактныеЛицаПартнеров.ПометкаУдаления
		|	И КонтактныеЛицаПартнеров.ДатаРождения <> ДАТАВРЕМЯ(1, 1, 1)
		|	И ДЕНЬ(КонтактныеЛицаПартнеров.ДатаРождения) = ДЕНЬ(ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, 1))
		|	И МЕСЯЦ(КонтактныеЛицаПартнеров.ДатаРождения) = МЕСЯЦ(ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, 1))
		|	И ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения ЕСТЬ NULL ";
		
	КонецЕсли;
	
	Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДатаСеанса());
	Запрос.УстановитьПараметр("ВидОповещения", ВидОповещения);
	Запрос.УстановитьПараметр("ГруппаРассылокИОповещений", Выборка.ГруппаРассылокИОповещений);
	
	ВыборкаОчередь = Запрос.Выполнить().Выбрать();
		
	Пока ВыборкаОчередь.Следующий() Цикл
		
		РегистрыСведений.ОчередьСобытийДляОповещенийКлиентам.ВыполнитьЗаписьВРегистр(
		                ВидОповещения,
		                ВыборкаОчередь.Подписчик,
		                ВыборкаОчередь.ИсточникОповещения,
		                ВыборкаОчередь.ДатаОтправки,
		                ВыборкаОчередь.ДатаАктуальностиОтправки);
		
	КонецЦикла;

КонецПроцедуры

Процедура АнализПросроченнаяЗадолженность(ВидОповещения)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ВидыОповещенийКлиентам.ГруппаРассылокИОповещений,
	|	ГруппыРассылокИОповещений.Принудительная,
	|	ГруппыРассылокИОповещений.ОтправлятьПартнеру,
	|	ГруппыРассылокИОповещений.ОтправлятьКонтактнымЛицамРоли
	|ИЗ
	|	Справочник.ВидыОповещенийКлиентам КАК ВидыОповещенийКлиентам
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ГруппыРассылокИОповещений КАК ГруппыРассылокИОповещений
	|		ПО ВидыОповещенийКлиентам.ГруппаРассылокИОповещений = ГруппыРассылокИОповещений.Ссылка
	|ГДЕ
	|	ВидыОповещенийКлиентам.Ссылка = &ВидОповещения";
	
	Запрос.УстановитьПараметр("ВидОповещения", ВидОповещения);
	
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	
	Запрос = Новый Запрос;
	
	Если Выборка.Принудительная Тогда
		
		Если Не Выборка.ОтправлятьПартнеру И НЕ Выборка.ОтправлятьКонтактнымЛицамРоли Тогда
			Возврат;
		КонецЕсли;
		
		Запрос.Текст = "
		|ВЫБРАТЬ
		|	ВложенныйЗапрос.ИсточникОповещения КАК ИсточникОповещения,
		|	СУММА(ВложенныйЗапрос.СуммаОстаток) КАК СуммаОстаток,
		|	СУММА(ВложенныйЗапрос.КОплатеОстаток) КАК КОплатеОстаток
		|ИЗ
		|	(ВЫБРАТЬ
		|		РасчетыСКлиентамиОстатки.АналитикаУчетаПоПартнерам.Партнер КАК ИсточникОповещения,
		|		РасчетыСКлиентамиОстатки.ОбъектРасчетов КАК ОбъектРасчетов,
		|		СУММА(РасчетыСКлиентамиОстатки.СуммаОстаток) КАК СуммаОстаток,
		|		СУММА(РасчетыСКлиентамиОстатки.КОплатеОстаток) КАК КОплатеОстаток
		|	ИЗ
		|		РегистрНакопления.РасчетыСКлиентами.Остатки(&ТекущаяДата, ) КАК РасчетыСКлиентамиОстатки
		|			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОчередьСобытийДляОповещенийКлиентам КАК ОчередьСобытийДляОповещенийКлиентам
		|				ПО РасчетыСКлиентамиОстатки.АналитикаУчетаПоПартнерам.Партнер = ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения
		|					И (ОчередьСобытийДляОповещенийКлиентам.ВидОповещения = &ВидОповещения)
		|	ГДЕ
		|		ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения ЕСТЬ NULL 
		|	СГРУППИРОВАТЬ ПО
		|		РасчетыСКлиентамиОстатки.АналитикаУчетаПоПартнерам.Партнер,
		|		РасчетыСКлиентамиОстатки.ОбъектРасчетов
		|	ИМЕЮЩИЕ
		|		СУММА(РасчетыСКлиентамиОстатки.КОплатеОстаток) > 0) КАК ВложенныйЗапрос
		|СГРУППИРОВАТЬ ПО
		|	ВложенныйЗапрос.ИсточникОповещения"
		
	Иначе
		
		Запрос.Текст = "
		|ВЫБРАТЬ
		|	ВложенныйЗапрос.ИсточникОповещения КАК ИсточникОповещения,
		|	СУММА(ВложенныйЗапрос.СуммаОстаток) КАК СуммаОстаток,
		|	СУММА(ВложенныйЗапрос.КОплатеОстаток) КАК КОплатеОстаток
		|ИЗ
		|	(ВЫБРАТЬ
		|		РасчетыСКлиентамиОстатки.АналитикаУчетаПоПартнерам.Партнер КАК ИсточникОповещения,
		|		РасчетыСКлиентамиОстатки.ОбъектРасчетов КАК ОбъектРасчетов,
		|		СУММА(РасчетыСКлиентамиОстатки.СуммаОстаток) КАК СуммаОстаток,
		|		СУММА(РасчетыСКлиентамиОстатки.КОплатеОстаток) КАК КОплатеОстаток
		|	ИЗ
		|		РегистрНакопления.РасчетыСКлиентами.Остатки(
		|			&ТекущаяДата,
		|			АналитикаУчетаПоПартнерам.Партнер В
		|				(ВЫБРАТЬ
		|					ПодпискиНаРассылкиИОповещенияКлиентам.Владелец
		|				ИЗ
		|					Справочник.ПодпискиНаРассылкиИОповещенияКлиентам КАК ПодпискиНаРассылкиИОповещенияКлиентам
		|						ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОчередьСобытийДляОповещенийКлиентам КАК ОчередьСобытийДляОповещенийКлиентам
		|						ПО
		|							ПодпискиНаРассылкиИОповещенияКлиентам.Владелец = ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения
		|								И ОчередьСобытийДляОповещенийКлиентам.ВидОповещения = &ВидОповещения
		|				ГДЕ
		|					ПодпискиНаРассылкиИОповещенияКлиентам.ГруппаРассылокИОповещений = &ГруппаРассылокИОповещений
		|					И НЕ ПодпискиНаРассылкиИОповещенияКлиентам.ПометкаУдаления
		|					И ПодпискиНаРассылкиИОповещенияКлиентам.ПодпискаДействует
		|					И (ПодпискиНаРассылкиИОповещенияКлиентам.ОтправлятьПартнеру
		|						ИЛИ ПодпискиНаРассылкиИОповещенияКлиентам.КоличествоКонтактныхЛицАдресатов > 0)
		|					И ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения ЕСТЬ NULL )) КАК РасчетыСКлиентамиОстатки
		|	СГРУППИРОВАТЬ ПО
		|		РасчетыСКлиентамиОстатки.АналитикаУчетаПоПартнерам.Партнер,
		|		РасчетыСКлиентамиОстатки.ОбъектРасчетов
		|	ИМЕЮЩИЕ
		|		СУММА(РасчетыСКлиентамиОстатки.КОплатеОстаток) > 0) КАК ВложенныйЗапрос
		|СГРУППИРОВАТЬ ПО
		|	ВложенныйЗапрос.ИсточникОповещения";
		
	КонецЕсли;

	
	Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДатаСеанса());
	Запрос.УстановитьПараметр("ВидОповещения", ВидОповещения);
	Запрос.УстановитьПараметр("ГруппаРассылокИОповещений", Выборка.ГруппаРассылокИОповещений);
	
	ВыборкаОчередь = Запрос.Выполнить().Выбрать();
		
	Пока ВыборкаОчередь.Следующий() Цикл
		
		РегистрыСведений.ОчередьСобытийДляОповещенийКлиентам.ВыполнитьЗаписьВРегистр(
		                ВидОповещения,
		                ВыборкаОчередь.ИсточникОповещения,
		                ВыборкаОчередь.ИсточникОповещения,
		                Дата(1,1,1),
		                Дата(1,1,1));
		
	КонецЦикла;
	
КонецПроцедуры

Процедура АнализПлановыеПлатежи(ВидОповещения)

	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ВидыОповещенийКлиентам.ГруппаРассылокИОповещений,
	|	ГруппыРассылокИОповещений.Принудительная,
	|	ГруппыРассылокИОповещений.ОтправлятьПартнеру,
	|	ГруппыРассылокИОповещений.ОтправлятьКонтактнымЛицамРоли
	|ИЗ
	|	Справочник.ВидыОповещенийКлиентам КАК ВидыОповещенийКлиентам
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ГруппыРассылокИОповещений КАК ГруппыРассылокИОповещений
	|		ПО ВидыОповещенийКлиентам.ГруппаРассылокИОповещений = ГруппыРассылокИОповещений.Ссылка
	|ГДЕ
	|	ВидыОповещенийКлиентам.Ссылка = &ВидОповещения";
	
	Запрос.УстановитьПараметр("ВидОповещения", ВидОповещения);
	
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	
	Запрос = Новый Запрос;
	
	Если Выборка.Принудительная Тогда
		
		Если Не Выборка.ОтправлятьПартнеру И НЕ Выборка.ОтправлятьКонтактнымЛицамРоли Тогда
			Возврат;
		КонецЕсли;
		
		Запрос.Текст = "
		|ВЫБРАТЬ
		|	РасчетыСКлиентамиОстатки.АналитикаУчетаПоПартнерам.Партнер КАК ИсточникОповещения,
		|	СУММА(РасчетыСКлиентамиОстатки.СуммаОстаток) КАК СуммаОстаток
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентами.Остатки(ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, 2), ) КАК РасчетыСКлиентамиОстатки
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОчередьСобытийДляОповещенийКлиентам КАК ОчередьСобытийДляОповещенийКлиентам
		|		ПО РасчетыСКлиентамиОстатки.АналитикаУчетаПоПартнерам.Партнер = ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения
		|			И (ОчередьСобытийДляОповещенийКлиентам.ВидОповещения = &ВидОповещения)
		|ГДЕ
		|	ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения ЕСТЬ NULL 
		|
		|СГРУППИРОВАТЬ ПО
		|	РасчетыСКлиентамиОстатки.АналитикаУчетаПоПартнерам.Партнер
		|
		|ИМЕЮЩИЕ
		|	СУММА(РасчетыСКлиентамиОстатки.СуммаОстаток) > 0";
		
	Иначе
		
		Запрос.Текст = "
		|ВЫБРАТЬ
		|	РасчетыСКлиентамиОстатки.АналитикаУчетаПоПартнерам.Партнер КАК ИсточникОповещения,
		|	СУММА(РасчетыСКлиентамиОстатки.КОплатеОстаток) КАК КОплатеОстаток
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентами.Остатки(
		|			ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, 2),
		|			АналитикаУчетаПоПартнерам.Партнер В
		|				(ВЫБРАТЬ
		|					ПодпискиНаРассылкиИОповещенияКлиентам.Владелец
		|				ИЗ
		|					Справочник.ПодпискиНаРассылкиИОповещенияКлиентам КАК ПодпискиНаРассылкиИОповещенияКлиентам
		|						ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОчередьСобытийДляОповещенийКлиентам КАК ОчередьСобытийДляОповещенийКлиентам
		|						ПО
		|							ПодпискиНаРассылкиИОповещенияКлиентам.Владелец = ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения
		|								И ОчередьСобытийДляОповещенийКлиентам.ВидОповещения = &ВидОповещения
		|				ГДЕ
		|					ПодпискиНаРассылкиИОповещенияКлиентам.ГруппаРассылокИОповещений = &ГруппаРассылокИОповещений
		|					И НЕ ПодпискиНаРассылкиИОповещенияКлиентам.ПометкаУдаления
		|					И ПодпискиНаРассылкиИОповещенияКлиентам.ПодпискаДействует
		|					И (ПодпискиНаРассылкиИОповещенияКлиентам.ОтправлятьПартнеру
		|						ИЛИ ПодпискиНаРассылкиИОповещенияКлиентам.КоличествоКонтактныхЛицАдресатов > 0)
		|					И ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения ЕСТЬ NULL )) КАК РасчетыСКлиентамиОстатки
		|
		|СГРУППИРОВАТЬ ПО
		|	РасчетыСКлиентамиОстатки.АналитикаУчетаПоПартнерам.Партнер
		|
		|ИМЕЮЩИЕ
		|	СУММА(РасчетыСКлиентамиОстатки.КОплатеОстаток) > 0"
		
		
	КонецЕсли;
	
	ДатаАнализа = ТекущаяДатаСеанса();
	
	Запрос.УстановитьПараметр("ТекущаяДата", ДатаАнализа);
	Запрос.УстановитьПараметр("ВидОповещения", ВидОповещения);
	Запрос.УстановитьПараметр("ГруппаРассылокИОповещений", Выборка.ГруппаРассылокИОповещений);
	
	ВыборкаОчередь = Запрос.Выполнить().Выбрать();
		
	Пока ВыборкаОчередь.Следующий() Цикл
		
		РегистрыСведений.ОчередьСобытийДляОповещенийКлиентам.ВыполнитьЗаписьВРегистр(
		                ВидОповещения,
		                ВыборкаОчередь.ИсточникОповещения,
		                ВыборкаОчередь.ИсточникОповещения,
		                Дата(1, 1, 1),
		                НачалоДня(ДатаАнализа + 86400 * 2));
		
	КонецЦикла;

КонецПроцедуры

Процедура АнализПлановыеОтгрузки(ВидОповещения)

	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ВидыОповещенийКлиентам.ГруппаРассылокИОповещений,
	|	ГруппыРассылокИОповещений.Принудительная,
	|	ГруппыРассылокИОповещений.ОтправлятьПартнеру,
	|	ГруппыРассылокИОповещений.ОтправлятьКонтактнымЛицамРоли,
	|	ГруппыРассылокИОповещений.ОтправлятьКонтактномуЛицуОбъектаОповещения
	|ИЗ
	|	Справочник.ВидыОповещенийКлиентам КАК ВидыОповещенийКлиентам
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ГруппыРассылокИОповещений КАК ГруппыРассылокИОповещений
	|		ПО ВидыОповещенийКлиентам.ГруппаРассылокИОповещений = ГруппыРассылокИОповещений.Ссылка
	|ГДЕ
	|	ВидыОповещенийКлиентам.Ссылка = &ВидОповещения";
	
	Запрос.УстановитьПараметр("ВидОповещения", ВидОповещения);
	
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	
	Запрос = Новый Запрос;
	
	Если Выборка.Принудительная Тогда
		
		Если Не Выборка.ОтправлятьПартнеру И НЕ Выборка.ОтправлятьКонтактнымЛицамРоли И НЕ Выборка.ОтправлятьКонтактномуЛицуОбъектаОповещения Тогда
			Возврат;
		КонецЕсли;
		
		Запрос.Текст = "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Отбор.Распоряжение         КАК ИсточникОповещения,
		|	Отбор.Распоряжение.Партнер КАК Подписчик,
		|	&ДатаСобытия               КАК ДатаСобытия
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаОтгрузку.Обороты(,,,Распоряжение В (ВЫБРАТЬ
		|																	ОткрытыеЗаказы.Распоряжение 
		|																ИЗ
		|																	РегистрСведений.РаспоряженияНаОтгрузкуКВыполнению КАК ОткрытыеЗаказы
		|																ГДЕ
		|																	ОткрытыеЗаказы.Распоряжение ССЫЛКА Документ.ЗаказКлиента)) КАК Отбор
		|
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РаспоряженияНаОтгрузку КАК ТаблицаКОформлению
		|		ПО Отбор.Распоряжение = ТаблицаКОформлению.Распоряжение
		|		 И Отбор.КодСтроки    = ТаблицаКОформлению.КодСтроки
		|		 И Отбор.КОформлениюОборот > 0
		|		 И ТаблицаКОформлению.КОформлению > 0
		|		 И ТаблицаКОформлению.ВидДвиженияРегистра = ЗНАЧЕНИЕ(Перечисление.ВидыДвиженияНакопления.Приход)
		|		 И ТаблицаКОформлению.Активность
		|		 И ТаблицаКОформлению.Период = &ДатаСобытия
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОчередьСобытийДляОповещенийКлиентам КАК ОчередьСобытийДляОповещенийКлиентам
		|		ПО Отбор.Распоряжение.Партнер = ОчередьСобытийДляОповещенийКлиентам.Подписчик
		|		 И Отбор.Распоряжение = ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения
		|		 И ОчередьСобытийДляОповещенийКлиентам.ВидОповещения = &ВидОповещения
		|ГДЕ
		|	ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения ЕСТЬ NULL";
		
	Иначе
		
		 Запрос.Текст = "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Отбор.Распоряжение         КАК ИсточникОповещения,
		|	Отбор.Распоряжение.Партнер КАК Подписчик,
		|	&ДатаСобытия               КАК ДатаСобытия
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаОтгрузку.Обороты(,,,Распоряжение В (ВЫБРАТЬ
		|																	ОткрытыеЗаказы.Распоряжение 
		|																ИЗ
		|																	РегистрСведений.РаспоряженияНаОтгрузкуКВыполнению КАК ОткрытыеЗаказы
		|																ГДЕ
		|																	ОткрытыеЗаказы.Распоряжение ССЫЛКА Документ.ЗаказКлиента)) КАК Отбор
		|
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РаспоряженияНаОтгрузку КАК ТаблицаКОформлению
		|		ПО Отбор.Распоряжение = ТаблицаКОформлению.Распоряжение
		|		 И Отбор.КодСтроки    = ТаблицаКОформлению.КодСтроки
		|		 И Отбор.КОформлениюОборот > 0
		|		 И ТаблицаКОформлению.КОформлению > 0
		|		 И ТаблицаКОформлению.ВидДвиженияРегистра = ЗНАЧЕНИЕ(Перечисление.ВидыДвиженияНакопления.Приход)
		|		 И ТаблицаКОформлению.Активность
		|		 И ТаблицаКОформлению.Период = &ДатаСобытия
		|
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПодпискиНаРассылкиИОповещенияКлиентам КАК ПодпискиНаРассылкиИОповещенияКлиентам
		|		ПО Отбор.Распоряжение.Партнер = ПодпискиНаРассылкиИОповещенияКлиентам.Владелец
		|		 И ПодпискиНаРассылкиИОповещенияКлиентам.ПодпискаДействует
		|		 И ПодпискиНаРассылкиИОповещенияКлиентам.ОтправлятьКонтактномуЛицуОбъектаОповещения
		|		 И НЕ ПодпискиНаРассылкиИОповещенияКлиентам.ПометкаУдаления
		|		 И ПодпискиНаРассылкиИОповещенияКлиентам.ГруппаРассылокИОповещений = &ГруппаРассылокИОповещений
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОчередьСобытийДляОповещенийКлиентам КАК ОчередьСобытийДляОповещенийКлиентам
		|		ПО Отбор.Распоряжение.Партнер = ОчередьСобытийДляОповещенийКлиентам.Подписчик
		|		 И Отбор.Распоряжение = ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения
		|		 И ОчередьСобытийДляОповещенийКлиентам.ВидОповещения = &ВидОповещения
		|ГДЕ
		|	ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения ЕСТЬ NULL";
		
	КонецЕсли;
	
	ДатаАнализа = ТекущаяДатаСеанса(); 
	
	Запрос.УстановитьПараметр("ДатаСобытия", НачалоДня(ДатаАнализа + 86400));
	Запрос.УстановитьПараметр("ВидОповещения", ВидОповещения);
	Запрос.УстановитьПараметр("ГруппаРассылокИОповещений", Выборка.ГруппаРассылокИОповещений);
	
	ВыборкаОчередь = Запрос.Выполнить().Выбрать();
		
	Пока ВыборкаОчередь.Следующий() Цикл
		
		РегистрыСведений.ОчередьСобытийДляОповещенийКлиентам.ВыполнитьЗаписьВРегистр(
		                ВидОповещения,
		                ВыборкаОчередь.Подписчик,
		                ВыборкаОчередь.ИсточникОповещения,
		                Дата(1, 1, 1),
		                КонецДня(ВыборкаОчередь.ДатаСобытия));
		
	КонецЦикла;

КонецПроцедуры

Процедура АнализОкончаниеОпроса(ВидОповещения)

	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ВидыОповещенийКлиентам.ГруппаРассылокИОповещений,
	|	ГруппыРассылокИОповещений.Принудительная,
	|	ГруппыРассылокИОповещений.ОтправлятьПартнеру,
	|	ГруппыРассылокИОповещений.ОтправлятьКонтактнымЛицамРоли,
	|	ГруппыРассылокИОповещений.ОтправлятьКонтактномуЛицуОбъектаОповещения
	|ИЗ
	|	Справочник.ВидыОповещенийКлиентам КАК ВидыОповещенийКлиентам
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ГруппыРассылокИОповещений КАК ГруппыРассылокИОповещений
	|		ПО ВидыОповещенийКлиентам.ГруппаРассылокИОповещений = ГруппыРассылокИОповещений.Ссылка
	|ГДЕ
	|	ВидыОповещенийКлиентам.Ссылка = &ВидОповещения";
	
	Запрос.УстановитьПараметр("ВидОповещения", ВидОповещения);
	
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	
	Запрос = Новый Запрос;
	
	Если Выборка.Принудительная Тогда
		
		Если (НЕ Выборка.ОтправлятьПартнеру) ИЛИ (НЕ Выборка.ОтправлятьКонтактномуЛицуОбъектаОповещения) Тогда
			Возврат;
		КонецЕсли;
		
		Запрос.Текст = "
		|ВЫБРАТЬ
		|	НазначениеОпросов.Ссылка,
		|	НазначениеОпросов.ТипРеспондентов,
		|	НазначениеОпросов.СвободныйОпрос
		|ПОМЕСТИТЬ ЗаканчивающиесяОпросы
		|ИЗ
		|	Документ.НазначениеОпросов КАК НазначениеОпросов
		|ГДЕ
		|	НазначениеОпросов.Проведен
		|	И НазначениеОпросов.ДатаНачала < &ТекущаяДата
		|	И ДЕНЬ(НазначениеОпросов.ДатаОкончания) = ДЕНЬ(ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, 2))
		|	И (НазначениеОпросов.ТипРеспондентов = ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка)
		|			ИЛИ НазначениеОпросов.ТипРеспондентов = ЗНАЧЕНИЕ(Справочник.КонтактныеЛицаПартнеров.ПустаяСсылка))
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЗаканчивающиесяОпросы.Ссылка КАК Опрос,
		|	Партнеры.Ссылка КАК Респондент,
		|	ЗаканчивающиесяОпросы.ТипРеспондентов
		|ПОМЕСТИТЬ ОпросыРеспонденты
		|ИЗ
		|	ЗаканчивающиесяОпросы КАК ЗаканчивающиесяОпросы
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Партнеры КАК Партнеры
		|		ПО (ИСТИНА)
		|			И (ЗаканчивающиесяОпросы.СвободныйОпрос)
		|			И (ЗаканчивающиесяОпросы.ТипРеспондентов = ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка))
		|			И (НЕ Партнеры.ПометкаУдаления)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЗаканчивающиесяОпросы.Ссылка,
		|	КонтактныеЛица.Ссылка,
		|	ЗаканчивающиесяОпросы.ТипРеспондентов
		|ИЗ
		|	ЗаканчивающиесяОпросы КАК ЗаканчивающиесяОпросы
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров КАК КонтактныеЛица
		|		ПО (ИСТИНА)
		|			И (ЗаканчивающиесяОпросы.СвободныйОпрос)
		|			И (ЗаканчивающиесяОпросы.ТипРеспондентов = ЗНАЧЕНИЕ(Справочник.КонтактныеЛицаПартнеров.ПустаяСсылка))
		|			И (НЕ КонтактныеЛица.ПометкаУдаления)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЗаканчивающиесяОпросы.Ссылка,
		|	НазначениеОпросовРеспонденты.Респондент,
		|	ЗаканчивающиесяОпросы.ТипРеспондентов
		|ИЗ
		|	ЗаканчивающиесяОпросы КАК ЗаканчивающиесяОпросы
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.НазначениеОпросов.Респонденты КАК НазначениеОпросовРеспонденты
		|		ПО ЗаканчивающиесяОпросы.Ссылка = НазначениеОпросовРеспонденты.Ссылка
		|			И (НЕ ЗаканчивающиесяОпросы.СвободныйОпрос)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ОпросыРеспонденты.Опрос КАК ИсточникОповещения,
		|	ВЫБОР
		|		КОГДА ОпросыРеспонденты.ТипРеспондентов = ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка)
		|			ТОГДА ОпросыРеспонденты.Респондент
		|		ИНАЧЕ ОпросыРеспонденты.Респондент.Владелец
		|	КОНЕЦ КАК Подписчик,
		|	КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, 2), ДЕНЬ) КАК ДатаАктуальностиОтправки
		|ПОМЕСТИТЬ НеЗаполнившиеРеспондентыОпросы
		|ИЗ
		|	ОпросыРеспонденты КАК ОпросыРеспонденты
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Анкета КАК Анкета
		|		ПО ОпросыРеспонденты.Опрос = Анкета.Опрос
		|			И ОпросыРеспонденты.Респондент = Анкета.Респондент
		|			И (Анкета.Проведен)
		|ГДЕ
		|	Анкета.Ссылка ЕСТЬ NULL 
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	НеЗаполнившиеРеспондентыОпросы.ИсточникОповещения,
		|	НеЗаполнившиеРеспондентыОпросы.Подписчик,
		|	НеЗаполнившиеРеспондентыОпросы.ДатаАктуальностиОтправки
		|ИЗ
		|	НеЗаполнившиеРеспондентыОпросы КАК НеЗаполнившиеРеспондентыОпросы
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОчередьСобытийДляОповещенийКлиентам КАК ОчередьСобытийДляОповещенийКлиентам
		|		ПО НеЗаполнившиеРеспондентыОпросы.ИсточникОповещения = ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения
		|			И НеЗаполнившиеРеспондентыОпросы.Подписчик = ОчередьСобытийДляОповещенийКлиентам.Подписчик
		|			И (ОчередьСобытийДляОповещенийКлиентам.ВидОповещения = &ВидОповещения)
		|ГДЕ
		|	ОчередьСобытийДляОповещенийКлиентам.ВидОповещения ЕСТЬ NULL ";
		
	Иначе
		
		Запрос.Текст = "
		|ВЫБРАТЬ
		|	НазначениеОпросов.Ссылка,
		|	НазначениеОпросов.ТипРеспондентов,
		|	НазначениеОпросов.СвободныйОпрос
		|ПОМЕСТИТЬ ЗаканчивающиесяОпросы
		|ИЗ
		|	Документ.НазначениеОпросов КАК НазначениеОпросов
		|ГДЕ
		|	НазначениеОпросов.Проведен
		|	И НазначениеОпросов.ДатаНачала < &ТекущаяДата
		|	И ДЕНЬ(НазначениеОпросов.ДатаОкончания) = ДЕНЬ(ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, 2))
		|	И (НазначениеОпросов.ТипРеспондентов = ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка)
		|			ИЛИ НазначениеОпросов.ТипРеспондентов = ЗНАЧЕНИЕ(Справочник.КонтактныеЛицаПартнеров.ПустаяСсылка))
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЗаканчивающиесяОпросы.Ссылка КАК Опрос,
		|	Партнеры.Ссылка КАК Респондент,
		|	ЗаканчивающиесяОпросы.ТипРеспондентов
		|ПОМЕСТИТЬ ОпросыРеспонденты
		|ИЗ
		|	ЗаканчивающиесяОпросы КАК ЗаканчивающиесяОпросы
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Партнеры КАК Партнеры
		|		ПО (ИСТИНА)
		|			И (ЗаканчивающиесяОпросы.СвободныйОпрос)
		|			И (ЗаканчивающиесяОпросы.ТипРеспондентов = ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка))
		|			И (НЕ Партнеры.ПометкаУдаления)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЗаканчивающиесяОпросы.Ссылка,
		|	КонтактныеЛица.Ссылка,
		|	ЗаканчивающиесяОпросы.ТипРеспондентов
		|ИЗ
		|	ЗаканчивающиесяОпросы КАК ЗаканчивающиесяОпросы
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров КАК КонтактныеЛица
		|		ПО (ИСТИНА)
		|			И (ЗаканчивающиесяОпросы.СвободныйОпрос)
		|			И (ЗаканчивающиесяОпросы.ТипРеспондентов = ЗНАЧЕНИЕ(Справочник.КонтактныеЛицаПартнеров.ПустаяСсылка))
		|			И (НЕ КонтактныеЛица.ПометкаУдаления)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЗаканчивающиесяОпросы.Ссылка,
		|	НазначениеОпросовРеспонденты.Респондент,
		|	ЗаканчивающиесяОпросы.ТипРеспондентов
		|ИЗ
		|	ЗаканчивающиесяОпросы КАК ЗаканчивающиесяОпросы
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.НазначениеОпросов.Респонденты КАК НазначениеОпросовРеспонденты
		|		ПО ЗаканчивающиесяОпросы.Ссылка = НазначениеОпросовРеспонденты.Ссылка
		|			И (НЕ ЗаканчивающиесяОпросы.СвободныйОпрос)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ОпросыРеспонденты.Опрос КАК ИсточникОповещения,
		|	ВЫБОР
		|		КОГДА ОпросыРеспонденты.ТипРеспондентов = ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка)
		|			ТОГДА ОпросыРеспонденты.Респондент
		|		ИНАЧЕ ОпросыРеспонденты.Респондент.Владелец
		|	КОНЕЦ КАК Подписчик,
		|	КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, 2), ДЕНЬ) КАК ДатаАктуальностиОтправки
		|ПОМЕСТИТЬ НеЗаполнившиеРеспондентыОпросы
		|ИЗ
		|	ОпросыРеспонденты КАК ОпросыРеспонденты
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Анкета КАК Анкета
		|		ПО ОпросыРеспонденты.Опрос = Анкета.Опрос
		|			И ОпросыРеспонденты.Респондент = Анкета.Респондент
		|			И (Анкета.Проведен)
		|ГДЕ
		|	Анкета.Ссылка ЕСТЬ NULL 
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	НеЗаполнившиеРеспондентыОпросы.ИсточникОповещения,
		|	НеЗаполнившиеРеспондентыОпросы.Подписчик,
		|	НеЗаполнившиеРеспондентыОпросы.ДатаАктуальностиОтправки
		|ИЗ
		|	НеЗаполнившиеРеспондентыОпросы КАК НеЗаполнившиеРеспондентыОпросы
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПодпискиНаРассылкиИОповещенияКлиентам КАК ПодпискиНаРассылкиИОповещенияКлиентам
		|		ПО НеЗаполнившиеРеспондентыОпросы.Подписчик = ПодпискиНаРассылкиИОповещенияКлиентам.Владелец
		|			И (ПодпискиНаРассылкиИОповещенияКлиентам.ПодпискаДействует)
		|			И (ПодпискиНаРассылкиИОповещенияКлиентам.ОтправлятьКонтактномуЛицуОбъектаОповещения)
		|			И (ПодпискиНаРассылкиИОповещенияКлиентам.ОтправлятьПартнеру)
		|			И (НЕ ПодпискиНаРассылкиИОповещенияКлиентам.ПометкаУдаления)
		|			И (ПодпискиНаРассылкиИОповещенияКлиентам.ГруппаРассылокИОповещений = &ГруппаРассылокИОповещений)
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОчередьСобытийДляОповещенийКлиентам КАК ОчередьСобытийДляОповещенийКлиентам
		|		ПО НеЗаполнившиеРеспондентыОпросы.ИсточникОповещения = ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения
		|			И НеЗаполнившиеРеспондентыОпросы.Подписчик = ОчередьСобытийДляОповещенийКлиентам.Подписчик
		|			И (ОчередьСобытийДляОповещенийКлиентам.ВидОповещения = &ВидОповещения)
		|ГДЕ
		|	ОчередьСобытийДляОповещенийКлиентам.ВидОповещения ЕСТЬ NULL ";
		
	КонецЕсли;
	
	Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДатаСеанса());
	Запрос.УстановитьПараметр("ВидОповещения", ВидОповещения);
	Запрос.УстановитьПараметр("ГруппаРассылокИОповещений", Выборка.ГруппаРассылокИОповещений);
	
	ВыборкаОчередь = Запрос.Выполнить().Выбрать();
		
	Пока ВыборкаОчередь.Следующий() Цикл
		
		РегистрыСведений.ОчередьСобытийДляОповещенийКлиентам.ВыполнитьЗаписьВРегистр(
		                ВидОповещения,
		                ВыборкаОчередь.Подписчик,
		                ВыборкаОчередь.ИсточникОповещения,
		                Дата(1, 1, 1),
		                КонецДня(ВыборкаОчередь.ДатаАктуальностиОтправки));
		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область СчетаНаОплату

Процедура ОбработатьИзменениеСчетаНаОплату(Источник, ТипСобытия, РежимЗаписи)

	СозданиеСчетаИспользуется      = РассылкиИОповещенияКлиентамПовтИсп.ТипСобытияИспользуется(Перечисления.ТипыСобытийОповещений.ВыпискаСчета);
	ИзменениеСчетаИспользуется     = РассылкиИОповещенияКлиентамПовтИсп.ТипСобытияИспользуется(Перечисления.ТипыСобытийОповещений.ИзменениеСчета);
	АннулированиеСчетаИспользуется = РассылкиИОповещенияКлиентамПовтИсп.ТипСобытияИспользуется(Перечисления.ТипыСобытийОповещений.АннулированиеСчета);
	
	Если ТипСобытия = "ПередЗаписью" Тогда
		
		Если РежимЗаписи <> РежимЗаписиДокумента.Проведение Тогда
			Возврат;
		КонецЕсли;
		
		Если НЕ СозданиеСчетаИспользуется И НЕ ИзменениеСчетаИспользуется И НЕ АннулированиеСчетаИспользуется Тогда
			Возврат;
		КонецЕсли;
		
		Источник.ДополнительныеСвойства.Вставить("ДанныеДоЗаписи", ДанныеСчетаНаОплату(Источник.Ссылка));
		
	ИначеЕсли ТипСобытия = "ПриЗаписи" Тогда
		
		
		Если НЕ Источник.ДополнительныеСвойства.Свойство("ДанныеДоЗаписи") Тогда
			Возврат;
		КонецЕсли;
		
		ДанныеДоЗаписи = Источник.ДополнительныеСвойства.ДанныеДоЗаписи;
		
		Если ДанныеДоЗаписи.Количество() = 0 Тогда
			
			Если СозданиеСчетаИспользуется Тогда
				
				ЗаписьВОчередьПоТипуСобытия(Перечисления.ТипыСобытийОповещений.ВыпискаСчета,
				                            Источник.Ссылка,
				                            Источник.Партнер,
				                            Дата(1, 1, 1),
				                            ТекущаяДатаСеанса()+ 86400*3);
				
				Возврат;
				
			КонецЕсли;
			
		Иначе
			
			Если НЕ ДанныеДоЗаписи[0].Аннулирован И Источник.Аннулирован Тогда
				
				Если АннулированиеСчетаИспользуется Тогда
					
					ЗаписьВОчередьПоТипуСобытия(Перечисления.ТипыСобытийОповещений.АннулированиеСчета,
					                            Источник.Ссылка,
					                            Источник.Партнер,
					                            Дата(1, 1, 1),
					                            ТекущаяДатаСеанса()+ 86400*3);
					
					Возврат;
					
				КонецЕсли;
				
			КонецЕсли;
			
			Если ДанныеДоЗаписи[0].БанковскийСчет <> Источник.БанковскийСчет 
				ИЛИ ДанныеДоЗаписи[0].Валюта <> Источник.Валюта
				ИЛИ ДанныеДоЗаписи[0].Договор <> Источник.Договор
				ИЛИ ДанныеДоЗаписи[0].Касса <> Источник.Касса
				ИЛИ ДанныеДоЗаписи[0].Контрагент <> Источник.Контрагент
				ИЛИ ДанныеДоЗаписи[0].СуммаДокумента <> Источник.СуммаДокумента
				ИЛИ ДанныеДоЗаписи[0].ФормаОплаты <> Источник.ФормаОплаты Тогда
				
				Если ИзменениеСчетаИспользуется Тогда
					
					ЗаписьВОчередьПоТипуСобытия(Перечисления.ТипыСобытийОповещений.ИзменениеСчета,
					                            Источник.Ссылка,
					                            Источник.Партнер,
					                            Дата(1, 1, 1),
					                            ТекущаяДатаСеанса()+ 86400*3);
					
					Возврат;
					
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;

КонецПроцедуры

Функция ДанныеСчетаНаОплату(СчетНаОплату)

	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	СчетНаОплатуКлиенту.СуммаДокумента,
	|	СчетНаОплатуКлиенту.Валюта,
	|	СчетНаОплатуКлиенту.ФормаОплаты,
	|	СчетНаОплатуКлиенту.БанковскийСчет,
	|	СчетНаОплатуКлиенту.Касса,
	|	СчетНаОплатуКлиенту.Аннулирован,
	|	СчетНаОплатуКлиенту.Контрагент,
	|	СчетНаОплатуКлиенту.Договор
	|ИЗ
	|	Документ.СчетНаОплатуКлиенту КАК СчетНаОплатуКлиенту
	|ГДЕ
	|	СчетНаОплатуКлиенту.Ссылка = &СчетНаОплату
	|	И СчетНаОплатуКлиенту.Проведен";
	
	Запрос.УстановитьПараметр("СчетНаОплату", СчетНаОплату);
	
	Возврат Запрос.Выполнить().Выгрузить();

КонецФункции

#КонецОбласти

#Область СостояниеЗаказов

Процедура ОбработатьИзменениеСостоянияЗаказовКлиента(Источник, ТипСобытия)

	ТипСобытияОповещения = Перечисления.ТипыСобытийОповещений.ИзменениеСостоянияЗаказа;
	
	Если Источник.Отбор.Найти("Заказ") = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ЗаказКлиента = Источник.Отбор.Заказ.Значение;
	
	Если ТипСобытия = "ПередЗаписью" Тогда
		
		Если НЕ РассылкиИОповещенияКлиентамПовтИсп.ТипСобытияИспользуется(ТипСобытияОповещения) Тогда
			Возврат;
		КонецЕсли;
		
		Если НЕ ТипЗнч(ЗаказКлиента) = Тип("ДокументСсылка.ЗаказКлиента") Тогда
			Возврат;
		КонецЕсли;
		
		Источник.ДополнительныеСвойства.Вставить("ДанныеДоЗаписи", ДанныеРегистраСостоянияЗаказов(ЗаказКлиента));
		
		
	ИначеЕсли ТипСобытия = "ПриЗаписи" Тогда
		
		Если НЕ Источник.ДополнительныеСвойства.Свойство("ДанныеДоЗаписи") Тогда
			 Возврат;
		КонецЕсли;
		
		ДанныеПослеЗаписи = ДанныеРегистраСостоянияЗаказов(ЗаказКлиента);
		
		Если ДанныеПослеЗаписи.Количество() = 0 Тогда
			Возврат;
		КонецЕсли;
		
		Если Не ТаблицыОтличаются(ДанныеПослеЗаписи, Источник.ДополнительныеСвойства.ДанныеДоЗаписи) Тогда
			Возврат;
		КонецЕсли;
		
		ТекущиеДанные = ДанныеПослеЗаписи[0];
		
		Если НЕ ТекущиеДанные.Проведен Тогда
			Возврат;
		КонецЕсли;
		
		Если ТекущиеДанные.Состояние = Перечисления.СостоянияЗаказовКлиентов.ГотовКЗакрытию Тогда
			
			Возврат;
			
		КонецЕсли;
		
		МассивВидовОповещений = РассылкиИОповещенияКлиентамПовтИсп.ДействующиеВидыОповещенийПоТипуСобытия(ТипСобытияОповещения);
		Получатель = ТекущиеДанные.Партнер;
		
		Для Каждого ВидОповещения Из МассивВидовОповещений Цикл
		
			РегистрыСведений.ОчередьСобытийДляОповещенийКлиентам.ВыполнитьЗаписьВРегистр(ВидОповещения,
			                                                                             Получатель,
			                                                                             ЗаказКлиента,
			                                                                             Дата(1, 1, 1),
			                                                                             ТекущаяДатаСеанса() + 86400);
		
		КонецЦикла;
		
	КонецЕсли;

КонецПроцедуры

Функция ДанныеРегистраСостоянияЗаказов(ЗаказКлиента)

	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ЕСТЬNULL(СостоянияЗаказовКлиентов.Состояние, НЕОПРЕДЕЛЕНО) КАК Состояние,
	|	ЗаказКлиента.Проведен,
	|	ЗаказКлиента.Партнер
	|ИЗ
	|	Документ.ЗаказКлиента КАК ЗаказКлиента
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СостоянияЗаказовКлиентов КАК СостоянияЗаказовКлиентов
	|		ПО СостоянияЗаказовКлиентов.Заказ = ЗаказКлиента.Ссылка
	|ГДЕ
	|	ЗаказКлиента.Ссылка = &ЗаказКлиента";
	
	Запрос.УстановитьПараметр("ЗаказКлиента", ЗаказКлиента);
	
	Возврат Запрос.Выполнить().Выгрузить();

КонецФункции

#КонецОбласти

#Область НачислениеСписаниеБонусов

Процедура ОбработатьИзменениеБонусныхБаллов(Источник, ТипСобытия);

	НачислениеБонусовИспользуется = РассылкиИОповещенияКлиентамПовтИсп.ТипСобытияИспользуется(Перечисления.ТипыСобытийОповещений.НачислениеБонусов);
	СписаниеБонусовИспользуется = РассылкиИОповещенияКлиентамПовтИсп.ТипСобытияИспользуется(Перечисления.ТипыСобытийОповещений.СписаниеБонусов);
	
	Если Источник.Отбор.Найти("Регистратор") = Неопределено Тогда
		Возврат;
	КонецЕсли;
		
	Регистратор = Источник.Отбор.Регистратор.Значение;
	
	Если ТипСобытия = "ПередЗаписью" Тогда
		
		Если НЕ НачислениеБонусовИспользуется И НЕ СписаниеБонусовИспользуется Тогда
			Возврат;
		КонецЕсли;
		
		Если ТипЗнч(Регистратор) = Тип("ДокументСсылка.ОтчетОРозничныхПродажах") Тогда
			КассоваяСмена = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Регистратор, "КассоваяСмена");
			Если Не КассоваяСмена.Пустая() Тогда
				Возврат;
			КонецЕсли;
		КонецЕсли;
		
		Если ЧекАрхивный(Регистратор) Тогда
			Возврат;
		КонецЕсли;
		
		Источник.ДополнительныеСвойства.Вставить("ДанныеДоЗаписи", ДанныеРегистраНачислениеБонусов(Регистратор));
		
	ИначеЕсли ТипСобытия = "ПриЗаписи" Тогда
		
		Если НЕ Источник.ДополнительныеСвойства.Свойство("ДанныеДоЗаписи") Тогда
			 Возврат;
		КонецЕсли;
		
		Если ЧекАрхивный(Регистратор) Тогда
			Возврат;
		КонецЕсли;
		
		ДанныеПослеЗаписи = ДанныеРегистраНачислениеБонусов(Регистратор);
		
		Если ТаблицыОтличаются(ДанныеПослеЗаписи.Начисление, Источник.ДополнительныеСвойства.ДанныеДоЗаписи.Начисление) Тогда
			
			МассивПредполагаемыхПолучателей = ДанныеПослеЗаписи.Начисление.ВыгрузитьКолонку("Партнер");
			Для Каждого Получатель Из МассивПредполагаемыхПолучателей Цикл
				
				ЗаписьВОчередьПоТипуСобытия(Перечисления.ТипыСобытийОповещений.НачислениеБонусов,
				                            Регистратор,
				                            Получатель,
				                            Дата(1, 1, 1),
				                            ТекущаяДатаСеанса() + 86400);
			КонецЦикла;
			
		КонецЕсли;
		
		Если ТаблицыОтличаются(ДанныеПослеЗаписи.Списание, Источник.ДополнительныеСвойства.ДанныеДоЗаписи.Списание) Тогда
		
			МассивПредполагаемыхПолучателей = ДанныеПослеЗаписи.Списание.ВыгрузитьКолонку("Партнер");
			Для Каждого Получатель Из МассивПредполагаемыхПолучателей Цикл
				
				ЗаписьВОчередьПоТипуСобытия(Перечисления.ТипыСобытийОповещений.СписаниеБонусов,
				                            Регистратор,
				                            Получатель,
				                            Дата(1, 1, 1),
				                            ТекущаяДатаСеанса() + 86400);
			КонецЦикла;
		
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Функция ДанныеРегистраНачислениеБонусов(Регистратор)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	БонусныеБаллы.Партнер КАК Партнер,
	|	СУММА(БонусныеБаллы.Начислено) КАК Начислено
	|ИЗ
	|	РегистрНакопления.БонусныеБаллы КАК БонусныеБаллы
	|ГДЕ
	|	БонусныеБаллы.Регистратор = &Регистратор
	|	И БонусныеБаллы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|
	|СГРУППИРОВАТЬ ПО
	|	БонусныеБаллы.Партнер
	|
	|УПОРЯДОЧИТЬ ПО
	|	Партнер
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	БонусныеБаллы.Партнер КАК Партнер,
	|	СУММА(БонусныеБаллы.Начислено) КАК Начислено
	|ИЗ
	|	РегистрНакопления.БонусныеБаллы КАК БонусныеБаллы
	|ГДЕ
	|	БонусныеБаллы.Регистратор = &Регистратор
	|	И БонусныеБаллы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|
	|СГРУППИРОВАТЬ ПО
	|	БонусныеБаллы.Партнер
	|
	|УПОРЯДОЧИТЬ ПО
	|	Партнер";
	
	Запрос.УстановитьПараметр("Регистратор", Регистратор);
	Результат = Запрос.ВыполнитьПакет();
	
	СтруктураДанных = Новый Структура;
	СтруктураДанных.Вставить("Начисление", Результат[0].Выгрузить());
	СтруктураДанных.Вставить("Списание", Результат[1].Выгрузить());
	
	Возврат СтруктураДанных;
	
КонецФункции

Функция ЧекАрхивный(Регистратор)
	
	Если ТипЗнч(Регистратор) = Тип("ДокументСсылка.ЧекККМ") ИЛИ ТипЗнч(Регистратор) = Тип("ДокументСсылка.ЧекККМВозврат") Тогда
		Возврат ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Регистратор, "Архивный");
	Иначе
		Возврат Ложь;
	КонецЕсли
	
КонецФункции

#КонецОбласти

#Область ПоступлениеОплаты

Процедура ОбработатьИзменениеПоступленияОплаты(Источник, ТипСобытия, РежимЗаписи)

	ПоступлениеОплатыИспользуется = РассылкиИОповещенияКлиентамПовтИсп.ТипСобытияИспользуется(Перечисления.ТипыСобытийОповещений.ПоступлениеОплатыОтКлиента);
	
	Если ТипСобытия = "ПередЗаписью" Тогда
		
		Если РежимЗаписи <> РежимЗаписиДокумента.Проведение Тогда
			Возврат;
		КонецЕсли;
		
		Если НЕ ПоступлениеОплатыИспользуется Тогда
			Возврат;
		КонецЕсли;
		
		Источник.ДополнительныеСвойства.Вставить("ДанныеДоЗаписи", ДанныеПоступленияОплаты(Источник.Ссылка));
		
	ИначеЕсли ТипСобытия = "ПриЗаписи" Тогда
		
		Если НЕ Источник.ДополнительныеСвойства.Свойство("ДанныеДоЗаписи") Тогда
			Возврат;
		КонецЕсли;
		
		РасшифровкаПлатежаДоЗаписи = Источник.ДополнительныеСвойства.ДанныеДоЗаписи;
		РасшифровкаПлатежаДоЗаписи.Свернуть("Партнер,Валюта", "Сумма");
		
		РасшифровкаПлатежа = Источник.РасшифровкаПлатежа.Выгрузить(,"Партнер,Сумма");
		РасшифровкаПлатежа.Колонки.Добавить("Валюта");
		РасшифровкаПлатежа.Свернуть("Партнер", "Сумма");
		
		Для каждого ТекСтрока Из РасшифровкаПлатежа Цикл
			
			СтрокаДоЗаписи = РасшифровкаПлатежаДоЗаписи.Найти(ТекСтрока.Партнер, "Партнер");
			
			Если СтрокаДоЗаписи = Неопределено
				Или СтрокаДоЗаписи.Валюта <> Источник.Валюта
				Или СтрокаДоЗаписи.Сумма <> ТекСтрока.Сумма Тогда
				
				ЗаписьВОчередьПоТипуСобытия(Перечисления.ТипыСобытийОповещений.ПоступлениеОплатыОтКлиента,
				                            Источник.Ссылка,
				                            ТекСтрока.Партнер,
				                            Дата(1, 1, 1),
				                            ТекущаяДатаСеанса()+ 86400*3);
				
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;

КонецПроцедуры

Функция ДанныеПоступленияОплаты(ПлатежныйДокумент)

	Запрос = Новый Запрос;
	Запрос.Текст = "
		|ВЫБРАТЬ
		|	ПриходныйКассовыйОрдерРасшифровкаПлатежа.Партнер КАК Партнер,
		|	ПриходныйКассовыйОрдерРасшифровкаПлатежа.Сумма КАК Сумма,
		|	ПриходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Валюта КАК Валюта
		|ИЗ
		|	Документ.ПриходныйКассовыйОрдер.РасшифровкаПлатежа КАК ПриходныйКассовыйОрдерРасшифровкаПлатежа
		|ГДЕ
		|	ПриходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка = &ПлатежныйДокумент
		|	И ПриходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Проведен
		|	
		|ОБЪЕДИНИТЬ ВСЕ
		|	
		|ВЫБРАТЬ
		|	ПоступлениеБезналичныхДенежныхСредствРасшифровкаПлатежа.Партнер КАК Партнер,
		|	ПоступлениеБезналичныхДенежныхСредствРасшифровкаПлатежа.Сумма КАК Сумма,
		|	ПоступлениеБезналичныхДенежныхСредствРасшифровкаПлатежа.Ссылка.Валюта КАК Валюта
		|	
		|ИЗ
		|	Документ.ПоступлениеБезналичныхДенежныхСредств.РасшифровкаПлатежа КАК ПоступлениеБезналичныхДенежныхСредствРасшифровкаПлатежа
		|ГДЕ
		|	ПоступлениеБезналичныхДенежныхСредствРасшифровкаПлатежа.Ссылка = &ПлатежныйДокумент
		|	И ПоступлениеБезналичныхДенежныхСредствРасшифровкаПлатежа.Ссылка.Проведен
		|	
		|ОБЪЕДИНИТЬ ВСЕ
		|	
		|ВЫБРАТЬ
		|	ОперацияПоПлатежнойКартеРасшифровкаПлатежа.Партнер КАК Партнер,
		|	ОперацияПоПлатежнойКартеРасшифровкаПлатежа.Сумма КАК Сумма,
		|	ОперацияПоПлатежнойКартеРасшифровкаПлатежа.Ссылка.Валюта КАК Валюта
		|	
		|ИЗ
		|	Документ.ОперацияПоПлатежнойКарте.РасшифровкаПлатежа КАК ОперацияПоПлатежнойКартеРасшифровкаПлатежа
		|ГДЕ
		|	ОперацияПоПлатежнойКартеРасшифровкаПлатежа.Ссылка = &ПлатежныйДокумент
		|	И ОперацияПоПлатежнойКартеРасшифровкаПлатежа.Ссылка.Проведен
		|
		|";
	
	Запрос.УстановитьПараметр("ПлатежныйДокумент", ПлатежныйДокумент);
	
	Возврат Запрос.Выполнить().Выгрузить();

КонецФункции

#КонецОбласти

#Область СозданиеВзаимодействийПоОчередиОповещений

// Получает данные вида оповещения
// 
// Параметры:
//  ВидОповещения - СправочникСсылка.ВидыОповещенийКлиентам - 
// Возвращаемое значение:
//  Неопределено, ВыборкаИзРезультатаЗапроса - содержит:
//   * ВидОповещения - СправочникСсылка.ВидыОповещенийКлиентам -
//   * ГруппаРассылокИОповещений - СправочникСсылка.ГруппыРассылокИОповещений - 
//   * ПредназначенаДляЭлектронныхПисем - Булево -
//   * ПредназначенаДляSMS - Булево -
//   * ШаблонСообщенияSMS - СправочникСсылка.ШаблоныСообщений -
//   * ШаблонЭлектронногоПисьма - СправочникСсылка.ШаблоныСообщений -
//   * УсловиеОтправки - Строка -
//   * ТипСобытия - Строка -
//   * Принудительная - Булево -
//   * УчетнаяЗапись - СправочникСсылка.УчетныеЗаписиЭлектроннойПочты - 
//   * ВидКонтактнойИнформацииПартнераДляПисем - СправочникСсылка.ВидыКонтактнойИнформации - 
//   * ВидКонтактнойИнформацииПартнераДляSMS - СправочникСсылка.ВидыКонтактнойИнформации - 
//   * ВидКонтактнойИнформацииКонтактногоЛицаДляПисем - СправочникСсылка.ВидыКонтактнойИнформации - 
//   * ВидКонтактнойИнформацииКонтактногоЛицаДляSMS - СправочникСсылка.ВидыКонтактнойИнформации - 
//   * ОтправлятьПартнеру - Булево - 
//   * ОтправлятьКонтактномуЛицуОбъектаОповещения - Булево -
//   * ОтправлятьКонтактнымЛицамРоли - Булево -
//   * РольКонтактногоЛица - СправочникСсылка.РолиКонтактныхЛицПартнеров - 
//   * Ответственный - СправочникСсылка.Пользователи - 
//   * УчетнаяЗаписьИмяПользователя - Строка -
//   * УчетнаяЗаписьАдресЭлектроннойПочты - Строка -
//   * УдалятьПисьмаПослеОтправки - Булево -
//   * Наименование - Строка - 
//   * ПараметрыУсловия - ТаблицаЗначений - содержит:
//     ** ЭтоПараметрПредыдущегоСообщения - Булево -
//     ** ИмяПараметра - Строка -
//   * ИспользуетсяУсловиеОтправки - Булево -
//   
Функция ДанныеВидаОповещения(ВидОповещения)

	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ВидыОповещенийКлиентам.Ссылка КАК ВидОповещения,
	|	ВидыОповещенийКлиентам.ГруппаРассылокИОповещений,
	|	ВидыОповещенийКлиентам.ПредназначенаДляЭлектронныхПисем,
	|	ВидыОповещенийКлиентам.ПредназначенаДляSMS,
	|	ВидыОповещенийКлиентам.ШаблонСообщенияSMS,
	|	ВидыОповещенийКлиентам.ШаблонЭлектронногоПисьма,
	|	ВидыОповещенийКлиентам.УсловиеОтправки,
	|	ВидыОповещенийКлиентам.ТипСобытия,
	|	ГруппыРассылокИОповещений.Принудительная,
	|	ГруппыРассылокИОповещений.УчетнаяЗапись,
	|	ГруппыРассылокИОповещений.ВидКонтактнойИнформацииПартнераДляПисем,
	|	ГруппыРассылокИОповещений.ВидКонтактнойИнформацииПартнераДляSMS,
	|	ГруппыРассылокИОповещений.ВидКонтактнойИнформацииКонтактногоЛицаДляПисем,
	|	ГруппыРассылокИОповещений.ВидКонтактнойИнформацииКонтактногоЛицаДляSMS,
	|	ГруппыРассылокИОповещений.ОтправлятьПартнеру,
	|	ГруппыРассылокИОповещений.ОтправлятьКонтактномуЛицуОбъектаОповещения,
	|	ГруппыРассылокИОповещений.ОтправлятьКонтактнымЛицамРоли,
	|	ГруппыРассылокИОповещений.РольКонтактногоЛица,
	|	ГруппыРассылокИОповещений.Ответственный,
	|	ЕСТЬNULL(УчетныеЗаписиЭлектроннойПочты.ИмяПользователя, """") КАК УчетнаяЗаписьИмяПользователя,
	|	ЕСТЬNULL(УчетныеЗаписиЭлектроннойПочты.АдресЭлектроннойПочты, """") КАК УчетнаяЗаписьАдресЭлектроннойПочты,
	|	ЕСТЬNULL(НастройкиУчетныхЗаписейЭлектроннойПочты.УдалятьПисьмаПослеОтправки, ЛОЖЬ) КАК УдалятьПисьмаПослеОтправки,
	|	ВидыОповещенийКлиентам.Наименование,
	|	ВидыОповещенийКлиентам.ПараметрыУсловия.(
	|		ЭтоПараметрПредыдущегоСообщения,
	|		ИмяПараметра
	|	),
	|	ВидыОповещенийКлиентам.ИспользуетсяУсловиеОтправки
	|ИЗ
	|	Справочник.ВидыОповещенийКлиентам КАК ВидыОповещенийКлиентам
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ГруппыРассылокИОповещений КАК ГруппыРассылокИОповещений
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.УчетныеЗаписиЭлектроннойПочты КАК УчетныеЗаписиЭлектроннойПочты
	|				ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.НастройкиУчетныхЗаписейЭлектроннойПочты КАК НастройкиУчетныхЗаписейЭлектроннойПочты
	|				ПО УчетныеЗаписиЭлектроннойПочты.Ссылка = НастройкиУчетныхЗаписейЭлектроннойПочты.УчетнаяЗаписьЭлектроннойПочты
	|			ПО ГруппыРассылокИОповещений.УчетнаяЗапись = УчетныеЗаписиЭлектроннойПочты.Ссылка
	|		ПО ВидыОповещенийКлиентам.ГруппаРассылокИОповещений = ГруппыРассылокИОповещений.Ссылка
	|ГДЕ
	|	ВидыОповещенийКлиентам.Ссылка = &ВидОповещенийКлиентам
	|	И НЕ ВидыОповещенийКлиентам.ПометкаУдаления";
	
	Запрос.УстановитьПараметр("ВидОповещенийКлиентам", ВидОповещения);
	
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	Возврат Выборка;

КонецФункции 

Процедура ОбработатьОчередьСообщенийПоВидуОповещения(ВидОповещения, ДатаОбработки );
	
	ДанныеВидаОповещения    = ДанныеВидаОповещения(ВидОповещения);
	Если ДанныеВидаОповещения = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ДанныеТипаСобытия       = Перечисления.ТипыСобытийОповещений.ДанныеДляОбработкиОчередиОповещений(ДанныеВидаОповещения.ТипСобытия);
	ДанныеПолучателей       = ДанныеПолучателейПоВидуОповещения(ДанныеВидаОповещения, ДатаОбработки, ДанныеТипаСобытия);
	ДанныеШаблоновСообщений = ДанныеШаблоновВидаОповещений(ДанныеВидаОповещения, ДатаОбработки, ДанныеТипаСобытия);
	
	МассивСозданныхВзаимодействий = Новый Массив;
	
	СформироватьСообщенияПоВидуОповещения(ДанныеВидаОповещения, ДанныеТипаСобытия, ДанныеПолучателей,
	                                      ДанныеШаблоновСообщений, МассивСозданныхВзаимодействий);
	
КонецПроцедуры



// Описание
// 
// Параметры:
// 	ДанныеВидаОповещения - см. ДанныеВидаОповещения
// 	ДанныеТипаСобытия - см. Перечисления.ТипыСобытийОповещений.ДанныеДляОбработкиОчередиОповещений
// 	ДанныеПолучателей - Соответствие - Описание
// 	ДанныеШаблоновСообщений - см. ДанныеШаблоновВидаОповещений
// 	МассивСозданныхВзаимодействий - Массив - Описание
//
Процедура СформироватьСообщенияПоВидуОповещения(ДанныеВидаОповещения, ДанныеТипаСобытия, ДанныеПолучателей,
	                                            ДанныеШаблоновСообщений, МассивСозданныхВзаимодействий)

	Если ДанныеВидаОповещения.ПредназначенаДляЭлектронныхПисем Тогда
		
		Если ДанныеШаблоновСообщений.ДанныеШаблонаПисьма.ДанныеШаблона.ШаблонПоВнешнейОбработке Тогда
			
			Для Каждого ДанныеПолучателя Из ДанныеПолучателей Цикл
			
				ДанныеПоИсточнику = ДанныеПолучателей.Получить(ДанныеПолучателя.Ключ);
				Если ДанныеПоИсточнику = Неопределено Тогда
					Возврат;
				КонецЕсли;
				
				ДанныеШаблона = ДанныеШаблоновСообщений.ДанныеШаблонаПисьма.ДанныеШаблона; // см. ШаблоныСообщенийКлиентСервер.ОписаниеПараметровШаблона
				
				ДанныеПисьма = ШаблоныСообщений.СформироватьСообщение(ДанныеШаблона.Ссылка,
				                                                      ДанныеПолучателя.Ключ,
				                                                      Новый УникальныйИдентификатор);
				
				Для Каждого ДанныеПоПодписчику Из ДанныеПоИсточнику Цикл
					
					Если НЕ ДанныеПоПодписчику.Значение.Свойство("МассивПолучателей")
						Или ТипЗнч(ДанныеПоПодписчику.Значение.МассивПолучателей) <> Тип("Массив")
						Или ДанныеПоПодписчику.Значение.МассивПолучателей.Количество() = 0 Тогда
						
						Продолжить;
						
					Иначе
						
						ДанныеПолучателей =  ДанныеПоПодписчику.Значение;
						
					КонецЕсли;
					
					СоздатьПисьмоПоОповещениюШаблонОпределенВнешнейОбработкой(ДанныеПолучателей, ДанныеПисьма, ДанныеВидаОповещения,
					                                                          ДанныеШаблоновСообщений.ДанныеШаблонаПисьма, МассивСозданныхВзаимодействий)
					
				КонецЦикла;
					
			КонецЦикла;
		Иначе
		
			Для Каждого СтрокаДанныхШаблона Из ДанныеШаблоновСообщений.ДанныеШаблонаПисьма.ТаблицаВыводимыхПолей Цикл
				
				ДанныеПоИсточнику = ДанныеПолучателей.Получить(СтрокаДанныхШаблона.ИсточникОповещения);
				Если ДанныеПоИсточнику = Неопределено Тогда
					Возврат;
				КонецЕсли;
				ДанныеАдресатов = ДанныеПоИсточнику.Получить(СтрокаДанныхШаблона.Подписчик);
				Если ДанныеПолучателей = Неопределено Тогда
					Продолжить;
				КонецЕсли;
				
				СоздатьПисьмоПоОповещению(ДанныеАдресатов, СтрокаДанныхШаблона,
				                          ДанныеВидаОповещения, ДанныеШаблоновСообщений.ДанныеШаблонаПисьма,
				                          ДанныеТипаСобытия, 
				                          МассивСозданныхВзаимодействий);
				
			КонецЦикла;
			
		КонецЕсли;
			
			Взаимодействия.УстановитьПапкиДляМассиваПисем(МассивСозданныхВзаимодействий);
		
	КонецЕсли;
	
	Если ДанныеВидаОповещения.ПредназначенаДляSMS Тогда
		
		Если ДанныеШаблоновСообщений.ДанныеШаблонаSMS.ДанныеШаблона.ШаблонПоВнешнейОбработке Тогда
			
			Для Каждого ДанныеПолучателя Из ДанныеПолучателей Цикл
			
				ДанныеПоИсточнику = ДанныеПолучателей.Получить(ДанныеПолучателя.Ключ);
				Если ДанныеПоИсточнику = Неопределено Тогда
					Возврат;
				КонецЕсли;
				
				ДанныеШаблона = ДанныеШаблоновСообщений.ДанныеШаблонаSMS.ДанныеШаблона; // см. ШаблоныСообщенийКлиентСервер.ОписаниеПараметровШаблона
				
				ДанныеСообщения = ШаблоныСообщений.СформироватьСообщение(ДанныеШаблона.Ссылка,
				                                                         ДанныеПолучателя.Ключ,
				                                                         Новый УникальныйИдентификатор);
				
				
				Для Каждого ДанныеПоПодписчику Из ДанныеПоИсточнику Цикл
					
					Если НЕ ДанныеПоПодписчику.Значение.Свойство("МассивПолучателей")
						Или ТипЗнч(ДанныеПоПодписчику.Значение.МассивПолучателей) <> Тип("Массив")
						Или ДанныеПоПодписчику.Значение.МассивПолучателей.Количество() = 0 Тогда
						
						Продолжить;
						
					Иначе
						
						ДанныеПолучателей =  ДанныеПоПодписчику.Значение;
						
					КонецЕсли;
					
					СоздатьSMSПоОповещениюШаблонОпределенВнешнейОбработкой(ДанныеПолучателей, ДанныеСообщения, ДанныеВидаОповещения,
					                                                       ДанныеШаблоновСообщений.ДанныеШаблонаSMS, МассивСозданныхВзаимодействий)
					
				КонецЦикла;
					
			КонецЦикла;
		Иначе
		
			Для Каждого СтрокаДанныхШаблона Из ДанныеШаблоновСообщений.ДанныеШаблонаSMS.ТаблицаВыводимыхПолей Цикл
				
				ДанныеПоИсточнику = ДанныеПолучателей.Получить(СтрокаДанныхШаблона.ИсточникОповещения);
				Если ДанныеПоИсточнику = Неопределено Тогда
					Возврат;
				КонецЕсли;
				ДанныеАдресатов = ДанныеПоИсточнику.Получить(СтрокаДанныхШаблона.Подписчик);
				Если ДанныеПолучателей = Неопределено Тогда
					Продолжить;
				КонецЕсли;
				
				СоздатьSMSПоОповещению(ДанныеАдресатов, СтрокаДанныхШаблона,
				                       ДанныеВидаОповещения, ДанныеШаблоновСообщений.ДанныеШаблонаSMS,
				                       ДанныеТипаСобытия, МассивСозданныхВзаимодействий);
				
			КонецЦикла;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Взаимодействия.РассчитатьРассмотреноПоПредметам(МассивСозданныхВзаимодействий);
	Взаимодействия.РассчитатьРассмотреноПоКонтактам(МассивСозданныхВзаимодействий);

КонецПроцедуры

#Область СозданиеСообщенияSMSПоОповещению

Процедура СоздатьSMSПоОповещениюШаблонОпределенВнешнейОбработкой(ДанныеПолучателей, ДанныеСообщения, ДанныеВидаОповещения, 
	                                                             ДанныеШаблона, МассивСозданныхВзаимодействий)
	
	ДокументСообщениеSMS    = Документы.СообщениеSMS.СоздатьДокумент();
	ЗаполнитьПолучателейСообщенияSMS(ДокументСообщениеSMS, ДанныеПолучателей);
	
	Если ДокументСообщениеSMS.Адресаты.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	ЗаполнитьДанныеШапкиДокументаСообщениеSMS(ДокументСообщениеSMS, ДанныеВидаОповещения, ДанныеПолучателей, ДанныеШаблона);
	ДокументСообщениеSMS.ТекстСообщения = ДанныеСообщения.Текст;
	
	ЗаписатьДокументСообщениеSMS(ДокументСообщениеSMS, Неопределено);
	МассивСозданныхВзаимодействий.Добавить(ДокументСообщениеSMS.Ссылка);
	
КонецПроцедуры

Процедура СоздатьSMSПоОповещению(ДанныеПолучателей,
                                СтрокаДанныхШаблона,
                                ДанныеВидаОповещения,
                                ДанныеШаблона,
                                ДанныеТипаСобытия,
                                МассивСозданныхВзаимодействий)
	
	Если НЕ СообщениеУдовлетворяетУсловиюОтправки(ДанныеВидаОповещения, СтрокаДанныхШаблона, ДанныеПолучателей) Тогда
		Возврат;
	КонецЕсли;
	
	ДокументСообщениеSMS    = Документы.СообщениеSMS.СоздатьДокумент();
	ЗаполнитьПолучателейСообщенияSMS(ДокументСообщениеSMS, ДанныеПолучателей);
	
	Если ДокументСообщениеSMS.Адресаты.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	ЗаполнитьДанныеШапкиДокументаСообщениеSMS(ДокументСообщениеSMS, ДанныеВидаОповещения, ДанныеПолучателей, ДанныеШаблона);
	
	СоответствиеПараметров  = ЗначенияРеквизитовПоПараметрам(СтрокаДанныхШаблона, ДанныеШаблона.ДанныеШаблона, ДанныеТипаСобытия);
	ДокументСообщениеSMS.ТекстСообщения = ШаблоныСообщений.ВставитьПараметрыВСтрокуСогласноТаблицеПараметров(
	                                                        ДанныеШаблона.ДанныеШаблона.Текст,
	                                                        СоответствиеПараметров);
	
	ЗаписатьДокументСообщениеSMS(ДокументСообщениеSMS,Неопределено);
	ВыполнитьЗаписьДанныхОповещения(СтрокаДанныхШаблона, ДанныеВидаОповещения);
	МассивСозданныхВзаимодействий.Добавить(ДокументСообщениеSMS.Ссылка);
	
КонецПроцедуры

Процедура ЗаполнитьПолучателейСообщенияSMS(ДокументСообщениеSMS, ДанныеПолучателей)

	МассивТелефонов = Новый Массив;
	ПредставлениеПолучателя = "";
	
	Для Каждого ДанныеПолучателя Из ДанныеПолучателей.МассивПолучателей Цикл
		Для Каждого ДанныеТелефона Из ДанныеПолучателя.КонтактнаяИнформация.МассивНомеровТелефонов Цикл
			
			НомерТелефона = "";
			ПодготовитьНомерТелефона(ДанныеТелефона.ЗначениеПолей,
			                         ДанныеТелефона.Представление,
			                         НомерТелефона);
			
			Если ПустаяСтрока(НомерТелефона) Тогда
				Продолжить;
			КонецЕсли;
			
			Если МассивТелефонов.Найти(НомерТелефона) = Неопределено Тогда
				МассивТелефонов.Добавить(НомерТелефона);
			Иначе
				Продолжить;
			КонецЕсли;
			
			ДанныеАдресата = Новый Структура;
			ДанныеАдресата.Вставить("Получатель", ДанныеПолучателя.Получатель);
			ДанныеАдресата.Вставить("ПредставлениеПолучателя", ДанныеПолучателя.ПредставлениеПолучателя);
			ДанныеАдресата.Вставить("ПредставлениеКонтактнойИнформации", ДанныеТелефона.Представление);
			ДанныеАдресата.Вставить("КонтактнаяИнформация", НомерТелефона);
			
			ДобавитьАдресатаSMS(ДокументСообщениеSMS, ДанныеАдресата);
			
		КонецЦикла;
	КонецЦикла;

КонецПроцедуры


// Описание
// 
// Параметры:
// 	ДокументСообщениеSMS - ДокументОбъект.СообщениеSMS - заполняемый документ.
// 	ДанныеВидаОповещения - ВыборкаИзРезультатаЗапроса, Неопределено - данные вида оповещения.
// 	ДанныеПолучателей - Структура - Описание:
// 	 * ДатаОтправки              -Дата - дата отправки сообщения.
// 	 * ДатаАктуальностиОтправки - Дата  - дата, после которой сообщение отправлять не нужно.
// 	ДанныеШаблона - Структура - данные шаблона сообщений.
//
Процедура ЗаполнитьДанныеШапкиДокументаСообщениеSMS(ДокументСообщениеSMS, ДанныеВидаОповещения, ДанныеПолучателей, ДанныеШаблона)
	
	ДанныеДокумента = Новый Структура;
	ДанныеДокумента.Вставить("Ответственный", ДанныеВидаОповещения.Ответственный);
	ДанныеДокумента.Вставить("Ссылка", ДанныеВидаОповещения.ВидОповещения);
	ДанныеДокумента.Вставить("Тема", ДанныеВидаОповещения.Наименование);
	ДанныеДокумента.Вставить("Комментарий", КомментарийДляСообщенияПоОповещению(ДанныеВидаОповещения));
	ДанныеДокумента.Вставить("ОтправлятьВТранслите", ДанныеШаблона.ДанныеШаблона.ПеревестиВТранслит);
	ДанныеДокумента.Вставить("Основание", Неопределено);
	ДанныеДокумента.Вставить("ДатаРассылки", ДанныеПолучателей.ДатаОтправки);
	ДанныеДокумента.Вставить("ДатаАктуальности", ДанныеПолучателей.ДатаАктуальностиОтправки);
	
	ЗаполнитьРеквизитыДокументаСообщениеSMS(ДанныеДокумента, ДокументСообщениеSMS);
	
КонецПроцедуры

#КонецОбласти

#Область СозданиеСообщенияSMSПоОповещению

Процедура СоздатьПисьмоПоОповещениюШаблонОпределенВнешнейОбработкой(ДанныеПолучателей,
	                                                                ДанныеПисьма, 
	                                                                ДанныеВидаОповещения, 
	                                                                ДанныеШаблонаПисьма,
	                                                                МассивСозданныхВзаимодействий)
	
	Письмо = Документы.ЭлектронноеПисьмоИсходящее.СоздатьДокумент();
	
	ЗаполнитьПолучателейПисьма(Письмо, ДанныеПолучателей);
	
	Если Письмо.ПолучателиКопий.Количество() = 0 И Письмо.ПолучателиПисьма.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	ДанныеШаблона = ДанныеШаблонаПисьма.ДанныеШаблона;
	ТаблицаПрисоединенныхФайлов = ДанныеПисьма.Вложения;
	
	ЗаполнитьДанныеШапкиДокументаПисьмо(Письмо, ДанныеВидаОповещения, ДанныеПолучателей, ДанныеШаблона, ТаблицаПрисоединенныхФайлов);
	
	Письмо.Тема = ДанныеПисьма.Тема;
	Если ДанныеШаблона.ФорматПисьма = Перечисления.СпособыРедактированияЭлектронныхПисем.ОбычныйТекст Тогда
		Письмо.Текст = ДанныеПисьма.Текст;
	Иначе
		Письмо.ТекстHTML = ДанныеПисьма.Текст;
		Письмо.Текст     = Взаимодействия.ПолучитьОбычныйТекстИзHTML(Письмо.ТекстHTML);
	КонецЕсли;
	
	СформироватьСпискиПолучателей(Письмо);
	
	Письмо.Записать();
	
	Для Каждого Вложение Из ТаблицаПрисоединенныхФайлов Цикл
		
		ПараметрыВложения = Новый Структура;
		ПараметрыВложения.Вставить("ИмяФайла", Вложение.Наименование);
		ПараметрыВложения.Вставить("Размер", Вложение.Размер);
		
		ПрисоединенныйФайл = УправлениеЭлектроннойПочтой.ЗаписатьВложениеЭлектронногоПисьмаИзВременногоХранилища(
		                                Письмо.Ссылка, Вложение.АдресВременногоХранилища, ПараметрыВложения);
		
		Если ПрисоединенныйФайл <> Неопределено Тогда
			ПрисоединенныйФайлОбъект = ПрисоединенныйФайл.ПолучитьОбъект();
			ПрисоединенныйФайлОбъект.ИДФайлаЭлектронногоПисьма = Вложение.ИДФайлаЭлектронногоПисьма;
			ПрисоединенныйФайлОбъект.Записать();
		КонецЕсли;
			
	КонецЦикла;
	
	МассивСозданныхВзаимодействий.Добавить(Письмо.Ссылка);
	УстановитьФлагРассмотреноПослеСозданияПисьма(Письмо);
	
КонецПроцедуры

Процедура СоздатьПисьмоПоОповещению(ДанныеПолучателей,
	                                СтрокаДанныхШаблона,
	                                ДанныеВидаОповещения,
	                                ДанныеШаблонаПисьма,
	                                ДанныеТипаСобытия,
	                                МассивСозданныхВзаимодействий)
	
	Если НЕ СообщениеУдовлетворяетУсловиюОтправки(ДанныеВидаОповещения, СтрокаДанныхШаблона, ДанныеПолучателей) Тогда
		Возврат;
	КонецЕсли;
	
	Письмо = Документы.ЭлектронноеПисьмоИсходящее.СоздатьДокумент();
	
	ЗаполнитьПолучателейПисьма(Письмо, ДанныеПолучателей);
	ДанныеШаблона               = ДанныеШаблонаПисьма.ДанныеШаблона;
	ТаблицаПрисоединенныхФайлов = ДанныеШаблонаПисьма.ТаблицаПрисоединенныхФайлов;
	ТаблицаПечатныхФорм         = ДанныеШаблонаПисьма.ТаблицаПечатныхФорм;
	
	Если Письмо.ПолучателиКопий.Количество() = 0 И Письмо.ПолучателиПисьма.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	ЗаполнитьДанныеШапкиДокументаПисьмо(Письмо, ДанныеВидаОповещения, ДанныеПолучателей, ДанныеШаблона, ТаблицаПрисоединенныхФайлов);
	
	СоответствиеПараметров     = ЗначенияРеквизитовПоПараметрам(СтрокаДанныхШаблона, ДанныеШаблона, ДанныеТипаСобытия);
	Письмо.Тема                = ШаблоныСообщений.ВставитьПараметрыВСтрокуСогласноТаблицеПараметров(
	                                                          ДанныеШаблона.Тема,
	                                                          СоответствиеПараметров);
	Если ДанныеШаблона.ФорматПисьма = Перечисления.СпособыРедактированияЭлектронныхПисем.ОбычныйТекст Тогда
		Письмо.Текст = ШаблоныСообщений.ВставитьПараметрыВСтрокуСогласноТаблицеПараметров(
		                                                          ДанныеШаблона.Текст,
		                                                          СоответствиеПараметров);
	Иначе
		Письмо.ТекстHTML = ШаблоныСообщений.ВставитьПараметрыВСтрокуСогласноТаблицеПараметров(
		                                                                ДанныеШаблона.Текст,
		                                                                СоответствиеПараметров);
		Письмо.Текст     = Взаимодействия.ПолучитьОбычныйТекстИзHTML(Письмо.ТекстHTML);
	КонецЕсли;
	
	СформироватьСпискиПолучателей(Письмо);
	Письмо.Записать();
	
	Для Каждого Вложение Из ТаблицаПрисоединенныхФайлов Цикл
		
		ПараметрыВложения = Новый Структура;
		ПараметрыВложения.Вставить("ИмяФайла", Вложение.Наименование);
		ПараметрыВложения.Вставить("Размер",   Вложение.Размер);
		
		ПрисоединенныйФайл = УправлениеЭлектроннойПочтой.ЗаписатьВложениеЭлектронногоПисьмаИзВременногоХранилища(
		                                Письмо.Ссылка, Вложение.АдресВременногоХранилища, ПараметрыВложения);
		
		Если ПрисоединенныйФайл <> Неопределено Тогда
			ПрисоединенныйФайлОбъект = ПрисоединенныйФайл.ПолучитьОбъект();
			ПрисоединенныйФайлОбъект.ИДФайлаЭлектронногоПисьма = Вложение.ИДФайлаЭлектронногоПисьма;
			ПрисоединенныйФайлОбъект.Записать();
		КонецЕсли;
			
	КонецЦикла;
	
	ДобавитьВложенияПечатныеФормыПисьмоПоОповещению(Письмо, ДанныеШаблона, СтрокаДанныхШаблона, ТаблицаПечатныхФорм);
		
	МассивСозданныхВзаимодействий.Добавить(Письмо.Ссылка);
	ВыполнитьЗаписьДанныхОповещения(СтрокаДанныхШаблона, ДанныеВидаОповещения);
	УстановитьФлагРассмотреноПослеСозданияПисьма(Письмо);
	
КонецПроцедуры

// Добавляет вложения печатниые формы в письмо, создаваемое по оповещению
// 
// Параметры:
// 	Письмо - ДокументОбъект.ЭлектронноеПисьмоИсходящее - заполняемый документ.
// 	ПараметрыШаблона - Структура - данные вида оповещения.
// 	СтрокаДанныхШаблона - СтрокаТаблицыЗначений - содержит колонки:
// 	 * ИсточникОповещения             -ДокументОбъект - документ, по которому требуется отправить оповещение .
// 	ВыбранныеПечатныеФормы - ТаблицаЗначений - содержит колонки:
// 	 * Имя - Строка - имя печатной формы 
// 	ДанныеШаблона - Структура - данные шаблона сообщений.
//
Процедура ДобавитьВложенияПечатныеФормыПисьмоПоОповещению(Письмо, ПараметрыШаблона, СтрокаДанныхШаблона, ВыбранныеПечатныеФормы)
	
	ИсточникОповещения = СтрокаДанныхШаблона.ИсточникОповещения;
	Если Не ЗначениеЗаполнено(ИсточникОповещения) Тогда
		Возврат;
	КонецЕсли;
	
	МетаданныеОбъект     = ИсточникОповещения.Метаданные(); 
	ИмяОбъектаМетаданных = МетаданныеОбъект.Имя;
	
	ИсточникиКомандПечати   = УправлениеПечатью.ИсточникиКомандПечати();
	Если ИсточникиКомандПечати.Найти(МетаданныеОбъект) = Неопределено Тогда
		
		Возврат;
		
	КонецЕсли;
	
	ВыбранныеКомандыПечати = Новый Соответствие;
	Для Каждого СтрокаВыбранныеПечатныеФормы Из ВыбранныеПечатныеФормы Цикл
		
		Если СтрокаВыбранныеПечатныеФормы.Имя = ИмяОбъектаМетаданных Тогда
			ВыбранныеКомандыПечати.Вставить(СтрокаВыбранныеПечатныеФормы.Идентификатор, Истина);
		КонецЕсли;
		
	КонецЦикла;
	
	КомандыПечатиОбъекта = УправлениеПечатью.КомандыПечатиОбъектаДоступныеДляВложений(МетаданныеОбъект); 
	
	ВложенияПечатныеФормы = Новый Массив;
	
	Для Каждого Вложение Из КомандыПечатиОбъекта Цикл
		Если НЕ Вложение.Отключена
			И СтрНайти(Вложение.Идентификатор, ",") = 0
			И НЕ ПустаяСтрока(Вложение.МенеджерПечати)
			И НЕ Вложение.СразуНаПринтер
			И НЕ Вложение.СкрытаФункциональнымиОпциями Тогда
			
			КомандаВыбрана = ВыбранныеКомандыПечати.Получить(Вложение.УникальныйИдентификатор);
			Если КомандаВыбрана = Неопределено 
				Или КомандаВыбрана = Ложь Тогда
				
				Продолжить;
				
			КонецЕсли;
			
			ВыбранныеКомандыПечати.Вставить(Вложение.УникальныйИдентификатор, Ложь);
			
			ДанныеВложения = Новый Структура;
			ДанныеВложения.Вставить("ИмяПечатнойФормы",            Вложение.Идентификатор);
			ДанныеВложения.Вставить("ИдентификаторКомандыПечати",  Вложение.УникальныйИдентификатор);
			ДанныеВложения.Вставить("Представление",               Вложение.Представление);
			ДанныеВложения.Вставить("МенеджерПечати",              Вложение.МенеджерПечати);
			ДанныеВложения.Вставить("ТипФайла",                    "MXL");
			ДанныеВложения.Вставить("Статус",                      "ПечатнаяФорма");
			ДанныеВложения.Вставить("ИмяПараметра",                 "");
			ДанныеВложения.Вставить("ПараметрыПечати",             Вложение.ДополнительныеПараметры);
			
			ВложенияПечатныеФормы.Добавить(ДанныеВложения);
			
		КонецЕсли;
	КонецЦикла;
		
	Если ВложенияПечатныеФормы.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	ФорматыСохранения = Новый Массив;
	Если ТипЗнч(ПараметрыШаблона.ФорматыВложений) = Тип("СписокЗначений") Тогда
		Для каждого ФорматВложения Из ПараметрыШаблона.ФорматыВложений Цикл
			ФорматыСохранения.Добавить(?(ТипЗнч(ФорматВложения.Значение) = Тип("ТипФайлаТабличногоДокумента"),
				ФорматВложения.Значение,
				ТипФайлаТабличногоДокумента[ФорматВложения.Значение]));
		КонецЦикла;
	Иначе
		ФорматыСохранения.Добавить(СтандартныеПодсистемыСервер.ТипФайлаТабличногоДокументаPDF());
	КонецЕсли;
	
	Для каждого ВложениеПечатнаяФорма Из ВложенияПечатныеФормы Цикл 
		
		Если ВложениеПечатнаяФорма.Статус = "ПечатнаяФорма" Тогда
			ИмяМенеджераПечати = ВложениеПечатнаяФорма.МенеджерПечати;
			ПараметрыПечати    = ВложениеПечатнаяФорма.ПараметрыПечати;
			МассивОбъектов     = Новый Массив;
			
			МассивОбъектов.Добавить(ИсточникОповещения);
			
			ИменаМакетов = ?(ПустаяСтрока(ВложениеПечатнаяФорма.ИмяПечатнойФормы), ВложениеПечатнаяФорма.ИдентификаторКомандыПечати, ВложениеПечатнаяФорма.ИмяПечатнойФормы);
			
			Попытка
				КомандаПечати = Новый Структура;
				КомандаПечати.Вставить("Идентификатор",           ИменаМакетов);
				КомандаПечати.Вставить("МенеджерПечати",          ИмяМенеджераПечати);
				КомандаПечати.Вставить("ДополнительныеПараметры", ПараметрыПечати);
				
				НастройкиСохранения = УправлениеПечатью.НастройкиСохранения();
				НастройкиСохранения.ФорматыСохранения = ФорматыСохранения;
				НастройкиСохранения.УпаковатьВАрхив = ПараметрыШаблона.УпаковатьВАрхив;
				НастройкиСохранения.ПереводитьИменаФайловВТранслит = ПараметрыШаблона.ТранслитерироватьИменаФайлов;
				НастройкиСохранения.ПодписьИПечать = ПараметрыШаблона.ПодписьИПечать;
				
				КоллекцияПечатныхФорм = УправлениеПечатью.НапечататьВФайл(КомандаПечати, МассивОбъектов, НастройкиСохранения);
				
			Исключение
				// Ошибка при создании внешний печатной формы. Создаем дальше письмо, без этой печатной формы.
				ИнформацияОбОшибке = ИнформацияОбОшибке();
				ТекстОшибки = НСтр("ru = 'Ошибка при создании внешней печатной формы. По причине:'") + Символы.ПС
						+ ПодробноеПредставлениеОшибки(ИнформацияОбОшибке);
				
				ВыполнитьЗаписьЖурналаРегистрации(ТекстОшибки, УровеньЖурналаРегистрации.Ошибка);

				Продолжить;
				
			КонецПопытки;
			
			Для Каждого ПечатнаяФорма Из КоллекцияПечатныхФорм Цикл
				
				ПараметрыВложения = Новый Структура;
				ПараметрыВложения.Вставить("ИмяФайла", ПечатнаяФорма.ИмяФайла);
				ПараметрыВложения.Вставить("Размер",   ПечатнаяФорма.ДвоичныеДанные.Размер());
				
				АдресВоВременномХранилище = ПоместитьВоВременноеХранилище(ПечатнаяФорма.ДвоичныеДанные);
				УправлениеЭлектроннойПочтой.ЗаписатьВложениеЭлектронногоПисьмаИзВременногоХранилища(
				                                Письмо.Ссылка, АдресВоВременномХранилище, ПараметрыВложения);
				
			КонецЦикла;
				
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Описание
// 
// Параметры:
// 	Письмо - ДокументОбъект.ЭлектронноеПисьмоИсходящее - Описание
// 	ДанныеВидаОповещения - ВыборкаИзРезультатаЗапроса, Неопределено - Описание:
// 	ДанныеПолучателей - Структура - Описание:
// 	* ДатаОтправки             - Дата  - дата, в которую надо отправить сообщение.
// 	* ДатаАктуальностиОтправки - Дата - дата, после которой не требуется отправлять сообщение.
// 	ДанныеШаблона - Структура - Описание:
//
Процедура ЗаполнитьДанныеШапкиДокументаПисьмо(Письмо, ДанныеВидаОповещения, ДанныеПолучателей, ДанныеШаблона, ТаблицаПрисоединенныхФайлов)
	
	Письмо.Автор                    = Пользователи.ТекущийПользователь();
	Письмо.Ответственный            = ДанныеВидаОповещения.Ответственный;
	Письмо.Дата                     = ТекущаяДатаСеанса();
	Письмо.Важность                 = Перечисления.ВариантыВажностиВзаимодействия.Обычная;
	Письмо.Кодировка                = "UTF-8";
	Письмо.УчетнаяЗапись            = ДанныеВидаОповещения.УчетнаяЗапись;
	
	Письмо.ОтправительПредставление = ВзаимодействияКлиентСервер.ПолучитьПредставлениеАдресата(
	                                            ДанныеВидаОповещения.УчетнаяЗаписьИмяПользователя,
	                                            ДанныеВидаОповещения.УчетнаяЗаписьАдресЭлектроннойПочты,
	                                            "");
	Письмо.СтатусПисьма             = Перечисления.СтатусыИсходящегоЭлектронногоПисьма.Исходящее;
	Письмо.ТипТекста                = ?(ДанныеШаблона.ФорматПисьма = Перечисления.СпособыРедактированияЭлектронныхПисем.HTML, 
	                                            Перечисления.ТипыТекстовЭлектронныхПисем.HTML, 
	                                            Перечисления.ТипыТекстовЭлектронныхПисем.ПростойТекст);
	
	Письмо.УведомитьОДоставке            = Ложь;
	Письмо.УведомитьОПрочтении           = Ложь;
	Письмо.ОтображатьТелоИсходногоПисьма = Ложь;
	Письмо.ВключатьТелоИсходногоПисьма   = Ложь;
	Письмо.УдалятьПослеОтправки          = ДанныеВидаОповещения.УдалятьПисьмаПослеОтправки;
	Письмо.Комментарий                   = КомментарийДляСообщенияПоОповещению(ДанныеВидаОповещения);
	Письмо.ВзаимодействиеОснование       = ДанныеВидаОповещения.ВидОповещения;
	Письмо.ДатаКогдаОтправить            = ДанныеПолучателей.ДатаОтправки;
	Письмо.ДатаАктуальностиОтправки      = ДанныеПолучателей.ДатаАктуальностиОтправки;
	Письмо.ЕстьВложения                  = ТаблицаПрисоединенныхФайлов.Количество() > 0;
	
КонецПроцедуры

Процедура ЗаполнитьПолучателейПисьма(Письмо, ДанныеПолучателей)

	МассивАдресов = Новый Массив;
	ПредставлениеПолучателя = "";
	
	Для Каждого ДанныеПолучателя Из ДанныеПолучателей.МассивПолучателей Цикл
		Для Каждого АдресЭП Из ДанныеПолучателя.КонтактнаяИнформация.МассивАдресовЭП Цикл
			
			Если МассивАдресов.Найти(АдресЭП.Представление) = Неопределено Тогда
				МассивАдресов.Добавить(АдресЭП.Представление);
			Иначе
				Продолжить;
			КонецЕсли;
			
			Получатель = Новый Структура("КонтактнаяИнформация, ПредставлениеПолучателя, Получатель",
			                             АдресЭП.Представление,
			                             ДанныеПолучателя.ПредставлениеПолучателя, 
			                             ДанныеПолучателя.Получатель);
			
			Если ОбщегоНазначенияКлиентСервер.АдресЭлектроннойПочтыСоответствуетТребованиям(Получатель.КонтактнаяИнформация) Тогда
				 ДобавитьПолучателяПисьма(Письмо.ПолучателиПисьма, Получатель);
			КонецЕсли;
			
		КонецЦикла;
	КонецЦикла;

КонецПроцедуры

Процедура УстановитьФлагРассмотреноПослеСозданияПисьма(Письмо)
	
	Реквизиты = РегистрыСведений.ПредметыПапкиВзаимодействий.РеквизитыВзаимодействия();
	Реквизиты.Предмет = Письмо.Ссылка;
	Реквизиты.Рассмотрено = Истина;
	РегистрыСведений.ПредметыПапкиВзаимодействий.ЗаписатьПредметыПапкиВзаимодействий(Письмо.Ссылка, Реквизиты);
	
КонецПроцедуры

#КонецОбласти

Процедура ВыполнитьЗаписьДанныхОповещения(СтрокаДанныхШаблона, ДанныеВидаОповещения)
	
	Если ДанныеВидаОповещения.ИспользуетсяУсловиеОтправки Тогда
		СтруктураДанныеСообщения = Новый Структура;
		Для каждого Параметр Из ДанныеВидаОповещения.ПараметрыУсловия.Выгрузить() Цикл
			Если НЕ Параметр.ЭтоПараметрПредыдущегоСообщения И Не СтруктураДанныеСообщения.Свойство(Параметр.ИмяПараметра) Тогда
				СтруктураДанныеСообщения.Вставить(Параметр.ИмяПараметра, СтрокаДанныхШаблона[Параметр.ИмяПараметра]);
			КонецЕсли;
		КонецЦикла;
		
		Если СтруктураДанныеСообщения.Количество() > 0 Тогда
			МенеджерЗаписи = РегистрыСведений.ДанныеПоследнихОповещений.СоздатьМенеджерЗаписи();
			МенеджерЗаписи.ВидОповещения              = ДанныеВидаОповещения.ВидОповещения;
			МенеджерЗаписи.ИсточникОповещения         = СтрокаДанныхШаблона.ИсточникОповещения;
			МенеджерЗаписи.Подписчик                  = СтрокаДанныхШаблона.Подписчик;
			МенеджерЗаписи.ДанныеПоследнегоОповещения = Новый ХранилищеЗначения(СтруктураДанныеСообщения);
			МенеджерЗаписи.Записать(Истина);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// Сообщение удовлетворяет условию отправки.
// 
// Параметры:
//  ДанныеВидаОповещения - Неопределено, ВыборкаИзРезультатаЗапроса - Данные вида оповещения:
//   * ВидОповещения - СправочникСсылка.ВидыОповещенийКлиентам -
//   * ГруппаРассылокИОповещений - СправочникСсылка.ГруппыРассылокИОповещений -
//   * ПредназначенаДляЭлектронныхПисем - Булево -
//   * ПредназначенаДляSMS - Булево -
//   * ШаблонСообщенияSMS - СправочникСсылка.ШаблоныСообщений -
//   * ШаблонЭлектронногоПисьма - СправочникСсылка.ШаблоныСообщений -
//   * УсловиеОтправки - Строка -
//   * ТипСобытия - Строка -
//   * Принудительная - Булево -
//   * УчетнаяЗапись - СправочникСсылка.УчетныеЗаписиЭлектроннойПочты -
//   * ВидКонтактнойИнформацииПартнераДляПисем - СправочникСсылка.ВидыКонтактнойИнформации -
//   * ВидКонтактнойИнформацииПартнераДляSMS - СправочникСсылка.ВидыКонтактнойИнформации -
//   * ВидКонтактнойИнформацииКонтактногоЛицаДляПисем - СправочникСсылка.ВидыКонтактнойИнформации -
//   * ВидКонтактнойИнформацииКонтактногоЛицаДляSMS - СправочникСсылка.ВидыКонтактнойИнформации -
//   * ОтправлятьПартнеру - Булево -
//   * ОтправлятьКонтактномуЛицуОбъектаОповещения - Булево -
//   * ОтправлятьКонтактнымЛицамРоли - Булево -
//   * РольКонтактногоЛица - СправочникСсылка.РолиКонтактныхЛицПартнеров -
//   * Ответственный - СправочникСсылка.Пользователи -
//   * УчетнаяЗаписьИмяПользователя - Строка -
//   * УчетнаяЗаписьАдресЭлектроннойПочты - Строка -
//   * УдалятьПисьмаПослеОтправки - Булево -
//   * Наименование - Строка -
//   * ПараметрыУсловия - ТаблицаЗначений - содержит:
//    ** ЭтоПараметрПредыдущегоСообщения - Булево -
//    ** ИмяПараметра - Строка -
//   * ИспользуетсяУсловиеОтправки - Булево -
// СтрокаДанныхШаблона - СтрокаТаблицыЗначений - Строка данных шаблона
// ДанныеПолучателей - Структура - содержит:
//   * ДанныеПоследнегоОповещения - ХранилищеЗначения -  
// 
// Возвращаемое значение:
//  Булево - Сообщение удовлетворяет условию отправки
Функция СообщениеУдовлетворяетУсловиюОтправки(ДанныеВидаОповещения, СтрокаДанныхШаблона, ДанныеПолучателей)
	
	Если НЕ ДанныеВидаОповещения.ИспользуетсяУсловиеОтправки Тогда
		Возврат Истина;
	КонецЕсли;
	
	ТребуютсяДанныеПоследнегоОповещения = (СтрНайти(ДанныеВидаОповещения.УсловиеОтправки, "ПредыдущееСообщение") > 0);
	
	Если ТребуютсяДанныеПоследнегоОповещения
		И ДанныеПолучателей.ДанныеПоследнегоОповещения = Неопределено Тогда
		Возврат Истина;
	КонецЕсли;
	
	Если ТребуютсяДанныеПоследнегоОповещения Тогда
		ДанныеПредыдущегоСообщения = ДанныеПолучателей.ДанныеПоследнегоОповещения.Получить();
		Если ДанныеПредыдущегоСообщения = Неопределено Тогда
			Возврат Истина;
		КонецЕсли;
	КонецЕсли;
	
	УсловиеОтправки = ДанныеВидаОповещения.УсловиеОтправки;
	
	Попытка
		
		ПараметрыУсловияОтправки = Новый Структура;
		ПараметрыУсловияОтправки.Вставить("ТипШаблона", "SMS");
		ПараметрыУсловияОтправки.Вставить("Текст", УсловиеОтправки);
		СоответствиеПараметровУсловия = ШаблоныСообщений.ПараметрыИзТекстаСообщения(ПараметрыУсловияОтправки);
		
		ТекущееСообщение = Новый Структура;
		ПредыдущееСообщение = Новый Структура;
		
		Для Каждого ЭлементСоответствия Из СоответствиеПараметровУсловия Цикл
			Для Каждого Параметр Из ЭлементСоответствия.Значение Цикл
				Если ЭлементСоответствия.Ключ = "ПредыдущееСообщение" Тогда
					
					ПредыдущееСообщение.Вставить(Параметр.Ключ, ДанныеПредыдущегоСообщения[Параметр.Ключ]);
					
				ИначеЕсли ЭлементСоответствия.Ключ = "ТекущееСообщение" Тогда
					
					ТекущееСообщение.Вставить(Параметр.Ключ, СтрокаДанныхШаблона[Параметр.Ключ]);
					
				Иначе
					
					Продолжить;
					
				КонецЕсли;
				
				УсловиеОтправки = СтрЗаменить(УсловиеОтправки, "[ПредыдущееСообщение", "Параметры.ПредыдущееСообщение");
				УсловиеОтправки = СтрЗаменить(УсловиеОтправки, "[ТекущееСообщение",    "Параметры.ТекущееСообщение");
				УсловиеОтправки = СтрЗаменить(УсловиеОтправки, "]", "");
				
			КонецЦикла;
		КонецЦикла;
		
		Параметры = Новый Структура;
		Параметры.Вставить("ПредыдущееСообщение", ПредыдущееСообщение);
		Параметры.Вставить("ТекущееСообщение",    ТекущееСообщение);
		
		Если ОбщегоНазначения.ВычислитьВБезопасномРежиме(УсловиеОтправки, Параметры) = Ложь Тогда
			Возврат Ложь;
		Иначе
			Возврат Истина;
		КонецЕсли;
	
	Исключение
		// Если проверку выполнить не удалось, то пропускаем ее.
		Возврат Истина;
	КонецПопытки;
	
	Возврат Истина;
	
КонецФункции

Функция ЗначенияРеквизитовПоПараметрам(СтрокаДанныхШаблона, ДанныеШаблона, ДанныеТипаСобытия)

	СоответствиеПараметровТекстаСообщения = ШаблоныСообщений.ПараметрыИзТекстаСообщения(ДанныеШаблона);
	СоответствиеПараметров = СоответствиеПараметровТекстаСообщения.Получить(ДанныеТипаСобытия.Имя);

	Если СоответствиеПараметров <> Неопределено Тогда
		СтрокаДанныхШаблонаСоответствие = СтрокаТаблицыЗначенийВСоответствие(СтрокаДанныхШаблона);
		ЗаполнитьПараметрыВСоответствии(СоответствиеПараметров, СтрокаДанныхШаблонаСоответствие);
	КонецЕсли;
	
	Если СоответствиеПараметровТекстаСообщения[ШаблоныСообщений.ИмяУзлаОбщихРеквизитов()] <> Неопределено Тогда
		ШаблоныСообщений.ЗаполнитьОбщиеРеквизиты(СоответствиеПараметровТекстаСообщения[ШаблоныСообщений.ИмяУзлаОбщихРеквизитов()]);
	КонецЕсли;
	
	Возврат СоответствиеПараметровТекстаСообщения;

КонецФункции

Функция СтрокаТаблицыЗначенийВСоответствие(СтрокаТаблицыЗначений)
	
	Соответствие = Новый Соответствие;
	Для каждого Колонка Из СтрокаТаблицыЗначений.Владелец().Колонки Цикл
		Соответствие.Вставить(Колонка.Имя, СтрокаТаблицыЗначений[Колонка.Имя]);
	КонецЦикла;
	
	Возврат Соответствие;
	
КонецФункции

Процедура ЗаполнитьПараметрыВСоответствии(СоответствиеПараметров, СтрокаДанныхШаблонаСоответствие, Префикс = "")
	
	Для Каждого Параметр Из СоответствиеПараметров Цикл
		
		Если СтрНайти(Параметр.Ключ, "~") и ЗначениеЗаполнено(СтрокаДанныхШаблонаСоответствие[Префикс]) Тогда
			ЗаполнитьРеквизитыСвойствИКонтактнойИнформации(СоответствиеПараметров, СтрокаДанныхШаблонаСоответствие[Префикс]);
		ИначеЕсли ТипЗнч(Параметр.Значение) = Тип("Соответствие") Тогда
			ЗаполнитьПараметрыВСоответствии(Параметр.Значение, СтрокаДанныхШаблонаСоответствие, Префикс + Параметр.Ключ);
		Иначе
			Если СтрокаДанныхШаблонаСоответствие[Префикс] <> Неопределено Тогда
				СоответствиеПараметров[Параметр.Ключ] = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтрокаДанныхШаблонаСоответствие[Префикс], Параметр.Ключ);
			Иначе
				СоответствиеПараметров[Параметр.Ключ] = СтрокаДанныхШаблонаСоответствие[Параметр.Ключ];
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Функция ЗначенияРеквизитовСвойств(Предмет)
	
	ЗначенияСвойств = Новый ТаблицаЗначений;
	Если ОбщегоНазначения.ПодсистемаСуществует("СтандартныеПодсистемы.Свойства") Тогда
		МодульУправлениеСвойствами = ОбщегоНазначения.ОбщийМодуль("УправлениеСвойствами");
		ПолучатьДопСведения = МодульУправлениеСвойствами.ИспользоватьДопСведения(Предмет);
		ПолучатьДопРеквизиты = МодульУправлениеСвойствами.ИспользоватьДопРеквизиты(Предмет);
		
		Если ПолучатьДопРеквизиты Или ПолучатьДопСведения Тогда
			ЗначенияСвойств = МодульУправлениеСвойствами.ЗначенияСвойств(Предмет, ПолучатьДопРеквизиты, ПолучатьДопСведения);
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат ЗначенияСвойств;
	
КонецФункции

Функция ЗначенияРеквизитовКонтактнойИнформации(Предмет)
	
	КонтактнаяИнформацияОбъектов = Неопределено;
	Если ОбщегоНазначения.ПодсистемаСуществует("СтандартныеПодсистемы.КонтактнаяИнформация") Тогда
		МодульУправлениеКонтактнойИнформацией = ОбщегоНазначения.ОбщийМодуль("УправлениеКонтактнойИнформацией");	
		
		ОбъектыСКонтактнойИнформацией = Новый Массив;
		ОбъектыСКонтактнойИнформацией.Добавить(Предмет);
		ВидыКонтактнойИнформации = МодульУправлениеКонтактнойИнформацией.ВидыКонтактнойИнформацииОбъекта(Предмет.Ссылка);
		Если ВидыКонтактнойИнформации.Количество() > 0 Тогда
			КонтактнаяИнформацияОбъектов = МодульУправлениеКонтактнойИнформацией.КонтактнаяИнформацияОбъектов(ОбъектыСКонтактнойИнформацией,,, ТекущаяДатаСеанса());
		КонецЕсли;
	КонецЕсли;
	
	Возврат КонтактнаяИнформацияОбъектов;
	
КонецФункции

Функция ИмяПараметраБезСтрокиФормата(Знач ПараметрШаблонаИзТекста)
	
	Результат = Новый Структура;
	Результат.Вставить("Имя",   "");
	Результат.Вставить("Формат", "");
	
	ПозицияФорматТекст = СтрНайти(ПараметрШаблонаИзТекста, "{", НаправлениеПоиска.СКонца);
	Если ПозицияФорматТекст > 0 Тогда
		Результат.Имя = Лев(ПараметрШаблонаИзТекста, ПозицияФорматТекст - 1);
		Результат.Формат = Сред(ПараметрШаблонаИзТекста, ПозицияФорматТекст + 1, СтрДлина(ПараметрШаблонаИзТекста) - ПозицияФорматТекст - 1);
	Иначе
		Результат.Имя = ПараметрШаблонаИзТекста;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Процедура ЗаполнитьРеквизитыСвойствИКонтактнойИнформации(ПараметрыТекстаСообщения, Предмет) Экспорт 
	
	МетаданныеОбъекта = Предмет.Метаданные();
	ЗначенияСвойств = ЗначенияРеквизитовСвойств(Предмет);
	КонтактнаяИнформацияОбъектов = ЗначенияРеквизитовКонтактнойИнформации(Предмет);
	
	Для каждого ПараметрОснования Из ПараметрыТекстаСообщения Цикл
		
		Если СтрНачинаетсяС(ПараметрОснования.Ключ, "~Свойство") Тогда
			
			Для каждого ПараметрСвойство Из ПараметрОснования.Значение Цикл
				Если ЗначенияСвойств <> Неопределено Тогда
					Для каждого СтрокаСвойство Из ЗначенияСвойств Цикл
						ОписаниеПараметра = ИмяПараметраБезСтрокиФормата(ПараметрСвойство.Ключ);
						ИдентификаторДляФормул = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтрокаСвойство.Свойство, "ИдентификаторДляФормул");
						Если СтрСравнить(ИдентификаторДляФормул, ОписаниеПараметра.Имя) = 0 Тогда
							Если ПустаяСтрока(ОписаниеПараметра.Формат) Тогда
								ПараметрОснования.Значение[ПараметрСвойство.Ключ] = Строка(СтрокаСвойство.Значение);
							Иначе
								ПараметрОснования.Значение[ПараметрСвойство.Ключ] = Формат(СтрокаСвойство.Значение, ОписаниеПараметра.Формат);
							КонецЕсли;
						КонецЕсли;
					КонецЦикла;
				КонецЕсли;
			КонецЦикла;
			
		ИначеЕсли СтрНачинаетсяС(ПараметрОснования.Ключ, "~КИ") Тогда
			
			Для каждого ПараметрКонтактнойИнформации Из ПараметрОснования.Значение Цикл
				
				Для каждого КонтактнаяИнформацияОбъекта Из КонтактнаяИнформацияОбъектов Цикл
					ИдентификаторДляФормул = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(КонтактнаяИнформацияОбъекта.Вид, "ИдентификаторДляФормул");
					
					Если СтрСравнить(ИдентификаторДляФормул, ПараметрКонтактнойИнформации.Ключ) = 0 Тогда
						Если ЗначениеЗаполнено(ПараметрыТекстаСообщения[ПараметрКонтактнойИнформации.Ключ]) Тогда
							ПредыдущиеЗначение = ПараметрыТекстаСообщения[ПараметрКонтактнойИнформации.Ключ] +", ";
						Иначе
							ПредыдущиеЗначение = "";
						КонецЕсли;
						ПараметрОснования.Значение[ПараметрКонтактнойИнформации.Ключ] = ПредыдущиеЗначение + Строка(КонтактнаяИнформацияОбъекта.Представление);
					КонецЕсли;
				КонецЦикла;
				
			КонецЦикла;
			
		ИначеЕсли ТипЗнч(ПараметрОснования.Значение) = Тип("Соответствие") Тогда
			
			МетаданныеОбъектаПоКлючу = МетаданныеОбъекта.Реквизиты.Найти(ПараметрОснования.Ключ);
			Если МетаданныеОбъектаПоКлючу <> Неопределено  Тогда
				ЗаполнитьРеквизитыСвойствИКонтактнойИнформации(ПараметрОснования.Значение, Предмет[ПараметрОснования.Ключ]);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

// Формирует данные шаблона по виду оповещения.
// 
// Параметры:
// 	ДанныеВидаОповещения - см. ДанныеВидаОповещения
// 	ДатаОтработки - Дата - 
// ДанныеТипаСобытия - см. Перечисления.ТипыСобытийОповещений.ДанныеДляОбработкиОчередиОповещений
// Возвращаемое значение:
// 	Структура - Описание:
// * ДанныеШаблонаПисьма - см. ДанныеШаблонаСообщений
// * ДанныеШаблонаSMS - см. ДанныеШаблонаСообщений
//
Функция ДанныеШаблоновВидаОповещений(ДанныеВидаОповещения, ДатаОтработки, ДанныеТипаСобытия)

	ДанныеШаблоновСообщений = Новый Структура;
	ДанныеШаблоновСообщений.Вставить("ДанныеШаблонаSMS",Неопределено);
	ДанныеШаблоновСообщений.Вставить("ДанныеШаблонаПисьма", Неопределено);
	Если ДанныеВидаОповещения.ИспользуетсяУсловиеОтправки Тогда
		ПараметрыУсловия = ДанныеВидаОповещения.ПараметрыУсловия.Выгрузить();
	Иначе
		ПараметрыУсловия = Неопределено;
	КонецЕсли;
	
	Если ДанныеВидаОповещения.ПредназначенаДляSMS Тогда
		ДанныеШаблоновСообщений.ДанныеШаблонаSMS = ДанныеШаблонаСообщений(ДатаОтработки,
		                                                                  ДанныеВидаОповещения.ВидОповещения,
		                                                                  ДанныеВидаОповещения.ШаблонСообщенияSMS,
		                                                                  ПараметрыУсловия,
		                                                                  Ложь,
		                                                                  ДанныеТипаСобытия);
	КонецЕсли;
	
	Если ДанныеВидаОповещения.ПредназначенаДляЭлектронныхПисем Тогда
		ДанныеШаблоновСообщений.ДанныеШаблонаПисьма = ДанныеШаблонаСообщений(ДатаОтработки,
		                                                                     ДанныеВидаОповещения.ВидОповещения,
		                                                                     ДанныеВидаОповещения.ШаблонЭлектронногоПисьма,
		                                                                     ПараметрыУсловия,
		                                                                     Истина,
		                                                                     ДанныеТипаСобытия);
	КонецЕсли;
	
	Возврат ДанныеШаблоновСообщений;

КонецФункции

// Формирует данные шаблона сообщений
// 
// Параметры:
// 	ДатаОтработки - Дата - 
// 	ВидОповещения - СправочникСсылка.ВидыОповещенийКлиентам - 
// 	ШаблонСообщения - СправочникСсылка.ШаблоныСообщений - 
// 	ПараметрыУсловия - ТаблицаЗначений - Описание
// 	ПредназначенДляПисем - Булево - Описание
// 	ДанныеТипаСобытия - см. Перечисления.ТипыСобытийОповещений.ДанныеДляОбработкиОчередиОповещений
// Возвращаемое значение:
//  Структура - содержит:
//   * ДанныеШаблона - см. ШаблоныСообщенийКлиентСервер.ОписаниеПараметровШаблона
//   * ТаблицаВыводимыхПолей - ТаблицаЗначений -
//   * ТаблицаПрисоединенныхФайлов - ТаблицаЗначений - 
//
Функция ДанныеШаблонаСообщений(ДатаОтработки, ВидОповещения, ШаблонСообщения, ПараметрыУсловия, ПредназначенДляПисем, ДанныеТипаСобытия)

	СтруктураВозврата = Новый Структура;
	СтруктураВозврата.Вставить("ДанныеШаблона",               Неопределено);
	СтруктураВозврата.Вставить("ТаблицаВыводимыхПолей",       Неопределено);
	СтруктураВозврата.Вставить("ТаблицаПрисоединенныхФайлов", Неопределено);
	СтруктураВозврата.Вставить("ТаблицаПечатныхФорм",         Неопределено);
	
	ДанныеШаблона = ШаблоныСообщений.ПараметрыШаблона(ШаблонСообщения);
	СтруктураВозврата.ДанныеШаблона = ДанныеШаблона;
	
	Если ДанныеШаблона.ШаблонПоВнешнейОбработке Тогда
		Возврат СтруктураВозврата;
	КонецЕсли;
	
	СоответствиеПараметровТекстаСообщения = ШаблоныСообщений.ПараметрыИзТекстаСообщения(ДанныеШаблона);
	
	Если СоответствиеПараметровТекстаСообщения.Количество() = 0 Тогда
		ТипСобытия = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ВидОповещения, "ТипСобытия");
		Если Не ЗначениеЗаполнено(ТипСобытия) Тогда
			Возврат Неопределено;
		КонецЕсли;
		СоответствиеПараметровТекстаСообщения.Вставить(ОбщегоНазначения.ИмяЗначенияПеречисления(ТипСобытия), Новый Массив);
	КонецЕсли;
	
	Для каждого ЭлементСоответствия Из СоответствиеПараметровТекстаСообщения Цикл
		
		Если ДанныеТипаСобытия.Имя <> ЭлементСоответствия.Ключ Тогда
			Продолжить;
		КонецЕсли;
			
		Попытка
	
			МакетСКД = Перечисления.ТипыСобытийОповещений.ПолучитьМакет(ЭлементСоответствия.Ключ);
			СнятьОграничениеИспользованияУПоля("Подписчик", МакетСКД.НаборыДанных.Данные);
			СнятьОграничениеИспользованияУПоля("ИсточникОповещения", МакетСКД.НаборыДанных.Данные);
			
			АдресСхемы = ПоместитьВоВременноеХранилище(МакетСКД, Новый УникальныйИдентификатор);
			КомпоновщикНастроек = Новый КомпоновщикНастроекКомпоновкиДанных;
			КомпоновщикНастроек.Инициализировать(Новый ИсточникДоступныхНастроекКомпоновкиДанных(АдресСхемы));
			
			КомпоновщикНастроек.ЗагрузитьНастройки(МакетСКД.НастройкиПоУмолчанию);
			КомпоновщикНастроек.Восстановить(СпособВосстановленияНастроекКомпоновкиДанных.Полное);
			КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных();
			
			Для Каждого ВыбранноеПоле Из ЭлементСоответствия.Значение Цикл 
				ОтчетыУТКлиентСервер.ДобавитьВыбранноеПоле(КомпоновщикНастроек, ВыбранноеПоле.Ключ);
			КонецЦикла;
			ОтчетыУТКлиентСервер.ДобавитьВыбранноеПоле(КомпоновщикНастроек, "ИсточникОповещения");
			ОтчетыУТКлиентСервер.ДобавитьВыбранноеПоле(КомпоновщикНастроек, "Подписчик");
			
			Если ПараметрыУсловия <> Неопределено Тогда
				Для Каждого Параметр Из ПараметрыУсловия Цикл
					Если (Не Параметр.ЭтоПараметрПредыдущегоСообщения) 
						  И (ЭлементСоответствия.Значение.Получить(Параметр.ИмяПараметра) = Неопределено) Тогда
						ОтчетыУТКлиентСервер.ДобавитьВыбранноеПоле(КомпоновщикНастроек, Параметр.ИмяПараметра);
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			
			МакетКомпоновкиДанных = КомпоновщикМакета.Выполнить(МакетСКД, КомпоновщикНастроек.ПолучитьНастройки(),,,Тип("ГенераторМакетаКомпоновкиДанныхДляКоллекцииЗначений"));
			ТекстЗапроса = МакетКомпоновкиДанных.НаборыДанных.Данные.Запрос;
			
			Запрос = Новый Запрос;
			Запрос.Текст = ТекстЗапроса;
			
			Для Каждого ЗначениеПараметра Из МакетКомпоновкиДанных.ЗначенияПараметров Цикл
				
				Если ТипЗнч(ЗначениеПараметра.Значение) = Тип("ВыражениеКомпоновкиДанных") Тогда
					Запрос.УстановитьПараметр(ЗначениеПараметра.Имя, ОбщегоНазначения.ВычислитьВБезопасномРежиме(ЗначениеПараметра.Значение));
				КонецЕсли;
				
			КонецЦикла;
			
			Запрос.УстановитьПараметр("ВидОповещения", ВидОповещения);
			Запрос.УстановитьПараметр("ДатаОтработки", ДатаОтработки);
			Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДатаСеанса());
			Запрос.УстановитьПараметр("ВалютаУправленческогоУчета", Константы.ВалютаУправленческогоУчета.Получить());
			
			СтруктураВозврата.ТаблицаВыводимыхПолей = Запрос.Выполнить().Выгрузить();
			
			Прервать;
			
		Исключение
			
			Возврат Неопределено
			
		КонецПопытки;
		
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ШаблоныСообщенийПрисоединенныеФайлы.Ссылка,
	|	ШаблоныСообщенийПрисоединенныеФайлы.Размер,
	|	ШаблоныСообщенийПрисоединенныеФайлы.ИДФайлаЭлектронногоПисьма,
	|	ШаблоныСообщенийПрисоединенныеФайлы.Наименование,
	|	ШаблоныСообщенийПрисоединенныеФайлы.Расширение,
	|	НЕОПРЕДЕЛЕНО КАК АдресВременногоХранилища
	|ИЗ
	|	Справочник.ШаблоныСообщенийПрисоединенныеФайлы КАК ШаблоныСообщенийПрисоединенныеФайлы
	|ГДЕ
	|	НЕ ШаблоныСообщенийПрисоединенныеФайлы.ПометкаУдаления
	|	И ШаблоныСообщенийПрисоединенныеФайлы.ВладелецФайла = &ШаблонСообщения
	|	И ШаблоныСообщенийПрисоединенныеФайлы.ИДФайлаЭлектронногоПисьма <> """"";
	
	Запрос.УстановитьПараметр("ШаблонСообщения", ШаблонСообщения);
	
	Результат = Запрос.Выполнить();
	
	ТаблицаПрисоединенныхФайлов = Результат.Выгрузить();
	УникальныйИдентификаторДляПомещения = Новый УникальныйИдентификатор;
	Для Каждого ПрисоединенныйФайл Из ТаблицаПрисоединенныхФайлов Цикл
		
		ПрисоединенныйФайл.АдресВременногоХранилища = ПоместитьВоВременноеХранилище(
		                                     РаботаСФайлами.ДвоичныеДанныеФайла(ПрисоединенныйФайл["Ссылка"]),
		                                     УникальныйИдентификаторДляПомещения);
	КонецЦикла;
	
	СтруктураВозврата.ТаблицаПрисоединенныхФайлов = ТаблицаПрисоединенныхФайлов;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ШаблоныСообщенийПечатныеФормыИВложения.Идентификатор КАК Идентификатор,
	|	ШаблоныСообщенийПечатныеФормыИВложения.НомерСтроки КАК НомерСтроки,
	|	ШаблоныСообщенийПечатныеФормыИВложения.Имя КАК Имя
	|ИЗ
	|	Справочник.ШаблоныСообщений.ПечатныеФормыИВложения КАК ШаблоныСообщенийПечатныеФормыИВложения
	|ГДЕ
	|	ШаблоныСообщенийПечатныеФормыИВложения.Ссылка = &ШаблонСообщения";
	
	Запрос.УстановитьПараметр("ШаблонСообщения", ШаблонСообщения);
	
	СтруктураВозврата.ТаблицаПечатныхФорм = Запрос.Выполнить().Выгрузить();
	
	Возврат СтруктураВозврата;

КонецФункции

Процедура СнятьОграничениеИспользованияУПоля(ИмяПоля, НаборДанных)
	
	ПолеИсточникОповещений = НаборДанных.Поля.Найти(ИмяПоля);
	Если ПолеИсточникОповещений <> Неопределено Тогда
		ПолеИсточникОповещений.ОграничениеИспользования.Поле = Ложь;
	КонецЕсли;
	
КонецПроцедуры

Функция ДанныеПолучателейПоВидуОповещения(ДанныеВидаОповещения, ДатаОбработки, ДанныеТипаСобытия)
	
	ШаблонЗапроса = "
	|%ВременнаяТаблицаПодписчики%
	|%ВременнаяТаблицаКонтактныеЛицаОповещения%
	|%ВременнаяТаблицаКонтактныеЛицаПодписчика%
	|%КонтактнаяИнформацияПодписчики%
	|%КонтактнаяИнформацияКонтактныхЛицОповещения%
	|%КонтактнаяИнформацияКонтактныхЛицПодписчика%
	|
	|ИТОГИ ПО
	|	ИсточникОповещения,
	|	Подписчик,
	|	Получатель
	|";
	
	ИтоговыйЗапросСодержитТекст = Ложь;
	
	ОбработатьТекстЗапросаПоПодписчикамДляОповещений(ШаблонЗапроса,
	                                                 ДанныеВидаОповещения,
	                                                 ДатаОбработки,
	                                                 ДанныеТипаСобытия,
	                                                 ИтоговыйЗапросСодержитТекст);
	
	ОбработатьТекстЗапросаПоКонтактнымЛицамДляОповещений(ШаблонЗапроса,
	                                                     ДанныеВидаОповещения,
	                                                     ДатаОбработки,
	                                                     ДанныеТипаСобытия,
	                                                     ИтоговыйЗапросСодержитТекст);
	 
	ОбработатьТекстЗапросаПоКонтактнымЛицамПодписчика(ШаблонЗапроса,
	                                                  ДанныеВидаОповещения,
	                                                  ДатаОбработки,
	                                                  ДанныеТипаСобытия,
	                                                  ИтоговыйЗапросСодержитТекст);
	
	ТекстЗапросаПоКонтактнымЛицам = "";
	
	Запрос = Новый Запрос;
	Запрос.Текст = ШаблонЗапроса;
	
	Запрос.УстановитьПараметр("ВидОповещения", ДанныеВидаОповещения.ВидОповещения);
	Запрос.УстановитьПараметр("ДатаОбработки", ДатаОбработки);
	Запрос.УстановитьПараметр("РольКонтактногоЛица", ДанныеВидаОповещения.РольКонтактногоЛица);
	Запрос.УстановитьПараметр("ВидКИКонтактногоЛицаДляПисем", ДанныеВидаОповещения.ВидКонтактнойИнформацииКонтактногоЛицаДляПисем);
	Запрос.УстановитьПараметр("ВидКИКонтактногоЛицаДляSMS", ДанныеВидаОповещения.ВидКонтактнойИнформацииКонтактногоЛицаДляSMS);
	Запрос.УстановитьПараметр("ВидКИПартнераДляПисем", ДанныеВидаОповещения.ВидКонтактнойИнформацииПартнераДляПисем);
	Запрос.УстановитьПараметр("ВидКИПартнераДляSMS", ДанныеВидаОповещения.ВидКонтактнойИнформацииПартнераДляSMS);
	Запрос.УстановитьПараметр("ГруппаРассылокИОповещений", ДанныеВидаОповещения.ГруппаРассылокИОповещений);
	
	СоответствиеДанныхПолучателей = Новый Соответствие;
	
	ВыборкаИтоги = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаИтоги.Следующий() Цикл
		
		СоответствиеПодписчики = Новый Соответствие;
		
		ВыборкаПодписчик = ВыборкаИтоги.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаПодписчик.Следующий() Цикл
			
			СтруктураДанныеПодписчика = Новый Структура;
			МассивПолучателей = Новый Массив;
			
			ВыборкаПолучатель = ВыборкаПодписчик.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаПолучатель.Следующий() Цикл
				
				МассивНомеровТелефонов  = Новый Массив;
				МассивАдресовЭП         = Новый Массив;
				ПредставлениеПолучателя = "";
				
				ВыборкаДетали = ВыборкаПолучатель.Выбрать();
				Пока ВыборкаДетали.Следующий() Цикл
					
					ПредставлениеПолучателя = ?(ПустаяСтрока(ПредставлениеПолучателя), ВыборкаДетали.ПредставлениеПолучателя, ПредставлениеПолучателя);
					
					Если ДанныеВидаОповещения.ПредназначенаДляSMS 
						И (НЕ ПустаяСтрока(ВыборкаДетали.ПредставлениеТелефон) ИЛИ НЕ ПустаяСтрока(ВыборкаДетали.ЗначениеПолейТелефон)) Тогда
						
						МассивНомеровТелефонов.Добавить(Новый Структура("Представление, ЗначениеПолей",
						                                                ВыборкаДетали.ПредставлениеТелефон, ВыборкаДетали.ЗначениеПолейТелефон));
						
					КонецЕсли;
					
					Если ДанныеВидаОповещения.ПредназначенаДляЭлектронныхПисем 
						И (НЕ ПустаяСтрока(ВыборкаДетали.ПредставлениеПисьмо) ИЛИ НЕ ПустаяСтрока(ВыборкаДетали.ЗначениеПолейПисьмо)) Тогда
						
						МассивАдресовЭП.Добавить(Новый Структура("Представление, ЗначениеПолей",
						                                         ВыборкаДетали.ПредставлениеПисьмо, ВыборкаДетали.ЗначениеПолейПисьмо));
						
					КонецЕсли;
					
				КонецЦикла;
				
				СтруктураКонтактнойИнформации = Новый Структура;
				СтруктураКонтактнойИнформации.Вставить("МассивНомеровТелефонов", МассивНомеровТелефонов);
				СтруктураКонтактнойИнформации.Вставить("МассивАдресовЭП", МассивАдресовЭП);
				
				СтруктураПолучатель = Новый Структура;
				СтруктураПолучатель.Вставить("Получатель", ВыборкаПолучатель.Получатель);
				СтруктураПолучатель.Вставить("ПредставлениеПолучателя", ПредставлениеПолучателя);
				СтруктураПолучатель.Вставить("КонтактнаяИнформация", СтруктураКонтактнойИнформации);
				
				МассивПолучателей.Добавить(СтруктураПолучатель);
				
			КонецЦикла;
			
			СтруктураДанныеПодписчика.Вставить("МассивПолучателей", МассивПолучателей);
			СтруктураДанныеПодписчика.Вставить("ДатаОтправки", Дата(1,1,1));
			СтруктураДанныеПодписчика.Вставить("ДатаАктуальностиОтправки", Дата(1,1,1));
			СтруктураДанныеПодписчика.Вставить("ДанныеПоследнегоОповещения", Неопределено);
			СоответствиеПодписчики.Вставить(ВыборкаПодписчик.Подписчик, СтруктураДанныеПодписчика);
			
		КонецЦикла;
		
		СоответствиеДанныхПолучателей.Вставить(ВыборкаИтоги.ИсточникОповещения, СоответствиеПодписчики);
		
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения КАК ИсточникОповещения,
	|	ОчередьСобытийДляОповещенийКлиентам.Подписчик КАК Подписчик,
	|	МАКСИМУМ(ОчередьСобытийДляОповещенийКлиентам.ДатаОтправки) КАК ДатаОтправки,
	|	МАКСИМУМ(ОчередьСобытийДляОповещенийКлиентам.ДатаАктуальностиОтправки) КАК ДатаАктуальностиОтправки
	|ПОМЕСТИТЬ ДатыРассылок
	|ИЗ
	|	РегистрСведений.ОчередьСобытийДляОповещенийКлиентам КАК ОчередьСобытийДляОповещенийКлиентам
	|ГДЕ
	|	ОчередьСобытийДляОповещенийКлиентам.ВидОповещения = &ВидОповещения
	|	И ОчередьСобытийДляОповещенийКлиентам.Период < &ДатаОбработки
	|
	|СГРУППИРОВАТЬ ПО
	|	ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения,
	|	ОчередьСобытийДляОповещенийКлиентам.Подписчик
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ИсточникОповещения,
	|	Подписчик
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДатыРассылок.ИсточникОповещения,
	|	ДатыРассылок.Подписчик,
	|	ДатыРассылок.ДатаОтправки,
	|	ДатыРассылок.ДатаАктуальностиОтправки,
	|	ЕСТЬNULL(ДанныеПоследнихОповещений.ДанныеПоследнегоОповещения, НЕОПРЕДЕЛЕНО) КАК ДанныеПоследнегоОповещения
	|ИЗ
	|	ДатыРассылок КАК ДатыРассылок
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПоследнихОповещений КАК ДанныеПоследнихОповещений
	|		ПО ДатыРассылок.ИсточникОповещения = ДанныеПоследнихОповещений.ИсточникОповещения
	|			И ДатыРассылок.Подписчик = ДанныеПоследнихОповещений.Подписчик
	|			И (ДанныеПоследнихОповещений.ВидОповещения = &ВидОповещения)";
	
	Запрос.УстановитьПараметр("ВидОповещения", ДанныеВидаОповещения.ВидОповещения);
	Запрос.УстановитьПараметр("ДатаОбработки", ДатаОбработки);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ДанныеИсточника = СоответствиеДанныхПолучателей.Получить(Выборка.ИсточникОповещения);
		Если ДанныеИсточника <> Неопределено Тогда
			ДанныеПодписчика = ДанныеИсточника.Получить(Выборка.Подписчик); // Структура
			Если ДанныеПодписчика <> Неопределено Тогда
				ДанныеПодписчика.ДатаОтправки               = Выборка.ДатаОтправки; 
				ДанныеПодписчика.ДатаАктуальностиОтправки   = Выборка.ДатаАктуальностиОтправки;
				ДанныеПодписчика.ДанныеПоследнегоОповещения = Выборка.ДанныеПоследнегоОповещения;
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат СоответствиеДанныхПолучателей;
	
КонецФункции

Процедура ОбработатьТекстЗапросаПоПодписчикамДляОповещений(ШаблонЗапроса, ДанныеВидаОповещения, ДатаОтработки, ДанныеТипаСобытия, ИтоговыйЗапросСодержитТекст)
	
	Если НЕ ДанныеТипаСобытия.ОтправлятьПартнеру И  НЕ ДанныеТипаСобытия.ОтправлятьКонтактнымЛицамПартнера  Тогда
		
		ТекстВременнаяТаблицаПодписчики = "";
		ТекстКонтактнаяИнформацияПодписчики = "";
		
	Иначе
		
		ТекстВременнаяТаблицаПодписчики = "
		|ВЫБРАТЬ
		|	ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения,
		|	ОчередьСобытийДляОповещенийКлиентам.Подписчик
		|ПОМЕСТИТЬ Подписчики
		|ИЗ
		|	РегистрСведений.ОчередьСобытийДляОповещенийКлиентам КАК ОчередьСобытийДляОповещенийКлиентам
		|ГДЕ
		|	ОчередьСобытийДляОповещенийКлиентам.ВидОповещения = &ВидОповещения
		|	И ОчередьСобытийДляОповещенийКлиентам.Период < &ДатаОбработки
		|;
		|
		|/////////////////////////////////////////////////////";
		
		Если ДанныеВидаОповещения.Принудительная Тогда
			
			Если ДанныеТипаСобытия.ОтправлятьПартнеру И ДанныеВидаОповещения.ОтправлятьПартнеру Тогда
				
				ИтоговыйЗапросСодержитТекст = Истина;
				
				ТекстКонтактнаяИнформацияПодписчики = "
				|ВЫБРАТЬ
				|	Подписчики.ИсточникОповещения КАК ИсточникОповещения,
				|	Подписчики.Подписчик КАК Подписчик,
				|	Подписчики.Подписчик КАК Получатель,
				|	Партнеры.НаименованиеПолное КАК ПредставлениеПолучателя,
				|	ЕСТЬNULL(КонтактнаяИнформацияДляSMS.Представление, """") КАК ПредставлениеТелефон,
				|	ПОДСТРОКА(ЕСТЬNULL(КонтактнаяИнформацияДляSMS.ЗначенияПолей, """"), 1, 1024) КАК ЗначениеПолейТелефон,
				|	ЕСТЬNULL(КонтактнаяИнформацияДляПисем.Представление, """") КАК ПредставлениеПисьмо,
				|	ПОДСТРОКА(ЕСТЬNULL(КонтактнаяИнформацияДляПисем.ЗначенияПолей, """"), 1, 1024) КАК ЗначениеПолейПисьмо
				|ИЗ
				|	Подписчики КАК Подписчики
				|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Партнеры.КонтактнаяИнформация КАК КонтактнаяИнформацияДляПисем
				|		ПО Подписчики.Подписчик = КонтактнаяИнформацияДляПисем.Ссылка
				|			И (КонтактнаяИнформацияДляПисем.Вид = &ВидКИПартнераДляПисем)
				|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Партнеры.КонтактнаяИнформация КАК КонтактнаяИнформацияДляSMS
				|		ПО Подписчики.Подписчик = КонтактнаяИнформацияДляSMS.Ссылка
				|			И (КонтактнаяИнформацияДляSMS.Вид = &ВидКИПартнераДляSMS)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Партнеры КАК Партнеры
				|		ПО Подписчики.Подписчик = Партнеры.Ссылка";
				
			КонецЕсли;

			
		Иначе
			
			Если ДанныеТипаСобытия.ОтправлятьПартнеру Тогда
				
				ИтоговыйЗапросСодержитТекст = Истина;
				
				ТекстКонтактнаяИнформацияПодписчики = "
				|ВЫБРАТЬ
				|	Подписчики.ИсточникОповещения КАК ИсточникОповещения,
				|	Подписчики.Подписчик,
				|	Подписчики.Подписчик КАК Получатель,
				|	Партнеры.НаименованиеПолное КАК ПредставлениеПолучателя,
				|	ЕСТЬNULL(ПодпискиНаРассылкиИОповещенияКлиентам.ВидКИПартнераДляПисем, НЕОПРЕДЕЛЕНО) КАК ВидКИДляПисем,
				|	ЕСТЬNULL(ПодпискиНаРассылкиИОповещенияКлиентам.ВидКИПартнераДляSMS, НЕОПРЕДЕЛЕНО) КАК ВидКИДляSMS
				|ПОМЕСТИТЬ ПодписчикиВидыКИ
				|ИЗ
				|	Подписчики КАК Подписчики
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Партнеры КАК Партнеры
				|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПодпискиНаРассылкиИОповещенияКлиентам КАК ПодпискиНаРассылкиИОповещенияКлиентам
				|			ПО (НЕ ПодпискиНаРассылкиИОповещенияКлиентам.ПометкаУдаления)
				|				И (ПодпискиНаРассылкиИОповещенияКлиентам.ПодпискаДействует)
				|				И (ПодпискиНаРассылкиИОповещенияКлиентам.ОтправлятьПартнеру)
				|				И (ПодпискиНаРассылкиИОповещенияКлиентам.ГруппаРассылокИОповещений = &ГруппаРассылокИОповещений)
				|				И Партнеры.Ссылка = ПодпискиНаРассылкиИОповещенияКлиентам.Владелец
				|		ПО Подписчики.Подписчик = Партнеры.Ссылка
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ПодписчикиВидыКИ.ИсточникОповещения,
				|	ПодписчикиВидыКИ.Подписчик,
				|	ПодписчикиВидыКИ.Получатель,
				|	ПодписчикиВидыКИ.ПредставлениеПолучателя,
				|	ЕСТЬNULL(КонтактнаяИнформацияТелефон.Представление, """") КАК ПредставлениеТелефон,
				|	ПОДСТРОКА(ЕСТЬNULL(КонтактнаяИнформацияТелефон.ЗначенияПолей, """"), 1, 1024) КАК ЗначениеПолейТелефон,
				|	ЕСТЬNULL(КонтактнаяИнформацияПисьма.Представление, """") КАК ПредставлениеПисьмо,
				|	ПОДСТРОКА(ЕСТЬNULL(КонтактнаяИнформацияПисьма.ЗначенияПолей, """"), 1, 1024) КАК ЗначениеПолейПисьмо
				|ИЗ
				|	ПодписчикиВидыКИ КАК ПодписчикиВидыКИ
				|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Партнеры.КонтактнаяИнформация КАК КонтактнаяИнформацияПисьма
				|		ПО ПодписчикиВидыКИ.Получатель = КонтактнаяИнформацияПисьма.Ссылка
				|			И ПодписчикиВидыКИ.ВидКИДляПисем = КонтактнаяИнформацияПисьма.Вид
				|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Партнеры.КонтактнаяИнформация КАК КонтактнаяИнформацияТелефон
				|		ПО ПодписчикиВидыКИ.Получатель = КонтактнаяИнформацияТелефон.Ссылка
				|			И ПодписчикиВидыКИ.ВидКИДляSMS = КонтактнаяИнформацияТелефон.Вид";
				
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
	ШаблонЗапроса = СтрЗаменить(ШаблонЗапроса, "%ВременнаяТаблицаПодписчики%", ТекстВременнаяТаблицаПодписчики);
	ШаблонЗапроса = СтрЗаменить(ШаблонЗапроса, "%КонтактнаяИнформацияПодписчики%", ТекстКонтактнаяИнформацияПодписчики);
	
КонецПроцедуры

Процедура ОбработатьТекстЗапросаПоКонтактнымЛицамДляОповещений(ШаблонЗапроса, ДанныеВидаОповещения, МассивИсточниковОповещений, ДанныеТипаСобытия, ИтоговыйЗапросСодержитТекст)
	
	Если ДанныеТипаСобытия.ОтправлятьКонтактнымЛицамОбъектаОповещения Тогда
		
		ТекстВременнаяТаблицаВременнаяТаблицаКонтактныеЛицаОповещения = "
		|ВЫБРАТЬ
		|	ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения КАК ИсточникОповещения,
		|	ОчередьСобытийДляОповещенийКлиентам.Подписчик КАК Подписчик,
		|	ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения" + ДанныеТипаСобытия.ПутьККонтактномуЛицу + " КАК КонтактноеЛицоОбъектаОповещения
		|ПОМЕСТИТЬ КонтактныеЛицаОбъектОповещения
		|ИЗ
		|	РегистрСведений.ОчередьСобытийДляОповещенийКлиентам КАК ОчередьСобытийДляОповещенийКлиентам
		|ГДЕ
		|	ОчередьСобытийДляОповещенийКлиентам.ВидОповещения = &ВидОповещения
		|	И ОчередьСобытийДляОповещенийКлиентам.Период < &ДатаОбработки
		|;
		|
		|/////////////////////////////////////////////////////";
		
		Если ДанныеВидаОповещения.Принудительная Тогда
			
			ТекстКонтактнаяИнформацияКонтактныеЛицаОповещения = "
			|ВЫБРАТЬ
			|	КонтактныеЛицаОбъектОповещения.ИсточникОповещения КАК ИсточникОповещения,
			|	КонтактныеЛицаОбъектОповещения.Подписчик,
			|	КонтактныеЛицаОбъектОповещения.КонтактноеЛицоОбъектаОповещения КАК Получатель,
			|	КонтактныеЛицаПартнеров.Наименование КАК ПредставлениеПолучателя,
			|	ЕСТЬNULL(КонтактнаяИнформацияДляSMS.Представление, """") КАК ПредставлениеТелефон,
			|	ПОДСТРОКА(ЕСТЬNULL(КонтактнаяИнформацияДляSMS.ЗначенияПолей, """"), 1, 1024) КАК ЗначениеПолейТелефон,
			|	ЕСТЬNULL(КонтактнаяИнформацияДляПисем.Представление, """") КАК ПредставлениеПисьмо,
			|	ПОДСТРОКА(ЕСТЬNULL(КонтактнаяИнформацияДляПисем.ЗначенияПолей, """"), 1, 1024) КАК ЗначениеПолейПисьмо
			|ИЗ
			|	КонтактныеЛицаОбъектОповещения КАК КонтактныеЛицаОбъектОповещения
			|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров.КонтактнаяИнформация КАК КонтактнаяИнформацияДляПисем
			|		ПО КонтактныеЛицаОбъектОповещения.КонтактноеЛицоОбъектаОповещения = КонтактнаяИнформацияДляПисем.Ссылка
			|			И (КонтактнаяИнформацияДляПисем.Вид = &ВидКИКонтактногоЛицаДляПисем)
			|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров.КонтактнаяИнформация КАК КонтактнаяИнформацияДляSMS
			|		ПО КонтактныеЛицаОбъектОповещения.КонтактноеЛицоОбъектаОповещения = КонтактнаяИнформацияДляSMS.Ссылка
			|			И (КонтактнаяИнформацияДляSMS.Вид = &ВидКИКонтактногоЛицаДляSMS)
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров КАК КонтактныеЛицаПартнеров
			|		ПО КонтактныеЛицаОбъектОповещения.КонтактноеЛицоОбъектаОповещения = КонтактныеЛицаПартнеров.Ссылка";
			
		Иначе
			
			ТекстВременнаяТаблицаВременнаяТаблицаКонтактныеЛицаОповещения = ТекстВременнаяТаблицаВременнаяТаблицаКонтактныеЛицаОповещения + "
			|ВЫБРАТЬ
			|	КонтактныеЛицаОбъектОповещения.ИсточникОповещения КАК ИсточникОповещения,
			|	КонтактныеЛицаОбъектОповещения.Подписчик,
			|	КонтактныеЛицаОбъектОповещения.КонтактноеЛицоОбъектаОповещения КАК Получатель,
			|	КонтактныеЛицаПартнеров.Наименование КАК ПредставлениеПолучателя,
			|	ЕСТЬNULL(ПодпискиНаРассылкиИОповещенияКлиентам.ВидКИКонтактногоЛицаОбъектаОповещенияДляПисем, НЕОПРЕДЕЛЕНО) КАК ВидКИДляПисем,
			|	ЕСТЬNULL(ПодпискиНаРассылкиИОповещенияКлиентам.ВидКИКонтактногоЛицаОбъектаОповещенияДляSMS, НЕОПРЕДЕЛЕНО) КАК ВидКИДляSMS
			|ПОМЕСТИТЬ КонтактныеЛицаОповещенияВидыКИ
			|ИЗ
			|	КонтактныеЛицаОбъектОповещения КАК КонтактныеЛицаОбъектОповещения
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров КАК КонтактныеЛицаПартнеров
			|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПодпискиНаРассылкиИОповещенияКлиентам КАК ПодпискиНаРассылкиИОповещенияКлиентам
			|			ПО (НЕ ПодпискиНаРассылкиИОповещенияКлиентам.ПометкаУдаления)
			|				И (ПодпискиНаРассылкиИОповещенияКлиентам.ПодпискаДействует)
			|				И (ПодпискиНаРассылкиИОповещенияКлиентам.ОтправлятьКонтактномуЛицуОбъектаОповещения)
			|				И (ПодпискиНаРассылкиИОповещенияКлиентам.ГруппаРассылокИОповещений = &ГруппаРассылокИОповещений)
			|				И КонтактныеЛицаПартнеров.Владелец = ПодпискиНаРассылкиИОповещенияКлиентам.Владелец
			|		ПО КонтактныеЛицаОбъектОповещения.КонтактноеЛицоОбъектаОповещения = КонтактныеЛицаПартнеров.Ссылка
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////";
			
			ТекстКонтактнаяИнформацияКонтактныеЛицаОповещения = "
			|ВЫБРАТЬ
			|	КонтактныеЛицаОповещенияВидыКИ.ИсточникОповещения,
			|	КонтактныеЛицаОповещенияВидыКИ.Подписчик,
			|	КонтактныеЛицаОповещенияВидыКИ.Получатель,
			|	КонтактныеЛицаОповещенияВидыКИ.ПредставлениеПолучателя,
			|	ЕСТЬNULL(КонтактнаяИнформацияТелефон.Представление, """") КАК ПредставлениеТелефон,
			|	ПОДСТРОКА(ЕСТЬNULL(КонтактнаяИнформацияТелефон.ЗначенияПолей, """"), 1, 1024) КАК ЗначениеПолейТелефон,
			|	ЕСТЬNULL(КонтактнаяИнформацияПисьма.Представление, """") КАК ПредставлениеПисьмо,
			|	ПОДСТРОКА(ЕСТЬNULL(КонтактнаяИнформацияПисьма.ЗначенияПолей, """"), 1, 1024) КАК ЗначениеПолейПисьмо
			|ИЗ
			|	КонтактныеЛицаОповещенияВидыКИ КАК КонтактныеЛицаОповещенияВидыКИ
			|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров.КонтактнаяИнформация КАК КонтактнаяИнформацияПисьма
			|		ПО КонтактныеЛицаОповещенияВидыКИ.Получатель = КонтактнаяИнформацияПисьма.Ссылка
			|			И КонтактныеЛицаОповещенияВидыКИ.ВидКИДляПисем = КонтактнаяИнформацияПисьма.Вид
			|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров.КонтактнаяИнформация КАК КонтактнаяИнформацияТелефон
			|		ПО КонтактныеЛицаОповещенияВидыКИ.Получатель = КонтактнаяИнформацияТелефон.Ссылка
			|			И КонтактныеЛицаОповещенияВидыКИ.ВидКИДляSMS = КонтактнаяИнформацияТелефон.Вид";
			
		КонецЕсли;
		
	Иначе
		
		ТекстВременнаяТаблицаВременнаяТаблицаКонтактныеЛицаОповещения = "";
		ТекстКонтактнаяИнформацияКонтактныеЛицаОповещения = "";
		
	КонецЕсли;
	
	Если НЕ ПустаяСтрока(ТекстКонтактнаяИнформацияКонтактныеЛицаОповещения) Тогда
		Если ИтоговыйЗапросСодержитТекст Тогда
			ТекстКонтактнаяИнформацияКонтактныеЛицаОповещения = ТекстОбъединить() + ТекстКонтактнаяИнформацияКонтактныеЛицаОповещения;
		КонецЕсли;
		ИтоговыйЗапросСодержитТекст = Истина;
	КонецЕсли;
	
	ШаблонЗапроса = СтрЗаменить(ШаблонЗапроса, "%ВременнаяТаблицаКонтактныеЛицаОповещения%", ТекстВременнаяТаблицаВременнаяТаблицаКонтактныеЛицаОповещения);
	ШаблонЗапроса = СтрЗаменить(ШаблонЗапроса, "%КонтактнаяИнформацияКонтактныхЛицОповещения%", ТекстКонтактнаяИнформацияКонтактныеЛицаОповещения);
	
КонецПроцедуры

Процедура ОбработатьТекстЗапросаПоКонтактнымЛицамПодписчика(ШаблонЗапроса,
	                                                        ДанныеВидаОповещения,
	                                                        ДатаОтработки,
	                                                        ДанныеТипаСобытия,
	                                                        ИтоговыйЗапросСодержитТекст)

	Если ДанныеТипаСобытия.ОтправлятьКонтактнымЛицамПартнера Тогда
		
		Если ДанныеВидаОповещения.Принудительная Тогда
			
			ТекстВременнаяТаблицаКонтактныеЛицаПодписчиков = "
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения,
			|	ОчередьСобытийДляОповещенийКлиентам.Подписчик,
			|	КонтактныеЛицаПартнеров.Ссылка КАК Получатель
			|ПОМЕСТИТЬ КонтактныеЛицаПодписчика
			|ИЗ
			|	РегистрСведений.ОчередьСобытийДляОповещенийКлиентам КАК ОчередьСобытийДляОповещенийКлиентам
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров КАК КонтактныеЛицаПартнеров
			|		ПО ОчередьСобытийДляОповещенийКлиентам.Подписчик = КонтактныеЛицаПартнеров.Владелец
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров.РолиКонтактногоЛица КАК КонтактныеЛицаПартнеровРолиКонтактногоЛица
			|		ПО (КонтактныеЛицаПартнеровРолиКонтактногоЛица.Ссылка = КонтактныеЛицаПартнеров.Ссылка)
			|			И (КонтактныеЛицаПартнеровРолиКонтактногоЛица.РольКонтактногоЛица = &РольКонтактногоЛица)
			|ГДЕ
			|	ОчередьСобытийДляОповещенийКлиентам.ВидОповещения = &ВидОповещения
			|	И ОчередьСобытийДляОповещенийКлиентам.Период < &ДатаОбработки
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////";
			
			ТекстКонтактнаяИнформацияКонтактныеЛицаПодписчиков = "
			|ВЫБРАТЬ
			|	КонтактныеЛицаПодписчика.ИсточникОповещения КАК ИсточникОповещения,
			|	КонтактныеЛицаПодписчика.Подписчик,
			|	КонтактныеЛицаПодписчика.Получатель КАК Получатель,
			|	КонтактныеЛицаПартнеров.Наименование КАК ПредставлениеПолучателя,
			|	ЕСТЬNULL(КонтактнаяИнформацияДляSMS.Представление, """") КАК ПредставлениеТелефон,
			|	ПОДСТРОКА(ЕСТЬNULL(КонтактнаяИнформацияДляSMS.ЗначенияПолей, """"), 1, 1024) КАК ЗначениеПолейТелефон,
			|	ЕСТЬNULL(КонтактнаяИнформацияДляПисем.Представление, """") КАК ПредставлениеПисьмо,
			|	ПОДСТРОКА(ЕСТЬNULL(КонтактнаяИнформацияДляПисем.ЗначенияПолей, """"), 1, 1024) КАК ЗначениеПолейПисьмо
			|ИЗ
			|	КонтактныеЛицаПодписчика КАК КонтактныеЛицаПодписчика
			|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров.КонтактнаяИнформация КАК КонтактнаяИнформацияДляПисем
			|		ПО КонтактныеЛицаПодписчика.Получатель = КонтактнаяИнформацияДляПисем.Ссылка
			|			И (КонтактнаяИнформацияДляПисем.Вид = &ВидКИКонтактногоЛицаДляПисем)
			|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров.КонтактнаяИнформация КАК КонтактнаяИнформацияДляSMS
			|		ПО КонтактныеЛицаПодписчика.Получатель = КонтактнаяИнформацияДляSMS.Ссылка
			|			И (КонтактнаяИнформацияДляSMS.Вид = &ВидКИКонтактногоЛицаДляSMS)
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров КАК КонтактныеЛицаПартнеров
			|		ПО КонтактныеЛицаПодписчика.Получатель = КонтактныеЛицаПартнеров.Ссылка";

		Иначе
			
			ТекстВременнаяТаблицаКонтактныеЛицаПодписчиков = "
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ОчередьСобытийДляОповещенийКлиентам.ИсточникОповещения,
			|	ОчередьСобытийДляОповещенийКлиентам.Подписчик,
			|	ПодпискиНаРассылкиИОповещенияКлиентамКонтактныеЛица.КонтактноеЛицо КАК Получатель,
			|	ПодпискиНаРассылкиИОповещенияКлиентамКонтактныеЛица.ВидКИДляПисем,
			|	ПодпискиНаРассылкиИОповещенияКлиентамКонтактныеЛица.ВидКИДляSMS
			|ПОМЕСТИТЬ КонтактныеЛицаПодписчика
			|ИЗ
			|	РегистрСведений.ОчередьСобытийДляОповещенийКлиентам КАК ОчередьСобытийДляОповещенийКлиентам
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПодпискиНаРассылкиИОповещенияКлиентам КАК ПодпискиНаРассылкиИОповещенияКлиентам
			|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПодпискиНаРассылкиИОповещенияКлиентам.КонтактныеЛица КАК ПодпискиНаРассылкиИОповещенияКлиентамКонтактныеЛица
			|			ПО ПодпискиНаРассылкиИОповещенияКлиентам.Ссылка = ПодпискиНаРассылкиИОповещенияКлиентамКонтактныеЛица.Ссылка
			|		ПО ОчередьСобытийДляОповещенийКлиентам.Подписчик = ПодпискиНаРассылкиИОповещенияКлиентам.Владелец
			|			И (ПодпискиНаРассылкиИОповещенияКлиентам.ГруппаРассылокИОповещений = &ГруппаРассылокИОповещений)
			|			И (НЕ ПодпискиНаРассылкиИОповещенияКлиентам.ПометкаУдаления)
			|			И (ПодпискиНаРассылкиИОповещенияКлиентам.ПодпискаДействует)
			|ГДЕ
			|	ОчередьСобытийДляОповещенийКлиентам.ВидОповещения = &ВидОповещения
			|	И ОчередьСобытийДляОповещенийКлиентам.Период < &ДатаОбработки
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|";
			
			ТекстКонтактнаяИнформацияКонтактныеЛицаПодписчиков = "
			|ВЫБРАТЬ
			|	КонтактныеЛицаПодписчика.ИсточникОповещения КАК ИсточникОповещения,
			|	КонтактныеЛицаПодписчика.Подписчик,
			|	КонтактныеЛицаПодписчика.Получатель КАК Получатель,
			|	КонтактныеЛицаПартнеров.Наименование КАК ПредставлениеПолучателя,
			|	ЕСТЬNULL(КонтактнаяИнформацияДляSMS.Представление, """") КАК ПредставлениеТелефон,
			|	ПОДСТРОКА(ЕСТЬNULL(КонтактнаяИнформацияДляSMS.ЗначенияПолей, """"), 1, 1024) КАК ЗначениеПолейТелефон,
			|	ЕСТЬNULL(КонтактнаяИнформацияДляПисем.Представление, """") КАК ПредставлениеПисьмо,
			|	ПОДСТРОКА(ЕСТЬNULL(КонтактнаяИнформацияДляПисем.ЗначенияПолей, """"), 1, 1024) КАК ЗначениеПолейПисьмо
			|ИЗ
			|	КонтактныеЛицаПодписчика КАК КонтактныеЛицаПодписчика
			|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров.КонтактнаяИнформация КАК КонтактнаяИнформацияДляПисем
			|		ПО КонтактныеЛицаПодписчика.Получатель = КонтактнаяИнформацияДляПисем.Ссылка
			|			И (КонтактнаяИнформацияДляПисем.Вид = КонтактныеЛицаПодписчика.ВидКИДляПисем)
			|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров.КонтактнаяИнформация КАК КонтактнаяИнформацияДляSMS
			|		ПО КонтактныеЛицаПодписчика.Получатель = КонтактнаяИнформацияДляSMS.Ссылка
			|			И (КонтактнаяИнформацияДляSMS.Вид = КонтактныеЛицаПодписчика.ВидКИДляSMS)
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров КАК КонтактныеЛицаПартнеров
			|		ПО КонтактныеЛицаПодписчика.Получатель = КонтактныеЛицаПартнеров.Ссылка";
			
		КонецЕсли;
		
	Иначе
		
		ТекстВременнаяТаблицаКонтактныеЛицаПодписчиков = "";
		ТекстКонтактнаяИнформацияКонтактныеЛицаПодписчиков = "";
		
	КонецЕсли;
	
	Если НЕ ПустаяСтрока(ТекстКонтактнаяИнформацияКонтактныеЛицаПодписчиков) Тогда
		
		Если ИтоговыйЗапросСодержитТекст Тогда
			ТекстКонтактнаяИнформацияКонтактныеЛицаПодписчиков = ТекстОбъединить() + ТекстКонтактнаяИнформацияКонтактныеЛицаПодписчиков;
		КонецЕсли;
		
		ИтоговыйЗапросСодержитТекст = Истина;
		
	КонецЕсли;
	
	ШаблонЗапроса = СтрЗаменить(ШаблонЗапроса, "%ВременнаяТаблицаКонтактныеЛицаПодписчика%", ТекстВременнаяТаблицаКонтактныеЛицаПодписчиков);
	ШаблонЗапроса = СтрЗаменить(ШаблонЗапроса, "%КонтактнаяИнформацияКонтактныхЛицПодписчика%", ТекстКонтактнаяИнформацияКонтактныеЛицаПодписчиков);

КонецПроцедуры

Функция КомментарийДляСообщенияПоОповещению(ДанныеВидаОповещения)

	ТекстКомментария =  НСтр("ru = 'Создано по виду оповещения ""%1""'");
	ТекстКомментария = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстКомментария, ДанныеВидаОповещения.Наименование);
	
	Возврат ТекстКомментария;
	
КонецФункции

#КонецОбласти

#Область СозданиеДокументовПоРассылке

Процедура ОбработатьТекстЗапросаАдресатыРассылки(Данные, Запрос, ЕстьОтборПоКомпоновке)

	Если Данные.Принудительная Тогда
		
		ТекстЗапросаПартнеры       = "";
		ТекстЗапросаКонтактныеЛица = "";
		
		Если Данные.ОтправлятьПартнеру Тогда
			
			ТекстЗапросаПартнеры = "
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ПартнерыКонтактнаяИнформация.Ссылка КАК Партнер,
			|	ПартнерыКонтактнаяИнформация.Ссылка КАК Получатель,
			|	ПартнерыКонтактнаяИнформация.Представление КАК ПредставлениеКонтактнойИнформации,
			|	ВЫБОР
			|		КОГДА &ПредназначенаДляПисем
			|			ТОГДА ПартнерыКонтактнаяИнформация.АдресЭП
			|		ИНАЧЕ ПартнерыКонтактнаяИнформация.НомерТелефона
			|	КОНЕЦ КАК КонтактнаяИнформация,
			|	ПОДСТРОКА(ПартнерыКонтактнаяИнформация.ЗначенияПолей, 1, 1024) КАК ЗначенияПолей,
			|	Партнеры.НаименованиеПолное КАК ПредставлениеПолучателя
			|ИЗ
			|	Справочник.Партнеры.КонтактнаяИнформация КАК ПартнерыКонтактнаяИнформация
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Партнеры КАК Партнеры
			|		ПО ПартнерыКонтактнаяИнформация.Ссылка = Партнеры.Ссылка
			|			И (ПартнерыКонтактнаяИнформация.Вид = &ВидКонтактнойИнформацииПартнера)
			|			И (НЕ Партнеры.ПометкаУдаления)
			|			И &СоединениеПоОтбору";
			
			ОбработатьТекстЗапросаПоПартнерамРассылки(Запрос, ТекстЗапросаПартнеры, Данные, ЕстьОтборПоКомпоновке);
			
		КонецЕсли;
		
		Если Данные.ОтправлятьКонтактнымЛицамРоли Тогда
			
			ТекстЗапросаКонтактныеЛица ="
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	КонтактныеЛицаПартнеров.Владелец КАК Партнер,
			|	КонтактныеЛицаПартнеровКонтактнаяИнформация.Ссылка КАК Получатель,
			|	КонтактныеЛицаПартнеровКонтактнаяИнформация.Представление КАК ПредставлениеКонтактнойИнформации,
			|	ВЫБОР
			|		КОГДА &ПредназначенаДляПисем
			|			ТОГДА КонтактныеЛицаПартнеровКонтактнаяИнформация.АдресЭП
			|		ИНАЧЕ КонтактныеЛицаПартнеровКонтактнаяИнформация.НомерТелефона
			|	КОНЕЦ КАК КонтактнаяИнформация,
			|	ПОДСТРОКА(КонтактныеЛицаПартнеровКонтактнаяИнформация.ЗначенияПолей, 1, 1024) КАК ЗначенияПолей,
			|	КонтактныеЛицаПартнеров.Наименование КАК ПредставлениеПолучателя
			|ИЗ
			|	Справочник.КонтактныеЛицаПартнеров.КонтактнаяИнформация КАК КонтактныеЛицаПартнеровКонтактнаяИнформация
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров КАК КонтактныеЛицаПартнеров
			|		ПО КонтактныеЛицаПартнеровКонтактнаяИнформация.Ссылка = КонтактныеЛицаПартнеров.Ссылка
			|			И (НЕ КонтактныеЛицаПартнеров.ПометкаУдаления)
			|		И &СоединениеПоОтбору
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров.РолиКонтактногоЛица КАК КонтактныеЛицаПартнеровРолиКонтактногоЛица
			|		ПО КонтактныеЛицаПартнеровКонтактнаяИнформация.Ссылка = КонтактныеЛицаПартнеровРолиКонтактногоЛица.Ссылка
			|			И (КонтактныеЛицаПартнеровРолиКонтактногоЛица.РольКонтактногоЛица = &РольКонтактногоЛица)
			|			И (КонтактныеЛицаПартнеровКонтактнаяИнформация.Вид = &ВидКонтактнойИнформацииКонтактногоЛица)
			|		";
			
			ОбработатьТекстЗапросаПоКонтактнымЛицамРассылки(Запрос, ТекстЗапросаКонтактныеЛица, Данные, ЕстьОтборПоКомпоновке);
			Запрос.УстановитьПараметр("РольКонтактногоЛица", Данные.РольКонтактногоЛица);
			
		КонецЕсли;
		
		Если (НЕ Данные.ОтправлятьПартнеру) И (НЕ Данные.ОтправлятьКонтактнымЛицамРоли) Тогда
			Запрос.Текст = "";
		Иначе
			НеобходимТекстОбъединить = Данные.ОтправлятьПартнеру И Данные.ОтправлятьКонтактнымЛицамРоли;
			Запрос.Текст = Запрос.Текст + ТекстЗапросаПартнеры + ?(НеобходимТекстОбъединить, ТекстОбъединить(), "") + ТекстЗапросаКонтактныеЛица;
		КонецЕсли;
		
	Иначе // По подпискам
		
		ТекстЗапросаПодписчики = "
		|ВЫБРАТЬ
		|	ПодпискиНаРассылкиИОповещенияКлиентам.Владелец КАК Партнер,
		|	ПодпискиНаРассылкиИОповещенияКлиентам.Владелец КАК Получатель,
		|	ПартнерыКонтактнаяИнформация.Представление КАК ПредставлениеКонтактнойИнформации,
		|	ВЫБОР
		|		КОГДА &ПредназначенаДляПисем
		|			ТОГДА ПартнерыКонтактнаяИнформация.АдресЭП
		|		ИНАЧЕ ПартнерыКонтактнаяИнформация.НомерТелефона
		|	КОНЕЦ КАК КонтактнаяИнформация,
		|	ПОДСТРОКА(ПартнерыКонтактнаяИнформация.ЗначенияПолей, 1, 1024) КАК ЗначенияПолей,
		|	Партнеры.НаименованиеПолное КАК ПредставлениеПолучателя
		|ИЗ
		|	Справочник.ПодпискиНаРассылкиИОповещенияКлиентам КАК ПодпискиНаРассылкиИОповещенияКлиентам
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Партнеры КАК Партнеры
		|		ПО ПодпискиНаРассылкиИОповещенияКлиентам.Владелец = Партнеры.Ссылка
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Партнеры.КонтактнаяИнформация КАК ПартнерыКонтактнаяИнформация
		|		ПО ПодпискиНаРассылкиИОповещенияКлиентам.Владелец = ПартнерыКонтактнаяИнформация.Ссылка
		|			И (ВЫБОР
		|				КОГДА &ПредназначенаДляПисем
		|					ТОГДА ПодпискиНаРассылкиИОповещенияКлиентам.ВидКИПартнераДляПисем = ПартнерыКонтактнаяИнформация.Вид
		|				ИНАЧЕ ПодпискиНаРассылкиИОповещенияКлиентам.ВидКИПартнераДляSMS = ПартнерыКонтактнаяИнформация.Вид
		|			КОНЕЦ)
		|		И &СоединениеПоОтбору
		|ГДЕ
		|	ПодпискиНаРассылкиИОповещенияКлиентам.ПодпискаДействует
		|	И ПодпискиНаРассылкиИОповещенияКлиентам.ОтправлятьПартнеру
		|	И НЕ ПодпискиНаРассылкиИОповещенияКлиентам.ПометкаУдаления
		|	И ПодпискиНаРассылкиИОповещенияКлиентам.ГруппаРассылокИОповещений = &ГруппаРассылокИОповещений
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	КонтактныеЛицаПартнеров.Владелец КАК Партнер,
		|	ПодпискиНаРассылкиИОповещенияКлиентамКонтактныеЛица.КонтактноеЛицо КАК Получатель,
		|	КонтактныеЛицаПартнеровКонтактнаяИнформация.Представление КАК ПредставлениеКонтактнойИнформации,
		|	ВЫБОР
		|		КОГДА &ПредназначенаДляПисем
		|			ТОГДА КонтактныеЛицаПартнеровКонтактнаяИнформация.АдресЭП
		|		ИНАЧЕ КонтактныеЛицаПартнеровКонтактнаяИнформация.НомерТелефона
		|	КОНЕЦ КАК КонтактнаяИнформация,
		|	ПОДСТРОКА(КонтактныеЛицаПартнеровКонтактнаяИнформация.ЗначенияПолей, 1, 1024),
		|	КонтактныеЛицаПартнеров.Наименование
		|ИЗ
		|	Справочник.ПодпискиНаРассылкиИОповещенияКлиентам.КонтактныеЛица КАК ПодпискиНаРассылкиИОповещенияКлиентамКонтактныеЛица
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПодпискиНаРассылкиИОповещенияКлиентам КАК ПодпискиНаРассылкиИОповещенияКлиентам
		|		ПО ПодпискиНаРассылкиИОповещенияКлиентамКонтактныеЛица.Ссылка = ПодпискиНаРассылкиИОповещенияКлиентам.Ссылка
		|		И &СоединениеПоОтбору
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров.КонтактнаяИнформация КАК КонтактныеЛицаПартнеровКонтактнаяИнформация
		|		ПО ПодпискиНаРассылкиИОповещенияКлиентамКонтактныеЛица.КонтактноеЛицо = КонтактныеЛицаПартнеровКонтактнаяИнформация.Ссылка
		|			И (ВЫБОР
		|				КОГДА &ПредназначенаДляПисем
		|					ТОГДА ПодпискиНаРассылкиИОповещенияКлиентамКонтактныеЛица.ВидКИДляПисем = КонтактныеЛицаПартнеровКонтактнаяИнформация.Вид
		|				ИНАЧЕ ПодпискиНаРассылкиИОповещенияКлиентамКонтактныеЛица.ВидКИДляSMS = КонтактныеЛицаПартнеровКонтактнаяИнформация.Вид
		|			КОНЕЦ)
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров КАК КонтактныеЛицаПартнеров
		|		ПО ПодпискиНаРассылкиИОповещенияКлиентамКонтактныеЛица.КонтактноеЛицо = КонтактныеЛицаПартнеров.Ссылка
		|ГДЕ
		|	НЕ ПодпискиНаРассылкиИОповещенияКлиентам.ПометкаУдаления
		|	И ПодпискиНаРассылкиИОповещенияКлиентам.ПодпискаДействует
		|	И ПодпискиНаРассылкиИОповещенияКлиентам.ГруппаРассылокИОповещений = &ГруппаРассылокИОповещений";
		
		Запрос.УстановитьПараметр("ГруппаРассылокИОповещений", Данные.ГруппаРассылокИОповещений);
		
		Если ЕстьОтборПоКомпоновке Тогда
			ТекстСоединениеПоОтбору ="ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПартнеров КАК ОтборПартнеров
			                         |ПО ПодпискиНаРассылкиИОповещенияКлиентам.Владелец = ОтборПартнеров.Партнер";
		Иначе
			ТекстСоединениеПоОтборуПартнеры = "";
		КонецЕсли;
		
		ТекстЗапросаПодписчики = СтрЗаменить(ТекстЗапросаПодписчики, "И &СоединениеПоОтбору", ТекстСоединениеПоОтбору);
		Запрос.Текст = Запрос.Текст + ТекстЗапросаПодписчики;
		
	КонецЕсли;

КонецПроцедуры

// Добавляет при необходимости в текст запроса по партнерам рассылки соединение с временной таблицей отбора
//  и устанавливает значение параметра ВидКонтактнойИнформацииПартнера.
//
// Параметры:
//  Запрос                - Запрос - запрос, который формируется динамически.
//  ТекстЗапроса          - Строка - текст запроса, который будет обработан.
//  Данные                - Структура - содержит в себе реквизиты документа "Рассылка клиентам".
//  ЕстьОтборПоКомпоновке - Булево - признак того, что отбор по партнерам установлен.
//
Процедура ОбработатьТекстЗапросаПоПартнерамРассылки(Запрос, ТекстЗапроса, Данные, ЕстьОтборПоКомпоновке) Экспорт
	
	Если ЕстьОтборПоКомпоновке Тогда
		ТекстСоединениеПоОтбору ="ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПартнеров КАК ОтборПартнеров
		|ПО ПартнерыКонтактнаяИнформация.Ссылка = ОтборПартнеров.Партнер";
	Иначе
		ТекстСоединениеПоОтбору = "";
	КонецЕсли;
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "И &СоединениеПоОтбору", ТекстСоединениеПоОтбору);
	
	Запрос.УстановитьПараметр("ВидКонтактнойИнформацииПартнера",
	?(Данные.ПредназначенаДляЭлектронныхПисем,
	Данные.ВидКонтактнойИнформацииПартнераДляПисем,
	Данные.ВидКонтактнойИнформацииПартнераДляSMS));
	
КонецПроцедуры

// Добавляет при необходимости в текст запроса по контактным лицам рассылки соединение с временной таблицей отбора
//  и устанавливает значение параметра ВидКонтактнойИнформацииКонтактногоЛица.
//
// Параметры:
//  Запрос                - Запрос - запрос, который формируется динамически.
//  ТекстЗапроса          - Строка - текст запроса, который будет обработан.
//  Данные                - Структура - содержит в себе реквизиты документа "Рассылка клиентам".
//  ЕстьОтборПоКомпоновке - Булево - признак того, что отбор по партнерам установлен.
//
Процедура ОбработатьТекстЗапросаПоКонтактнымЛицамРассылки(Запрос, ТекстЗапроса, Данные, ЕстьОтборПоКомпоновке) Экспорт

	Если ЕстьОтборПоКомпоновке Тогда
		ТекстСоединениеПоОтбору ="ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПартнеров КАК ОтборПартнеров
		|ПО КонтактныеЛицаПартнеров.Владелец = ОтборПартнеров.Партнер";
	Иначе
		ТекстСоединениеПоОтбору = "";
	КонецЕсли;
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "И &СоединениеПоОтбору", ТекстСоединениеПоОтбору);
	
	Запрос.УстановитьПараметр("ВидКонтактнойИнформацииКонтактногоЛица",
	?(Данные.ПредназначенаДляЭлектронныхПисем,
	Данные.ВидКонтактнойИнформацииКонтактногоЛицаДляПисем,
	Данные.ВидКонтактнойИнформацииКонтактногоЛицаДляSMS));

КонецПроцедуры

Процедура ОбработатьТекстЗапросаАдресатыРассылкиНазначениеОпросов(Данные, ДанныеОснования, Запрос, ЕстьОтборПоКомпоновке)
	
	Если Данные.Принудительная Тогда
		
		Если ТипЗнч(ДанныеОснования.ТипРеспондентов) = Тип("СправочникСсылка.Партнеры") И Данные.ОтправлятьПартнеру Тогда
			
			Если ДанныеОснования.СвободныйОпрос Тогда
				
				ТекстЗапросаРеспонденты = "
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	ПартнерыКонтактнаяИнформация.Ссылка КАК Партнер,
				|	ПартнерыКонтактнаяИнформация.Ссылка КАК Получатель,
				|	ПартнерыКонтактнаяИнформация.Представление КАК ПредставлениеКонтактнойИнформации,
				|	ВЫБОР
				|		КОГДА &ПредназначенаДляПисем
				|			ТОГДА ПартнерыКонтактнаяИнформация.АдресЭП
				|		ИНАЧЕ ПартнерыКонтактнаяИнформация.НомерТелефона
				|	КОНЕЦ КАК КонтактнаяИнформация,
				|	ПОДСТРОКА(ПартнерыКонтактнаяИнформация.ЗначенияПолей, 1, 1024) КАК ЗначенияПолей,
				|	Партнеры.НаименованиеПолное КАК ПредставлениеПолучателя
				|ИЗ
				|	Справочник.Партнеры.КонтактнаяИнформация КАК ПартнерыКонтактнаяИнформация
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Партнеры КАК Партнеры
				|		ПО ПартнерыКонтактнаяИнформация.Ссылка = Партнеры.Ссылка
				|			И (ПартнерыКонтактнаяИнформация.Вид = &ВидКонтактнойИнформацииПартнера)
				|			И (НЕ Партнеры.ПометкаУдаления)
				|		И &СоединениеПоОтбору";
				
			Иначе
				
				ТекстЗапросаРеспонденты = "
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	НазначениеОпросовРеспонденты.Респондент КАК Партнер,
				|	НазначениеОпросовРеспонденты.Респондент КАК Получатель,
				|	ПартнерыКонтактнаяИнформация.Представление КАК ПредставлениеКонтактнойИнформации,
				|	ВЫБОР
				|		КОГДА &ПредназначенаДляПисем
				|			ТОГДА ПартнерыКонтактнаяИнформация.АдресЭП
				|		ИНАЧЕ ПартнерыКонтактнаяИнформация.НомерТелефона
				|	КОНЕЦ КАК КонтактнаяИнформация,
				|	ПОДСТРОКА(ПартнерыКонтактнаяИнформация.ЗначенияПолей, 1, 1024) КАК ЗначенияПолей,
				|	Партнеры.НаименованиеПолное КАК ПредставлениеПолучателя
				|ИЗ
				|	Документ.НазначениеОпросов.Респонденты КАК НазначениеОпросовРеспонденты
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Партнеры.КонтактнаяИнформация КАК ПартнерыКонтактнаяИнформация
				|		ПО НазначениеОпросовРеспонденты.Респондент = ПартнерыКонтактнаяИнформация.Ссылка
				|			И (ПартнерыКонтактнаяИнформация.Вид = &ВидКонтактнойИнформацииПартнера)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Партнеры КАК Партнеры
				|		ПО НазначениеОпросовРеспонденты.Респондент = Партнеры.Ссылка
				|		И &СоединениеПоОтбору
				|ГДЕ
				|	НазначениеОпросовРеспонденты.Ссылка = &НазначениеОпросов"
				
			КонецЕсли;
			
			ОбработатьТекстЗапросаПоПартнерамРассылки(Запрос, ТекстЗапросаРеспонденты, Данные, ЕстьОтборПоКомпоновке);
			
		ИначеЕсли ТипЗнч(ДанныеОснования.ТипРеспондентов) = Тип("СправочникСсылка.КонтактныеЛицаПартнеров") И Данные.ОтправлятьКонтактномуЛицуОбъектаОповещения Тогда
			
			Если ДанныеОснования.СвободныйОпрос Тогда
				
				ТекстЗапросаРеспонденты ="
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	КонтактныеЛицаПартнеров.Владелец КАК Партнер,
				|	КонтактныеЛицаПартнеровКонтактнаяИнформация.Ссылка КАК Получатель,
				|	КонтактныеЛицаПартнеровКонтактнаяИнформация.Представление КАК ПредставлениеКонтактнойИнформации,
				|	ВЫБОР
				|		КОГДА &ПредназначенаДляПисем
				|			ТОГДА КонтактныеЛицаПартнеровКонтактнаяИнформация.АдресЭП
				|		ИНАЧЕ КонтактныеЛицаПартнеровКонтактнаяИнформация.НомерТелефона
				|	КОНЕЦ КАК КонтактнаяИнформация,
				|	ПОДСТРОКА(КонтактныеЛицаПартнеровКонтактнаяИнформация.ЗначенияПолей, 1, 1024) КАК ЗначенияПолей,
				|	КонтактныеЛицаПартнеров.Наименование КАК ПредставлениеПолучателя
				|ИЗ
				|	Справочник.КонтактныеЛицаПартнеров.КонтактнаяИнформация КАК КонтактныеЛицаПартнеровКонтактнаяИнформация
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров КАК КонтактныеЛицаПартнеров
				|		ПО КонтактныеЛицаПартнеровКонтактнаяИнформация.Ссылка = КонтактныеЛицаПартнеров.Ссылка
				|			И (КонтактныеЛицаПартнеровКонтактнаяИнформация.Вид = &ВидКонтактнойИнформацииКонтактногоЛица)
				|			И (НЕ КонтактныеЛицаПартнеров.ПометкаУдаления)
				|		И &СоединениеПоОтбору
				|";
				
			Иначе
				
				ТекстЗапросаРеспонденты = "
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	Партнеры.Ссылка КАК Партнер,
				|	НазначениеОпросовРеспонденты.Респондент КАК Получатель,
				|	КонтактныеЛицаПартнеровКонтактнаяИнформация.Представление КАК ПредставлениеКонтактнойИнформации,
				|	ВЫБОР
				|		КОГДА &ПредназначенаДляПисем
				|			ТОГДА КонтактныеЛицаПартнеровКонтактнаяИнформация.АдресЭП
				|		ИНАЧЕ КонтактныеЛицаПартнеровКонтактнаяИнформация.НомерТелефона
				|	КОНЕЦ КАК КонтактнаяИнформация,
				|	ПОДСТРОКА(КонтактныеЛицаПартнеровКонтактнаяИнформация.ЗначенияПолей, 1, 1024) КАК ЗначенияПолей,
				|	КонтактныеЛицаПартнеров.Наименование КАК ПредставлениеПолучателя
				|ИЗ
				|	Документ.НазначениеОпросов.Респонденты КАК НазначениеОпросовРеспонденты
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров.КонтактнаяИнформация КАК КонтактныеЛицаПартнеровКонтактнаяИнформация
				|		ПО НазначениеОпросовРеспонденты.Респондент = КонтактныеЛицаПартнеровКонтактнаяИнформация.Ссылка
				|			И (КонтактныеЛицаПартнеровКонтактнаяИнформация.Вид = &ВидКонтактнойИнформацииКонтактногоЛица)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров КАК КонтактныеЛицаПартнеров
				|		ПО КонтактныеЛицаПартнеровКонтактнаяИнформация.Ссылка = КонтактныеЛицаПартнеров.Ссылка
				|		И &СоединениеПоОтбору
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Партнеры КАК Партнеры
				|		ПО КонтактныеЛицаПартнеров.Владелец = Партнеры.Ссылка
				|ГДЕ
				|	НазначениеОпросовРеспонденты.Ссылка = &НазначениеОпросов";
				
			КонецЕсли;
			
			ОбработатьТекстЗапросаПоКонтактнымЛицамРассылки(Запрос, ТекстЗапросаРеспонденты, Данные, ЕстьОтборПоКомпоновке);
			
		КонецЕсли;
		
	Иначе
		
		Запрос.УстановитьПараметр("ГруппаРассылокИОповещений", Данные.ГруппаРассылокИОповещений);
		
		Если ТипЗнч(ДанныеОснования.ТипРеспондентов) = Тип("СправочникСсылка.Партнеры")  Тогда
			
			Если ДанныеОснования.СвободныйОпрос Тогда
				
				ТекстЗапросаРеспонденты = "
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	ПодпискиНаРассылкиИОповещенияКлиентам.Владелец КАК Партнер,
				|	ПодпискиНаРассылкиИОповещенияКлиентам.Владелец КАК Получатель,
				|	ПартнерыКонтактнаяИнформация.Представление КАК ПредставлениеКонтактнойИнформации,
				|	ВЫБОР
				|		КОГДА &ПредназначенаДляПисем
				|			ТОГДА ПартнерыКонтактнаяИнформация.АдресЭП
				|		ИНАЧЕ ПартнерыКонтактнаяИнформация.НомерТелефона
				|	КОНЕЦ КАК КонтактнаяИнформация,
				|	ПОДСТРОКА(ПартнерыКонтактнаяИнформация.ЗначенияПолей, 1, 1024) КАК ЗначенияПолей,
				|	Партнеры.НаименованиеПолное КАК ПредставлениеПолучателя
				|ИЗ
				|	Справочник.ПодпискиНаРассылкиИОповещенияКлиентам КАК ПодпискиНаРассылкиИОповещенияКлиентам
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Партнеры КАК Партнеры
				|		ПО ПодпискиНаРассылкиИОповещенияКлиентам.Владелец = Партнеры.Ссылка
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Партнеры.КонтактнаяИнформация КАК ПартнерыКонтактнаяИнформация
				|		ПО ПодпискиНаРассылкиИОповещенияКлиентам.Владелец = ПартнерыКонтактнаяИнформация.Ссылка
				|			И (ВЫБОР
				|				КОГДА &ПредназначенаДляПисем
				|					ТОГДА ПодпискиНаРассылкиИОповещенияКлиентам.ВидКИПартнераДляПисем = ПартнерыКонтактнаяИнформация.Вид
				|				ИНАЧЕ ПодпискиНаРассылкиИОповещенияКлиентам.ВидКИПартнераДляSMS = ПартнерыКонтактнаяИнформация.Вид
				|			КОНЕЦ)
				|		И &СоединениеПоОтбору
				|ГДЕ
				|	ПодпискиНаРассылкиИОповещенияКлиентам.ПодпискаДействует
				|	И ПодпискиНаРассылкиИОповещенияКлиентам.ОтправлятьПартнеру
				|	И НЕ ПодпискиНаРассылкиИОповещенияКлиентам.ПометкаУдаления
				|	И ПодпискиНаРассылкиИОповещенияКлиентам.ГруппаРассылокИОповещений = &ГруппаРассылокИОповещений";
				
			Иначе
				
				ТекстЗапросаРеспонденты = "
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	НазначениеОпросовРеспонденты.Респондент КАК Партнер,
				|	НазначениеОпросовРеспонденты.Респондент КАК Получатель,
				|	ПартнерыКонтактнаяИнформация.Представление КАК ПредставлениеКонтактнойИнформации,
				|	ВЫБОР
				|		КОГДА &ПредназначенаДляПисем
				|			ТОГДА ПартнерыКонтактнаяИнформация.АдресЭП
				|		ИНАЧЕ ПартнерыКонтактнаяИнформация.НомерТелефона
				|	КОНЕЦ КАК КонтактнаяИнформация,
				|	ПОДСТРОКА(ПартнерыКонтактнаяИнформация.ЗначенияПолей, 1, 1024) КАК ЗначенияПолей,
				|	Партнеры.НаименованиеПолное КАК ПредставлениеПолучателя
				|ИЗ
				|	Документ.НазначениеОпросов.Респонденты КАК НазначениеОпросовРеспонденты
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПодпискиНаРассылкиИОповещенияКлиентам КАК ПодпискиНаРассылкиИОповещенияКлиентам
				|			ПО НазначениеОпросовРеспонденты.Респондент = ПодпискиНаРассылкиИОповещенияКлиентам.Владелец
				|				И ПодпискиНаРассылкиИОповещенияКлиентам.ПодпискаДействует
				|				И ПодпискиНаРассылкиИОповещенияКлиентам.ОтправлятьПартнеру
				|				И НЕ ПодпискиНаРассылкиИОповещенияКлиентам.ПометкаУдаления
				|				И ПодпискиНаРассылкиИОповещенияКлиентам.ГруппаРассылокИОповещений = &ГруппаРассылокИОповещений			
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Партнеры.КонтактнаяИнформация КАК ПартнерыКонтактнаяИнформация
				|		ПО НазначениеОпросовРеспонденты.Респондент = ПартнерыКонтактнаяИнформация.Ссылка
				|			И (ВЫБОР
				|				КОГДА &ПредназначенаДляПисем
				|					ТОГДА ПодпискиНаРассылкиИОповещенияКлиентам.ВидКИПартнераДляПисем = ПартнерыКонтактнаяИнформация.Вид
				|				ИНАЧЕ ПодпискиНаРассылкиИОповещенияКлиентам.ВидКИПартнераДляSMS = ПартнерыКонтактнаяИнформация.Вид
				|			КОНЕЦ)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Партнеры КАК Партнеры
				|		ПО НазначениеОпросовРеспонденты.Респондент = Партнеры.Ссылка
				|		И &СоединениеПоОтбору
				|ГДЕ
				|	НазначениеОпросовРеспонденты.Ссылка = &НазначениеОпросов"
				
			КонецЕсли;
			
			ОбработатьТекстЗапросаПоПартнерамРассылки(Запрос, ТекстЗапросаРеспонденты, Данные, ЕстьОтборПоКомпоновке);
			
		ИначеЕсли ТипЗнч(ДанныеОснования.ТипРеспондентов) = Тип("СправочникСсылка.КонтактныеЛицаПартнеров") Тогда
			
			Если ДанныеОснования.СвободныйОпрос Тогда
				
				ТекстЗапросаРеспонденты = "
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	СправочникПартнеры.Ссылка КАК Партнер,
				|	КонтактныеЛицаПартнеров.Ссылка КАК Получатель,
				|	КонтактныеЛицаПартнеровКонтактнаяИнформация.Представление КАК ПредставлениеКонтактнойИнформации,
				|	ВЫБОР
				|		КОГДА &ПредназначенаДляПисем
				|			ТОГДА КонтактныеЛицаПартнеровКонтактнаяИнформация.АдресЭП
				|		ИНАЧЕ КонтактныеЛицаПартнеровКонтактнаяИнформация.НомерТелефона
				|	КОНЕЦ КАК КонтактнаяИнформация,
				|	ПОДСТРОКА(КонтактныеЛицаПартнеровКонтактнаяИнформация.ЗначенияПолей, 1, 1024) КАК ЗначенияПолей,
				|	КонтактныеЛицаПартнеров.Наименование КАК ПредставлениеПолучателя
				|ИЗ
				|	Справочник.ПодпискиНаРассылкиИОповещенияКлиентам КАК ПодпискиНаРассылкиИОповещенияКлиентам
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Партнеры КАК СправочникПартнеры
				|		ПО ПодпискиНаРассылкиИОповещенияКлиентам.Владелец = СправочникПартнеры.Ссылка
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров КАК КонтактныеЛицаПартнеров
				|		ПО (СправочникПартнеры.Ссылка = КонтактныеЛицаПартнеров.Владелец)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров.КонтактнаяИнформация КАК КонтактныеЛицаПартнеровКонтактнаяИнформация
				|		ПО (КонтактныеЛицаПартнеров.Ссылка = КонтактныеЛицаПартнеровКонтактнаяИнформация.Ссылка)
				|			И (ВЫБОР
				|				КОГДА &ПредназначенаДляПисем
				|					ТОГДА ПодпискиНаРассылкиИОповещенияКлиентам.ВидКИКонтактногоЛицаОбъектаОповещенияДляПисем = КонтактныеЛицаПартнеровКонтактнаяИнформация.Вид
				|				ИНАЧЕ ПодпискиНаРассылкиИОповещенияКлиентам.ВидКИКонтактногоЛицаОбъектаОповещенияДляSMS = КонтактныеЛицаПартнеровКонтактнаяИнформация.Вид
				|			КОНЕЦ)
				|		И &СоединениеПоОтбору
				|ГДЕ
				|	НЕ ПодпискиНаРассылкиИОповещенияКлиентам.ПометкаУдаления
				|	И ПодпискиНаРассылкиИОповещенияКлиентам.ПодпискаДействует
				|	И ПодпискиНаРассылкиИОповещенияКлиентам.ОтправлятьКонтактномуЛицуОбъектаОповещения
				|	И ПодпискиНаРассылкиИОповещенияКлиентам.ГруппаРассылокИОповещений = &ГруппаРассылокИОповещений";

			Иначе
				
				ТекстЗапросаРеспонденты = "
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	НазначениеОпросовРеспонденты.Респондент КАК Партнер,
				|	НазначениеОпросовРеспонденты.Респондент КАК Получатель,
				|	КонтактныеЛицаПартнеровКонтактнаяИнформация.Представление КАК ПредставлениеКонтактнойИнформации,
				|	ВЫБОР
				|		КОГДА &ПредназначенаДляПисем
				|			ТОГДА КонтактныеЛицаПартнеровКонтактнаяИнформация.АдресЭП
				|		ИНАЧЕ КонтактныеЛицаПартнеровКонтактнаяИнформация.НомерТелефона
				|	КОНЕЦ КАК КонтактнаяИнформация,
				|	ПОДСТРОКА(КонтактныеЛицаПартнеровКонтактнаяИнформация.ЗначенияПолей, 1, 1024) КАК ЗначенияПолей,
				|	КонтактныеЛицаПартнеров.Наименование КАК ПредставлениеПолучателя
				|ИЗ
				|	Документ.НазначениеОпросов.Респонденты КАК НазначениеОпросовРеспонденты
				|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров КАК КонтактныеЛицаПартнеров
				|		ПО НазначениеОпросовРеспонденты.Респондент = КонтактныеЛицаПартнеров.Ссылка
				|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Партнеры КАК Партнеры
				|		ПО КонтактныеЛицаПартнеров.Владелец = Партнеры.Ссылка
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПодпискиНаРассылкиИОповещенияКлиентам КАК ПодпискиНаРассылкиИОповещенияКлиентам
				|			ПО Партнеры.Ссылка = ПодпискиНаРассылкиИОповещенияКлиентам.Владелец
				|				И ПодпискиНаРассылкиИОповещенияКлиентам.ПодпискаДействует
				|				И ПодпискиНаРассылкиИОповещенияКлиентам.ОтправлятьКонтактномуЛицуОбъектаОповещения
				|				И НЕ ПодпискиНаРассылкиИОповещенияКлиентам.ПометкаУдаления
				|				И ПодпискиНаРассылкиИОповещенияКлиентам.ГруппаРассылокИОповещений = &ГруппаРассылокИОповещений			
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров.КонтактнаяИнформация КАК КонтактныеЛицаПартнеровКонтактнаяИнформация
				|		ПО КонтактныеЛицаПартнеров.Ссылка = КонтактныеЛицаПартнеровКонтактнаяИнформация.Ссылка
				|			И (ВЫБОР
				|				КОГДА &ПредназначенаДляПисем
				|					ТОГДА ПодпискиНаРассылкиИОповещенияКлиентам.ВидКИКонтактногоЛицаОбъектаОповещенияДляПисем = КонтактныеЛицаПартнеровКонтактнаяИнформация.Вид
				|				ИНАЧЕ ПодпискиНаРассылкиИОповещенияКлиентам.ВидКИКонтактногоЛицаОбъектаОповещенияДляSMS = КонтактныеЛицаПартнеровКонтактнаяИнформация.Вид
				|			КОНЕЦ)
				|		И &СоединениеПоОтбору
				|ГДЕ
				|	НазначениеОпросовРеспонденты.Ссылка = &НазначениеОпросов"
				
			КонецЕсли;
			
			ОбработатьТекстЗапросаПоКонтактнымЛицамРассылки(Запрос, ТекстЗапросаРеспонденты, Данные, ЕстьОтборПоКомпоновке);

		КонецЕсли;
		
	КонецЕсли;
	
	Запрос.Текст = Запрос.Текст + ТекстЗапросаРеспонденты;
	Запрос.УстановитьПараметр("НазначениеОпросов", ДанныеОснования.Ссылка); 
	
КонецПроцедуры

Функция ВыборкаАдресатовРассылки(Данные, ДанныеОснования)
	
	УстановленОтборПоОснованию = Ложь;
	Запрос = ЗапросОтборПоКомпоновке(Данные, УстановленОтборПоОснованию);
	ТекстЗапросаОтборПоКомпоновке = Запрос.Текст;
	
	ЕстьОтборПоКомпоновке = Не ПустаяСтрока(Запрос.Текст);
	
	Если ДанныеОснования <> Неопределено И УстановленОтборПоОснованию Тогда
		
		Если ТипЗнч(ДанныеОснования.Ссылка) = Тип("ДокументСсылка.НазначениеОпросов") Тогда
			
			ОбработатьТекстЗапросаАдресатыРассылкиНазначениеОпросов(Данные, ДанныеОснования, Запрос, ЕстьОтборПоКомпоновке);
			
		КонецЕсли;
		
	Иначе
		
		ОбработатьТекстЗапросаАдресатыРассылки(Данные, Запрос, ЕстьОтборПоКомпоновке);
		
	КонецЕсли;
	
	Если Запрос.Текст = ТекстЗапросаОтборПоКомпоновке Тогда
		Запрос.Текст = "";
	КонецЕсли;
	
	
	ТекстЗапросаДополнительныеПолучатели = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВЫБОР
	|		КОГДА РассылкаКлиентамДополнительныеПолучатели.Контакт ССЫЛКА Справочник.Партнеры
	|			ТОГДА Партнеры.Ссылка
	|		ИНАЧЕ КонтактныеЛицаПартнеров.Владелец
	|	КОНЕЦ КАК Партнер,
	|	РассылкаКлиентамДополнительныеПолучатели.Контакт КАК Получатель,
	|	РассылкаКлиентамДополнительныеПолучатели.КонтактнаяИнформация КАК ПредставлениеКонтактнойИнформации,
	|	РассылкаКлиентамДополнительныеПолучатели.КонтактнаяИнформация КАК КонтактнаяИнформация,
	|	"""" КАК ЗначенияПолей,
	|	ВЫБОР
	|		КОГДА РассылкаКлиентамДополнительныеПолучатели.Контакт ССЫЛКА Справочник.Партнеры
	|			ТОГДА ЕСТЬNULL(Партнеры.НаименованиеПолное, """")
	|		ИНАЧЕ ЕСТЬNULL(КонтактныеЛицаПартнеров.Наименование, """")
	|	КОНЕЦ КАК ПредставлениеПолучателя
	|ИЗ
	|	Документ.РассылкаКлиентам.ДополнительныеПолучатели КАК РассылкаКлиентамДополнительныеПолучатели
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Партнеры КАК Партнеры
	|		ПО РассылкаКлиентамДополнительныеПолучатели.Контакт = Партнеры.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров КАК КонтактныеЛицаПартнеров
	|		ПО РассылкаКлиентамДополнительныеПолучатели.Контакт = КонтактныеЛицаПартнеров.Ссылка
	|ГДЕ
	|	РассылкаКлиентамДополнительныеПолучатели.Ссылка = &РассылкаКлиентам
	|ИТОГИ ПО
	|	Партнер,
	|   Получатель";
	
	Запрос.УстановитьПараметр("ПредназначенаДляПисем", Данные.ПредназначенаДляЭлектронныхПисем);
	Запрос.УстановитьПараметр("РассылкаКлиентам", Данные.Ссылка);
	
	Запрос.Текст = Запрос.Текст + ?(ПустаяСтрока(Запрос.Текст), "", ТекстОбъединить()) + ТекстЗапросаДополнительныеПолучатели;
	
	Возврат Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
КонецФункции 

Процедура СоздатьПисьмаДляРассылки(Данные, ВыборкаАдресатовРассылки, МассивСозданныхВзаимодействий, ДанныеОснования)
	
	РассылкаПерсонализирована = РассылкаПерсонализирована(Данные);
	АдресатыАдреса = Новый Соответствие;
	МассивАдресатовРассылки = Новый Массив;
	
	Пока ВыборкаАдресатовРассылки.Следующий() Цикл
		
		Если Не РассылкаПерсонализирована Тогда
			МассивАдресатовРассылки.Очистить();
		КонецЕсли;
		
		ВыборкаПолучатель = ВыборкаАдресатовРассылки.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаПолучатель.Следующий() Цикл
			
			Если РассылкаПерсонализирована Тогда
				МассивАдресатовРассылки.Очистить();
			КонецЕсли;
		
			ВыборкаДетали = ВыборкаПолучатель.Выбрать();
			Пока ВыборкаДетали.Следующий() Цикл
				
				МассивАдресатовРассылки.Добавить(ДанныеАдресатаПоВыборке(ВыборкаДетали));
				
			КонецЦикла;
			
			Если РассылкаПерсонализирована Тогда
				СоздатьПисьмоДляАдресатаРассылки(Данные, МассивАдресатовРассылки, АдресатыАдреса,
				                                 РассылкаПерсонализирована, МассивСозданныхВзаимодействий, ДанныеОснования);
			КонецЕсли;
			
		КонецЦикла;
		
		Если Не РассылкаПерсонализирована Тогда
			СоздатьПисьмоДляАдресатаРассылки(Данные, МассивАдресатовРассылки, АдресатыАдреса,
			                                 РассылкаПерсонализирована, МассивСозданныхВзаимодействий, ДанныеОснования);
		КонецЕсли;
		
	КонецЦикла;
	
	Если МассивСозданныхВзаимодействий.Количество() > 0 Тогда
		Взаимодействия.УстановитьПапкиДляМассиваПисем(МассивСозданныхВзаимодействий);
	КонецЕсли;
	
КонецПроцедуры

Функция ДанныеАдресатаПоВыборке(Выборка)
	
	ДанныеАдресата = Новый Структура;
	ДанныеАдресата.Вставить("ЗначенияПолей",                     Выборка.ЗначенияПолей);
	ДанныеАдресата.Вставить("КонтактнаяИнформация",              Выборка.КонтактнаяИнформация);
	ДанныеАдресата.Вставить("Партнер",                           Выборка.Партнер);
	ДанныеАдресата.Вставить("Получатель",                        Выборка.Получатель);
	ДанныеАдресата.Вставить("ПредставлениеКонтактнойИнформации", Выборка.ПредставлениеКонтактнойИнформации);
	ДанныеАдресата.Вставить("ПредставлениеПолучателя",           Выборка.ПредставлениеПолучателя);
	
	Возврат ДанныеАдресата;
	
КонецФункции

Функция УжеОтравлялосьНаДанныйАдрес(АдресатРассылки, АдресатыАдреса)
	
	МассивАдресов = АдресатыАдреса.Получить(АдресатРассылки.Получатель);
	Если МассивАдресов = Неопределено Тогда
		
		МассивАдресов = Новый Массив;
		МассивАдресов.Добавить(АдресатРассылки.КонтактнаяИнформация);
		АдресатыАдреса.Вставить(АдресатРассылки.Получатель, МассивАдресов);
		
	Иначе
		Если МассивАдресов.Найти(АдресатРассылки.КонтактнаяИнформация) = Неопределено Тогда
			МассивАдресов.Добавить(АдресатРассылки.КонтактнаяИнформация);
		Иначе
			Возврат Истина;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

Процедура СоздатьПисьмоДляАдресатаРассылки(Данные, МассивАдресатовРассылки, АдресатыАдреса,
	                                       РассылкаПерсонализирована, МассивСозданныхПисем, ДанныеОснования)
	
	Письмо = Документы.ЭлектронноеПисьмоИсходящее.СоздатьДокумент();
	
	ПредставлениеПолучателя = "";
	
	Для Каждого ДанныеПолучателя Из МассивАдресатовРассылки Цикл
		
		Если УжеОтравлялосьНаДанныйАдрес(ДанныеПолучателя, АдресатыАдреса) Тогда
			Продолжить;
		КонецЕсли;
		
		Если РассылкаПерсонализирована Тогда
			ТабличнаяЧасть = Письмо.ПолучателиПисьма;
		Иначе
		
			ТабличнаяЧасть = ?(ТипЗнч(ДанныеПолучателя.Получатель) = Тип("СправочникСсылка.Партнеры") ИЛИ (НЕ Данные.ОтправлятьПартнеру), 
			                   Письмо.ПолучателиПисьма,
			                   Письмо.ПолучателиКопий);
		
		КонецЕсли;
		
		ПредставлениеПолучателя = ДанныеПолучателя.ПредставлениеПолучателя;
		
		Если ОбщегоНазначенияКлиентСервер.АдресЭлектроннойПочтыСоответствуетТребованиям(ДанныеПолучателя.КонтактнаяИнформация) Тогда
			ДобавитьПолучателяПисьма(ТабличнаяЧасть, ДанныеПолучателя);
		КонецЕсли;
		
	КонецЦикла;
		
	Если Письмо.ПолучателиКопий.Количество() = 0 И Письмо.ПолучателиПисьма.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Письмо.Автор                    = Пользователи.ТекущийПользователь();
	Письмо.Ответственный            = Данные.Ответственный;
	Письмо.Дата                     = ТекущаяДатаСеанса();
	Письмо.Важность                 = Перечисления.ВариантыВажностиВзаимодействия.Обычная;
	Письмо.Кодировка                = "UTF-8";
	Письмо.УчетнаяЗапись            = Данные.УчетнаяЗапись;
	Письмо.ОтправительПредставление = ВзаимодействияКлиентСервер.ПолучитьПредставлениеАдресата(Данные.УчетнаяЗаписьИмяПользователя,
	                                                                                           Данные.УчетнаяЗаписьАдресЭлектроннойПочты,
	                                                                                           "");
	
	Письмо.СтатусПисьма = Перечисления.СтатусыИсходящегоЭлектронногоПисьма.Исходящее;
	Письмо.Тема                    = Данные.Тема;
	Письмо.ТипТекста               = ?(Данные.ТипТекстаПисьма = Перечисления.СпособыРедактированияЭлектронныхПисем.HTML, 
	                                   Перечисления.ТипыТекстовЭлектронныхПисем.HTML, 
	                                   Перечисления.ТипыТекстовЭлектронныхПисем.ПростойТекст);
	Письмо.ВзаимодействиеОснование = Данные.Ссылка;
	Письмо.УведомитьОДоставке  = Ложь;
	Письмо.УведомитьОПрочтении = Ложь;
	Письмо.ОтображатьТелоИсходногоПисьма = Ложь;
	Письмо.ВключатьТелоИсходногоПисьма   = Ложь;
	Письмо.УдалятьПослеОтправки = Данные.УдалятьПослеОтправки;
	Письмо.Комментарий = КомментарийДляСообщенияПоРассылке(Данные);
	Письмо.ДатаКогдаОтправить = Данные.ДатаРассылки;
	Письмо.ДатаАктуальностиОтправки = Данные.ДатаАктуальности;
	Письмо.ЕстьВложения             = Данные.ЕстьВложения;

	Если Письмо.ТипТекста = Перечисления.ТипыТекстовЭлектронныхПисем.ПростойТекст Тогда
		Письмо.Текст = СформироватьТекстСообщения(Данные.ТекстПисьма, ПредставлениеПолучателя, ДанныеОснования);
	Иначе
		Письмо.ТекстHTML = СформироватьТекстСообщения(Данные.ТекстПисьмаHTML, ПредставлениеПолучателя, ДанныеОснования);
		Письмо.Текст     = Взаимодействия.ПолучитьОбычныйТекстИзHTML(Письмо.ТекстHTML);
	КонецЕсли;
	
	СформироватьСпискиПолучателей(Письмо);
	
	Письмо.Записать();
	
	Предмет = ПредметСообщения(Данные.Основание, Письмо.Ссылка);
	
	Реквизиты = РегистрыСведений.ПредметыПапкиВзаимодействий.РеквизитыВзаимодействия();
	Реквизиты.Предмет                 = Предмет;
	Реквизиты.Рассмотрено             = Истина;
	Реквизиты.РассчитыватьРассмотрено = Ложь;
	
	РегистрыСведений.ПредметыПапкиВзаимодействий.ЗаписатьПредметыПапкиВзаимодействий(Письмо.Ссылка, Реквизиты);
	
	МассивСозданныхПисем.Добавить(Письмо.Ссылка);
	
КонецПроцедуры

Процедура СформироватьСпискиПолучателей(Письмо)
	
	Письмо.СписокПолучателейПисьма       = ВзаимодействияКлиентСервер.ПолучитьПредставлениеСпискаАдресатов(Письмо.ПолучателиПисьма, Ложь);
	Письмо.СписокПолучателейКопий        = ВзаимодействияКлиентСервер.ПолучитьПредставлениеСпискаАдресатов(Письмо.ПолучателиКопий, Ложь);
	Письмо.СписокПолучателейСкрытыхКопий = "";
	
КонецПроцедуры

Процедура ДобавитьПолучателяПисьма(ТабличнаяЧасть, Получатель)

	НоваяСтрока = ТабличнаяЧасть.Добавить();
	НоваяСтрока.Адрес         = Получатель.КонтактнаяИнформация;
	НоваяСтрока.Представление = Получатель.ПредставлениеПолучателя;
	НоваяСтрока.Контакт       = Получатель.Получатель;
	
КонецПроцедуры

Функция ПредметСообщения(ОснованиеРассылки, Сообщение)

	Если ЗначениеЗаполнено(ОснованиеРассылки) И ВзаимодействияКлиентСервер.ЯвляетсяПредметом(ОснованиеРассылки) Тогда
		Возврат ОснованиеРассылки;
	Иначе
		Возврат Сообщение;
	КонецЕсли;

КонецФункции 

Процедура СоздатьSMSДляРассылки(Данные, ВыборкаАдресатовРассылки, МассивСозданныхВзаимодействий, ДанныеОснования)
	
	РассылкаПерсонализирована = РассылкаПерсонализирована(Данные);
	АдресатыАдреса = Новый Соответствие;
	МассивАдресатовРассылки = Новый Массив;
	
	Пока ВыборкаАдресатовРассылки.Следующий() Цикл
		
		ВыборкаПолучатель = ВыборкаАдресатовРассылки.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаПолучатель.Следующий() Цикл
			
			Если РассылкаПерсонализирована Тогда
				МассивАдресатовРассылки.Очистить();
			КонецЕсли;
		
			ВыборкаДетали = ВыборкаПолучатель.Выбрать();
			Пока ВыборкаДетали.Следующий() Цикл
				
				МассивАдресатовРассылки.Добавить(ДанныеАдресатаПоВыборке(ВыборкаДетали));
				
			КонецЦикла;
			
			Если РассылкаПерсонализирована Тогда
				СоздатьSMSДляАдресатовРассылки(Данные, МассивАдресатовРассылки, АдресатыАдреса, МассивСозданныхВзаимодействий, ДанныеОснования);
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЦикла;
	
	Если Не РассылкаПерсонализирована Тогда
		СоздатьSMSДляАдресатовРассылки(Данные, МассивАдресатовРассылки, АдресатыАдреса, МассивСозданныхВзаимодействий, ДанныеОснования);
	КонецЕсли;
	
КонецПроцедуры

Процедура СоздатьSMSДляАдресатовРассылки(Данные, МассивАдресатовРассылки, АдресатыАдреса, МассивСозданныхВзаимодействий, ДанныеОснования)
	
	ДокументСообщениеSMS = Документы.СообщениеSMS.СоздатьДокумент();
	ПредставлениеПолучателя = "";

	Для каждого АдресатРассылки Из МассивАдресатовРассылки Цикл
		
		ПодготовитьНомерТелефона(АдресатРассылки.ЗначенияПолей,
		                         АдресатРассылки.ПредставлениеКонтактнойИнформации,
		                         АдресатРассылки.КонтактнаяИнформация);
		
		Если ПустаяСтрока(АдресатРассылки.КонтактнаяИнформация) Тогда
			Продолжить;
		КонецЕсли;
		
		Если УжеОтравлялосьНаДанныйАдрес(АдресатРассылки, АдресатыАдреса) Тогда
			Продолжить;
		КонецЕсли;
		
		ПредставлениеПолучателя = АдресатРассылки.ПредставлениеПолучателя;
		
		ДобавитьАдресатаSMS(ДокументСообщениеSMS, АдресатРассылки);
	
	КонецЦикла;
	
	Если ДокументСообщениеSMS.Адресаты.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	ЗаполнитьРеквизитыДокументаСообщениеSMS(Данные, ДокументСообщениеSMS);
	ДокументСообщениеSMS.ТекстСообщения = СформироватьТекстСообщения(Данные.ТекстSMS, ПредставлениеПолучателя, ДанныеОснования);

	ЗаписатьДокументСообщениеSMS(ДокументСообщениеSMS, Данные.Основание);
	МассивСозданныхВзаимодействий.Добавить(ДокументСообщениеSMS.Ссылка);
	
КонецПроцедуры

Процедура ЗаписатьДокументСообщениеSMS(ДокументСообщениеSMS, Основание)

	Взаимодействия.УстановитьСостояниеИсходящееДокументСообщениеSMS(ДокументСообщениеSMS);
	
	ДокументСообщениеSMS.Записать();
	
	Предмет = ПредметСообщения(Основание, ДокументСообщениеSMS.Ссылка);
	
	Реквизиты = РегистрыСведений.ПредметыПапкиВзаимодействий.РеквизитыВзаимодействия();
	Реквизиты.Предмет                 = Предмет;
	Реквизиты.Рассмотрено             = Истина;
	Реквизиты.РассчитыватьРассмотрено = Ложь;
	
	РегистрыСведений.ПредметыПапкиВзаимодействий.ЗаписатьПредметыПапкиВзаимодействий(ДокументСообщениеSMS.Ссылка, Реквизиты);

КонецПроцедуры

Процедура ДобавитьАдресатаSMS(ДокументСообщениеSMS, ДанныеАдресата)
	
	НоваяСтрока = ДокументСообщениеSMS.Адресаты.Добавить();
	НоваяСтрока.Контакт               = ДанныеАдресата.Получатель;
	НоваяСтрока.ПредставлениеКонтакта = ДанныеАдресата.ПредставлениеПолучателя;
	НоваяСтрока.КакСвязаться          = ДанныеАдресата.ПредставлениеКонтактнойИнформации;
	НоваяСтрока.НомерДляОтправки      = ДанныеАдресата.КонтактнаяИнформация;
	НоваяСтрока.СостояниеСообщения    = Перечисления.СостоянияСообщенияSMS.Исходящее;

КонецПроцедуры

Процедура ПодготовитьНомерТелефона(ЗначенияПолей, Представление, НомерТелефона)

	ЗначенияПолейXML = УправлениеКонтактнойИнформацией.КонтактнаяИнформацияВXML(ЗначенияПолей,
	                                                                            Представление,
	                                                                            Перечисления.ТипыКонтактнойИнформации.Телефон);
	
	СтруктураПолей = УправлениеКонтактнойИнформацией.СведенияОТелефоне(ЗначенияПолейXML);
	
	КодСтраны     = ?(СтруктураПолей.Свойство("КодСтраны"), СтруктураПолей.КодСтраны, "");
	КодГорода     = ?(СтруктураПолей.Свойство("КодГорода"), СтруктураПолей.КодГорода, "");
	НомерТелефона = ?(СтруктураПолей.Свойство("НомерТелефона"), СтруктураПолей.НомерТелефона, "");
	
	// По значениям полей
	Если Не ПустаяСтрока(КодСтраны) И НЕ ПустаяСтрока(КодГорода) И Не ПустаяСтрока(НомерТелефона) Тогда
		Если КодСтраны = "7" ИЛИ КодСтраны = "8" Тогда
			КодСтраны = "+7";
		КонецЕсли;
		НомерТелефонаДляОтправки = КодСтраны + КодГорода + НомерТелефона;
		
		Если НомерТелефонаСоответствуетТребованиямДляОтправкиSMS(НомерТелефонаДляОтправки) Тогда
			НомерТелефона = НомерТелефонаДляОтправки;
		Возврат;
		
	КонецЕсли;

	КонецЕсли;
	
	// По номеру телефона
	Если Не ПустаяСтрока(НомерТелефона) Тогда
		
		НомерТелефонаДляОтправки = НомерТелефона;
		Если СтрДлина(НомерТелефонаДляОтправки) = 10 Тогда
			НомерТелефонаДляОтправки = "+7" + НомерТелефонаДляОтправки;
		ИначеЕсли СтрДлина(НомерТелефонаДляОтправки) = 11 
				И Лев(НомерТелефонаДляОтправки, 1) = "7" ИЛИ Лев(НомерТелефонаДляОтправки, 1) = "8" Тогда
				НомерТелефонаДляОтправки = "+7" + Прав(НомерТелефонаДляОтправки, 10);
		КонецЕсли;
			
		Если НомерТелефонаСоответствуетТребованиямДляОтправкиSMS(НомерТелефонаДляОтправки) Тогда
			НомерТелефона = НомерТелефонаДляОтправки;
			Возврат;
		КонецЕсли;
		
	КонецЕсли;
	
	Если Не ПустаяСтрока(Представление) Тогда
		
		// По представлению в формате XXXXXXXXXXXXX
		НомерТелефонаДляОтправки = Представление;
		Если СтрДлина(НомерТелефонаДляОтправки) = 10 Тогда
			НомерТелефонаДляОтправки = "+7" + НомерТелефонаДляОтправки;
		ИначеЕсли СтрДлина(НомерТелефонаДляОтправки) = 11 
				И Лев(НомерТелефонаДляОтправки, 1) = "7" ИЛИ Лев(НомерТелефонаДляОтправки, 1) = "8" Тогда
				НомерТелефонаДляОтправки = "+7" + Прав(НомерТелефонаДляОтправки, 10);
		КонецЕсли;
			
		Если НомерТелефонаСоответствуетТребованиямДляОтправкиSMS(НомерТелефонаДляОтправки) Тогда
			НомерТелефона = НомерТелефонаДляОтправки;
			Возврат;
		КонецЕсли;
		
		// По представлению в формате +X(XXX)XXXXXXX
		СтруктураПолей = СтруктураПолейПоПредставлениюТелефона(Представление);
		КодСтраны     = ?(СтруктураПолей.Свойство("КодСтраны"), СтруктураПолей.КодСтраны, "");
		КодГорода     = ?(СтруктураПолей.Свойство("КодГорода"), СтруктураПолей.КодГорода, "");
		НомерТелефона = ?(СтруктураПолей.Свойство("НомерТелефона"), СтруктураПолей.НомерТелефона, "");
		
		Если Не ПустаяСтрока(КодСтраны) И НЕ ПустаяСтрока(КодГорода) И Не ПустаяСтрока(НомерТелефона) Тогда
			
			Если КодСтраны = "7" ИЛИ КодСтраны = "8" Тогда
				КодСтраны = "+7";
			КонецЕсли;
			НомерТелефонаДляОтправки = КодСтраны + КодГорода + НомерТелефона;
			
			Если НомерТелефонаСоответствуетТребованиямДляОтправкиSMS(НомерТелефонаДляОтправки) Тогда
				НомерТелефона = НомерТелефонаДляОтправки;
				Возврат;
			КонецЕсли;
			
		КонецЕсли;
	
	КонецЕсли;
	
	НомерТелефона = "";

КонецПроцедуры

// Формирует структуру полей контактной информации типа Телефон или МобильныйТелефон по представлению телефона.
//
// Параметры:
//  Представление  - Строка - строковая информация с номером телефона.
//
// Возвращаемое значение:
//   Структура   - сформированная структура.
//
Функция СтруктураПолейПоПредставлениюТелефона(Представление)
	
	текСтр = СокрЛП(Представление);
	
	// Вырежем добавочный номер с комментарием.
	ПозДоб = СтрНайти(ВРЕГ(текСтр), "ДОБ.");
	Если ПозДоб <> 0 Тогда
		ДобавочныйСКомментарием = СокрЛП(Сред(текСтр, ПозДоб+4));
		
		текСтр = СокрЛП(Лев(текСтр, ПозДоб-1));
		
		Если СтрЗаканчиваетсяНа(текСтр, ",") Тогда
			текСтр = Лев(текСтр, СтрДлина(текСтр)-1);
		КонецЕсли;
		
		ПозДоб = СтрНайти(ВРЕГ(ДобавочныйСКомментарием), ", ");
		
		Если ПозДоб <> 0 Тогда
			Добавочный = СокрЛП(Лев(ДобавочныйСКомментарием, ПозДоб-1));
			Комментарий = СокрЛП(Сред(ДобавочныйСКомментарием, ПозДоб+2));
		Иначе
			Добавочный = ДобавочныйСКомментарием;
		КонецЕсли;
		
	КонецЕсли;
	
	// вырежем код города
	Поз = СтрНайти(текСтр, "(");
	Если Поз <> 0 Тогда
		КодСтраны = СокрЛП(Лев(текСтр, Поз-1));
		
		текСтр = СокрЛП(Сред(текСтр, Поз+1));
		Поз = СтрНайти(текСтр, ")");
		
		Если Поз <> 0 Тогда
			КодГорода = СокрЛП(Лев(текСтр, Поз-1));
			текСтр = СокрЛП(Сред(текСтр, Поз+1));
		КонецЕсли;
	КонецЕсли;
	
	Поз = СтрНайти(текСтр, ", ");
	// Если добавочного номера нет - ориентируемся по номеру телефона и комментарию.
	Если ПозДоб = 0 И Поз <> 0 Тогда
		// вырежем комментарий
		НомерТелефона = СокрЛП(Лев(текСтр, Поз-1));
		Комментарий = СокрЛП(Сред(текСтр, Поз+2));
	Иначе
		// все оставшееся это номер
		НомерТелефона = текСтр;
	КонецЕсли;
	
	Результат = Новый Структура;
	Результат.Вставить("КодСтраны", КодСтраны);
	Результат.Вставить("КодГорода", КодГорода);
	Результат.Вставить("НомерТелефона", НомерТелефона);
	Результат.Вставить("Добавочный", Добавочный);
	Результат.Вставить("Комментарий", Комментарий);
	
	Возврат Результат;
	
КонецФункции

Функция НомерТелефонаСоответствуетТребованиямДляОтправкиSMS(НомерТелефонаДляОтправки)

	Если СтрДлина(НомерТелефонаДляОтправки) <> 12 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если Лев(НомерТелефонаДляОтправки, 2) <> "+7" Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если НЕ СтроковыеФункцииКлиентСервер.ТолькоЦифрыВСтроке(Прав(НомерТелефонаДляОтправки, 10)) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Возврат Истина;

КонецФункции 

Функция СформироватьТекстСообщения(ШаблонСообщения, ПредставлениеПолучателя, ДанныеОснования)
	
	ТекстСообщения = ШаблонСообщения;
	
	ТекстСообщения = СтрЗаменить(ТекстСообщения, "[ПредставлениеАдресата]", ПредставлениеПолучателя);
	ТекстСообщения = СтрЗаменить(ТекстСообщения, "[ТекущаяДата]", Формат(ТекущаяДатаСеанса(), "ДЛФ=D"));
	
	Если ДанныеОснования <> Неопределено Тогда
		Если ТипЗнч(ДанныеОснования.Ссылка) = Тип("ДокументСсылка.НазначениеОпросов") Тогда
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "[ДатаНачалаОпроса]", Формат(ДанныеОснования.ДатаНачала, "ДЛФ=D"));
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "[ДатаОкончанияОпроса]", Формат(ДанныеОснования.ДатаОкончания, "ДЛФ=D"));
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "[НаименованиеОпроса]", ДанныеОснования.Наименование);
		КонецЕсли;
	КонецЕсли;
	
	Возврат ТекстСообщения;
	
КонецФункции

Процедура ЗаполнитьРеквизитыДокументаСообщениеSMS(Данные, ДокументСообщениеSMS)
	
	ДокументСообщениеSMS.Дата                     = ТекущаяДатаСеанса();
	ДокументСообщениеSMS.Автор                    = Пользователи.ТекущийПользователь();
	ДокументСообщениеSMS.Важность                 = Перечисления.ВариантыВажностиВзаимодействия.Обычная;
	ДокументСообщениеSMS.Ответственный            = Данные.Ответственный;
	ДокументСообщениеSMS.ВзаимодействиеОснование  = Данные.Ссылка;
	ДокументСообщениеSMS.Тема                     = Данные.Тема;
	ДокументСообщениеSMS.ОтправлятьВТранслите     = Данные.ОтправлятьВТранслите;
	ДокументСообщениеSMS.ДатаКогдаОтправить       = Данные.ДатаРассылки;
	ДокументСообщениеSMS.ДатаАктуальностиОтправки = Данные.ДатаАктуальности;
	
	Если ТипЗнч(Данные) = Тип("Структура") Тогда
		Если Данные.Свойство("Комментарий") Тогда
			ДокументСообщениеSMS.Комментарий = Данные.Комментарий;
		КонецЕсли;
	Иначе
		ДокументСообщениеSMS.Комментарий = КомментарийДляСообщенияПоРассылке(Данные);
	КонецЕсли;
	
КонецПроцедуры

Функция КомментарийДляСообщенияПоРассылке(Данные)

	ТекстКомментария = НСтр("ru = 'Создано по рассылке ""%1"" № %2 от %3.'");
	ТекстКомментария = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(Данные.Тема,
	                                                                           Данные.Номер,
	                                                                           Данные.Дата);
	
	Возврат ТекстКомментария
	
КонецФункции

Функция РассылкаПерсонализирована(Данные)
	
	ШаблонСообщения = ШаблонСообщенияРассылки(Данные);
	
	Возврат СтрНайти(ШаблонСообщения, "[ПредставлениеАдресата]") > 0;
	
КонецФункции

Функция ШаблонСообщенияРассылки(Данные)

	ШаблонСообщения = "";
	
	Если Данные.ПредназначенаДляЭлектронныхПисем Тогда
		
		Если Данные.ТипТекстаПисьма = Перечисления.СпособыРедактированияЭлектронныхПисем.HTML Тогда
			ШаблонСообщения = Данные.ТекстПисьмаHTML;
		Иначе
			ШаблонСообщения = Данные.ТекстПисьма;
		КонецЕсли;
		
	Иначе
		ШаблонСообщения = Данные.ТекстSMS;
	КонецЕсли;
	
	Возврат ШаблонСообщения;

КонецФункции 

#КонецОбласти

#Область Прочее

Функция ТаблицыОтличаются(Таблица1, Таблица2)

	Если Таблица1.Количество() <> Таблица2.Количество() Тогда
		Возврат Истина;
	КонецЕсли;
	
	Если Таблица1.Колонки.Количество() <> Таблица2.Колонки.Количество() Тогда
		Возврат Истина
	КонецЕсли;
	
	Для ИндСтрока = 0 По Таблица1.Количество() - 1 Цикл
		Для ИндКолонка = 0 По Таблица1.Колонки.Количество() - 1 Цикл
		
			Если Таблица1[ИндСтрока][ИндКолонка] <> Таблица2[ИндСтрока][ИндКолонка] Тогда
				Возврат Истина;
			КонецЕсли;
				
		КонецЦикла;
	КонецЦикла;
	
	Возврат Ложь;

КонецФункции

Процедура ЗаписьВОчередьПоТипуСобытия(ТипСобытияОповещения, ИсточникОповещения, Подписчик, ДатаОтправки, ДатаАктуальности)
	
	МассивВидовОповещений = РассылкиИОповещенияКлиентамПовтИсп.ДействующиеВидыОповещенийПоТипуСобытия(ТипСобытияОповещения);
	
	Для Каждого ВидОповещения Из МассивВидовОповещений Цикл
			
			РегистрыСведений.ОчередьСобытийДляОповещенийКлиентам.ВыполнитьЗаписьВРегистр(ВидОповещения,
			                                                                             Подписчик,
			                                                                             ИсточникОповещения,
			                                                                             ДатаОтправки,
			                                                                             ДатаАктуальности);
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ДобавитьЗапятуюЕслиНеПустойТекст(Строка)

	Строка = Строка + ?(ПустаяСтрока(Строка), "", ", ");

КонецПроцедуры

Процедура ДобавитьПодписчиковПоОтбору(АдресВоВременномХранилище,
	                                  ГруппаРассылокИОповещений,
	                                  ПредназначенаДляSMS,
	                                  ПредназначенаДляЭлектронныхПисем) Экспорт
	
	ТаблицаПартнеров = ПолучитьИзВременногоХранилища(АдресВоВременномХранилище);
	
	Если ТаблицаПартнеров.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст ="
	|ВЫБРАТЬ
	|	ТаблицаПартнеров.Партнер,
	|	ТаблицаПартнеров.ВидКИДляПисем,
	|	ТаблицаПартнеров.ВидКИТелефон
	|ПОМЕСТИТЬ ПодобранныеПартнеры
	|ИЗ
	|	&ТаблицаПартнеров КАК ТаблицаПартнеров
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПодобранныеПартнеры.Партнер,
	|	ПодобранныеПартнеры.ВидКИДляПисем,
	|	ПодобранныеПартнеры.ВидКИТелефон,
	|	ЕСТЬNULL(ПодпискиНаРассылкиИОповещенияКлиентам.Ссылка, ЗНАЧЕНИЕ(Справочник.ПодпискиНаРассылкиИОповещенияКлиентам.ПустаяСсылка)) КАК Подписка,
	|	ЕСТЬNULL(ПодпискиНаРассылкиИОповещенияКлиентам.ПодпискаДействует, ЛОЖЬ) КАК ПодпискаДействует
	|ИЗ
	|	ПодобранныеПартнеры КАК ПодобранныеПартнеры
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПодпискиНаРассылкиИОповещенияКлиентам КАК ПодпискиНаРассылкиИОповещенияКлиентам
	|		ПО ПодобранныеПартнеры.Партнер = ПодпискиНаРассылкиИОповещенияКлиентам.Владелец
	|			И (ПодпискиНаРассылкиИОповещенияКлиентам.ГруппаРассылокИОповещений = &ГруппаРассылокИОповещений)
	|			И (НЕ ПодпискиНаРассылкиИОповещенияКлиентам.ПометкаУдаления)";
	
	Запрос.УстановитьПараметр("ТаблицаПартнеров", ТаблицаПартнеров);
	Запрос.УстановитьПараметр("ГруппаРассылокИОповещений", ГруппаРассылокИОповещений);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		
		Если Выборка.Подписка.Пустая() Тогда
			
			ПодпискаОбъект = Справочники.ПодпискиНаРассылкиИОповещенияКлиентам.СоздатьЭлемент();
			ПодпискаОбъект.Владелец = Выборка.Партнер;
			ПодпискаОбъект.ГруппаРассылокИОповещений = ГруппаРассылокИОповещений;
			ПодпискаОбъект.ОтправлятьПартнеру = Истина;
			
			Если ПредназначенаДляSMS Тогда
				ПодпискаОбъект.ВидКИПартнераДляSMS = Выборка.ВидКИТелефон;
			КонецЕсли;
			Если ПредназначенаДляЭлектронныхПисем Тогда
				ПодпискаОбъект.ВидКИПартнераДляПисем = Выборка.ВидКИДляПисем;
			КонецЕсли;
			
		Иначе
			
			Если Выборка.ПодпискаДействует Тогда
				Продолжить
			КонецЕсли;
			
			ПодпискаОбъект = Выборка.Подписка.ПолучитьОбъект();
			
		КонецЕсли;
		
		ПодпискаОбъект.ПодпискаДействует  = Истина;
		ПодпискаОбъект.Записать();
		
	КонецЦикла;

КонецПроцедуры

Функция ТекстОбъединить()
	
	Возврат "
		|
		|ОБЪЕДИНИТЬ
		|";
	
КонецФункции

Функция ВыполнитьЗаписьЖурналаРегистрации(ТекстЗаписи ,УровеньВажности)

	ЗаписьЖурналаРегистрации(
		НСтр("ru = 'Рассылки и оповещения клиентам'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()), 
		УровеньВажности, , ,
		ТекстЗаписи);

КонецФункции 

#КонецОбласти

#КонецОбласти

