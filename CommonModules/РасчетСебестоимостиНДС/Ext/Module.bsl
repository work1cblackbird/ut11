#Область ПрограммныйИнтерфейс

#Область ЭтапыРасчета

//++ Локализация

// Этап "ПодготовкаДанныхДляУчетаНДСиУСН"
//
// Параметры:
//	ПараметрыРасчета - Структура - параметры расчета себестоимости
//
Процедура ПодготовкаДанныхДляУчетаНДСиУСН(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "ПодготовкаДанныхДляУчетаНДСиУСН");
	
	// 1. Инициализация структуры данных для расчета
	//	- формирует структуру ПараметрыРасчета.РаспределениеПартий.
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьРаспределениеПартий(
		ПараметрыРасчета,
		ТаблицаДляРаспределенияПартийНДС(ПараметрыРасчета),
		ОписаниеЦепочекПартийНДС(ПараметрыРасчета),
		ОписаниеДвиженийПартийНДС(ПараметрыРасчета),
		ОписаниеНезаписываемыхПартийНДС(ПараметрыРасчета));
		
	// 2. Получение исходных данных для расчета
	// 	- формирует временную таблицу Данные.
	ПолучитьДанныеДляПартийНДС(ПараметрыРасчета);
	
	// 3. Получение цепочек из исходных данных
	// 	- формирует временные таблицы Источники и Приемники.
	РасчетСебестоимостиПрикладныеАлгоритмы.ПостроитьЦепочкиДвижений(ПараметрыРасчета);
	
	// 4. Заполнение партий в цепочках
	// 	- заполняет таблицу ПараметрыРасчета.РаспределениеПартий.РасчетныеПартии.
	РасчетСебестоимостиПрикладныеАлгоритмы.РассчитатьПартииПоЦепочкам(ПараметрыРасчета);
	
	// 5. Помещение данных в таблицу-приемник и очистка вспомогательных временных таблиц.
	// 	- формирует движения по регистру ДетализацияПартийТоваровДляНДСиУСН.
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗавершитьРаспределениеПартий(ПараметрыРасчета);
	
	// Формирование движений по регистру
	// 
	// 1. Инициализация структуры данных для расчета
	//	- формирует структуру ПараметрыРасчета.РаспределениеПартий.
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьТрансляциюПартий(
		ПараметрыРасчета,
		Неопределено,
		Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН.Имя);
	
	// 2. Получение исходных данных для трансляции
	// 	- формирует временную таблицу Данные.
	РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьДанныеЭтапаРасчета(
		ПараметрыРасчета,
		ТекстЗапросаДляДетализацииПартийТоваровДляНДСиУСН(ПараметрыРасчета));
	
	// 3. Помещение данных в таблицу-приемник и очистка вспомогательных временных таблиц.
	// 	- формирует движения по регистру ДетализацияПартийТоваровДляНДСиУСН.
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗавершитьРаспределениеПартий(ПараметрыРасчета);
	
	// Запись сформированных движений по регистру ДетализацияПартийТоваровДляНДСиУСН
	ЗаписатьРегистры = Новый Массив;
	ЗаписатьРегистры.Добавить(Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН.ПолноеИмя());
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ПредварительнаяЗаписьСформированныхДвижений(ПараметрыРасчета, ЗаписатьРегистры);
	
КонецПроцедуры

//-- Локализация

// Этап "РаспределениеПартийНДСФИФОСкользящая"
//
// Параметры:
//	ПараметрыРасчета - Структура - параметры расчета себестоимости
//
Процедура РаспределениеПартийНДСФИФОСкользящая(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "РаспределениеПартийНДСФИФОСкользящая");
	
	СуществующиеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета);
	
	// 1. Инициализация структуры данных этапа подготовки данных.
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьПодготовкуДанныхДляСледующихЭтапов(
		ПараметрыРасчета,
		"ПриходыТоваровНДС2_4, ВТКоэффициентыДопРасходов, ВТПолностьюВыбывшиеТовары, ПриходыТоваровНДС2_4_ДляРешенияСЛУ");
		
	ИнициализироватьТаблицыДляДокументовВводаОстатков(ПараметрыРасчета);
	
	// 2. Формирование временных таблиц.
	РасчетСебестоимостиПрикладныеАлгоритмы.ПодготовитьДанныеДляСледующихЭтапов(
		ПараметрыРасчета,
		ТекстЗапросаПодготовкаДанныхРаспределенияНДС(ПараметрыРасчета));
		
	// 3. Завершаем этап подготовки данных. 
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗавершитьПодготовкуДанныхДляСледующихЭтапов(ПараметрыРасчета);
	
	РаспределитьНДСПоСебестоимости(ПараметрыРасчета, "ПриходыТоваровНДС2_4_ДляРешенияСЛУ");
	
	// Уничтожим ненужные временные таблицы.
	НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(
		ПараметрыРасчета,
		СуществующиеВТ + ", ПриходыТоваровНДС2_4, ВТКоэффициентыДопРасходов, ВТПолностьюВыбывшиеТовары");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);
	
	СформироватьСтоимостьПартийНДСНаКонецПериода(ПараметрыРасчета, 1);
	
КонецПроцедуры

// Этап "РаспределениеПартийНДСФИФОСкользящаяПоДопРасходам"
//
// Параметры:
//	ПараметрыРасчета - Структура - параметры расчета себестоимости
//
Процедура РаспределениеПартийНДСФИФОСкользящаяПоДопРасходам(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "РаспределениеПартийНДСФИФОСкользящаяПоДопРасходам");
	
	// 1. Инициализация структуры данных для расчета
	//	- формирует структуру ПараметрыРасчета.РаспределениеПартий
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьРаспределениеПартий(
		ПараметрыРасчета,
		ТаблицаРаспределениеПартийНДСФИФОСкользящаяПоДопРасходам(ПараметрыРасчета),
		ОписаниеЦепочекРаспределениеПартийНДСФИФОСкользящаяПоДопРасходам(ПараметрыРасчета),
		ОписаниеДвиженийРаспределениеПартийНДСФИФОСкользящаяПоДопРасходам(ПараметрыРасчета),
		ОписаниеНезаписываемыхРаспределениеПартийНДСФИФОСкользящаяПоДопРасходам(ПараметрыРасчета));
		
	// 2. Получение исходных данных для расчета
	// 	- формирует временную таблицу Данные
	ПолучитьДанныеДляРаспределениеПартийНДСФИФОСкользящаяПоДопРасходам(ПараметрыРасчета);
	
	// 3. Получение цепочек из исходных данных
	// 	- формирует временные таблицы Источники и Приемники
	РасчетСебестоимостиПрикладныеАлгоритмы.ПостроитьЦепочкиДвижений(ПараметрыРасчета);
	
	// 4. Заполнение партий в цепочках
	// 	- заполняет таблицу ПараметрыРасчета.РаспределениеПартий.РасчетныеПартии
	РасчетСебестоимостиПрикладныеАлгоритмы.РассчитатьПартииПоЦепочкам(ПараметрыРасчета);
	
	// 5. Помещение данных в таблицу-приемник и очистка вспомогательных временных таблиц.
	// 	- формирует временную таблицу ВТДопРасходыДляПостатейныхЗатрат
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗавершитьРаспределениеПартий(ПараметрыРасчета);
	
	СуществующиеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета);
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	#Область ПодготовкаДанныхРаспределенияНДС
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.Регистратор,
	// Аналитики партий НДС
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	// Аналитики себестоимости
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаФинансовогоУчета,
	// Прочие поля
	|	Т.СтатьяРасходовАктивов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|
	// Ресурсы
	|	СУММА(ВЫРАЗИТЬ(ЕСТЬNULL(Коэффициенты.Коэффициент, 1) * Т.СтоимостьСНДС КАК ЧИСЛО(31,2))) КАК СтоимостьСНДС,
	|	СУММА(ВЫРАЗИТЬ(ЕСТЬNULL(Коэффициенты.Коэффициент, 1) * Т.СтоимостьБезНДС КАК ЧИСЛО(31,2))) КАК СтоимостьБезНДС,
	|	СУММА(ВЫРАЗИТЬ(ЕСТЬNULL(Коэффициенты.Коэффициент, 1) * Т.СтоимостьБезНДСРегл КАК ЧИСЛО(31,2))) КАК СтоимостьБезНДСРегл,
	|	СУММА(ВЫРАЗИТЬ(ЕСТЬNULL(Коэффициенты.Коэффициент, 1) * 
	|		ВЫБОР КОГДА Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
	|			ТОГДА 0 
	|		ИНАЧЕ Т.НДСРегл КОНЕЦ КАК ЧИСЛО(31,2))) КАК НДСРегл,
	|	СУММА(ВЫРАЗИТЬ(ЕСТЬNULL(Коэффициенты.Коэффициент, 1) * Т.СтоимостьБезНДСУпр КАК ЧИСЛО(31,2))) КАК СтоимостьБезНДСУпр,
	|	СУММА(ВЫРАЗИТЬ(ЕСТЬNULL(Коэффициенты.Коэффициент, 1) * 
	|		ВЫБОР КОГДА Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
	|			ТОГДА 0
	|		ИНАЧЕ Т.НДСУпр КОНЕЦ КАК ЧИСЛО(31,2))) КАК НДСУпр,
	|
	|	ЕСТЬNULL(Выбытия.ПолноеВыбытие, ЛОЖЬ) И ЕСТЬNULL(Коэффициенты.Коэффициент, 1) = 0 КАК ПолноеВыбытие,
	|	ЕСТЬNULL(Выбытия.Количество, 0) КАК Количество,
	|	СУММА(ВЫБОР КОГДА ЕСТЬNULL(Выбытия.ПолноеВыбытие, ЛОЖЬ) И ЕСТЬNULL(Выбытия.Количество, 0) <> 0
	|			ТОГДА ВЫРАЗИТЬ(Т.СтоимостьСНДС / Выбытия.Количество КАК ЧИСЛО (28, 10))
	|			ИНАЧЕ 0
	|		  КОНЕЦ) КАК ВыбытиеСтоимостьСНДС,
	|	СУММА(ВЫБОР КОГДА ЕСТЬNULL(Выбытия.ПолноеВыбытие, ЛОЖЬ) И ЕСТЬNULL(Выбытия.Количество, 0) <> 0
	|			ТОГДА ВЫРАЗИТЬ(Т.СтоимостьБезНДС / Выбытия.Количество КАК ЧИСЛО (28, 10))
	|			ИНАЧЕ 0
	|		  КОНЕЦ) КАК ВыбытиеСтоимостьБезНДС,
	|	СУММА(ВЫБОР КОГДА ЕСТЬNULL(Выбытия.ПолноеВыбытие, ЛОЖЬ) И ЕСТЬNULL(Выбытия.Количество, 0) <> 0
	|			ТОГДА ВЫРАЗИТЬ(Т.СтоимостьБезНДСРегл / Выбытия.Количество КАК ЧИСЛО (28, 10))
	|			ИНАЧЕ 0
	|		  КОНЕЦ) КАК ВыбытиеСтоимостьБезНДСРегл,
	|	СУММА(ВЫБОР КОГДА ЕСТЬNULL(Выбытия.ПолноеВыбытие, ЛОЖЬ) И ЕСТЬNULL(Выбытия.Количество, 0) <> 0
	|		  И Т.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
	|			ТОГДА ВЫРАЗИТЬ(Т.НДСРегл / Выбытия.Количество КАК ЧИСЛО (28, 10))
	|			ИНАЧЕ 0
	|		  КОНЕЦ) КАК ВыбытиеНДСРегл,
	|	СУММА(ВЫБОР КОГДА ЕСТЬNULL(Выбытия.ПолноеВыбытие, ЛОЖЬ) И ЕСТЬNULL(Выбытия.Количество, 0) <> 0
	|			ТОГДА ВЫРАЗИТЬ(Т.СтоимостьБезНДСУпр / Выбытия.Количество КАК ЧИСЛО (28, 10))
	|			ИНАЧЕ 0
	|		  КОНЕЦ) КАК ВыбытиеСтоимостьБезНДСУпр,
	|	СУММА(ВЫБОР КОГДА ЕСТЬNULL(Выбытия.ПолноеВыбытие, ЛОЖЬ) И ЕСТЬNULL(Выбытия.Количество, 0) <> 0
	|		  И Т.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
	|			ТОГДА ВЫРАЗИТЬ(Т.НДСУпр / Выбытия.Количество КАК ЧИСЛО (28, 10))
	|			ИНАЧЕ 0
	|		  КОНЕЦ) КАК ВыбытиеНДСУпр
	|ПОМЕСТИТЬ ВТДопРасходыНДС2_4
	|ИЗ
	|	ВТДопРасходыДляПостатейныхЗатрат КАК Т
	//++ Локализация
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТСтатьиПроизводственныхЗатрат КАК Статьи
	|		ПО Т.КорСтатьяРасходов = Статьи.Ссылка
	//-- Локализация
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Отбор
	|		ПО Т.АналитикаУчетаНоменклатуры = Отбор.Ссылка
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТКоэффициентыДопРасходов КАК Коэффициенты
	|		ПО Т.Организация = Коэффициенты.Организация
	|		И Т.РазделУчета = Коэффициенты.РазделУчета
	|		И Т.АналитикаУчетаНоменклатуры = Коэффициенты.АналитикаУчетаНоменклатуры
	|		И Т.ВидЗапасов = Коэффициенты.ВидЗапасов
	|		И Т.Партия = Коэффициенты.Партия
	|		И Т.АналитикаУчетаПартий = Коэффициенты.АналитикаУчетаПартий
	|		И Т.ВидДеятельностиНДС = Коэффициенты.ВидДеятельностиНДС
	|		И Т.АналитикаФинансовогоУчета = Коэффициенты.АналитикаФинансовогоУчета
	|		И Т.Регистратор = Коэффициенты.Регистратор
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТПолностьюВыбывшиеТовары КАК Выбытия
	|		ПО Т.Организация = Выбытия.Организация
	|		И Т.РазделУчета = Выбытия.РазделУчета
	|		И Т.АналитикаУчетаНоменклатуры = Выбытия.АналитикаУчетаНоменклатуры
	|		И Т.ВидЗапасов = Выбытия.ВидЗапасов
	|		И Т.Партия = Выбытия.Партия
	|		И Т.АналитикаУчетаПартий = Выбытия.АналитикаУчетаПартий
	|		И Т.ВидДеятельностиНДС = Выбытия.ВидДеятельностиНДС
	|		И Т.АналитикаФинансовогоУчета = Выбытия.АналитикаФинансовогоУчета
	|		И Т.Регистратор = Выбытия.Регистратор
	|ГДЕ
	|	Т.ТипЗаписи В (ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией))
	//++ Локализация
	|	И НЕ (Отбор.Ссылка ЕСТЬ NULL
	|		И Статьи.Ссылка ЕСТЬ НЕ NULL
	|		И Т.Организация В(&ОрганизацииСРаздельнымУчетомПостатейныхЗатрат))
	//-- Локализация
	|	И Т.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.СтатьяРасходовАктивов,
	|	Т.АналитикаРасходов,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	ЕСТЬNULL(Выбытия.ПолноеВыбытие, ЛОЖЬ) И ЕСТЬNULL(Коэффициенты.Коэффициент, 1) = 0,
	|	ЕСТЬNULL(Выбытия.Количество, 0)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЛОЖЬ КАК ЭтоОстаткиПостатейныеПеременные,
	|	ЛОЖЬ КАК ЭтоОстаткиПостатейныеПостоянные,
	// Аналитики партий НДС
	|	ДД.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	ДД.ДокументПоступления,
	|	ДД.АналитикаУчетаПартийДокументаПоступления,
	|	ЛОЖЬ КАК ЗатратыПредыдущихПеределов,
	|	ИСТИНА КАК ЭтоДопРасходы,
	|	ДД.ЭтоПеременныеДопРасходы КАК ЭтоПеременныеДопРасходы,
	|	
	// Аналитики себестоимости
	|	ДД.Организация,
	|	ДД.РазделУчета,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.АналитикаФинансовогоУчета,
	|
	// Прочие поля
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|
	// Ресурсы
	|	ВЫБОР КОГДА ДД.СтоимостьСНДС < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК ЗнакСтоимостьСНДС,
	|	ВЫБОР КОГДА ДД.СтоимостьБезНДС < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК ЗнакСтоимостьБезНДС,
	|	ВЫБОР КОГДА ДД.СтоимостьБезНДСРегл < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК ЗнакСтоимостьБезНДСРегл,
	|	ВЫБОР КОГДА ДД.НДСРегл < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК ЗнакНДСРегл,
	|	ВЫБОР КОГДА ДД.СтоимостьБезНДСУпр < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК ЗнакСтоимостьБезНДСУпр,
	|	ВЫБОР КОГДА ДД.НДСУпр < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК ЗнакНДСУпр,
	|
	|	ВЫБОР КОГДА ДД.СтоимостьСНДС < 0 ТОГДА -ДД.СтоимостьСНДС ИНАЧЕ ДД.СтоимостьСНДС КОНЕЦ КАК СтоимостьСНДС,
	|	ВЫБОР КОГДА ДД.СтоимостьБезНДС < 0 ТОГДА -ДД.СтоимостьБезНДС ИНАЧЕ ДД.СтоимостьБезНДС КОНЕЦ КАК СтоимостьБезНДС,
	|	ВЫБОР КОГДА ДД.СтоимостьБезНДСРегл < 0 ТОГДА -ДД.СтоимостьБезНДСРегл ИНАЧЕ ДД.СтоимостьБезНДСРегл КОНЕЦ КАК СтоимостьБезНДСРегл,
	|	ВЫБОР КОГДА ДД.НДСРегл < 0 ТОГДА -ДД.НДСРегл ИНАЧЕ ДД.НДСРегл КОНЕЦ КАК НДСРегл,
	|	ВЫБОР КОГДА ДД.СтоимостьБезНДСУпр < 0 ТОГДА -ДД.СтоимостьБезНДСУпр ИНАЧЕ ДД.СтоимостьБезНДСУпр КОНЕЦ КАК СтоимостьБезНДСУпр,
	|	ВЫБОР КОГДА ДД.НДСУпр < 0 ТОГДА -ДД.НДСУпр ИНАЧЕ ДД.НДСУпр КОНЕЦ КАК НДСУпр
	|ПОМЕСТИТЬ ПриходыДопРасходовНДС2_4_ДляРешенияСЛУ
	|ИЗ
	|(ВЫБРАТЬ
	// Если доп. расходы относятся на партию прошлого периода, то это переменные доп. расходы
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(РеестрПартия.ДатаДокументаИБ, &КонецПредыдущегоПериода) < &НачалоПериода
	|			ТОГДА ИСТИНА
	|			ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЭтоПеременныеДопРасходы,
	// Аналитики партий НДС
	|	ДД.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(ДД.ДокументПоступления) В (&ТипыДокументовПартии)
	|		ТОГДА ДД.ДокументПоступления
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДокументПоступления,
	|	ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(ДД.ДокументПоступления) В (&ТипыДокументовПартии)
	|		ТОГДА ДД.АналитикаУчетаПартийДокументаПоступления
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|	КОНЕЦ КАК АналитикаУчетаПартийДокументаПоступления,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	
	// Аналитики себестоимости
	|	ДД.Организация,
	|	ДД.РазделУчета,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.АналитикаФинансовогоУчета,
	|
	// Ресурсы
	|	СУММА(ДД.СтоимостьСНДС) КАК СтоимостьСНДС,
	|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	СУММА(ДД.СтоимостьБезНДСРегл) КАК СтоимостьБезНДСРегл,
	|	СУММА(ДД.НДСРегл) КАК НДСРегл,
	|	СУММА(ДД.СтоимостьБезНДСУпр) КАК СтоимостьБезНДСУпр,
	|	СУММА(ДД.НДСУпр) КАК НДСУпр
	|ИЗ
	|	ВТДопРасходыНДС2_4 КАК ДД
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РеестрДокументов КАК РеестрПартия
	|		ПО РеестрПартия.Ссылка = ДД.Партия
	|		И НЕ РеестрПартия.ДополнительнаяЗапись
	|		И РеестрПартия.Ссылка <> НЕОПРЕДЕЛЕНО
	|ГДЕ
	|	НЕ ДД.ПолноеВыбытие
	|СГРУППИРОВАТЬ ПО
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(РеестрПартия.ДатаДокументаИБ, &КонецПредыдущегоПериода) < &НачалоПериода
	|			ТОГДА ИСТИНА
	|			ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ДД.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(ДД.ДокументПоступления) В (&ТипыДокументовПартии)
	|		ТОГДА ДД.ДокументПоступления
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(ДД.ДокументПоступления) В (&ТипыДокументовПартии)
	|		ТОГДА ДД.АналитикаУчетаПартийДокументаПоступления
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|	КОНЕЦ,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	ДД.Организация,
	|	ДД.РазделУчета,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.АналитикаФинансовогоУчета
	|) КАК ДД
	|ГДЕ
	|	ДД.СтоимостьСНДС <> 0
	|	ИЛИ ДД.СтоимостьБезНДС <> 0
	|	ИЛИ ДД.СтоимостьБезНДСРегл <> 0
	|	ИЛИ ДД.НДСРегл <> 0
	|	ИЛИ ДД.СтоимостьБезНДСУпр <> 0
	|	ИЛИ ДД.НДСУпр <> 0
	|
	// Индексы должны соответствовать свойству ИндексыРегистра из описания регистра себестоимости
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаНоменклатуры,
	|	Организация,
	|	Партия
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
	
	#КонецОбласти
	
	РаспределитьНДСПоСебестоимости(ПараметрыРасчета, "ПриходыДопРасходовНДС2_4_ДляРешенияСЛУ");
	
	Если РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(ПараметрыРасчета, "ПриходыДопРасходовНДС2_4_ДляРешенияСЛУ") > 0 Тогда
		СформироватьСтоимостьПартийНДСНаКонецПериода(ПараметрыРасчета, 2);
	КонецЕсли;
	
	// Уничтожим ненужные временные таблицы.
	НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(
		ПараметрыРасчета,
		СуществующиеВТ);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);
	
	Если ПараметрыРасчета.ЭтоЛокализованнаяВерсия Тогда
		
		// Запись сформированных движений по регистрам партий НДС
		ЗаписатьРегистры = Новый Массив;
		ЗаписатьРегистры.Добавить(Метаданные.РегистрыСведений.ДетализацияСебестоимостиПартииТоваров.ПолноеИмя());
		ЗаписатьРегистры.Добавить(Метаданные.РегистрыСведений.ДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты.ПолноеИмя());
		ЗаписатьРегистры.Добавить(Метаданные.РегистрыСведений.ДетализацияСебестоимостиТоваровПостатейныеЗатраты.ПолноеИмя());

		//++ Локализация
		

		//-- Локализация
		РасчетСебестоимостиПрикладныеАлгоритмы.ПредварительнаяЗаписьСформированныхДвижений(ПараметрыРасчета, ЗаписатьРегистры);
		
	КонецЕсли;
	
КонецПроцедуры

//++ Локализация

// Этап "РаспределениеПартийНДСФИФОСкользящаяПоПартиямПрочихРасходов"
//
// Параметры:
//	ПараметрыРасчета - Структура - параметры расчета себестоимости
//
Процедура РаспределениеПартийНДСФИФОСкользящаяПоПартиямПрочихРасходов(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "РаспределениеПартийНДСФИФОСкользящаяПоПартиямПрочихРасходов");
	
	#Область ДанныеДляРаспределения
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьТрансляциюПартий(
		ПараметрыРасчета,
		ТаблицаРаспределениеПартийНДСФИФОСкользящая(ПараметрыРасчета),
		,
		"ВТДанныеПостатейныеЗатраты",
		"СтатьяРасходовАктивов, АналитикаРасходов, Подразделение, Организация, НаправлениеДеятельности",
		"ВТСебестоимостьСписаниеТоваров");
		
	ПолучитьДанныеДляРаспределениеПартийНДСФИФОСкользящая(ПараметрыРасчета);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗавершитьРаспределениеПартий(ПараметрыРасчета);
	
	СуществующиеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета);
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.К,
	|	Т.ТипЗаписи,
	|	Т.ЧастичноОставитьВНЗП,
	|	Т.Знаменатель,
	|	Т.ЗнаменательУпр,
	|	Т.ЗнаменательДляИсточников,
	|	Т.ЗнаменательДляИсточниковУпр,
	|	Т.Период,
	|	Т.Регистратор,
	|	Т.ВидДвижения,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.КорАналитикаУчетаНоменклатуры,
	|	Т.КорВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	МАКСИМУМ(ЕСТЬNULL(Реестр.ДатаДокументаИБ, ДАТАВРЕМЯ(1,1,1))) КАК ДатаДокументаИБ,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.НаправлениеДеятельности,
	|	Т.ХозяйственнаяОперация,
	|	Т.КорВидДеятельностиНДС,
	|	Т.КорНаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.СтатьяРасходовАктивов,
	|	Т.АналитикаРасходов,
	|	Т.КорПодразделение,
	|	Т.СтатьяСписанияНДС,
	|	Т.АналитикаСписанияНДС,
	|	Т.РазделУчета,
	|	Т.АналитикаФинансовогоУчета,
	|
	|	Т.СтоимостьСНДС,
	|	Т.СтоимостьБезНДС,
	|	Т.СтоимостьБезНДСРегл,
	|	Т.НДСРегл,
	|	Т.НДСУпр
	|ПОМЕСТИТЬ ВТДанныеПостатейныеЗатратыПоУзлуПредварительная
	|ИЗ
	|	ВТДанныеПостатейныеЗатраты КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РеестрДокументов КАК Реестр
	|		ПО Реестр.Ссылка = Т.ДокументПоступления
	|		И Реестр.Организация = Т.Организация
	|		И (НЕ Реестр.ДополнительнаяЗапись ИЛИ Реестр.ТипСсылки В (&ДокументыСДвумяОрганизациями))
	|		И Реестр.Ссылка <> НЕОПРЕДЕЛЕНО
	|		И Т.ДокументПоступления <> НЕОПРЕДЕЛЕНО
	|СГРУППИРОВАТЬ ПО
	|	Т.К,
	|	Т.ТипЗаписи,
	|	Т.ЧастичноОставитьВНЗП,
	|	Т.Знаменатель,
	|	Т.ЗнаменательУпр,
	|	Т.ЗнаменательДляИсточников,
	|	Т.ЗнаменательДляИсточниковУпр,
	|	Т.Период,
	|	Т.Регистратор,
	|	Т.ВидДвижения,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.КорАналитикаУчетаНоменклатуры,
	|	Т.КорВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.НаправлениеДеятельности,
	|	Т.ХозяйственнаяОперация,
	|	Т.КорВидДеятельностиНДС,
	|	Т.КорНаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.СтатьяРасходовАктивов,
	|	Т.АналитикаРасходов,
	|	Т.КорПодразделение,
	|	Т.СтатьяСписанияНДС,
	|	Т.АналитикаСписанияНДС,
	|	Т.РазделУчета,
	|	Т.АналитикаФинансовогоУчета,
	|
	|	Т.СтоимостьСНДС,
	|	Т.СтоимостьБезНДС,
	|	Т.СтоимостьБезНДСРегл,
	|	Т.НДСРегл,
	|	Т.НДСУпр
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	АВТОНОМЕРЗАПИСИ() КАК НомерУзла,
	|	Т.К,
	|	Т.ТипЗаписи,
	|	Т.ЧастичноОставитьВНЗП,
	|	Т.Знаменатель,
	|	Т.ЗнаменательУпр,
	|	Т.ЗнаменательДляИсточников,
	|	Т.ЗнаменательДляИсточниковУпр,
	|	Т.Период,
	|	Т.Регистратор,
	|	Т.ВидДвижения,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.КорАналитикаУчетаНоменклатуры,
	|	Т.КорВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	ВЫБОР КОГДА Т.ДатаДокументаИБ МЕЖДУ &НачалоПериода и &КонецПериода ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ КАК ДокументПоступленияВТекущемПериоде,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.НаправлениеДеятельности,
	|	Т.ХозяйственнаяОперация,
	|	Т.КорВидДеятельностиНДС,
	|	Т.КорНаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.СтатьяРасходовАктивов,
	|	Т.АналитикаРасходов,
	|	Т.КорПодразделение,
	|	Т.СтатьяСписанияНДС,
	|	Т.АналитикаСписанияНДС,
	|	Т.РазделУчета,
	|	Т.АналитикаФинансовогоУчета,
	|
	|	Т.СтоимостьСНДС,
	|	Т.СтоимостьБезНДС,
	|	Т.СтоимостьБезНДСРегл,
	|	Т.НДСРегл,
	|	Т.НДСУпр
	|ПОМЕСТИТЬ ВТДанныеПостатейныеЗатратыПоУзлу
	|ИЗ
	|	ВТДанныеПостатейныеЗатратыПоУзлуПредварительная КАК Т
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерУзла
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	ВЫБОР КОГДА Т.ВариантУчетаНДСПриИзмененииВидаДеятельности = ЗНАЧЕНИЕ(Перечисление.ВариантыУчетаНДСПриИзмененииВидаДеятельностиНаНеоблагаемую.ВключатьВСтоимостьИлиРасходыВЗависимостиОтПериода)
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЗависитОтПериод,
	|	Т.СтатьяРасходовНеНДС,
	|	Т.АналитикаРасходовНеНДС,
	|	Т.СтатьяРасходовЕНВД,
	|	Т.АналитикаРасходовЕНВД
	|ПОМЕСТИТЬ ВТНастройкиСписанияНДС
	|ИЗ
	|	РегистрСведений.НастройкиУчетаНДС.СрезПоследних(&НачалоПериода, Организация В(&МассивОрганизаций)) КАК Т
	|ГДЕ
	|	НЕ Т.ВариантУчетаНДСПриИзмененииВидаДеятельности ЕСТЬ NULL
	|	И Т.ВариантУчетаНДСПриИзмененииВидаДеятельности <> ЗНАЧЕНИЕ(Перечисление.ВариантыУчетаНДСПриИзмененииВидаДеятельностиНаНеоблагаемую.ВключатьВСтоимость)
	|	И Т.СтатьяРасходовСписаниеНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Источники.К КАК Источник,
	|	Приемники.К КАК Приемник
	|ПОМЕСТИТЬ ВТСвязи1
	|ИЗ
	|	ВТДанныеПостатейныеЗатраты КАК Источники
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДанныеПостатейныеЗатраты КАК Приемники
	|		ПО Источники.СтатьяРасходовАктивов = Приемники.СтатьяРасходовАктивов
	|		И Источники.АналитикаРасходов = Приемники.АналитикаРасходов
	|		И Источники.Подразделение = Приемники.Подразделение
	|		И Источники.Организация = Приемники.Организация
	|		И Источники.НаправлениеДеятельности = Приемники.НаправлениеДеятельности
	|ГДЕ
	|	Источники.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыРегл)
	|	И Приемники.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.БазаРегл)
	|ИНДЕКСИРОВАТЬ ПО
	|	Приемник
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.К,
	|	Т.ТипЗаписи,
	|	Т.Организация,
	|	Т.ВидДеятельностиНДС,
	|	Т.Подразделение,
	|	Т.КорПодразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.КорНаправлениеДеятельности,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.СтатьяРасходовАктивов,
	|	Т.АналитикаРасходов
	|ПОМЕСТИТЬ ВТИсточникиПриемники
	|ИЗ
	|	ВТДанныеПостатейныеЗатраты КАК Т
	|ГДЕ
	|	Т.ТипЗаписи В
	|		(ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.БазаРегл),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОстатокНЗП),
	|		 ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпускПостатейные))
	|ИНДЕКСИРОВАТЬ ПО
	|	СтатьяРасходовАктивов,
	|	Партия,
	|	Организация,
	|	ВидДеятельностиНДС
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Источники.К КАК Источник,
	|	Приемники.К КАК Приемник
	|ПОМЕСТИТЬ ВТСвязи2
	|ИЗ
	|	ВТИсточникиПриемники КАК Источники
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТИсточникиПриемники КАК Приемники
	|		ПО Источники.СтатьяРасходовАктивов = Приемники.СтатьяРасходовАктивов
	|		И Источники.АналитикаРасходов = Приемники.АналитикаРасходов
	|		И Источники.Партия = Приемники.Партия
	|		И Источники.Организация = Приемники.Организация
	|		И Источники.ВидДеятельностиНДС = Приемники.ВидДеятельностиНДС
	|		И Источники.КорПодразделение = Приемники.Подразделение
	|		И Источники.КорНаправлениеДеятельности = Приемники.НаправлениеДеятельности
	|ГДЕ
	|	Источники.ТипЗаписи В (ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.БазаРегл), ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОстатокНЗП))
	|	И Приемники.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпускПостатейные)
	|ИНДЕКСИРОВАТЬ ПО
	|	Приемник
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТИсточникиПриемники
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.К,
	|	Т.ТипЗаписи,
	|	Т.Организация,
	|	Т.КорВидДеятельностиНДС,
	|	Т.КорНаправлениеДеятельности,
	|	Т.КорПартия,
	|	Т.КорАналитикаУчетаПартий,
	|	Т.Регистратор
	|ПОМЕСТИТЬ ВТИсточники
	|ИЗ
	|	ВТДанныеПостатейныеЗатраты КАК Т
	|ГДЕ
	|	Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпускПостатейные)
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор,
	|	КорПартия,
	|	КорАналитикаУчетаПартий,
	|	КорНаправлениеДеятельности,
	|	Организация,
	|	КорВидДеятельностиНДС
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.К,
	|	Т.ТипЗаписи,
	|	Т.Организация,
	|	Т.ВидДеятельностиНДС,
	|	Т.НаправлениеДеятельности,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.Регистратор
	|ПОМЕСТИТЬ ВТПриемники
	|ИЗ
	|	ВТДанныеПостатейныеЗатраты КАК Т
	|ГДЕ
	|	Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор,
	|	Партия,
	|	АналитикаУчетаПартий,
	|	НаправлениеДеятельности,
	|	Организация,
	|	ВидДеятельностиНДС
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Источники.К КАК Источник,
	|	Приемники.К КАК Приемник
	|ПОМЕСТИТЬ ВТСвязи3
	|ИЗ
	|	ВТИсточники КАК Источники
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПриемники КАК Приемники
	|		ПО Источники.Регистратор = Приемники.Регистратор
	|		И Источники.КорПартия = Приемники.Партия
	|		И Источники.КорАналитикаУчетаПартий = Приемники.АналитикаУчетаПартий
	|		И Источники.КорНаправлениеДеятельности = Приемники.НаправлениеДеятельности
	|		И Источники.Организация = Приемники.Организация
	|		И Источники.КорВидДеятельностиНДС = Приемники.ВидДеятельностиНДС
	|ИНДЕКСИРОВАТЬ ПО
	|	Приемник
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТИсточники
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТПриемники
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
	
	#КонецОбласти
	
	СформироватьПромежуточныйРезультатРаспределенияПартийНДС(ПараметрыРасчета, Запрос, 1);
	СформироватьПромежуточныйРезультатРаспределенияПартийНДС(ПараметрыРасчета, Запрос, 2);
	СформироватьПромежуточныйРезультатРаспределенияПартийНДС(ПараметрыРасчета, Запрос, 3); // формируется ВТСписаниеПостатейныхЗатрат 
	
	#Область ПодготовкаДанныхРаспределенияНДС
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ЛОЖЬ КАК ЭтоОстаткиПостатейныеПеременные,
	|	ЛОЖЬ КАК ЭтоОстаткиПостатейныеПостоянные,
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаФинансовогоУчета,
	|
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатурыДокументаПоступления,
	|	ВЫРАЗИТЬ(Т.СтатьяРасходовАктивов КАК ПланВидовХарактеристик.СтатьиРасходов) КАК СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	ЛОЖЬ КАК ЗатратыПредыдущихПеределов,
	|	ВЫБОР КОГДА ВЫРАЗИТЬ(Т.СтатьяРасходовАктивов КАК ПланВидовХарактеристик.СтатьиРасходов).ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЭтоДопРасходы,
	|	ЛОЖЬ КАК ЭтоПеременныеДопРасходы,
	|
	|	ВЫБОР КОГДА СУММА(Т.СтоимостьСНДС) < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК ЗнакСтоимостьСНДС,
	|	ВЫБОР КОГДА СУММА(Т.СтоимостьБезНДС) < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК ЗнакСтоимостьБезНДС,
	|	ВЫБОР КОГДА СУММА(Т.СтоимостьБезНДСРегл) < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК ЗнакСтоимостьБезНДСРегл,
	|	ВЫБОР КОГДА СУММА(Т.НДСРегл) < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК ЗнакНДСРегл,
	|	ВЫБОР КОГДА СУММА(Т.СтоимостьБезНДСУпр) < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК ЗнакСтоимостьБезНДСУпр,
	|	ВЫБОР КОГДА СУММА(Т.НДСУпр) < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК ЗнакНДСУпр,
	|
	|	ВЫБОР КОГДА СУММА(Т.СтоимостьСНДС) < 0 ТОГДА -СУММА(Т.СтоимостьСНДС) ИНАЧЕ СУММА(Т.СтоимостьСНДС) КОНЕЦ КАК СтоимостьСНДС,
	|	ВЫБОР КОГДА СУММА(Т.СтоимостьБезНДС) < 0 ТОГДА -СУММА(Т.СтоимостьБезНДС) ИНАЧЕ СУММА(Т.СтоимостьБезНДС) КОНЕЦ КАК СтоимостьБезНДС,
	|	ВЫБОР КОГДА СУММА(Т.СтоимостьБезНДСРегл) < 0 ТОГДА -СУММА(Т.СтоимостьБезНДСРегл) ИНАЧЕ СУММА(Т.СтоимостьБезНДСРегл) КОНЕЦ КАК СтоимостьБезНДСРегл,
	|	ВЫБОР КОГДА СУММА(Т.НДСРегл) < 0 ТОГДА -СУММА(Т.НДСРегл) ИНАЧЕ СУММА(Т.НДСРегл) КОНЕЦ КАК НДСРегл,
	|	ВЫБОР КОГДА СУММА(Т.СтоимостьБезНДСУпр) < 0 ТОГДА -СУММА(Т.СтоимостьБезНДСУпр) ИНАЧЕ СУММА(Т.СтоимостьБезНДСУпр) КОНЕЦ КАК СтоимостьБезНДСУпр,
	|	ВЫБОР КОГДА СУММА(Т.НДСУпр) < 0 ТОГДА -СУММА(Т.НДСУпр) ИНАЧЕ СУММА(Т.НДСУпр) КОНЕЦ КАК НДСУпр
	|ПОМЕСТИТЬ ПриходыПостатейныхНДС2_4
	|ИЗ
	|	ВТСписаниеПостатейныхЗатрат КАК Т
	|ГДЕ
	|	Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
	|	ИЛИ (Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией)
	|		И Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаСебестоимость))
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	ВЫРАЗИТЬ(Т.СтатьяРасходовАктивов КАК ПланВидовХарактеристик.СтатьиРасходов),
	|	Т.АналитикаРасходов,
	|	ВЫБОР КОГДА ВЫРАЗИТЬ(Т.СтатьяРасходовАктивов КАК ПланВидовХарактеристик.СтатьиРасходов).ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ //ЭтоДопРасходы
	|ИМЕЮЩИЕ
	|	СУММА(Т.СтоимостьСНДС) <> 0
	|	ИЛИ СУММА(Т.СтоимостьБезНДС) <> 0
	|	ИЛИ СУММА(Т.СтоимостьБезНДСРегл) <> 0
	|	ИЛИ СУММА(Т.НДСРегл) <> 0
	|	ИЛИ СУММА(Т.СтоимостьБезНДСУпр) <> 0
	|	ИЛИ СУММА(Т.НДСУпр) <> 0
	|
	// Индексы должны соответствовать свойству ИндексыРегистра из описания регистра себестоимости
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаНоменклатуры,
	|	Организация,
	|	Партия
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
	
	#КонецОбласти
	
	Если РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(ПараметрыРасчета, "ПриходыПостатейныхНДС2_4") > 0 Тогда
		
		РаспределитьНДСПоСебестоимости(ПараметрыРасчета, "ПриходыПостатейныхНДС2_4");
		
	КонецЕсли;
	
	
	Если РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(ПараметрыРасчета, "ПриходыПостатейныхНДС2_4") > 0
		Тогда
		
		СформироватьСтоимостьПартийНДСНаКонецПериода(ПараметрыРасчета, 3);
		
	КонецЕсли;
	
	// Уничтожим ненужные временные таблицы.
	НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(
		ПараметрыРасчета,
		СуществующиеВТ + ", ВТСписаниеПостатейныхЗатрат");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);
	
	Если НЕ ПараметрыРасчета.ЭтоЛокализованнаяВерсия Тогда
		
		// Запись сформированных движений по регистрам партий НДС
		ЗаписатьРегистры = Новый Массив;
		ЗаписатьРегистры.Добавить(Метаданные.РегистрыСведений.ДетализацияСебестоимостиПартииТоваров.ПолноеИмя());
		ЗаписатьРегистры.Добавить(Метаданные.РегистрыСведений.ДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты.ПолноеИмя());
		ЗаписатьРегистры.Добавить(Метаданные.РегистрыСведений.ДетализацияСебестоимостиТоваровПостатейныеЗатраты.ПолноеИмя());
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ПредварительнаяЗаписьСформированныхДвижений(ПараметрыРасчета, ЗаписатьРегистры);
		
	КонецЕсли;
	
КонецПроцедуры

//-- Локализация

// Этап "ПодготовкаДанныхДляВключенияИсключенияНДСДопРасходовВСтоимость24"
//
// Параметры:
//	ПараметрыРасчета - Структура - параметры расчета себестоимости
//
Процедура ПодготовкаДанныхДляВключенияИсключенияНДСДопРасходовВСтоимость24(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "ПодготовкаДанныхДляВключенияИсключенияНДСДопРасходовВСтоимость24");
	
	// 1. Инициализация структуры данных для расчета
	//	- формирует структуру ПараметрыРасчета.РаспределениеПартий.
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьТрансляциюПартий(
		ПараметрыРасчета,
		Неопределено,
		Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя);
	
	// 2. Получение исходных данных для трансляции
	// 	- формирует временную таблицу Данные.
	ПолучитьДанныеДляВключенияИсключенияНДСДопРасходов(ПараметрыРасчета);
	
	// 3. Помещение данных в таблицу-приемник и очистка вспомогательных временных таблиц.
	// 	- формирует движения по регистру СебестоимостьТоваров.
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗавершитьРаспределениеПартий(ПараметрыРасчета);
	
КонецПроцедуры

// Этап "ПодготовкаДанныхДляПартийПрочихРасходов"
//
// Параметры:
//	ПараметрыРасчета - Структура - параметры расчета себестоимости
//
Процедура ПодготовкаДанныхДляПартийПрочихРасходов(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "ПодготовкаДанныхДляПартийПрочихРасходов");
	
	// 1. Инициализация структуры данных для расчета
	//	- формирует структуру ПараметрыРасчета.РаспределениеПартий.
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьТрансляциюПартий(
		ПараметрыРасчета,
		Неопределено,
		Метаданные.РегистрыНакопления.ПартииПрочихРасходов.Имя);
	
	// 2. Получение исходных данных для трансляции
	// 	- формирует временную таблицу Данные.
	ПолучитьДанныеДляПартийПрочихРасходов(ПараметрыРасчета);
	
	// 3. Помещение данных в таблицу-приемник и очистка вспомогательных временных таблиц.
	// 	- формирует движения по регистру ПартииПрочихРасходов.
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗавершитьРаспределениеПартий(ПараметрыРасчета);
	
КонецПроцедуры

//++ Локализация

// Этап "ПодготовкаДанныхДляПрочихРасходов"
//
// Параметры:
//	ПараметрыРасчета - Структура - параметры расчета себестоимости
//
Процедура ПодготовкаДанныхДляПрочихРасходов(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "ПодготовкаДанныхДляПрочихРасходов");
	
	// 1. Инициализация структуры данных для расчета
	//	- формирует структуру ПараметрыРасчета.РаспределениеПартий.
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьТрансляциюПартий(
		ПараметрыРасчета,
		Неопределено,
		Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя);
	
	// 2. Получение исходных данных для трансляции
	// 	- формирует временную таблицу Данные.
	ПолучитьДанныеДляПрочихРасходов(ПараметрыРасчета);
	
	// 3. Помещение данных в таблицу-приемник и очистка вспомогательных временных таблиц.
	// 	- формирует движения по регистру ПрочиеРасходы.
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗавершитьРаспределениеПартий(ПараметрыРасчета);
	
КонецПроцедуры


// Этап "ПодготовкаДанныхДляПартийНДСКРаспределению"
//
// Параметры:
//	ПараметрыРасчета - Структура - параметры расчета себестоимости
//
Процедура ПодготовкаДанныхДляПартийНДСКРаспределению(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "ПодготовкаДанныхДляПартийНДСКРаспределению");
	
	// 1. Инициализация структуры данных для расчета
	//	- формирует структуру ПараметрыРасчета.РаспределениеПартий.
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьТрансляциюПартий(
		ПараметрыРасчета,
		Неопределено,
		Метаданные.РегистрыНакопления.ПартииНДСКРаспределению.Имя);
	
	// 2. Получение исходных данных для трансляции
	// 	- формирует временную таблицу Данные.
	ПолучитьДанныеДляПартийНДСКРаспределению(ПараметрыРасчета);
	
	// 3. Помещение данных в таблицу-приемник и очистка вспомогательных временных таблиц.
	// 	- формирует движения по регистру ПартииНДСКРаспределению.
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗавершитьРаспределениеПартий(ПараметрыРасчета);
	
КонецПроцедуры

// Этап формирования документов РаспределениеНДС
//
// Параметры:
//	ПараметрыРасчета - Структура - параметры расчета себестоимости
//
Процедура РаспределениеНДСПоВидамНалогообложения(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "РаспределениеНДСПоВидамНалогообложения");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	// Сохраним движения документа РаспределениеНДС по регистру ПрочиеРасходы до расчета.
	// Эти движения не имеют признаков "расчетные", т.к. формируются самим документом, а не механикой расчета себестоимости.
	// При окончании расчета механизм расчета не имеет возможности определить наличие изменений в таких движения.
	Запрос.Текст =
	"ВЫБРАТЬ
	|	*
	|ПОМЕСТИТЬ ВТДвиженияРаспределенияНДСПоПрочиеРасходыДоРасчета
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходы КАК Т
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|	И Т.Регистратор ССЫЛКА Документ.РаспределениеНДС
	|	И НЕ Т.РасчетПартий
	|	И НЕ Т.РасчетСебестоимости
	|	И Т.Активность
	|;
	|ВЫБРАТЬ
	|	Организации.Ссылка КАК Организация,
	|	Организации.ГоловнаяОрганизация КАК ГоловнаяОрганизация,
	|	&НачалоПериода КАК Период,
	|	МАКСИМУМ(НастройкиУчетаНДС.Период) КАК ПериодУчетнойПолитики
	|ПОМЕСТИТЬ ПартииНДСКРаспределениюПериодыНастройкиУчетаНДС
	|ИЗ
	|	ВТКэшРасчетныеОстаткиПартииНДСКРаспределению КАК Остатки
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Организации КАК Организации
	|		ПО Организации.Ссылка = Остатки.Организация
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.НастройкиУчетаНДС КАК НастройкиУчетаНДС
	|		ПО Организации.ГоловнаяОрганизация = НастройкиУчетаНДС.Организация
	|		И &НачалоПериода >= НастройкиУчетаНДС.Период
	|ГДЕ
	|	Остатки.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
	|	И Остатки.СтатьяРасходов.ВариантРаспределенияРасходовРегл <> ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
	|
	|СГРУППИРОВАТЬ ПО
	|	Организации.Ссылка,
	|	Организации.ГоловнаяОрганизация
	|	
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	Период
	|;
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ПериодыНастройки.Организация КАК Организация
	|ИЗ
	|	ПартииНДСКРаспределениюПериодыНастройкиУчетаНДС КАК ПериодыНастройки
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.НастройкиУчетаНДС КАК НастройкиУчетаНДС
	|	ПО ПериодыНастройки.ГоловнаяОрганизация = НастройкиУчетаНДС.Организация
	|		И ПериодыНастройки.ПериодУчетнойПолитики = НастройкиУчетаНДС.Период
	|ГДЕ
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(НастройкиУчетаНДС.ПериодичностьРаспределенияНДС, ЗНАЧЕНИЕ(Перечисление.Периодичность.Квартал))
	|		 = ЗНАЧЕНИЕ(Перечисление.Периодичность.Квартал)
	|			ТОГДА НАЧАЛОПЕРИОДА(КОНЕЦПЕРИОДА(ПериодыНастройки.Период, КВАРТАЛ), МЕСЯЦ)
	|		КОГДА НастройкиУчетаНДС.ПериодичностьРаспределенияНДС = ЗНАЧЕНИЕ(Перечисление.Периодичность.Месяц) ТОГДА
	|			НАЧАЛОПЕРИОДА(ПериодыНастройки.Период, МЕСЯЦ)
	|	КОНЕЦ = &НачалоПериода
	|";
	
	РезультатЗапроса = Запрос.Выполнить();
	МассивОрганизаций = РезультатЗапроса.Выгрузить().ВыгрузитьКолонку("Организация");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, "ПартииНДСКРаспределениюПериодыНастройкиУчетаНДС");
	
	// Вызовем "внешнюю" логику перепроведения документов РаспределениеНДС.
	// При этом будут переформированы "первичные" движения этих документов.
	// Распределение выполняется только при наличии остатков в регистре "Партии НДС к распределению".
	Если МассивОрганизаций.Количество() > 0 Тогда
		РезультатРаспределенияНДС = Документы.РаспределениеНДС.РаспределитьНДС(
			ПараметрыРасчета.РасчетныйПериод.НачалоПериода,
			МассивОрганизаций,
			РасчетСебестоимостиПрикладныеАлгоритмы.ИмяСобытияОшибкиДляЖурналаРегистрации(ПараметрыРасчета),
			ПараметрыРасчета.МенеджерВременныхТаблиц,
			Истина);
	Иначе
		РезультатРаспределенияНДС = Новый Структура;
		РезультатРаспределенияНДС.Вставить("МассивДокументов", 		  Новый Массив);
		РезультатРаспределенияНДС.Вставить("РассчитанныеОрганизации", Новый Массив);
		РезультатРаспределенияНДС.Вставить("ТекстОшибки", 	   		  "");
	КонецЕсли;
	
	РасчетСебестоимостиПротоколРасчета.УвеличитьКоличествоОбработанныхДанныхДляЗамера(
		ПараметрыРасчета,
		ПараметрыРасчета.МассивОрганизаций.Количество());
	
	// Сохраним движения документа РаспределениеНДС по регистру ПрочиеРасходы после расчета.
	Запрос.Текст =
	"ВЫБРАТЬ
	|	*
	|ПОМЕСТИТЬ ВТДвиженияРаспределенияНДСПоПрочиеРасходыПослеРасчета
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходы КАК Т
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|	И Т.Регистратор ССЫЛКА Документ.РаспределениеНДС
	|	И НЕ Т.РасчетПартий
	|	И НЕ Т.РасчетСебестоимости
	|	И Т.Активность";
	
	Запрос.Выполнить();
	
	Если ЗначениеЗаполнено(РезультатРаспределенияНДС.ТекстОшибки) Тогда
		
		ТекстДляПротокола = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru='Операция ""Распределение НДС"" не была выполнена по причине:
				|%1'", ОбщегоНазначения.КодОсновногоЯзыка()),
			РезультатРаспределенияНДС.ТекстОшибки);
			
		// В механизме закрытия месяца ошибка зарегистрирована из механизма распределения НДС.
		РасчетСебестоимостиПротоколРасчета.ЗафиксироватьОшибкуРасчета(
			ПараметрыРасчета,
			Перечисления.ТипыОшибокПартионногоУчетаИСебестоимости.ОшибкаРаспределенияНДС,
			ТекстДляПротокола);
		
	КонецЕсли;
		
	// Если документ РаспределениеНДС может делать движения по регистру,
	// обслуживаемому механизмом партионного учета и себестоимости,
	// то по этому регистру надо обновить расчетные кэши остатков и оборотов.
	// Иначе получится ситуация, что данные ИБ при проведении этих документов изменились,
	// а следующие этапы расчета "не увидят" этого во временных таблицах кэшей регистров.
	Если РезультатРаспределенияНДС.МассивДокументов.Количество() > 0 Тогда
		
		ВозможныеДвиженияДокументов = Метаданные.Документы.РаспределениеНДС.Движения;
		
		Для Каждого КлючИЗначение Из ПараметрыРасчета.Движения Цикл
			
			ОписаниеРегистра = КлючИЗначение.Значение;
			
			Если ВозможныеДвиженияДокументов.Содержит(ОписаниеРегистра.МетаданныеРегистра) Тогда
				ОписаниеРегистра.НадоОбновитьРасчетныйКэш = Истина;
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ОбновитьРасчетныеКэшиРегистров(ПараметрыРасчета, Истина);
	
	РасчетСебестоимостиПротоколРасчета.ДополнительнаяИнформация(
		ПараметрыРасчета,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru='Обработано документов ""Распределение НДС"": %1'", ОбщегоНазначения.КодОсновногоЯзыка()),
			РасчетСебестоимостиПротоколРасчета.ПредставлениеЗначения(
				РезультатРаспределенияНДС.МассивДокументов.Количество())));
	
КонецПроцедуры

//-- Локализация

#КонецОбласти

//++ Локализация

#Область Инициализация

// Инициализирует общие параметры расчета, описывающие обслуживаемые механизмом расчета регистры.
//
// Параметры:
//	ПараметрыРасчета - Структура - параметры расчета себестоимости
//
Процедура ИнициализироватьОбслуживаемыеРегистры(ПараметрыРасчета) Экспорт
	
	ПараметрыРасчета.РегистрыСРасчетнымиОборотами.Вставить(Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН.Имя, Истина);
	
	ПараметрыРасчета.РегистрыСРасчетнымиОстатками.Вставить(Метаданные.РегистрыНакопления.ПартииНДСКРаспределению.Имя, Истина);
	
КонецПроцедуры

// Дополняет перечень документов, которые могут иметь движения в разных месяцах или по нескольким организациям.
//
// Параметры:
//	РазныеПериоды - Булево - добавлять в результат документы с движениями в разных периодах
//	РазныеОрганизации - Булево - добавлять в результат документы с движениями по нескольким организациям
//	ИмяРегистра - Строка - имя регистра накопления, для которого нужно получить перечень документов;
//		пустое значение - перечень документов для всех регистров.
//	ОписаниеДокументов - Соответствие - Ключ - ОбъектМетаданных.
//
Процедура ДополнитьДокументыСРазнымиПериодамиИлиОрганизациямиВДвижениях(РазныеПериоды, РазныеОрганизации, ИмяРегистра, ОписаниеДокументов) Экспорт
	
	// Для движений в других периодах Значение = Истина означает
	// - наличие первичных+расчетных движений,
	// - расчетные движения формируются при расчете их периода.
	// Если указано значение Ложь, то это означает, что
	// - расчетные движения могут быть без первичных движений,
	// - расчетные движения любых периодов формируются при расчете периода документа.
	// Для движений других организаций Значение должно быть только Истина.
	
	Значение = Истина;
	
	Если ИмяРегистра = ""
	 ИЛИ ИмяРегистра = Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя Тогда
		Если РазныеПериоды Тогда
			ОписаниеДокументов.Вставить(Метаданные.Документы.СчетФактураНалоговыйАгент,  Значение); // движения могут быть любым периодом
		КонецЕсли;
	КонецЕсли;
	
	Если ИмяРегистра = ""
	 ИЛИ ИмяРегистра = Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН.Имя Тогда
		
		Если РазныеПериоды Тогда
			ОписаниеДокументов.Вставить(Метаданные.Документы.РеализацияТоваровУслуг, 	 Значение); // операция РеализацияБезПереходаПраваСобственности
			ОписаниеДокументов.Вставить(Метаданные.Документы.СчетФактураНалоговыйАгент,	 Значение); // движения могут быть любым периодом

		КонецЕсли;
		
	КонецЕсли;

	Если ИмяРегистра = ""
	 ИЛИ ИмяРегистра = Метаданные.РегистрыНакопления.НДСПредъявленный.Имя Тогда
		
		Если РазныеПериоды Тогда
			ОписаниеДокументов.Вставить(Метаданные.Документы.РасчетСебестоимостиТоваров, Значение);
		КонецЕсли;
		
	КонецЕсли;
	
	Если ИмяРегистра = ""
	 ИЛИ ИмяРегистра = Метаданные.РегистрыНакопления.ПартииНДСКРаспределению.Имя Тогда
		
		Если РазныеПериоды Тогда
			Для Каждого МетаДокумент Из Метаданные.Документы Цикл
				Если МетаДокумент.Движения.Содержит(Метаданные.РегистрыНакопления.ПартииНДСКРаспределению) Тогда
					ОписаниеДокументов.Вставить(МетаДокумент, Значение);
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// Формирует общие временные таблицы для отбора данных в запросах.
//
Процедура ИнициализироватьВременныеТаблицыДляОтборов(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоФормированиеВременнойТаблицы(ПараметрыРасчета, "ВТОтборАналитикиУчетаПартийНДС2_4");
	
	ИнициализироватьТаблицуДляОтбораАналитикУчетаПартийНДС2_4(ПараметрыРасчета.МенеджерВременныхТаблиц);
	
	РасчетСебестоимостиПротоколРасчета.ОкончаниеФормированиеВременнойТаблицы(ПараметрыРасчета, Истина);
	
КонецПроцедуры

#КонецОбласти

//-- Локализация

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область Инициализация

Процедура ИнициализироватьТаблицуДляОтбораАналитикУчетаПартийНДС2_4(МенеджерВременныхТаблиц) Экспорт
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(МенеджерВременныхТаблиц, "ВТОтборАналитикиУчетаПартийНДС2_4");
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	Запрос.Текст = ТекстЗапросаТаблицыДляОтбораАналитикУчетаПартийНДС2_4();
	Запрос.Выполнить();
	
КонецПроцедуры

Функция ТекстЗапросаТаблицыДляОтбораАналитикУчетаПартийНДС2_4() Экспорт
	
	Возврат 
		"ВЫБРАТЬ
		|	Т.Ссылка КАК Ссылка,
		|	ВЫБОР
		|		КОГДА НЕ Т.Контрагент В (ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка), ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка), НЕОПРЕДЕЛЕНО)
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ВнешнийКонтрагент,
		|	ВЫБОР
		|		КОГДА Т.КодСтроки <> 0
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ЗаполненКодСтроки
		|ПОМЕСТИТЬ ВТОтборАналитикиУчетаПартийНДС2_4
		|ИЗ
		|	Справочник.КлючиАналитикиУчетаПартий КАК Т
		|ГДЕ
		|	НЕ Т.Контрагент В (ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка), ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка), НЕОПРЕДЕЛЕНО)
		|	ИЛИ Т.КодСтроки <> 0
		|";
	
КонецФункции

#КонецОбласти

#Область ПроцедурыЭтапа_РасчетПартийНДС

//++ Локализация

// Инициализация данных

Функция ПоляПотребленийПартииНДС(ПараметрыРасчета)
	
	Возврат "АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС";
	
КонецФункции

Функция ОписаниеЦепочекПартийНДС(ПараметрыРасчета) Экспорт
	
	ОписаниеЦепочек = Новый Соответствие;
	ПоляПотреблений	= ПоляПотребленийПартииНДС(ПараметрыРасчета);
	
	// ОстатокСгруппированный <- Остаток, ДопРасходы, ДопРасходыСПартией, КорректировкаСтоимости, ОтклонениеВСтоимости, ОстатокДляРаспределения 
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный, ПоляПотреблений + ", Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный,
		Перечисления.ТипыЗаписейПартий.Остаток, ПоляПотреблений + ", Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный,
		Перечисления.ТипыЗаписейПартий.ДопРасходы, ПоляПотреблений + ", Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный,
		Перечисления.ТипыЗаписейПартий.ДопРасходыСПартией, ПоляПотреблений + ", Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный,
		Перечисления.ТипыЗаписейПартий.КорректировкаСтоимости, ПоляПотреблений + ", Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный,
		Перечисления.ТипыЗаписейПартий.ОтклонениеВСтоимости, ПоляПотреблений + ", Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный,
		Перечисления.ТипыЗаписейПартий.ОстатокДляРаспределения, ПоляПотреблений + ", Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный,
		Перечисления.ТипыЗаписейПартий.БазаДопРасходыРегл, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный,
		Перечисления.ТипыЗаписейПартий.БазаДопРасходыУпр, ПоляПотреблений + ", ДокументИсточник");
		
	// ОстатокДляРаспределения <- ДопРасходыБезПартии
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ОстатокДляРаспределения, ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ОстатокДляРаспределения,
		Перечисления.ТипыЗаписейПартий.ДопРасходыБезПартии, ПоляПотреблений + ", ДокументИсточник");
	
	// ПартияСгруппированная <- Партия, ДопРасходы, ДопРасходыБезПартии, ДопРасходыСПартией, КорректировкаСтоимости, ОтклонениеВСтоимости, Выпуск, Перемещение
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПартияСгруппированная, ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,
		Перечисления.ТипыЗаписейПартий.Партия, ПоляПотреблений + ", Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,
		Перечисления.ТипыЗаписейПартий.ДопРасходы, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,
		Перечисления.ТипыЗаписейПартий.ДопРасходыБезПартии, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,
		Перечисления.ТипыЗаписейПартий.ДопРасходыСПартией, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,
		Перечисления.ТипыЗаписейПартий.КорректировкаСтоимости, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,
		Перечисления.ТипыЗаписейПартий.ОтклонениеВСтоимости, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,
		Перечисления.ТипыЗаписейПартий.Выпуск, ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,
		Перечисления.ТипыЗаписейПартий.Перемещение, ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,
		Перечисления.ТипыЗаписейПартий.БазаДопРасходыРегл, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,
		Перечисления.ТипыЗаписейПартий.БазаДопРасходыУпр, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,
		Перечисления.ТипыЗаписейПартий.ПартииДляРаспределения, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,
		Перечисления.ТипыЗаписейПартий.ПартииВПути, ПоляПотреблений + ", ДокументИсточник");
	
	// Потребление <- (ОстатокСгруппированный, Партия, ДопРасходы, ДопРасходыБезПартии, ДопРасходыСПартией,
	// КорректировкаПриобретенияПрошлогоПериода, Перемещение, ПеремещениеОбособленно, Сторно, СторноВозврата, СторноПотребления,
	// ВозвратПрошлыхПериодов, ВозвратБезДокументаИсточника).
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Потребление, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный,		ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,		ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.Перемещение, ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно, ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.Сторно, 		ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.СторноВозврата, ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.СторноПотребления, ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.ВозвратПрошлыхПериодов, ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.ИсправлениеПрошлогоПериода, ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.ВозвратБезДокументаИсточника, ПоляПотреблений + ", Регистратор");
		
	// ПотреблениеТоварыВПути <- (ПеремещениеТоварыВПути, Перемещение).
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПотреблениеТоварыВПути, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, 
		Перечисления.ТипыЗаписейПартий.ПотреблениеТоварыВПути, Перечисления.ТипыЗаписейПартий.ПеремещениеТоварыВПути,
		ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, 
		Перечисления.ТипыЗаписейПартий.ПотреблениеТоварыВПути, Перечисления.ТипыЗаписейПартий.Перемещение, 
		ПоляПотреблений + ", Регистратор");
		
	// ПотреблениеАвто <- (ОстатокСгруппированный, ПартияСгруппированная, Перемещение, ПеремещениеОбособленно, Сторно, СторноВозврата,
	// СторноПотребления, ДопРасходы).
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПотреблениеАвто, 		ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный,				ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,		ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.Перемещение, 		ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно, 		ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.Сторно, 				ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.СторноВозврата, 		ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.СторноПотребления,	ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.ДопРасходы,			ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.ИсправлениеПрошлогоПериода, ПоляПотреблений + ", Регистратор");	
		
	// СписаниеНаДругиеПартии <- (ОстатокСгруппированный, Партия, ДопРасходы, ДопРасходыБезПартии, ДопРасходыСПартией,
	// КорректировкаПриобретенияПрошлогоПериода, Перемещение, ПеремещениеОбособленно, Сторно, СторноВозврата, СторноПотребления,
	// ВозвратПрошлыхПериодов)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.СписаниеНаДругиеПартии, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписаниеНаДругиеПартии,
		Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный,		ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписаниеНаДругиеПартии,
		Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,		ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписаниеНаДругиеПартии,
		Перечисления.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписаниеНаДругиеПартии,
		Перечисления.ТипыЗаписейПартий.Перемещение, ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписаниеНаДругиеПартии,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно, ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписаниеНаДругиеПартии,
		Перечисления.ТипыЗаписейПартий.Сторно, 		ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписаниеНаДругиеПартии,
		Перечисления.ТипыЗаписейПартий.СторноВозврата, ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписаниеНаДругиеПартии,
		Перечисления.ТипыЗаписейПартий.СторноПотребления, ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписаниеНаДругиеПартии,
		Перечисления.ТипыЗаписейПартий.ВозвратПрошлыхПериодов, ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписаниеНаДругиеПартии,
		Перечисления.ТипыЗаписейПартий.ИсправлениеПрошлогоПериода, ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписаниеНаДругиеПартии,
		Перечисления.ТипыЗаписейПартий.СторноСписанияНаДругиеПартии, ПоляПотреблений + ", Регистратор");
		
	// СторноСписанияНаДругиеПартии <- (СписаниеНаДругиеПартии)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.СторноСписанияНаДругиеПартии, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СторноСписанияНаДругиеПартии,
		Перечисления.ТипыЗаписейПартий.СписаниеНаДругиеПартии, ПоляПотреблений + ", Регистратор");	
		
	// КорректировкаПриобретения <- (ОстатокСгруппированный, ПартияСгруппированная, ВозвратПрошлыхПериодов)	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.КорректировкаПриобретения, ПоляПотреблений);
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.КорректировкаПриобретения,
		Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный, 				 ПоляПотреблений);
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.КорректировкаПриобретения,
		Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,			 	 ПоляПотреблений);
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.КорректировкаПриобретения,
		Перечисления.ТипыЗаписейПартий.ВозвратПрошлыхПериодов,	 ПоляПотреблений);	
		
	// ИсправлениеПеремещенияПрошлогоПериода <- (ОстатокСгруппированный, ПартияСгруппированная, ВозвратПрошлыхПериодов)	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ИсправлениеПеремещенияПрошлогоПериода, ПоляПотреблений);
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ИсправлениеПеремещенияПрошлогоПериода,
		Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный, 				 ПоляПотреблений);
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ИсправлениеПеремещенияПрошлогоПериода,
		Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,			 	 ПоляПотреблений);
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ИсправлениеПеремещенияПрошлогоПериода,
		Перечисления.ТипыЗаписейПартий.ВозвратПрошлыхПериодов,	 ПоляПотреблений);	
		
	// Сторно <- (Потребление, ПотреблениеАвто, Прошлое)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Сторно, 		"ДокументИсточник, КорАналитикаУчетаНоменклатуры, КорВидЗапасов");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Сторно,
		Перечисления.ТипыЗаписейПартий.Потребление, "Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Сторно,
		Перечисления.ТипыЗаписейПартий.ПотреблениеАвто, "Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Сторно,
		Перечисления.ТипыЗаписейПартий.Прошлое, 	"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
		
	// СторноПотребления <- (Потребление)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.СторноПотребления, "ДокументИсточник, АналитикаУчетаНоменклатуры, ВидЗапасов");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СторноПотребления,
		Перечисления.ТипыЗаписейПартий.Потребление, "Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
	
	// СторноВозврата <- (Сторно, СторноВозвратНаДругойСклад)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.СторноВозврата,	"ДокументИсточник, АналитикаУчетаНоменклатуры, ВидЗапасов");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СторноВозврата,
		Перечисления.ТипыЗаписейПартий.Сторно, "Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СторноВозврата,
		Перечисления.ТипыЗаписейПартий.СторноВозвратНаДругойСклад, "Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
		
	// СторноВозвратНаДругойСклад <- (Потребление, ПотреблениеАвто, Прошлое)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.СторноВозвратНаДругойСклад,	"ДокументИсточник, КорАналитикаУчетаНоменклатуры, КорВидЗапасов");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СторноВозвратНаДругойСклад,
		Перечисления.ТипыЗаписейПартий.Потребление,					"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СторноВозвратНаДругойСклад,
		Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,				"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СторноВозвратНаДругойСклад,
		Перечисления.ТипыЗаписейПартий.Прошлое,						"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
		
	// ВозвратБезДокументаИсточника <- (Потребление)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ВозвратБезДокументаИсточника, ПоляПотреблений);
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ВозвратБезДокументаИсточника,
		Перечисления.ТипыЗаписейПартий.Потребление, 				 ПоляПотреблений);
		
	// СписаниеОстаткаБезПартии <- (Потребление, Остаток, СторноСписанияОстаткаБезПартии, ИсправлениеПрошлогоПериода)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.СписаниеОстаткаБезПартии, ПоляПотреблений);
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписаниеОстаткаБезПартии,
		Перечисления.ТипыЗаписейПартий.Потребление, 				 ПоляПотреблений);
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписаниеОстаткаБезПартии,
		Перечисления.ТипыЗаписейПартий.Остаток, 					 ПоляПотреблений);
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписаниеОстаткаБезПартии,
		Перечисления.ТипыЗаписейПартий.СторноСписанияОстаткаБезПартии, ПоляПотреблений);
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписаниеОстаткаБезПартии,
		Перечисления.ТипыЗаписейПартий.ИсправлениеПрошлогоПериода,	 ПоляПотреблений);
		
	// СторноСписанияОстаткаБезПартии <- (СписаниеОстаткаБезПартии)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.СторноСписанияОстаткаБезПартии, 	"ДокументИсточник, АналитикаУчетаНоменклатуры, ВидЗапасов");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СторноСписанияОстаткаБезПартии,
		Перечисления.ТипыЗаписейПартий.СписаниеОстаткаБезПартии, "Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
	
	// ВозвратНаДругойСклад <- (СторноВозвратНаДругойСклад, СторноВозврата)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ВозвратНаДругойСклад,
		"Регистратор, АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ВозвратНаДругойСклад,
		Перечисления.ТипыЗаписейПартий.СторноВозвратНаДругойСклад,
		"Регистратор, АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ВозвратНаДругойСклад,
		Перечисления.ТипыЗаписейПартий.СторноВозврата,
		"Регистратор, АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС");
		
	// Распределение <- (Перемещение, ПеремещениеОбособленно, ОстатокСгруппированный, ПартияСгруппированная, ВозвратПрошлыхПериодов, Распределение)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Распределение,
		"АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.Перемещение,
		"АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно,
		"АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный,
		"АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,
		"АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.ВозвратПрошлыхПериодов,
		"АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.Распределение,
		"АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Регистратор");
 	
	// Перемещение <- (Потребление, ПотреблениеАвто, ПотреблениеПроизводство, ВозвратНаДругойСклад, СписаниеНаДругиеПартии).
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Перемещение,
		"ДокументИсточник, Партия, АналитикаУчетаНоменклатуры, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Организация");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Перемещение,
		Перечисления.ТипыЗаписейПартий.Потребление,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС, Организация");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Перемещение,
		Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС, Организация");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Перемещение,
		Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС, Организация");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Перемещение,
		Перечисления.ТипыЗаписейПартий.ВозвратНаДругойСклад,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС, Организация");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Перемещение,
		Перечисления.ТипыЗаписейПартий.СписаниеНаДругиеПартии,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС, Организация");
	
	// ПеремещениеТоварыВПути <- (ПотреблениеТоварыВПути, Потребление).
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПеремещениеТоварыВПути,
		"ДокументИсточник, Партия, АналитикаУчетаНоменклатуры, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета,
		|ВидДеятельностиНДС, Организация");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, 
		Перечисления.ТипыЗаписейПартий.ПеремещениеТоварыВПути,
		Перечисления.ТипыЗаписейПартий.ПотреблениеТоварыВПути,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов,
		|КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС, Организация");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, 
		Перечисления.ТипыЗаписейПартий.ПеремещениеТоварыВПути,
		Перечисления.ТипыЗаписейПартий.Потребление,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов,
		|КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС, Организация");
		
	// ПеремещениеОбособленно <- (Потребление)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно,
		"ДокументИсточник, Партия, АналитикаУчетаНоменклатуры, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Организация");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно,
		Перечисления.ТипыЗаписейПартий.Потребление,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС, КорОрганизация");
		
	// ПеремещениеАвто <- (Потребление, ПотреблениеПроизводство, ПотреблениеАвто, Распределение).
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПеремещениеАвто,
		"ДокументИсточник, Партия, АналитикаУчетаНоменклатуры, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеАвто,
		Перечисления.ТипыЗаписейПартий.Потребление,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеАвто,
		Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеАвто,
		Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеАвто,
		Перечисления.ТипыЗаписейПартий.Распределение,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеАвто,
		Перечисления.ТипыЗаписейПартий.СписаниеНаДругиеПартии,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС");
		
	// СписанияНаВыпуск <- (Перемещение, ПеремещениеОбособленно, ПеремещениеАвто, ПартияСгруппированная, ОстатокСгруппированный).
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск, ПоляПотреблений + ",Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		Перечисления.ТипыЗаписейПартий.Перемещение, ПоляПотреблений + ",Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно, ПоляПотреблений + ",Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		Перечисления.ТипыЗаписейПартий.ПеремещениеАвто, ПоляПотреблений + ",Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		Перечисления.ТипыЗаписейПартий.ПартияСгруппированная, ПоляПотреблений + ",Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный, ПоляПотреблений + ",Партия");
		
	// Выпуск <- (СписанияНаВыпуск, Потребление)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Выпуск,
		"Регистратор, Партия, АналитикаУчетаНоменклатуры, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Выпуск,
		Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Выпуск,
		Перечисления.ТипыЗаписейПартий.Потребление,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС");	
	// Также эта связь используется в ТекстДвиженияСебестоимостиТоваров()
		
	// ПотреблениеПроизводство <- (ПартияСгруппированная, Перемещение, ПеремещениеОбособленно, ОстатокСгруппированный)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство, "АналитикаУчетаНоменклатуры, Организация, РазделУчета, ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство,
		Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,   "АналитикаУчетаНоменклатуры, Организация, РазделУчета, Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство,
		Перечисления.ТипыЗаписейПартий.Перемещение, 		"АналитикаУчетаНоменклатуры, Организация, РазделУчета, Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно, "АналитикаУчетаНоменклатуры, Организация, РазделУчета, Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство,
		Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный, "АналитикаУчетаНоменклатуры, Организация, РазделУчета, Регистратор");
		
	// СписаниеНаРасходы <- (ПартияСгруппированная)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.СписаниеНаРасходы, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписаниеНаРасходы,
		Перечисления.ТипыЗаписейПартий.ПартияСгруппированная, ПоляПотреблений + ", Регистратор");
		
	// ВозвратПрошлыхПериодов <- (Прошлое)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ВозвратПрошлыхПериодов, "ДокументИсточник, КорАналитикаУчетаНоменклатуры, КорВидЗапасов, Организация, РазделУчета");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ВозвратПрошлыхПериодов,
		Перечисления.ТипыЗаписейПартий.Прошлое, 			   "Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, РазделУчета");
		
	// СторноВозвратаПрошлыхПериодов <- (ВозвратПрошлыхПериодов)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.СторноВозвратаПрошлыхПериодов, "ДокументИсточник, КорАналитикаУчетаНоменклатуры, КорВидЗапасов, Организация, РазделУчета");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СторноВозвратаПрошлыхПериодов,
		Перечисления.ТипыЗаписейПартий.ВозвратПрошлыхПериодов, 		  "Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, РазделУчета");
		
	// ИсправлениеТекущегоПериода <- (Перемещение)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ИсправлениеТекущегоПериода, "ДокументИсточник, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, РазделУчета");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ИсправлениеТекущегоПериода,
		Перечисления.ТипыЗаписейПартий.Перемещение, "Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, РазделУчета");	
		
	// Дополнение, ОтклонениеВСтоимости, РаспределениеПоВыбывшимТоварам, ПеремещениеУпр <- (<без источников - для формирования записей по
	// данным запроса>).
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеДополнения(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Дополнение);
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеДополнения(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ВключениеИсключениеНДСВСтоимости);
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеДополнения(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ОтклонениеВСтоимости);
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеДополнения(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам);
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеДополнения(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеУпр);
	
	#Область БазаДопРасходыРегл
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ДопРасходыДляРаспределенияРегл);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.БазаДопРасходыРегл,
		"Организация, СтатьяРасходовАктивов, АналитикаРасходов, Подразделение, НаправлениеДеятельности",
		Источники);
	
	#КонецОбласти
	
	#Область БазаДопРасходыУпр
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ДопРасходыДляРаспределенияУпр);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.БазаДопРасходыУпр,
		"Организация, СтатьяРасходовАктивов, АналитикаРасходов, Подразделение, НаправлениеДеятельности",
		Источники);
	
	#КонецОбласти
	
	#Область ПартииДляРаспределения
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.БазаДопРасходыРегл);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.БазаДопРасходыУпр);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПартииДляРаспределения,
		ПоляПотреблений + ", Регистратор",
		Источники,
		ПоляПотреблений + ", ДокументИсточник");
		
	#КонецОбласти
	
	#Область ПартииВПути
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.БазаДопРасходыРегл);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.БазаДопРасходыУпр);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПартииВПути,
		"КорАналитикаУчетаНоменклатуры, Организация, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС",
		Источники,
		ПоляПотреблений);
		
	#КонецОбласти
	
	Возврат ОписаниеЦепочек;
	
КонецФункции

Функция ОписаниеДвиженийПартийНДС(ПараметрыРасчета)
	
	КолонкиТаблицыРаспределения = ТаблицаДляРаспределенияПартийНДС(ПараметрыРасчета).Колонки;
	
	ОписаниеДвижений = РасчетСебестоимостиПрикладныеАлгоритмы.ОписаниеДвижений();
	ОписаниеДвижений.Вставить("Контекст", "ПодготовкаДанныхДляУчетаНДСиУСН");
	ОписаниеДвижений.Вставить("ИмяВременнойТаблицы", "ВТДетализацияПартийТоваровДляНДСиУСН");
	ОписаниеДвижений.Вставить("ПоляРасчета", РасчетСебестоимостиПрикладныеАлгоритмы.ПереченьПолей(КолонкиТаблицыРаспределения));
	ОписаниеДвижений.Вставить("КлючиСравнения",	ПоляПотребленийПартииНДС(ПараметрыРасчета));
	ОписаниеДвижений.Вставить("Показатели", "Знаменатель, ЗнаменательДляИсточников, Количество, СтоимостьБезНДС, НДС, СтоимостьБезНДСУпр, НДСУпр");
	ОписаниеДвижений.Вставить("БазисПрихода", "Знаменатель");
	ОписаниеДвижений.Вставить("БазисРасхода", "Знаменатель");
	ОписаниеДвижений.Вставить("КлючРасхода", "ДокументИсточник");
	ОписаниеДвижений.Вставить("ПолеПорядка", "Период");
	ОписаниеДвижений.Вставить("ПоляСортировки", "Партия");
	ОписаниеДвижений.Вставить("СортировкаПоУсловию", Истина);

	ОписаниеДвижений.Вставить("ПоляСуммирования", "Количество, СтоимостьБезНДС, НДС, СтоимостьБезНДСУпр, НДСУпр");
	ОписаниеДвижений.Вставить("ИсключенияПоляСуммирования", "Знаменатель, ЗнаменательДляИсточников");
	ОписаниеДвижений.Вставить("ПоляГруппировки", 
		РасчетСебестоимостиПрикладныеАлгоритмы.ПереченьПолей(КолонкиТаблицыРаспределения, ОписаниеДвижений.ПоляСуммирования));
	ОписаниеДвижений.Вставить("ЕстьСторно", Истина);
	ОписаниеДвижений.Вставить("ЕстьИсправления", Истина);
	ОписаниеДвижений.Вставить("УменьшатьБазис", Истина);
	ОписаниеДвижений.Вставить("УдалятьСтрокиБезИсточников", Истина);
	
	ОписаниеДвижений.Вставить("ВременныеТаблицыДляСледующихЭтапов",
		"ПриходыТоваровНДС, ВТДопРасходыДляРаспределения, ВТБазаРаспределенияДопРасходов, ВТБазаРаспределенияДопРасходовСводно");
	
	Возврат ОписаниеДвижений;
	
КонецФункции

Функция ОписаниеНезаписываемыхПартийНДС(ПараметрыРасчета)
	
	НезаписываемыеТипыЗаписей = Новый Соответствие;
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.Остаток,   Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.Прошлое,   Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный, Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.ПартияСгруппированная, Истина);
	
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.БазаДопРасходыРегл, 	  		  Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.БазаДопРасходыУпр, 		  	  Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.ДопРасходыДляРаспределенияРегл, Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.ДопРасходыДляРаспределенияУпр,  Истина);
	
	НезаписываемыеРазделы = Новый Соответствие;
	
	Возврат РасчетСебестоимостиПрикладныеАлгоритмы.ОписаниеНезаписываемыхДанных(Ложь, НезаписываемыеТипыЗаписей, НезаписываемыеРазделы);
	
КонецФункции

Функция ТаблицаДляРаспределенияПартийНДС(ПараметрыРасчета)
	
	Возврат РасчетСебестоимостиПрикладныеАлгоритмы.ТаблицаДляРаспределенияПартий(ПараметрыРасчета,	ТекстОписаниеДанныхДляПартийНДСиУСН());
	
КонецФункции

// Выборка данных

Процедура ПолучитьДанныеДляПартийНДС(ПараметрыРасчета)
	
	ПараметрыНумерации = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		"АналитикаУчетаНоменклатуры", // разделитель
		"Знаменатель, Количество, СтоимостьБезНДС, НДС, НДСУпр", // ресурсы
		"АналитикаУчетаНоменклатуры, Период, Приоритет ВОЗР, РазделУчета, Организация, АналитикаУчетаНоменклатуры, Партия, Регистратор"); // порядок
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьДанныеЭтапаРасчета(
		ПараметрыРасчета,
		ТекстЗапросаДляПартийНДС(ПараметрыРасчета),
		ПараметрыНумерации);
	
	СкорректироватьАналитикиУчетаПартийДляПартийНДС(ПараметрыРасчета);
	
КонецПроцедуры

Процедура СкорректироватьАналитикиУчетаПартийДляПартийНДС(ПараметрыРасчета)
	
	ТекстЗапроса = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий
	|ИЗ
	|	Данные КАК Т";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.СкорректироватьАналитикиУчетаПартийПриРасчете(ПараметрыРасчета, ТекстЗапроса);
	
КонецПроцедуры

// Тексты запросов

// ... общий

Функция ТекстЗапросаДляПартийНДС(ПараметрыРасчета = Неопределено) Экспорт
	
	ТекстЗапроса = ""
		// подготовка временных таблиц
		+ ТекстИнициализацияПартийНДС() // вт ПриходыТоваров, СписаниеОтклоненийВСтоимости, ОстаткиТоваров, ПрошлыеРеализацииПартийНДС
		+ ОбщегоНазначения.РазделительПакетаЗапросов() + ТекстИсправленныеДокументыНДС() // вт ИсправленныеДокументыНДС
		+ ОбщегоНазначения.РазделительПакетаЗапросов() + ТекстКорректировкиДоВводаОстатков() // вт КорректировкиДоВводаОстатков
		+ ОбщегоНазначения.РазделительПакетаЗапросов() + ТекстПриходыТоваровНДС() // вт ПриходыТоваровНДС
		+ ОбщегоНазначения.РазделительПакетаЗапросов() + ТекстОстаткиСебестоимостиТоваров() // вт ОстаткиСебестоимостиТоваров
		+ ОбщегоНазначения.РазделительПакетаЗапросов() + ТекстВТНачальныеОстаткиПартийНДС() // вт ВТНачальныеОстаткиПартийНДС
		+ ОбщегоНазначения.РазделительПакетаЗапросов() + ТекстДвиженияСебестоимостиНДС() // вт ДвиженияСебестоимостиНДС, использует ИсправленныеДокументыНДС
		+ ОбщегоНазначения.РазделительПакетаЗапросов() + ТекстПрошлыеРеализацииСебестоимость() // вт ПрошлыеРеализацииСебестоимость
		+ ОбщегоНазначения.РазделительПакетаЗапросов() + ТекстАналитикиУчетаПартийТаможенныхДеклараций() // ВТИзменениеВидаДеятельностиДопРасходов
		+ ОбщегоНазначения.РазделительПакетаЗапросов() + ТекстРаспределениеДопРасходов()
		+ ОбщегоНазначения.РазделительПакетаЗапросов()
		// выборка данных
		+ ТекстОписаниеДанныхДляПартийНДСиУСН() //вт Данные
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстДетальныеНачальныеОстаткиПартийНДС() // использует ВТНачальныеОстаткиПартийНДС
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстНачальныеОстаткиПартийНДС() // использует ВТНачальныеОстаткиПартийНДС
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстНачальныеОстаткиПартийДляДопРасходов() // использует ВТНачальныеОстаткиПартийНДС
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстДетальныеПриходыСебестоимостиТоваров() // использует ПриходыТоваровНДС
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстПриходыСебестоимостиТоваров() // использует ПриходыТоваровНДС
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстПриходыСебестоимостиТоваровДляДопРасходов() // использует ПриходыТоваровНДС
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстПриходыСебестоимостиТоваровВПути()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстДвиженияСебестоимостиТоваров()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстДвиженияСебестоимостиТоваровСборка()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстВозвратыПрошлыхПериодов()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстРеализацииПрошлыхМесяцевПартииНДС() // использует ПрошлыеРеализации
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстРеализацииПрошлыхМесяцевПартииНДС21() // использует ПрошлыеРеализации
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстТаможенныеДекларацииИзменениеВидыДеятельностиНДС()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстСторноДвиженияИсправленныхДокументовПрошлогоПериодаНДС() // использует ИсправленныеДокументыНДС
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстДопРасходыСредняяДляРаспределенияРегл() // использует ИсправленныеДокументыНДС
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстБазаДопРасходыСредняяРегл() // использует ИсправленныеДокументыНДС
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстДопРасходыСредняяДляРаспределенияУпр() // использует ИсправленныеДокументыНДС
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстБазаДопРасходыСредняяУпр() // использует ИсправленныеДокументыНДС
		+ "";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаДляДетализацииПартийТоваровДляНДСиУСН(ПараметрыРасчета = Неопределено) Экспорт
	
	ТекстЗапроса = ""
		// выборка данных
		+ ТекстОписаниеДанныхДляПартийНДСиУСН() //вт Данные
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстДанныеДляДетализацииПартийТоваровДляНДСиУСН()
		+ "";
		
	Возврат ТекстЗапроса;
	
КонецФункции

// ... описания данных

Функция ТекстОписаниеДанныхДляПартийНДСиУСН()
	ТекстЗапроса = 
		"ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80)) 					КАК ЗапросИсточник,
		|	ДД.ТипЗаписи 									КАК ТипЗаписи,
		|	ЛОЖЬ											КАК ЭтоСторно,
		|	0 												КАК Приоритет,
		|	0 												КАК Знаменатель,
		|	0 												КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ 											КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) 	КАК Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС 		КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|
		|	ДД.Количество,
		|	ДД.СтоимостьБезНДС,
		|	ДД.НДС,
		|	ДД.НДСУпр КАК СтоимостьБезНДСУпр,
		|	ДД.НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.РазделУчета КАК КорРазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ДД.Организация КАК КорОрганизация,
		|	ДД.Партия КАК КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	ДД.СтатьяРасходовАктивов КАК КорСтатьяРасходов,
		|	ДД.АналитикаРасходов КАК КорАналитикаРасходов,
		|	ДД.Подразделение КАК КорПодразделение,
		|	ДД.ДокументИсточник,
		|	ДД.СтатьяСписанияНДС,
		|	ДД.АналитикаСписанияНДС,
		|	ДД.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.Сторно
		|ПОМЕСТИТЬ Данные
		|ИЗ
		|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН КАК ДД
		|";
		
	ТекстЗапроса = РасчетСебестоимостиПрикладныеАлгоритмы.ПодготовитьЗапросОписанияДанных(ТекстЗапроса);
	
	Возврат ТекстЗапроса;
	 
КонецФункции

// ... формирования временные таблиц

Функция ТекстИнициализацияПартийНДС() // вт ПриходыТоваров, СписаниеОтклоненийВСтоимости, ОстаткиТоваров, ПрошлыеРеализацииПартийНДС
	Возврат
		"ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.Организация В (&ОрганизацииСФИФОСкользящая)
		|			ТОГДА ДД.Партия
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
		|		  И ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.ЗаявлениеОВвозеТоваров)
		|		  И ТИПЗНАЧЕНИЯ(ДД.АналитикаРасходов) = ТИП(Документ.ПоступлениеТоваровНаСклад)
		|		  И ДД.АналитикаРасходов <> ЗНАЧЕНИЕ(Документ.ПоступлениеТоваровНаСклад.ПустаяСсылка)
		|			ТОГДА ДД.АналитикаРасходов
		|		КОГДА НЕ Корректировка.ДокументОснование ЕСТЬ NULL
		|			ТОГДА Корректировка.ДокументОснование
		|		КОГДА НЕ ВводОстатковТоваров.Партия ЕСТЬ NULL
		|			ТОГДА ВводОстатковТоваров.Партия
		|		КОГДА НЕ ВводОстатков.Партия ЕСТЬ NULL
		|			ТОГДА ВводОстатков.Партия
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ) КАК Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	СУММА(ДД.Количество) КАК Количество
		|ПОМЕСТИТЬ ПриходыТоваров
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК Корректировка
		|		ПО Корректировка.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВводОстатков КАК ВводОстатков
		|		ПО ВводОстатков.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВводОстатковТоваров КАК ВводОстатковТоваров
		|		ПО ВводОстатковТоваров.Ссылка = ДД.Регистратор
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.Количество > 0
		|	И ДД.СлужебноеВидДвиженияПриход
		|	И ДД.ТипЗаписи <> ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|	И НЕ ДД.Сторно
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.Организация В (&ОрганизацииСФИФОСкользящая)
		|			ТОГДА ДД.Партия
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
		|		  И ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.ЗаявлениеОВвозеТоваров)
		|		  И ТИПЗНАЧЕНИЯ(ДД.АналитикаРасходов) = ТИП(Документ.ПоступлениеТоваровНаСклад)
		|		  И ДД.АналитикаРасходов <> ЗНАЧЕНИЕ(Документ.ПоступлениеТоваровНаСклад.ПустаяСсылка)
		|			ТОГДА ДД.АналитикаРасходов
		|		КОГДА НЕ Корректировка.ДокументОснование ЕСТЬ NULL
		|			ТОГДА Корректировка.ДокументОснование
		|		КОГДА НЕ ВводОстатковТоваров.Партия ЕСТЬ NULL
		|			ТОГДА ВводОстатковТоваров.Партия
		|		КОГДА НЕ ВводОстатков.Партия ЕСТЬ NULL
		|			ТОГДА ВводОстатков.Партия
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ),
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС
		|ИНДЕКСИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.Регистратор,
		|	СУММА(ДД.Количество) КАК Количество
		|ПОМЕСТИТЬ ПриходыСборокТоваров
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.Количество > 0
		|	И ДД.СлужебноеВидДвиженияПриход
		|	И ДД.Регистратор ССЫЛКА Документ.СборкаТоваров
		|	И НЕ ДД.Сторно
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.Регистратор
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	СУММА(ДД.ДопРасходыРегл)	КАК ДопРасходыРегл,
		|	СУММА(ДД.НДСРегл)			КАК НДСРегл,
		|	СУММА(ДД.ДопРасходыУпр)		КАК ДопРасходыУпр,
		|	СУММА(ДД.НДСУпр)			КАК НДСУпр
		|ПОМЕСТИТЬ СписаниеОтклоненийВСтоимости
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
		|	И НЕ ДД.СлужебноеВидДвиженияПриход
		|	И НЕ ДД.Сторно
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.КоличествоОстаток КАК Количество
		|ПОМЕСТИТЬ ОстаткиТоваров
		|ИЗ
		|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН.Остатки(&ГраницаКонецПредыдущегоПериода,
		|		Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)) КАК ДД
		|ГДЕ
		|	ДД.КоличествоОстаток > 0
		|ИНДЕКСИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.ДокументИсточник,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС
		|	КОНЕЦ КАК ВидДеятельностиНДС,
		|	СУММА(ДД.Количество) КАК Количество
		|ПОМЕСТИТЬ ПрошлыеРеализацииПартийНДС
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов)
		|	И ДД.Количество <> 0
		|	И НЕ ДД.Сторно
		|СГРУППИРОВАТЬ ПО
		|	ДД.ДокументИсточник,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС
		|	КОНЕЦ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Т.Ссылка КАК Ссылка,
		|	Т.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	Т.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
		|	Т.АналитикаУчетаНоменклатуры.Серия КАК Серия
		|ПОМЕСТИТЬ ВТПередачиБезНДС
		|ИЗ
		|	Документ.ПередачаТоваровМеждуОрганизациями.ВидыЗапасов КАК Т
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями КАК Передачи
		|		ПО Т.Ссылка = Передачи.Ссылка
		|ГДЕ
		|	Передачи.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И Передачи.Организация В (&МассивОрганизаций)
		|	И Передачи.Проведен
		|	И Т.СтавкаНДС = ЗНАЧЕНИЕ(Справочник.СтавкиНДС.БезНДС)
		|ИНДЕКСИРОВАТЬ ПО
		|	Ссылка
		|";
КонецФункции

Функция ТекстИсправленныеДокументыНДС() // вт ИсправленныеДокументыНДС
	Возврат "	
		|ВЫБРАТЬ
		|	Реестр.СторнируемыйДокумент КАК ДокументИсточник,
		|	РеестрИсточника.ДатаДокументаИБ КАК ДатаДокументаИсточника,
		|	МАКСИМУМ(ВЫБОР КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ИсправлениеПеремещенияПрошлогоПериода)
		|		ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ) КАК ИсправлениеПеремещения,
		|	ДД.Период,
		|	ДД.Регистратор
		|ПОМЕСТИТЬ ИсправленныеДокументыНДС
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.РеестрДокументов КАК Реестр
		|		ПО Реестр.Ссылка = ДД.Регистратор
		|		И Реестр.Организация = ДД.Организация
		|		И (НЕ Реестр.ДополнительнаяЗапись ИЛИ Реестр.ТипСсылки В (&ДокументыСДвумяОрганизациями))
		|		И Реестр.Ссылка <> НЕОПРЕДЕЛЕНО
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.РеестрДокументов КАК РеестрИсточника
		|		ПО РеестрИсточника.Ссылка = Реестр.СторнируемыйДокумент
		|		И РеестрИсточника.Организация = ДД.Организация
		|		И (НЕ РеестрИсточника.ДополнительнаяЗапись ИЛИ РеестрИсточника.ТипСсылки В (&ДокументыСДвумяОрганизациями))
		|		И РеестрИсточника.Ссылка <> НЕОПРЕДЕЛЕНО
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.Сторно
		|	И ДД.ДокументИсточник <> ДД.Регистратор
		|СГРУППИРОВАТЬ ПО
		|	Реестр.СторнируемыйДокумент,
		|	РеестрИсточника.ДатаДокументаИБ,
		|	ДД.Период,
		|	ДД.Регистратор
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	СУММА(ДД.Количество) КАК Знаменатель
		|ПОМЕСТИТЬ ЗнаменателиИсправленныхДокументовНДС
		|ИЗ
		|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИсправленныеДокументыНДС КАК ИсправленныеДокументы
		|		ПО ИсправленныеДокументы.ДокументИсточник = ДД.Регистратор
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.Активность
		|	И ДД.Период < &НачалоПериода
		|	И ДД.ТипЗаписи <> ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы)
		|	И НЕ ДД.Сторно
		|	И ДД.Количество <> 0
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС
		|ИНДЕКСИРОВАТЬ ПО
		|	Организация,
		|	Партия
		|";
КонецФункции

Функция ТекстКорректировкиДоВводаОстатков()

	Возврат "
	|ВЫБРАТЬ
	|	ДД.Регистратор КАК Регистратор,
	|	ДД.ИдентификаторФинЗаписи
	|ПОМЕСТИТЬ КорректировкиДоВводаОстатковПредварительная
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаРеализации КАК Корректировка
	|		ПО ДД.Регистратор = Корректировка.Ссылка
	|ГДЕ
	|	ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
	|	И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаДоВводаОстатков)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|
	|ВЫБРАТЬ
	|	ДД.Регистратор КАК Регистратор,
	|	ДД.ИдентификаторФинЗаписи,
	|	ДвиженияПоНДС.СуммаБезНДС
	|ПОМЕСТИТЬ КорректировкиДоВводаОстатков
	|ИЗ
	|	КорректировкиДоВводаОстатковПредварительная КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|		ПО ДД.Регистратор = ДвиженияПоНДС.Регистратор
	|		И ДД.ИдентификаторФинЗаписи = ДвиженияПоНДС.ИдентификаторФинЗаписи
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|
	|";
	
КонецФункции

Функция ТекстПриходыТоваровНДС() // вт ПриходыТоваровНДС, использует ИсправленныеДокументыНДС
	Возврат "
		|ВЫБРАТЬ
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход
		|			И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|		ИНАЧЕ ДД.ТипЗаписи КОНЕЦ) КАК ТипЗаписи,
		|	ЛОЖЬ КАК ЭтоСторно,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|		 ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА НЕ ИсправленныеДокументы.ДокументИсточник ЕСТЬ NULL
		|			ТОГДА ИсправленныеДокументы.ДокументИсточник
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
		|		  И ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.ЗаявлениеОВвозеТоваров)
		|		  И ТИПЗНАЧЕНИЯ(ДД.АналитикаРасходов) = ТИП(Документ.ПоступлениеТоваровНаСклад)
		|		  И ДД.АналитикаРасходов <> ЗНАЧЕНИЕ(Документ.ПоступлениеТоваровНаСклад.ПустаяСсылка)
		|			ТОГДА ДД.АналитикаРасходов
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
		|		 И ДД.ХозяйственнаяОперация В
		|		  (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСФактуровкаПоставки),
		|		   ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщикаФактуровкаПоставки))
		|			ТОГДА ДД.АналитикаРасходов
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
		|		  И ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.ЗаявлениеОВвозеТоваров)
		|		  И ДД.ДокументИсточник <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.ДокументИсточник
		|		КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|			ТОГДА ВЫБОР
		|				КОГДА ТИПЗНАЧЕНИЯ(ДД.ДокументИсточник) = ТИП(Документ.ВводОстатковТоваров)
		|					ТОГДА ЕСТЬNULL(ВводОстатковТоваров.Партия,
		|						ЕСТЬNULL(ДопРасходыКорректировка.ДокументОснование, ДД.ДокументИсточник))
		|				ИНАЧЕ ЕСТЬNULL(ВводОстатков.Партия,
		|					ЕСТЬNULL(ДопРасходыКорректировка.ДокументОснование, ДД.ДокументИсточник))
		|			КОНЕЦ
		|		КОГДА НЕ Корректировка.ДокументОснование ЕСТЬ NULL
		|			ТОГДА Корректировка.ДокументОснование
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ) КАК Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам))
		|		И ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		КОГДА ДД.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия) И ДД.Количество = 0
		|		 И ДД.КорАналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		ИНАЧЕ ДД.АналитикаУчетаПартий КОНЕЦ) КАК АналитикаУчетаПартий,
		|	(ВЫБОР
		|		КОГДА НЕ ИсправленныеДокументы.ДокументИсточник ЕСТЬ NULL
		|			ТОГДА ИсправленныеДокументы.ДокументИсточник
		|		КОГДА НЕ Корректировка.ВидКорректировки ЕСТЬ NULL
		|		 И Корректировка.ВидКорректировки <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон)
		|			ТОГДА Корректировка.ДокументОснование
		|		КОГДА НЕ СчетФактура.Исправление ЕСТЬ NULL И СчетФактура.Исправление
		|			ТОГДА СчетФактура.СчетФактураОснование
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ) КАК ДокументПоступления,
		|
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(
		|		ВЫБОР КОГДА НЕ КорректировкиДоВводаОстатков.Регистратор ЕСТЬ NULL
		|		ТОГДА КорректировкиДоВводаОстатков.СуммаБезНДС
		|		ИНАЧЕ
		|		ВЫБОР КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|		 И ДД.НДСРегл = 0
		|			ТОГДА 0
		|			ИНАЧЕ ДД.СтоимостьРегл + ДД.ДопРасходыРегл КОНЕЦ
		|		+ ВЫБОР
		|			КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|				ТОГДА -ДД.НДСРегл
		|			ИНАЧЕ 0
		|	КОНЕЦ - ЕСТЬNULL(СписаниеОтклонений.ДопРасходыРегл, 0) КОНЕЦ) КАК СтоимостьБезНДС,
		|	СУММА(ДД.НДСРегл - ЕСТЬNULL(СписаниеОтклонений.НДСРегл, 0)) КАК НДС,
		|	СУММА(
		|		ВЫБОР КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|		 И ДД.НДСУпр = 0
		|			ТОГДА 0
		|		КОГДА НЕ &УправленческийУчетОрганизаций
		|			ТОГДА 0
		|			ИНАЧЕ ДД.СтоимостьУпр + ДД.ДопРасходыУпр КОНЕЦ
		|		+ ВЫБОР
		|			КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|				ТОГДА -ДД.НДСУпр
		|			ИНАЧЕ 0
		|	КОНЕЦ - ЕСТЬNULL(СписаниеОтклонений.ДопРасходыУпр, 0)) КАК СтоимостьБезНДСУпр,
		|	СУММА(ВЫБОР
		|		КОГДА &УправленческийУчетОрганизаций
		|			ТОГДА ДД.НДСУпр - ЕСТЬNULL(СписаниеОтклонений.НДСУпр, 0)
		|		ИНАЧЕ 0
		|	КОНЕЦ) КАК НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	(ВЫБОР
		|		КОГДА ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|		 И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.СтатьяРасходовСписания
		|		КОГДА ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
		|			ТОГДА ДД.СтатьяАктивовПассивов
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов КАК АналитикаАктивов,
		|	(ВЫБОР
		|		КОГДА НЕ ДД.Организация В (&ОрганизацииСФИФОСкользящая)
		|		 И Реестр.ДатаДокументаИБ < &НачалоПериода
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
		|		  И ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.ЗаявлениеОВвозеТоваров)
		|		  И ТИПЗНАЧЕНИЯ(ДД.АналитикаРасходов) = ТИП(Документ.ПоступлениеТоваровНаСклад)
		|		  И ДД.АналитикаРасходов <> ЗНАЧЕНИЕ(Документ.ПоступлениеТоваровНаСклад.ПустаяСсылка)
		|			ТОГДА ДД.АналитикаРасходов
		|		КОГДА ДД.Партия <> НЕОПРЕДЕЛЕНО
		|		 И ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|			ТОГДА ДД.Партия
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ) КАК ДокументИсточник,
		|	ДД.Сторно
		|ПОМЕСТИТЬ ПриходыТоваровНДС
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПоПартнерам КАК АналитикаРасчетов
		|		ПО АналитикаРасчетов.Ссылка = ДД.АналитикаУчетаПоПартнерам
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК Договоры
		|		ПО Договоры.Ссылка = АналитикаРасчетов.Договор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК Корректировка
		|		ПО Корректировка.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК ДопРасходыКорректировка
		|		ПО ДопРасходыКорректировка.Ссылка = ДД.ДокументИсточник
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученныйНалоговыйАгент КАК СчетФактура
		|		ПО СчетФактура.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВводОстатков КАК ВводОстатков
		|		ПО ВводОстатков.Ссылка = ДД.ДокументИсточник
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВводОстатковТоваров КАК ВводОстатковТоваров
		|		ПО ВводОстатковТоваров.Ссылка = ДД.ДокументИсточник
		|	ЛЕВОЕ СОЕДИНЕНИЕ СписаниеОтклоненийВСтоимости КАК СписаниеОтклонений
		|		ПО СписаниеОтклонений.Организация = ДД.Организация
		|		И СписаниеОтклонений.РазделУчета = ДД.РазделУчета
		|		И СписаниеОтклонений.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И СписаниеОтклонений.ВидЗапасов = ДД.ВидЗапасов
		|		И СписаниеОтклонений.Партия = ДД.Партия
		|		И СписаниеОтклонений.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И СписаниеОтклонений.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|		И ДД.СлужебноеВидДвиженияПриход
		|		И ДД.ТипЗаписи <> ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РеестрДокументов КАК Реестр
		|		ПО Реестр.Ссылка = ДД.ДокументИсточник
		|		И НЕ Реестр.ДополнительнаяЗапись
		|		И Реестр.Ссылка <> НЕОПРЕДЕЛЕНО
		|	ЛЕВОЕ СОЕДИНЕНИЕ ИсправленныеДокументыНДС КАК ИсправленныеДокументы
		|		ПО ИсправленныеДокументы.Регистратор = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ КорректировкиДоВводаОстатков КАК КорректировкиДоВводаОстатков
		|		ПО КорректировкиДоВводаОстатков.Регистратор = ДД.Регистратор
		|		И КорректировкиДоВводаОстатков.ИдентификаторФинЗаписи = ДД.ИдентификаторФинЗаписи
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И (ДД.СлужебноеВидДвиженияПриход
		|		ИЛИ ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
		|		ИЛИ ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
		|		ИЛИ ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
		|	И НЕ ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВключениеИсключениеНДСВСтоимости)
		// Исключаем суммовую корректировку приобретения, если корректируемый документ относится к периоду с выключенным партионным учетом.
		|	И НЕ (
		|		ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода)
		|   	И ДД.СлужебноеВидДвиженияПриход
		|		И ДД.Количество = 0
		|		И Реестр.ДатаДокументаИБ < &ДатаПереходаНаПартионныйУчетВерсии22
		|		И &ИспользовалсяПартионныйУчетДоПереходаНаВерсию22 = ЛОЖЬ)
		// Если ведется учет по УСН, то нужны все партии, независимо от наличия в них НДС.
		// В противном случае нужно ограничить выборку данных:
		// - выбрать партии с НДС
		// - также выбрать партии без НДС, но с количеством, т.к. в дальнейшем на них могут быть отнесены затраты с НДС
		|	И (ДД.НДСРегл <> 0
		|		ИЛИ ДД.НДСУпр <> 0
		|		ИЛИ ДД.Организация В (&ОрганизацииНаУСН)
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.СборкаТоваров
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ТаможеннаяДекларацияИмпорт
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПорчаТоваров
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПересортицаТоваров
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ОприходованиеИзлишковТоваров
		|		ИЛИ ЕСТЬNULL(Договоры.УчетАгентскогоНДС, ЛОЖЬ)
		|		ИЛИ ДД.ХозяйственнаяОперация В (
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭС),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСНеотфактурованнаяПоставка),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСТоварыВПути),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаПоИмпорту),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаПоИмпортуТоварыВПути))

		|		ИЛИ ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.ПоступлениеТоваровНаСклад)
		|		)
		// Исключаем движения по выпуску продукции на склад.
		|	И НЕ (ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|			И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводстваФиксированнаяСтоимость)))
		|	И ДД.ТипЗаписи В (
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение))
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И (ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
		|		)
		|	И НЕ ДД.РазделУчета В (
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажи),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажиПереданныеПартнерам),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажиКОформлениюСписания),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки))
		|	И (ВЫБОР
		|		КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам))
		|		И ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		КОГДА ДД.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия) И ДД.Количество = 0
		|		 И ДД.КорАналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		ИНАЧЕ ДД.АналитикаУчетаПартий КОНЕЦ) <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ОтчетКомитентуОСписании
		|	И НЕ ((ДД.Регистратор ССЫЛКА Документ.ВводОстатков
		|				И НЕ ВЫРАЗИТЬ(ДД.Регистратор КАК Документ.ВводОстатков).ВводОстатков22)
		|			ИЛИ ДД.Регистратор ССЫЛКА Документ.ВводОстатковТоваров)
		|	И НЕ ДД.Сторно
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход
		|			И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|		ИНАЧЕ ДД.ТипЗаписи КОНЕЦ),
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|		 ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА НЕ ИсправленныеДокументы.ДокументИсточник ЕСТЬ NULL
		|			ТОГДА ИсправленныеДокументы.ДокументИсточник
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
		|		  И ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.ЗаявлениеОВвозеТоваров)
		|		  И ТИПЗНАЧЕНИЯ(ДД.АналитикаРасходов) = ТИП(Документ.ПоступлениеТоваровНаСклад)
		|		  И ДД.АналитикаРасходов <> ЗНАЧЕНИЕ(Документ.ПоступлениеТоваровНаСклад.ПустаяСсылка)
		|			ТОГДА ДД.АналитикаРасходов
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
		|		 И ДД.ХозяйственнаяОперация В
		|		  (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСФактуровкаПоставки),
		|		   ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщикаФактуровкаПоставки))
		|			ТОГДА ДД.АналитикаРасходов
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
		|		  И ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.ЗаявлениеОВвозеТоваров)
		|		  И ДД.ДокументИсточник <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.ДокументИсточник
		|		КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|			ТОГДА ВЫБОР
		|				КОГДА ТИПЗНАЧЕНИЯ(ДД.ДокументИсточник) = ТИП(Документ.ВводОстатковТоваров)
		|					ТОГДА ЕСТЬNULL(ВводОстатковТоваров.Партия,
		|						ЕСТЬNULL(ДопРасходыКорректировка.ДокументОснование, ДД.ДокументИсточник))
		|				ИНАЧЕ ЕСТЬNULL(ВводОстатков.Партия,
		|					ЕСТЬNULL(ДопРасходыКорректировка.ДокументОснование, ДД.ДокументИсточник))
		|			КОНЕЦ
		|		КОГДА НЕ Корректировка.ДокументОснование ЕСТЬ NULL
		|			ТОГДА Корректировка.ДокументОснование
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ),
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам))
		|		И ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		КОГДА ДД.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия) И ДД.Количество = 0
		|		 И ДД.КорАналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		ИНАЧЕ ДД.АналитикаУчетаПартий КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА НЕ ИсправленныеДокументы.ДокументИсточник ЕСТЬ NULL
		|			ТОГДА ИсправленныеДокументы.ДокументИсточник
		|		КОГДА НЕ Корректировка.ВидКорректировки ЕСТЬ NULL
		|		 И Корректировка.ВидКорректировки <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон)
		|			ТОГДА Корректировка.ДокументОснование
		|		КОГДА НЕ СчетФактура.Исправление ЕСТЬ NULL И СчетФактура.Исправление
		|			ТОГДА СчетФактура.СчетФактураОснование
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ), // ДокументПоступления
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	(ВЫБОР
		|		КОГДА ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|		 И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.СтатьяРасходовСписания
		|		КОГДА ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
		|			ТОГДА ДД.СтатьяАктивовПассивов
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	(ВЫБОР
		|		КОГДА НЕ ДД.Организация В (&ОрганизацииСФИФОСкользящая)
		|		 И Реестр.ДатаДокументаИБ < &НачалоПериода
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
		|		  И ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.ЗаявлениеОВвозеТоваров)
		|		  И ТИПЗНАЧЕНИЯ(ДД.АналитикаРасходов) = ТИП(Документ.ПоступлениеТоваровНаСклад)
		|		  И ДД.АналитикаРасходов <> ЗНАЧЕНИЕ(Документ.ПоступлениеТоваровНаСклад.ПустаяСсылка)
		|			ТОГДА ДД.АналитикаРасходов
		|		КОГДА ДД.Партия <> НЕОПРЕДЕЛЕНО
		|		 И ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|			ТОГДА ДД.Партия
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ),
		|	ДД.Сторно
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) КАК ТипЗаписи,
		|	ЛОЖЬ КАК ЭтоСторно,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|
		|	(ВЫБОР
		|		КОГДА ДД.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		ИНАЧЕ ДД.АналитикаУчетаПартий КОНЕЦ) КАК АналитикаУчетаПартий,
		|	ДД.Регистратор КАК ДокументПоступления,
		|
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(СписаниеОтклонений.ДопРасходыРегл
		|		+ ВЫБОР
		|			КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|				ТОГДА -СписаниеОтклонений.НДСРегл
		|			ИНАЧЕ 0
		|	КОНЕЦ) КАК СтоимостьБезНДС,
		|	СУММА(СписаниеОтклонений.НДСРегл) КАК НДС,
		|	СУММА(ВЫБОР
		|		КОГДА &УправленческийУчетОрганизаций
		|			ТОГДА СписаниеОтклонений.ДопРасходыУпр
		|		+ ВЫБОР
		|			КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|				ТОГДА -СписаниеОтклонений.НДСУпр
		|			ИНАЧЕ 0
		|		КОНЕЦ
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК СтоимостьБезНДСУпр,
		|	СУММА(ВЫБОР
		|		КОГДА &УправленческийУчетОрганизаций
		|			ТОГДА СписаниеОтклонений.НДСУпр
		|		ИНАЧЕ 0
		|	КОНЕЦ) КАК НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов КАК АналитикаАктивов,
		|	(ВЫБОР
		|		КОГДА ДД.Партия <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Партия
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ) КАК ДокументИсточник,
		|	ДД.Сторно
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ СписаниеОтклоненийВСтоимости КАК СписаниеОтклонений
		|		ПО СписаниеОтклонений.Организация = ДД.Организация
		|		И СписаниеОтклонений.РазделУчета = ДД.РазделУчета
		|		И СписаниеОтклонений.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И СписаниеОтклонений.ВидЗапасов = ДД.ВидЗапасов
		|		И СписаниеОтклонений.Партия = ДД.Партия
		|		И СписаниеОтклонений.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И СписаниеОтклонений.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|		И ДД.СлужебноеВидДвиженияПриход
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.СлужебноеВидДвиженияПриход
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
		|	И (ВЫБОР
		|		КОГДА ДД.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		ИНАЧЕ ДД.АналитикаУчетаПартий КОНЕЦ) <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|	И НЕ ДД.Сторно
		|СГРУППИРОВАТЬ ПО
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	(ВЫБОР
		|		КОГДА ДД.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		ИНАЧЕ ДД.АналитикаУчетаПартий КОНЕЦ),
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	(ВЫБОР
		|		КОГДА ДД.Партия <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Партия
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ),
		|	ДД.Сторно
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОстатокСгруппированный) КАК ТипЗаписи,
		|	ЛОЖЬ КАК ЭтоСторно,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|		 ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.НДС) КАК НДС,
		|	0 КАК СтоимостьБезНДСУпр,
		|	СУММА(ДД.НДСУпр) КАК НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов КАК АналитикаАктивов,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ДД.Сторно
		|ИЗ
		|	ВТКэшРасчетныеОборотыДетализацияПартийТоваровДляНДСиУСН КАК ДД
		|ГДЕ
		|	((ДД.Регистратор ССЫЛКА Документ.ВводОстатков
		|			И НЕ ВЫРАЗИТЬ(Регистратор КАК Документ.ВводОстатков).ВводОстатков22)
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ВводОстатковТоваров)
		|	И ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И НЕ ДД.Сторно
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.ТипЗаписи,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|		 ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	ДД.Сторно
		|";
КонецФункции

Функция ТекстОстаткиСебестоимостиТоваров() // вт ОстаткиСебестоимостиТоваров
	Возврат "
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.КоличествоОстаток КАК Количество
		|ПОМЕСТИТЬ ОстаткиСебестоимостиТоваров
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Остатки(&ГраницаКонецПредыдущегоПериода,
		|		Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)) КАК ДД
		|ГДЕ
		|	ДД.КоличествоОстаток > 0
		|ИНДЕКСИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры
		|";
КонецФункции

Функция ТекстВТНачальныеОстаткиПартийНДС() // вт ВТНачальныеОстаткиПартийНДС
	Возврат "
		|ВЫБРАТЬ
		|	ВЫБОР КОГДА ЕСТЬNULL(Остатки.Количество, ДД.КоличествоОстаток) < 0
		|		ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ЭтоСторно,
		|	ЕСТЬNULL(Остатки.Количество, ДД.КоличествоОстаток) КАК Знаменатель,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура 	КАК Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС 	КАК НалогообложениеПартии,
		|	
		| ЕСТЬNULL(ПериодикаПартии.ДатаРегистратора, &КонецПредыдущегоПериода) КАК Период,
		|	(ВЫБОР
		|		КОГДА ДД.РазделУчета В (
		|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути),
		|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссиюВПути),
		|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссиюВПути))
		|			ТОГДА ДД.Партия
		|		КОГДА ОстаткиСебестоимостиТоваров.Партия ЕСТЬ NULL
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		КОГДА ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
		|			ТОГДА ДД.Партия
		|		ИНАЧЕ ДД.Партия КОНЕЦ) КАК Регистратор,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|
		|	ДД.КоличествоОстаток КАК Количество,
		|	ДД.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
		|	ДД.НДСОстаток КАК НДС,
		|	ДД.НДСУпрОстаток КАК НДСУпр
		|ПОМЕСТИТЬ ВТНачальныеОстаткиПартийНДС
		|ИЗ
		|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН.Остатки(&ГраницаКонецПредыдущегоПериода,
		|		Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)) КАК ДД
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиТоваров КАК Остатки
		|		ПО Остатки.Организация = ДД.Организация
		|		И Остатки.РазделУчета = ДД.РазделУчета
		|		И Остатки.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Остатки.ВидЗапасов = ДД.ВидЗапасов
		|		И Остатки.Партия = ДД.Партия
		|		И Остатки.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Остатки.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиСебестоимостиТоваров КАК ОстаткиСебестоимостиТоваров
		|		ПО ОстаткиСебестоимостиТоваров.Организация = ДД.Организация
		|		И ОстаткиСебестоимостиТоваров.РазделУчета = ДД.РазделУчета
		|		И ОстаткиСебестоимостиТоваров.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И ОстаткиСебестоимостиТоваров.ВидЗапасов = ДД.ВидЗапасов
		|		И ОстаткиСебестоимостиТоваров.Партия = ДД.Партия
		|		И ОстаткиСебестоимостиТоваров.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И ОстаткиСебестоимостиТоваров.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ПериодикаПартии
		|		ПО ПериодикаПартии.Организация = ДД.Организация
		|		И ПериодикаПартии.Документ = ДД.Партия
		|ГДЕ
		|	ДД.КоличествоОстаток >= 0
		|";
КонецФункции

Функция ТекстДвиженияСебестоимостиНДС() // вт ДвиженияСебестоимостиНДС, использует ИсправленныеДокументыНДС 	
	Возврат "
		|ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация В (
		//++ Устарело_Переработка24
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика),
		//-- Устарело_Переработка24
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика2_5),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводстваФиксированнаяСтоимость))
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск) И НЕ ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщика)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПеремещениеАвто)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводстваФиксированнаяСтоимость),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию))
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
		|			И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|			ТОГДА
		|				ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|					ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|					ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|				КОНЕЦ
		|
		|		ИНАЧЕ ДД.ТипЗаписи
		|	КОНЕЦ КАК ТипЗаписи,
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК ЭтоСторно,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	
		|	ДД.Период,
		|	ДД.Регистратор КАК Регистратор,
		|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|		 ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА КорректировкаПриобретения.ДокументОснование ЕСТЬ НЕ NULL
		|			ТОГДА КорректировкаПриобретения.ДокументОснование
		|		ИНАЧЕ ДД.Партия КОНЕЦ) КАК Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|
		|	СУММА(ДД.Количество) КАК Количество,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ВЫБОР
		|		КОГДА НЕ ПередачаВидыЗапасов.Ссылка ЕСТЬ NULL И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И Передача.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
		|		КОГДА НЕ Передача.Ссылка ЕСТЬ NULL И НЕ ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА Передача.НалогообложениеНДС
		|		КОГДА НЕ Возврат.Ссылка ЕСТЬ NULL И ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА Возврат.НалогообложениеНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС
		|	КОНЕЦ КАК КорВидДеятельностиНДС,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	(ВЫБОР
		|		КОГДА ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|		 И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.СтатьяРасходовСписания
		|		КОГДА ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
		|			ТОГДА ДД.СтатьяАктивовПассивов
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов КАК АналитикаАктивов,
		|	ДД.КорНаправлениеДеятельности,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация В (
		//++ Устарело_Переработка24
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика),
		//-- Устарело_Переработка24
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика2_5),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводстваФиксированнаяСтоимость))
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение))
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор

		// Для корректировок приобретения надо указать документ-основание, чтобы построилась связь с партией
		|		КОГДА ТИПЗНАЧЕНИЯ(ДД.ДокументИсточник) = ТИП(Документ.КорректировкаПриобретения)
		|			ТОГДА ВЫРАЗИТЬ(ДД.ДокументИсточник КАК Документ.КорректировкаПриобретения).ДокументОснование
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
		|			И НЕ ДД.СлужебноеВидДвиженияПриход
		|			И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|				ТОГДА ДД.Регистратор
		|		
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ) КАК ДокументИсточник,
		|	ДД.Сторно
		|ПОМЕСТИТЬ ДвиженияСебестоимостиНДС
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями КАК Передача
		|		ПО Передача.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТПередачиБезНДС КАК ПередачаВидыЗапасов
		|		ПО ПередачаВидыЗапасов.Ссылка = ДД.Регистратор
		|			И ПередачаВидыЗапасов.Номенклатура = ДД.АналитикаУчетаНоменклатуры.Номенклатура
		|			И ПередачаВидыЗапасов.Характеристика = ДД.АналитикаУчетаНоменклатуры.Характеристика
		|			И ПередачаВидыЗапасов.Серия = ДД.АналитикаУчетаНоменклатуры.Серия
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровМеждуОрганизациями КАК Возврат
		|		ПО Возврат.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ ИсправленныеДокументыНДС КАК ИсправленныеДокументы
		|		ПО ИсправленныеДокументы.Регистратор = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК КорректировкаПриобретения
		|		ПО КорректировкаПриобретения.Ссылка = ДД.Регистратор
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.Количество <> 0
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И НЕ ДД.РазделУчета В (
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажи),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажиПереданныеПартнерам),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажиКОформлениюСписания),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки))
		|	И (НЕ ДД.ТипЗаписи В (
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВключениеИсключениеНДСвСтоимости),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов))

		|	)
		|	И НЕ (ДД.Регистратор ССЫЛКА Документ.ПересортицаТоваров И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение))
		|	И НЕ (ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|		И ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|		И ДД.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением))
		// Исключаем исправления документов прошлого периода.
		// Эти движения формируются в функции ТекстСторноДвиженияИсправленныхДокументовПрошлогоПериодаНДС().
		|	И НЕ (ДД.Сторно
		|		И ЕСТЬNULL(ИсправленныеДокументы.ДатаДокументаИсточника, &НачалоПериода) < &НачалоПериода)
		|
		|СГРУППИРОВАТЬ ПО
		|	ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация В (
		//++ Устарело_Переработка24
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика),
		//-- Устарело_Переработка24
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика2_5),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводстваФиксированнаяСтоимость))
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск) И НЕ ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщика)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПеремещениеАвто)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводстваФиксированнаяСтоимость),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию))
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
		|			И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) 
		|			ТОГДА
		|				ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|					ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|					ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|				КОНЕЦ
		|
		|		ИНАЧЕ ДД.ТипЗаписи
		|	КОНЕЦ, // ТипЗаписи
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ), // ЭтоСторно
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|		 ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ, // ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА КорректировкаПриобретения.ДокументОснование ЕСТЬ НЕ NULL
		|			ТОГДА КорректировкаПриобретения.ДокументОснование
		|		ИНАЧЕ ДД.Партия КОНЕЦ), // Партия
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ВЫБОР
		|		КОГДА НЕ ПередачаВидыЗапасов.Ссылка ЕСТЬ NULL И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И Передача.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
		|		КОГДА НЕ Передача.Ссылка ЕСТЬ NULL И НЕ ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА Передача.НалогообложениеНДС
		|		КОГДА НЕ Возврат.Ссылка ЕСТЬ NULL И ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА Возврат.НалогообложениеНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС
		|	КОНЕЦ, // КорВидДеятельностиНДС
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	(ВЫБОР
		|		КОГДА ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|		 И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.СтатьяРасходовСписания
		|		КОГДА ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
		|			ТОГДА ДД.СтатьяАктивовПассивов
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ), // СтатьяРасходовАктивов
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.КорНаправлениеДеятельности,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация В (
		//++ Устарело_Переработка24
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика),
		//-- Устарело_Переработка24
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика2_5),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводстваФиксированнаяСтоимость))
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение))
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ТИПЗНАЧЕНИЯ(ДД.ДокументИсточник) = ТИП(Документ.КорректировкаПриобретения)
		|			ТОГДА ВЫРАЗИТЬ(ДД.ДокументИсточник КАК Документ.КорректировкаПриобретения).ДокументОснование
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
		|			И НЕ ДД.СлужебноеВидДвиженияПриход
		|			И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|				ТОГДА ДД.Регистратор
		|		
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ), // ДокументИсточник
		|	ДД.Сторно
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор
		|";
КонецФункции

Функция ТекстПрошлыеРеализацииСебестоимость() // вт ПрошлыеРеализацииСебестоимость
	Возврат "
		|ВЫБРАТЬ
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	Прошлые.ВидЗапасов,
		|	Прошлые.АналитикаФинансовогоУчета,
		|	Прошлые.ВидДеятельностиНДС,
		|	СУММА(ДД.Количество) КАК Количество
		|
		|ПОМЕСТИТЬ ПрошлыеРеализацииСебестоимость
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрошлыеРеализацииПартийНДС КАК Прошлые
		|		ПО ДД.Регистратор = Прошлые.ДокументИсточник
		|		И ДД.Организация = Прошлые.Организация
		|		И ДД.РазделУчета = Прошлые.РазделУчета
		|		И ДД.АналитикаУчетаНоменклатуры = Прошлые.АналитикаУчетаНоменклатуры
		|		И (ДД.ВидЗапасов = Прошлые.ВидЗапасов
		|			ИЛИ ДД.ВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка))
		|		И ДД.АналитикаФинансовогоУчета = Прошлые.АналитикаФинансовогоУчета
		|		И ДД.КорВидДеятельностиНДС = Прошлые.ВидДеятельностиНДС
		|СГРУППИРОВАТЬ ПО
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	Прошлые.ВидЗапасов,
		|	Прошлые.АналитикаФинансовогоУчета,
		|	Прошлые.ВидДеятельностиНДС
		|";
КонецФункции

Функция ТекстАналитикиУчетаПартийТаможенныхДеклараций() // ВТИзменениеВидаДеятельностиДопРасходов
	Возврат "
		|ВЫБРАТЬ
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ВЫРАЗИТЬ(ДД.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры) КАК АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорАналитикаУчетаПартий,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.ДокументИсточник,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.НДСУпр) КАК НДСУпр
		|ПОМЕСТИТЬ ВТИзменениеВидаДеятельностиДопРасходовПредварительная
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.ВидДеятельностиНДС <> ДД.КорВидДеятельностиНДС
		|	И ДД.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И (ДД.НДСРегл <> 0 ИЛИ ДД.НДСУпр <> 0)
		|	И ДД.ТипЗаписи В (
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии))
		|	И НЕ ДД.Сторно
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ВЫРАЗИТЬ(ДД.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры),
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорАналитикаУчетаПартий,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.ДокументИсточник
		|ИНДЕКСИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры,
		|	Организация,
		|	Партия
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.КорВидДеятельностиНДС,
		|	МАКСИМУМ(ЕСТЬNULL(АналитикиПартий.КорАналитикаУчетаПартий, ДД.КорАналитикаУчетаПартий)) КАК КорАналитикаУчетаПартий,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.ДокументИсточник,
		|	ДД.НДСРегл,
		|	ДД.НДСУпр
		|ПОМЕСТИТЬ ВТИзменениеВидаДеятельностиДопРасходов
		|ИЗ
		|	ВТИзменениеВидаДеятельностиДопРасходовПредварительная КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК АналитикиПартий
		|		ПО ДД.Регистратор = АналитикиПартий.Регистратор
		|		И ДД.Организация = АналитикиПартий.Организация
		|		И ДД.РазделУчета = АналитикиПартий.РазделУчета
		|		И ДД.АналитикаУчетаНоменклатуры = АналитикиПартий.АналитикаУчетаНоменклатуры
		|		И ДД.ВидЗапасов = АналитикиПартий.ВидЗапасов
		|		И ДД.Партия = АналитикиПартий.Партия
		|		И ДД.ВидДеятельностиНДС = АналитикиПартий.ВидДеятельностиНДС
		|		И ДД.АналитикаФинансовогоУчета = АналитикиПартий.АналитикаФинансовогоУчета
		|		И ДД.КорАналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|		И НЕ АналитикиПартий.РасчетПартий 
		|		И НЕ АналитикиПартий.РасчетСебестоимости
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.ДокументИсточник,
		|	ДД.НДСРегл,
		|	ДД.НДСУпр
		|
	    |";
КонецФункции

//-- Локализация 

Функция ТекстРаспределениеДопРасходов()
	
	Возврат "
	|ВЫБРАТЬ
	|	Т.Ссылка
	|ПОМЕСТИТЬ ВТОрганизацииДляРаспределенияДопРасходовНДС
	|ИЗ
	|	Справочник.Организации КАК Т
	|ГДЕ
	|	Т.Ссылка В(&ОрганизацииСУчетомПартийНДСВерсии22)
	|	ИЛИ Т.Ссылка В(&ОрганизацииСУчетомПартийНДСВерсии24)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Регистратор КАК Регистратор,
	|	Т.Период КАК Период,
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.ДокументПоступленияРасходов КАК ДокументПоступления,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартийДокументаПоступления,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	ЛОЖЬ КАК РасчетПартий,
	|	ИСТИНА КАК ЭтоПартииПрочихРасходов,
	|	СУММА(Т.СтоимостьРегл * Статьи.КоэффициентРегл) КАК СтоимостьРегл,
	|	СУММА(Т.НДСРегл * Статьи.КоэффициентРегл) КАК НДСРегл,
	|	СУММА(Т.Стоимость * Статьи.КоэффициентУпр) КАК Стоимость,
	|	СУММА(Т.СтоимостьБезНДС * Статьи.КоэффициентУпр) КАК СтоимостьБезНДС,
	|	СУММА(Т.НДСУпр * Статьи.КоэффициентУпр) КАК НДСУпр,
	|	СУММА(ВЫБОР
	// Для НДС налогового агента в качестве знаменателя берется НДС в упр. учете,
	// т.к. в регистре "Прочие расходы" будет только сумма в упр учете.
	|		КОГДА Т.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.НДСНалоговогоАгента) И Т.НДСУпр <> 0
	|			ТОГДА Т.НДСУпр
	|		КОГДА Т.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.НДСНалоговогоАгента) И Т.СтоимостьБезНДС <> 0
	|			ТОГДА Т.СтоимостьБезНДС
	|		КОГДА Т.СтоимостьРегл <> 0 ТОГДА Т.СтоимостьРегл
	|		ИНАЧЕ Т.НДСРегл КОНЕЦ
	|		* Статьи.КоэффициентРегл) КАК ЗнаменательРегл,
	|	СУММА(ВЫБОР
	|		КОГДА Т.СтоимостьБезНДС <> 0 ТОГДА Т.СтоимостьБезНДС
	|		ИНАЧЕ Т.НДСУпр КОНЕЦ
	|		* Статьи.КоэффициентУпр) КАК ЗнаменательУпр
	|ПОМЕСТИТЬ ВТДопРасходыДляРаспределенияПредварительная
	|ИЗ
	|	ВТКэшРасчетныеОборотыПартииПрочихРасходов КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОрганизацииДляРаспределенияДопРасходовНДС КАК Организации
	|		ПО Т.Организация = Организации.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТСтатьиЗатратНаСебестоимость КАК Статьи
	|		ПО Т.СтатьяРасходов = Статьи.Ссылка
	|ГДЕ
	|	Т.СлужебноеВидДвиженияПриход
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.Период,
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.ВидДеятельностиНДС,
	|	Т.ДокументПоступленияРасходов,
	|	Т.АналитикаУчетаПартий,
	|	Т.НаправлениеДеятельности,
	|	Т.ХозяйственнаяОперация
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НЕОПРЕДЕЛЕНО КАК Регистратор,
	|	&НачалоПериода КАК Период,
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.ДокументПоступленияРасходов КАК ДокументПоступления,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартийДокументаПоступления,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
	|	ЛОЖЬ КАК РасчетПартий,
	|	ИСТИНА КАК ЭтоПартииПрочихРасходов,
	|	СУММА(Т.СтоимостьРеглОстаток * Статьи.КоэффициентРегл) КАК СтоимостьРегл,
	|	СУММА(Т.НДСРеглОстаток * Статьи.КоэффициентРегл) КАК НДСРегл,
	|	СУММА(Т.СтоимостьОстаток * Статьи.КоэффициентУпр) КАК Стоимость,
	|	СУММА(Т.СтоимостьБезНДСОстаток * Статьи.КоэффициентУпр) КАК СтоимостьБезНДС,
	|	СУММА(Т.НДСУпрОстаток * Статьи.КоэффициентУпр) КАК НДСУпр,
	|	СУММА(Т.СтоимостьРеглОстаток * Статьи.КоэффициентРегл) КАК ЗнаменательРегл,
	|	СУММА(Т.СтоимостьБезНДСОстаток * Статьи.КоэффициентУпр) КАК ЗнаменательУпр
	|ИЗ
	|	РегистрНакопления.ПартииПрочихРасходов.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		Организация В(ВЫБРАТЬ Т.Ссылка ИЗ ВТОрганизацииДляРаспределенияДопРасходовНДС КАК Т)
	|	) КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТСтатьиЗатратНаСебестоимость КАК Статьи
	|		ПО Т.СтатьяРасходов = Статьи.Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.ВидДеятельностиНДС,
	|	Т.ДокументПоступленияРасходов,
	|	Т.АналитикаУчетаПартий,
	|	Т.НаправлениеДеятельности
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Отнесение отклонений в стоимости товаров на статьи расходов, распределяемые на себестоимость товаров.
	// Движения по регистру "Партии прочих расходов" для таких расходов формируются в этапе "ПодготовкаДанныхДляПартийПрочихРасходов"
	// процедура ТекстПоступлениеПартийПрочихРасходовПриСписанииНоменклатурыНаДопРасходыФИФО().
	// Выборка данных должна соответствовать процедуре СформироватьДвиженияПоОтклонениямВСтоимостиТоваров() #Область ОтклоненияВСтоимостиПрочиеРасходы
	|ВЫБРАТЬ
	|	Т.Регистратор КАК Регистратор,
	|	Т.Период КАК Период,
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.СтатьяРасходовСписания КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.Регистратор КАК ДокументПоступления,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартийДокументаПоступления,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Т.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	Т.РасчетПартий КАК РасчетПартий,
	|	ЛОЖЬ КАК ЭтоПартииПрочихРасходов,
	|	СУММА(Т.СтоимостьРегл * Статьи.КоэффициентРегл) КАК СтоимостьРегл,
	|	СУММА(Т.НДСРегл * Статьи.КоэффициентРегл) КАК НДСРегл,
	|	СУММА(Т.Стоимость * Статьи.КоэффициентУпр) КАК Стоимость,
	|	СУММА(Т.СтоимостьБезНДС * Статьи.КоэффициентУпр) КАК СтоимостьБезНДС,
	|	СУММА(Т.НДСУпр * Статьи.КоэффициентУпр) КАК НДСУпр,
	|	СУММА(ВЫБОР
	|		КОГДА Т.СтоимостьРегл <> 0 ТОГДА Т.СтоимостьРегл
	|		ИНАЧЕ Т.НДСРегл КОНЕЦ
	|		* Статьи.КоэффициентРегл) КАК ЗнаменательРегл,
	|	СУММА(ВЫБОР
	|		КОГДА Т.СтоимостьБезНДС <> 0 ТОГДА Т.СтоимостьБезНДС
	|		ИНАЧЕ Т.НДСУпр КОНЕЦ
	|		* Статьи.КоэффициентУпр) КАК ЗнаменательУпр
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОрганизацииДляРаспределенияДопРасходовНДС КАК Организации
	|		ПО Т.Организация = Организации.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТСтатьиЗатратНаСебестоимость КАК Статьи
	|		ПО Т.СтатьяРасходовСписания = Статьи.Ссылка
	|ГДЕ
	|	Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейпартий.ОтклонениеВСтоимостиНаПрочиеРасходы)
	|	И Т.РасчетПартий
	|	И НЕ Т.Сторно
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.Период,
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаУчетаПартий,
	|	Т.КорНаправлениеДеятельности,
	|	Т.ХозяйственнаяОперация,
	|	Т.РасчетПартий
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СтатьяРасходов,
	|	АналитикаРасходов,
	|	Подразделение,
	|	Организация,
	|	НаправлениеДеятельности
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.ДокументПоступления
	|ПОМЕСТИТЬ ВТДокументыПоступленияРасходов
	|ИЗ
	|	ВТДопРасходыДляРаспределенияПредварительная КАК Т
	|ГДЕ
	|	Т.ДокументПоступления <> НЕОПРЕДЕЛЕНО
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументПоступления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Регистратор
	|ПОМЕСТИТЬ ВТРегистраторыРасходов
	|ИЗ
	|	ВТДопРасходыДляРаспределенияПредварительная КАК Т
	|ГДЕ
	|	Т.Регистратор <> НЕОПРЕДЕЛЕНО
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Регистратор КАК Регистратор,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.Подразделение,
	|	Т.Организация,
	|	Т.НаправлениеДеятельности,
	|	МАКСИМУМ(ВЫБОР КОГДА Т.СуммаУпр <> 0 ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК ЕстьСуммаУпр
	|ПОМЕСТИТЬ ВТДвиженияПрочиеРасходы
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходы КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТСтатьиЗатратНаСебестоимость КАК Статьи
	|		ПО Т.СтатьяРасходов = Статьи.Ссылка
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТДокументыПоступленияРасходов КАК ДокументыПоступления
	|		ПО Т.Регистратор = ДокументыПоступления.ДокументПоступления
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРегистраторыРасходов КАК Регистраторы
	|		ПО Т.Регистратор = Регистраторы.Регистратор
	|ГДЕ
	|	Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И Т.Период <= &КонецПериода
	|	И (НЕ ДокументыПоступления.ДокументПоступления ЕСТЬ NULL
	|		ИЛИ НЕ Регистраторы.Регистратор ЕСТЬ NULL)
	|	И НЕ Т.РасчетПартий
	|	И НЕ Т.РасчетСебестоимости
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.Подразделение,
	|	Т.Организация,
	|	Т.НаправлениеДеятельности
	|ИНДЕКСИРОВАТЬ ПО
	|	СтатьяРасходов,
	|	АналитикаРасходов,
	|	Подразделение,
	|	Организация,
	|	НаправлениеДеятельности
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Регистратор,
	|	Т.Период,
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.ВидДеятельностиНДС,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.ХозяйственнаяОперация,
	|	Т.РасчетПартий,
	|	Т.ЭтоПартииПрочихРасходов,
	|	Т.СтоимостьРегл,
	|	Т.НДСРегл,
	|	Т.Стоимость,
	|	Т.СтоимостьБезНДС,
	|	ВЫБОР КОГДА ЕСТЬNULL(ПрочиеРасходы.ЕстьСуммаУпр, ИСТИНА) ТОГДА Т.СтоимостьБезНДС ИНАЧЕ 0 КОНЕЦ КАК СтоимостьБезНДСУпр,
	|	Т.НДСУпр,
	|	Т.ЗнаменательРегл,
	|	Т.ЗнаменательУпр
	|ПОМЕСТИТЬ ВТДопРасходыДляРаспределения
	|ИЗ
	|	ВТДопРасходыДляРаспределенияПредварительная КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТДвиженияПрочиеРасходы КАК ПрочиеРасходы
	|		ПО Т.СтатьяРасходов = ПрочиеРасходы.СтатьяРасходов
	|		И Т.АналитикаРасходов = ПрочиеРасходы.АналитикаРасходов
	|		И Т.Подразделение = ПрочиеРасходы.Подразделение
	|		И Т.Организация = ПрочиеРасходы.Организация
	|		И Т.НаправлениеДеятельности = ПрочиеРасходы.НаправлениеДеятельности
	|		И (Т.ДокументПоступления = ПрочиеРасходы.Регистратор
	|			ИЛИ Т.Регистратор = ПрочиеРасходы.Регистратор)
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	Т.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|	Т.КорРазделУчета,
	|	Т.КорВидЗапасов,
	|	Т.КорОрганизация КАК КорОрганизация,
	|	Т.КорПартия КАК КорПартия,
	|	Т.КорАналитикаУчетаПартий,
	|	Т.КорАналитикаФинансовогоУчета,
	|	Т.КорВидДеятельностиНДС,
	|	Т.ХозяйственнаяОперация,
	|	Т.ТипЗаписи,
	|	Т.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	ЕСТЬNULL(Т.ЗаказКлиента, НЕОПРЕДЕЛЕНО) КАК ЗаказКлиента,
	|	Т.Количество,
	|	ВЫРАЗИТЬ(Т.Количество / СУММА(Итоги.Количество) КАК ЧИСЛО(31,10)) КАК Коэффициент
	|ПОМЕСТИТЬ ДолиДополнительныхРасходовПриведенные
	|ИЗ
	|	ДолиДополнительныхРасходов КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДолиДополнительныхРасходов КАК Итоги
	|		ПО Т.Регистратор = Итоги.Регистратор
	|		И Т.КорАналитикаУчетаНоменклатуры = Итоги.КорАналитикаУчетаНоменклатуры
	|		И Т.КорРазделУчета = Итоги.КорРазделУчета
	|		И Т.КорВидЗапасов = Итоги.КорВидЗапасов
	|		И Т.КорОрганизация = Итоги.КорОрганизация
	|		И Т.КорПартия = Итоги.КорПартия
	|		И Т.КорАналитикаУчетаПартий = Итоги.КорАналитикаУчетаПартий
	|		И Т.КорАналитикаФинансовогоУчета = Итоги.КорАналитикаФинансовогоУчета
	|		И Т.КорВидДеятельностиНДС = Итоги.КорВидДеятельностиНДС
	|		И Т.ТипЗаписи = Итоги.ТипЗаписи
	|		И Т.АналитикаУчетаПоПартнерам = Итоги.АналитикаУчетаПоПартнерам
	|		И Т.ЗаказКлиента = Итоги.ЗаказКлиента
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.КорАналитикаУчетаНоменклатуры,
	|	Т.КорРазделУчета,
	|	Т.КорВидЗапасов,
	|	Т.КорОрганизация,
	|	Т.КорПартия,
	|	Т.КорАналитикаУчетаПартий,
	|	Т.КорАналитикаФинансовогоУчета,
	|	Т.КорВидДеятельностиНДС,
	|	Т.ХозяйственнаяОперация,
	|	Т.ТипЗаписи,
	|	Т.АналитикаУчетаПоПартнерам,
	|	ЕСТЬNULL(Т.ЗаказКлиента, НЕОПРЕДЕЛЕНО),
	|	Т.Количество
	|
	|ИМЕЮЩИЕ
	|    СУММА(Итоги.Количество) <> 0
	|ИНДЕКСИРОВАТЬ ПО
	|	КорАналитикаУчетаНоменклатуры,
	|	КорОрганизация,
	|	КорПартия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВЫБОР КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам) ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ КАК НаВыбытие,
	|	ДД.Период,
	|	ДД.Регистратор,
	|	ДД.Организация,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.РазделУчета,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.ТипЗаписи,
	|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
	|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, НЕОПРЕДЕЛЕНО) КАК КорНаправлениеДеятельности,
	|	ДокументРаспределения.Подразделение,
	|	ДокументРаспределения.СтатьяРасходов,
	|	ДокументРаспределения.АналитикаРасходов,
	|	ДокументРаспределения.НаправлениеДеятельности,
	|	ДД.ИдентификаторФинЗаписи,
	|	Доли.ХозяйственнаяОперация,
	|	(ВЫБОР
	|		КОГДА Реестр.Ссылка ЕСТЬ NULL ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА КОНЕЦ) КАК УказанДокументВАналитикеРасходов,			
	|	
	|	ВЫРАЗИТЬ(СУММА(ВЫБОР
	|		КОГДА ДД.ДопРасходыРегл <> 0 ТОГДА ДД.ДопРасходыРегл
	|		КОГДА ДД.ДопРасходыБезНДС <> 0 ТОГДА ДД.ДопРасходыБезНДС
	|		ИНАЧЕ ДД.ДопРасходы КОНЕЦ * ЕСТЬNULL(Доли.Коэффициент, 1)) КАК ЧИСЛО(31,2)) КАК ЗнаменательРегл,
	|	ВЫРАЗИТЬ(СУММА(ВЫБОР
	|		КОГДА ДД.ДопРасходыУпр <> 0 ТОГДА ДД.ДопРасходыУпр
	|		КОГДА ДД.ДопРасходыБезНДС <> 0 ТОГДА ДД.ДопРасходыБезНДС
	|		ИНАЧЕ ДД.ДопРасходы КОНЕЦ * ЕСТЬNULL(Доли.Коэффициент, 1)) КАК ЧИСЛО(31,2)) КАК ЗнаменательУпр,
	|	СУММА(ЕСТЬNULL(Доли.Количество, 0)) КАК Количество
	|ПОМЕСТИТЬ ВТБазаРаспределенияДопРасходовБезПартий
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК ДокументРаспределения
	|		ПО ДД.Регистратор = ДокументРаспределения.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОрганизацииДляРаспределенияДопРасходовНДС КАК Организации
	|		ПО ДД.Организация = Организации.Ссылка
	|	ЛЕВОЕ СОЕДИНЕНИЕ ДолиДополнительныхРасходовПриведенные КАК Доли
	|		ПО Доли.Регистратор = ДД.Регистратор
	|		И Доли.КорАналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
	|		И Доли.КорРазделУчета = ДД.РазделУчета
	|		И Доли.КорВидЗапасов = ДД.ВидЗапасов
	|		И Доли.КорОрганизация = ДД.Организация
	|		И Доли.КорПартия = ДД.Партия
	|		И Доли.КорАналитикаУчетаПартий = ДД.АналитикаУчетаПартий
	|		И Доли.КорАналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
	|		И Доли.КорВидДеятельностиНДС = ДД.ВидДеятельностиНДС
	|		И Доли.ТипЗаписи = ДД.ТипЗаписи
	|		И Доли.АналитикаУчетаПоПартнерам = ДД.АналитикаУчетаПоПартнерам
	|		И Доли.ЗаказКлиента = ДД.ЗаказКлиента
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РеестрДокументов КАК Реестр
	|		ПО Реестр.Ссылка = ДД.АналитикаРасходов
	|		И НЕ Реестр.ДополнительнаяЗапись
	|ГДЕ
	|	ДД.СлужебноеВидДвиженияПриход
	|	И ДД.ТипЗаписи В (
	|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам))
	|
	|СГРУППИРОВАТЬ ПО
	|	ВЫБОР КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам) ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ,
	|	ДД.Период,
	|	ДД.Регистратор,
	|	ДД.Организация,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.РазделУчета,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.ТипЗаписи,
	|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, НЕОПРЕДЕЛЕНО),
	|	ДокументРаспределения.Подразделение,
	|	ДокументРаспределения.СтатьяРасходов,
	|	ДокументРаспределения.АналитикаРасходов,
	|	ДокументРаспределения.НаправлениеДеятельности,
	|	ДД.ИдентификаторФинЗаписи,
	|	Доли.ХозяйственнаяОперация,
	|	(ВЫБОР
	|		КОГДА Реестр.Ссылка ЕСТЬ NULL ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА КОНЕЦ)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// База распределения, если в стоимости доп расходов есть только постатейные затраты.
	|ВЫБРАТЬ
	|	ВЫБОР
	|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ КОНЕЦ КАК НаВыбытие,
	|	ДокументРаспределения.Дата КАК Период,
	|	ДД.Регистратор,
	|	ДокументРаспределения.Организация,
	|	ДД.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	ДД.КорВидЗапасов КАК ВидЗапасов,
	|	ДД.КорРазделУчета КАК РазделУчета,
	|	ДД.КорПартия КАК Партия,
	|	ДД.КорАналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	ДД.КорАналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	ДД.КорВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	ДД.ТипЗаписи,
	|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
	|	ЕСТЬNULL(ДД.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, НЕОПРЕДЕЛЕНО) КАК КорНаправлениеДеятельности,
	|	ДокументРаспределения.Подразделение,
	|	ДокументРаспределения.СтатьяРасходов,
	|	ДокументРаспределения.АналитикаРасходов,
	|	ДокументРаспределения.НаправлениеДеятельности,
	|	"""" КАК ИдентификаторФинЗаписи,
	|	ДД.ХозяйственнаяОперация,
	|	(ВЫБОР
	|		КОГДА Реестр.Ссылка ЕСТЬ NULL ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА КОНЕЦ) КАК УказанДокументВАналитикеРасходов,			
	|	
	|	ДД.ДоляСтоимостиРегл КАК ЗнаменательРегл,
	|	ДД.ДоляСтоимостиУпр КАК ЗнаменательУпр,
	|	ДД.Количество КАК Количество
	|ИЗ
	|	ДолиДополнительныхРасходов КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК ДокументРаспределения
	|		ПО ДД.Регистратор = ДокументРаспределения.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОрганизацииДляРаспределенияДопРасходовНДС КАК Организации
	|		ПО ДокументРаспределения.Организация = Организации.Ссылка
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РеестрДокументов КАК Реестр
	|		ПО Реестр.Ссылка = ДокументРаспределения.АналитикаРасходов
	|		И НЕ Реестр.ДополнительнаяЗапись
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК Себестоимость
	|		ПО Себестоимость.Регистратор = ДД.Регистратор
	|ГДЕ
	|	ДД.ТипЗаписи В (
	|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам))
	|	И ДокументРаспределения.СтатьяРасходов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.НДСНалоговогоАгента)
	|	И ДД.КорСтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|	И Себестоимость.Регистратор ЕСТЬ NULL
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЛОЖЬ КАК НаВыбытие,
	|	ДД.Период,
	|	ДД.Регистратор,
	|	ДД.Организация,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|	НЕОПРЕДЕЛЕНО КАК Партия,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
	|	ВЫБОР КОГДА КорСтатья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
	|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
	|		ИНАЧЕ ЕСТЬNULL(ПоступлениеТоваров.ЗакупкаПодДеятельность, ПоступлениеУслуг.ЗакупкаПодДеятельность)
	|	КОНЕЦ КАК ВидДеятельностиНДС,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы) КАК ТипЗаписи,
	|	ДД.КорСтатьяРасходов КАК КорСтатьяРасходов,
	|	ДД.КорАналитикаРасходов КАК КорАналитикаРасходов,
	|	ДД.КорПодразделение КАК КорПодразделение,
	|	ДД.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	ДокументРаспределения.Подразделение,
	|	ДокументРаспределения.СтатьяРасходов,
	|	ДокументРаспределения.АналитикаРасходов,
	|	ДокументРаспределения.НаправлениеДеятельности,
	|	ДД.ИдентификаторФинЗаписи,
	|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
	|	(ВЫБОР
	|		КОГДА Реестр.Ссылка ЕСТЬ NULL ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА КОНЕЦ) КАК УказанДокументВАналитикеРасходов,
	|	
	|	СУММА(ВЫБОР
	|		КОГДА ДД.СуммаРегл <> 0 ТОГДА ДД.СуммаРегл
	|		ИНАЧЕ ДД.Сумма КОНЕЦ) КАК ЗнаменательРегл,
	|	СУММА(ВЫБОР
	|		КОГДА ДД.СуммаУпр <> 0 ТОГДА ДД.СуммаУпр
	|		ИНАЧЕ ДД.Сумма КОНЕЦ) КАК ЗнаменательУпр,
	|	СУММА(ЕСТЬNULL(Доли.ДоляСтоимостиРегл, 0)) КАК Количество
	|ИЗ
	|	ВТКэшРасчетныеОборотыПрочиеРасходы КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК ДокументРаспределения
	|		ПО ДД.Регистратор = ДокументРаспределения.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОрганизацииДляРаспределенияДопРасходовНДС КАК Организации
	|		ПО ДД.Организация = Организации.Ссылка
	|	ЛЕВОЕ СОЕДИНЕНИЕ ДолиДополнительныхРасходов КАК Доли
	|		ПО Доли.Регистратор = ДД.Регистратор
	|		И Доли.КорСтатьяРасходов = ДД.КорСтатьяРасходов
	|		И Доли.КорАналитикаРасходов = ДД.КорАналитикаРасходов
	|		И Доли.КорПодразделение = ДД.КорПодразделение
	|		И Доли.КорНаправлениеДеятельности = ДД.КорНаправлениеДеятельности
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РеестрДокументов КАК Реестр
	|		ПО Реестр.Ссылка = ДД.АналитикаРасходов
	|		И НЕ Реестр.ДополнительнаяЗапись
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПриобретениеТоваровУслуг КАК ПоступлениеТоваров
	|		ПО ПоступлениеТоваров.Ссылка = ДокументРаспределения.АналитикаРасходов
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПриобретениеУслугПрочихАктивов КАК ПоступлениеУслуг
	|		ПО ПоступлениеУслуг.Ссылка = ДокументРаспределения.АналитикаРасходов
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК КорСтатья
	|		ПО КорСтатья.Ссылка = ДД.КорСтатьяРасходов
	|ГДЕ
	|	НЕ ДД.СлужебноеВидДвиженияПриход
	|	И (ДД.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.НДСНалоговогоАгента)
	|		ИЛИ ДД.КорСтатьяРасходов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка))
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Период,
	|	ДД.Регистратор,
	|	ДД.Организация,
	|	ДД.КорСтатьяРасходов,
	|	ДД.КорАналитикаРасходов,
	|	ДД.КорПодразделение,
	|	ДД.КорНаправлениеДеятельности,
	|	ВЫБОР КОГДА КорСтатья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
	|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
	|		ИНАЧЕ ЕСТЬNULL(ПоступлениеТоваров.ЗакупкаПодДеятельность, ПоступлениеУслуг.ЗакупкаПодДеятельность)
	|	КОНЕЦ, // ВидДеятельностиНДС
	|	ДокументРаспределения.Подразделение,
	|	ДокументРаспределения.СтатьяРасходов,
	|	ДокументРаспределения.АналитикаРасходов,
	|	ДокументРаспределения.НаправлениеДеятельности,
	|	ДД.ИдентификаторФинЗаписи,
	|	(ВЫБОР
	|		КОГДА Реестр.Ссылка ЕСТЬ NULL ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА КОНЕЦ)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.НаВыбытие,
	|	ДД.Период,
	|	ДД.Регистратор,
	|	ДД.Организация КАК Организация,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.РазделУчета,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.КорСтатьяРасходов,
	|	ДД.КорАналитикаРасходов,
	|	ДД.КорПодразделение,
	|	ДД.КорНаправлениеДеятельности,
	|	ДД.Подразделение КАК Подразделение,
	|	ДД.СтатьяРасходов КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов КАК АналитикаРасходов,
	|	ДД.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ДД.УказанДокументВАналитикеРасходов,
	|	ВЫБОР КОГДА ЛОЖЬ ТОГДА НЕОПРЕДЕЛЕНО // для удобства расстановки тегов
	//++ Локализация
	|		КОГДА ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22) И НЕ Партии.Партия ЕСТЬ NULL
	|			ТОГДА Партии.Партия
	|		КОГДА ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22) И ДД.УказанДокументВАналитикеРасходов
	|			ТОГДА ДД.АналитикаРасходов
	//-- Локализация
	|		ИНАЧЕ ДД.Партия
	|	КОНЕЦ КАК Партия,
	|	ВЫБОР КОГДА ЛОЖЬ ТОГДА НЕОПРЕДЕЛЕНО // для удобства расстановки тегов
	//++ Локализация
	|		КОГДА ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
	|			ТОГДА ЕСТЬNULL(Партии.АналитикаУчетаПартий, ДД.АналитикаУчетаПартий)
	//-- Локализация
	|		ИНАЧЕ ДД.АналитикаУчетаПартий
	|	КОНЕЦ КАК АналитикаУчетаПартий,
	|	ДД.ТипЗаписи,
	|	ДД.ИдентификаторФинЗаписи,
	|	ДД.ХозяйственнаяОперация,
	|	
	|	ВЫРАЗИТЬ(ВЫБОР КОГДА ДД.ЗнаменательРегл < 0 ТОГДА -ДД.ЗнаменательРегл ИНАЧЕ ДД.ЗнаменательРегл КОНЕЦ КАК ЧИСЛО(31,3)) КАК ЗнаменательРегл,
	|	ВЫРАЗИТЬ(ВЫБОР КОГДА ДД.ЗнаменательУпр < 0 ТОГДА -ДД.ЗнаменательУпр ИНАЧЕ ДД.ЗнаменательУпр КОНЕЦ КАК ЧИСЛО(31,3)) КАК ЗнаменательУпр,
	|	ВЫБОР КОГДА ДД.ЗнаменательРегл < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК ЗнакРегл,
	|	ВЫБОР КОГДА ДД.ЗнаменательУпр < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК ЗнакУпр,
	|	ВЫРАЗИТЬ(ДД.Количество КАК ЧИСЛО(31,3)) КАК Количество
	|ПОМЕСТИТЬ ВТБазаРаспределенияДопРасходов
	|ИЗ
	|	ВТБазаРаспределенияДопРасходовБезПартий КАК ДД
	//++ Локализация
	|	ЛЕВОЕ СОЕДИНЕНИЕ ПриходыТоваровНДС КАК Партии
	|		ПО ДД.АналитикаРасходов = Партии.Регистратор
	|		И ДД.АналитикаУчетаНоменклатуры = Партии.АналитикаУчетаНоменклатуры
	|		И ДД.ВидЗапасов = Партии.ВидЗапасов
	|		И ДД.Организация = Партии.Организация
	//-- Локализация
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.Организация КАК Организация,
	|	ДД.Подразделение КАК Подразделение,
	|	ДД.СтатьяРасходов КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов КАК АналитикаРасходов,
	|	ДД.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	СУММА(ДД.ЗнакРегл * ДД.ЗнаменательРегл) КАК ЗнаменательРегл,
	|	СУММА(ДД.ЗнакУпр * ДД.ЗнаменательУпр) КАК ЗнаменательУпр
	|ПОМЕСТИТЬ ВТБазаРаспределенияДопРасходовСводно
	|ИЗ
	|	ВТБазаРаспределенияДопРасходов КАК ДД
	|СГРУППИРОВАТЬ ПО
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	ДД.НаправлениеДеятельности
	|ИНДЕКСИРОВАТЬ ПО
	|	СтатьяРасходов,
	|	АналитикаРасходов,
	|	Подразделение,
	|	Организация,
	|	НаправлениеДеятельности
	|";
	
КонецФункции

//++ Локализация 

// ... выборки данных

Функция ТекстДетальныеНачальныеОстаткиПартийНДС() // использует ВТНачальныеОстаткиПартийНДС
	Возврат
		"ВЫБРАТЬ
		|	""ТекстДетальныеНачальныеОстаткиПартийНДС"" 	 КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Остаток) КАК ТипЗаписи,
		|	ВЫБОР
		|		КОГДА ДД.Знаменатель < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ЭтоСторно,
		|	0 КАК Приоритет,
		|	ДД.Знаменатель,
		|	0 КАК ЗнаменательДляИсточников,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.Номенклатура,
		|	ДД.НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|
		|	ДД.Количество,
		|	ДД.СтоимостьБезНДС,
		|	ДД.НДС,
		|	ДД.СтоимостьБезНДС КАК СтоимостьБезНДСУпр,
		|	ДД.НДСУпр,
		|
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	ЛОЖЬ КАК Сторно
		|ИЗ
		|	ВТНачальныеОстаткиПартийНДС КАК ДД
		|";
КонецФункции

Функция ТекстНачальныеОстаткиПартийНДС() // использует ВТНачальныеОстаткиПартийНДС
	Возврат
		"ВЫБРАТЬ
		|	""ТекстНачальныеОстаткиПартийНДС"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОстатокСгруппированный) КАК ТипЗаписи,
		|	ВЫБОР
		|		КОГДА МАКСИМУМ(ДД.Знаменатель) < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ЭтоСторно,
		|	0 КАК Приоритет,
		|	МАКСИМУМ(ДД.Знаменатель),
		|	СУММА(ДД.Знаменатель) КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	
		|	ВЫБОР КОГДА СУММА(ДД.Знаменатель) < 0 ТОГДА &КонецПериода ИНАЧЕ ДД.Период КОНЕЦ КАК Период,
		|	ДД.Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	ЛОЖЬ КАК Сторно
		|ИЗ
		|	ВТНачальныеОстаткиПартийНДС КАК ДД
		|СГРУППИРОВАТЬ ПО
		|	ДД.Номенклатура,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС
		|";
КонецФункции

Функция ТекстНачальныеОстаткиПартийДляДопРасходов() // использует ВТНачальныеОстаткиПартийНДС
	Возврат
		"ВЫБРАТЬ
		|	""ТекстНачальныеОстаткиПартийДляДопРасходов"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОстатокДляРаспределения) КАК ТипЗаписи,
		|	ВЫБОР
		|		КОГДА МАКСИМУМ(ДД.Знаменатель) < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ЭтоСторно,
		|	0 КАК Приоритет,
		|	МАКСИМУМ(ДД.Знаменатель),
		|	СУММА(ДД.Знаменатель) КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|
		|	0 КАК Количество,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДС,
		|	0 КАК СтоимостьБезНДСУпр,
		|	0 КАК НДСУпр,
		|
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	ЛОЖЬ КАК Сторно
		|ИЗ
		|	ВТНачальныеОстаткиПартийНДС КАК ДД
		|ГДЕ
		|	ДД.Количество <> 0
		|СГРУППИРОВАТЬ ПО
		|	ДД.Номенклатура,
		|	ДД.Период,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС
		|";
КонецФункции

Функция ТекстДетальныеПриходыСебестоимостиТоваров() // использует ПриходыТоваровНДС
	Возврат
		"ВЫБРАТЬ
		|	""ТекстДетальныеПриходыСебестоимостиТоваров"" КАК ЗапросИсточник,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы)
		|		 И ДД.Партия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии)
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода)
		|		 И Приходы.Количество ЕСТЬ NULL
		|		 И Остатки.Количество ЕСТЬ NULL
		|		 И ОстаткиСебестоимостиТоваров.Количество ЕСТЬ NULL
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии)
		|		ИНАЧЕ ДД.ТипЗаписи КОНЕЦ) КАК ТипЗаписи,
		|	(ВЫБОР
		|		КОГДА НЕ Приходы.Количество ЕСТЬ NULL И Приходы.Количество < 0 ТОГДА ИСТИНА
		|		КОГДА НЕ Остатки.Количество ЕСТЬ NULL И Остатки.Количество < 0 ТОГДА ИСТИНА
		|		КОГДА НЕ ОстаткиСебестоимостиТоваров.Количество ЕСТЬ NULL И ОстаткиСебестоимостиТоваров.Количество < 0
		|			ТОГДА ИСТИНА
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК ЭтоСторно,
		|	0 КАК Приоритет,
		|	СУММА(ВЫБОР
		|		КОГДА НЕ Приходы.Количество ЕСТЬ NULL ТОГДА Приходы.Количество
		|		КОГДА НЕ Остатки.Количество ЕСТЬ NULL ТОГДА Остатки.Количество
		|		КОГДА НЕ ОстаткиСебестоимостиТоваров.Количество ЕСТЬ NULL ТОГДА ОстаткиСебестоимостиТоваров.Количество
		|		КОГДА НЕ ОстаткиПартийНДС.Количество ЕСТЬ NULL ТОГДА ОстаткиПартийНДС.Количество
		|		ИНАЧЕ ДД.Количество КОНЕЦ) КАК Знаменатель,
		|	0 КАК ЗнаменательДляИсточников,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.Номенклатура,
		|	ДД.НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ВЫБОР КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода)
		|	 И Приходы.Количество ЕСТЬ NULL
		|	 И Остатки.Количество ЕСТЬ NULL
		|	 И ОстаткиСебестоимостиТоваров.Количество ЕСТЬ NULL
		|		ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.Партия
		|	КОНЕЦ КАК Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|
		|	ДД.Количество,
		|	ДД.СтоимостьБезНДС,
		|	ДД.НДС,
		|	ДД.СтоимостьБезНДСУпр,
		|	ДД.НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
		|	ДД.ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	ДД.Сторно
		|ИЗ
		|	ПриходыТоваровНДС КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиТоваров КАК Остатки
		|		ПО ДД.ТипЗаписи В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|		И ДД.Количество = 0
		|		И Остатки.Организация = ДД.Организация
		|		И Остатки.РазделУчета = ДД.РазделУчета
		|		И Остатки.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Остатки.ВидЗапасов = ДД.ВидЗапасов
		|		И Остатки.Партия = ДД.Партия
		|		И Остатки.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Остатки.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|	ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиСебестоимостиТоваров КАК ОстаткиСебестоимостиТоваров
		|		ПО ОстаткиСебестоимостиТоваров.Организация = ДД.Организация
		|		И ОстаткиСебестоимостиТоваров.РазделУчета = ДД.РазделУчета
		|		И ОстаткиСебестоимостиТоваров.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И ОстаткиСебестоимостиТоваров.ВидЗапасов = ДД.ВидЗапасов
		|		И ОстаткиСебестоимостиТоваров.Партия = ДД.Партия
		|		И ОстаткиСебестоимостиТоваров.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И ОстаткиСебестоимостиТоваров.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПриходыТоваров КАК Приходы
		|		ПО ДД.ТипЗаписи В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|		И ДД.Количество = 0
		|		И Приходы.Организация = ДД.Организация
		|		И Приходы.РазделУчета = ДД.РазделУчета
		|		И Приходы.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Приходы.ВидЗапасов = ДД.ВидЗапасов
		|		И Приходы.Партия = ДД.Партия
		|		И Приходы.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Приходы.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТНачальныеОстаткиПартийНДС КАК ОстаткиПартийНДС
		|		ПО ОстаткиПартийНДС.Организация = ДД.Организация
		|		И ОстаткиПартийНДС.РазделУчета = ДД.РазделУчета
		|		И ОстаткиПартийНДС.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И ОстаткиПартийНДС.ВидЗапасов = ДД.ВидЗапасов
		|		И ОстаткиПартийНДС.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И ОстаткиПартийНДС.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|		И ОстаткиПартийНДС.Регистратор = ДД.ДокументИсточник
		|		И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода)
		|		И ОстаткиПартийНДС.Количество <> 0
		|ГДЕ
		|	НЕ (ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|		И ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)))
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И ДД.ВидДеятельностиНДС <> НЕОПРЕДЕЛЕНО
		|	И (ДД.Количество <> 0
		|		ИЛИ ДД.СтоимостьБезНДС <> 0
		|		ИЛИ ДД.НДС <> 0
		|		ИЛИ ДД.НДСУпр <> 0)
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы)
		|		 И ДД.Партия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии)
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода)
		|		 И Приходы.Количество ЕСТЬ NULL
		|		 И Остатки.Количество ЕСТЬ NULL
		|		 И ОстаткиСебестоимостиТоваров.Количество ЕСТЬ NULL
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии)
		|		ИНАЧЕ ДД.ТипЗаписи КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА НЕ Приходы.Количество ЕСТЬ NULL И Приходы.Количество < 0 ТОГДА ИСТИНА
		|		КОГДА НЕ Остатки.Количество ЕСТЬ NULL И Остатки.Количество < 0 ТОГДА ИСТИНА
		|		КОГДА НЕ ОстаткиСебестоимостиТоваров.Количество ЕСТЬ NULL И ОстаткиСебестоимостиТоваров.Количество < 0
		|			ТОГДА ИСТИНА
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ),
		|	ДД.Номенклатура,
		|	ДД.НалогообложениеПартии,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ВЫБОР КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода)
		|	 И Приходы.Количество ЕСТЬ NULL
		|	 И Остатки.Количество ЕСТЬ NULL
		|	 И ОстаткиСебестоимостиТоваров.Количество ЕСТЬ NULL
		|		ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.Партия
		|	КОНЕЦ,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|	ДД.Количество,
		|	ДД.СтоимостьБезНДС,
		|	ДД.НДС,
		|	ДД.СтоимостьБезНДСУпр,
		|	ДД.НДСУпр,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	ДД.ДокументИсточник,
		|	ДД.Сторно
		|";
КонецФункции

Функция ТекстПриходыСебестоимостиТоваров() // использует ПриходыТоваровНДС
	Возврат
		"ВЫБРАТЬ
		|	""ТекстПриходыСебестоимостиТоваров"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПартияСгруппированная) КАК ТипЗаписи,
		|	МАКСИМУМ(ВЫБОР
		|		КОГДА НЕ Приходы.Количество ЕСТЬ NULL И Приходы.Количество < 0 ТОГДА ИСТИНА
		|		КОГДА НЕ Остатки.Количество ЕСТЬ NULL И Остатки.Количество < 0 ТОГДА ИСТИНА
		|		КОГДА НЕ ОстаткиСебестоимостиТоваров.Количество ЕСТЬ NULL И ОстаткиСебестоимостиТоваров.Количество < 0
		|			ТОГДА ИСТИНА
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК ЭтоСторно,
		|	0 КАК Приоритет,
		|	МАКСИМУМ(ВЫБОР
		|		КОГДА НЕ Приходы.Количество ЕСТЬ NULL ТОГДА Приходы.Количество
		|		КОГДА НЕ Остатки.Количество ЕСТЬ NULL ТОГДА Остатки.Количество
		|		КОГДА НЕ ОстаткиСебестоимостиТоваров.Количество ЕСТЬ NULL ТОГДА ОстаткиСебестоимостиТоваров.Количество
		|		ИНАЧЕ ДД.Количество КОНЕЦ) КАК Знаменатель,
		|	0 КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	
		|	ЕСТЬNULL(ПериодикаПартии.ДатаРегистратора, &КонецПредыдущегоПериода) КАК Период,
		|	ЕСТЬNULL(ИсправленныеДокументы.Регистратор, ДД.Партия) КАК Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|
		|	0 КАК Количество,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДС,
		|	0 КАК СтоимостьБезНДСУпр,
		|	0 КАК НДСУпр,
		|
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	ДД.Сторно
		|ИЗ
		|	ПриходыТоваровНДС КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиТоваров КАК Остатки
		|		ПО ДД.ТипЗаписи В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|		И ДД.Количество = 0
		|		И Остатки.Организация = ДД.Организация
		|		И Остатки.РазделУчета = ДД.РазделУчета
		|		И Остатки.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Остатки.ВидЗапасов = ДД.ВидЗапасов
		|		И Остатки.Партия = ДД.Партия
		|		И Остатки.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Остатки.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|	ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиСебестоимостиТоваров КАК ОстаткиСебестоимостиТоваров
		|		ПО ОстаткиСебестоимостиТоваров.Организация = ДД.Организация
		|		И ОстаткиСебестоимостиТоваров.РазделУчета = ДД.РазделУчета
		|		И ОстаткиСебестоимостиТоваров.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И ОстаткиСебестоимостиТоваров.ВидЗапасов = ДД.ВидЗапасов
		|		И ОстаткиСебестоимостиТоваров.Партия = ДД.Партия
		|		И ОстаткиСебестоимостиТоваров.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И ОстаткиСебестоимостиТоваров.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПриходыТоваров КАК Приходы
		|		ПО ДД.ТипЗаписи В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|		И ДД.Количество = 0
		|		И Приходы.Организация = ДД.Организация
		|		И Приходы.РазделУчета = ДД.РазделУчета
		|		И Приходы.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Приходы.ВидЗапасов = ДД.ВидЗапасов
		|		И Приходы.Партия = ДД.Партия
		|		И Приходы.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Приходы.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ПериодикаПартии
		|		ПО ПериодикаПартии.Организация = ДД.Организация
		|		И ПериодикаПартии.Документ = ДД.Партия
		|	ЛЕВОЕ СОЕДИНЕНИЕ ИсправленныеДокументыНДС КАК ИсправленныеДокументы
		|		ПО ИсправленныеДокументы.Регистратор = ДД.Регистратор
		|ГДЕ
		|	НЕ (ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|		И ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)))
		|	И (ДД.Количество <> 0
		|		ИЛИ ДД.СтоимостьБезНДС <> 0
		|		ИЛИ ДД.НДС <> 0
		|		ИЛИ ДД.НДСУпр <> 0)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Номенклатура,
		|	ЕСТЬNULL(ПериодикаПартии.ДатаРегистратора, &КонецПредыдущегоПериода),
		|	ЕСТЬNULL(ИсправленныеДокументы.Регистратор, ДД.Партия),
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.Сторно
		|";
КонецФункции

Функция ТекстПриходыСебестоимостиТоваровДляДопРасходов() // использует ПриходыТоваровНДС
	Возврат
		"ВЫБРАТЬ
		|	""ТекстПриходыСебестоимостиТоваровДляДопРасходов"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПартииДляРаспределения) КАК ТипЗаписи,
		|	МАКСИМУМ(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК ЭтоСторно,
		|	0 КАК Приоритет,
		|	МАКСИМУМ(ДД.Количество) КАК Знаменатель,
		|	0 КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	
		|	ДД.Период КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|
		|	0 КАК Количество,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДС,
		|	0 КАК СтоимостьБезНДСУпр,
		|	0 КАК НДСУпр,
		|
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
		|	ДД.Партия КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	ДД.Сторно
		|ИЗ
		|	ПриходыТоваровНДС КАК ДД
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ПериодикаПартии
		|		ПО ПериодикаПартии.Организация = ДД.Организация
		|		И ПериодикаПартии.Документ = ДД.Партия
		|ГДЕ
		|	ДД.Количество <> 0
		|СГРУППИРОВАТЬ ПО
		|	ДД.Номенклатура,
		|	ДД.Период,
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.Сторно
		|";
КонецФункции

Функция ТекстПриходыСебестоимостиТоваровВПути()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстПриходыСебестоимостиТоваровВПути"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПартииВПути) КАК ТипЗаписи,
		|	ВЫБОР
		|		КОГДА СУММА(ДД.Количество) < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ЭтоСторно,
		|	0 КАК Приоритет,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	0 КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	
		|	МИНИМУМ(ДД.Период) КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета КАК РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК ВидЗапасов,
		|	ДД.Партия КАК Партия,
		|	ДД.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|
		|	0 КАК Количество,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДС,
		|	0 КАК СтоимостьБезНДСУпр,
		|	0 КАК НДСУпр,
		|
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС КАК КорВидДеятельностиНДС,
		|	ДД.КорРазделУчета КАК КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	ДД.КорПартия КАК КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
		|	ДД.Партия КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	ДД.Сторно
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПоступлениеТоваровНаСклад КАК Поступления
		|	ПО ДД.Регистратор = Поступления.Ссылка
		|ГДЕ
		|	ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщикаПоступлениеИзТоваровВПути)
		|	И НЕ ДД.СлужебноеВидДвиженияПриход
		|	И ДД.Количество <> 0
		|СГРУППИРОВАТЬ ПО
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.Сторно
		|";
КонецФункции

Функция ТекстДвиженияСебестоимостиТоваров()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстДвиженияСебестоимостиТоваров"" КАК ЗапросИсточник,
		|	ДД.ТипЗаписи,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|		 И Выпуски.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|			ТОГДА ЛОЖЬ
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|		 И Выпуски.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|			ТОГДА ЛОЖЬ
		|			ИНАЧЕ ДД.ЭтоСторно
		|		КОНЕЦ) КАК ЭтоСторно,
		|	0 КАК Приоритет,
		|	СУММА(ДД.Знаменатель) КАК Знаменатель,
		|	СУММА(ВЫБОР
		|			КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|			 И Выпуски.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|				ТОГДА Выпуски.Знаменатель
		|			КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|			 И Выпуски.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|				ТОГДА Выпуски.Знаменатель
		//++ Устарело_Переработка24
		|			КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|			 И РаботыДляДавальца.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|				ТОГДА РаботыДляДавальца.Знаменатель
		|			КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|			 И РаботыДляДавальца.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|				ТОГДА РаботыДляДавальца.Знаменатель
		//-- Устарело_Переработка24
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|		 И ДД.Партия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.РазделУчета В (
		|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути),
		|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссиюВПути),
		|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссиюВПути))
		|		 И ДД.Партия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.Партия КОНЕЦ) КАК Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДС,
		|	0 КАК СтоимостьБезНДСУпр,
		|	0 КАК НДСУпр,
		|	ДД.ХозяйственнаяОперация,
		|	(ВЫБОР
		//++ Устарело_Переработка24
		|		КОГДА РаботыДляДавальца.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|			И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА РаботыДляДавальца.ВидДеятельностиНДС
		//-- Устарело_Переработка24
		|		КОГДА ИСТИНА
		|			ТОГДА ДД.КорВидДеятельностиНДС КОНЕЦ) КАК КорВидДеятельностиНДС,
		|	(ВЫБОР
		//++ Устарело_Переработка24
		|		КОГДА РаботыДляДавальца.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|			И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА РаботыДляДавальца.РазделУчета
		//-- Устарело_Переработка24
		|		КОГДА ИСТИНА
		|			ТОГДА ДД.КорРазделУчета КОНЕЦ) КАК КорРазделУчета,
		|	(ВЫБОР
		//++ Устарело_Переработка24
		|		КОГДА РаботыДляДавальца.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|			И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА РаботыДляДавальца.АналитикаУчетаНоменклатуры
		//-- Устарело_Переработка24
		|		КОГДА ИСТИНА
		|			ТОГДА ДД.КорАналитикаУчетаНоменклатуры КОНЕЦ) КАК КорАналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		//++ Устарело_Переработка24
		|		КОГДА РаботыДляДавальца.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|			И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА РаботыДляДавальца.ВидЗапасов
		//-- Устарело_Переработка24
		|		КОГДА ИСТИНА
		|			ТОГДА ДД.КорВидЗапасов КОНЕЦ) КАК КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|		 И ДД.КорПартия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|		 И ДД.КорПартия = НЕОПРЕДЕЛЕНО
		|		 И Выпуски.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписаниеНаДругиеПартии)
		|		 И ДД.КорПартия = НЕОПРЕДЕЛЕНО
		|		 И ДД.Регистратор ССЫЛКА Документ.СборкаТоваров
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.КорРазделУчета В (
		|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути),
		|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссиюВПути),
		|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссиюВПути))
		|		 И ДД.КорПартия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.КорПартия КОНЕЦ) КАК КорПартия,
		|	(ВЫБОР
		|		КОГДА РаботыДляДавальца.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		 И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА РаботыДляДавальца.АналитикаФинансовогоУчета
		|		КОГДА ИСТИНА
		|			ТОГДА ДД.КорАналитикаФинансовогоУчета КОНЕЦ) КАК КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
		|	ДД.ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.Сторно
		|ИЗ
		|	ДвиженияСебестоимостиНДС КАК ДД
		|		ЛЕВОЕ СОЕДИНЕНИЕ ДвиженияСебестоимостиНДС КАК Выпуски
		|		ПО ДД.Регистратор = Выпуски.Регистратор
		|			И ДД.КорПартия = Выпуски.Партия
		|			И ДД.КорАналитикаУчетаНоменклатуры = Выпуски.АналитикаУчетаНоменклатуры
		|			И ДД.КорРазделУчета = Выпуски.РазделУчета
		|			И ДД.КорВидЗапасов = Выпуски.ВидЗапасов
		|			И ДД.КорАналитикаФинансовогоУчета = Выпуски.АналитикаФинансовогоУчета
		|			И ДД.КорВидДеятельностиНДС = Выпуски.ВидДеятельностиНДС
		|			И (ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)))
		|			И (Выпуски.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск))
		|
		//++ Устарело_Переработка24
		|		ЛЕВОЕ СОЕДИНЕНИЕ ДвиженияСебестоимостиНДС КАК РаботыДляДавальца
		|		ПО ДД.Регистратор = РаботыДляДавальца.Регистратор
		|			И ДД.КорПартия = РаботыДляДавальца.Партия
		|			И ДД.КорАналитикаУчетаНоменклатуры = РаботыДляДавальца.КорАналитикаУчетаНоменклатуры
		|			И ДД.КорВидЗапасов = РаботыДляДавальца.КорВидЗапасов
		|			И (ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)))
		|			И (РаботыДляДавальца.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск))
		//-- Устарело_Переработка24
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.ТипЗаписи,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|		 И Выпуски.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|			ТОГДА ЛОЖЬ
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|		 И Выпуски.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|			ТОГДА ЛОЖЬ
		|			ИНАЧЕ ДД.ЭтоСторно
		|		КОНЕЦ),
		|	ДД.Номенклатура,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|		 И ДД.Партия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.РазделУчета В (
		|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути),
		|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссиюВПути),
		|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссиюВПути))
		|		 И ДД.Партия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.Партия КОНЕЦ),
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.ХозяйственнаяОперация,
		|	(ВЫБОР
		//++ Устарело_Переработка24
		|		КОГДА РаботыДляДавальца.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|			И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА РаботыДляДавальца.ВидДеятельностиНДС
		//-- Устарело_Переработка24
		|		КОГДА ИСТИНА
		|			ТОГДА ДД.КорВидДеятельностиНДС КОНЕЦ),
		|	(ВЫБОР
		//++ Устарело_Переработка24
		|		КОГДА РаботыДляДавальца.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|			И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА РаботыДляДавальца.РазделУчета
		//-- Устарело_Переработка24
		|		КОГДА ИСТИНА
		|			ТОГДА ДД.КорРазделУчета КОНЕЦ),
		|	(ВЫБОР
		//++ Устарело_Переработка24
		|		КОГДА РаботыДляДавальца.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|			И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА РаботыДляДавальца.АналитикаУчетаНоменклатуры
		//-- Устарело_Переработка24
		|		КОГДА ИСТИНА
		|			ТОГДА ДД.КорАналитикаУчетаНоменклатуры КОНЕЦ),
		|	(ВЫБОР
		//++ Устарело_Переработка24
		|		КОГДА РаботыДляДавальца.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|			И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА РаботыДляДавальца.ВидЗапасов
		//-- Устарело_Переработка24
		|		КОГДА ИСТИНА
		|			ТОГДА ДД.КорВидЗапасов КОНЕЦ),
		|	ДД.КорОрганизация,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|		 И ДД.КорПартия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|		 И ДД.КорПартия = НЕОПРЕДЕЛЕНО
		|		 И Выпуски.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписаниеНаДругиеПартии)
		|		 И ДД.КорПартия = НЕОПРЕДЕЛЕНО
		|		 И ДД.Регистратор ССЫЛКА Документ.СборкаТоваров
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.КорРазделУчета В (
		|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути),
		|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссиюВПути),
		|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссиюВПути))
		|		 И ДД.КорПартия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.КорПартия КОНЕЦ),
		|	(ВЫБОР
		//++ Устарело_Переработка24
		|		КОГДА РаботыДляДавальца.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|			И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА РаботыДляДавальца.АналитикаФинансовогоУчета
		//-- Устарело_Переработка24
		|		КОГДА ИСТИНА
		|			ТОГДА ДД.КорАналитикаФинансовогоУчета
		|	КОНЕЦ),
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.ДокументИсточник,
		|	ДД.Сторно
		|";
КонецФункции

Функция ТекстДвиженияСебестоимостиТоваровСборка()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстДвиженияСебестоимостиТоваровСборка"" КАК ЗапросИсточник,
		|	(ВЫБОР
		|		КОГДА ДД.Сторно ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ИсправлениеТекущегоПериода)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение) КОНЕЦ) КАК ТипЗаписи,
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК ЭтоСторно,
		|	0 КАК Приоритет,
		|	СУММА(ВЫБОР КОГДА ДД.Сторно ТОГДА -ДД.Количество
		|		ИНАЧЕ ДД.Количество КОНЕЦ) КАК Знаменатель,
		|	МАКСИМУМ(ВЫБОР КОГДА ДД.Сторно ТОГДА -Приходы.Количество
		|		ИНАЧЕ Приходы.Количество КОНЕЦ) КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.КорАналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.КорРазделУчета КАК РазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов КАК ВидЗапасов,
		|	ДД.Регистратор КАК Партия,
		|	ДД.КорАналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
		|	ДД.КорВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДС,
		|	0 КАК СтоимостьБезНДСУпр,
		|	0 КАК НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
		|	(ВЫБОР
		|		КОГДА ДД.Сторно ТОГДА ДД.ДокументИсточник
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ) КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.Сторно
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПриходыСборокТоваров КАК Приходы
		|		ПО Приходы.Организация = ДД.Организация
		|		И Приходы.РазделУчета = ДД.КорРазделУчета
		|		И Приходы.АналитикаУчетаНоменклатуры = ДД.КорАналитикаУчетаНоменклатуры
		|		И Приходы.Партия = ДД.КорПартия
		|		И Приходы.АналитикаФинансовогоУчета = ДД.КорАналитикаФинансовогоУчета
		|		И Приходы.ВидДеятельностиНДС = ДД.КорВидДеятельностиНДС
		|		И Приходы.Регистратор = ДД.Регистратор
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.Количество <> 0
		|	И ДД.Регистратор ССЫЛКА Документ.СборкаТоваров
		|	И ДД.ТипЗаписи В (
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписаниеНаДругиеПартии),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СторноСписанияНаДругиеПартии))
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА ДД.Сторно ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ИсправлениеТекущегоПериода)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение) КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ),
		|	ДД.КорАналитикаУчетаНоменклатуры.Номенклатура,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.ХозяйственнаяОперация,
		|	(ВЫБОР
		|		КОГДА ДД.Сторно ТОГДА ДД.ДокументИсточник
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ),
		|	ДД.Сторно
		|";
КонецФункции

Функция ТекстВозвратыПрошлыхПериодов()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстВозвратыПрошлыхПериодов"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов) КАК ТипЗаписи,
		|	ИСТИНА КАК ЭтоСторно,
		|	0 КАК Приоритет,
		|	-ДД.Количество КАК Знаменатель,
		|	0 КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|
		|	-ДД.Количество,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДС,
		|	0 КАК СтоимостьБезНДСУпр,
		|	0 КАК НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.РазделУчета КАК КорРазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ДД.Организация КАК КорОрганизация,
		|	ДД.Партия КАК КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
		|	ДД.ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.Сторно
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.Количество <> 0
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов)
		|	И НЕ ДД.Сторно
		|";
КонецФункции

Функция ТекстРеализацииПрошлыхМесяцевПартииНДС() // использует ПрошлыеРеализации 
	Возврат
		"ВЫБРАТЬ
		|	""ТекстРеализацииПрошлыхМесяцевПартииНДС"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Прошлое) КАК ТипЗаписи,
		|	ЛОЖЬ КАК ЭтоСторно,
		|	0 КАК Приоритет,
		|	ПрошлыеСебестоимость.Количество				КАК Знаменатель,
		|	0 											КАК ЗнаменательДляИсточников,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура 	КАК Номенклатура,
		|	ДД.КорВидДеятельностиНДС 					КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.КорВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|
		|	ДД.Количество,
		|	ДД.СтоимостьБезНДС,
		|	ДД.НДС,
		|	ДД.СтоимостьБезНДС КАК СтоимостьБезНДСУпр,
		|	ДД.НДСУпр,
		|
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	ДД.Сторно
		|ИЗ
		|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрошлыеРеализацииПартийНДС КАК Прошлые
		|		ПО ДД.Регистратор = Прошлые.ДокументИсточник
		|		И ДД.Организация = Прошлые.Организация
		|		И ДД.РазделУчета = Прошлые.РазделУчета
		|		И ДД.АналитикаУчетаНоменклатуры = Прошлые.АналитикаУчетаНоменклатуры
		|		И ДД.ВидЗапасов = Прошлые.ВидЗапасов
		|		И ДД.АналитикаФинансовогоУчета = Прошлые.АналитикаФинансовогоУчета
		|		И ДД.КорВидДеятельностиНДС = Прошлые.ВидДеятельностиНДС
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрошлыеРеализацииСебестоимость КАК ПрошлыеСебестоимость
		|		ПО ДД.Регистратор = ПрошлыеСебестоимость.Регистратор
		|		И ДД.Организация = ПрошлыеСебестоимость.Организация
		|		И ДД.РазделУчета = ПрошлыеСебестоимость.РазделУчета
		|		И ДД.АналитикаУчетаНоменклатуры = ПрошлыеСебестоимость.АналитикаУчетаНоменклатуры
		|		И ДД.ВидЗапасов = ПрошлыеСебестоимость.ВидЗапасов
		|		И ДД.АналитикаФинансовогоУчета = ПрошлыеСебестоимость.АналитикаФинансовогоУчета
		|		И ДД.КорВидДеятельностиНДС = ПрошлыеСебестоимость.ВидДеятельностиНДС
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.Активность
		|	И НЕ (ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|		И ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением))
		|	И НЕ ДД.Сторно
		|";
КонецФункции

Функция ТекстРеализацииПрошлыхМесяцевПартииНДС21() // использует ПрошлыеРеализации 
	Возврат
		"ВЫБРАТЬ
		|	""ТекстРеализацииПрошлыхМесяцевПартииНДС21"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Прошлое) КАК ТипЗаписи,
		|	ЛОЖЬ КАК ЭтоСторно,
		|	0 КАК Приоритет,
		|	Прошлые.Количество							КАК Знаменатель,
		|	0 											КАК ЗнаменательДляИсточников,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.Номенклатура								КАК Номенклатура,
		|	ДД.НалогообложениеНДС						КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	Прошлые.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	Прошлые.Партия,
		|	Прошлые.АналитикаФинансовогоУчета,
		|	ДД.НалогообложениеНДС КАК ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|
		|	ДД.Количество,
		|	ДД.СтоимостьБезНДС,
		|	ДД.НДСРегл,
		|	0 КАК СтоимостьБезНДСУпр,
		|	0 КАК НДСУпр,
		|
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	ЛОЖЬ КАК Сторно
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрошлыеРеализацииПартийНДС КАК Прошлые
		|		ПО ДД.Регистратор = Прошлые.ДокументИсточник
		|		И ДД.Организация = Прошлые.Организация
		|		И ДД.АналитикаУчетаНоменклатуры = Прошлые.АналитикаУчетаНоменклатуры
		|		И ДД.ВидЗапасов = Прошлые.ВидЗапасов
		|		И (ДД.ДокументПоступления = Прошлые.Партия
		|			ИЛИ Прошлые.Партия = НЕОПРЕДЕЛЕНО)
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.Активность
		|";
КонецФункции

Функция ТекстТаможенныеДекларацииИзменениеВидыДеятельностиНДС()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстТаможенныеДекларацииИзменениеВидыДеятельностиНДС"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВключениеИсключениеНДСВСтоимости) КАК ТипЗаписи,
		|	ЛОЖЬ КАК ЭтоСторно,
		|	0 КАК Приоритет,
		|	0 КАК Знаменатель,
		|	0 КАК ЗнаменательДляИсточников,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.Организация В (&ОрганизацииСФИФОСкользящая)
		|			ТОГДА ДД.Партия
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ) КАК Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.КорВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|
		|	ДД.КорАналитикаУчетаПартий КАК АналитикаУчетаПартий,
		|	ДД.Регистратор КАК ДокументПоступления,
		|
		|	0 КАК Количество,
		|	0 КАК СтоимостьБезНДС,
		|	ДД.НДСРегл КАК НДС,
		|	0 КАК СтоимостьБезНДСУпр,
		|	(ВЫБОР
		|		КОГДА &УправленческийУчетОрганизаций ТОГДА ДД.НДСУпр
		|		ИНАЧЕ 0 КОНЕЦ) КАК НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
		|	ДД.ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	ЛОЖЬ КАК Сторно
		|ИЗ
		|	ВТИзменениеВидаДеятельностиДопРасходов КАК ДД
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	""ТекстТаможенныеДекларацииИзменениеВидыДеятельностиНДС"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВключениеИсключениеНДСВСтоимости) КАК ТипЗаписи,
		|	ЛОЖЬ КАК ЭтоСторно,
		|	0 КАК Приоритет,
		|	0 КАК Знаменатель,
		|	0 КАК ЗнаменательДляИсточников,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.Организация В (&ОрганизацииСФИФОСкользящая)
		|			ТОГДА ДД.Партия
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ) КАК Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.КорВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|
		|	ДД.КорАналитикаУчетаПартий КАК АналитикаУчетаПартий,
		|	ДД.Регистратор КАК ДокументПоступления,
		|
		|	0 КАК Количество,
		|	0 КАК СтоимостьБезНДС,
		|	ДД.НДСРегл КАК НДС,
		|	0 КАК СтоимостьБезНДСУпр,
		|	(ВЫБОР
		|		КОГДА &УправленческийУчетОрганизаций ТОГДА ДД.НДСУпр
		|		ИНАЧЕ 0 КОНЕЦ) КАК НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.ВидДеятельностиНДС КАК КорВидДеятельностиНДС,
		|	ДД.РазделУчета КАК КорРазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ДД.Организация КАК КорОрганизация,
		|	ДД.Партия КАК КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
		|	ДД.ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
		|	ДД.КорНаправлениеДеятельности,
		|	ЛОЖЬ КАК Сторно
		|ИЗ
		|	ВТИзменениеВидаДеятельностиДопРасходов КАК ДД
		|";
КонецФункции

Функция ТекстСторноДвиженияИсправленныхДокументовПрошлогоПериодаНДС() // использует ИсправленныеДокументыНДС 
	Возврат
		"ВЫБРАТЬ
		|	""ТекстСторноДвиженияИсправленныхДокументовПрошлогоПериодаНДС"" КАК ЗапросИсточник,
		|	(ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И ИсправленныеДокументы.ИсправлениеПеремещения
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ИсправлениеПеремещенияПрошлогоПериода)
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ИсправлениеПрошлогоПериода) КОНЕЦ) КАК ТипЗаписи,
		|	ИСТИНА КАК ЭтоСторно,
		|	0 КАК Приоритет,
		|	ВЫБОР КОГДА ДД.Количество = 0
		|		ТОГДА -Знаменатели.Знаменатель
		|		ИНАЧЕ -ДД.Количество
		|	КОНЕЦ 										КАК Знаменатель,
		|	0 											КАК ЗнаменательДляИсточников,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура 	КАК Номенклатура,
		|	ДД.КорВидДеятельностиНДС 					КАК НалогообложениеПартии,
		|
		|	ИсправленныеДокументы.Период,
		|	ИсправленныеДокументы.Регистратор,	
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|
		|	-ДД.Количество,
		|	-ДД.СтоимостьБезНДС,
		|	-ДД.НДС,
		|	-ДД.СтоимостьБезНДС КАК СтоимостьБезНДСУпр,
		|	-ДД.НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.СтатьяСписанияНДС,
		|	ДД.АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
		|	ДД.КорНаправлениеДеятельности,
		|	ИСТИНА КАК Сторно
		|ИЗ
		|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИсправленныеДокументыНДС КАК ИсправленныеДокументы
		|		ПО ИсправленныеДокументы.ДокументИсточник = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ ЗнаменателиИсправленныхДокументовНДС КАК Знаменатели
		|		ПО Знаменатели.Организация = ДД.Организация
		|		И Знаменатели.РазделУчета = ДД.РазделУчета
		|		И Знаменатели.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Знаменатели.ВидЗапасов = ДД.ВидЗапасов
		|		И Знаменатели.Партия = ДД.Партия
		|		И Знаменатели.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Знаменатели.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.Активность
		|	И ДД.Период < &НачалоПериода
		|	И ДД.ТипЗаписи <> ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы)
		|	И НЕ ДД.Сторно
		|";
КонецФункции

Функция ТекстДопРасходыСредняяДляРаспределенияРегл()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстДопРасходыСредняяДляРаспределенияРегл"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыДляРаспределенияРегл) КАК ТипЗаписи,
		|	ВЫБОР КОГДА МАКСИМУМ(База.ЗнаменательРегл) < 0 ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ КАК ЭтоСторно,
		|	0 											КАК Приоритет,
		|	МАКСИМУМ(База.ЗнаменательРегл) 				КАК Знаменатель,
		|	0											КАК ЗнаменательДляИсточников,
		|	ИСТИНА 										КАК РасчетЗавершен,
		|	
		|	НЕОПРЕДЕЛЕНО 								КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО 								КАК НалогообложениеПартии,
		|
		|	ВЫБОР КОГДА СУММА(ДД.ЗнаменательРегл) < 0 ТОГДА &КонецПредыдущегоПериода ИНАЧЕ ДД.Период КОНЕЦ КАК Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Партия,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|
		|	0 КАК Количество,
		|	ДД.СтоимостьРегл КАК СтоимостьБезНДС,
		|	ДД.НДСРегл КАК НДС,
		|	ВЫБОР КОГДА ДД.НДСУпр = 0 ТОГДА ДД.СтоимостьБезНДСУпр ИНАЧЕ 0 КОНЕЦ КАК СтоимостьБезНДСУпр,
		|	0 КАК НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.ВидДеятельностиНДС КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение КАК Подразделение,
		|	ДД.СтатьяРасходов КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	ДД.НаправлениеДеятельности,
		|	ДД.НаправлениеДеятельности КАК КорНаправлениеДеятельности,
		|	ЛОЖЬ КАК Сторно
		|ИЗ
		|	ВТДопРасходыДляРаспределения КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТБазаРаспределенияДопРасходовСводно КАК База
		|		ПО ДД.Организация = База.Организация
		|		И ДД.Подразделение = База.Подразделение
		|		И ДД.НаправлениеДеятельности = База.НаправлениеДеятельности
		|		И ДД.СтатьяРасходов = База.СтатьяРасходов
		|		И ДД.АналитикаРасходов = База.АналитикаРасходов
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И База.ЗнаменательРегл <> 0
		|	И (ДД.СтоимостьРегл <> 0 ИЛИ ДД.НДСРегл <> 0)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартийДокументаПоступления,
		|	ДД.НаправлениеДеятельности,
		|	ДД.СтоимостьРегл,
		|	ДД.НДСРегл,
		|	ВЫБОР КОГДА ДД.НДСУпр = 0 ТОГДА ДД.СтоимостьБезНДСУпр ИНАЧЕ 0 КОНЕЦ,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.Подразделение
		|";
КонецФункции

Функция ТекстБазаДопРасходыСредняяРегл()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстБазаДопРасходыСредняяРегл"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.БазаДопРасходыРегл) КАК ТипЗаписи,
		|	ЛОЖЬ КАК ЭтоСторно,
		|	ВЫБОР КОГДА ДД.ЗнакРегл = -1 ТОГДА 0 ИНАЧЕ 10 КОНЕЦ КАК Приоритет,
		|	СУММА(ДД.Количество)						КАК Знаменатель,
		|	СУММА(ДД.ЗнаменательРегл)					КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ 										КАК РасчетЗавершен,
		|	
		|	ВЫРАЗИТЬ(ДД.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Номенклатура КАК Номенклатура,
		|	ВЫРАЗИТЬ(ДД.АналитикаУчетаПартий КАК Справочник.КлючиАналитикиУчетаПартий).НалогообложениеНДС 		КАК НалогообложениеПартии,
		|
		|	ДД.Период КАК Период,
		|	ДД.Регистратор КАК Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия КАК Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|
		|	0 КАК Количество,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДС,
		|	0 КАК СтоимостьБезНДСУпр,
		|	0 КАК НДСУпр,
		|
		|	ВЫБОР КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
		|	 И ДД.ХозяйственнаяОперация <> НЕОПРЕДЕЛЕНО
		|	 И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка)
		|			ТОГДА ДД.ХозяйственнаяОперация
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаСебестоимость)
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	ДД.РазделУчета КАК КорРазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение КАК Подразделение,
		|	ДД.СтатьяРасходов КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	ДД.КорСтатьяРасходов,
		|	ДД.КорАналитикаРасходов,
		|	ДД.КорПодразделение,
		|	(ВЫБОР
		|		КОГДА ДД.УказанДокументВАналитикеРасходов ТОГДА ДД.АналитикаРасходов
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	ДД.НаправлениеДеятельности,
		|	ДД.КорНаправлениеДеятельности,
		|	ЛОЖЬ КАК Сторно
		|ИЗ
		|	ВТБазаРаспределенияДопРасходов КАК ДД
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.ЗнаменательРегл <> 0
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА ДД.ЗнакРегл = -1 ТОГДА 0 ИНАЧЕ 10 КОНЕЦ,
		|	ВЫРАЗИТЬ(ДД.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Номенклатура,
		|	ВЫРАЗИТЬ(ДД.АналитикаУчетаПартий КАК Справочник.КлючиАналитикиУчетаПартий).НалогообложениеНДС,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	ВЫБОР КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
		|	 И ДД.ХозяйственнаяОперация <> НЕОПРЕДЕЛЕНО
		|	 И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка)
		|			ТОГДА ДД.ХозяйственнаяОперация
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаСебестоимость)
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.КорСтатьяРасходов,
		|	ДД.КорАналитикаРасходов,
		|	ДД.КорПодразделение,
		|	(ВЫБОР
		|		КОГДА ДД.УказанДокументВАналитикеРасходов ТОГДА ДД.АналитикаРасходов
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
		|	ДД.НаправлениеДеятельности,
		|	ДД.КорНаправлениеДеятельности
		|";
КонецФункции

Функция ТекстДопРасходыСредняяДляРаспределенияУпр()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстДопРасходыСредняяДляРаспределенияУпр"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыДляРаспределенияУпр) КАК ТипЗаписи,
		|	ВЫБОР КОГДА МАКСИМУМ(База.ЗнаменательУпр) < 0 ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ КАК ЭтоСторно,
		|	0 											КАК Приоритет,
		|	МАКСИМУМ(База.ЗнаменательУпр) 				КАК Знаменатель,
		|	0											КАК ЗнаменательДляИсточников,
		|	ИСТИНА 										КАК РасчетЗавершен,
		|	
		|	НЕОПРЕДЕЛЕНО 								КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО 								КАК НалогообложениеПартии,
		|
		|	ВЫБОР КОГДА СУММА(ДД.ЗнаменательУпр) < 0 ТОГДА &КонецПредыдущегоПериода ИНАЧЕ ДД.Период КОНЕЦ КАК Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Партия,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|
		|	0 КАК Количество,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДС,
		|	ДД.СтоимостьБезНДСУпр КАК СтоимостьБезНДСУпр,
		|	ДД.НДСУпр КАК НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.ВидДеятельностиНДС КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение КАК Подразделение,
		|	ДД.СтатьяРасходов КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	ДД.НаправлениеДеятельности,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК КорНаправлениеДеятельности,
		|	ЛОЖЬ КАК Сторно
		|ИЗ
		|	ВТДопРасходыДляРаспределения КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТБазаРаспределенияДопРасходовСводно КАК База
		|		ПО ДД.Организация = База.Организация
		|		И ДД.Подразделение = База.Подразделение
		|		И ДД.НаправлениеДеятельности = База.НаправлениеДеятельности
		|		И ДД.СтатьяРасходов = База.СтатьяРасходов
		|		И ДД.АналитикаРасходов = База.АналитикаРасходов
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И База.ЗнаменательУпр <> 0
		|	И (ДД.СтоимостьБезНДСУпр <> 0 ИЛИ ДД.НДСУпр <> 0)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.ВидДеятельностиНДС,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартийДокументаПоступления,
		|	ДД.НаправлениеДеятельности,
		|	ДД.СтоимостьБезНДСУпр,
		|	ДД.НДСУпр,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.Подразделение
		|";
КонецФункции

Функция ТекстБазаДопРасходыСредняяУпр()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстБазаДопРасходыСредняяУпр"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.БазаДопРасходыУпр) КАК ТипЗаписи,
		|	ЛОЖЬ КАК ЭтоСторно,
		|	ВЫБОР КОГДА ДД.ЗнакУпр = -1 ТОГДА 0 ИНАЧЕ 10 КОНЕЦ КАК Приоритет,
		|	СУММА(ДД.Количество)						КАК Знаменатель,
		|	СУММА(ДД.ЗнаменательУпр)					КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ 										КАК РасчетЗавершен,
		|	
		|	ВЫРАЗИТЬ(ДД.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Номенклатура КАК Номенклатура,
		|	ВЫРАЗИТЬ(ДД.АналитикаУчетаПартий КАК Справочник.КлючиАналитикиУчетаПартий).НалогообложениеНДС 		КАК НалогообложениеПартии,
		|
		|	ДД.Период КАК Период,
		|	ДД.Регистратор КАК Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия КАК Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|
		|	0 КАК Количество,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДС,
		|	0 КАК СтоимостьБезНДСУпр,
		|	0 КАК НДСУпр,
		|
		|	ВЫБОР КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
		|	 И ДД.ХозяйственнаяОперация <> НЕОПРЕДЕЛЕНО
		|	 И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка)
		|			ТОГДА ДД.ХозяйственнаяОперация
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаСебестоимость)
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	ДД.РазделУчета КАК КорРазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение КАК Подразделение,
		|	ДД.СтатьяРасходов КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	ДД.КорСтатьяРасходов,
		|	ДД.КорАналитикаРасходов,
		|	ДД.КорПодразделение,
		|	(ВЫБОР
		|		КОГДА ДД.УказанДокументВАналитикеРасходов ТОГДА ДД.АналитикаРасходов
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	ДД.НаправлениеДеятельности,
		|	ДД.КорНаправлениеДеятельности,
		|	ЛОЖЬ КАК Сторно
		|ИЗ
		|	ВТБазаРаспределенияДопРасходов КАК ДД
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.ЗнаменательУпр <> 0
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА ДД.ЗнакУпр = -1 ТОГДА 0 ИНАЧЕ 10 КОНЕЦ,
		|	ВЫРАЗИТЬ(ДД.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Номенклатура,
		|	ВЫРАЗИТЬ(ДД.АналитикаУчетаПартий КАК Справочник.КлючиАналитикиУчетаПартий).НалогообложениеНДС,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	ВЫБОР КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
		|	 И ДД.ХозяйственнаяОперация <> НЕОПРЕДЕЛЕНО
		|	 И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка)
		|			ТОГДА ДД.ХозяйственнаяОперация
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаСебестоимость)
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.КорСтатьяРасходов,
		|	ДД.КорАналитикаРасходов,
		|	ДД.КорПодразделение,
		|	(ВЫБОР
		|		КОГДА ДД.УказанДокументВАналитикеРасходов ТОГДА ДД.АналитикаРасходов
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
		|	ДД.НаправлениеДеятельности,
		|	ДД.КорНаправлениеДеятельности
		|";
КонецФункции

Функция ТекстДанныеДляДетализацииПартийТоваровДляНДСиУСН()
	ТекстЗапроса = 
		"ВЫБРАТЬ
		|	""ТекстДанныеДляДетализацииПартийТоваровДляНДСиУСН"" КАК ЗапросИсточник,
		|	ДД.ТипЗаписи,
		|	ЛОЖЬ КАК ЭтоСторно,
		|	0 КАК Приоритет,
		|	0 КАК Знаменатель,
		|	0 КАК ЗнаменательДляИсточников,
		|	ДД.РасчетЗавершен,
		|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
		|	ДД.НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|
		|	ДД.Количество,
		|	ДД.СтоимостьБезНДС,
		|	ВЫБОР КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы)
		|	 И ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|		ТОГДА 0
		|		ИНАЧЕ ДД.НДС
		|	КОНЕЦ КАК НДС,
		|	0 КАК СтоимостьБезНДСУпр,
		|	ВЫБОР КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы)
		|	 И ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|		ТОГДА 0
		|		ИНАЧЕ ДД.НДСУпр
		|	КОНЕЦ КАК НДСУпр,
		|
		|	ВЫБОР
		|		КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|		 И НЕ ЕСТЬNULL(СтатьиРасходов.ПринятиеКНалоговомуУчету, ИСТИНА) И ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
		|		 И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНДСПоПриобретеннымЦенностям)
		|		ИНАЧЕ ДД.ХозяйственнаяОперация
		|	КОНЕЦ КАК ХозяйственнаяОперация,
		|	ВЫБОР
		|		КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|		 И НЕ ЕСТЬNULL(СтатьиРасходов.ПринятиеКНалоговомуУчету, ИСТИНА) И ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
		|		 И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС
		|	КОНЕЦ КАК КорВидДеятельностиНДС,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
		|	ДД.ДокументИсточник,
		// Если в настройке учета НДС установлен флажок "Списывать НДС по расходам, не принимаемым к НУ" и указана статья расходов,
		// не принимаемая к налоговому учету по налогу на прибыль, то такие расходы списываются на статью и аналитику расходов 
		// из настройки учета НДС, если НДС не был включен в стоимость товара.
		|	ВЫБОР
		|		КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|		 И НЕ ЕСТЬNULL(СтатьиРасходов.ПринятиеКНалоговомуУчету, ИСТИНА) И ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
		|		 И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
		|			ТОГДА НастройкиУчетаНДС.СтатьяРасходовСписаниеНДС
		|		ИНАЧЕ ДД.СтатьяСписанияНДС
		|	КОНЕЦ КАК СтатьяСписанияНДС,
		|	ВЫБОР
		|		КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|		 И НЕ ЕСТЬNULL(СтатьиРасходов.ПринятиеКНалоговомуУчету, ИСТИНА) И ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
		|		 И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
		|			ТОГДА НастройкиУчетаНДС.АналитикаРасходовСписаниеНДС
		|		ИНАЧЕ ДД.АналитикаСписанияНДС
		|	КОНЕЦ КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.Сторно
		|ИЗ
		|	ВтДетализацияПартийТоваровДляНДСиУСН КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходов
		|		ПО СтатьиРасходов.Ссылка = ДД.СтатьяРасходовАктивов
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТНастройкиУчетаНДС КАК НастройкиУчетаНДС
		|		ПО НастройкиУчетаНДС.Организация = ДД.Организация
		|ГДЕ
		|	ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|";
	Возврат ТекстЗапроса;
	 
КонецФункции

// Заполнение расчетной партии

Процедура ЗаполнитьРасчетнуюПартиюНДС(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход)
	
	Если Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Перемещение
	 И Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПартияСгруппированная
	 И ТипЗнч(Расход.Регистратор) <> Тип("ДокументСсылка.СборкаТоваров") Тогда
		Возврат; // для производственных документов вместо Перемещения используется Выпуск
		
	ИначеЕсли ТипЗнч(Расход.Регистратор) = Тип("ДокументСсылка.КорректировкаПриобретения")
	 И Приход.Партия <> Расход.Партия Тогда
		Возврат; // для корректировок приобретения прошлого периода можно подобрать только исходную партию
	
	ИначеЕсли ТипЗнч(Расход.Регистратор) = Тип("ДокументСсылка.Сторно")
	 И Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.КорректировкаПриобретения
	 И ЗначениеЗаполнено(Расход.ДокументИсточник)
	 И Расход.ДокументИсточник <> Приход.Партия Тогда
		Возврат; // сторно должно подобрать партию сторнируемого документа
	КонецЕсли;
	
	СуммовыеРесурсы = Новый Структура("СтоимостьБезНДС, НДС, СтоимостьБезНДСУпр, НДСУпр");
	
	// Заполняем расчетную партию по расходной партии-основании
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	
	//	Заполняем партионную идентификацию в расчетной партии
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход, "ДокументПоступления, АналитикаУчетаПартий, НалогообложениеПартии");
	
	Если НЕ ЗначениеЗаполнено(РасчетнаяПартия.ДокументПоступления)
	 И (Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ДопРасходыДляРаспределенияРегл
	   ИЛИ Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ДопРасходыДляРаспределенияУпр) Тогда
	   
		ДопустимыеТипы = Метаданные.РегистрыНакопления.ПартииПрочихРасходов.Измерения.ДокументПоступленияРасходов.Тип;
		РасчетнаяПартия.ДокументИсточник = ДопустимыеТипы.ПривестиЗначение(Приход.Регистратор); // для формирования движений по партиям прочих расходов по исходному документу поступления
		
	Иначе
		
		РасчетнаяПартия.ДокументИсточник = Неопределено;
		
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.Партия) Тогда
		РасчетнаяПартия.Партия = Приход.Партия;
	КонецЕсли;
	
	// Заменим старые аналитики учета партий на новые.
	Если ПараметрыРасчета.РаспределениеПартий.ДополнительныеСвойства.Свойство("АналитикиУчетаПартий") Тогда
		
		АналитикиУчетаПартий = ПараметрыРасчета.РаспределениеПартий.ДополнительныеСвойства.АналитикиУчетаПартий; // Соответствие
		НоваяАналитикаУчетаПартий = АналитикиУчетаПартий.Получить(РасчетнаяПартия.АналитикаУчетаПартий);
		
		Если ЗначениеЗаполнено(НоваяАналитикаУчетаПартий) Тогда
			РасчетнаяПартия.АналитикаУчетаПартий = НоваяАналитикаУчетаПартий;
		КонецЕсли;
		
	КонецЕсли;
	
	КорректироватьБазуВРасходе = Ложь;
	
	// Расчетная партия заполняется на наибольшее общее вычитаемое
	Если ((РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Перемещение
	 	  И ТипЗнч(РасчетнаяПартия.Регистратор) = Тип("ДокументСсылка.СборкаТоваров"))
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск) Тогда
		КоличествоСписания = Мин(Расход.Количество, Приход.Знаменатель);
		ЗнаменательСписания = КоличествоСписания;
		ПриходБазис = ?(Приход.Знаменатель <> 0, КоличествоСписания / Приход.Знаменатель, 0);
	ИначеЕсли РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Выпуск Тогда
		КоличествоСписания = Мин(Расход.Знаменатель, Приход.ЗнаменательДляИсточников);
		ЗнаменательСписания = КоличествоСписания;
		ПриходБазис = ?(Приход.ЗнаменательДляИсточников <> 0, КоличествоСписания / Приход.ЗнаменательДляИсточников, 0);
	ИначеЕсли РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПартияСгруппированная
	 И Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Перемещение
	 И ТипЗнч(Приход.Регистратор) = Тип("ДокументСсылка.СборкаТоваров") Тогда
		КоличествоСписания = Мин(Расход.Знаменатель, Приход.ЗнаменательДляИсточников);
		ЗнаменательСписания = КоличествоСписания;
		ПриходБазис = 1;
	ИначеЕсли РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПартияСгруппированная Тогда
		КоличествоСписания = Мин(Расход.Знаменатель, Приход.Знаменатель);
		ЗнаменательСписания = КоличествоСписания;
		ПриходБазис = 1;
	ИначеЕсли РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.БазаДопРасходыРегл
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.БазаДопРасходыУпр Тогда
		КоличествоСписания = Мин(Расход.ЗнаменательДляИсточников, Приход.Знаменатель);
		ЗнаменательСписания = КоличествоСписания;
		ПриходБазис = ?(Приход.Знаменатель <> 0, КоличествоСписания / (Приход.Знаменатель * ?(Приход.ЭтоСторно, -1, 1)), 0);
	ИначеЕсли Приход.Количество <> 0 Тогда
		КорректироватьБазуВРасходе = Истина;
		КоличествоСписания = Мин(Расход.Количество, Приход.Количество);
		ПриходБазис = ?(Приход.Количество <> 0, КоличествоСписания / Приход.Количество, 0);
		ЗнаменательСписания = Мин(Расход.Знаменатель, ПриходБазис * Приход.Знаменатель);
	Иначе
		КоличествоСписания = Мин(Расход.Знаменатель, Приход.Знаменатель);
		ЗнаменательСписания = КоличествоСписания;
		ПриходБазис = ?(Приход.Знаменатель <> 0, КоличествоСписания / Приход.Знаменатель, 0);
	КонецЕсли;
	Если ПриходБазис = 0 Тогда
		Возврат;
	КонецЕсли;
	
	// Заполняем показатели расчетной партии
	Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Выпуск Тогда
		РасчетнаяПартия.Количество = 0;
	ИначеЕсли РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Перемещение
	 И ТипЗнч(РасчетнаяПартия.Регистратор) = Тип("ДокументСсылка.СборкаТоваров") Тогда
		РасчетнаяПартия.Количество = 0;
	ИначеЕсли РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск Тогда
		РасчетнаяПартия.Количество = Окр(ПриходБазис * Приход.Количество, 3);
	ИначеЕсли РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПартияСгруппированная Тогда
		РасчетнаяПартия.Количество = Приход.Количество;
	Иначе
		РасчетнаяПартия.Количество = Мин(Расход.Количество, Приход.Количество);
	КонецЕсли;
	РасчетнаяПартия.Знаменатель = 0;
	
	Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПартияСгруппированная
	 И Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Перемещение
	 И ТипЗнч(Приход.Регистратор) = Тип("ДокументСсылка.СборкаТоваров") Тогда
	 	РасчетнаяПартия.Знаменатель = Приход.ЗнаменательДляИсточников;
	ИначеЕсли РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПартияСгруппированная Тогда
		РасчетнаяПартия.Знаменатель = Приход.Знаменатель;
	ИначеЕсли РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.БазаДопРасходыРегл
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.БазаДопРасходыУпр Тогда
		РасчетнаяПартия.Знаменатель = Расход.Знаменатель;
	Иначе
		РасчетнаяПартия.Знаменатель = 0;
	КонецЕсли;
	
	Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
		РасчетнаяПартия[ИмяРесурса.Ключ] = Окр(ПриходБазис * Приход[ИмяРесурса.Ключ], 2);
	КонецЦикла;
	
	// Корректируем базу расчета в приходе
	Если НЕ (Приход.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияКлиентуРеглУчет
		И Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Потребление)
	И НЕ (Приход.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию
		И Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Потребление)
	И НЕ (Приход.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СторноРеализацииВозвратНаДругойСклад
		И Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.СторноВозвратНаДругойСклад
		И Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ВозвратНаДругойСклад)
	И НЕ (Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.СписаниеНаДругиеПартии
		И Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Перемещение)
	И НЕ (Приход.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства
		И Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Распределение) Тогда
	 
	 	Если НЕ Приход.ЭтоСторно И РасчетнаяПартия.ЭтоСторно
		 И РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Потребление Тогда
			Знак = -1;
		Иначе
			Знак = 1;
		КонецЕсли;
	 
	    Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Выпуск Тогда
			Приход.Знаменатель = Приход.Знаменатель - Знак * Окр(ПриходБазис * Приход.Знаменатель, 3);
			Приход.Количество = Приход.Количество - Знак * РасчетнаяПартия.Количество;
			Приход.ЗнаменательДляИсточников = Приход.ЗнаменательДляИсточников - Знак * ЗнаменательСписания;
		ИначеЕсли РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.БазаДопРасходыРегл
		 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.БазаДопРасходыУпр Тогда
			
			// Доп. расходы с отрицательным знаменателем идут первыми (для этого при выборке данных у них особым образом заполняется поле Период)
			// Для последующего корректного списания положительных доп. расходов знаменатель базы надо увеличить на сумму отрицательных знаменателей.  		
		 	Если ЗнаменательСписания < 0 Тогда
				Расход.ЗнаменательДляИсточников = Расход.ЗнаменательДляИсточников - ЗнаменательСписания;
		 	КонецЕсли;
		 	
			Приход.Знаменатель = Приход.Знаменатель - Знак * ЗнаменательСписания;
			
		 	Если Приход.ЭтоСторно Тогда
				Знак = -1; // для корректировки сумм в приходе
			КонецЕсли;
			
		Иначе
			Приход.Знаменатель = Приход.Знаменатель - Знак * ЗнаменательСписания;
			Приход.Количество = Приход.Количество - Знак * РасчетнаяПартия.Количество;
		КонецЕсли;
		
		Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
			Приход[ИмяРесурса.Ключ] = Приход[ИмяРесурса.Ключ] - Знак * РасчетнаяПартия[ИмяРесурса.Ключ];
		КонецЦикла;
	 	
	КонецЕсли;
	
	// Корректируем базу расчета в расходе
	Если КорректироватьБазуВРасходе Тогда
		
		Расход.Количество = Расход.Количество - РасчетнаяПартия.Количество;
		
		Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
			Расход[ИмяРесурса.Ключ] = Расход[ИмяРесурса.Ключ] - РасчетнаяПартия[ИмяРесурса.Ключ];
		КонецЦикла;
		
	КонецЕсли;
	
	Если Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ДопРасходы
	 И Приход.ВидДеятельностиНДС = Перечисления.ТипыНалогообложенияНДС.ОпределяетсяРаспределением Тогда
		РасчетнаяПартия.НДС = 0;
		РасчетнаяПартия.НДСУпр = 0;
	КонецЕсли;
	 
	СуммовыеРесурсыНДС = Новый Структура("НДС, НДСУпр");
	ЗаполнитьСтатьюИАналитикуСписанияНДС(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход, СуммовыеРесурсыНДС);
	
	Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ОстатокДляРаспределения
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПартииВПути
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПартииДляРаспределения Тогда
		РасчетнаяПартия.Период = Приход.Период;
		РасчетнаяПартия.Регистратор = Приход.Регистратор;
	ИначеЕсли РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.БазаДопРасходыРегл
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.БазаДопРасходыУпр Тогда
		РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ДопРасходы;
		РасчетнаяПартия.ЗнаменательДляИсточников = 0;
		РасчетнаяПартия.Подразделение = Приход.Подразделение;
	 	РасчетнаяПартия.КорВидДеятельностиНДС = Приход.КорВидДеятельностиНДС;
	КонецЕсли;
	
	// По результатам партионной идентификации определяем завершенность расчета
	Если РасчетнаяПартия.Количество = 0
	 И РасчетнаяПартия.СтоимостьБезНДС = 0
	 И РасчетнаяПартия.НДС = 0
	 И РасчетнаяПартия.НДСУпр = 0 Тогда
		РасчетнаяПартия.РасчетЗавершен = Ложь;
		
	ИначеЕсли ТипЗнч(Приход.Регистратор) = Тип("ДокументСсылка.ВводОстатков") 
		Или ТипЗнч(Приход.Регистратор) = Тип("ДокументСсылка.ВводОстатковТоваров") Тогда
		// Для документов ВводОстатков с реквизитом ВводОстатков22 = Ложь в таблице Данные
		// установлен признак РасчетЗавершен = Ложь для того, чтобы движения этого документа не записывались в ИБ,
		// т.к. они уже сформированы самим документом.
		РасчетнаяПартия.РасчетЗавершен = Истина;
	Иначе
		РасчетнаяПартия.РасчетЗавершен = Приход.РасчетЗавершен;
	КонецЕсли;
	
	Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ОстатокДляРаспределения
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПартииДляРаспределения Тогда
		
		РасчетнаяПартияРасход = РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьРасчетнуюПартию(ПараметрыРасчета, РасчетнаяПартия, Ложь);
		РасчетнаяПартияРасход.ВидДвижения = ВидДвиженияНакопления.Расход;
		РасчетнаяПартияРасход.Партия = Неопределено;
		
	ИначеЕсли РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПартииВПути Тогда
		
		РасчетнаяПартияРасход = РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьРасчетнуюПартию(ПараметрыРасчета, Приход, Ложь);
		РасчетнаяПартияРасход.ВидДвижения = ВидДвиженияНакопления.Расход;
		
		Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
			РасчетнаяПартияРасход[ИмяРесурса.Ключ] = РасчетнаяПартия[ИмяРесурса.Ключ];
		КонецЦикла;
		
		РасчетнаяПартияРасход.КорАналитикаУчетаНоменклатуры = РасчетнаяПартия.АналитикаУчетаНоменклатуры;
		РасчетнаяПартияРасход.КорВидЗапасов 				= РасчетнаяПартия.ВидЗапасов;
		РасчетнаяПартияРасход.КорПартия 					= РасчетнаяПартия.Партия;
		РасчетнаяПартияРасход.КорРазделУчета 				= РасчетнаяПартия.РазделУчета;
		РасчетнаяПартияРасход.КорВидДеятельностиНДС 		= РасчетнаяПартия.ВидДеятельностиНДС;
		РасчетнаяПартияРасход.КорАналитикаФинансовогоУчета 	= РасчетнаяПартия.АналитикаФинансовогоУчета;
		
	ИначеЕсли (Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.БазаДопРасходыРегл
	 ИЛИ Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.БазаДопРасходыУпр)
	 И ЗначениеЗаполнено(Расход.ХозяйственнаяОперация) Тогда
	 
		РасчетнаяПартияРасход = РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьРасчетнуюПартию(ПараметрыРасчета, РасчетнаяПартия, Ложь);
		РасчетнаяПартияРасход.ВидДвижения = ВидДвиженияНакопления.Расход;
		
		РасчетнаяПартия.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РаспределениеРасходовНаСебестоимость;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьСтатьюИАналитикуСписанияНДС(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход, СуммовыеРесурсыНДС)
	
	Период = НачалоМесяца(РасчетнаяПартия.Период);
	
	ПараметрыУчетнойПолитики = НастройкиНалоговУчетныхПолитик.ДействующиеПараметрыНалоговУчетныхПолитикНаДату("НастройкиУчетаНДС", РасчетнаяПартия.Организация, НачалоМесяца(Период)); 
	
	Если ПараметрыУчетнойПолитики <> Неопределено
	 И ПараметрыУчетнойПолитики.ВариантУчетаНДСПриИзмененииВидаДеятельности = Перечисления.ВариантыУчетаНДСПриИзмененииВидаДеятельностиНаНеоблагаемую.ВключатьВСтоимость Тогда
		Возврат;
	КонецЕсли;
	
	Если УчетНДСУП.ВозможноСписаниеНДС(РасчетнаяПартия.ВидДеятельностиНДС, РасчетнаяПартия.КорВидДеятельностиНДС)
	 ИЛИ (РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Приход
	  И УчетНДСУП.ВозможноСписаниеНДС(Приход.ВидДеятельностиНДС, Приход.КорВидДеятельностиНДС)) Тогда
	
		Если ПараметрыУчетнойПолитики <> Неопределено
		 И ПараметрыУчетнойПолитики.ВариантУчетаНДСПриИзмененииВидаДеятельности = Перечисления.ВариантыУчетаНДСПриИзмененииВидаДеятельностиНаНеоблагаемую.ВключатьВСтоимостьИлиРасходыВЗависимостиОтПериода Тогда
			
			Если ЗначениеЗаполнено(РасчетнаяПартия.ДокументПоступления) Тогда
				ДатаПартии = НачалоМесяца(ОбщегоНазначения.ЗначениеРеквизитаОбъекта(РасчетнаяПартия.ДокументПоступления, "Дата"));
			Иначе
				ДатаПартии = Дата(1,1,1);
			КонецЕсли;
			
			Если ДатаПартии = Период Тогда
				Возврат;
			КонецЕсли;
			
		КонецЕсли;
		
		Если ПараметрыУчетнойПолитики <> Неопределено
		 И УчетНДСУП.ВозможноСписаниеНДС(РасчетнаяПартия.ВидДеятельностиНДС, РасчетнаяПартия.КорВидДеятельностиНДС) Тогда
			
			Если РасчетнаяПартия.КорВидДеятельностиНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС Тогда
				РасчетнаяПартия.СтатьяСписанияНДС 	 = ПараметрыУчетнойПолитики.СтатьяРасходовНеНДС;
				РасчетнаяПартия.АналитикаСписанияНДС = ПараметрыУчетнойПолитики.АналитикаРасходовНеНДС;
			Иначе
				РасчетнаяПартия.СтатьяСписанияНДС 	 = ПараметрыУчетнойПолитики.СтатьяРасходовЕНВД;
				РасчетнаяПартия.АналитикаСписанияНДС = ПараметрыУчетнойПолитики.АналитикаРасходовЕНВД;
			КонецЕсли;
			
		Иначе
			
			// При вызове из процедуры ЗаполнитьРасчетнуюПартиюНДС колонки НДС имеют имена НДС и НДСУпр.
			// При вызове из процедуры ЗаполнитьРасчетнуюПартиюНДС2_4 колонки НДС имеют имена НДСРегл и НДСУпр.
			Для Каждого ИмяРесурса Из СуммовыеРесурсыНДС Цикл
				РасчетнаяПартия[ИмяРесурса.Ключ] = 0;
			КонецЦикла;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

//-- Локализация

#КонецОбласти

#Область ПроцедурыЭтапа_РасчетПартийНДС2_4

// Формирует временную таблицу ВТДвиженияВводаОстатков.
//
Процедура ИнициализироватьТаблицыДляДокументовВводаОстатков(ПараметрыРасчета)
	
	СуществующиеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета);
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 0
	|	Себестоимость.АналитикаУчетаНоменклатуры,
	|	Т.Организация,
	|	Т.Партия,
	|	Т.ВидЗапасов,
	|	Себестоимость.РазделУчета,
	|	Т.АналитикаУчетаПартий,
	|	Себестоимость.АналитикаФинансовогоУчета,
	|	Себестоимость.ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаДокументаПоступления,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовАктивов,
	|	0 КАК Количество,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК НДС,
	|	0 КАК СтоимостьБезНДСУпр,
	|	0 КАК НДСУпр
	|ПОМЕСТИТЬ ВТДвиженияВводаОстатков0
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиПартииТоваров КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров КАк Себестоимость
	|		ПО ЛОЖЬ
	|;
	|ВЫБРАТЬ
	|	Т.Дата,
	|	Т.Ссылка
	|ИЗ
	|	Документ.ВводОстатковТоваров КАК Т
	|ГДЕ
	|	Т.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
	|	И Т.ХозяйственнаяОперация В (
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковСобственныхТоваров),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковТоваровПереданныхНаКомиссию),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковМатериаловПереданныхВПроизводство),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковТоваровПереданныхНаКомиссию2_5),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковТоваровПереданныхНаОтветственноеХранение),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковВозвратнойТарыПринятойОтПоставщиков)
	|		)
	|	И Т.Проведен
	|
	//++ Локализация
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Дата,
	|	Т.Ссылка
	|ИЗ
	|	Документ.ВводОстатков КАК Т
	|ГДЕ
	|	Т.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
	|	И Т.ХозяйственнаяОперация В (
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковСобственныхТоваров),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковТоваровПереданныхНаКомиссию),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковВозвратнойТарыПринятойОтПоставщиков),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковМатериаловПереданныхВПроизводство),
	//++ Устарело_Переработка24
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковМатериаловПереданныхПереработчикам)
	//-- Устарело_Переработка24
	|		)
	|	И Т.Проведен
	//-- Локализация
	|
	|УПОРЯДОЧИТЬ ПО
	|	Дата
	|";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ИменаВременныхТаблиц = "ВТДвиженияВводаОстатков0";
	НомерДокумента = 0;
	
	Пока Выборка.Следующий() Цикл
		
		НомерДокумента = НомерДокумента + 1;
		ИмяТекущейВТ = "ВТДвиженияВводаОстатков" + Формат(НомерДокумента, "ЧГ=");
		ИменаВременныхТаблиц = ИменаВременныхТаблиц + ", " + ИмяТекущейВТ;
		
		ТекстыЗапроса = Новый СписокЗначений;
		ЗапросДокумента = Новый Запрос;
		ЗапросДокумента.УстановитьПараметр(РасчетСебестоимостиПрикладныеАлгоритмы.ИмяСлужебногоДополнительногоСвойстваОбъекта(), Истина);
		ЗапросДокумента.УстановитьПараметр("ИмяВременнойТаблицыПартийНДС2_4", ИмяТекущейВТ);
		
		//++ Локализация
		Если ТипЗнч(Выборка.Ссылка) = Тип("ДокументСсылка.ВводОстатков") Тогда
			Документы.ВводОстатков.ЗаполнитьПараметрыИнициализации(ЗапросДокумента, Выборка.Ссылка);
			Документы.ВводОстатков.ТекстЗапросаТаблицаДетализацияПартийТоваровДляНДСиУСН2_4(ЗапросДокумента, ТекстыЗапроса, "");
		Иначе
		//-- Локализация
			Документы.ВводОстатковТоваров.ЗаполнитьПараметрыИнициализации(ЗапросДокумента, Выборка.Ссылка);
			Документы.ВводОстатковТоваров.ТекстЗапросаТаблицаДетализацияПартийТоваровДляНДСиУСН2_4(ЗапросДокумента, ТекстыЗапроса, "");
		//++ Локализация
		КонецЕсли;
		//-- Локализация
		
		ЗапросДокумента.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
		ЗапросДокумента.Текст = СтрСоединить(ТекстыЗапроса.ВыгрузитьЗначения(), Символы.ПС + ";" + Символы.ПС);
		
		ЗапросДокумента.Выполнить();
		
		НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(
			ПараметрыРасчета,
			СуществующиеВТ + ", " + ИменаВременныхТаблиц);
		
		РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);
		
	КонецЦикла;
	
	ИменаКолонок = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьИменаКолонокСтрокой(
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыгрузитьВременнуюТаблицу(ПараметрыРасчета, "ВТДвиженияВводаОстатков0"));
		
	РасчетСебестоимостиПрикладныеАлгоритмы.ОбъединитьВременныеТаблицы(
		ПараметрыРасчета,
		ИменаВременныхТаблиц,
		"ВТДвиженияВводаОстатков",
		ИменаКолонок,
		"Количество, СтоимостьБезНДС, НДС, СтоимостьБезНДСУпр, НДСУпр",
		"ДокументПоступления",
		Истина);
	
	// Уничтожим ненужные временные таблицы.
	НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(
		ПараметрыРасчета,
		СуществующиеВТ + ", ВТДвиженияВводаОстатков");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);
	
	Если РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(ПараметрыРасчета, "ВТДвиженияВводаОстатков") = 0 Тогда
		
		// Добавим поле ЭтоПеременныеДопРасходы в ВТДвиженияВводаОстатков
		Запрос.Текст =
		"ВЫБРАТЬ
		|	Т.ДокументПоступления,
		|	Т.АналитикаУчетаДокументаПоступления,
		|	Т.Организация,
		|	Т.РазделУчета,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.ВидДеятельностиНДС,
		|	Т.АналитикаФинансовогоУчета,
		|	Т.СтатьяРасходовАктивов,
		|	Т.СтоимостьБезНДСУпр,
		|	Т.НДСУпр,
		|	Т.СтоимостьБезНДС,
		|	Т.НДС,
		|	Т.Количество,
		|	ЛОЖЬ КАК ЭтоПеременныеДопРасходы
		|ПОМЕСТИТЬ ВТДвиженияВводаОстатковНовые
		|ИЗ
		|	ВТДвиженияВводаОстатков КАК Т
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ВТДвиженияВводаОстатков
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	*
		|ПОМЕСТИТЬ ВТДвиженияВводаОстатков
		|ИЗ
		|	ВТДвиженияВводаОстатковНовые КАК Т
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ВТДвиженияВводаОстатковНовые
		|";
		
		Запрос.Выполнить();
		
		Возврат;
		
	КонецЕсли;
	
	// Если движения ввода остатков по аналитикам из ВТАналитикиВводаОстатков встречаются больше одного раза в текущем периоде или были в прошлых периодах,
	// то такие движения надо помещать в периодический регистр партий.
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаДокументаПоступления,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.Организация,
	|	Т.ВидЗапасов,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	СУММА(1) КАК КоличествоЗаписей
	|ПОМЕСТИТЬ ВТАналитикиВводаОстатков
	|ИЗ
	|	ВТДвиженияВводаОстатков КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаДокументаПоступления,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.Организация,
	|	Т.ВидЗапасов,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументПоступления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаДокументаПоступления,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.Организация,
	|	Т.ВидЗапасов,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	СУММА(Т.СтоимостьБезНДСРегл) КАК СтоимостьБезНДСРегл,
	|	СУММА(Т.НДСРегл) КАК НДСРегл,
	|	СУММА(Т.СтоимостьБезНДСУпр) КАК СтоимостьБезНДСУпр,
	|	СУММА(Т.НДСУпр) КАК НДСУпр
	|ПОМЕСТИТЬ ВТПартииПеременные
	|ИЗ
	|(ВЫБРАТЬ
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаДокументаПоступления,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.Организация,
	|	Т.ВидЗапасов,
	|	Т.Номенклатура КАК Номенклатура,
	|	Т.Характеристика КАК Характеристика,
	|	Т.СтоимостьБезНДСРегл,
	|	Т.НДСРегл,
	|	Т.СтоимостьБезНДСУпр,
	|	Т.НДСУпр
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиПартииТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТАналитикиВводаОстатков КАК Отбор
	|		ПО Т.ДокументПоступления = Отбор.ДокументПоступления
	|		И Т.АналитикаУчетаПартийДокументаПоступления = Отбор.АналитикаУчетаДокументаПоступления
	|		И Т.Партия = Отбор.Партия
	|		И Т.АналитикаУчетаПартий = Отбор.АналитикаУчетаПартий
	|		И Т.Организация = Отбор.Организация
	|		И Т.ВидЗапасов = Отбор.ВидЗапасов
	|		И Т.Номенклатура = Отбор.Номенклатура
	|		И Т.Характеристика = Отбор.Характеристика
	|ГДЕ
	|	Т.ПериодРегистрации < &НачалоПериода
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаДокументаПоступления,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.Организация,
	|	Т.ВидЗапасов,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	Т.СтоимостьБезНДСРегл,
	|	Т.НДСРегл,
	|	Т.СтоимостьБезНДСУпр,
	|	Т.НДСУпр
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиТоваровПостатейныеЗатраты КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТАналитикиВводаОстатков КАК Отбор
	|		ПО Т.ДокументПоступления = Отбор.ДокументПоступления
	|		И Т.АналитикаУчетаПартийДокументаПоступления = Отбор.АналитикаУчетаДокументаПоступления
	|		И Т.Партия = Отбор.Партия
	|		И Т.АналитикаУчетаПартий = Отбор.АналитикаУчетаПартий
	|		И Т.Организация = Отбор.Организация
	|		И Т.ВидЗапасов = Отбор.ВидЗапасов
	|		И Т.АналитикаУчетаНоменклатуры.Номенклатура = Отбор.Номенклатура
	|		И Т.АналитикаУчетаНоменклатуры.Характеристика = Отбор.Характеристика
	|ГДЕ
	|	Т.Период < &НачалоПериода
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаДокументаПоступления,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.Организация,
	|	Т.ВидЗапасов,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	0,
	|	0,
	|	0,
	|	0
	|ИЗ
	|	ВТАналитикиВводаОстатков КАК Т
	|ГДЕ
	|	Т.КоличествоЗаписей > 1
	|) КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаДокументаПоступления,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.Организация,
	|	Т.ВидЗапасов,
	|	Т.Номенклатура,
	|	Т.Характеристика
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументПоступления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.Организация,
	|	Т.ВидЗапасов,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Т.ДокументПоступления) КАК КоличествоДокументов,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Т.АналитикаУчетаДокументаПоступления) КАК КоличествоАналитик
	|ПОМЕСТИТЬ ВТДокументыПоступленияПеременные
	|ИЗ
	|	ВТАналитикиВводаОстатков КАК Т
	|ГДЕ
	|	Т.КоличествоЗаписей = 1
	|СГРУППИРОВАТЬ ПО
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.Организация,
	|	Т.ВидЗапасов,
	|	Т.Номенклатура,
	|	Т.Характеристика
	|ИМЕЮЩИЕ
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Т.ДокументПоступления) > 1
	|	ИЛИ КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Т.АналитикаУчетаДокументаПоступления) > 1
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаДокументаПоступления,
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.СтатьяРасходовАктивов,
	|	Т.СтоимостьБезНДСУпр - Т.Количество * ЕСТЬNULL(Партии.СтоимостьБезНДСУпр, 0) КАК СтоимостьБезНДСУпр,
	|	Т.НДСУпр - Т.Количество * ЕСТЬNULL(Партии.НДСУпр, 0) КАК НДСУпр,
	|	Т.СтоимостьБезНДС - Т.Количество * ЕСТЬNULL(Партии.СтоимостьБезНДСРегл, 0) КАК СтоимостьБезНДС,
	|	Т.НДС - Т.Количество * ЕСТЬNULL(Партии.НДСРегл, 0) КАК НДС,
	|	Т.Количество,
	|	ВЫБОР КОГДА Партии.ДокументПоступления ЕСТЬ NULL
	|	  И ДокументыПоступления.Партия ЕСТЬ NULL
	|		ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ЭтоПеременныеДопРасходы
	|ПОМЕСТИТЬ ВТДвиженияВводаОстатковНовые
	|ИЗ
	|	ВТДвиженияВводаОстатков КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТПартииПеременные КАК Партии
	|		ПО Т.ДокументПоступления = Партии.ДокументПоступления
	|		И Т.АналитикаУчетаДокументаПоступления = Партии.АналитикаУчетаДокументаПоступления
	|		И Т.Партия = Партии.Партия
	|		И Т.АналитикаУчетаПартий = Партии.АналитикаУчетаПартий
	|		И Т.Организация = Партии.Организация
	|		И Т.ВидЗапасов = Партии.ВидЗапасов
	|		И Т.АналитикаУчетаНоменклатуры.Номенклатура = Партии.Номенклатура
	|		И Т.АналитикаУчетаНоменклатуры.Характеристика = Партии.Характеристика
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТДокументыПоступленияПеременные КАК ДокументыПоступления
	|		ПО Т.Партия = ДокументыПоступления.Партия
	|		И Т.АналитикаУчетаПартий = ДокументыПоступления.АналитикаУчетаПартий
	|		И Т.Организация = ДокументыПоступления.Организация
	|		И Т.ВидЗапасов = ДокументыПоступления.ВидЗапасов
	|		И Т.АналитикаУчетаНоменклатуры.Номенклатура = ДокументыПоступления.Номенклатура
	|		И Т.АналитикаУчетаНоменклатуры.Характеристика = ДокументыПоступления.Характеристика
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТДвиженияВводаОстатков
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаДокументаПоступления,
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.СтатьяРасходовАктивов,
	|	Т.СтоимостьБезНДСУпр,
	|	Т.НДСУпр,
	|	Т.СтоимостьБезНДС,
	|	Т.НДС,
	|	Т.Количество,
	|	Т.ЭтоПеременныеДопРасходы
	|ПОМЕСТИТЬ ВТДвиженияВводаОстатков
	|ИЗ
	|	ВТДвиженияВводаОстатковНовые КАК Т
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СтатьяРасходовАктивов
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
	
	НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(
		ПараметрыРасчета,
		СуществующиеВТ + ", ВТДвиженияВводаОстатков");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);
	
КонецПроцедуры

Процедура РаспределитьНДСПоСебестоимости(ПараметрыРасчета, ИмяТаблицыДанных)
	
	ИмяТаблицыДанныхИсходная = ИмяТаблицыДанных;
	СуществующиеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета);
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	#Область ПодготовкаДанных
	
	РасширенныйУчетЗатратДляПартийНДС = ЗначениеЗаполнено(ПараметрыРасчета.ОрганизацииСДетализациейМатериальныхИПостатейныхЗатрат);
	
	Если Запрос.Параметры.ОрганизацииСДетализациейМатериальныхИПостатейныхЗатрат.Количество() <>
	 Запрос.Параметры.ОрганизацииСУчетомПартийНДСВерсии24.Количество() Тогда
		
		Запрос.Текст =
		"ВЫБРАТЬ
		|	Т.ЭтоОстаткиПостатейныеПеременные,
		|	Т.ЭтоОстаткиПостатейныеПостоянные,
		// Аналитики партий НДС
		|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
		|	Т.ДокументПоступления,
		|	Т.АналитикаУчетаПартийДокументаПоступления,
		|	ЛОЖЬ КАК ЗатратыПредыдущихПеределов,
		|	Т.ЭтоДопРасходы,
		|	Т.ЭтоПеременныеДопРасходы,
		|	
		// Аналитики себестоимости
		|	Т.Организация,
		|	Т.РазделУчета,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.ВидДеятельностиНДС,
		|	Т.АналитикаФинансовогоУчета,
		|
		// Прочие поля
		|	Т.СтатьяРасходов,
		|	Т.АналитикаРасходов,
		|
		// Ресурсы
		|	1 КАК ЗнакСтоимостьСНДС,
		|	1 КАК ЗнакСтоимостьБезНДС,
		|	Т.ЗнакСтоимостьБезНДСРегл,
		|	Т.ЗнакНДСРегл,
		|	Т.ЗнакСтоимостьБезНДСУпр,
		|	Т.ЗнакНДСУпр,
		|
		|	0 КАК СтоимостьСНДС,
		|	0 КАК СтоимостьБезНДС,
		|	Т.СтоимостьБезНДСРегл,
		|	Т.НДСРегл,
		|	Т.СтоимостьБезНДСУпр,
		|	Т.НДСУпр
		|ПОМЕСТИТЬ ДанныеДляРасчетаСокращенная
		|ИЗ
		|	ИмяТаблицыДанных КАК Т
		|ГДЕ
		|	НЕ Т.Организация В (&ОрганизацииСДетализациейМатериальныхИПостатейныхЗатрат)
		|	И (Т.НДСРегл <> 0 ИЛИ Т.НДСУпр <> 0
		|
		//++ Локализация
		|		ИЛИ Т.Организация В (&ОрганизацииНаУСН)
		//-- Локализация
		|		)
		|	И Т.АналитикаУчетаПартийДокументаПоступления <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	Т.ЭтоОстаткиПостатейныеПеременные,
		|	Т.ЭтоОстаткиПостатейныеПостоянные,
		// Аналитики партий НДС
		|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
		|	Т.ДокументПоступления,
		|	Т.АналитикаУчетаПартийДокументаПоступления,
		|	Т.ЗатратыПредыдущихПеределов,
		|	Т.ЭтоДопРасходы,
		|	Т.ЭтоПеременныеДопРасходы,
		|	
		// Аналитики себестоимости
		|	Т.Организация,
		|	Т.РазделУчета,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.ВидДеятельностиНДС,
		|	Т.АналитикаФинансовогоУчета,
		|
		// Прочие поля
		|	Т.СтатьяРасходов,
		|	Т.АналитикаРасходов,
		|
		// Ресурсы
		|	Т.ЗнакСтоимостьСНДС,
		|	Т.ЗнакСтоимостьБезНДС,
		|	Т.ЗнакСтоимостьБезНДСРегл,
		|	Т.ЗнакНДСРегл,
		|	Т.ЗнакСтоимостьБезНДСУпр,
		|	Т.ЗнакНДСУпр,
		|
		|	Т.СтоимостьСНДС,
		|	Т.СтоимостьБезНДС,
		|	Т.СтоимостьБезНДСРегл,
		|	Т.НДСРегл,
		|	Т.СтоимостьБезНДСУпр,
		|	Т.НДСУпр
		|ИЗ
		|	ИмяТаблицыДанных КАК Т
		|ГДЕ
		|	Т.Организация В (&ОрганизацииСДетализациейМатериальныхИПостатейныхЗатрат)
		|
		// Индексы должны соответствовать свойству ИндексыРегистра из описания регистра себестоимости
		|ИНДЕКСИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры,
		|	Организация,
		|	Партия
		|";
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИмяТаблицыДанных", ИмяТаблицыДанных);
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
		
		ИмяТаблицыДанных = "ДанныеДляРасчетаСокращенная";
		
	КонецЕсли;
	
	Если НЕ РасчетСебестоимостиПрикладныеАлгоритмы.ВременнаяТаблицаСуществует(ПараметрыРасчета, "ВтСвязиУзловКорректировкиСебестоимостиСоСписаниемНДС") Тогда
		
		Запрос.Текст =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Т.НомерУзла,
		|	ВЫБОР КОГДА Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|		ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ИсточникСписанияНДС,
		|	ВЫБОР КОГДА Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|		ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ПриемникСписанияНДС,
		|	ВЫБОР КОГДА ЛОЖЬ ТОГДА ЛОЖЬ // для удобства расстановки тегов
		//++ Локализация
		|		КОГДА УчетнаяПолитика.ВариантУчетаНДСПриИзмененииВидаДеятельности = ЗНАЧЕНИЕ(Перечисление.ВариантыУчетаНДСПриИзмененииВидаДеятельностиНаНеоблагаемую.ВключатьВСтоимостьИлиРасходыВЗависимостиОтПериода)
		|			ТОГДА ИСТИНА
		//-- Локализация
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК СписаниеНДСЗависитОтПериодаДокументаПоступления
		|ПОМЕСТИТЬ ВтУзлыКорректировкиСебестоимостиДляСписанияНДС
		|ИЗ
		|	ВтУзлыКорректировкиСебестоимости КАК Т
		//++ Локализация
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТНастройкиУчетаНДС КАК УчетнаяПолитика
		|		ПО Т.Организация = УчетнаяПолитика.Организация
		//-- Локализация
		|ГДЕ
		|	ЛОЖЬ
		//++ Локализация
		|	ИЛИ УчетнаяПолитика.ВариантУчетаНДСПриИзмененииВидаДеятельности <> ЗНАЧЕНИЕ(Перечисление.ВариантыУчетаНДСПриИзмененииВидаДеятельностиНаНеоблагаемую.ВключатьВСтоимость)
		//-- Локализация
		|ИНДЕКСИРОВАТЬ ПО
		|	НомерУзла
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Т.НомерУзлаИсточник КАК НомерУзлаИсточник,
		|	Т.НомерУзлаПриемник КАК НомерУзлаПриемник,
		|	Т.Вес,
		|	ВЫБОР КОГДА ЕСТЬNULL(УзлыИсточники.ИсточникСписанияНДС, ЛОЖЬ)
		|	  И ЕСТЬNULL(УзлыПриемники.ПриемникСписанияНДС, ЛОЖЬ)
		|		ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК СменаВидаДеятельностиНДС,
		|	ЕСТЬNULL(УзлыИсточники.СписаниеНДСЗависитОтПериодаДокументаПоступления, ЛОЖЬ) КАК СписаниеНДСЗависитОтПериодаДокументаПоступления
		|ПОМЕСТИТЬ ВтСвязиУзловКорректировкиСебестоимостиСоСписаниемНДС
		|ИЗ
		|	ВтСвязиУзловКорректировкиСебестоимости КАК Т
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВтУзлыКорректировкиСебестоимостиДляСписанияНДС КАК УзлыИсточники
		|		ПО УзлыИсточники.НомерУзла = Т.НомерУзлаИсточник
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВтУзлыКорректировкиСебестоимостиДляСписанияНДС КАК УзлыПриемники
		|		ПО УзлыПриемники.НомерУзла = Т.НомерУзлаПриемник
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	НомерУзлаИсточник
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Т.НомерУзлаИсточник КАК НомерУзлаИсточник,
		|	Т.НомерУзлаПриемник КАК НомерУзлаПриемник
		|ПОМЕСТИТЬ ВтСвязиУзловКорректировкиСебестоимостиСоСменойПартии
		|ИЗ
		|	ВтСвязиУзловКорректировкиСебестоимости КАК Т
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВтУзлыКорректировкиСебестоимости КАК УзлыИсточники
		|		ПО УзлыИсточники.НомерУзла = Т.НомерУзлаИсточник
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВтУзлыКорректировкиСебестоимости КАК УзлыПриемники
		|		ПО УзлыПриемники.НомерУзла = Т.НомерУзлаПриемник
		|ГДЕ
		|	УзлыИсточники.Партия <> УзлыПриемники.Партия
		|	И УзлыИсточники.Организация В (&ОрганизацииСДетализациейМатериальныхИПостатейныхЗатрат)
		|ИНДЕКСИРОВАТЬ ПО
		|	НомерУзлаИсточник
		|";
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
		
	КонецЕсли;
	
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ИСТИНА 
	|ИЗ
	|	ВтУзлыКорректировкиСебестоимостиДляСписанияНДС КАК Т
	|ГДЕ
	|	Т.СписаниеНДСЗависитОтПериодаДокументаПоступления";
	
	ВозможноСписаниеНДСПоПериодам = НЕ Запрос.Выполнить().Пустой();
	Запрос.УстановитьПараметр("ВозможноСписаниеНДСПоПериодам", ВозможноСписаниеНДСПоПериодам);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.ЭтоОстаткиПостатейныеПеременные,
	|	Т.ЭтоОстаткиПостатейныеПостоянные,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.ЗатратыПредыдущихПеределов,
	|	Т.ЭтоДопРасходы,
	|	Т.ЭтоПеременныеДопРасходы,
	|	ВЫБОР КОГДА НЕ &ВозможноСписаниеНДСПоПериодам // в этом случае период документа не важен - для оптимальной группировки узлов НДС примем для всех узлов значение ИСТИНА
	|	  ИЛИ НАЧАЛОПЕРИОДА(ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)), МЕСЯЦ) = &НачалоПериода
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ДокументПоступленияВТекущемПериоде
	|ПОМЕСТИТЬ ДанныеДляНумерации
	|ИЗ
	|	ИмяТаблицыДанных КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|		ПО ДанныеПервичныхДокументов.Организация = Т.Организация
	|		И ДанныеПервичныхДокументов.Документ = Т.ДокументПоступления
	|ГДЕ
	|	(Т.СтоимостьСНДС <> 0
	|		ИЛИ Т.СтоимостьБезНДС <> 0
	|		ИЛИ Т.СтоимостьБезНДСРегл <> 0
	|		ИЛИ Т.НДСРегл <> 0
	|		ИЛИ Т.СтоимостьБезНДСУпр <> 0
	|		ИЛИ Т.НДСУпр <> 0)
	|	И Т.Партия <> НЕОПРЕДЕЛЕНО
	|СГРУППИРОВАТЬ ПО
	|	Т.ЭтоОстаткиПостатейныеПеременные,
	|	Т.ЭтоОстаткиПостатейныеПостоянные,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.ЗатратыПредыдущихПеределов,
	|	Т.ЭтоДопРасходы,
	|	Т.ЭтоПеременныеДопРасходы,
	|	ВЫБОР КОГДА НЕ &ВозможноСписаниеНДСПоПериодам
	|	  ИЛИ НАЧАЛОПЕРИОДА(ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)), МЕСЯЦ) = &НачалоПериода
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ
	|";
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИмяТаблицыДанных", ИмяТаблицыДанных);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
	
	КоличествоПартийНДС = РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(ПараметрыРасчета, "ДанныеДляНумерации");
	
	Если КоличествоПартийНДС = 0 Тогда
		
		ДополнитьДанныеДетализацииПартийНДС(ПараметрыРасчета, ИмяТаблицыДанныхИсходная);
	
		// Уничтожим ненужные временные таблицы.
		НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(
			ПараметрыРасчета,
			СуществующиеВТ);
		
		РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);
	
		Возврат;
		
	КонецЕсли;
	
	ПараметрыНумерации = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		"АналитикаУчетаНоменклатурыДокументаПоступления", // разделитель
		"", // ресурсы
		"ДокументПоступления, АналитикаУчетаПартийДокументаПоступления, АналитикаУчетаНоменклатурыДокументаПоступления, СтатьяРасходов", // порядок
		"НомерУзла",
		"ДокументПоступления"); 
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗаполнитьНомераСтрокВременнойТаблицы(
		ПараметрыРасчета,
		ПараметрыНумерации,
		"ДанныеДляНумерации",
		"ВТУзлыПартийНДС");
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Узлы.НомерУзла,
	|	Узлы.Организация КАК Организация,
	|	Узлы.РазделУчета,
	|	Узлы.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Узлы.ВидЗапасов,
	|	Узлы.Партия КАК Партия,
	|	Узлы.АналитикаУчетаПартий,
	|	Узлы.ВидДеятельностиНДС,
	|	Узлы.АналитикаФинансовогоУчета,
	|	ЕСТЬNULL(УзлыСписанияНДС.СписаниеНДСЗависитОтПериодаДокументаПоступления, ЛОЖЬ) КАК СписаниеНДСЗависитОтПериодаДокументаПоступления
	|ПОМЕСТИТЬ ВтУзлыКорректировкиСебестоимостиСоСписаниемНДС
	|ИЗ
	|	ВтУзлыКорректировкиСебестоимости КАК Узлы
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтУзлыКорректировкиСебестоимостиДляСписанияНДС КАК УзлыСписанияНДС
	|		ПО Узлы.НомерУзла = УзлыСписанияНДС.НомерУзла
	// Индексы должны соответствовать свойству ИндексыРегистра из описания регистра себестоимости
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаНоменклатуры,
	|	Организация,
	|	Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Узлы.НомерУзла КАК НомерУзла,
	|	Узлы.Организация КАК Организация,
	|	Узлы.РазделУчета,
	|	Узлы.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Узлы.ВидЗапасов,
	|	Узлы.Партия КАК Партия,
	|	Узлы.АналитикаУчетаПартий,
	|	Узлы.ВидДеятельностиНДС,
	|	Узлы.АналитикаФинансовогоУчета,
	|	Узлы.СписаниеНДСЗависитОтПериодаДокументаПоступления,
	|	ЕСТЬNULL(ОстаткиСебестоимости.Количество, 0) КАК КоличествоПартии
	|ПОМЕСТИТЬ ВтУзлыКорректировкиСебестоимостиСОстаткамиПартий
	|ИЗ
	|	ВтУзлыКорректировкиСебестоимостиСоСписаниемНДС КАК Узлы
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТКэшРасчетныеОстаткиСебестоимостьТоваров КАК ОстаткиСебестоимости
	|			ПО ОстаткиСебестоимости.АналитикаУчетаНоменклатуры = Узлы.АналитикаУчетаНоменклатуры
	|			И ОстаткиСебестоимости.Организация = Узлы.Организация
	|			И ОстаткиСебестоимости.Партия = Узлы.Партия
	|			И ОстаткиСебестоимости.РазделУчета = Узлы.РазделУчета
	|			И ОстаткиСебестоимости.ВидЗапасов = Узлы.ВидЗапасов
	|			И ОстаткиСебестоимости.АналитикаУчетаПартий = Узлы.АналитикаУчетаПартий
	|			И ОстаткиСебестоимости.ВидДеятельностиНДС = Узлы.ВидДеятельностиНДС
	|			И ОстаткиСебестоимости.АналитикаФинансовогоУчета = Узлы.АналитикаФинансовогоУчета
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерУзла
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Узлы.НомерУзла КАК НомерУзлаСебестоимости,
	|	Узлы.СписаниеНДСЗависитОтПериодаДокументаПоступления КАК СписаниеНДСЗависитОтПериодаДокументаПоступления,
	|
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.ЗатратыПредыдущихПеределов,
	|	Т.ЭтоОстаткиПостатейныеПеременные,
	|	Т.ЭтоОстаткиПостатейныеПостоянные,
	|	Т.ЭтоДопРасходы,
	|	Т.ЭтоПеременныеДопРасходы,
	|
	|	Т.ЗнакСтоимостьСНДС,
	|	Т.ЗнакСтоимостьБезНДС,
	|	Т.ЗнакСтоимостьБезНДСРегл,
	|	Т.ЗнакНДСРегл,
	|	Т.ЗнакСтоимостьБезНДСУпр,
	|	Т.ЗнакНДСУпр,
	|	Т.СтоимостьСНДС КАК СтоимостьСНДС,
	|	Т.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|	Т.СтоимостьБезНДСРегл КАК СтоимостьБезНДСРегл,
	|	Т.НДСРегл КАК НДСРегл,
	|	Т.СтоимостьБезНДСУпр КАК СтоимостьБезНДСУпр,
	|	Т.НДСУпр КАК НДСУпр
	|ПОМЕСТИТЬ ВТИсходныеУзлыСебестоимостиБезНДС
	|ИЗ
	|	ИмяТаблицыДанных КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтУзлыКорректировкиСебестоимостиСоСписаниемНДС КАК Узлы
	|		ПО Узлы.АналитикаУчетаНоменклатуры = Т.АналитикаУчетаНоменклатуры
	|		И Узлы.Организация = Т.Организация
	|		И Узлы.Партия = Т.Партия
	|		И Узлы.РазделУчета = Т.РазделУчета
	|		И Узлы.ВидЗапасов = Т.ВидЗапасов
	|		И Узлы.АналитикаУчетаПартий = Т.АналитикаУчетаПартий
	|		И Узлы.ВидДеятельностиНДС = Т.ВидДеятельностиНДС
	|		И Узлы.АналитикаФинансовогоУчета = Т.АналитикаФинансовогоУчета
	|ГДЕ
	|	Т.СтоимостьСНДС <> 0
	|	ИЛИ Т.СтоимостьБезНДС <> 0
	|	ИЛИ Т.СтоимостьБезНДСРегл <> 0
	|	ИЛИ Т.НДСРегл <> 0
	|	ИЛИ Т.СтоимостьБезНДСУпр <> 0
	|	ИЛИ Т.НДСУпр <> 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументПоступления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.НомерУзлаСебестоимости,
	|	УзлыНДС.НомерУзла КАК НомерУзлаНДС,
	|
	|	Т.СписаниеНДСЗависитОтПериодаДокументаПоступления,
	|	УзлыНДС.ДокументПоступленияВТекущемПериоде,
	|
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	ВЫБОР КОГДА НЕ (ТИПЗНАЧЕНИЯ(Т.СтатьяРасходов) = ТИП(ПланВидовХарактеристик.СтатьиРасходов)
	|		И Т.СтатьяРасходов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка))
	|	  И НЕ ЕСТЬNULL(Т.ЭтоДопРасходы, ЛОЖЬ)
	|	  И НЕ ЕСТЬNULL(Т.ЭтоОстаткиПостатейныеПеременные, ЛОЖЬ)
	|	  И НЕ ЕСТЬNULL(Т.ЭтоОстаткиПостатейныеПостоянные, ЛОЖЬ)
	|		ТОГДА Т.АналитикаУчетаНоменклатурыДокументаПоступления
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|	КОНЕЦ КАК АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.ЗатратыПредыдущихПеределов,
	|	Т.ЭтоОстаткиПостатейныеПеременные,
	|	Т.ЭтоОстаткиПостатейныеПостоянные,
	|	Т.ЭтоДопРасходы,
	|	Т.ЭтоПеременныеДопРасходы,
	|
	|	Т.ЗнакСтоимостьСНДС,
	|	Т.ЗнакСтоимостьБезНДС,
	|	Т.ЗнакСтоимостьБезНДСРегл,
	|	Т.ЗнакНДСРегл,
	|	Т.ЗнакСтоимостьБезНДСУпр,
	|	Т.ЗнакНДСУпр,
	|	СУММА(Т.СтоимостьСНДС) КАК СтоимостьСНДС,
	|	СУММА(Т.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	СУММА(Т.СтоимостьБезНДСРегл) КАК СтоимостьБезНДСРегл,
	|	СУММА(Т.НДСРегл) КАК НДСРегл,
	|	СУММА(Т.СтоимостьБезНДСУпр) КАК СтоимостьБезНДСУпр,
	|	СУММА(Т.НДСУпр) КАК НДСУпр
	|ПОМЕСТИТЬ ВТИсходныеУзлыСебестоимостиИНДСПредварительная
	|ИЗ
	|	ВТИсходныеУзлыСебестоимостиБезНДС КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУзлыПартийНДС КАК УзлыНДС
	|		ПО УзлыНДС.ДокументПоступления = Т.ДокументПоступления
	|		И УзлыНДС.АналитикаУчетаПартийДокументаПоступления = Т.АналитикаУчетаПартийДокументаПоступления
	|		И УзлыНДС.АналитикаУчетаНоменклатурыДокументаПоступления = Т.АналитикаУчетаНоменклатурыДокументаПоступления
	|		И УзлыНДС.СтатьяРасходов = Т.СтатьяРасходов
	|		И УзлыНДС.АналитикаРасходов = Т.АналитикаРасходов
	|		И УзлыНДС.ЗатратыПредыдущихПеределов = Т.ЗатратыПредыдущихПеределов
	|		И УзлыНДС.ЭтоОстаткиПостатейныеПеременные = Т.ЭтоОстаткиПостатейныеПеременные
	|		И УзлыНДС.ЭтоОстаткиПостатейныеПостоянные = Т.ЭтоОстаткиПостатейныеПостоянные
	|		И УзлыНДС.ЭтоДопРасходы = Т.ЭтоДопРасходы
	|		И УзлыНДС.ЭтоПеременныеДопРасходы = Т.ЭтоПеременныеДопРасходы
	|СГРУППИРОВАТЬ ПО
	|	Т.НомерУзлаСебестоимости,
	|	УзлыНДС.НомерУзла,
	|	Т.СписаниеНДСЗависитОтПериодаДокументаПоступления,
	|	УзлыНДС.ДокументПоступленияВТекущемПериоде,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	ВЫБОР КОГДА НЕ (ТИПЗНАЧЕНИЯ(Т.СтатьяРасходов) = ТИП(ПланВидовХарактеристик.СтатьиРасходов)
	|		И Т.СтатьяРасходов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка))
	|	  И НЕ ЕСТЬNULL(Т.ЭтоДопРасходы, ЛОЖЬ)
	|	  И НЕ ЕСТЬNULL(Т.ЭтоОстаткиПостатейныеПеременные, ЛОЖЬ)
	|	  И НЕ ЕСТЬNULL(Т.ЭтоОстаткиПостатейныеПостоянные, ЛОЖЬ)
	|		ТОГДА Т.АналитикаУчетаНоменклатурыДокументаПоступления
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|	КОНЕЦ, //АналитикаУчетаНоменклатурыДокументаПоступления
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.ЗатратыПредыдущихПеределов,
	|	Т.ЭтоОстаткиПостатейныеПеременные,
	|	Т.ЭтоОстаткиПостатейныеПостоянные,
	|	Т.ЭтоДопРасходы,
	|	Т.ЭтоПеременныеДопРасходы,
	|	Т.ЗнакСтоимостьСНДС,
	|	Т.ЗнакСтоимостьБезНДС,
	|	Т.ЗнакСтоимостьБезНДСРегл,
	|	Т.ЗнакНДСРегл,
	|	Т.ЗнакСтоимостьБезНДСУпр,
	|	Т.ЗнакНДСУпр
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерУзлаСебестоимости,
	|	ДокументПоступленияВТекущемПериоде
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.НомерУзлаСебестоимости,
	|	Т.ДокументПоступленияВТекущемПериоде,
	|
	|	СУММА(Т.СтоимостьСНДС) КАК СтоимостьСНДС,
	|	СУММА(Т.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	СУММА(Т.СтоимостьБезНДСРегл) КАК СтоимостьБезНДСРегл,
	|	СУММА(Т.НДСРегл) КАК НДСРегл,
	|	СУММА(Т.СтоимостьБезНДСУпр) КАК СтоимостьБезНДСУпр,
	|	СУММА(Т.НДСУпр) КАК НДСУпр
	|ПОМЕСТИТЬ ВТИсходныеУзлыСебестоимостиИНДССгруппированные
	|ИЗ
	|	ВТИсходныеУзлыСебестоимостиИНДСПредварительная КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.НомерУзлаСебестоимости,
	|	Т.ДокументПоступленияВТекущемПериоде
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерУзлаСебестоимости,
	|	ДокументПоступленияВТекущемПериоде
	|";
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИмяТаблицыДанных", ИмяТаблицыДанных);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, "ВтУзлыКорректировкиСебестоимостиСоСписаниемНДС, ВТИсходныеУзлыСебестоимостиБезНДС");
	
	ПараметрыНумерации = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		"АналитикаУчетаНоменклатурыДокументаПоступления", // разделитель
		"СтоимостьСНДС, СтоимостьБезНДС, СтоимостьБезНДСРегл, НДСРегл, СтоимостьБезНДСУпр, НДСУпр", // ресурсы
		"НомерУзлаСебестоимости, ДокументПоступленияВТекущемПериоде", // порядок
		"НомерУзлаГруппаНДС", // поле нового номера строки
		"НомерУзлаСебестоимости, ДокументПоступленияВТекущемПериоде"); // индексы
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗаполнитьНомераСтрокВременнойТаблицы(
		ПараметрыРасчета,
		ПараметрыНумерации,
		"ВТИсходныеУзлыСебестоимостиИНДССгруппированные");
		
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.НомерУзлаСебестоимости,
	|	Т.НомерУзлаНДС,
	|	УзлыСгруппированные.НомерУзлаГруппаНДС КАК НомерУзлаГруппаНДС,
	|
	|	Т.СписаниеНДСЗависитОтПериодаДокументаПоступления,
	|	Т.ДокументПоступленияВТекущемПериоде,
	|
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.ЗатратыПредыдущихПеределов,
	|	Т.ЭтоОстаткиПостатейныеПеременные,
	|	Т.ЭтоОстаткиПостатейныеПостоянные,
	|	Т.ЭтоДопРасходы,
	|	Т.ЭтоПеременныеДопРасходы,
	|
	|	Т.СтоимостьСНДС КАК СтоимостьСНДС,
	|	Т.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|	Т.СтоимостьБезНДСРегл КАК СтоимостьБезНДСРегл,
	|	Т.НДСРегл КАК НДСРегл,
	|	Т.СтоимостьБезНДСУпр КАК СтоимостьБезНДСУпр,
	|	Т.НДСУпр КАК НДСУпр,
	|
	|	 Т.ЗнакСтоимостьСНДС * УзлыСгруппированные.СтоимостьСНДС 				КАК ИтогСтоимостьСНДС,
	|	 Т.ЗнакСтоимостьБезНДС * УзлыСгруппированные.СтоимостьБезНДС 			КАК ИтогСтоимостьБезНДС,
	|	 Т.ЗнакСтоимостьБезНДСРегл * УзлыСгруппированные.СтоимостьБезНДСРегл 	КАК ИтогСтоимостьБезНДСРегл,
	|	 Т.ЗнакНДСРегл * УзлыСгруппированные.НДСРегл 							КАК ИтогНДСРегл,
	|	 Т.ЗнакСтоимостьБезНДСУпр * УзлыСгруппированные.СтоимостьБезНДСУпр 		КАК ИтогСтоимостьБезНДСУпр,
	|	 Т.ЗнакНДСУпр * УзлыСгруппированные.НДСУпр 								КАК ИтогНДСУпр,
	|
	| 	ВЫРАЗИТЬ(ВЫБОР КОГДА УзлыСгруппированные.СтоимостьСНДС <> 0
	|		ТОГДА Т.ЗнакСтоимостьСНДС * Т.СтоимостьСНДС / УзлыСгруппированные.СтоимостьСНДС
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК ЧИСЛО(31,10)) КАК ДоляСтоимостьСНДС,
	| 	ВЫРАЗИТЬ(ВЫБОР КОГДА УзлыСгруппированные.СтоимостьБезНДС <> 0
	|		ТОГДА Т.ЗнакСтоимостьБезНДС * Т.СтоимостьБезНДС / УзлыСгруппированные.СтоимостьБезНДС
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК ЧИСЛО(31,10)) КАК ДоляСтоимостьБезНДС,
	| 	ВЫРАЗИТЬ(ВЫБОР КОГДА УзлыСгруппированные.СтоимостьБезНДСРегл <> 0
	|		ТОГДА Т.ЗнакСтоимостьБезНДСРегл * Т.СтоимостьБезНДСРегл / УзлыСгруппированные.СтоимостьБезНДСРегл
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК ЧИСЛО(31,10)) КАК ДоляСтоимостьБезНДСРегл,
	| 	ВЫРАЗИТЬ(ВЫБОР КОГДА УзлыСгруппированные.НДСРегл <> 0
	|		ТОГДА Т.ЗнакНДСРегл * Т.НДСРегл / УзлыСгруппированные.НДСРегл
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК ЧИСЛО(31,10)) КАК ДоляНДСРегл,
	| 	ВЫРАЗИТЬ(ВЫБОР КОГДА УзлыСгруппированные.СтоимостьБезНДСУпр <> 0
	|		ТОГДА Т.ЗнакСтоимостьБезНДСУпр * Т.СтоимостьБезНДСУпр / УзлыСгруппированные.СтоимостьБезНДСУпр
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК ЧИСЛО(31,10)) КАК ДоляСтоимостьБезНДСУпр,
	| 	ВЫРАЗИТЬ(ВЫБОР КОГДА УзлыСгруппированные.НДСУпр <> 0
	|		ТОГДА  Т.ЗнакНДСУпр * Т.НДСУпр / УзлыСгруппированные.НДСУпр
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК ЧИСЛО(31,10)) КАК ДоляНДСУпр
	|ПОМЕСТИТЬ ВТИсходныеУзлыСебестоимостиИНДС
	|ИЗ
	|	ВТИсходныеУзлыСебестоимостиИНДСПредварительная КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТИсходныеУзлыСебестоимостиИНДССгруппированные КАК УзлыСгруппированные
	|		ПО УзлыСгруппированные.НомерУзлаСебестоимости = Т.НомерУзлаСебестоимости
	|	 	И УзлыСгруппированные.ДокументПоступленияВТекущемПериоде = Т.ДокументПоступленияВТекущемПериоде
	|ГДЕ
	|	Т.СтоимостьСНДС <> 0
	|	ИЛИ Т.СтоимостьБезНДС <> 0
	|	ИЛИ Т.СтоимостьБезНДСРегл <> 0
	|	ИЛИ Т.НДСРегл <> 0
	|	ИЛИ Т.СтоимостьБезНДСУпр <> 0
	|	ИЛИ Т.НДСУпр <> 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерУзлаГруппаНДС
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.НомерУзлаСебестоимости КАК НомерУзлаСебестоимости,
	|	Т.НомерУзлаГруппаНДС КАК НомерУзлаНДС,
	|
	|	Т.СписаниеНДСЗависитОтПериодаДокументаПоступления,
	|	Т.ДокументПоступленияВТекущемПериоде,
	|
	|	СУММА(Т.СтоимостьСНДС) КАК СтоимостьСНДС,
	|	СУММА(Т.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	СУММА(Т.СтоимостьБезНДСРегл) КАК СтоимостьБезНДСРегл,
	|	СУММА(Т.НДСРегл) КАК НДСРегл,
	|	СУММА(Т.СтоимостьБезНДСУпр) КАК СтоимостьБезНДСУпр,
	|	СУММА(Т.НДСУпр) КАК НДСУпр
	|ПОМЕСТИТЬ СтоимостьПартийНДС
	|ИЗ
	|	ВТИсходныеУзлыСебестоимостиИНДС КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.НомерУзлаСебестоимости,
	|	Т.НомерУзлаГруппаНДС,
	|	Т.СписаниеНДСЗависитОтПериодаДокументаПоступления,
	|	Т.ДокументПоступленияВТекущемПериоде
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерУзлаНДС
	|";
		
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"ВТИсходныеУзлыСебестоимостиИНДСПредварительная, ВТИсходныеУзлыСебестоимостиИНДССгруппированные");
	
	#КонецОбласти
	
	#Область ДвиженияБезСтоимости
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	-1 						  КАК УзелИсточник,
	|	Т.НомерУзлаСебестоимости  КАК УзелПриемник,
	|	Т.НомерУзлаНДС 			  КАК НомерУзлаНДС,
	|	ЛОЖЬ												КАК СменаВидаДеятельностиНДС,
	|	Т.ДокументПоступленияВТекущемПериоде 			  	КАК ДокументПоступленияВТекущемПериоде,
	|	Т.СписаниеНДСЗависитОтПериодаДокументаПоступления 	КАК СписаниеНДСЗависитОтПериодаДокументаПоступления
	|ПОМЕСТИТЬ ВТУзлыИсточникиШага_0
	|ИЗ
	|	СтоимостьПартийНДС КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.УзелИсточник,
	|	Т.УзелПриемник,
	|	Т.НомерУзлаНДС,
	|	Т.СменаВидаДеятельностиНДС,
	|	Т.ДокументПоступленияВТекущемПериоде,
	|	Т.СписаниеНДСЗависитОтПериодаДокументаПоступления
	|ПОМЕСТИТЬ ВТУзлыСПолямиРаспределения_0
	|ИЗ
	|	ВТУзлыИсточникиШага_0 КАК Т
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	УзелПриемник
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина, "ВТУзлыСПолямиРаспределения_0");
	
	ИмяТаблицыУзлов = "ВТУзлыИсточникиШага_0";
	ИмяТаблицыСвязей = "ВТУзлыСПолямиРаспределения_0";
	
	КоличествоУзловИсточников = РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(ПараметрыРасчета, "ВТУзлыИсточникиШага_0");
	КоличествоСвязейОбработано = РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(ПараметрыРасчета, "ВТУзлыСПолямиРаспределения_0");
	КоличествоСвязейОбработаноНаПредыдущемШаге = КоличествоСвязейОбработано;
	
	НомерИтерации = 0;
	ПродолжатьОбходГрафа = (КоличествоУзловИсточников > 0);
	
	Пока ПродолжатьОбходГрафа Цикл
	
		НомерИтерации = НомерИтерации + 1;
		
		Запрос.Текст =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	УзлыПриемники.НомерУзлаИсточник КАК УзелИсточник,
		|	УзлыПриемники.НомерУзлаПриемник КАК УзелПриемник,
		|	УзлыИсточники.НомерУзлаНДС,
		|	УзлыПриемники.СменаВидаДеятельностиНДС,
		|	УзлыИсточники.ДокументПоступленияВТекущемПериоде,
		|	УзлыИсточники.СписаниеНДСЗависитОтПериодаДокументаПоступления
		|ПОМЕСТИТЬ ВТУзлыИсточникиШага_1
		|ИЗ
		|	ВтСвязиУзловКорректировкиСебестоимостиСоСписаниемНДС КАК УзлыПриемники
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУзлыИсточникиШага_0 КАК УзлыИсточники
		|		ПО УзлыПриемники.НомерУзлаИсточник = УзлыИсточники.УзелПриемник
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	УзелПриемник
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Т.УзелИсточник,
		|	Т.УзелПриемник,
		|	Т.НомерУзлаНДС,
		|	Т.СменаВидаДеятельностиНДС,
		|	Т.ДокументПоступленияВТекущемПериоде,
		|	Т.СписаниеНДСЗависитОтПериодаДокументаПоступления
		|ПОМЕСТИТЬ ВТУзлыСПолямиРаспределения_1
		|ИЗ
		|	ВТУзлыСПолямиРаспределения_0 КАК Т
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	Т.УзелИсточник,
		|	Т.УзелПриемник,
		|	Т.НомерУзлаНДС,
		|	Т.СменаВидаДеятельностиНДС,
		|	Т.ДокументПоступленияВТекущемПериоде,
		|	Т.СписаниеНДСЗависитОтПериодаДокументаПоступления
		|ИЗ
		|	ВТУзлыИсточникиШага_1 КАК Т
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	НомерУзлаНДС,
		|	УзелПриемник
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ВТУзлыИсточникиШага_0
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ВТУзлыСПолямиРаспределения_0
		|";
		
		ИмяТаблицыУзлов = "ВТУзлыИсточникиШага_" + Формат(НомерИтерации, "ЧН=0; ЧГ=");
		ИмяТаблицыСвязей = "ВТУзлыСПолямиРаспределения_" + Формат(НомерИтерации, "ЧН=0; ЧГ=");
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ВТУзлыИсточникиШага_1", ИмяТаблицыУзлов);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ВТУзлыИсточникиШага_0", "ВТУзлыИсточникиШага_" + Формат(НомерИтерации - 1, "ЧН=0; ЧГ="));
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ВТУзлыСПолямиРаспределения_1", ИмяТаблицыСвязей);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ВТУзлыСПолямиРаспределения_0", "ВТУзлыСПолямиРаспределения_" + Формат(НомерИтерации - 1, "ЧН=0; ЧГ="));
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина, ИмяТаблицыСвязей);
		
		КоличествоСвязейОбработано = РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(ПараметрыРасчета, ИмяТаблицыСвязей);
		
		ПродолжатьОбходГрафа = (КоличествоСвязейОбработано > КоличествоСвязейОбработаноНаПредыдущемШаге);
		КоличествоСвязейОбработаноНаПредыдущемШаге = КоличествоСвязейОбработано;
		
	КонецЦикла; 
	
	ОписаниеЭтапа = НСтр("ru = 'Выполнено итераций распределения партий - %1,
	|	размер таблицы связей - %2'");
	
	ОписаниеЭтапа = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		ОписаниеЭтапа,
		РасчетСебестоимостиПротоколРасчета.ПредставлениеЗначения(НомерИтерации + 1),
		РасчетСебестоимостиПротоколРасчета.ПредставлениеЗначения(КоличествоСвязейОбработано));
	
	РасчетСебестоимостиПротоколРасчета.ДополнительнаяИнформация(ПараметрыРасчета, ОписаниеЭтапа);
	
	#КонецОбласти
	
	#Область ДанныеДляРешенияСЛУ
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.УзелИсточник,
	|	Т.УзелПриемник,
	|	Т.НомерУзлаНДС,
	|	Т.СменаВидаДеятельностиНДС,
	|	Т.ДокументПоступленияВТекущемПериоде,
	|	Т.СписаниеНДСЗависитОтПериодаДокументаПоступления
	|ПОМЕСТИТЬ ВТТаблицаСвязей
	|ИЗ
	|	ИмяТаблицыСвязей КАК Т
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерУзлаНДС
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ИмяТаблицыСвязей
	|
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ИмяТаблицыУзлов
	|
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.УзелИсточник КАК НомерУзла,
	|	Т.НомерУзлаНДС КАК НомерУзлаНДС
	|ПОМЕСТИТЬ ДанныеДляНумерации
	|ИЗ
	|	ВТТаблицаСвязей КАК Т
	|ГДЕ
	|	Т.УзелИсточник <> -1
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.УзелПриемник,
	|	Т.НомерУзлаНДС
	|ИЗ
	|	ВТТаблицаСвязей КАК Т";
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИмяТаблицыСвязей", ИмяТаблицыСвязей);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИмяТаблицыУзлов",  ИмяТаблицыУзлов);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
	
	ПараметрыНумерации = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		"", // разделитель
		"", // ресурсы
		"НомерУзла, НомерУзлаНДС", // порядок
		"НовыйНомерУзла",
		"НомерУзлаНДС");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗаполнитьНомераСтрокВременнойТаблицы(
		ПараметрыРасчета,
		ПараметрыНумерации,
		"ДанныеДляНумерации",
		"ВТНовыеУзлы");
		
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.УзелИсточник КАК УзелИсточник,
	|	Т.УзелПриемник КАК УзелПриемник,
	|	Т.НомерУзлаНДС КАК НомерУзлаНДС,
	|	ЕСТЬNULL(НовыеУзлыИсточники.НовыйНомерУзла, -1) КАК НовыйУзелИсточник,
	|	НовыеУзлыПриемники.НовыйНомерУзла КАК НовыйУзелПриемник,
	|
	|	ВЫБОР КОГДА Т.СменаВидаДеятельностиНДС
	|	  И (НЕ Т.СписаниеНДСЗависитОтПериодаДокументаПоступления ИЛИ НЕ Т.ДокументПоступленияВТекущемПериоде)
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ВыполнитьСписаниеНДС,
	|
	|	Стоимости.СтоимостьСНДС,
	|	Стоимости.СтоимостьБезНДС,
	|	Стоимости.СтоимостьБезНДСРегл,
	|	Стоимости.НДСРегл,
	|	Стоимости.СтоимостьБезНДСУпр,
	|	Стоимости.НДСУпр
	|ПОМЕСТИТЬ ВТРезультатРасчетаПредварительный
	|ИЗ
	|	ВТТаблицаСвязей КАК Т
	|		ЛЕВОЕ СОЕДИНЕНИЕ СтоимостьПартийНДС КАК Стоимости
	|			ПО Т.УзелПриемник = Стоимости.НомерУзлаСебестоимости
	|			И Т.НомерУзлаНДС = Стоимости.НомерУзлаНДС
	|			И (Т.УзелИсточник = -1)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТНовыеУзлы КАК НовыеУзлыИсточники
	|			ПО Т.УзелИсточник = НовыеУзлыИсточники.НомерУзла
	|			И Т.НомерУзлаНДС = НовыеУзлыИсточники.НомерУзлаНДС
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТНовыеУзлы КАК НовыеУзлыПриемники
	|			ПО Т.УзелПриемник = НовыеУзлыПриемники.НомерУзла
	|			И Т.НомерУзлаНДС = НовыеУзлыПриемники.НомерУзлаНДС
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	УзелИсточник
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТТаблицаСвязей";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
	
	#КонецОбласти
	
	#Область РешениеСЛУ
	
	ПояснениеДляЗамера = НСтр("ru = 'Решение для партий НДС'", ОбщегоНазначения.КодОсновногоЯзыка());
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Т.НовыйУзелПриемник) КАК Количество
	|ИЗ
	|	ВТРезультатРасчетаПредварительный КАК Т
	|";
	
	Выборка = Запрос.Выполнить().Выбрать();
	Выборка.Следующий();
	КоличествоУзлов = Выборка.Количество;
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	КОЛИЧЕСТВО(*) КАК Количество
	|ИЗ
	|	(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.НовыйУзелИсточник КАК Источник,
	|		Т.НовыйУзелПриемник КАК Приемник
	|	ИЗ
	|		ВТРезультатРасчетаПредварительный КАК Т
	|	ГДЕ
	|		Т.НовыйУзелИсточник <> -1
	|	) КАК Т
	|";
	
	Выборка = Запрос.Выполнить().Выбрать();
	Выборка.Следующий();
	КоличествоСвязей = Выборка.Количество;
	
	ТекстДляПротокола = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Узлов СЛУ: %1, связей СЛУ: %2'"),
		КоличествоУзлов,
		КоличествоСвязей);
		
	РасчетСебестоимостиПротоколРасчета.ДополнительнаяИнформация(ПараметрыРасчета, ТекстДляПротокола, ТекстДляПротокола);
	
	ЕстьСписаниеНДС = Ложь;
	//++ Локализация
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ИСТИНА
	|ИЗ
	|	ВТРезультатРасчетаПредварительный КАК Т
	|ГДЕ
	|	Т.ВыполнитьСписаниеНДС";
	
	ЕстьСписаниеНДС = НЕ Запрос.Выполнить().Пустой();
	//-- Локализация
	
	ЗапросУзлы = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(ЗапросУзлы, ПараметрыРасчета);
	
	ЗапросУзлы.Текст = ТекстЗапросаУзлыНДС();
	
	ЗапросСвязи = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(ЗапросСвязи, ПараметрыРасчета);
	
	ЗапросСвязи.Текст = ТекстЗапросаСвязиНДС();
	
	МатрицаУзлов  = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, ЗапросУзлы,,, Истина, ПояснениеДляЗамера + ", " + НСтр("ru = 'узлы'", ОбщегоНазначения.КодОсновногоЯзыка()));
	МатрицаСвязей = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, ЗапросСвязи,,, Истина, ПояснениеДляЗамера + ", " + НСтр("ru = 'связи'", ОбщегоНазначения.КодОсновногоЯзыка()));
	
	РасчетСебестоимостиПротоколРасчета.НачалоВыполненияФрагментаКода(ПараметрыРасчета, "РассчитатьСистемыЛинейныхУравнений", ПояснениеДляЗамера);
	РасчетСистемЛинейныхУравнений = РасчетСебестоимостиРешениеСЛУ.ПолучитьКомпонентуДляРешенияСЛУ(ПараметрыРасчета);
	
	РасчетСистемЛинейныхУравнений.ИсточникДанныхУзлов = МатрицаУзлов;
	РасчетСистемЛинейныхУравнений.ИсточникДанныхСвязей = МатрицаСвязей;
	
	// описание ключевых колонок
	РасчетСистемЛинейныхУравнений.КолонкаУравненияВУзлах = "НомерУзла";
	РасчетСистемЛинейныхУравнений.КолонкаУравненияВСвязях = "Приемник";
	РасчетСистемЛинейныхУравнений.КолонкаПеременныеВСвязях = "Источник";
	
	// описание системы
	ИменаКолонокРешений = ""; // порядок полей должен соответствовать именам КолонкаКоэффициентовВУзлах в вызовах ОписанияСистем.Добавить()
	
	Если РасширенныйУчетЗатратДляПартийНДС Тогда
		
		ОписаниеСистемы = РасчетСистемЛинейныхУравнений.ОписанияСистем.Добавить();
		ОписаниеСистемы.КолонкаКоэффициентовВУзлах = "СтоимостьСНДС";
		ОписаниеСистемы.КолонкаКоэффициентовВСвязях = "Вес";
		
		ОписаниеСистемы = РасчетСистемЛинейныхУравнений.ОписанияСистем.Добавить();
		ОписаниеСистемы.КолонкаКоэффициентовВУзлах = "СтоимостьБезНДС";
		ОписаниеСистемы.КолонкаКоэффициентовВСвязях = "Вес";
		
		ИменаКолонокРешений = ИменаКолонокРешений + ?(ИменаКолонокРешений = "", "", ", ") + "СтоимостьСНДС, СтоимостьБезНДС";
		
	КонецЕсли;
	
	ОписаниеСистемы = РасчетСистемЛинейныхУравнений.ОписанияСистем.Добавить();
	ОписаниеСистемы.КолонкаКоэффициентовВУзлах = "СтоимостьБезНДСРегл";
	ОписаниеСистемы.КолонкаКоэффициентовВСвязях = "Вес";
	
	ОписаниеСистемы = РасчетСистемЛинейныхУравнений.ОписанияСистем.Добавить();
	ОписаниеСистемы.КолонкаКоэффициентовВУзлах = "НДСРегл";
	ОписаниеСистемы.КолонкаКоэффициентовВСвязях = "Вес";
	
	ОписаниеСистемы = РасчетСистемЛинейныхУравнений.ОписанияСистем.Добавить();
	ОписаниеСистемы.КолонкаКоэффициентовВУзлах = "СтоимостьБезНДСУпр";
	ОписаниеСистемы.КолонкаКоэффициентовВСвязях = "Вес";
	
	ОписаниеСистемы = РасчетСистемЛинейныхУравнений.ОписанияСистем.Добавить();
	ОписаниеСистемы.КолонкаКоэффициентовВУзлах = "НДСУпр";
	ОписаниеСистемы.КолонкаКоэффициентовВСвязях = "Вес";
	
	ИменаКолонокРешений = ИменаКолонокРешений + ?(ИменаКолонокРешений = "", "", ", ") + "СтоимостьБезНДСРегл, НДСРегл, СтоимостьБезНДСУпр, НДСУпр";
	
	Если РасширенныйУчетЗатратДляПартийНДС Тогда
		
		ОписаниеСистемы = РасчетСистемЛинейныхУравнений.ОписанияСистем.Добавить();
		ОписаниеСистемы.КолонкаКоэффициентовВУзлах = "ИсходнаяЗатрата";
		ОписаниеСистемы.КолонкаКоэффициентовВСвязях = "ВесПередел";
		
		ИменаКолонокРешений = ИменаКолонокРешений + ?(ИменаКолонокРешений = "", "", ", ") + "ИсходнаяЗатрата";
		
	КонецЕсли;
	
	Если ЕстьСписаниеНДС Тогда
		
		ОписаниеСистемы = РасчетСистемЛинейныхУравнений.ОписанияСистем.Добавить();
		ОписаниеСистемы.КолонкаКоэффициентовВУзлах = "СписаниеНДС";
		ОписаниеСистемы.КолонкаКоэффициентовВСвязях = "ВесНДС";
		
		ИменаКолонокРешений = ИменаКолонокРешений + ?(ИменаКолонокРешений = "", "", ", ") + "СписаниеНДС";
		
	КонецЕсли;
	
	// решение
	Если ПараметрыРасчета.ОтключитьРедуцированиеГрафаНДС Тогда
		ТаблицаРешений = РасчетСистемЛинейныхУравнений.РассчитатьСистемыЛинейныхУравнений(Ложь);
	Иначе
		// В платформе ниже версии 8.3.17 у этого метода не было параметров.
		ТаблицаРешений = РасчетСистемЛинейныхУравнений.РассчитатьСистемыЛинейныхУравнений();
	КонецЕсли;
	РасчетСебестоимостиПротоколРасчета.ОкончаниеВыполненияФрагментаКода(ПараметрыРасчета);
	
	// Загрузка решений во временную таблицу.
	ПараметрыЗагрузкиСЛУ = РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьПараметрыЗагрузкиРешенияСЛУ(ИменаКолонокРешений);
	ПараметрыЗагрузкиСЛУ.ЧислоРазрядов = 31;
	ПараметрыЗагрузкиСЛУ.УчитыватьНулевыеРешения = Ложь;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗагрузитьРешениеСЛУВоВременнуюТаблицу(
		ПараметрыРасчета,
		ПараметрыЗагрузкиСЛУ,
		ТаблицаРешений,
		ПояснениеДляЗамера);
	
	#КонецОбласти
	
	#Область ПодготовкаДвиженийРегистровНДС
	
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Т.НовыйНомерУзла,
	|   Т.НомерУзла,
	|	Т.НомерУзлаНДС
	|ПОМЕСТИТЬ ВТНовыеУзлыИндексированная
	|ИЗ
	|	ВТНовыеУзлы КАК Т
	|ИНДЕКСИРОВАТЬ ПО
	|	НовыйНомерУзла
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|   Т.НомерУзла,
	|	Т.НомерУзлаНДС,
	|	ВЫБОР КОГДА &ПолеИсходнаяЗатрата <> 0 ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ КАК ИсходнаяЗатрата,
	//++ Локализация
	|	ВЫБОР КОГДА &ПолеСписаниеНДС = 0 ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ КАК СписаниеНДС,
	//-- Локализация
	| 	СУММА(&ПолеСтоимостьСНДС) КАК СтоимостьСНДС,
	| 	СУММА(&ПолеСтоимостьБезНДС) КАК СтоимостьБезНДС,
	| 	СУММА(Решения.СтоимостьБезНДСРегл) КАК СтоимостьБезНДСРегл,
	| 	СУММА(Решения.НДСРегл) КАК НДСРегл,
	| 	СУММА(Решения.СтоимостьБезНДСУпр) КАК СтоимостьБезНДСУпр,
	| 	СУММА(Решения.НДСУпр) КАК НДСУпр
	|ПОМЕСТИТЬ ТаблицаРешенийРасширенная
	|ИЗ
	|	ВТНовыеУзлыИндексированная КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаРешений КАК Решения
	|		ПО Т.НовыйНомерУзла = Решения.НомерУзла
	|СГРУППИРОВАТЬ ПО
	|   Т.НомерУзла,
	|	Т.НомерУзлаНДС,
	//++ Локализация
	|	ВЫБОР КОГДА &ПолеСписаниеНДС = 0 ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ,
	//-- Локализация
	|	ВЫБОР КОГДА &ПолеИсходнаяЗатрата <> 0 ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерУзлаНДС
	|";
	
	Если РасширенныйУчетЗатратДляПартийНДС Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПолеИсходнаяЗатрата", "Решения.ИсходнаяЗатрата");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПолеСтоимостьСНДС",   "Решения.СтоимостьСНДС");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПолеСтоимостьБезНДС", "Решения.СтоимостьБезНДС");
	Иначе
		Запрос.УстановитьПараметр("ПолеИсходнаяЗатрата", 1);
		Запрос.УстановитьПараметр("ПолеСтоимостьСНДС",   0);
		Запрос.УстановитьПараметр("ПолеСтоимостьБезНДС", 0);
	КонецЕсли;
	
	Если ЕстьСписаниеНДС Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПолеСписаниеНДС", "Решения.СписаниеНДС");
	Иначе
		Запрос.УстановитьПараметр("ПолеСписаниеНДС", 1);
	КонецЕсли;
	
	Запрос.УстановитьПараметр("ПогрешностьОкругленияРешенияСЛУ", 0.00000001);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
	
	Запрос.Текст = "
	|ВЫБРАТЬ
	|   Т.НомерУзла,
	|	УзлыНДС.ЭтоОстаткиПостатейныеПеременные,
	|	УзлыНДС.ЭтоОстаткиПостатейныеПостоянные,
	|	УзлыНДС.ЭтоДопРасходы,
	|	УзлыНДС.ЭтоПеременныеДопРасходы,
	|	УзлыНДС.СтатьяРасходов,
	|	УзлыНДС.АналитикаРасходов,
	|	УзлыНДС.ДокументПоступления,
	|	УзлыНДС.АналитикаУчетаПартийДокументаПоступления,
	|	УзлыНДС.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	УзлыНДС.ЗатратыПредыдущихПеределов,
	//++ Локализация
	|	Т.СписаниеНДС,
	//-- Локализация
	|	Т.ИсходнаяЗатрата,
	| 	СУММА(ВЫРАЗИТЬ(ВЫБОР КОГДА УзлыНДС.ДоляСтоимостьСНДС = 0 ИЛИ УзлыНДС.ДоляСтоимостьСНДС = 1 ИЛИ УзлыНДС.ДоляСтоимостьСНДС = -1
	|			ТОГДА Т.СтоимостьСНДС * УзлыНДС.ДоляСтоимостьСНДС
	|			ИНАЧЕ Т.СтоимостьСНДС * УзлыНДС.СтоимостьСНДС / УзлыНДС.ИтогСтоимостьСНДС
	|		КОНЕЦ КАК ЧИСЛО(31,10))) КАК СтоимостьСНДС,
	| 	СУММА(ВЫРАЗИТЬ(ВЫБОР КОГДА УзлыНДС.ДоляСтоимостьБезНДС = 0 ИЛИ УзлыНДС.ДоляСтоимостьБезНДС = 1 ИЛИ УзлыНДС.ДоляСтоимостьБезНДС = -1
	|			ТОГДА Т.СтоимостьБезНДС * УзлыНДС.ДоляСтоимостьБезНДС
	|			ИНАЧЕ Т.СтоимостьБезНДС * УзлыНДС.СтоимостьБезНДС / УзлыНДС.ИтогСтоимостьБезНДС
	|		КОНЕЦ КАК ЧИСЛО(31,10))) КАК СтоимостьБезНДС,
	| 	СУММА(ВЫРАЗИТЬ(ВЫБОР КОГДА УзлыНДС.ДоляСтоимостьБезНДСРегл = 0 ИЛИ УзлыНДС.ДоляСтоимостьБезНДСРегл = 1 ИЛИ УзлыНДС.ДоляСтоимостьБезНДСРегл = -1
	|			ТОГДА Т.СтоимостьБезНДСРегл * УзлыНДС.ДоляСтоимостьБезНДСРегл
	|			ИНАЧЕ Т.СтоимостьБезНДСРегл * УзлыНДС.СтоимостьБезНДСРегл / УзлыНДС.ИтогСтоимостьБезНДСРегл
	|		КОНЕЦ КАК ЧИСЛО(31,10))) КАК СтоимостьБезНДСРегл,
	| 	СУММА(ВЫРАЗИТЬ(ВЫБОР КОГДА УзлыНДС.ДоляНДСРегл = 0 ИЛИ УзлыНДС.ДоляНДСРегл = 1 ИЛИ УзлыНДС.ДоляНДСРегл = -1
	|			ТОГДА Т.НДСРегл * УзлыНДС.ДоляНДСРегл
	|			ИНАЧЕ Т.НДСРегл * УзлыНДС.НДСРегл / УзлыНДС.ИтогНДСРегл
	|		КОНЕЦ КАК ЧИСЛО(31,10))) КАК НДСРегл,
	| 	СУММА(ВЫРАЗИТЬ(ВЫБОР КОГДА УзлыНДС.ДоляСтоимостьБезНДСУпр = 0 ИЛИ УзлыНДС.ДоляСтоимостьБезНДСУпр = 1 ИЛИ УзлыНДС.ДоляСтоимостьБезНДСУпр = -1
	|			ТОГДА Т.СтоимостьБезНДСУпр * УзлыНДС.ДоляСтоимостьБезНДСУпр
	|			ИНАЧЕ Т.СтоимостьБезНДСУпр * УзлыНДС.СтоимостьБезНДСУпр / УзлыНДС.ИтогСтоимостьБезНДСУпр
	|		КОНЕЦ КАК ЧИСЛО(31,10))) КАК СтоимостьБезНДСУпр,
	| 	СУММА(ВЫРАЗИТЬ(ВЫБОР КОГДА УзлыНДС.ДоляНДСУпр = 0 ИЛИ УзлыНДС.ДоляНДСУпр = 1 ИЛИ УзлыНДС.ДоляНДСУпр = -1
	|			ТОГДА Т.НДСУпр * УзлыНДС.ДоляНДСУпр
	|			ИНАЧЕ Т.НДСУпр * УзлыНДС.НДСУпр / УзлыНДС.ИтогНДСУпр
	|		КОНЕЦ КАК ЧИСЛО(31,10))) КАК НДСУпр
	|ПОМЕСТИТЬ ТаблицаРешенийДетально
	|ИЗ
	|	ТаблицаРешенийРасширенная КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТИсходныеУзлыСебестоимостиИНДС КАК УзлыНДС
	|		ПО Т.НомерУзлаНДС = УзлыНДС.НомерУзлаГруппаНДС
	|СГРУППИРОВАТЬ ПО
	|   Т.НомерУзла,
	|	УзлыНДС.ЭтоОстаткиПостатейныеПеременные,
	|	УзлыНДС.ЭтоОстаткиПостатейныеПостоянные,
	|	УзлыНДС.ЭтоДопРасходы,
	|	УзлыНДС.ЭтоПеременныеДопРасходы,
	|	УзлыНДС.СтатьяРасходов,
	|	УзлыНДС.АналитикаРасходов,
	|	УзлыНДС.ДокументПоступления,
	|	УзлыНДС.АналитикаУчетаПартийДокументаПоступления,
	|	УзлыНДС.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	УзлыНДС.ЗатратыПредыдущихПеределов,
	//++ Локализация
	|	Т.СписаниеНДС,
	//-- Локализация
	|	Т.ИсходнаяЗатрата
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерУзла
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.ЭтоОстаткиПостатейныеПеременные,
	|	Т.ЭтоОстаткиПостатейныеПостоянные,
	|	Т.ЭтоДопРасходы,
	|	Т.ЭтоПеременныеДопРасходы,
	|
	|	&НачалоПериода КАК Период,
	|	УзлыСебестоимости.Организация КАК Организация,
	|	УзлыСебестоимости.РазделУчета,
	|	УзлыСебестоимости.АналитикаУчетаНоменклатуры,
	|	УзлыСебестоимости.ВидЗапасов,
	|	УзлыСебестоимости.Партия,
	|	УзлыСебестоимости.АналитикаУчетаПартий,
	|	УзлыСебестоимости.ВидДеятельностиНДС,
	|	УзлыСебестоимости.АналитикаФинансовогоУчета,
	|	ВЫБОР КОГДА УзлыСебестоимости.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|		ТОГДА УзлыСебестоимости.АналитикаУчетаНоменклатуры
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|	КОНЕЦ КАК АналитикаУчетаНоменклатурыНЗП,
	|	МАКСИМУМ(УзлыСебестоимости.КоличествоПартии) КАК КоличествоПартии,
	|
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|
	|	(Т.ИсходнаяЗатрата И НЕ Т.ЗатратыПредыдущихПеределов) КАК ИсходнаяЗатрата,
	//++ Локализация
	|	Т.СписаниеНДС,
	|	ВЫБОР КОГДА УзлыСебестоимости.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|		ТОГДА ЕСТЬNULL(УчетнаяПолитика.СтатьяРасходовНеНДС, ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка))
	|		ИНАЧЕ ЕСТЬNULL(УчетнаяПолитика.СтатьяРасходовЕНВД, ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка))
	|	КОНЕЦ КАК СтатьяСписанияНДС,
	//-- Локализация
	|	СУММА(ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА Т.СтоимостьСНДС - ВЫРАЗИТЬ(Т.СтоимостьСНДС КАК ЧИСЛО(31,4)) МЕЖДУ -&ПогрешностьОкругленияРешенияСЛУ И &ПогрешностьОкругленияРешенияСЛУ
	|			ТОГДА ВЫРАЗИТЬ(Т.СтоимостьСНДС КАК ЧИСЛО(31,4))
	|			ИНАЧЕ Т.СтоимостьСНДС
	|		КОНЕЦ КАК ЧИСЛО(31,10))) КАК СтоимостьСНДС,
	|	СУММА(ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА Т.СтоимостьБезНДС - ВЫРАЗИТЬ(Т.СтоимостьБезНДС КАК ЧИСЛО(31,4)) МЕЖДУ -&ПогрешностьОкругленияРешенияСЛУ И &ПогрешностьОкругленияРешенияСЛУ
	|			ТОГДА ВЫРАЗИТЬ(Т.СтоимостьБезНДС КАК ЧИСЛО(31,4))
	|			ИНАЧЕ Т.СтоимостьБезНДС
	|		КОНЕЦ КАК ЧИСЛО(31,10))) КАК СтоимостьБезНДС,
	|	СУММА(ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА Т.СтоимостьБезНДСРегл - ВЫРАЗИТЬ(Т.СтоимостьБезНДСРегл КАК ЧИСЛО(31,4)) МЕЖДУ -&ПогрешностьОкругленияРешенияСЛУ И &ПогрешностьОкругленияРешенияСЛУ
	|			ТОГДА ВЫРАЗИТЬ(Т.СтоимостьБезНДСРегл КАК ЧИСЛО(31,4))
	|			ИНАЧЕ Т.СтоимостьБезНДСРегл
	|		КОНЕЦ КАК ЧИСЛО(31,10))) КАК СтоимостьБезНДСРегл,
	|	СУММА(ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА Т.НДСРегл - ВЫРАЗИТЬ(Т.НДСРегл КАК ЧИСЛО(31,4)) МЕЖДУ -&ПогрешностьОкругленияРешенияСЛУ И &ПогрешностьОкругленияРешенияСЛУ
	|			ТОГДА ВЫРАЗИТЬ(Т.НДСРегл КАК ЧИСЛО(31,4))
	|			ИНАЧЕ Т.НДСРегл
	|		КОНЕЦ КАК ЧИСЛО(31,10))) КАК НДСРегл,
	|	СУММА(ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА Т.СтоимостьБезНДСУпр - ВЫРАЗИТЬ(Т.СтоимостьБезНДСУпр КАК ЧИСЛО(31,4)) МЕЖДУ -&ПогрешностьОкругленияРешенияСЛУ И &ПогрешностьОкругленияРешенияСЛУ
	|			ТОГДА ВЫРАЗИТЬ(Т.СтоимостьБезНДСУпр КАК ЧИСЛО(31,4))
	|			ИНАЧЕ Т.СтоимостьБезНДСУпр
	|		КОНЕЦ КАК ЧИСЛО(31,10))) КАК СтоимостьБезНДСУпр,
	|	СУММА(ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА Т.НДСУпр - ВЫРАЗИТЬ(Т.НДСУпр КАК ЧИСЛО(31,4)) МЕЖДУ -&ПогрешностьОкругленияРешенияСЛУ И &ПогрешностьОкругленияРешенияСЛУ
	|			ТОГДА ВЫРАЗИТЬ(Т.НДСУпр КАК ЧИСЛО(31,4))
	|			ИНАЧЕ Т.НДСУпр
	|		КОНЕЦ КАК ЧИСЛО(31,10))) КАК НДСУпр
	|ПОМЕСТИТЬ ВТЦеныУзловДетально
	|ИЗ
	|	ТаблицаРешенийДетально КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтУзлыКорректировкиСебестоимостиСОстаткамиПартий КАК УзлыСебестоимости
	|		ПО УзлыСебестоимости.НомерУзла = Т.НомерУзла
	//++ Локализация
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТНастройкиУчетаНДС КАК УчетнаяПолитика
	|			ПО УзлыСебестоимости.Организация = УчетнаяПолитика.Организация
	//-- Локализация
	|ГДЕ
	|	УзлыСебестоимости.Партия <> НЕОПРЕДЕЛЕНО
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.ЭтоОстаткиПостатейныеПеременные,
	|	Т.ЭтоОстаткиПостатейныеПостоянные,
	|	Т.ЭтоДопРасходы,
	|	Т.ЭтоПеременныеДопРасходы,
	|	УзлыСебестоимости.Организация,
	|	УзлыСебестоимости.РазделУчета,
	|	УзлыСебестоимости.АналитикаУчетаНоменклатуры,
	|	УзлыСебестоимости.ВидЗапасов,
	|	УзлыСебестоимости.Партия,
	|	УзлыСебестоимости.АналитикаУчетаПартий,
	|	УзлыСебестоимости.ВидДеятельностиНДС,
	|	УзлыСебестоимости.АналитикаФинансовогоУчета,
	|	ВЫБОР КОГДА УзлыСебестоимости.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|		ТОГДА УзлыСебестоимости.АналитикаУчетаНоменклатуры
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|	КОНЕЦ,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	//++ Локализация
	|	Т.СписаниеНДС,
	|	ВЫБОР КОГДА УзлыСебестоимости.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|		ТОГДА ЕСТЬNULL(УчетнаяПолитика.СтатьяРасходовНеНДС, ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка))
	|		ИНАЧЕ ЕСТЬNULL(УчетнаяПолитика.СтатьяРасходовЕНВД, ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка))
	|	КОНЕЦ,
	//-- Локализация
	|	(Т.ИсходнаяЗатрата И НЕ Т.ЗатратыПредыдущихПеределов)
	|ИМЕЮЩИЕ
	|	СУММА(ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА Т.СтоимостьСНДС - ВЫРАЗИТЬ(Т.СтоимостьСНДС КАК ЧИСЛО(31,4)) МЕЖДУ -&ПогрешностьОкругленияРешенияСЛУ И &ПогрешностьОкругленияРешенияСЛУ
	|			ТОГДА ВЫРАЗИТЬ(Т.СтоимостьСНДС КАК ЧИСЛО(31,4))
	|			ИНАЧЕ Т.СтоимостьСНДС
	|		КОНЕЦ КАК ЧИСЛО(31,10))) <> 0
	|	ИЛИ СУММА(ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА Т.СтоимостьБезНДС - ВЫРАЗИТЬ(Т.СтоимостьБезНДС КАК ЧИСЛО(31,4)) МЕЖДУ -&ПогрешностьОкругленияРешенияСЛУ И &ПогрешностьОкругленияРешенияСЛУ
	|			ТОГДА ВЫРАЗИТЬ(Т.СтоимостьБезНДС КАК ЧИСЛО(31,4))
	|			ИНАЧЕ Т.СтоимостьБезНДС
	|		КОНЕЦ КАК ЧИСЛО(31,10))) <> 0
	|	ИЛИ СУММА(ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА Т.СтоимостьБезНДСРегл - ВЫРАЗИТЬ(Т.СтоимостьБезНДСРегл КАК ЧИСЛО(31,4)) МЕЖДУ -&ПогрешностьОкругленияРешенияСЛУ И &ПогрешностьОкругленияРешенияСЛУ
	|			ТОГДА ВЫРАЗИТЬ(Т.СтоимостьБезНДСРегл КАК ЧИСЛО(31,4))
	|			ИНАЧЕ Т.СтоимостьБезНДСРегл
	|		КОНЕЦ КАК ЧИСЛО(31,10))) <> 0
	|	ИЛИ СУММА(ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА Т.НДСРегл - ВЫРАЗИТЬ(Т.НДСРегл КАК ЧИСЛО(31,4)) МЕЖДУ -&ПогрешностьОкругленияРешенияСЛУ И &ПогрешностьОкругленияРешенияСЛУ
	|			ТОГДА ВЫРАЗИТЬ(Т.НДСРегл КАК ЧИСЛО(31,4))
	|			ИНАЧЕ Т.НДСРегл
	|		КОНЕЦ КАК ЧИСЛО(31,10))) <> 0
	|	ИЛИ СУММА(ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА Т.СтоимостьБезНДСУпр - ВЫРАЗИТЬ(Т.СтоимостьБезНДСУпр КАК ЧИСЛО(31,4)) МЕЖДУ -&ПогрешностьОкругленияРешенияСЛУ И &ПогрешностьОкругленияРешенияСЛУ
	|			ТОГДА ВЫРАЗИТЬ(Т.СтоимостьБезНДСУпр КАК ЧИСЛО(31,4))
	|			ИНАЧЕ Т.СтоимостьБезНДСУпр
	|		КОНЕЦ КАК ЧИСЛО(31,10))) <> 0
	|	ИЛИ СУММА(ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА Т.НДСУпр - ВЫРАЗИТЬ(Т.НДСУпр КАК ЧИСЛО(31,4)) МЕЖДУ -&ПогрешностьОкругленияРешенияСЛУ И &ПогрешностьОкругленияРешенияСЛУ
	|			ТОГДА ВЫРАЗИТЬ(Т.НДСУпр КАК ЧИСЛО(31,4))
	|			ИНАЧЕ Т.НДСУпр
	|		КОНЕЦ КАК ЧИСЛО(31,10))) <> 0
	|	
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	АналитикаРасходов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Организация КАК Организация,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов
	|ПОМЕСТИТЬ ВТАналитикиРасходовПартийНДС
	|ИЗ
	|	ВТЦеныУзловДетально КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
	|		ПО Статья.Ссылка = Т.СтатьяРасходов
	|ГДЕ
	|	Т.АналитикаРасходов <> НЕОПРЕДЕЛЕНО
	|	И (ТИПЗНАЧЕНИЯ(Т.АналитикаРасходов) В (&ТипыДокументовПартии)
	|		ИЛИ ТИПЗНАЧЕНИЯ(Т.АналитикаРасходов) В (&ТипыАналитикПеременныхРасходов))
	|	И (Статья.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
	|		ИЛИ Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
	|	И НЕ Т.ЭтоОстаткиПостатейныеПеременные
	|	И НЕ Т.ЭтоОстаткиПостатейныеПостоянные
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	АналитикаРасходов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	// Формирование таблицы отбора данных для движений по регистру "ДетализацияСебестоимостиТоваровПостатейныеЗатраты".
	// В регистр "ДетализацияСебестоимостиТоваровПостатейныеЗатраты" попадают дополнительные расходы:
	// - относящиеся к партии прошлого периода
	// - распределяемые на документ перемещения товаров
	// - распределяемые на склад или на номенклатуру (такие доп расходы распределяются на остатки и приходы товаров)
	// 	 распределяемые на прочие расходы
	|ВЫБРАТЬ
	|	Т.Организация КАК Организация,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов
	|ПОМЕСТИТЬ ВТОтборАналитикиРасходовПартийНДСПеременные
	|ИЗ
	|	ВТАналитикиРасходовПартийНДС КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|		ПО ДанныеПервичныхДокументов.Организация = Т.Организация
	|		И ДанныеПервичныхДокументов.Документ = Т.АналитикаРасходов
	|ГДЕ
	|	(ДанныеПервичныхДокументов.ДатаРегистратора ЕСТЬ НЕ NULL
	|		И НАЧАЛОПЕРИОДА(ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, &НачалоПериода), МЕСЯЦ) < &НачалоПериода)
	|	ИЛИ ТИПЗНАЧЕНИЯ(Т.АналитикаРасходов) В (&ТипыАналитикПеременныхРасходов)
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	АналитикаРасходов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Организация,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий
	|ПОМЕСТИТЬ ВТОтборПартий
	|ИЗ
	|	ВТЦеныУзловДетально КАК Т
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия,
	|	АналитикаУчетаПартий,
	|	Организация
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	&НачалоПериода КАК ПериодРегистрации,
	|
	|	Т.Организация,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидЗапасов,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|
	|	Т.ЗатратыПредыдущихПеределов,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.АналитикаУчетаНоменклатурыНЗП,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|
	|	СУММА(Т.СтоимостьСНДС) КАК СтоимостьСНДС,
	|	СУММА(Т.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	СУММА(Т.СтоимостьБезНДСРегл) КАК СтоимостьБезНДСРегл,
	|	СУММА(Т.НДСРегл) КАК НДСРегл,
	|	СУММА(Т.СтоимостьБезНДСУпр) КАК СтоимостьБезНДСУпр,
	|	СУММА(Т.НДСУпр) КАК НДСУпр
	|ПОМЕСТИТЬ ВТЦеныУзловПостоянные
	|ИЗ
	|(
	|	ВЫБРАТЬ
	|		ЛОЖЬ КАК ЕстьДвижения,
	|		Т.Организация,
	|		Т.Партия,
	|		Т.АналитикаУчетаПартий,
	|		Т.ВидЗапасов,
	|		ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Номенклатура КАК Номенклатура,
	|		ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Характеристика КАК Характеристика,
	|	
	|		НЕ Т.ИсходнаяЗатрата КАК ЗатратыПредыдущихПеределов,
	|		Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|		Т.АналитикаУчетаНоменклатурыНЗП,
	|		Т.ДокументПоступления,
	|		Т.АналитикаУчетаПартийДокументаПоступления,
	|
	|		МАКСИМУМ(Т.СтоимостьСНДС) КАК СтоимостьСНДС,
	|		МАКСИМУМ(Т.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|		МАКСИМУМ(Т.СтоимостьБезНДСРегл) КАК СтоимостьБезНДСРегл,
	|		МАКСИМУМ(Т.НДСРегл) КАК НДСРегл,
	|		МАКСИМУМ(Т.СтоимостьБезНДСУпр) КАК СтоимостьБезНДСУпр,
	|		МАКСИМУМ(Т.НДСУпр) КАК НДСУпр
	|	ИЗ
	|		ВТЦеныУзловДетально КАК Т
	|		ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходов
	|			ПО Т.СтатьяРасходов = СтатьиРасходов.Ссылка
	|	ГДЕ
	|		СтатьиРасходов.Ссылка ЕСТЬ NULL
	|		И НЕ Т.ЭтоДопРасходы
	|		И НЕ Т.ЭтоОстаткиПостатейныеПеременные
	|		И НЕ Т.ЭтоОстаткиПостатейныеПостоянные		
	|	СГРУППИРОВАТЬ ПО
	|		Т.Организация,
	|		Т.Партия,
	|		Т.АналитикаУчетаПартий,
	|		Т.ВидЗапасов,
	|		ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Номенклатура,
	|		ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Характеристика,
	|		НЕ Т.ИсходнаяЗатрата,
	|		Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|		Т.АналитикаУчетаНоменклатурыНЗП,
	|		Т.ДокументПоступления,
	|		Т.АналитикаУчетаПартийДокументаПоступления
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		ИСТИНА КАК ЕстьДвижения,
	|		Т.Организация,
	|		Т.Партия,
	|		Т.АналитикаУчетаПартий,
	|		Т.ВидЗапасов,
	|		Т.Номенклатура,
	|		Т.Характеристика,
	|
	|		Т.ЗатратыПредыдущихПеределов,
	|		Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|		Т.АналитикаУчетаНоменклатурыНЗП,
	|		Т.ДокументПоступления,
	|		Т.АналитикаУчетаПартийДокументаПоступления,
	|
	|		0,
	|		0,
	|		0,
	|		0,
	|		0,
	|		0
	|	ИЗ
	|		РегистрСведений.ДетализацияСебестоимостиПартииТоваров КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборПартий КАК Отбор
	|			ПО Т.Организация = Отбор.Организация
	|			И Т.Партия = Отбор.Партия
	|			И Т.АналитикаУчетаПартий = Отбор.АналитикаУчетаПартий
	|	ГДЕ
	|		Т.ПериодРегистрации < &НачалоПериода
	|) КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидЗапасов,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ЗатратыПредыдущихПеределов,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.АналитикаУчетаНоменклатурыНЗП,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления
	|ИМЕЮЩИЕ
	|	МАКСИМУМ(Т.ЕстьДвижения) = ЛОЖЬ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	&НачалоПериода КАК ПериодРегистрации,
	|
	|	Т.Организация,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидЗапасов,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|
	|	Т.ЗатратыПредыдущихПеределов,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.АналитикаУчетаНоменклатурыНЗП,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|
	|	СУММА(Т.СтоимостьСНДС) КАК СтоимостьСНДС,
	|	СУММА(Т.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	СУММА(Т.СтоимостьБезНДСРегл) КАК СтоимостьБезНДСРегл,
	|	СУММА(Т.НДСРегл) КАК НДСРегл,
	|	СУММА(Т.СтоимостьБезНДСУпр) КАК СтоимостьБезНДСУпр,
	|	СУММА(Т.НДСУпр) КАК НДСУпр
	|ПОМЕСТИТЬ ВТЦеныУзловПостатейныеПостоянные
	|ИЗ
	|(
	|	ВЫБРАТЬ
	|		ЛОЖЬ КАК ЕстьДвижения,
	|		ВЫБОР КОГДА Т.ЭтоОстаткиПостатейныеПеременные И НЕ Т.ЭтоПеременныеДопРасходы ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ КАК ВключениеПеременныхВСтоимость,
	|		Т.Организация,
	|		Т.Партия,
	|		Т.АналитикаУчетаПартий,
	|		Т.ВидЗапасов,
	|		ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Номенклатура КАК Номенклатура,
	|		ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Характеристика КАК Характеристика,
	|	
	|		НЕ Т.ИсходнаяЗатрата КАК ЗатратыПредыдущихПеределов,
	|		Т.СтатьяРасходов,
	|		Т.АналитикаРасходов,
	|		Т.АналитикаУчетаНоменклатурыНЗП,
	|		Т.ДокументПоступления,
	|		Т.АналитикаУчетаПартийДокументаПоступления,
	|
	|		МАКСИМУМ(Т.СтоимостьСНДС) КАК СтоимостьСНДС,
	|		МАКСИМУМ(Т.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|		МАКСИМУМ(Т.СтоимостьБезНДСРегл) КАК СтоимостьБезНДСРегл,
	|		МАКСИМУМ(Т.НДСРегл) КАК НДСРегл,
	|		МАКСИМУМ(Т.СтоимостьБезНДСУпр) КАК СтоимостьБезНДСУпр,
	|		МАКСИМУМ(Т.НДСУпр) КАК НДСУпр
	|	ИЗ
	|		ВТЦеныУзловДетально КАК Т
	|		ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходов
	|			ПО Т.СтатьяРасходов = СтатьиРасходов.Ссылка
	|	ГДЕ
	|		(НЕ СтатьиРасходов.Ссылка ЕСТЬ NULL
	|			ИЛИ (Т.ЭтоДопРасходы И НЕ Т.ЭтоПеременныеДопРасходы)
	// Условие для таможенных деклараций на импорт с доп расходами на документ поступления прошлого периода, перенесенных на другую партию.
	// Данные расходы переквалифицируются с переменных на постоянные.
	|			ИЛИ (Т.ЭтоДопРасходы И Т.ЭтоПеременныеДопРасходы И НЕ Т.ИсходнаяЗатрата)
	|			ИЛИ (Т.ЭтоОстаткиПостатейныеПеременные И НЕ Т.ИсходнаяЗатрата)
	|			ИЛИ Т.ЭтоОстаткиПостатейныеПостоянные)
	// Условие для таможенных деклараций на импорт с доп расходами на документ поступления прошлого периода, которые являются и доп расходами и переменными доп расходами одновременно
	|		И НЕ (Т.ЭтоДопРасходы И Т.ЭтоПеременныеДопРасходы И Т.ИсходнаяЗатрата)
	|		И (НЕ Т.ЭтоОстаткиПостатейныеПеременные ИЛИ НЕ Т.ИсходнаяЗатрата)
	|		И (НЕ Т.ИсходнаяЗатрата
	|			ИЛИ НЕ (ИСТИНА В (ВЫБРАТЬ ПЕРВЫЕ 1 ИСТИНА
	|							  ИЗ ВТОтборАналитикиРасходовПартийНДСПеременные КАК Отбор
	|							  ГДЕ 
	|								Т.Организация = Отбор.Организация
	|								И Т.АналитикаРасходов = Отбор.АналитикаРасходов
	|								И Т.СтатьяРасходов = Отбор.СтатьяРасходов)))
	|	СГРУППИРОВАТЬ ПО
	|		ВЫБОР КОГДА Т.ЭтоОстаткиПостатейныеПеременные И НЕ Т.ЭтоПеременныеДопРасходы ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ,
	|		Т.Организация,
	|		Т.Партия,
	|		Т.АналитикаУчетаПартий,
	|		Т.ВидЗапасов,
	|		ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Номенклатура,
	|		ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Характеристика,
	|		НЕ Т.ИсходнаяЗатрата,
	|		Т.СтатьяРасходов,
	|		Т.АналитикаРасходов,
	|		Т.АналитикаУчетаНоменклатурыНЗП,
	|		Т.ДокументПоступления,
	|		Т.АналитикаУчетаПартийДокументаПоступления
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		ИСТИНА КАК ЕстьДвижения,
	|		ЛОЖЬ КАК ВключениеПеременныхВСтоимость,
	|		Т.Организация,
	|		Т.Партия,
	|		Т.АналитикаУчетаПартий,
	|		Т.ВидЗапасов,
	|		Т.Номенклатура,
	|		Т.Характеристика,
	|
	|		Т.ЗатратыПредыдущихПеределов,
	|		Т.СтатьяРасходов,
	|		Т.АналитикаРасходов,
	|		Т.АналитикаУчетаНоменклатурыНЗП,
	|		Т.ДокументПоступления,
	|		Т.АналитикаУчетаПартийДокументаПоступления,
	|
	|		0,
	|		0,
	|		0,
	|		0,
	|		0,
	|		0
	|	ИЗ
	|		РегистрСведений.ДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборПартий КАК Отбор
	|			ПО Т.Организация = Отбор.Организация
	|			И Т.Партия = Отбор.Партия
	|			И Т.АналитикаУчетаПартий = Отбор.АналитикаУчетаПартий
	|	ГДЕ
	|		Т.ПериодРегистрации < &НачалоПериода
	|) КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидЗапасов,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ЗатратыПредыдущихПеределов,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.АналитикаУчетаНоменклатурыНЗП,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления
	|ИМЕЮЩИЕ
	|	МАКСИМУМ(Т.ЕстьДвижения) = ЛОЖЬ
	|";
	
	ТипыАналитикПеременныхРасходов = Новый Массив;
	ТипыАналитикПеременныхРасходов.Добавить(Тип("ДокументСсылка.ПеремещениеТоваров"));
	ТипыАналитикПеременныхРасходов.Добавить(Тип("ДокументСсылка.ПоступлениеТоваровОтХранителя"));
	
	ТипыАналитикПеременныхРасходов.Добавить(Тип("СправочникСсылка.Склады"));
	ТипыАналитикПеременныхРасходов.Добавить(Тип("СправочникСсылка.Номенклатура"));
	ТипыАналитикПеременныхРасходов.Добавить(Тип("СправочникСсылка.ПрочиеРасходы"));
	ТипыАналитикПеременныхРасходов.Добавить(Тип("СправочникСсылка.Партнеры"));
	ТипыАналитикПеременныхРасходов.Добавить(Тип("СправочникСсылка.ДоговорыКонтрагентов"));
	
	Запрос.УстановитьПараметр("ТипыАналитикПеременныхРасходов", ТипыАналитикПеременныхРасходов);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, "ТаблицаРешений");
	
	#КонецОбласти
	
	СоответствиеВременныхТаблицДвижений = Новый Соответствие;
	
	#Область СохранениеДвижений_ДетализацияСебестоимостиПартииТоваров
	
	ИмяРегистра = Метаданные.РегистрыСведений.ДетализацияСебестоимостиПартииТоваров.Имя;
	
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	ИмяВременнойТаблицы = "ВТДетализацияСебестоимостиПартииТоваров";
	
	КопируемыеПоля = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьИменаКолонокСтрокой(
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыгрузитьВременнуюТаблицу(ПараметрыРасчета, "ВТЦеныУзловПостоянные", 0));
	
	КопируемыеПоля = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(КопируемыеПоля, "");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(
		ПараметрыРасчета,
		ТаблицаОписанияПолей,
		ИмяРегистра,
		"ВТЦеныУзловПостоянные",
		ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
	#КонецОбласти
	
	#Область СохранениеДвижений_ДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты
	
	ИмяРегистра = Метаданные.РегистрыСведений.ДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты.Имя;
	
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	ИмяВременнойТаблицы = "ВТДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты";
	
	КопируемыеПоля = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьИменаКолонокСтрокой(
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыгрузитьВременнуюТаблицу(ПараметрыРасчета, "ВТЦеныУзловПостатейныеПостоянные", 0));
	
	КопируемыеПоля = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(КопируемыеПоля, "");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(
		ПараметрыРасчета,
		ТаблицаОписанияПолей,
		ИмяРегистра,
		"ВТЦеныУзловПостатейныеПостоянные",
		ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
	#КонецОбласти
	
	#Область СохранениеДвижений_ДетализацияСебестоимостиТоваровПостатейныеЗатраты
	
	ИмяРегистра = Метаданные.РегистрыСведений.ДетализацияСебестоимостиТоваровПостатейныеЗатраты.Имя;
	
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	ИмяВременнойТаблицы = "ВТДетализацияСебестоимостиТоваровПостатейныеЗатраты";
	
	КопируемыеПоля = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьИменаКолонокСтрокой(
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыгрузитьВременнуюТаблицу(ПараметрыРасчета, "ВТЦеныУзловДетально", 0));
	
	КопируемыеПоля = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(КопируемыеПоля, "");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	УсловиеГДЕ = "(ЭтоОстаткиПостатейныеПеременные
		|	ИЛИ ЭтоПеременныеДопРасходы
		|	ИЛИ (Организация, СтатьяРасходов, АналитикаРасходов) В (
		|	ВЫБРАТЬ
		|		Организация, СтатьяРасходов, АналитикаРасходов
		|	ИЗ ВТОтборАналитикиРасходовПартийНДСПеременные КАК Отбор))
		|	И ИсходнаяЗатрата
		|	И НЕ ЭтоОстаткиПостатейныеПостоянные
		|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(
		ПараметрыРасчета,
		ТаблицаОписанияПолей,
		ИмяРегистра,
		"ВТЦеныУзловДетально",
		ИмяВременнойТаблицы,
		УсловиеГДЕ);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);

	//++ Локализация
	
	// Корректировка сумм НДС при списании НДС на статью
	ИмяВременнойТаблицы = "ВТДетализацияСебестоимостиТоваровПостатейныеЗатратыСписаниеНДС";
	
	КопируемыеПоля = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьИменаКолонокСтрокой(
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыгрузитьВременнуюТаблицу(ПараметрыРасчета, "ВТЦеныУзловДетально", 0));
	
	КопируемыеПоля = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(КопируемыеПоля, "");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьСНДС", 		"0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьБезНДС", 		"0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьБезНДСРегл", 	"0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьБезНДСУпр", 	"0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НДСРегл", 				"-НДСРегл");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НДСУпр", 				"-НДСУпр");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтатьяРасходов",		"СтатьяСписанияНДС");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаРасходов",		"НЕОПРЕДЕЛЕНО");
	
	УсловиеГДЕ = "СписаниеНДС И (НДСРегл <> 0 ИЛИ НДСУпр <> 0)";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(
		ПараметрыРасчета,
		ТаблицаОписанияПолей,
		ИмяРегистра,
		"ВТЦеныУзловДетально",
		ИмяВременнойТаблицы,
		УсловиеГДЕ);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
	//-- Локализация
	#КонецОбласти
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвиженияИзВременныхТаблиц(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений, Истина);
	
	ДополнитьДанныеДетализацииПартийНДС(ПараметрыРасчета, ИмяТаблицыДанныхИсходная);
	
	// Уничтожим ненужные временные таблицы.
	НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(
		ПараметрыРасчета,
		СуществующиеВТ);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);
	
КонецПроцедуры

Процедура ДополнитьДанныеДетализацииПартийНДС(ПараметрыРасчета, ИмяТаблицыДанныхИсходная)
	
	СуществующиеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета);
	
	ИмяРегистра = Метаданные.РегистрыСведений.ДетализацияСебестоимостиТоваровПостатейныеЗатраты.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	СоответствиеВременныхТаблицДвижений = Новый Соответствие;
	
	Если ИмяТаблицыДанныхИсходная = "ПриходыТоваровНДС2_4_ДляРешенияСЛУ" Тогда
		
		#Область КорректировкаСуммПриКорректировкиПриобретения
		
		// Корректировка сумм для корректировок приобретения на количество остатка
		ИмяВременнойТаблицы = "ВТДетализацияСебестоимостиТоваровПостатейныеЗатратыКорректировкиПриобретения";
		
		КопируемыеПоля = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьИменаКолонокСтрокой(
			РасчетСебестоимостиПрикладныеАлгоритмы.ВыгрузитьВременнуюТаблицу(ПараметрыРасчета, "ПриходыТоваровНДС2_4", 0));
		
		КопируемыеПоля = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(КопируемыеПоля, "");
		
		ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
		РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьСНДС", 		"СтоимостьСНДС");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьБезНДС", 		"СтоимостьБезНДС");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьБезНДСРегл", 	"СтоимостьБезНДСРегл");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьБезНДСУпр", 	"СтоимостьБезНДСУпр");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НДСРегл", 				"НДСРегл");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НДСУпр", 				"НДСУпр");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "КоличествоПартии",
			"ВЫБОР КОГДА Количество < 0 ТОГДА -Количество ИНАЧЕ Количество КОНЕЦ");

		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Период", 				"&НачалоПериода");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ТипЗаписи",				"ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка)");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ДокументПоступления",
			"ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(ДокументПоступления) В (&ТипыДокументовПартии)
			|		ТОГДА ДокументПоступления
			|		ИНАЧЕ НЕОПРЕДЕЛЕНО
			|КОНЕЦ");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаУчетаПартийДокументаПоступления",
			"ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(ДокументПоступления) В (&ТипыДокументовПартии)
			|		ТОГДА АналитикаУчетаПартийДокументаПоступления
			|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
			|КОНЕЦ");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтатьяРасходов",
			"ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(СтатьяРасходовАктивов) <> ТИП(ПланВидовХарактеристик.СтатьиРасходов)
			|		ТОГДА ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
			|		ИНАЧЕ СтатьяРасходовАктивов
			|КОНЕЦ");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаРасходов",
			"ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(СтатьяРасходовАктивов) <> ТИП(ПланВидовХарактеристик.СтатьиРасходов)
			|		ТОГДА НЕОПРЕДЕЛЕНО
			|		ИНАЧЕ АналитикаРасходовАктивов
			|КОНЕЦ");
		
		УсловиеГДЕ = "ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Остаток)";
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(
			ПараметрыРасчета,
			ТаблицаОписанияПолей,
			ИмяРегистра,
			"ПриходыТоваровНДС2_4",
			ИмяВременнойТаблицы,
			УсловиеГДЕ);
		
		СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
		
		#КонецОбласти
		
		#Область ОтклоненияСтоимостиПриПолномВыбытии
		
		// Отклонения стоимости при полном выбытии товара в прошлых периодах
		ИмяВременнойТаблицы = "ВТДетализацияСебестоимостиТоваровПостатейныеЗатратыОтклоненияНаВыбытияВПрошлыхПериодах";
		
		КопируемыеПоля = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьИменаКолонокСтрокой(
			РасчетСебестоимостиПрикладныеАлгоритмы.ВыгрузитьВременнуюТаблицу(ПараметрыРасчета, "ПриходыТоваровНДС2_4", 0));
		
		КопируемыеПоля = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(КопируемыеПоля, "");
		
		ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
		РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьСНДС",
			"ВЫРАЗИТЬ(СтоимостьСНДС / Количество КАК ЧИСЛО (28,10))");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьБезНДС",
			"ВЫРАЗИТЬ(СтоимостьБезНДС / Количество КАК ЧИСЛО (28,10))");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьБезНДСРегл",
			"ВЫРАЗИТЬ(СтоимостьБезНДСРегл / Количество КАК ЧИСЛО (28,10))");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьБезНДСУпр",
			"ВЫРАЗИТЬ(СтоимостьБезНДСУпр / Количество КАК ЧИСЛО (28,10))");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НДСРегл",
			"ВЫРАЗИТЬ(НДСРегл / Количество КАК ЧИСЛО (28,10))");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НДСУпр",
			"ВЫРАЗИТЬ(НДСУпр / Количество КАК ЧИСЛО (28,10))");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "КоличествоПартии",		"Количество");

		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Период", 				"&НачалоПериода");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ТипЗаписи",				"ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка)");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ДокументПоступления",
			"ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(ДокументПоступления) В (&ТипыДокументовПартии)
			|		ТОГДА ДокументПоступления
			|		ИНАЧЕ НЕОПРЕДЕЛЕНО
			|КОНЕЦ");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаУчетаПартийДокументаПоступления",
			"ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(ДокументПоступления) В (&ТипыДокументовПартии)
			|		ТОГДА АналитикаУчетаПартийДокументаПоступления
			|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
			|КОНЕЦ");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтатьяРасходов",
			"ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(СтатьяРасходовАктивов) <> ТИП(ПланВидовХарактеристик.СтатьиРасходов)
			|		ТОГДА ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
			|		ИНАЧЕ СтатьяРасходовАктивов
			|КОНЕЦ");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаРасходов",
			"ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(СтатьяРасходовАктивов) <> ТИП(ПланВидовХарактеристик.СтатьиРасходов)
			|		ТОГДА НЕОПРЕДЕЛЕНО
			|		ИНАЧЕ АналитикаРасходовАктивов
			|КОНЕЦ");
		
		УсловиеГДЕ = "ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОстатокСгруппированный) И Количество <> 0";
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(
			ПараметрыРасчета,
			ТаблицаОписанияПолей,
			ИмяРегистра,
			"ПриходыТоваровНДС2_4",
			ИмяВременнойТаблицы,
			УсловиеГДЕ);
		
		СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
		
		#КонецОбласти
		
	ИначеЕсли ИмяТаблицыДанныхИсходная = "ПриходыДопРасходовНДС2_4_ДляРешенияСЛУ" Тогда
		
		#Область ДопРасходыПриПолномВыбытии
		
		// Доп. расходы при полном выбытии товара в прошлых периодах
		ИмяВременнойТаблицы = "ВТДетализацияСебестоимостиТоваровПостатейныеЗатратыДопРасходыНаВыбытияВПрошлыхПериодах";
		
		КопируемыеПоля = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьИменаКолонокСтрокой(
			РасчетСебестоимостиПрикладныеАлгоритмы.ВыгрузитьВременнуюТаблицу(ПараметрыРасчета, "ВТДопРасходыНДС2_4", 0));
		
		КопируемыеПоля = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(КопируемыеПоля, "");
		
		ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
		РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьСНДС", 		"ВыбытиеСтоимостьСНДС");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьБезНДС", 		"ВыбытиеСтоимостьБезНДС");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьБезНДСРегл", 	"ВыбытиеСтоимостьБезНДСРегл");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьБезНДСУпр", 	"ВыбытиеСтоимостьБезНДСУпр");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НДСРегл", 				"ВыбытиеНДСРегл");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НДСУпр", 				"ВыбытиеНДСУпр");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "КоличествоПартии",		"Количество");
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Период", 				"&НачалоПериода");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ТипЗаписи",				"ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка)");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ДокументПоступления",
			"ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(ДокументПоступления) В (&ТипыДокументовПартии)
			|		ТОГДА ДокументПоступления
			|		ИНАЧЕ НЕОПРЕДЕЛЕНО
			|КОНЕЦ");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаУчетаПартийДокументаПоступления",
			"ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(ДокументПоступления) В (&ТипыДокументовПартии)
			|		ТОГДА АналитикаУчетаПартийДокументаПоступления
			|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
			|КОНЕЦ");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтатьяРасходов",
			"ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(СтатьяРасходов) <> ТИП(ПланВидовХарактеристик.СтатьиРасходов)
			|		ТОГДА ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
			|		ИНАЧЕ СтатьяРасходов
			|КОНЕЦ");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаРасходов",
			"ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(СтатьяРасходов) <> ТИП(ПланВидовХарактеристик.СтатьиРасходов)
			|		ТОГДА НЕОПРЕДЕЛЕНО
			|		ИНАЧЕ АналитикаРасходов
			|КОНЕЦ");
		
		УсловиеГДЕ = "ПолноеВыбытие";
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(
			ПараметрыРасчета,
			ТаблицаОписанияПолей,
			ИмяРегистра,
			"ВТДопРасходыНДС2_4",
			ИмяВременнойТаблицы,
			УсловиеГДЕ);
		
		СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);

		#КонецОбласти
		
	КонецЕсли;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвиженияИзВременныхТаблиц(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений, Истина);
	
	// Уничтожим ненужные временные таблицы.
	НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(
		ПараметрыРасчета,
		СуществующиеВТ);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);
	
КонецПроцедуры

Процедура СформироватьСтоимостьПартийНДСНаКонецПериода(ПараметрыРасчета, НомерВызова)
	
	ИмяТаблицыРезультата = "ВТОборотыСтоимостьПартийНДС"; 
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, ИмяТаблицыРезультата);
	
	СуществующиеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета);
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.УстановитьПараметр("НомерВызова", НомерВызова);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	НАЧАЛОПЕРИОДА(МАКСИМУМ(Т.Период), МЕСЯЦ) КАК Период
	|ПОМЕСТИТЬ ПериодПредыдущегоРассчитанногоПериода
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|ГДЕ
	|	Т.Период < &НачалоПериода
	|	И Т.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
	|ИНДЕКСИРОВАТЬ ПО
	|	Период
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.СтатьяРасходов,
	|
	|	МАКСИМУМ(Т.СтоимостьСНДС) КАК СтоимостьСНДС,
	|	МАКСИМУМ(Т.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	МАКСИМУМ(Т.СтоимостьБезНДСРегл) КАК СтоимостьБезНДСРегл,
	|	МАКСИМУМ(Т.НДСРегл) КАК НДСРегл,
	|	МАКСИМУМ(Т.СтоимостьБезНДСУпр) КАК СтоимостьБезНДСУпр,
	|	МАКСИМУМ(Т.НДСУпр) КАК НДСУпр
	|ПОМЕСТИТЬ ВТОстаткиПеременныхЗатрат
	|ИЗ
	|(ВЫБРАТЬ
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.СтатьяРасходов,
	|
	|	Т.СтоимостьСНДС,
	|	Т.СтоимостьБезНДС,
	|	Т.СтоимостьБезНДСРегл,
	|	Т.НДСРегл,
	|	Т.СтоимостьБезНДСУпр,
	|	Т.НДСУпр
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиТоваровПостатейныеЗатраты КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПериодПредыдущегоРассчитанногоПериода КАК ПериодДвижений
	|		ПО Т.Период = ПериодДвижений.Период
	|ГДЕ
	|	Т.Организация В(&ОрганизацииСУчетомПартийНДСВерсии24)
	|	И НЕ Т.ТипЗаписи В (&ТипыЗаписейКонвертацииДанных)
	|	И (&НомерВызова = 1 ИЛИ Т.НДСРегл <> 0 ИЛИ Т.НДСУпр <> 0)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.СтатьяРасходов,
	|
	|	Т.СтоимостьСНДС,
	|	Т.СтоимостьБезНДС,
	|	Т.СтоимостьБезНДСРегл,
	|	Т.НДСРегл,
	|	Т.СтоимостьБезНДСУпр,
	|	Т.НДСУпр
	|ИЗ
	|	ВТКэшДетализацияСебестоимостиТоваровПостатейныеЗатраты КАК Т
	|ГДЕ
	|	Т.Организация В(&ОрганизацииСУчетомПартийНДСВерсии24)
	|	И НЕ Т.ТипЗаписи В (&ТипыЗаписейКонвертацииДанных)
	|	И (&НомерВызова = 1 ИЛИ Т.НДСРегл <> 0 ИЛИ Т.НДСУпр <> 0)
	|) КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.СтатьяРасходов
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия,
	|	Организация
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Ссылка КАК Ссылка,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	Т.АналитикаУчетаНоменклатуры.Серия КАК Серия
	|ПОМЕСТИТЬ ВТПередачиБезНДС
	|ИЗ
	|	Документ.ПередачаТоваровМеждуОрганизациями.ВидыЗапасов КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями КАК Передачи
	|		ПО Т.Ссылка = Передачи.Ссылка
	|ГДЕ
	|	Передачи.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Передачи.Организация В (&МассивОрганизаций)
	|	И Передачи.Проведен
	|	И Т.СтавкаНДС = ЗНАЧЕНИЕ(Справочник.СтавкиНДС.БезНДС)
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.СлужебноеВидДвиженияПриход,
	|	Т.Регистратор,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов,
	|	(ВЫБОР
	|		КОГДА Т.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		 И Т.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Т.СтатьяРасходовСписания
	|		КОГДА Т.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|			ТОГДА Т.СтатьяАктивовПассивов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК СтатьяРасходовАктивов,
	|	(ВЫБОР
	|		КОГДА Т.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		 И Т.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Т.АналитикаРасходов
	|		КОГДА Т.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|			ТОГДА Т.АналитикаАктивовПассивов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК АналитикаРасходовАктивов,
	|
	|	ВЫБОР
	//++ Локализация
	|		КОГДА Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И НЕ ЕСТЬNULL(СтатьиРасходов.ПринятиеКНалоговомуУчету, ИСТИНА) И ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
	|		 И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	//-- Локализация
	|		КОГДА НЕ ПередачаВидыЗапасов.Ссылка ЕСТЬ NULL И НЕ Т.СлужебноеВидДвиженияПриход
	|		 И Передача.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|		КОГДА НЕ Передача.Ссылка ЕСТЬ NULL И НЕ Т.СлужебноеВидДвиженияПриход
	|			ТОГДА Передача.НалогообложениеНДС
	|		КОГДА НЕ Возврат.Ссылка ЕСТЬ NULL И Т.СлужебноеВидДвиженияПриход
	|			ТОГДА Возврат.НалогообложениеНДС
	|		ИНАЧЕ Т.КорВидДеятельностиНДС
	|	КОНЕЦ КАК КорВидДеятельностиНДС,
	|	Т.КорАналитикаУчетаНоменклатуры,
	|	Т.КорВидЗапасов,
	|	Т.Подразделение,
	|	Т.ТипЗаписи,
	|	Т.Сторно,
	|	Т.ИдентификаторФинЗаписи,
	|
	|	ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
	|	(ВЫБОР
	|		КОГДА Т.КорНаправлениеДеятельности <> ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|			ТОГДА Т.КорНаправлениеДеятельности
	|		ИНАЧЕ
	|			ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) 
	|		КОНЕЦ) КАК КорНаправлениеДеятельности,
	|	Т.ГруппаПродукции КАК КорГруппаПродукции,
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	Т.Количество
	|ПОМЕСТИТЬ ВТСебестоимостьДляСтоимостиПартийНДСПредварительная
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями КАК Передача
	|		ПО Передача.Ссылка = Т.Регистратор
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТПередачиБезНДС КАК ПередачаВидыЗапасов
	|		ПО ПередачаВидыЗапасов.Ссылка = Т.Регистратор
	|			И ПередачаВидыЗапасов.Номенклатура = Т.АналитикаУчетаНоменклатуры.Номенклатура
	|			И ПередачаВидыЗапасов.Характеристика = Т.АналитикаУчетаНоменклатуры.Характеристика
	|			И ПередачаВидыЗапасов.Серия = Т.АналитикаУчетаНоменклатуры.Серия
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровМеждуОрганизациями КАК Возврат
	|		ПО Возврат.Ссылка = Т.Регистратор
	//++ Локализация
	|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходов
	|		ПО СтатьиРасходов.Ссылка = Т.СтатьяРасходовСписания
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТНастройкиУчетаНДС КАК НастройкиУчетаНДС
	|		ПО НастройкиУчетаНДС.Организация = Т.Организация
	//-- Локализация
	|ГДЕ
	|	Т.Организация В(&ОрганизацииСУчетомПартийНДСВерсии24)
	|	И (Т.ТипЗаписи <> ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
	|		ИЛИ Т.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка))
	|	И Т.Количество <> 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СтатьяРасходовСписания
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Регистратор КАК Регистратор
	|ПОМЕСТИТЬ ВтРегистраторыВыручки
	|ИЗ
	|	ВТКэшРасчетныеОборотыВыручкаИСебестоимостьПродаж КАК Т
	|ГДЕ
	|	&НомерВызова = 3
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.СлужебноеВидДвиженияПриход,
	|	Т.Регистратор,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.СтатьяРасходовАктивов,
	|	Т.АналитикаРасходовАктивов,
	|
	|	Т.КорВидДеятельностиНДС,
	|	Т.КорАналитикаУчетаНоменклатуры,
	|	Т.КорВидЗапасов,
	|	Т.Подразделение,
	|	Т.ТипЗаписи,
	|	Т.Сторно,
	|	Т.ИдентификаторФинЗаписи,
	|	Т.НаправлениеДеятельности,
	|	Т.КорНаправлениеДеятельности,
	|	Т.КорГруппаПродукции,
	|	Т.ХозяйственнаяОперация,
	|	Т.ВозможноСписаниеНДС,
	|	Т.Количество
	|ПОМЕСТИТЬ ВТСебестоимостьДляСтоимостиПартийНДС
	|ИЗ
	|(ВЫБРАТЬ
	|	Т.Период,
	|	Т.СлужебноеВидДвиженияПриход,
	|	Т.Регистратор,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.СтатьяРасходовАктивов,
	|	Т.АналитикаРасходовАктивов,
	|
	|	Т.КорВидДеятельностиНДС,
	|	Т.КорАналитикаУчетаНоменклатуры,
	|	Т.КорВидЗапасов,
	|	Т.Подразделение,
	|	Т.ТипЗаписи,
	|	Т.Сторно,
	|	Т.ИдентификаторФинЗаписи,
	|	Т.НаправлениеДеятельности,
	|	Т.КорНаправлениеДеятельности,
	|	Т.КорГруппаПродукции,
	|	Т.ХозяйственнаяОперация,
	|
	|	ВЫБОР КОГДА Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|	  И Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ВозможноСписаниеНДС,
	// Заполнение поля ЭтоДанныеДляВключенияИсключенияНДС должно соответствовать условиям в ВключитьИсключитьНДСВСтоимость24(), ВключитьИсключитьНДСВСтоимостьПродаж24() 
	|	ВЫБОР КОГДА
	|	  (&НомерВызова <> 3
	|		ИЛИ НЕ РегистраторыВыручки.Регистратор ЕСТЬ NULL)
	|		ИЛИ (Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|	  		И Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)) // ВозможноСписаниеНДС
	|	  И (Т.ВидДеятельностиНДС <> Т.КорВидДеятельностиНДС
	//++ Локализация
	|		 ИЛИ Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 ИЛИ Т.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 ИЛИ Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДСВСтранеЕАЭС)
	|		 ИЛИ Т.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДСВСтранеЕАЭС)
	//-- Локализация
	|		)
	|	  И Т.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|	  И Т.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|	  И (НЕ Т.СлужебноеВидДвиженияПриход
	|		ИЛИ Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов))
	|	  И НЕ (Т.Сторно
	|			И Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ИсправлениеПрошлогоПериода))
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЭтоДанныеДляВключенияИсключенияНДС,
	// Заполнение поля ЭтоДанныеДляДопРасходов должно соответствовать условиям в ТекстДопРасходыДляРаспределенияФИФО()
	|	ВЫБОР КОГДА &НомерВызова = 1
	|	  И НЕ СтатьиНаСебестоимость.Ссылка ЕСТЬ NULL
	|	  И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНаРасходыФиксированнаяСтоимость)
	|	  И НЕ Т.СлужебноеВидДвиженияПриход
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЭтоДанныеДляДопРасходов,
	//++ Локализация

	// Заполнение поля ЭтоДанныеДляПартийНДСКРаспределению должно соответствовать условиям в см. ТекстПоступленияПартийНДСКРаспределениюИзПартийНДС2_4().
	|	ВЫБОР КОГДА НЕ Т.СлужебноеВидДвиженияПриход
	|	  И Т.Организация В (&ОрганизацииСРаспределениемПартийНДС)
	|	  И (СтатьиРасходов.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
	|		ИЛИ СтатьиРасходов.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
	|			И СтатьиРасходов.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС)
	|		ИЛИ Т.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
	|		ИЛИ НЕ СтатьиАктивовПассивов.Ссылка ЕСТЬ NULL
	|			И Т.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
	|		ИЛИ (НЕ СтатьиРасходов.Ссылка ЕСТЬ NULL ИЛИ НЕ СтатьиАктивовПассивов.Ссылка ЕСТЬ NULL)
	|			И Т.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортСырьевыхТоваровУслуг)
	// Если КорАналитикаУчетаНоменклатуры не пустая - значит это выпуск со списанием в производство (прямые расходы).
	// Прямые расходы не должны формировать движений по РН ПартииНДСКРаспределению.
	|			И Т.КорАналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|	    )
	|	  И Т.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|	  И Т.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
	|	  И НЕ ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.ВозвратТоваровПоставщику)
	|	  И НЕ ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.ВозвратТоваровМеждуОрганизациями)
	|	  И НЕ Т.РазделУчета В (
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажиКОформлениюСписания),
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработкуКОформлениюСписания),
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания))
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЭтоДанныеДляПартийНДСКРаспределению,
	//-- Локализация
	|
	|	Т.Количество
	|ИЗ
	|	ВТСебестоимостьДляСтоимостиПартийНДСПредварительная КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтРегистраторыВыручки КАК РегистраторыВыручки
	|		ПО РегистраторыВыручки.Регистратор = Т.Регистратор
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТСтатьиЗатратНаСебестоимость КАК СтатьиНаСебестоимость
	|		ПО &НомерВызова = 1
	|		И СтатьиНаСебестоимость.Ссылка = Т.СтатьяРасходовСписания
	//++ Локализация
	|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходов
	|		ПО СтатьиРасходов.Ссылка = Т.СтатьяРасходовСписания
	|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиАктивовПассивов КАК СтатьиАктивовПассивов
	|		ПО СтатьиАктивовПассивов.Ссылка = Т.СтатьяАктивовПассивов
	//-- Локализация
	|	) КАК Т
	|ГДЕ
	|	Т.ЭтоДанныеДляВключенияИсключенияНДС
	|	ИЛИ Т.ЭтоДанныеДляДопРасходов
	//++ Локализация
	|	ИЛИ Т.ЭтоДанныеДляПартийНДСКРаспределению
	//-- Локализация
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия,
	|	Организация,
	|	Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Партия,
	|	Т.Организация,
	|	Т.Номенклатура
	|ПОМЕСТИТЬ ВТОтборПартииДляЦен
	|ИЗ
	|	ВТСебестоимостьДляСтоимостиПартийНДС КАК Т
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия,
	|	Организация,
	|	Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Партия,
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидЗапасов,
	|	Т.АналитикаУчетаНоменклатурыНЗП,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	ЛОЖЬ КАК ПостатейныеЗатраты,
	|	НЕОПРЕДЕЛЕНО КАК ХарактерПроизводственныхЗатрат,
	|	ВЫРАЗИТЬ(Т.СтоимостьСНДС КАК ЧИСЛО(31,10)) КАК СтоимостьСНДС,
	|	ВЫРАЗИТЬ(Т.СтоимостьБезНДС КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(Т.СтоимостьБезНДСРегл КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСРегл,
	|	ВЫРАЗИТЬ(Т.НДСРегл КАК ЧИСЛО(31,10)) КАК НДСРегл,
	|	ВЫРАЗИТЬ(Т.СтоимостьБезНДСУпр КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСУпр,
	|	ВЫРАЗИТЬ(Т.НДСУпр КАК ЧИСЛО(31,10)) КАК НДСУпр
	|ПОМЕСТИТЬ ВТЦеныПартийНДСТекущие
	|ИЗ
	|	ВтКэшДетализацияСебестоимостиПартииТоваров КАК Т
	|ГДЕ
	|	НЕ Т.ТипЗаписи В (&ТипыЗаписейКонвертацииДанных)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Партия,
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидЗапасов,
	|	Т.АналитикаУчетаНоменклатурыНЗП,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	ЛОЖЬ КАК ПостатейныеЗатраты,
	|	НЕОПРЕДЕЛЕНО КАК ХарактерПроизводственныхЗатрат,
	|	ВЫРАЗИТЬ(Т.СтоимостьСНДС КАК ЧИСЛО(31,10)) КАК СтоимостьСНДС,
	|	ВЫРАЗИТЬ(Т.СтоимостьБезНДС КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(Т.СтоимостьБезНДСРегл КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСРегл,
	|	ВЫРАЗИТЬ(Т.НДСРегл КАК ЧИСЛО(31,10)) КАК НДСРегл,
	|	ВЫРАЗИТЬ(Т.СтоимостьБезНДСУпр КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСУпр,
	|	ВЫРАЗИТЬ(Т.НДСУпр КАК ЧИСЛО(31,10)) КАК НДСУпр
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиПартииТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборПартииДляЦен КАК Отбор
	|		ПО Отбор.Партия = Т.Партия
	|		И Отбор.Организация = Т.Организация
	|		И Отбор.Номенклатура = Т.Номенклатура
	|		И Т.ПериодРегистрации < &НачалоПериода
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Партия,
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидЗапасов,
	|	Т.АналитикаУчетаНоменклатурыНЗП,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	ВЫБОР КОГДА Т.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) ТОГДА ЛОЖЬ ИНАЧЕ ИСТИНА КОНЕЦ КАК ПостатейныеЗатраты,
	|	ВЫБОР КОГДА НЕ СтатьиНаПроизводство.Ссылка ЕСТЬ NULL
	|		ТОГДА Т.СтатьяРасходов.ХарактерПроизводственныхЗатрат
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ХарактерПроизводственныхЗатрат,
	|	ВЫРАЗИТЬ(Т.СтоимостьСНДС КАК ЧИСЛО(31,10)) КАК СтоимостьСНДС,
	|	ВЫРАЗИТЬ(Т.СтоимостьБезНДС КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(Т.СтоимостьБезНДСРегл КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСРегл,
	|	ВЫРАЗИТЬ(Т.НДСРегл КАК ЧИСЛО(31,10)) КАК НДСРегл,
	|	ВЫРАЗИТЬ(Т.СтоимостьБезНДСУпр КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСУпр,
	|	ВЫРАЗИТЬ(Т.НДСУпр КАК ЧИСЛО(31,10)) КАК НДСУпр
	|ИЗ
	|	ВтКэшДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТСтатьиПроизводственныхЗатрат КАК СтатьиНаПроизводство
	|		ПО СтатьиНаПроизводство.Ссылка = Т.СтатьяРасходов
	|ГДЕ
	|	НЕ Т.ТипЗаписи В (&ТипыЗаписейКонвертацииДанных)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Партия,
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидЗапасов,
	|	Т.АналитикаУчетаНоменклатурыНЗП,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	ВЫБОР КОГДА Т.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) ТОГДА ЛОЖЬ ИНАЧЕ ИСТИНА КОНЕЦ КАК ПостатейныеЗатраты,
	|	ВЫБОР КОГДА НЕ СтатьиНаПроизводство.Ссылка ЕСТЬ NULL
	|		ТОГДА Т.СтатьяРасходов.ХарактерПроизводственныхЗатрат
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ХарактерПроизводственныхЗатрат,
	|	ВЫРАЗИТЬ(Т.СтоимостьСНДС КАК ЧИСЛО(31,10)) КАК СтоимостьСНДС,
	|	ВЫРАЗИТЬ(Т.СтоимостьБезНДС КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(Т.СтоимостьБезНДСРегл КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСРегл,
	|	ВЫРАЗИТЬ(Т.НДСРегл КАК ЧИСЛО(31,10)) КАК НДСРегл,
	|	ВЫРАЗИТЬ(Т.СтоимостьБезНДСУпр КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСУпр,
	|	ВЫРАЗИТЬ(Т.НДСУпр КАК ЧИСЛО(31,10)) КАК НДСУпр
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборПартииДляЦен КАК Отбор
	|		ПО Отбор.Партия = Т.Партия
	|		И Отбор.Организация = Т.Организация
	|		И Отбор.Номенклатура = Т.Номенклатура
	|		И Т.ПериодРегистрации < &НачалоПериода
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТСтатьиПроизводственныхЗатрат КАК СтатьиНаПроизводство
	|		ПО СтатьиНаПроизводство.Ссылка = Т.СтатьяРасходов
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия,
	|	Организация,
	|	Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.СлужебноеВидДвиженияПриход,
	|	Т.Регистратор,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.СтатьяРасходовАктивов,
	|	Т.АналитикаРасходовАктивов,
	|
	|	Т.КорВидДеятельностиНДС,
	|	Т.КорАналитикаУчетаНоменклатуры,
	|	Т.КорВидЗапасов,
	|	Т.Подразделение,
	|	Т.ТипЗаписи,
	|	Т.Сторно,
	|	Т.ИдентификаторФинЗаписи,
	|	Цены.ПостатейныеЗатраты,
	|	ЛОЖЬ КАК ПостатейныеЗатратыНЗП,
	|	Цены.ХарактерПроизводственныхЗатрат,
	|
	|	Т.ВозможноСписаниеНДС,
	|
	|	Т.НаправлениеДеятельности,
	|	Т.КорНаправлениеДеятельности,
	|	Т.КорГруппаПродукции,
	|	Т.ХозяйственнаяОперация,
	|
	|	Цены.ДокументПоступления КАК ДокументПоступления,
	|	Цены.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
	|
	|	СУММА(ВЫРАЗИТЬ(ВЫРАЗИТЬ(Цены.СтоимостьСНДС КАК ЧИСЛО(31,10)) * ВЫРАЗИТЬ(Т.Количество КАК ЧИСЛО(15,3)) КАК ЧИСЛО (31,10))) КАК СтоимостьСНДС,
	|	СУММА(ВЫРАЗИТЬ(ВЫРАЗИТЬ(Цены.СтоимостьБезНДС КАК ЧИСЛО(31,10)) * ВЫРАЗИТЬ(Т.Количество КАК ЧИСЛО(15,3)) КАК ЧИСЛО (31,10))) КАК СтоимостьБезНДС,
	|	СУММА(ВЫРАЗИТЬ(ВЫРАЗИТЬ(Цены.СтоимостьБезНДСРегл КАК ЧИСЛО(31,10)) * ВЫРАЗИТЬ(Т.Количество КАК ЧИСЛО(15,3)) КАК ЧИСЛО (31,10))) КАК СтоимостьБезНДСРегл,
	|	СУММА(ВЫРАЗИТЬ(ВЫРАЗИТЬ(Цены.НДСРегл КАК ЧИСЛО(31,10)) * ВЫРАЗИТЬ(Т.Количество КАК ЧИСЛО(15,3)) КАК ЧИСЛО (31,10))) КАК НДСРегл,
	|	СУММА(ВЫРАЗИТЬ(ВЫРАЗИТЬ(Цены.СтоимостьБезНДСУпр КАК ЧИСЛО(31,10)) * ВЫРАЗИТЬ(Т.Количество КАК ЧИСЛО(15,3)) КАК ЧИСЛО (31,10))) КАК СтоимостьБезНДСУпр,
	|	СУММА(ВЫРАЗИТЬ(ВЫРАЗИТЬ(Цены.НДСУпр КАК ЧИСЛО(31,10)) * ВЫРАЗИТЬ(Т.Количество КАК ЧИСЛО(15,3)) КАК ЧИСЛО (31,10))) КАК НДСУпр,
	|	Т.Количество
	|ПОМЕСТИТЬ ВТОборотыСтоимостьПартийНДСПредварительная
	|ИЗ
	|	ВТСебестоимостьДляСтоимостиПартийНДС КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТЦеныПартийНДСТекущие КАК Цены
	|		ПО (Цены.Партия = Т.Партия)
	|			И (Цены.Организация = Т.Организация)
	|			И (Цены.Номенклатура = Т.Номенклатура)
	|			И (Цены.Характеристика = Т.Характеристика)
	|			И (Цены.АналитикаУчетаПартий = Т.АналитикаУчетаПартий)
	|			И (Цены.ВидЗапасов = Т.ВидЗапасов)
	|			И (Т.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|				ИЛИ Т.АналитикаУчетаНоменклатуры = Цены.АналитикаУчетаНоменклатурыНЗП)
	|ГДЕ
	|	(&НомерВызова = 1
	|		ИЛИ ВЫРАЗИТЬ(ВЫРАЗИТЬ(Цены.НДСРегл КАК ЧИСЛО(31,10)) * ВЫРАЗИТЬ(Т.Количество КАК ЧИСЛО(15,3)) КАК ЧИСЛО(31,2)) <> 0
	|		ИЛИ ВЫРАЗИТЬ(ВЫРАЗИТЬ(Цены.НДСУпр КАК ЧИСЛО(31,10)) * ВЫРАЗИТЬ(Т.Количество КАК ЧИСЛО(15,3)) КАК ЧИСЛО(31,2)) <> 0)
	|СГРУППИРОВАТЬ ПО
	|	Т.Период,
	|	Т.СлужебноеВидДвиженияПриход,
	|	Т.Регистратор,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.СтатьяРасходовАктивов,
	|	Т.АналитикаРасходовАктивов,
	|
	|	Т.КорВидДеятельностиНДС,
	|	Т.КорАналитикаУчетаНоменклатуры,
	|	Т.КорВидЗапасов,
	|	Т.Подразделение,
	|	Т.ТипЗаписи,
	|	Т.Сторно,
	|	Т.ИдентификаторФинЗаписи,
	|	Цены.ПостатейныеЗатраты,
	|	Цены.ХарактерПроизводственныхЗатрат,
	|	Т.ВозможноСписаниеНДС,
	|	Т.НаправлениеДеятельности,
	|	Т.КорНаправлениеДеятельности,
	|	Т.КорГруппаПродукции,
	|	Т.ХозяйственнаяОперация,
	|	Цены.ДокументПоступления,
	|	Цены.АналитикаУчетаПартийДокументаПоступления,
	|	Т.Количество
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.СлужебноеВидДвиженияПриход,
	|	Т.Регистратор,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов,
	|	(ВЫБОР
	|		КОГДА Т.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		 И Т.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Т.СтатьяРасходовСписания
	|		КОГДА Т.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|			ТОГДА Т.СтатьяАктивовПассивов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК СтатьяРасходовАктивов,
	|	(ВЫБОР
	|		КОГДА Т.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		 И Т.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Т.АналитикаРасходов
	|		КОГДА Т.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|			ТОГДА Т.АналитикаАктивовПассивов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК АналитикаРасходовАктивов,
	|
	|	Т.КорВидДеятельностиНДС,
	|	Т.КорАналитикаУчетаНоменклатуры,
	|	Т.КорВидЗапасов,
	|	Т.Подразделение,
	|	Т.ТипЗаписи,
	|	Т.Сторно,
	|	Т.ИдентификаторФинЗаписи,
	|	ВЫБОР КОГДА Цены.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) ТОГДА ЛОЖЬ ИНАЧЕ ИСТИНА КОНЕЦ КАК ПостатейныеЗатраты,
	|	ЛОЖЬ КАК ПостатейныеЗатратыНЗП,
	|	(ВЫБОР
	|		КОГДА НЕ СтатьиНаПроизводство.Ссылка ЕСТЬ NULL
	|			ТОГДА Цены.СтатьяРасходов.ХарактерПроизводственныхЗатрат
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК ХарактерПроизводственныхЗатрат,
	|
	|	ВЫБОР КОГДА Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|	  И Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ВозможноСписаниеНДС,
	|
	|	Т.НаправлениеДеятельности,
	|	Т.КорНаправлениеДеятельности,
	|	Т.КорГруппаПродукции,
	|	Т.ХозяйственнаяОперация,
	|
	|	Цены.ДокументПоступления КАК ДокументПоступления,
	|	Цены.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
	|
	|	СУММА(ВЫРАЗИТЬ(ВЫРАЗИТЬ(Цены.СтоимостьСНДС КАК ЧИСЛО(31,10)) * ВЫРАЗИТЬ(Т.Количество КАК ЧИСЛО(15,3)) КАК ЧИСЛО (31,10))) КАК СтоимостьСНДС,
	|	СУММА(ВЫРАЗИТЬ(ВЫРАЗИТЬ(Цены.СтоимостьБезНДС КАК ЧИСЛО(31,10)) * ВЫРАЗИТЬ(Т.Количество КАК ЧИСЛО(15,3)) КАК ЧИСЛО (31,10))) КАК СтоимостьБезНДС,
	|	СУММА(ВЫРАЗИТЬ(ВЫРАЗИТЬ(Цены.СтоимостьБезНДСРегл КАК ЧИСЛО(31,10)) * ВЫРАЗИТЬ(Т.Количество КАК ЧИСЛО(15,3)) КАК ЧИСЛО (31,10))) КАК СтоимостьБезНДСРегл,
	|	СУММА(ВЫРАЗИТЬ(ВЫРАЗИТЬ(Цены.НДСРегл КАК ЧИСЛО(31,10)) * ВЫРАЗИТЬ(Т.Количество КАК ЧИСЛО(15,3)) КАК ЧИСЛО (31,10))) КАК НДСРегл,
	|	СУММА(ВЫРАЗИТЬ(ВЫРАЗИТЬ(Цены.СтоимостьБезНДСУпр КАК ЧИСЛО(31,10)) * ВЫРАЗИТЬ(Т.Количество КАК ЧИСЛО(15,3)) КАК ЧИСЛО (31,10))) КАК СтоимостьБезНДСУпр,
	|	СУММА(ВЫРАЗИТЬ(ВЫРАЗИТЬ(Цены.НДСУпр КАК ЧИСЛО(31,10)) * ВЫРАЗИТЬ(Т.Количество КАК ЧИСЛО(15,3)) КАК ЧИСЛО (31,10))) КАК НДСУпр,
	|	Т.Количество
	|ИЗ
	|	ВТСебестоимостьДляСтоимостиПартийНДС КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОстаткиПеременныхЗатрат КАК Цены
	|		ПО (Цены.Организация = Т.Организация)
	|			И (Цены.РазделУчета = Т.РазделУчета)
	|			И (Цены.АналитикаУчетаНоменклатуры = Т.АналитикаУчетаНоменклатуры)
	|			И (Цены.ВидЗапасов = Т.ВидЗапасов)
	|			И (Цены.Партия = Т.Партия)
	|			И (Цены.АналитикаУчетаПартий = Т.АналитикаУчетаПартий)
	|			И (Цены.ВидДеятельностиНДС = Т.ВидДеятельностиНДС)
	|			И (Цены.АналитикаФинансовогоУчета = Т.АналитикаФинансовогоУчета)
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТСтатьиПроизводственныхЗатрат КАК СтатьиНаПроизводство
	|		ПО СтатьиНаПроизводство.Ссылка = Цены.СтатьяРасходов
	|ГДЕ
	|	НЕ Т.ТипЗаписи В (ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение))
	|	И (&НомерВызова = 1
	|		ИЛИ ВЫРАЗИТЬ(ВЫРАЗИТЬ(Цены.НДСРегл КАК ЧИСЛО(31,10)) * ВЫРАЗИТЬ(Т.Количество КАК ЧИСЛО(15,3)) КАК ЧИСЛО(31,2)) <> 0
	|		ИЛИ ВЫРАЗИТЬ(ВЫРАЗИТЬ(Цены.НДСУпр КАК ЧИСЛО(31,10)) * ВЫРАЗИТЬ(Т.Количество КАК ЧИСЛО(15,3)) КАК ЧИСЛО(31,2)) <> 0)
	|СГРУППИРОВАТЬ ПО
	|	Т.Период,
	|	Т.СлужебноеВидДвиженияПриход,
	|	Т.Регистратор,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов,
	|	(ВЫБОР
	|		КОГДА Т.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		 И Т.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Т.СтатьяРасходовСписания
	|		КОГДА Т.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|			ТОГДА Т.СтатьяАктивовПассивов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
	|	(ВЫБОР
	|		КОГДА Т.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		 И Т.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Т.АналитикаРасходов
	|		КОГДА Т.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|			ТОГДА Т.АналитикаАктивовПассивов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
	|	Т.КорВидДеятельностиНДС,
	|	Т.КорАналитикаУчетаНоменклатуры,
	|	Т.КорВидЗапасов,
	|	Т.Подразделение,
	|	Т.ТипЗаписи,
	|	Т.Сторно,
	|	Т.ИдентификаторФинЗаписи,
	|	ВЫБОР КОГДА Цены.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) ТОГДА ЛОЖЬ ИНАЧЕ ИСТИНА КОНЕЦ,
	|	(ВЫБОР
	|		КОГДА НЕ СтатьиНаПроизводство.Ссылка ЕСТЬ NULL
	|			ТОГДА Цены.СтатьяРасходов.ХарактерПроизводственныхЗатрат
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
	|	ВЫБОР КОГДА Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|	  И Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	Т.НаправлениеДеятельности,
	|	Т.КорНаправлениеДеятельности,
	|	Т.КорГруппаПродукции,
	|	Т.ХозяйственнаяОперация,
	|	Цены.ДокументПоступления,
	|	Цены.АналитикаУчетаПартийДокументаПоступления,
	|	Т.Количество
	//++ Локализация


	//-- Локализация
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Организация,
	|	Т.ДокументПоступления
	|ПОМЕСТИТЬ ВТДокументыПоступленияНДС
	|ИЗ
	|	ВТОборотыСтоимостьПартийНДСПредварительная КАК Т
	|ГДЕ
	|	Т.ВозможноСписаниеНДС
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	ДокументПоступления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ ПЕРВЫЕ 0
	|	Т.Организация,
	|	Т.ДокументПоступления КАК ДокументПоступления,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовНеНДС,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходовНеНДС,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовЕНВД,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходовЕНВД
	|
	|ПОМЕСТИТЬ ВТДокументыСписанияНДС
	|ИЗ
	|	ВТДокументыПоступленияНДС КАК Т
	//++ Локализация
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.ДокументПоступления КАК ДокументПоступления,
	|	УчетнаяПолитика.СтатьяРасходовНеНДС,
	|	УчетнаяПолитика.АналитикаРасходовНеНДС,
	|	УчетнаяПолитика.СтатьяРасходовЕНВД,
	|	УчетнаяПолитика.АналитикаРасходовЕНВД
	|ИЗ
	|	ВТДокументыПоступленияНДС КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТНастройкиУчетаНДС КАК УчетнаяПолитика
	|		ПО Т.Организация = УчетнаяПолитика.Организация
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|		ПО ДанныеПервичныхДокументов.Организация = Т.Организация
	|		И ДанныеПервичныхДокументов.Документ = Т.ДокументПоступления
	|ГДЕ
	|	УчетнаяПолитика.ВариантУчетаНДСПриИзмененииВидаДеятельности <> ЗНАЧЕНИЕ(Перечисление.ВариантыУчетаНДСПриИзмененииВидаДеятельностиНаНеоблагаемую.ВключатьВСтоимость)
	|	И (УчетнаяПолитика.ВариантУчетаНДСПриИзмененииВидаДеятельности <> ЗНАЧЕНИЕ(Перечисление.ВариантыУчетаНДСПриИзмененииВидаДеятельностиНаНеоблагаемую.ВключатьВСтоимостьИлиРасходыВЗависимостиОтПериода)
	|	   ИЛИ НАЧАЛОПЕРИОДА(ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)), МЕСЯЦ) <> &НачалоПериода)
	|	И УчетнаяПолитика.СтатьяРасходовСписаниеНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	//-- Локализация
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументПоступления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ ПЕРВЫЕ 9999999999999
	|	АВТОНОМЕРЗАПИСИ() КАК НомерЗаписи,
	|	Т.Период КАК Период,
	|	Т.СлужебноеВидДвиженияПриход КАК СлужебноеВидДвиженияПриход,
	|	Т.Регистратор КАК Регистратор,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Т.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов КАК СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
	|	ВЫБОР
	//++ Локализация
	
	// Если в настройке учета НДС установлен флажок "Списывать НДС по расходам, не принимаемым к НУ" и указана статья расходов,
	// не принимаемая к налоговому учету по налогу на прибыль, то такие расходы списываются на статью и аналитику расходов 
	// из настройки учета НДС, если НДС не был включен в стоимость товара.
	|		КОГДА Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И НЕ ЕСТЬNULL(СтатьиРасходов.ПринятиеКНалоговомуУчету, ИСТИНА) И ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
	|		 И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|			ТОГДА НастройкиУчетаНДС.СтатьяРасходовСписаниеНДС
	//-- Локализация
	|		КОГДА Т.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|			ТОГДА ЕСТЬNULL(СписаниеНДС.СтатьяРасходовНеНДС, ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка))
	|		ИНАЧЕ ЕСТЬNULL(СписаниеНДС.СтатьяРасходовЕНВД, ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка))
	|	КОНЕЦ КАК СтатьяСписанияНДС,
	|	ВЫБОР
	//++ Локализация
	|		КОГДА Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И НЕ ЕСТЬNULL(СтатьиРасходов.ПринятиеКНалоговомуУчету, ИСТИНА) И ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
	|		 И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|			ТОГДА НастройкиУчетаНДС.АналитикаРасходовСписаниеНДС
	//-- Локализация
	|		КОГДА Т.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|			ТОГДА ЕСТЬNULL(СписаниеНДС.АналитикаРасходовНеНДС, НЕОПРЕДЕЛЕНО)
	|		ИНАЧЕ ЕСТЬNULL(СписаниеНДС.АналитикаРасходовЕНВД, НЕОПРЕДЕЛЕНО)
	|	КОНЕЦ КАК АналитикаСписанияНДС,
	|	Т.СтатьяРасходовАктивов КАК СтатьяРасходовАктивов,
	|	Т.АналитикаРасходовАктивов КАК АналитикаРасходовАктивов,
	|	ВЫБОР
	|		КОГДА ЛОЖЬ ТОГДА НЕОПРЕДЕЛЕНО
	//++ Локализация
	|		КОГДА Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И НЕ ЕСТЬNULL(СтатьиРасходов.ПринятиеКНалоговомуУчету, ИСТИНА) И ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
	|		 И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	//-- Локализация
	|		ИНАЧЕ Т.КорВидДеятельностиНДС
	|	КОНЕЦ КАК КорВидДеятельностиНДС,
	|	Т.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|	Т.КорВидЗапасов КАК КорВидЗапасов,
	|	Т.Подразделение КАК Подразделение,
	|	Т.ТипЗаписи КАК ТипЗаписи,
	|	Т.Сторно КАК Сторно,
	|	Т.ИдентификаторФинЗаписи,
	|	Т.ПостатейныеЗатраты КАК ПостатейныеЗатраты,
	|	Т.ПостатейныеЗатратыНЗП КАК ПостатейныеЗатратыНЗП,
	|	Т.ХарактерПроизводственныхЗатрат,
	|	ВЫБОР КОГДА Т.ВозможноСписаниеНДС И НЕ СписаниеНДС.Организация ЕСТЬ NULL
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ВозможноСписаниеНДС,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	Т.КорГруппаПродукции КАК КорГруппаПродукции,
	|	ВЫБОР
	|		КОГДА ЛОЖЬ ТОГДА НЕОПРЕДЕЛЕНО // для удобства расстановки тегов
	//++ Локализация
	|		КОГДА Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И НЕ ЕСТЬNULL(СтатьиРасходов.ПринятиеКНалоговомуУчету, ИСТИНА) И ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
	|		 И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНДСПоПриобретеннымЦенностям)
	//-- Локализация
	|		ИНАЧЕ Т.ХозяйственнаяОперация
	|	КОНЕЦ КАК ХозяйственнаяОперация,
	|	Т.ДокументПоступления КАК ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
	|
	|	ВЫБОР КОГДА ВЫРАЗИТЬ(Т.СтоимостьСНДС КАК ЧИСЛО (31,2)) > Т.СтоимостьСНДС
	|			И Т.СтоимостьСНДС > 0
	|			И НЕ ОСНО.СистемаНалогообложения ЕСТЬ NULL
	|		ТОГДА ВЫРАЗИТЬ(Т.СтоимостьСНДС КАК ЧИСЛО (31,2)) - 0.01
	|		ИНАЧЕ ВЫРАЗИТЬ(Т.СтоимостьСНДС КАК ЧИСЛО (31,2))
	|	КОНЕЦ КАК СтоимостьСНДС,
	|	ВЫБОР КОГДА ВЫРАЗИТЬ(Т.СтоимостьБезНДС КАК ЧИСЛО (31,2)) > Т.СтоимостьБезНДС
	|			И Т.СтоимостьБезНДС > 0
	|			И НЕ ОСНО.СистемаНалогообложения ЕСТЬ NULL
	|		ТОГДА ВЫРАЗИТЬ(Т.СтоимостьБезНДС КАК ЧИСЛО (31,2)) - 0.01
	|		ИНАЧЕ ВЫРАЗИТЬ(Т.СтоимостьБезНДС КАК ЧИСЛО (31,2))
	|	КОНЕЦ КАК СтоимостьБезНДС,
	|	ВЫБОР КОГДА ВЫРАЗИТЬ(Т.СтоимостьБезНДСРегл КАК ЧИСЛО (31,2)) > Т.СтоимостьБезНДСРегл
	|			И Т.СтоимостьБезНДСРегл > 0
	|			И НЕ ОСНО.СистемаНалогообложения ЕСТЬ NULL
	|		ТОГДА ВЫРАЗИТЬ(Т.СтоимостьБезНДСРегл КАК ЧИСЛО (31,2)) - 0.01
	|		ИНАЧЕ ВЫРАЗИТЬ(Т.СтоимостьБезНДСРегл КАК ЧИСЛО (31,2))
	|	КОНЕЦ КАК СтоимостьБезНДСРегл,
	|	ВЫБОР КОГДА ВЫРАЗИТЬ(Т.НДСРегл КАК ЧИСЛО (31,2)) > Т.НДСРегл
	|			И Т.НДСРегл > 0
	|			И НЕ ОСНО.СистемаНалогообложения ЕСТЬ NULL
	|		ТОГДА ВЫРАЗИТЬ(Т.НДСРегл КАК ЧИСЛО (31,2)) - 0.01
	|		ИНАЧЕ ВЫРАЗИТЬ(Т.НДСРегл КАК ЧИСЛО (31,2))
	|	КОНЕЦ КАК НДСРегл,
	|	ВЫБОР КОГДА ВЫРАЗИТЬ(Т.СтоимостьБезНДСУпр КАК ЧИСЛО (31,2)) > Т.СтоимостьБезНДСУпр
	|			И Т.СтоимостьБезНДСУпр > 0
	|			И НЕ ОСНО.СистемаНалогообложения ЕСТЬ NULL
	|		ТОГДА ВЫРАЗИТЬ(Т.СтоимостьБезНДСУпр КАК ЧИСЛО (31,2)) - 0.01
	|		ИНАЧЕ ВЫРАЗИТЬ(Т.СтоимостьБезНДСУпр КАК ЧИСЛО (31,2))
	|	КОНЕЦ КАК СтоимостьБезНДСУпр,
	|	ВЫБОР КОГДА ВЫРАЗИТЬ(Т.НДСУпр КАК ЧИСЛО (31,2)) > Т.НДСУпр
	|			И Т.НДСУпр > 0
	|			И НЕ ОСНО.СистемаНалогообложения ЕСТЬ NULL
	|		ТОГДА ВЫРАЗИТЬ(Т.НДСУпр КАК ЧИСЛО (31,2)) - 0.01
	|		ИНАЧЕ ВЫРАЗИТЬ(Т.НДСУпр КАК ЧИСЛО (31,2))
	|	КОНЕЦ КАК НДСУпр,
	|	Т.Количество КАК Количество
	|ПОМЕСТИТЬ ВТОборотыСтоимостьПартийНДСБезКорректировокНДС
	|ИЗ
	|	ВТОборотыСтоимостьПартийНДСПредварительная КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТДокументыСписанияНДС КАК СписаниеНДС
	|		ПО СписаниеНДС.Организация = Т.Организация
	|		И СписаниеНДС.ДокументПоступления = Т.ДокументПоступления
	|		И Т.ВозможноСписаниеНДС
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиОрганизаций КАК ОСНО
	|		ПО ОСНО.Организация = Т.Организация
	|		И ОСНО.СистемаНалогообложения = ЗНАЧЕНИЕ(Перечисление.СистемыНалогообложения.Общая)
	//++ Локализация
	|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходов
	|		ПО СтатьиРасходов.Ссылка = Т.СтатьяРасходовСписания
	|		И НЕ (Т.ПостатейныеЗатраты И Т.ПостатейныеЗатратыНЗП)
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТНастройкиУчетаНДС КАК НастройкиУчетаНДС
	|		ПО НастройкиУчетаНДС.Организация = Т.Организация
	//-- Локализация
	|
	// Порядок полей и дальнейшая логика корректировки копеек должна быть идентичная ТекстЗапросаДетализацияПартийНДС()
	|УПОРЯДОЧИТЬ ПО
	|	Регистратор,
	|	Период,
	|	СлужебноеВидДвиженияПриход,
	|	Партия,
	|	АналитикаУчетаНоменклатуры,
	|	ВидЗапасов,
	|	РазделУчета,
	|	Организация,
	|	АналитикаФинансовогоУчета,
	|	ВидДеятельностиНДС,
	|	КорАналитикаУчетаНоменклатуры,
	|	Количество
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументПоступления,
	|	Организация,
	|	НомерЗаписи
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.ДокументПоступления,
	|	Т.Организация КАК Организация,
	|	МАКСИМУМ(Т.НомерЗаписи) КАК НомерЗаписи,
	|	СУММА(Т.СтоимостьБезНДСРегл) КАК СтоимостьБезНДС,
	|	СУММА(Т.НДСРегл) КАК НДС,
	|	СУММА(Т.НДСУпр) КАК НДСУпр
	|ПОМЕСТИТЬ ВТДокументыПоступления
	|ИЗ
	|	ВТОборотыСтоимостьПартийНДСБезКорректировокНДС КАК Т
	|ГДЕ
	// НДС включается в стоимость
	|	Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|	И Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|	И Т.СтатьяСписанияНДС = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|	И (НЕ Т.СлужебноеВидДвиженияПриход
	|		ИЛИ ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат))
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.ДокументПоступления,
	|	Т.Организация
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументПоступления
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.СчетФактура КАК ДокументПоступления,
	|	Т.Организация КАК Организация,
	|	СУММА(Т.СуммаБезНДСОборот) КАК СтоимостьБезНДС,
	|	СУММА(Т.НДСОборот) КАК НДС,
	|	СУММА(Т.НДСУпрОборот) КАК НДСУпр
	|ПОМЕСТИТЬ ВТОборотыДвиженияПоНДС
	|ИЗ
	|	РегистрНакопления.ДвиженияПоНДС.Обороты(, ДОБАВИТЬКДАТЕ(&НачалоПериода, СЕКУНДА, -1), ,
	|		СчетФактура В (ВЫБРАТЬ Отбор.ДокументПоступления ИЗ ВТДокументыПоступления КАК Отбор)) КАК Т	
	|СГРУППИРОВАТЬ ПО
	|	Т.СчетФактура,
	|	Т.Организация
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументПоступления
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.ДокументПоступления КАК ДокументПоступления,
	|	Т.Организация КАК Организация,
	|	Т.НомерЗаписи КАК НомерЗаписи,
	|	ВЫБОР КОГДА ОборотыНДС.СтоимостьБезНДС - Т.СтоимостьБезНДС <> 0
	|		И ОборотыНДС.СтоимостьБезНДС - Т.СтоимостьБезНДС <= &ПорогСписанияПогрешностейОкругленияНДС
	|		И ОборотыНДС.СтоимостьБезНДС - Т.СтоимостьБезНДС >= -&ПорогСписанияПогрешностейОкругленияНДС
	|	  ТОГДА ОборотыНДС.СтоимостьБезНДС - Т.СтоимостьБезНДС
	|	  ИНАЧЕ 0
	|	КОНЕЦ КАК СтоимостьБезНДС,
	|	ВЫБОР КОГДА ОборотыНДС.НДС - Т.НДС <> 0
	|		И ОборотыНДС.НДС - Т.НДС <= &ПорогСписанияПогрешностейОкругленияНДС
	|		И ОборотыНДС.НДС - Т.НДС >= -&ПорогСписанияПогрешностейОкругленияНДС
	|	  ТОГДА ОборотыНДС.НДС - Т.НДС
	|	  ИНАЧЕ 0
	|	КОНЕЦ КАК НДС,
	|	ВЫБОР КОГДА ОборотыНДС.НДСУпр - Т.НДСУпр <> 0
	|		И ОборотыНДС.НДСУпр - Т.НДСУпр <= &ПорогСписанияПогрешностейОкругленияНДС
	|		И ОборотыНДС.НДСУпр - Т.НДСУпр >= -&ПорогСписанияПогрешностейОкругленияНДС
	|	  ТОГДА ОборотыНДС.НДСУпр - Т.НДСУпр
	|	  ИНАЧЕ 0
	|	КОНЕЦ КАК НДСУпр
	|ПОМЕСТИТЬ ВТКорректировкиНДС
	|ИЗ
	|	ВТДокументыПоступления КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОборотыДвиженияПоНДС КАК ОборотыНДС
	|		ПО Т.ДокументПоступления = ОборотыНДС.ДокументПоступления
	|		И Т.Организация = ОборотыНДС.Организация
	|ГДЕ
	|	ВЫБОР КОГДА ОборотыНДС.СтоимостьБезНДС - Т.СтоимостьБезНДС <> 0
	|		И ОборотыНДС.СтоимостьБезНДС - Т.СтоимостьБезНДС <= &ПорогСписанияПогрешностейОкругленияНДС
	|		И ОборотыНДС.СтоимостьБезНДС - Т.СтоимостьБезНДС >= -&ПорогСписанияПогрешностейОкругленияНДС
	|	  ТОГДА ОборотыНДС.СтоимостьБезНДС - Т.СтоимостьБезНДС
	|	  ИНАЧЕ 0
	|	КОНЕЦ  <> 0
	|	ИЛИ ВЫБОР КОГДА ОборотыНДС.НДС - Т.НДС <> 0
	|		И ОборотыНДС.НДС - Т.НДС <= &ПорогСписанияПогрешностейОкругленияНДС
	|		И ОборотыНДС.НДС - Т.НДС >= -&ПорогСписанияПогрешностейОкругленияНДС
	|	  ТОГДА ОборотыНДС.НДС - Т.НДС
	|	  ИНАЧЕ 0
	|	КОНЕЦ  <> 0
	|	ИЛИ ВЫБОР КОГДА ОборотыНДС.НДСУпр - Т.НДСУпр <> 0
	|		И ОборотыНДС.НДСУпр - Т.НДСУпр <= &ПорогСписанияПогрешностейОкругленияНДС
	|		И ОборотыНДС.НДСУпр - Т.НДСУпр >= -&ПорогСписанияПогрешностейОкругленияНДС
	|	  ТОГДА ОборотыНДС.НДСУпр - Т.НДСУпр
	|	  ИНАЧЕ 0
	|	КОНЕЦ  <> 0
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументПоступления,
	|	Организация,
	|	НомерЗаписи
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.СлужебноеВидДвиженияПриход,
	|	Т.Регистратор,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.СтатьяСписанияНДС,
	|	Т.АналитикаСписанияНДС,
	|	Т.СтатьяРасходовАктивов,
	|	Т.АналитикаРасходовАктивов,
	|	Т.КорВидДеятельностиНДС,
	|	Т.КорАналитикаУчетаНоменклатуры,
	|	Т.КорВидЗапасов,
	|	Т.Подразделение,
	|	Т.ТипЗаписи,
	|	Т.Сторно,
	|	Т.ИдентификаторФинЗаписи,
	|	Т.ПостатейныеЗатраты,
	|	Т.ПостатейныеЗатратыНЗП,
	|	Т.ХарактерПроизводственныхЗатрат,
	|	Т.ВозможноСписаниеНДС,
	|	Т.НаправлениеДеятельности,
	|	Т.КорНаправлениеДеятельности,
	|	Т.КорГруппаПродукции,
	|	Т.ХозяйственнаяОперация,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|
	|	Т.СтоимостьСНДС,
	|	Т.СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(Т.СтоимостьБезНДСРегл + ЕСТЬNULL(КорректировкиНДС.СтоимостьБезНДС, 0) КАК ЧИСЛО(31, 2)) КАК СтоимостьБезНДСРегл,
	|	ВЫРАЗИТЬ(Т.НДСРегл + ЕСТЬNULL(КорректировкиНДС.НДС, 0) КАК ЧИСЛО(31, 2)) КАК НДСРегл,
	|	Т.СтоимостьБезНДСУпр,
	|	ВЫРАЗИТЬ(Т.НДСУпр + ЕСТЬNULL(КорректировкиНДС.НДСУпр, 0) КАК ЧИСЛО(31, 2)) КАК НДСУпр,
	|	Т.Количество
	|ПОМЕСТИТЬ ВТОборотыСтоимостьПартийНДС
	|ИЗ
	|	ВТОборотыСтоимостьПартийНДСБезКорректировокНДС КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТКорректировкиНДС КАК КорректировкиНДС
	|		ПО КорректировкиНДС.ДокументПоступления = Т.ДокументПоступления
	|		И КорректировкиНДС.Организация = Т.Организация
	|		И КорректировкиНДС.НомерЗаписи = Т.НомерЗаписи
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|";
	
	//++ Локализация


	//-- Локализация
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
	
	НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(
		ПараметрыРасчета,
		РасчетСебестоимостиУниверсальныеАлгоритмы.СоединитьСтроки(СуществующиеВТ, ИмяТаблицыРезультата));
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);
	
КонецПроцедуры

Функция ТекстЗапросаУзлыНДС(СРасшифровкойПолей = Ложь)
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	Т.НовыйУзелПриемник КАК НомерУзла,
	|	МАКСИМУМ(ВЫБОР КОГДА Т.УзелИсточник = -1
	|		ТОГДА 1
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяЗатрата,
	|	МАКСИМУМ(Т.СтоимостьСНДС) КАК СтоимостьСНДС,
	|	МАКСИМУМ(Т.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	МАКСИМУМ(Т.СтоимостьБезНДСРегл) КАК СтоимостьБезНДСРегл,
	|	МАКСИМУМ(Т.НДСРегл) КАК НДСРегл,
	|	МАКСИМУМ(Т.СтоимостьБезНДСУпр) КАК СтоимостьБезНДСУпр,
	|	МАКСИМУМ(Т.НДСУпр) КАК НДСУпр,
	|	МАКСИМУМ(ВЫБОР КОГДА Т.НДСРегл <> 0 ИЛИ Т.НДСУпр <> 0 ТОГДА 1 ИНАЧЕ 0 КОНЕЦ) КАК СписаниеНДС
	|ПОМЕСТИТЬ ВТУзлыНДСДляРешенияСЛУ
	|ИЗ
	|	ВТРезультатРасчетаПредварительный КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.НовыйУзелПриемник";
	
	Если НЕ СРасшифровкойПолей Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ПОМЕСТИТЬ ВТУзлыНДСДляРешенияСЛУ", "");
		Возврат ТекстЗапроса;
	КонецЕсли;
	
	ТекстЗапроса = ТекстЗапроса + "
	|;
	|" + "
	|ВЫБРАТЬ
	|	Т.НомерУзла КАК НомерУзла,
	|	НовыеУзлы.НомерУзла КАК НомерУзлаСебестоимости,
	|	НовыеУзлы.НомерУзлаНДС КАК НомерУзлаНДС,
	|
	|	УзлыСебестоимости.Организация КАК Организация,
	|	УзлыСебестоимости.РазделУчета,
	|	УзлыСебестоимости.АналитикаУчетаНоменклатуры,
	|	УзлыСебестоимости.ВидЗапасов,
	|	УзлыСебестоимости.Партия,
	|	УзлыСебестоимости.АналитикаУчетаПартий,
	|	УзлыСебестоимости.ВидДеятельностиНДС,
	|	УзлыСебестоимости.АналитикаФинансовогоУчета,
	|
	|	УзлыНДС.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	УзлыНДС.СтатьяРасходов КАК СтатьяРасходов,
	|	УзлыНДС.АналитикаРасходов КАК АналитикаРасходов,
	|	УзлыНДС.ДокументПоступления,
	|	УзлыНДС.АналитикаУчетаПартийДокументаПоступления,
	|
	|	ЕСТЬNULL(УзлыНДС.ЭтоОстаткиПостатейныеПеременные, ЛОЖЬ) КАК ЭтоОстаткиПостатейныеПеременные,
	|	ЕСТЬNULL(УзлыНДС.ЭтоОстаткиПостатейныеПостоянные, ЛОЖЬ) КАК ЭтоОстаткиПостатейныеПостоянные,
	|	ЕСТЬNULL(УзлыНДС.ЭтоДопРасходы, ЛОЖЬ) КАК ЭтоДопРасходы,
	|	ЕСТЬNULL(УзлыНДС.ЭтоПеременныеДопРасходы, ЛОЖЬ) КАК ЭтоПеременныеДопРасходы,
	|
	|	УзлыСебестоимости.КоличествоПартии КАК КоличествоПартии,
	|	Т.ИсходнаяЗатрата,
	|	УзлыНДС.СтоимостьСНДС,
	|	УзлыНДС.СтоимостьБезНДС,
	|	УзлыНДС.СтоимостьБезНДСРегл,
	|	УзлыНДС.НДСРегл,
	|	УзлыНДС.СтоимостьБезНДСУпр,
	|	УзлыНДС.НДСУпр,
	|	ВЫБОР КОГДА Т.НДСРегл <> 0 ИЛИ Т.НДСУпр <> 0 ТОГДА 1 ИНАЧЕ 0 КОНЕЦ КАК СписаниеНДС
	|ИЗ
	|	ВТНовыеУзлы КАК НовыеУзлы
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУзлыНДСДляРешенияСЛУ КАК Т
	|		ПО Т.НомерУзла = НовыеУзлы.НовыйНомерУзла
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТИсходныеУзлыСебестоимостиИНДС КАК УзлыНДС
	|		ПО НовыеУзлы.НомерУзлаНДС = УзлыНДС.НомерУзлаГруппаНДС
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтУзлыКорректировкиСебестоимостиСОстаткамиПартий КАК УзлыСебестоимости
	|		ПО УзлыСебестоимости.НомерУзла = НовыеУзлы.НомерУзла
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерУзла
	|";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаСвязиНДС()
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	Т.НовыйУзелИсточник КАК Источник,
	|	Т.НовыйУзелПриемник КАК Приемник,
	|	МАКСИМУМ(ЕСТЬNULL(-СвязиУзловСебестоимости.Вес, 0)) КАК Вес,
	|	МАКСИМУМ(ВЫБОР КОГДА Т.ВыполнитьСписаниеНДС
	|		ТОГДА 0
	|		ИНАЧЕ ЕСТЬNULL(-СвязиУзловСебестоимости.Вес, 0)
	|	КОНЕЦ) КАК ВесНДС,
	|	МАКСИМУМ(ВЫБОР КОГДА СвязиУзловПеределов.НомерУзлаИсточник ЕСТЬ НЕ NULL
	|		ТОГДА 0
	|		ИНАЧЕ ЕСТЬNULL(-СвязиУзловСебестоимости.Вес, 0)
	|	КОНЕЦ) КАК ВесПередел
	|ИЗ
	|	ВТРезультатРасчетаПредварительный КАК Т
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВтСвязиУзловКорректировкиСебестоимостиСоСписаниемНДС КАК СвязиУзловСебестоимости
	|			ПО Т.УзелИсточник = СвязиУзловСебестоимости.НомерУзлаИсточник
	|			И Т.УзелПриемник = СвязиУзловСебестоимости.НомерУзлаПриемник
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВтСвязиУзловКорректировкиСебестоимостиСоСменойПартии КАК СвязиУзловПеределов
	|			ПО Т.УзелИсточник = СвязиУзловПеределов.НомерУзлаИсточник
	|			И Т.УзелПриемник = СвязиУзловПеределов.НомерУзлаПриемник
	|ГДЕ
	|	Т.НовыйУзелИсточник <> -1
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.НовыйУзелИсточник,
	|	Т.НовыйУзелПриемник
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.НовыйУзелПриемник,
	|	Т.НовыйУзелПриемник,
	|	МАКСИМУМ(УзлыСебестоимости.Вес),
	|	МАКСИМУМ(ВЫБОР КОГДА Т.ВыполнитьСписаниеНДС
	|		ТОГДА 0
	|		ИНАЧЕ УзлыСебестоимости.Вес
	|	КОНЕЦ) КАК ВесНДС,
	|	МАКСИМУМ(УзлыСебестоимости.Вес) КАК ВесПередел
	|ИЗ
	|	ВТРезультатРасчетаПредварительный КАК Т
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВтУзлыКорректировкиСебестоимости КАК УзлыСебестоимости
	|			ПО Т.УзелПриемник = УзлыСебестоимости.НомерУзла
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.НовыйУзелПриемник";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ДанныеДляРешенияСЛУНДС(ПараметрыРасчета) Экспорт
	
	Результат = Новый Структура("Узлы, Связи, ТекстОшибки");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета);
		
	Попытка
		
		Запрос.Текст = ТекстЗапросаУзлыНДС(Истина);
		Результат.Узлы = Запрос.Выполнить().Выгрузить();
		
		Запрос.Текст = ТекстЗапросаСвязиНДС();
		Результат.Связи = Запрос.Выполнить().Выгрузить();
		
	Исключение
		
		Результат.ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		
	КонецПопытки;
	
	НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета, НовыеВТ);
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);
	
	Возврат Результат;
	
КонецФункции

Функция ТекстЗапросаПодготовкаДанныхРаспределенияНДС(ПараметрыРасчета = Неопределено) Экспорт
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	НАЧАЛОПЕРИОДА(МАКСИМУМ(Т.Период), МЕСЯЦ) КАК Период
	|ПОМЕСТИТЬ ПериодПредыдущегоРассчитанногоПериода
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|ГДЕ
	|	Т.Период < &НачалоПериода
	|	И Т.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
	|ИНДЕКСИРОВАТЬ ПО
	|	Период
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Организация,
	|	ВЫРАЗИТЬ(ДД.Регистратор КАК Документ.Сторно) КАК Сторно,
	|	ВЫРАЗИТЬ(ДД.Регистратор КАК Документ.Сторно).СторнируемыйДокумент КАК СторнируемыйДокумент
	|ПОМЕСТИТЬ ВТДокументыСторноПредварительная
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|ГДЕ
	|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
	|	И ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.Сторно)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СторнируемыйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.Организация,
	|	ДД.Сторно,
	|	ДД.СторнируемыйДокумент,
	|	ВЫБОР КОГДА ЕСТЬNULL(ДатыСторно.ДатаРегистратора, &НачалоПериода) < &НачалоПериода
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СторноПредыдущегоПериода
	|ПОМЕСТИТЬ ВТДокументыСторно
	|ИЗ
	|	ВТДокументыСторноПредварительная КАК ДД
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ДатыСторно
	|		ПО ДатыСторно.Организация = ДД.Организация
	|		И ДатыСторно.Документ = ДД.СторнируемыйДокумент
	|ИНДЕКСИРОВАТЬ ПО
	|	Сторно
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаФинансовогоУчета,
	|	(Т.ДопРасходы - Т.ДопРасходыСписание) / Т.ДопРасходы КАК Коэффициент
	|ПОМЕСТИТЬ ВТКоэффициентыДопРасходов
	|ИЗ
	|	(ВЫБРАТЬ
	|		Т.Регистратор,
	|		Т.Организация,
	|		Т.РазделУчета,
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов,
	|		Т.Партия,
	|		Т.АналитикаУчетаПартий,
	|		Т.ВидДеятельностиНДС,
	|		Т.АналитикаФинансовогоУчета,
	|  		СУММА(Т.ДопРасходыРегл) КАК ДопРасходы,
	|   	СУММА(ВЫБОР КОГДА Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
	|			ТОГДА Т.ДопРасходыРегл
	|			ИНАЧЕ 0
	|		КОНЕЦ) КАК ДопРасходыСписание
	|	ИЗ
	|		ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК Т
	|	ГДЕ
	|		Т.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
	|		И Т.Регистратор ССЫЛКА Документ.РаспределениеПрочихЗатрат
	|		И Т.СлужебноеВидДвиженияПриход
	|		И Т.ТипЗаписи В (ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы), ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам))
	|		И Т.ДопРасходыРегл <> 0
	|	СГРУППИРОВАТЬ ПО
	|		Т.Регистратор,
	|		Т.Организация,
	|		Т.РазделУчета,
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов,
	|		Т.Партия,
	|		Т.АналитикаУчетаПартий,
	|		Т.ВидДеятельностиНДС,
	|		Т.АналитикаФинансовогоУчета
	|	) КАК Т
	|ГДЕ
	|	Т.ДопРасходыСписание <> 0
	|	И Т.ДопРасходы <> 0
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.Организация,
	|	ДД.РазделУчета,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.АналитикаФинансовогоУчета,
	|	СУММА(ДД.КоличествоОстаток) КАК Количество,
	|	СУММА(ДД.СтоимостьОстаток) КАК СтоимостьСНДС,
	|	СУММА(ДД.СтоимостьБезНДСОстаток) КАК СтоимостьБезНДС
	|ПОМЕСТИТЬ ВТОстаткиСебестоимостиДляПартийНДС
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)) КАК ДД
	|СГРУППИРОВАТЬ ПО
	|	ДД.Организация,
	|	ДД.РазделУчета,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.АналитикаФинансовогоУчета
	|ИМЕЮЩИЕ
	|	СУММА(ДД.КоличествоОстаток) <> 0
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаНоменклатуры,
	|	Организация,
	|	Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.Организация,
	|	ДД.РазделУчета,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	ДД.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	ДД.ВидЗапасов,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.Количество,
	|	ДД.СтоимостьСНДС,
	|	ДД.СтоимостьБезНДС
	|ПОМЕСТИТЬ ВТОстаткиСебестоимостиСНоменклатуройДляПартийНДС
	|ИЗ
	|	ВТОстаткиСебестоимостиДляПартийНДС КАК ДД
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия,
	|	Организация,
	|	Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////

	|ВЫБРАТЬ
	|	АВТОНОМЕРЗАПИСИ() КАК НомерЗаписи,
	|	ВЫБОР КОГДА Остатки.Организация ЕСТЬ NULL ТОГДА ЛОЖЬ ИНАЧЕ ИСТИНА КОНЕЦ КАК ЕстьОстатки,
	// Аналитики себестоимости
	|	ДД.Организация КАК Организация,
	|	ДД.РазделУчета,
	|	ВЫРАЗИТЬ(ДД.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры) КАК АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.АналитикаФинансовогоУчета,
	|
	// Кор. аналитики себестоимости
	|	ДД.КорАналитикаУчетаНоменклатуры,
	|	ДД.КорВидЗапасов,
	|	ДД.КорПартия,
	|	ДД.КорАналитикаУчетаПартий,
	|	ДД.КорВидДеятельностиНДС,
	|	ДД.КорАналитикаФинансовогоУчета,
	|
	// Прочие поля
	|	ДД.Период,
	|	ДД.Регистратор,
	|	ДД.ТипЗаписи,
	|	ДД.Подразделение,
	|	ДД.Сторно,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовАктивов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходовАктивов,
	|	НАЧАЛОПЕРИОДА(ДД.ПериодПродажи, МЕСЯЦ) КАК ПериодПродажи,
	|	ДД.ДокументИсточник КАК Реализация,
	|
	// Ресурсы
	|	ДД.Количество КАК Количество
	|ПОМЕСТИТЬ ВТВозвратыПрошлыхПериодов
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиСебестоимостиДляПартийНДС КАК Остатки
	|		ПО ДД.Организация = Остатки.Организация
	|		И ДД.РазделУчета = Остатки.РазделУчета
	|		И ДД.АналитикаУчетаНоменклатуры = Остатки.АналитикаУчетаНоменклатуры
	|		И ДД.ВидЗапасов = Остатки.ВидЗапасов
	|		И ДД.Партия = Остатки.Партия
	|		И ДД.АналитикаУчетаПартий = Остатки.АналитикаУчетаПартий
	|		И ДД.ВидДеятельностиНДС = Остатки.ВидДеятельностиНДС
	|		И ДД.АналитикаФинансовогоУчета = Остатки.АналитикаФинансовогоУчета
	|ГДЕ
	|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
	|	И ДД.Партия <> НЕОПРЕДЕЛЕНО
	|   И ДД.СлужебноеВидДвиженияПриход
	|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов)
	|	И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТарыОтКлиентаПрошлыхПериодов)
	|	И ДД.Количество <> 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ПериодПродажи,
	|	КорАналитикаУчетаНоменклатуры,
	|	Организация,
	|	КорПартия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.НомерЗаписи,
	|	ДД.ЕстьОстатки,
	// Аналитики себестоимости
	|	ДД.Организация,
	|	ДД.РазделУчета,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	ДД.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	ДД.ВидЗапасов,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.АналитикаФинансовогоУчета,
	|
	// Кор. аналитики себестоимости
	|	ДД.КорАналитикаУчетаНоменклатуры,
	|	ДД.КорВидЗапасов,
	|	ДД.КорПартия,
	|	ДД.КорАналитикаУчетаПартий,
	|	ДД.КорВидДеятельностиНДС,
	|	ДД.КорАналитикаФинансовогоУчета,
	|
	// Прочие поля
	|	ДД.Период,
	|	ДД.Регистратор,
	|	ДД.ТипЗаписи,
	|	ДД.Подразделение,
	|	ДД.Сторно,
	|	ДД.СтатьяРасходовАктивов,
	|	ДД.АналитикаРасходовАктивов,
	|	ДД.ПериодПродажи,
	|	ДД.Реализация,
	|
	// Ресурсы
	|	ДД.Количество
	|ПОМЕСТИТЬ ВТВозвратыПрошлыхПериодовСНоменклатурой
	|ИЗ
	|	ВТВозвратыПрошлыхПериодов КАК ДД
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия,
	|	Организация,
	|	Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Реализация КАК Реализация
	|ПОМЕСТИТЬ ВТРеализацииВозвратов
	|ИЗ
	|	ВТВозвратыПрошлыхПериодов КАК Т
	|ГДЕ
	|	Т.Реализация <> НЕОПРЕДЕЛЕНО
	|ИНДЕКСИРОВАТЬ ПО
	|	Реализация
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	//++ Локализация
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	Т.Организация,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.НаправлениеДеятельности,
	|	Т.СтоимостьБезНДС,
	|	Т.НДС,
	|	Т.СтоимостьБезНДСУпр,
	|	Т.НДСУпр
	|ПОМЕСТИТЬ ДетализацияПартийРеализаций
	|ИЗ
	|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН2_4 КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТРеализацииВозвратов КАК Реализации
	|		ПО Т.Регистратор = Реализации.Реализация
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор,
	|	Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Регистратор КАК Регистратор,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
	|	СУММА(Т.Количество) КАК Количество
	|ПОМЕСТИТЬ ВТСебестоимостиРеализаций
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТРеализацииВозвратов КАК Реализации
	|		ПО Т.Регистратор = Реализации.Реализация
	|ГДЕ
	|	Т.Регистратор В (ВЫБРАТЬ РАЗЛИЧНЫЕ Отбор.Регистратор ИЗ ДетализацияПартийРеализаций КАК Отбор)
	|	И Т.Количество <> 0
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика,
	|	ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор,
	|	Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Регистратор КАК Регистратор,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	ПартииНДС.ДокументПоступления,
	|	ПартииНДС.АналитикаУчетаПартийДокументаПоступления,
	|	ПартииНДС.СтоимостьБезНДС / Т.Количество КАК СтоимостьБезНДС,
	|	ПартииНДС.НДС / Т.Количество КАК НДС,
	|	ПартииНДС.СтоимостьБезНДСУпр / Т.Количество КАК СтоимостьБезНДСУпр,
	|	ПартииНДС.НДСУпр / Т.Количество КАК НДСУпр
	|ПОМЕСТИТЬ ВТПартииНДСРеализаций
	|ИЗ
	|	ВТСебестоимостиРеализаций КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДетализацияПартийРеализаций КАК ПартииНДС
	|		ПО Т.Регистратор = ПартииНДС.Регистратор
	|		И Т.Организация = ПартииНДС.Организация
	|		И Т.Партия = ПартииНДС.Партия
	|		И Т.АналитикаУчетаПартий = ПартииНДС.АналитикаУчетаПартий
	|		И (Т.Номенклатура = ПартииНДС.Номенклатура ИЛИ ПартииНДС.Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка))
	|		И (Т.Характеристика = ПартииНДС.Характеристика ИЛИ ПартииНДС.Характеристика = ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка))
	|		И (Т.НаправлениеДеятельности = ПартииНДС.НаправлениеДеятельности ИЛИ ПартииНДС.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	//-- Локализация
	|ВЫБРАТЬ
	|	Возвраты.НомерЗаписи,
	|	0 КАК НомерИсточника,
	|	Возвраты.Регистратор КАК Регистратор,
	|	Возвраты.ТипЗаписи,
	|	Возвраты.Подразделение,
	|	Возвраты.Сторно,
	|	Возвраты.СтатьяРасходовАктивов,
	|	Возвраты.АналитикаРасходовАктивов,
	|	Возвраты.ПериодПродажи КАК Период,
	|	Возвраты.Организация,
	|	Возвраты.АналитикаУчетаНоменклатуры,
	|	Возвраты.ВидЗапасов,
	|	Возвраты.РазделУчета,
	|	Возвраты.Партия,
	|	Возвраты.АналитикаУчетаПартий,
	|	Возвраты.АналитикаФинансовогоУчета,
	|	Возвраты.ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.ЗатратыПредыдущихПеределов,
	|	Т.СтоимостьСНДС КАК СтоимостьСНДС,
	|	Т.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|	Т.СтоимостьБезНДСРегл КАК СтоимостьБезНДСРегл,
	|	Т.НДСРегл КАК НДСРегл,
	|	Т.СтоимостьБезНДСУпр КАК СтоимостьБезНДСУпр,
	|	Т.НДСУпр КАК НДСУпр,
	|	Возвраты.Количество КАК Количество
	|ПОМЕСТИТЬ ВТЦеныПартииНДСВозвратов
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиПартииТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТВозвратыПрошлыхПериодовСНоменклатурой КАК Возвраты
	|		ПО Т.Организация = Возвраты.Организация
	|		И Т.Партия = Возвраты.Партия
	|		И Т.АналитикаУчетаПартий = Возвраты.АналитикаУчетаПартий
	|		И Т.ВидЗапасов = Возвраты.ВидЗапасов
	|		И Т.Номенклатура = Возвраты.Номенклатура
	|		И Т.Характеристика = Возвраты.Характеристика
	|ГДЕ
	|	Т.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
	|	И НЕ Т.ТипЗаписи В (&ТипыЗаписейКонвертацииДанных)
	|	И Т.ПериодРегистрации < &НачалоПериода
	//  Если по партии возврата есть остатки, то цены возврата по всем регистрам партий НДС придут из таблицы ВТЦеныПартийТоваровНаНачалоПериода
	|	И НЕ Возвраты.ЕстьОстатки
	|
	//++ Локализация
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Возвраты.НомерЗаписи,
	|	1 КАК НомерИсточника,
	|	Возвраты.Регистратор,
	|	Возвраты.ТипЗаписи,
	|	Возвраты.Подразделение,
	|	Возвраты.Сторно,
	|	Возвраты.СтатьяРасходовАктивов,
	|	Возвраты.АналитикаРасходовАктивов,
	|	Т.Период,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	ЛОЖЬ КАК ЗатратыПредыдущихПеределов,
	|	0 КАК СтоимостьСНДС,
	|	0 КАК СтоимостьБезНДС,
	|	Т.СтоимостьБезНДС КАК СтоимостьБезНДСРегл,
	|	Т.НДС КАК НДСРегл,
	|	Т.СтоимостьБезНДСУпр КАК СтоимостьБезНДСУпр,
	|	Т.НДСУпр КАК НДСУпр,
	|	Возвраты.Количество КАК Количество
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТВозвратыПрошлыхПериодов КАК Возвраты
	|		ПО Т.Период = Возвраты.ПериодПродажи
	|		И Т.Организация = Возвраты.Организация
	|		И Т.РазделУчета = Возвраты.РазделУчета
	|		И Т.АналитикаУчетаНоменклатуры = Возвраты.КорАналитикаУчетаНоменклатуры
	|		И Т.ВидЗапасов = Возвраты.КорВидЗапасов
	|		И Т.Партия = Возвраты.КорПартия
	|		И Т.АналитикаУчетаПартий = Возвраты.КорАналитикаУчетаПартий
	//  в возврате прошлого периода кор.виддеятельности НДС не заполняется из документа реализации
	|		И Т.АналитикаФинансовогоУчета = Возвраты.КорАналитикаФинансовогоУчета
	|ГДЕ
	|	Т.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
	|	И НЕ Т.ТипЗаписи В (&ТипыЗаписейКонвертацииДанных)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Возвраты.НомерЗаписи,
	|	2 КАК НомерИсточника,
	|	Возвраты.Регистратор,
	|	Возвраты.ТипЗаписи,
	|	Возвраты.Подразделение,
	|	Возвраты.Сторно,
	|	Возвраты.СтатьяРасходовАктивов,
	|	Возвраты.АналитикаРасходовАктивов,
	|	Возвраты.ПериодПродажи КАК Период,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Возвраты.ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатурыДокументаПоступления,
	|	ЛОЖЬ КАК ЗатратыПредыдущихПеределов,
	|	0 КАК СтоимостьСНДС,
	|	0 КАК СтоимостьБезНДС,
	|	Т.СтоимостьБезНДС КАК СтоимостьБезНДСРегл,
	|	Т.НДС КАК НДСРегл,
	|	Т.СтоимостьБезНДСУпр КАК СтоимостьБезНДСУпр,
	|	Т.НДСУпр КАК НДСУпр,
	|	Возвраты.Количество КАК Количество
	|ИЗ
	|	ВТПартииНДСРеализаций КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТВозвратыПрошлыхПериодов КАК Возвраты
	|		ПО Т.Регистратор = Возвраты.Реализация
	|		И Т.Организация = Возвраты.Организация
	|		И Т.РазделУчета = Возвраты.РазделУчета
	|		И Т.АналитикаУчетаНоменклатуры = Возвраты.КорАналитикаУчетаНоменклатуры
	|		И Т.ВидЗапасов = Возвраты.КорВидЗапасов
	|		И Т.Партия = Возвраты.КорПартия
	|		И Т.АналитикаУчетаПартий = Возвраты.КорАналитикаУчетаПартий
	|		И Т.АналитикаФинансовогоУчета = Возвраты.КорАналитикаФинансовогоУчета
	|
	//-- Локализация
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерЗаписи,
	|	НомерИсточника
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.НомерЗаписи,
	|	МИНИМУМ(Т.НомерИсточника) КАК НомерИсточника
	|ПОМЕСТИТЬ ИсточникиЦенВозвратов
	|ИЗ
	|	ВТЦеныПартииНДСВозвратов КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.НомерЗаписи
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерЗаписи,
	|	НомерИсточника
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЛОЖЬ КАК ЭтоПостатейныеПеременные,
	|	ЛОЖЬ КАК ЭтоПостатейныеПостоянные,
	|	&НачалоПредыдущегоПериода КАК Период,
	|	Остатки.Организация КАК Организация,
	|	Остатки.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Остатки.ВидЗапасов,
	|	Остатки.РазделУчета,
	|	Остатки.Партия КАК Партия,
	|	Остатки.АналитикаУчетаПартий,
	|	Остатки.АналитикаФинансовогоУчета,
	|	Остатки.ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.ЗатратыПредыдущихПеределов,
	|	ВЫРАЗИТЬ(СУММА(Т.СтоимостьСНДС) КАК ЧИСЛО(31,10)) КАК СтоимостьСНДС,
	|	ВЫРАЗИТЬ(СУММА(Т.СтоимостьБезНДС) КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(СУММА(Т.СтоимостьБезНДСРегл) КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСРегл,
	|	ВЫРАЗИТЬ(СУММА(Т.НДСРегл) КАК ЧИСЛО(31,10)) КАК НДСРегл,
	|	ВЫРАЗИТЬ(СУММА(Т.СтоимостьБезНДСУпр) КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСУпр,
	|	ВЫРАЗИТЬ(СУММА(Т.НДСУпр) КАК ЧИСЛО(31,10)) КАК НДСУпр,
	|	СУММА(Остатки.Количество) КАК КоличествоПартии
	|ПОМЕСТИТЬ ВТЦеныПартийТоваровНаНачалоПериода
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиПартииТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОстаткиСебестоимостиСНоменклатуройДляПартийНДС КАК Остатки
	|		ПО Т.Организация = Остатки.Организация
	|		И Т.Партия = Остатки.Партия
	|		И Т.АналитикаУчетаПартий = Остатки.АналитикаУчетаПартий
	|		И Т.ВидЗапасов = Остатки.ВидЗапасов
	|		И Т.Номенклатура = Остатки.Номенклатура
	|		И Т.Характеристика = Остатки.Характеристика
	|		И (Остатки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|			ИЛИ Остатки.АналитикаУчетаНоменклатуры = Т.АналитикаУчетаНоменклатурыНЗП)
	|ГДЕ
	|	Т.ПериодРегистрации < &НачалоПериода
	|	И Т.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
	|СГРУППИРОВАТЬ ПО
	|	Остатки.Организация,
	|	Остатки.АналитикаУчетаНоменклатуры,
	|	Остатки.ВидЗапасов,
	|	Остатки.РазделУчета,
	|	Остатки.Партия,
	|	Остатки.АналитикаУчетаПартий,
	|	Остатки.АналитикаФинансовогоУчета,
	|	Остатки.ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.ЗатратыПредыдущихПеределов
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЛОЖЬ КАК ЭтоПостатейныеПеременные,
	|	ИСТИНА КАК ЭтоПостатейныеПостоянные,
	|	&НачалоПредыдущегоПериода КАК Период,
	|	Остатки.Организация КАК Организация,
	|	Остатки.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Остатки.ВидЗапасов,
	|	Остатки.РазделУчета,
	|	Остатки.Партия КАК Партия,
	|	Остатки.АналитикаУчетаПартий,
	|	Остатки.АналитикаФинансовогоУчета,
	|	Остатки.ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.ЗатратыПредыдущихПеределов,
	|	ВЫРАЗИТЬ(СУММА(Т.СтоимостьСНДС) КАК ЧИСЛО(31,10)) КАК СтоимостьСНДС,
	|	ВЫРАЗИТЬ(СУММА(Т.СтоимостьБезНДС) КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(СУММА(Т.СтоимостьБезНДСРегл) КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСРегл,
	|	ВЫРАЗИТЬ(СУММА(Т.НДСРегл) КАК ЧИСЛО(31,10)) КАК НДСРегл,
	|	ВЫРАЗИТЬ(СУММА(Т.СтоимостьБезНДСУпр) КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСУпр,
	|	ВЫРАЗИТЬ(СУММА(Т.НДСУпр) КАК ЧИСЛО(31,10)) КАК НДСУпр,
	|	СУММА(Остатки.Количество) КАК КоличествоПартии
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОстаткиСебестоимостиСНоменклатуройДляПартийНДС КАК Остатки
	|		ПО Т.Организация = Остатки.Организация
	|		И Т.Партия = Остатки.Партия
	|		И Т.АналитикаУчетаПартий = Остатки.АналитикаУчетаПартий
	|		И Т.ВидЗапасов = Остатки.ВидЗапасов
	|		И Т.Номенклатура = Остатки.Номенклатура
	|		И Т.Характеристика = Остатки.Характеристика
	|		И (Остатки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|			ИЛИ Остатки.АналитикаУчетаНоменклатуры = Т.АналитикаУчетаНоменклатурыНЗП)
	|ГДЕ
	|	Т.ПериодРегистрации < &НачалоПериода
	|	И Т.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
	|СГРУППИРОВАТЬ ПО
	|	Остатки.Организация,
	|	Остатки.АналитикаУчетаНоменклатуры,
	|	Остатки.ВидЗапасов,
	|	Остатки.РазделУчета,
	|	Остатки.Партия,
	|	Остатки.АналитикаУчетаПартий,
	|	Остатки.АналитикаФинансовогоУчета,
	|	Остатки.ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.ЗатратыПредыдущихПеределов
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЛОЖЬ КАК ЭтоПостатейныеПеременные,
	|	ИСТИНА КАК ЭтоПостатейныеПостоянные,
	|	Т.ПериодРегистрации,
	|	Возвраты.Организация,
	|	Возвраты.АналитикаУчетаНоменклатуры,
	|	Возвраты.ВидЗапасов,
	|	Возвраты.РазделУчета,
	|	Возвраты.Партия,
	|	Возвраты.АналитикаУчетаПартий,
	|	Возвраты.АналитикаФинансовогоУчета,
	|	Возвраты.ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.ЗатратыПредыдущихПеределов,
	|	ВЫРАЗИТЬ(СУММА(Т.СтоимостьСНДС) КАК ЧИСЛО(31,10)) КАК СтоимостьСНДС,
	|	ВЫРАЗИТЬ(СУММА(Т.СтоимостьБезНДС) КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(СУММА(Т.СтоимостьБезНДСРегл) КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСРегл,
	|	ВЫРАЗИТЬ(СУММА(Т.НДСРегл) КАК ЧИСЛО(31,10)) КАК НДСРегл,
	|	ВЫРАЗИТЬ(СУММА(Т.СтоимостьБезНДСУпр) КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСУпр,
	|	ВЫРАЗИТЬ(СУММА(Т.НДСУпр) КАК ЧИСЛО(31,10)) КАК НДСУпр,
	|	СУММА(Возвраты.Количество) КАК КоличествоПартии
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТВозвратыПрошлыхПериодовСНоменклатурой КАК Возвраты
	|		ПО Т.Организация = Возвраты.Организация
	|		И Т.Партия = Возвраты.Партия
	|		И Т.АналитикаУчетаПартий = Возвраты.АналитикаУчетаПартий
	|		И Т.ВидЗапасов = Возвраты.ВидЗапасов
	|		И Т.Номенклатура = Возвраты.Номенклатура
	|		И Т.Характеристика = Возвраты.Характеристика
	|ГДЕ
	|	Т.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
	|СГРУППИРОВАТЬ ПО
	|	Т.ПериодРегистрации,
	|	Возвраты.Организация,
	|	Возвраты.АналитикаУчетаНоменклатуры,
	|	Возвраты.ВидЗапасов,
	|	Возвраты.РазделУчета,
	|	Возвраты.Партия,
	|	Возвраты.АналитикаУчетаПартий,
	|	Возвраты.АналитикаФинансовогоУчета,
	|	Возвраты.ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.ЗатратыПредыдущихПеределов
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ИСТИНА КАК ЭтоПостатейныеПеременные,
	|	ЛОЖЬ КАК ЭтоПостатейныеПостоянные,
	|	Т.Период,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	ЛОЖЬ КАК ЗатратыПредыдущихПеределов,
	|	ВЫРАЗИТЬ(СУММА(Т.СтоимостьСНДС) КАК ЧИСЛО(31,10)) 		КАК СтоимостьСНДС,
	|	ВЫРАЗИТЬ(СУММА(Т.СтоимостьБезНДС) КАК ЧИСЛО(31,10)) 	КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(СУММА(Т.СтоимостьБезНДСРегл) КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСРегл,
	|	ВЫРАЗИТЬ(СУММА(Т.НДСРегл) КАК ЧИСЛО(31,10)) 			КАК НДСРегл,
	|	ВЫРАЗИТЬ(СУММА(Т.СтоимостьБезНДСУпр) КАК ЧИСЛО(31,10)) 	КАК СтоимостьБезНДСУпр,
	|	ВЫРАЗИТЬ(СУММА(Т.НДСУпр) КАК ЧИСЛО(31,10)) 				КАК НДСУпр,
	|	СУММА(Т.КоличествоПартии) 								КАК КоличествоПартии
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиТоваровПостатейныеЗатраты КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПериодПредыдущегоРассчитанногоПериода КАК ПериодДвижений
	|		ПО Т.Период = ПериодДвижений.Период
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОстаткиСебестоимостиДляПартийНДС КАК Остатки
	|		ПО Т.Организация = Остатки.Организация
	|		И Т.РазделУчета = Остатки.РазделУчета
	|		И Т.АналитикаУчетаНоменклатуры = Остатки.АналитикаУчетаНоменклатуры
	|		И Т.ВидЗапасов = Остатки.ВидЗапасов
	|		И Т.Партия = Остатки.Партия
	|		И Т.АналитикаУчетаПартий = Остатки.АналитикаУчетаПартий
	|		И Т.ВидДеятельностиНДС = Остатки.ВидДеятельностиНДС
	|		И Т.АналитикаФинансовогоУчета = Остатки.АналитикаФинансовогоУчета
	|ГДЕ
	|	Т.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
	|СГРУППИРОВАТЬ ПО
	|	Т.Период,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаНоменклатуры,
	|	Организация,
	|	Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////


	//++ Локализация
	|ВЫБРАТЬ
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	ВЫРАЗИТЬ(СУММА(Остатки.СтоимостьСНДС / Остатки.Количество) КАК ЧИСЛО(31,10)) КАК СтоимостьСНДС,
	|	ВЫРАЗИТЬ(СУММА(Остатки.СтоимостьБезНДС / Остатки.Количество) КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(СУММА(Т.СтоимостьБезНДС) КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСРегл,
	|	ВЫРАЗИТЬ(СУММА(Т.НДС) КАК ЧИСЛО(31,10)) КАК НДСРегл,
	|	ВЫРАЗИТЬ(СУММА(Т.СтоимостьБезНДСУпр) КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСУпр,
	|	ВЫРАЗИТЬ(СУММА(Т.НДСУпр) КАК ЧИСЛО(31,10)) КАК НДСУпр,
	|	СУММА(Т.КоличествоПартии) КАК КоличествоПартии
	|ПОМЕСТИТЬ ВТЦеныПартийНДСНаНачалоПериодаПредварительная
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПериодПредыдущегоРассчитанногоПериода КАК ПериодДвижений
	|		ПО Т.Период = ПериодДвижений.Период
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОстаткиСебестоимостиДляПартийНДС КАК Остатки
	|		ПО Т.Организация = Остатки.Организация
	|		И Т.РазделУчета = Остатки.РазделУчета
	|		И Т.АналитикаУчетаНоменклатуры = Остатки.АналитикаУчетаНоменклатуры
	|		И Т.ВидЗапасов = Остатки.ВидЗапасов
	|		И Т.Партия = Остатки.Партия
	|		И Т.АналитикаУчетаПартий = Остатки.АналитикаУчетаПартий
	|		И Т.ВидДеятельностиНДС = Остатки.ВидДеятельностиНДС
	|		И Т.АналитикаФинансовогоУчета = Остатки.АналитикаФинансовогоУчета
	|ГДЕ
	|	Т.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
	|	И НЕ Т.ТипЗаписи В (&ТипыЗаписейКонвертацииДанных)
	|	И Т.КоличествоПартии >= 0
	|СГРУППИРОВАТЬ ПО
	|	Т.Период,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Характеристика,
	|	Партия
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	СУММА(1) КАК Количество
	|ПОМЕСТИТЬ ВТЦеныПартийНДСПеременные
	|ИЗ
	|	ВТЦеныПартийНДСНаНачалоПериодаПредварительная КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий
	|ИМЕЮЩИЕ
	|	СУММА(1) > 1
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Характеристика,
	|	Партия
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.СтоимостьСНДС,
	|	Т.СтоимостьБезНДС,
	|	Т.СтоимостьБезНДСРегл,
	|	Т.НДСРегл,
	|	Т.СтоимостьБезНДСУпр,
	|	Т.НДСУпр,
	|	Т.КоличествоПартии,
	|	ВЫБОР КОГДА ПартииПеременные.Организация ЕСТЬ NULL
	|		ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ЭтоПеременныеЗатраты
	|ПОМЕСТИТЬ ВТЦеныПартийНДСНаНачалоПериода
	|ИЗ
	|	ВТЦеныПартийНДСНаНачалоПериодаПредварительная КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТЦеныПартийНДСПеременные КАК ПартииПеременные
	|		ПО Т.Организация = ПартииПеременные.Организация
	|		И Т.Номенклатура = ПартииПеременные.Номенклатура
	|		И Т.Характеристика = ПартииПеременные.Характеристика
	|		И Т.ВидЗапасов = ПартииПеременные.ВидЗапасов
	|		И Т.Партия = ПартииПеременные.Партия
	|		И Т.АналитикаУчетаПартий = ПартииПеременные.АналитикаУчетаПартий
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаНоменклатуры,
	|	Организация,
	|	Партия
	|;
	//-- Локализация
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаФинансовогоУчета,
	|	СУММА(Т.КоличествоОстаток) КАК Количество,
	|	СУММА(Т.СтоимостьОстаток) КАК СтоимостьСНДС,
	|	СУММА(Т.СтоимостьБезНДСОстаток) КАК СтоимостьБезНДС,
	|	СУММА(Т.СтоимостьРеглОстаток) КАК СтоимостьРегл,
	|	СУММА(ВЫБОР КОГДА &УправленческийУчетОрганизаций
	|		ТОГДА Т.СтоимостьУпрОстаток
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК СтоимостьУпр
	|ПОМЕСТИТЬ ВТОстаткиДляКорректировок
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров.Остатки(&НачалоПериода, Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)) КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаФинансовогоУчета
	|ИМЕЮЩИЕ
	|	СУММА(Т.КоличествоОстаток) <> 0
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаНоменклатуры,
	|	Организация,
	|	Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаФинансовогоУчета,
	|
	|	Т.КоличествоСводно КАК Количество,
	|	ВЫБОР КОГДА СУММА(ВЫБОР КОГДА Т.ЭтоВыбытие ТОГДА Т.КоличествоДетально ИНАЧЕ 0 КОНЕЦ) = Т.КоличествоСводно ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ КАК ПолноеВыбытие
	|ПОМЕСТИТЬ ВТПолностьюВыбывшиеТовары
	|ИЗ
	|	ПоказателиБазыРаспределенияПриемниковПрошлыхПериодовОтклоненияВСтоимости КАК Т
	|ГДЕ
	|	Т.КоличествоСводно <> 0
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаФинансовогоУчета,
	|   Т.КоличествоСводно
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	Т.КорОрганизация,
	|	Т.КорРазделУчета,
	|	Т.КорАналитикаУчетаНоменклатуры,
	|	Т.КорВидЗапасов,
	|	Т.КорПартия,
	|	Т.КорАналитикаУчетаПартий,
	|	Т.КорВидДеятельностиНДС,
	|	Т.КорАналитикаФинансовогоУчета,
	|
	|	Т.КоличествоСводно КАК Количество,
	|	ВЫБОР КОГДА СУММА(ВЫБОР КОГДА Т.ЭтоВыбытие ТОГДА Т.КоличествоДетально ИНАЧЕ 0 КОНЕЦ) = Т.КоличествоСводно ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ КАК ПолноеВыбытие
	|ИЗ
	|	ПоказателиБазыРаспределенияПриемниковПрошлыхПериодов КАК Т
	|ГДЕ
	|	Т.КоличествоСводно <> 0
	|	
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.КорОрганизация,
	|	Т.КорРазделУчета,
	|	Т.КорАналитикаУчетаНоменклатуры,
	|	Т.КорВидЗапасов,
	|	Т.КорПартия,
	|	Т.КорАналитикаУчетаПартий,
	|	Т.КорВидДеятельностиНДС,
	|	Т.КорАналитикаФинансовогоУчета,
	|   Т.КоличествоСводно
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаНоменклатуры,
	|	Организация,
	|	Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЕСТЬNULL(ДокументыСторно.СторнируемыйДокумент, Т.Регистратор) КАК Регистратор,
	|	Т.Организация КАК Организация,
	|	Т.РазделУчета,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаФинансовогоУчета,
	|
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.Количество КАК Количество,
	|	Остатки.Количество КАК КоличествоОстаток,
	|	ВЫБОР КОГДА (ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход ТОГДА -1 ИНАЧЕ 1 КОНЕЦ * Т.Количество) = Остатки.Количество
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЭтоСторно,
	|	ВЫБОР КОГДА (ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход ТОГДА -1 ИНАЧЕ 1 КОНЕЦ * Т.Количество) = Остатки.Количество
	|		ТОГДА Т.Стоимость
	|		ИНАЧЕ Т.Стоимость - ВЫРАЗИТЬ(Т.Количество * Остатки.СтоимостьСНДС / Остатки.Количество КАК ЧИСЛО(31,2))
	|	КОНЕЦ КАК СтоимостьСНДС,
	|	ВЫБОР КОГДА (ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход ТОГДА -1 ИНАЧЕ 1 КОНЕЦ * Т.Количество) = Остатки.Количество
	|		ТОГДА Т.СтоимостьБезНДС
	|		ИНАЧЕ Т.СтоимостьБезНДС - ВЫРАЗИТЬ(Т.Количество * Остатки.СтоимостьБезНДС / Остатки.Количество КАК ЧИСЛО(31,2))
	|	КОНЕЦ КАК СтоимостьБезНДС,
	|	ВЫБОР КОГДА (ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход ТОГДА -1 ИНАЧЕ 1 КОНЕЦ * Т.Количество) = Остатки.Количество
	|		ТОГДА Т.СтоимостьРегл
	|		ИНАЧЕ Т.СтоимостьРегл - ВЫРАЗИТЬ(Т.Количество * Остатки.СтоимостьРегл / Остатки.Количество КАК ЧИСЛО(31,2))
	|	КОНЕЦ КАК СтоимостьРегл,
	|	ВЫБОР КОГДА (ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход ТОГДА -1 ИНАЧЕ 1 КОНЕЦ * Т.Количество) = Остатки.Количество
	|			ТОГДА Т.НДСРегл
	|		КОГДА Т.СтоимостьРегл <> 0
	|			ТОГДА Т.НДСРегл * (Т.СтоимостьРегл - ВЫРАЗИТЬ(Т.Количество * Остатки.СтоимостьРегл / Остатки.Количество КАК ЧИСЛО(31,2))) / Т.СтоимостьРегл
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК НДСРегл,
	|	ВЫБОР КОГДА НЕ &УправленческийУчетОрганизаций
	|			ТОГДА 0
	|		КОГДА (ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход ТОГДА -1 ИНАЧЕ 1 КОНЕЦ * Т.Количество) = Остатки.Количество
	|			ТОГДА Т.СтоимостьУпр
	|		ИНАЧЕ Т.СтоимостьУпр - ВЫРАЗИТЬ(Т.Количество * Остатки.СтоимостьУпр / Остатки.Количество КАК ЧИСЛО(31,2))
	|	КОНЕЦ КАК СтоимостьУпр,
	|	ВЫБОР КОГДА НЕ &УправленческийУчетОрганизаций ИЛИ Т.СтоимостьУпр = 0
	|			ТОГДА 0
	|		КОГДА (ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход ТОГДА -1 ИНАЧЕ 1 КОНЕЦ * Т.Количество) = Остатки.Количество
	|			ТОГДА Т.НДСУпр
	|			ИНАЧЕ Т.НДСУпр * (Т.СтоимостьУпр - ВЫРАЗИТЬ(Т.Количество * Остатки.СтоимостьУпр / Остатки.Количество КАК ЧИСЛО(31,2))) / Т.СтоимостьУпр
	|	КОНЕЦ КАК НДСУпр
	|ПОМЕСТИТЬ ВТКорректировкиПриобретенияПредварительная
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОстаткиДляКорректировок КАК Остатки
	|		ПО Т.Организация = Остатки.Организация
	|		И Т.РазделУчета = Остатки.РазделУчета
	|		И Т.АналитикаУчетаНоменклатуры = Остатки.АналитикаУчетаНоменклатуры
	|		И Т.ВидЗапасов = Остатки.ВидЗапасов
	|		И Т.Партия = Остатки.Партия
	|		И Т.АналитикаУчетаПартий = Остатки.АналитикаУчетаПартий
	|		И Т.ВидДеятельностиНДС = Остатки.ВидДеятельностиНДС
	|		И Т.АналитикаФинансовогоУчета = Остатки.АналитикаФинансовогоУчета
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТДокументыСторно КАК ДокументыСторно
	|		ПО ДокументыСторно.Сторно = Т.Регистратор
	|ГДЕ
	|	Т.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
	|	И (ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.КорректировкаПриобретения)
	|		ИЛИ ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.ПоступлениеУслугВПодразделение)
	|		ИЛИ НЕ ДокументыСторно.Сторно ЕСТЬ NULL)
	|	И Т.ТипЗаписи В (ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения))
	|	И НЕ Т.РазделУчета В (
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку),
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки))
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаНоменклатуры,
	|	Организация,
	|	Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЛОЖЬ КАК ЭтоПостатейныеЗатраты,
	|	Т.ЭтоСторно,
	|	Т.Регистратор КАК ДокументПоступления,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартийДокументаПоступления,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатурыДокументаПоступления,
	|
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаФинансовогоУчета,
	|
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.Количество,
	|	Т.СтоимостьСНДС,
	|	Т.СтоимостьБезНДС,
	|	Т.СтоимостьРегл,
	|	Т.НДСРегл,
	|	Т.СтоимостьУпр,
	|	Т.НДСУпр
	|ПОМЕСТИТЬ ВТКорректировкиПриобретения
	|ИЗ
	|	ВТКорректировкиПриобретенияПредварительная КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ИСТИНА КАК ЭтоПостатейныеЗатраты,
	|	Т.ЭтоСторно,
	|	Остатки.ДокументПоступления КАК ДокументПоступления,
	|	Остатки.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатурыДокументаПоступления,
	|
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаФинансовогоУчета,
	|
	|	Остатки.СтатьяРасходов,
	|	Остатки.АналитикаРасходов,
	|	Т.Количество,
	|	ВЫРАЗИТЬ(-Т.Количество * Остатки.СтоимостьСНДС КАК ЧИСЛО(31,2)) КАК СтоимостьСНДС,
	|	ВЫРАЗИТЬ(-Т.Количество * Остатки.СтоимостьБезНДС КАК ЧИСЛО(31,2)) КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(-Т.Количество * Остатки.СтоимостьБезНДСРегл КАК ЧИСЛО(31,2)) КАК СтоимостьРегл,
	|	ВЫРАЗИТЬ(-Т.Количество * Остатки.НДСРегл КАК ЧИСЛО(31,2)) КАК НДСРегл,
	|	ВЫРАЗИТЬ(-Т.Количество * Остатки.СтоимостьБезНДСУпр КАК ЧИСЛО(31,2)) КАК СтоимостьУпр,
	|	ВЫРАЗИТЬ(-Т.Количество * Остатки.НДСУпр КАК ЧИСЛО(31,2)) КАК НДСУпр
	|ИЗ
	|	ВТКорректировкиПриобретенияПредварительная КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТЦеныПартийТоваровНаНачалоПериода КАК Остатки
	|		ПО Т.Организация = Остатки.Организация
	|		И Т.РазделУчета = Остатки.РазделУчета
	|		И Т.АналитикаУчетаНоменклатуры = Остатки.АналитикаУчетаНоменклатуры
	|		И Т.ВидЗапасов = Остатки.ВидЗапасов
	|		И Т.Партия = Остатки.Партия
	|		И Т.АналитикаУчетаПартий = Остатки.АналитикаУчетаПартий
	|		И Т.ВидДеятельностиНДС = Остатки.ВидДеятельностиНДС
	|		И Т.АналитикаФинансовогоУчета = Остатки.АналитикаФинансовогоУчета
	|ГДЕ
	|	(Остатки.ЭтоПостатейныеПеременные
	|		И Остатки.СтатьяРасходов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка))
	|	ИЛИ Остатки.ЭтоПостатейныеПостоянные
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаНоменклатуры,
	|	Организация,
	|	Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ ПЕРВЫЕ 0
	|	ДД.Организация КАК Организация,
	|	ДД.РазделУчета,
	|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.Партия КАК Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.АналитикаФинансовогоУчета,
	|
	|	1 КАК Коэффициент,
	|	0 КАК Количество,
	|	ЛОЖЬ КАК ЭтоПеременныеЗатраты
	|ПОМЕСТИТЬ ВТИзменениеОстатковНЗП
	|ИЗ
	|	ВТОстаткиСебестоимостиДляПартийНДС КАК ДД
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаНоменклатуры,
	|	Организация,
	|	Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	1 КАК КодИсточника,
	|	ЛОЖЬ КАК ЭтоОстаткиПостатейныеПеременные,
	|	ЛОЖЬ КАК ЭтоОстаткиПостатейныеПостоянные,
	|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
	|		 ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	КОНЕЦ КАК ВидДвижения,
	// Аналитики партий НДС
	|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатурыДокументаПоступления,
	|	ВЫБОР
	|		КОГДА НЕ Корректировка.ВидКорректировки ЕСТЬ NULL
	|		 И (Корректировка.ВидКорректировки <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон)
	|			ИЛИ ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения))
	|			ТОГДА Корректировка.ДокументОснование
	//++ Локализация
	|		КОГДА НЕ СчетФактура.Исправление ЕСТЬ NULL И СчетФактура.Исправление
	|			ТОГДА СчетФактура.СчетФактураОснование
	//-- Локализация
	|		КОГДА НЕ ДокументыСторно.Сторно ЕСТЬ NULL
	|			ТОГДА ДокументыСторно.СторнируемыйДокумент
	|		ИНАЧЕ ДД.Регистратор
	|	КОНЕЦ КАК ДокументПоступления,
	|	ВЫБОР
	|		КОГДА ДД.ТипЗаписи В (
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам))
	|			ТОГДА ДД.КорАналитикаУчетаПартий
	|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
	|		  И ДД.КорАналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|			ТОГДА ДД.КорАналитикаУчетаПартий
	|		КОГДА ДД.ТипЗаписи В (
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
	|		 И ДД.Количество = 0
	|		 И ДД.КорАналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|			ТОГДА ДД.КорАналитикаУчетаПартий
	|		КОГДА ДД.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|			ТОГДА ДД.КорАналитикаУчетаПартий
	|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия) И ДД.Количество = 0
	|		 И ДД.КорАналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|			ТОГДА ДД.КорАналитикаУчетаПартий
	|		КОГДА ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|		 И ДД.КорАналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|			ТОГДА ДД.КорАналитикаУчетаПартий
	|		ИНАЧЕ ДД.АналитикаУчетаПартий
	|	КОНЕЦ КАК АналитикаУчетаПартийДокументаПоступления,
	|	
	// Аналитики себестоимости
	|	ДД.Организация КАК Организация,
	|	ДД.РазделУчета,
	|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.Партия КАК Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.АналитикаФинансовогоУчета,
	|
	// Прочие поля
	|	ДД.Период,
	|	ДД.Регистратор,
	// Ддя таможенных деклараций с расходами на документ поступления прошлого периода, чтобы в дальнейшем установить признак "ЭтоПеременныеДопРасходы" в ИСТИНА
	// Аналогично надо сделать для документа Сторно, сторнирующего документ прошлого периода
	|	ВЫБОР
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.ТаможеннаяДекларацияИмпорт)
	|				И ЕСТЬNULL(РеестрПартия.ДатаДокументаИБ, &КонецПредыдущегоПериода) < &НачалоПериода
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Расчетное)
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.ПоступлениеУслугВПодразделение)
	|				И ЕСТЬNULL(РеестрПартия.ДатаДокументаИБ, &КонецПредыдущегоПериода) < &НачалоПериода
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Расчетное)
	|		КОГДА НЕ ДокументыСторно.Сторно ЕСТЬ NULL И ДокументыСторно.СторноПредыдущегоПериода
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Расчетное)
	|		КОГДА ЕСТЬNULL(Выбытия.ПолноеВыбытие, ЛОЖЬ)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОстатокСгруппированный)
	|		ИНАЧЕ ДД.ТипЗаписи
	|	КОНЕЦ КАК ТипЗаписи,
	|	ДД.Подразделение,
	|	ДД.Сторно,
	|	ВЫБОР
	|		КОГДА ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		 И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
	|			ТОГДА ДД.СтатьяРасходовСписания
	|		КОГДА ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|			ТОГДА ДД.СтатьяАктивовПассивов
	|		ИНАЧЕ ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КОНЕЦ КАК СтатьяРасходовАктивов,
	|	ВЫБОР
	|		КОГДА ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		 И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
	|			ТОГДА ДД.АналитикаРасходов
	|		КОГДА ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|			ТОГДА ДД.АналитикаАктивовПассивов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ КАК АналитикаРасходовАктивов,
	|	ЛОЖЬ КАК ЗатратыПредыдущихПеределов,
	|	(ВЫБОР
	|		КОГДА ДД.ДопРасходыРегл <> 0 ТОГДА ИСТИНА
	|		КОГДА ДД.СтоимостьРегл = 0 И ДД.НДСРегл <> 0 ТОГДА ИСТИНА
	|		КОГДА НЕ ДокументыСторно.Сторно ЕСТЬ NULL И ДокументыСторно.СторноПредыдущегоПериода ТОГДА ИСТИНА
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.ПоступлениеУслугВПодразделение)
	|				И ЕСТЬNULL(РеестрПартия.ДатаДокументаИБ, &КонецПредыдущегоПериода) < &НачалоПериода
	|			ТОГДА ИСТИНА
	|		КОГДА ЕСТЬNULL(Выбытия.ПолноеВыбытие, ЛОЖЬ) ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК ЭтоДопРасходы,
	|
	// Ресурсы
	|	СУММА(ДД.Стоимость) КАК СтоимостьСНДС,
	|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	СУММА(ДД.СтоимостьРегл + ДД.ДопРасходыРегл
	|		+ ВЫБОР
	|			КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|				ТОГДА -ДД.НДСРегл
	|			КОГДА ДД.Регистратор ССЫЛКА Документ.ТаможеннаяДекларацияИмпорт
	|			 И ДД.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|				ТОГДА -ДД.НДСРегл
	|			ИНАЧЕ 0
	|	КОНЕЦ) КАК СтоимостьБезНДСРегл,
	|	СУММА(ДД.НДСРегл) КАК НДСРегл,
	|	СУММА(ВЫБОР КОГДА &УправленческийУчетОрганизаций
	|		ТОГДА ДД.СтоимостьУпр + ДД.ДопРасходыУпр
	|		+ ВЫБОР
	|			КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|				ТОГДА -ДД.НДСУпр
	|			КОГДА ДД.Регистратор ССЫЛКА Документ.ТаможеннаяДекларацияИмпорт
	|			 И ДД.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|				ТОГДА -ДД.НДСРегл
	|			ИНАЧЕ 0
	|			КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК СтоимостьБезНДСУпр,
	|	СУММА(ВЫБОР
	|		КОГДА &УправленческийУчетОрганизаций
	|			ТОГДА ДД.НДСУпр
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК НДСУпр,
	|	СУММА(ВЫБОР КОГДА ЕСТЬNULL(Выбытия.ПолноеВыбытие, ЛОЖЬ) ТОГДА Выбытия.Количество ИНАЧЕ ДД.Количество КОНЕЦ) КАК Количество
	|
	|ПОМЕСТИТЬ ПриходыТоваровНДС2_4
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПоПартнерам КАК АналитикаРасчетов
	|		ПО АналитикаРасчетов.Ссылка = ДД.АналитикаУчетаПоПартнерам
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК Договоры
	|		ПО Договоры.Ссылка = АналитикаРасчетов.Договор
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК Корректировка
	|		ПО Корректировка.Ссылка = ДД.Регистратор
	//++ Локализация
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученныйНалоговыйАгент КАК СчетФактура
	|		ПО СчетФактура.Ссылка = ДД.Регистратор
	//-- Локализация
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РеестрДокументов КАК Реестр
	|		ПО Реестр.Ссылка = ДД.ДокументИсточник
	|		И НЕ Реестр.ДополнительнаяЗапись
	|		И Реестр.Ссылка <> НЕОПРЕДЕЛЕНО
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РеестрДокументов КАК РеестрПартия
	|		ПО РеестрПартия.Ссылка = ДД.Партия
	|		И НЕ РеестрПартия.ДополнительнаяЗапись
	|		И РеестрПартия.Ссылка <> НЕОПРЕДЕЛЕНО
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РеестрДокументов КАК РеестрКорректировка
	|		ПО РеестрКорректировка.Ссылка = Корректировка.ДокументОснование
	|		И НЕ РеестрКорректировка.ДополнительнаяЗапись
	|		И РеестрКорректировка.Ссылка <> НЕОПРЕДЕЛЕНО
	|		И НЕ Корректировка.Ссылка ЕСТЬ NULL
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиДляКорректировок КАК Остатки
	|		ПО ДД.Организация = Остатки.Организация
	|		И ДД.РазделУчета = Остатки.РазделУчета
	|		И ДД.АналитикаУчетаНоменклатуры = Остатки.АналитикаУчетаНоменклатуры
	|		И ДД.ВидЗапасов = Остатки.ВидЗапасов
	|		И ДД.Партия = Остатки.Партия
	|		И ДД.АналитикаУчетаПартий = Остатки.АналитикаУчетаПартий
	|		И ДД.ВидДеятельностиНДС = Остатки.ВидДеятельностиНДС
	|		И ДД.АналитикаФинансовогоУчета = Остатки.АналитикаФинансовогоУчета
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТПолностьюВыбывшиеТовары КАК Выбытия
	|		ПО ДД.Организация = Выбытия.Организация
	|		И ДД.РазделУчета = Выбытия.РазделУчета
	|		И ДД.АналитикаУчетаНоменклатуры = Выбытия.АналитикаУчетаНоменклатуры
	|		И ДД.ВидЗапасов = Выбытия.ВидЗапасов
	|		И ДД.Партия = Выбытия.Партия
	|		И ДД.АналитикаУчетаПартий = Выбытия.АналитикаУчетаПартий
	|		И ДД.ВидДеятельностиНДС = Выбытия.ВидДеятельностиНДС
	|		И ДД.АналитикаФинансовогоУчета = Выбытия.АналитикаФинансовогоУчета
	|		И ДД.Регистратор = Выбытия.Регистратор
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТДокументыСторно КАК ДокументыСторно
	|		ПО ДокументыСторно.Сторно = ДД.Регистратор
	|ГДЕ
	|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
	|	И ДД.Партия <> НЕОПРЕДЕЛЕНО
	|   И (ДД.СлужебноеВидДвиженияПриход
	|		ИЛИ ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
	|		ИЛИ ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
	|		ИЛИ ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости)
	|		ИЛИ ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
	// Исключаем суммовую корректировку приобретения, если корректируемый документ относится к периоду с выключенным партионным учетом.
	|	И НЕ (
	|		ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода)
	|		И ДД.СлужебноеВидДвиженияПриход
	|		И ДД.Количество = 0
	|		И ЕСТЬNULL(Реестр.ДатаДокументаИБ, РеестрКорректировка.ДатаДокументаИБ) < &ДатаПереходаНаПартионныйУчетВерсии22
	|		И &ИспользовалсяПартионныйУчетДоПереходаНаВерсию22 = ЛОЖЬ)
	// Исключаем данные, включенные в таблицу ВТКорректировкиПриобретенияПредварительная
	|	И НЕ ((ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.КорректировкаПриобретения)
	|			ИЛИ ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.ПоступлениеУслугВПодразделение)
	|			ИЛИ НЕ ДокументыСторно.Сторно ЕСТЬ NULL)
	|		И ДД.ТипЗаписи В (ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения))
	|		И НЕ Остатки.Организация ЕСТЬ NULL)
	// Исключаем возвратные отходы, не являющиеся партией (например, списанные на расходы), кроме незавершенного производства.
	|	И НЕ (
	|		ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
	|		И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииФиксированнаяСтоимость)
	|		И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|		)
	// Исключаем выпуск продукции по плановой стоимости
	|	И НЕ (
	|		ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
	|		И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
	|		И ДД.Количество <> 0
	|		И ДД.СтоимостьРегл <> 0
	|		)
	|	И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтражениеПлановойСтоимостиВыпуска)
	|	И (ДД.ТипЗаписи В (
	|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение))
	|		ИЛИ (ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения)
	|			И ТИПЗНАЧЕНИЯ(ДД.Регистратор) В (
	|				ТИП(Документ.ПоступлениеТоваровНаСклад),
	|				ТИП(Документ.ПоступлениеУслугВПодразделение),
	|				ТИП(Документ.КорректировкаПриобретения)))
	|		)
	|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|	И (ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|		ИЛИ ДД.СлужебноеВидДвиженияПриход
	|			И ДД.ХозяйственнаяОперация В (
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииФиксированнаяСтоимость),
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
	|			)
	|		)
	|	И НЕ ДД.РазделУчета В (
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку),
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки))
	|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВводОстатков
	|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВводОстатковТоваров
	//++ Локализация


	//-- Локализация
	|	И ТИПЗНАЧЕНИЯ(ДД.Регистратор) <> ТИП(Документ.РаспределениеПрочихЗатрат)
	|	И (ЕСТЬNULL(Выбытия.ПолноеВыбытие, ЛОЖЬ) И ДД.СлужебноеВидДвиженияПриход
	|		ИЛИ НЕ ЕСТЬNULL(Выбытия.ПолноеВыбытие, ЛОЖЬ))
	|СГРУППИРОВАТЬ ПО
	|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
	|		 ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ДД.ТипЗаписи В (
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам))
	|			ТОГДА ДД.КорАналитикаУчетаПартий
	|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
	|		  И ДД.КорАналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|			ТОГДА ДД.КорАналитикаУчетаПартий
	|		КОГДА ДД.ТипЗаписи В (
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
	|		 И ДД.Количество = 0
	|		 И ДД.КорАналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|			ТОГДА ДД.КорАналитикаУчетаПартий
	|		КОГДА ДД.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|			ТОГДА ДД.КорАналитикаУчетаПартий
	|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия) И ДД.Количество = 0
	|		 И ДД.КорАналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|			ТОГДА ДД.КорАналитикаУчетаПартий
	|		КОГДА ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|		 И ДД.КорАналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|			ТОГДА ДД.КорАналитикаУчетаПартий
	|		ИНАЧЕ ДД.АналитикаУчетаПартий
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА НЕ Корректировка.ВидКорректировки ЕСТЬ NULL
	|		 И (Корректировка.ВидКорректировки <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон)
	|			ИЛИ ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения))
	|			ТОГДА Корректировка.ДокументОснование
	//++ Локализация
	|		КОГДА НЕ СчетФактура.Исправление ЕСТЬ NULL И СчетФактура.Исправление
	|			ТОГДА СчетФактура.СчетФактураОснование
	//-- Локализация
	|		КОГДА НЕ ДокументыСторно.Сторно ЕСТЬ NULL
	|			ТОГДА ДокументыСторно.СторнируемыйДокумент
	|		ИНАЧЕ ДД.Регистратор
	|	КОНЕЦ,
	|	
	|	ДД.Организация,
	|	ДД.РазделУчета,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.Период,
	|	ДД.Регистратор,
	|	ДД.Подразделение,
	|	ДД.Сторно,
	|	ВЫБОР
	|		КОГДА ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		 И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
	|			ТОГДА ДД.СтатьяРасходовСписания
	|		КОГДА ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|			ТОГДА ДД.СтатьяАктивовПассивов
	|		ИНАЧЕ ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		 И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
	|			ТОГДА ДД.АналитикаРасходов
	|		КОГДА ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|			ТОГДА ДД.АналитикаАктивовПассивов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.ТаможеннаяДекларацияИмпорт)
	|				И ЕСТЬNULL(РеестрПартия.ДатаДокументаИБ, &КонецПредыдущегоПериода) < &НачалоПериода
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Расчетное)
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.ПоступлениеУслугВПодразделение)
	|				И ЕСТЬNULL(РеестрПартия.ДатаДокументаИБ, &КонецПредыдущегоПериода) < &НачалоПериода
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Расчетное)
	|		КОГДА НЕ ДокументыСторно.Сторно ЕСТЬ NULL И ДокументыСторно.СторноПредыдущегоПериода
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Расчетное)
	|		КОГДА ЕСТЬNULL(Выбытия.ПолноеВыбытие, ЛОЖЬ)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОстатокСгруппированный)
	|		ИНАЧЕ ДД.ТипЗаписи
	|	КОНЕЦ, // ТипЗаписи
	|	(ВЫБОР
	|		КОГДА ДД.ДопРасходыРегл <> 0 ТОГДА ИСТИНА
	|		КОГДА ДД.СтоимостьРегл = 0 И ДД.НДСРегл <> 0 ТОГДА ИСТИНА
	|		КОГДА НЕ ДокументыСторно.Сторно ЕСТЬ NULL И ДокументыСторно.СторноПредыдущегоПериода ТОГДА ИСТИНА
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.ПоступлениеУслугВПодразделение)
	|				И ЕСТЬNULL(РеестрПартия.ДатаДокументаИБ, &КонецПредыдущегоПериода) < &НачалоПериода
	|			ТОГДА ИСТИНА
	|		КОГДА ЕСТЬNULL(Выбытия.ПолноеВыбытие, ЛОЖЬ) ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ КОНЕЦ) // КАК ЭтоДопРасходы
	|
	//++ Локализация
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Остатки себестоимости по ценам старого регистра
	|ВЫБРАТЬ
	|	2 КАК КодИсточника,
	|	ЛОЖЬ КАК ЭтоОстаткиПостатейныеПеременные,
	|	ЛОЖЬ КАК ЭтоОстаткиПостатейныеПостоянные,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	// Аналитики партий НДС
	|	Цены.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Цены.ДокументПоступления,
	|	Цены.АналитикаУчетаПартийДокументаПоступления,
	|	
	// Аналитики себестоимости
	|	ДД.Организация,
	|	ДД.РазделУчета,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.АналитикаФинансовогоУчета,
	|
	// Прочие поля
	|	&НачалоПериода,
	|	НЕОПРЕДЕЛЕНО,
	|	ВЫБОР КОГДА Цены.ЭтоПеременныеЗатраты
	|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Расчетное)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Остаток)
	|	КОНЕЦ КАК ТипЗаписи,
	|	НЕОПРЕДЕЛЕНО,
	|	ЛОЖЬ КАК Сторно,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовАктивов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходовАктивов,
	|	ДД.Партия <> Цены.ДокументПоступления КАК ЗатратыПредыдущихПеределов,
	|	Цены.ЭтоПеременныеЗатраты КАК ЭтоДопРасходы,
	|
	// Ресурсы
	|	ВЫРАЗИТЬ(Цены.СтоимостьСНДС * (ДД.Количество + ЕСТЬNULL(Корректировки.Количество, 0)) КАК ЧИСЛО(31,10)) КАК СтоимостьСНДС,
	|	ВЫРАЗИТЬ(Цены.СтоимостьБезНДС * (ДД.Количество + ЕСТЬNULL(Корректировки.Количество, 0)) КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(Цены.СтоимостьБезНДСРегл * (ДД.Количество + ЕСТЬNULL(Корректировки.Количество, 0)) КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСРегл,
	|	ВЫРАЗИТЬ(Цены.НДСРегл * (ДД.Количество + ЕСТЬNULL(Корректировки.Количество, 0)) КАК ЧИСЛО(31,10)) КАК НДСРегл,
	|	ВЫРАЗИТЬ(Цены.СтоимостьБезНДСУпр * (ДД.Количество + ЕСТЬNULL(Корректировки.Количество, 0)) КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСУпр,
	|	ВЫРАЗИТЬ(Цены.НДСУпр * (ДД.Количество + ЕСТЬNULL(Корректировки.Количество, 0)) КАК ЧИСЛО(31,10)) КАК НДСУпр,
	|	(ДД.Количество + ЕСТЬNULL(Корректировки.Количество, 0)) КАК Количество
	|ИЗ
	|	ВТОстаткиСебестоимостиДляПартийНДС КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТЦеныПартийНДСНаНачалоПериода КАК Цены
	|		ПО Цены.Организация = ДД.Организация
	|		И Цены.РазделУчета = ДД.РазделУчета
	|		И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
	|		И Цены.ВидЗапасов = ДД.ВидЗапасов
	|		И Цены.Партия = ДД.Партия
	|		И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
	|		И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
	|		И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТКорректировкиПриобретения КАК Корректировки
	|		ПО Корректировки.Организация = ДД.Организация
	|		И Корректировки.РазделУчета = ДД.РазделУчета
	|		И Корректировки.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
	|		И Корректировки.ВидЗапасов = ДД.ВидЗапасов
	|		И Корректировки.Партия = ДД.Партия
	|		И Корректировки.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
	|		И Корректировки.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
	|		И Корректировки.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
	|		И НЕ Корректировки.ЭтоПостатейныеЗатраты
	|ГДЕ
	|	Цены.КоличествоПартии > 0
	|	И (Цены.СтоимостьСНДС <> 0
	|		ИЛИ Цены.СтоимостьБезНДС <> 0
	|		ИЛИ Цены.СтоимостьБезНДСРегл <> 0
	|		ИЛИ Цены.НДСРегл <> 0
	|		ИЛИ Цены.СтоимостьБезНДСУпр <> 0
	|		ИЛИ Цены.НДСУпр <> 0)
	//-- Локализация
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Остатки себестоимости по ценам нового регистра
	|ВЫБРАТЬ
	|	3 КАК КодИсточника,
	|	Цены.ЭтоПостатейныеПеременные КАК ЭтоОстаткиПостатейныеПеременные,
	|	Цены.ЭтоПостатейныеПостоянные КАК ЭтоОстаткиПостатейныеПостоянные,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	// Аналитики партий НДС
	|	Цены.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Цены.ДокументПоступления,
	|	Цены.АналитикаУчетаПартийДокументаПоступления,
	|	
	// Аналитики себестоимости
	|	ДД.Организация,
	|	ДД.РазделУчета,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.АналитикаФинансовогоУчета,
	|
	// Прочие поля
	|	&НачалоПериода,
	|	НЕОПРЕДЕЛЕНО,
	|	ВЫБОР КОГДА ЕСТЬNULL(ОстаткиНЗП.ЭтоПеременныеЗатраты, ЛОЖЬ)
	|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОстатокНЗП)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Прошлое)
	|	КОНЕЦ КАК ТипЗаписи,
	|	НЕОПРЕДЕЛЕНО,
	|	ЛОЖЬ КАК Сторно,
	|	Цены.СтатьяРасходов КАК СтатьяРасходовАктивов,
	|	Цены.АналитикаРасходов КАК АналитикаРасходовАктивов,
	|	Цены.ЗатратыПредыдущихПеределов,
	|	Цены.ЭтоПостатейныеПеременные ИЛИ Цены.ЭтоПостатейныеПостоянные КАК ЭтоДопРасходы,
	|
	// Ресурсы
	|	ВЫРАЗИТЬ(Цены.СтоимостьСНДС * (ДД.Количество + ЕСТЬNULL(Корректировки.Количество, 0)) * ЕСТЬNULL(ОстаткиНЗП.Коэффициент, 1) КАК ЧИСЛО(31,10)) КАК СтоимостьСНДС,
	|	ВЫРАЗИТЬ(Цены.СтоимостьБезНДС * (ДД.Количество + ЕСТЬNULL(Корректировки.Количество, 0)) * ЕСТЬNULL(ОстаткиНЗП.Коэффициент, 1) КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(Цены.СтоимостьБезНДСРегл * (ДД.Количество + ЕСТЬNULL(Корректировки.Количество, 0)) * ЕСТЬNULL(ОстаткиНЗП.Коэффициент, 1) КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСРегл,
	|	ВЫРАЗИТЬ(Цены.НДСРегл * (ДД.Количество + ЕСТЬNULL(Корректировки.Количество, 0)) * ЕСТЬNULL(ОстаткиНЗП.Коэффициент, 1) КАК ЧИСЛО(31,10)) КАК НДСРегл,
	|	ВЫРАЗИТЬ(Цены.СтоимостьБезНДСУпр * (ДД.Количество + ЕСТЬNULL(Корректировки.Количество, 0)) * ЕСТЬNULL(ОстаткиНЗП.Коэффициент, 1) КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСУпр,
	|	ВЫРАЗИТЬ(Цены.НДСУпр * (ДД.Количество + ЕСТЬNULL(Корректировки.Количество, 0)) * ЕСТЬNULL(ОстаткиНЗП.Коэффициент, 1) КАК ЧИСЛО(31,10)) КАК НДСУпр,
	|	ВЫБОР КОГДА ЕСТЬNULL(ОстаткиНЗП.ЭтоПеременныеЗатраты, ЛОЖЬ)
	|		ТОГДА ОстаткиНЗП.Количество
	|		ИНАЧЕ ДД.Количество + ЕСТЬNULL(Корректировки.Количество, 0)
	|	КОНЕЦ КАК Количество
	|ИЗ
	|	ВТОстаткиСебестоимостиДляПартийНДС КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТЦеныПартийТоваровНаНачалоПериода КАК Цены
	|		ПО Цены.Организация = ДД.Организация
	|		И Цены.РазделУчета = ДД.РазделУчета
	|		И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
	|		И Цены.ВидЗапасов = ДД.ВидЗапасов
	|		И Цены.Партия = ДД.Партия
	|		И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
	|		И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
	|		И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТКорректировкиПриобретения КАК Корректировки
	|		ПО Корректировки.Организация = ДД.Организация
	|		И Корректировки.РазделУчета = ДД.РазделУчета
	|		И Корректировки.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
	|		И Корректировки.ВидЗапасов = ДД.ВидЗапасов
	|		И Корректировки.Партия = ДД.Партия
	|		И Корректировки.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
	|		И Корректировки.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
	|		И Корректировки.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
	|		И НЕ Корректировки.ЭтоПостатейныеЗатраты
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТИзменениеОстатковНЗП КАК ОстаткиНЗП
	|		ПО ОстаткиНЗП.Организация = ДД.Организация
	|		И ОстаткиНЗП.РазделУчета = ДД.РазделУчета
	|		И ОстаткиНЗП.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
	|		И ОстаткиНЗП.ВидЗапасов = ДД.ВидЗапасов
	|		И ОстаткиНЗП.Партия = ДД.Партия
	|		И ОстаткиНЗП.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
	|		И ОстаткиНЗП.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
	|		И ОстаткиНЗП.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
	|ГДЕ
	|	Цены.КоличествоПартии > 0
	|	И (Цены.СтоимостьСНДС <> 0
	|		ИЛИ Цены.СтоимостьБезНДС <> 0
	|		ИЛИ Цены.СтоимостьБезНДСРегл <> 0
	|		ИЛИ Цены.НДСРегл <> 0
	|		ИЛИ Цены.СтоимостьБезНДСУпр <> 0
	|		ИЛИ Цены.НДСУпр <> 0)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Возвраты реализаций прошлых периодов (по данным старых регистров или материальные из нового регистра)
	|ВЫБРАТЬ
	|	4 КАК КодИсточника,
	|	ЛОЖЬ КАК ЭтоОстаткиПостатейныеПеременные,
	|	ЛОЖЬ КАК ЭтоОстаткиПостатейныеПостоянные,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	// Аналитики партий НДС
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	
	// Аналитики себестоимости
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаФинансовогоУчета,
	|
	// Прочие поля
	|	Т.Период,
	|	Т.Регистратор,
	|	Т.ТипЗаписи,
	|	Т.Подразделение,
	|	Т.Сторно,
	|	Т.СтатьяРасходовАктивов,
	|	Т.АналитикаРасходовАктивов,
	|	Т.ЗатратыПредыдущихПеределов,
	|	ЛОЖЬ КАК ЭтоДопРасходы,
	|
	// Ресурсы
	|	ВЫРАЗИТЬ(Т.СтоимостьСНДС * Т.Количество КАК ЧИСЛО(31,10)) КАК СтоимостьСНДС,
	|	ВЫРАЗИТЬ(Т.СтоимостьБезНДС * Т.Количество КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(Т.СтоимостьБезНДСРегл * Т.Количество КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСРегл,
	|	ВЫРАЗИТЬ(Т.НДСРегл * Т.Количество КАК ЧИСЛО(31,10)) КАК НДСРегл,
	|	ВЫРАЗИТЬ(Т.СтоимостьБезНДСУпр * Т.Количество КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСУпр,
	|	ВЫРАЗИТЬ(Т.НДСУпр * Т.Количество КАК ЧИСЛО(31,10)) КАК НДСУпр,
	|	Т.Количество КАК Количество
	|ИЗ
	|	ВТЦеныПартииНДСВозвратов КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИсточникиЦенВозвратов КАК Возвраты
	|		ПО Т.НомерЗаписи = Возвраты.НомерЗаписи
	|		И Т.НомерИсточника = Возвраты.НомерИсточника
	|ГДЕ
	|	Т.СтоимостьСНДС <> 0
	|		ИЛИ Т.СтоимостьБезНДС <> 0
	|		ИЛИ Т.СтоимостьБезНДСРегл <> 0
	|		ИЛИ Т.НДСРегл <> 0
	|		ИЛИ Т.СтоимостьБезНДСУпр <> 0
	|		ИЛИ Т.НДСУпр <> 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Ввод остатков товаров
	|ВЫБРАТЬ
	|	6 КАК КодИсточника,
	|	ЛОЖЬ КАК ЭтоОстаткиПостатейныеПеременные,
	|	ЛОЖЬ КАК ЭтоОстаткиПостатейныеПостоянные,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	// Аналитики партий НДС
	|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатурыДокументаПоступления,
	|	ДД.ДокументПоступления,
	|	ДД.АналитикаУчетаДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
	|	
	// Аналитики себестоимости
	|	ДД.Организация,
	|	ДД.РазделУчета,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.АналитикаФинансовогоУчета,
	|
	// Прочие поля
	|	&НачалоПериода КАК Период,
	|	НЕОПРЕДЕЛЕНО КАК Регистратор,
	|	ВЫБОР КОГДА ДД.ЭтоПеременныеДопРасходы
	|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Расчетное)
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ТипЗаписи,
	|	НЕОПРЕДЕЛЕНО КАК Подразделение,
	|	ЛОЖЬ КАК Сторно,
	|	ЕСТЬNULL(ДД.СтатьяРасходовАктивов, ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)) КАК СтатьяРасходовАктивов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходовАктивов,
	|	ЛОЖЬ КАК ЗатратыПредыдущихПеределов,
	|	ДД.ЭтоПеременныеДопРасходы КАК ЭтоДопРасходы,
	|
	// Ресурсы
	|	ВЫБОР КОГДА &УправленческийУчетОрганизаций
	|		ТОГДА ВЫБОР
	|				КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|				ТОГДА ДД.СтоимостьБезНДСУпр
	|				ИНАЧЕ ДД.СтоимостьБезНДСУпр + ДД.НДСУпр
	|			  КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ 					КАК СтоимостьСНДС,
	|	ВЫБОР КОГДА &УправленческийУчетОрганизаций
	|		ТОГДА ДД.СтоимостьБезНДСУпр
	|		ИНАЧЕ 0
	|	КОНЕЦ 					КАК СтоимостьБезНДС,
	|	ДД.СтоимостьБезНДС  	КАК СтоимостьБезНДСРегл,
	|	ДД.НДС  				КАК НДСРегл,
	|	ДД.СтоимостьБезНДСУпр  	КАК СтоимостьБезНДСУпр,
	|	ДД.НДСУпр  				КАК НДСУпр,
	|	ВЫБОР КОГДА ДД.Количество = 0 ТОГДА 1 ИНАЧЕ ДД.Количество КОНЕЦ КАК Количество
	|ИЗ
	|	ВТДвиженияВводаОстатков КАК ДД
	|ГДЕ
	|	(ДД.СтоимостьБезНДС <> 0
	|		ИЛИ ДД.НДС <> 0
	|		ИЛИ ДД.СтоимостьБезНДСУпр <> 0
	|		ИЛИ ДД.НДСУпр <> 0)
	|
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Корректировки приобретения - отклонение от старой стоимости
	|ВЫБРАТЬ
	|	8 КАК КодИсточника,
	|	ИСТИНА КАК ЭтоОстаткиПостатейныеПеременные,
	|	ЛОЖЬ КАК ЭтоОстаткиПостатейныеПостоянные,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	// Аналитики партий НДС
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления КАК АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.ДокументПоступления КАК ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
	|	
	// Аналитики себестоимости
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаФинансовогоУчета,
	|
	// Прочие поля
	|	&НачалоПериода,
	|	НЕОПРЕДЕЛЕНО,
	|	ВЫБОР КОГДА Т.ЭтоСторно
	|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Остаток)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Расчетное)
	|	КОНЕЦ КАК ТипЗаписи,
	|	НЕОПРЕДЕЛЕНО,
	|	ЛОЖЬ КАК Сторно,
	|	Т.СтатьяРасходовСписания КАК СтатьяРасходовАктивов,
	|	Т.АналитикаРасходов КАК АналитикаРасходовАктивов,
	|	ЛОЖЬ КАК ЗатратыПредыдущихПеределов,
	|	ИСТИНА КАК ЭтоДопРасходы,
	|
	// Ресурсы
	|	ВЫРАЗИТЬ(Т.СтоимостьСНДС / ВЫБОР КОГДА Т.ЭтоСторно ТОГДА -Т.Количество ИНАЧЕ 1 КОНЕЦ КАК ЧИСЛО (31,2)) КАК СтоимостьСНДС,
	|	ВЫРАЗИТЬ(Т.СтоимостьБезНДС / ВЫБОР КОГДА Т.ЭтоСторно ТОГДА -Т.Количество ИНАЧЕ 1 КОНЕЦ КАК ЧИСЛО (31,2)) КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ((Т.СтоимостьРегл
	|			+ ВЫБОР
	|				КОГДА НЕ Т.ЭтоПостатейныеЗатраты И Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|					ТОГДА -Т.НДСРегл
	|				ИНАЧЕ 0
	|			  КОНЕЦ) / ВЫБОР КОГДА Т.ЭтоСторно ТОГДА -Т.Количество ИНАЧЕ 1 КОНЕЦ
	|		КАК ЧИСЛО (31,2)) КАК СтоимостьБезНДСРегл,
	|	ВЫРАЗИТЬ(Т.НДСРегл / ВЫБОР КОГДА Т.ЭтоСторно ТОГДА -Т.Количество ИНАЧЕ 1 КОНЕЦ КАК ЧИСЛО (31,2)) КАК НДСРегл,
	|	ВЫРАЗИТЬ((Т.СтоимостьУпр
	|			+ ВЫБОР
	|				КОГДА НЕ Т.ЭтоПостатейныеЗатраты И Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|					ТОГДА -Т.НДСУпр
	|				ИНАЧЕ 0
	|			  КОНЕЦ) / ВЫБОР КОГДА Т.ЭтоСторно ТОГДА -Т.Количество ИНАЧЕ 1 КОНЕЦ
	|		КАК ЧИСЛО (31,2)) КАК СтоимостьБезНДСУпр,
	|	ВЫРАЗИТЬ(Т.НДСУпр / ВЫБОР КОГДА Т.ЭтоСторно ТОГДА -Т.Количество ИНАЧЕ 1 КОНЕЦ КАК ЧИСЛО (31,2)) КАК НДСУпр,
	|	Т.Количество КАК Количество
	|ИЗ
	|	ВТКорректировкиПриобретения КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Возвраты реализаций прошлых периодов
	|ВЫБРАТЬ
	|	9 КАК КодИсточника,
	|	Цены.ЭтоПостатейныеПеременные КАК ЭтоОстаткиПостатейныеПеременные,
	|	Цены.ЭтоПостатейныеПостоянные КАК ЭтоОстаткиПостатейныеПостоянные,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	// Аналитики партий НДС
	|	Цены.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Цены.ДокументПоступления,
	|	Цены.АналитикаУчетаПартийДокументаПоступления,
	|	
	// Аналитики себестоимости
	|	ДД.Организация,
	|	ДД.РазделУчета,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.АналитикаФинансовогоУчета,
	|
	// Прочие поля
	|	&НачалоПериода,
	|	НЕОПРЕДЕЛЕНО,
	|	НЕОПРЕДЕЛЕНО,
	|	НЕОПРЕДЕЛЕНО,
	|	ЛОЖЬ КАК Сторно,
	|	Цены.СтатьяРасходов КАК СтатьяРасходовАктивов,
	|	Цены.АналитикаРасходов КАК АналитикаРасходовАктивов,
	|	Цены.ЗатратыПредыдущихПеределов КАК ЗатратыПредыдущихПеределов,
	|	Цены.ЭтоПостатейныеПеременные ИЛИ Цены.ЭтоПостатейныеПостоянные КАК ЭтоДопРасходы,
	|
	// Ресурсы
	|	ВЫРАЗИТЬ(Цены.СтоимостьСНДС * ДД.Количество КАК ЧИСЛО(31,10)) КАК СтоимостьСНДС,
	|	ВЫРАЗИТЬ(Цены.СтоимостьБезНДС * ДД.Количество КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(Цены.СтоимостьБезНДСРегл * ДД.Количество КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСРегл,
	|	ВЫРАЗИТЬ(Цены.НДСРегл * ДД.Количество КАК ЧИСЛО(31,10)) КАК НДСРегл,
	|	ВЫРАЗИТЬ(Цены.СтоимостьБезНДСУпр * ДД.Количество КАК ЧИСЛО(31,10)) КАК СтоимостьБезНДСУпр,
	|	ВЫРАЗИТЬ(Цены.НДСУпр * ДД.Количество КАК ЧИСЛО(31,10)) КАК НДСУпр,
	|	ДД.Количество КАК Количество
	|ИЗ
	|	ВТВозвратыПрошлыхПериодов КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТЦеныПартийТоваровНаНачалоПериода КАК Цены
	|		ПО Цены.Период = ДД.ПериодПродажи
	|		И Цены.Организация = ДД.Организация
	|		И Цены.РазделУчета = ДД.РазделУчета
	|		И Цены.АналитикаУчетаНоменклатуры = ДД.КорАналитикаУчетаНоменклатуры
	|		И Цены.ВидЗапасов = ДД.КорВидЗапасов
	|		И Цены.Партия = ДД.КорПартия
	|		И Цены.АналитикаУчетаПартий = ДД.КорАналитикаУчетаПартий
	|		И Цены.АналитикаФинансовогоУчета = ДД.КорАналитикаФинансовогоУчета
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаНоменклатуры,
	|	Организация,
	|	Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.ЭтоОстаткиПостатейныеПеременные,
	|	ДД.ЭтоОстаткиПостатейныеПостоянные,
	// Аналитики партий НДС
	|	ДД.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	ДД.ДокументПоступления,
	|	ДД.АналитикаУчетаПартийДокументаПоступления,
	|	ДД.ЗатратыПредыдущихПеределов,
	|	ДД.ЭтоДопРасходы,
	|	ДД.ЭтоПеременныеДопРасходы,
	|	
	// Аналитики себестоимости
	|	ДД.Организация,
	|	ДД.РазделУчета,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.АналитикаФинансовогоУчета,
	|
	// Прочие поля
	|	ДД.СтатьяРасходовАктивов КАК СтатьяРасходов,
	|	ДД.АналитикаРасходовАктивов КАК АналитикаРасходов,
	|
	// Ресурсы
	|	ВЫБОР КОГДА ДД.СтоимостьСНДС < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК ЗнакСтоимостьСНДС,
	|	ВЫБОР КОГДА ДД.СтоимостьБезНДС < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК ЗнакСтоимостьБезНДС,
	|	ВЫБОР КОГДА ДД.СтоимостьБезНДСРегл < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК ЗнакСтоимостьБезНДСРегл,
	|	ВЫБОР КОГДА ДД.НДСРегл < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК ЗнакНДСРегл,
	|	ВЫБОР КОГДА ДД.СтоимостьБезНДСУпр < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК ЗнакСтоимостьБезНДСУпр,
	|	ВЫБОР КОГДА ДД.НДСУпр < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК ЗнакНДСУпр,
	|
	|	ВЫБОР КОГДА ДД.СтоимостьСНДС < 0 ТОГДА -ДД.СтоимостьСНДС ИНАЧЕ ДД.СтоимостьСНДС КОНЕЦ КАК СтоимостьСНДС,
	|	ВЫБОР КОГДА ДД.СтоимостьБезНДС < 0 ТОГДА -ДД.СтоимостьБезНДС ИНАЧЕ ДД.СтоимостьБезНДС КОНЕЦ КАК СтоимостьБезНДС,
	|	ВЫБОР КОГДА ДД.СтоимостьБезНДСРегл < 0 ТОГДА -ДД.СтоимостьБезНДСРегл ИНАЧЕ ДД.СтоимостьБезНДСРегл КОНЕЦ КАК СтоимостьБезНДСРегл,
	|	ВЫБОР КОГДА ДД.НДСРегл < 0 ТОГДА -ДД.НДСРегл ИНАЧЕ ДД.НДСРегл КОНЕЦ КАК НДСРегл,
	|	ВЫБОР КОГДА ДД.СтоимостьБезНДСУпр < 0 ТОГДА -ДД.СтоимостьБезНДСУпр ИНАЧЕ ДД.СтоимостьБезНДСУпр КОНЕЦ КАК СтоимостьБезНДСУпр,
	|	ВЫБОР КОГДА ДД.НДСУпр < 0 ТОГДА -ДД.НДСУпр ИНАЧЕ ДД.НДСУпр КОНЕЦ КАК НДСУпр
	|ПОМЕСТИТЬ ПриходыТоваровНДС2_4_ДляРешенияСЛУ
	|ИЗ
	|(ВЫБРАТЬ
	|	ДД.ЭтоОстаткиПостатейныеПеременные,
	|	ДД.ЭтоОстаткиПостатейныеПостоянные,
	// Аналитики партий НДС
	|	ДД.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(ДД.ДокументПоступления) В (&ТипыДокументовПартии)
	|		ТОГДА ДД.ДокументПоступления
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДокументПоступления,
	|	ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(ДД.ДокументПоступления) В (&ТипыДокументовПартии)
	|		ТОГДА ДД.АналитикаУчетаПартийДокументаПоступления
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|	КОНЕЦ КАК АналитикаУчетаПартийДокументаПоступления,
	|	ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(ДД.СтатьяРасходовАктивов) <> ТИП(ПланВидовХарактеристик.СтатьиРасходов)
	|		ТОГДА ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		ИНАЧЕ ДД.СтатьяРасходовАктивов
	|	КОНЕЦ КАК СтатьяРасходовАктивов,
	|	ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(ДД.СтатьяРасходовАктивов) <> ТИП(ПланВидовХарактеристик.СтатьиРасходов)
	|		ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ДД.АналитикаРасходовАктивов
	|	КОНЕЦ КАК АналитикаРасходовАктивов,
	|	ДД.ЗатратыПредыдущихПеределов,
	|	ДД.ЭтоДопРасходы,
	|	ВЫБОР КОГДА ДД.ЭтоДопРасходы
	|	 И ДД.ТипЗаписи В
	|	  (ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
	|	   ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам),
	|	   ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Расчетное))
	|			ТОГДА ИСТИНА
	|		КОГДА ДД.ЭтоДопРасходы
	|	 	И ДД.ТипЗаписи <> ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Прошлое)
	|		 И ТИПЗНАЧЕНИЯ(ДД.ДокументПоступления) В (&ТипыДокументовПартии)
	|		 И ЕСТЬNULL(Реестр.ДатаДокументаИБ, &НачалоПериода) < &НачалоПериода
	|			ТОГДА ИСТИНА
	|			ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЭтоПеременныеДопРасходы,
	|	
	// Аналитики себестоимости
	|	ДД.Организация,
	|	ДД.РазделУчета,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.АналитикаФинансовогоУчета,
	|
	// Ресурсы
	|	СУММА(ДД.СтоимостьСНДС * ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА -1 ИНАЧЕ 1 КОНЕЦ) КАК СтоимостьСНДС,
	|	СУММА(ДД.СтоимостьБезНДС * ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА -1 ИНАЧЕ 1 КОНЕЦ) КАК СтоимостьБезНДС,
	|	СУММА(ДД.СтоимостьБезНДСРегл * ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА -1 ИНАЧЕ 1 КОНЕЦ) КАК СтоимостьБезНДСРегл,
	|	СУММА(ДД.НДСРегл * ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА -1 ИНАЧЕ 1 КОНЕЦ) КАК НДСРегл,
	|	СУММА(ДД.СтоимостьБезНДСУпр * ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА -1 ИНАЧЕ 1 КОНЕЦ) КАК СтоимостьБезНДСУпр,
	|	СУММА(ДД.НДСУпр * ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА -1 ИНАЧЕ 1 КОНЕЦ) КАК НДСУпр
	|ИЗ
	|	ПриходыТоваровНДС2_4 КАК ДД
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РеестрДокументов КАК Реестр
	|		ПО Реестр.Ссылка = ДД.ДокументПоступления
	|		И НЕ Реестр.ДополнительнаяЗапись
	|		И Реестр.Ссылка <> НЕОПРЕДЕЛЕНО
	|ГДЕ
	|	ДД.ТипЗаписи <> ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОстатокНЗП)
	|	И ДД.ТипЗаписи <> ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Остаток)
	|	И ДД.ТипЗаписи <> ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОстатокСгруппированный)
	|СГРУППИРОВАТЬ ПО
	|	ДД.ЭтоОстаткиПостатейныеПеременные,
	|	ДД.ЭтоОстаткиПостатейныеПостоянные,
	|	ДД.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(ДД.ДокументПоступления) В (&ТипыДокументовПартии)
	|		ТОГДА ДД.ДокументПоступления
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(ДД.ДокументПоступления) В (&ТипыДокументовПартии)
	|		ТОГДА ДД.АналитикаУчетаПартийДокументаПоступления
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|	КОНЕЦ,
	|	ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(ДД.СтатьяРасходовАктивов) <> ТИП(ПланВидовХарактеристик.СтатьиРасходов)
	|		ТОГДА ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		ИНАЧЕ ДД.СтатьяРасходовАктивов
	|	КОНЕЦ,
	|	ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(ДД.СтатьяРасходовАктивов) <> ТИП(ПланВидовХарактеристик.СтатьиРасходов)
	|		ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ДД.АналитикаРасходовАктивов
	|	КОНЕЦ,
	|	ДД.ЗатратыПредыдущихПеределов,
	|	ДД.ЭтоДопРасходы,
	|	ВЫБОР КОГДА ДД.ЭтоДопРасходы
	|	 И ДД.ТипЗаписи В
	|	  (ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
	|	   ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам),
	|	   ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Расчетное))
	|			ТОГДА ИСТИНА
	|		КОГДА ДД.ЭтоДопРасходы
	|	 	И ДД.ТипЗаписи <> ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Прошлое)
	|		 И ТИПЗНАЧЕНИЯ(ДД.ДокументПоступления) В (&ТипыДокументовПартии)
	|		 И ЕСТЬNULL(Реестр.ДатаДокументаИБ, &НачалоПериода) < &НачалоПериода
	|			ТОГДА ИСТИНА
	|			ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ДД.Организация,
	|	ДД.РазделУчета,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.АналитикаФинансовогоУчета
	|) КАК ДД
	|ГДЕ
	|	ДД.СтоимостьСНДС <> 0
	|	ИЛИ ДД.СтоимостьБезНДС <> 0
	|	ИЛИ ДД.СтоимостьБезНДСРегл <> 0
	|	ИЛИ ДД.НДСРегл <> 0
	|	ИЛИ ДД.СтоимостьБезНДСУпр <> 0
	|	ИЛИ ДД.НДСУпр <> 0
	|
	// Индексы должны соответствовать свойству ИндексыРегистра из описания регистра себестоимости
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаНоменклатуры,
	|	Организация,
	|	Партия
    |";
	
	Возврат ТекстЗапроса;
	
КонецФункции

#КонецОбласти

#Область ПроцедурыЭтапа_РасчетПартийНДС2_4ПоДопРасходам

// Инициализация данных

Функция ПоляПотребленийРаспределениеПартийНДСФИФОСкользящаяПоДопРасходам(ПараметрыРасчета)
	
	Возврат "Организация, Подразделение, НаправлениеДеятельности, СтатьяРасходовАктивов, АналитикаРасходов";
	
КонецФункции

Функция ОписаниеЦепочекРаспределениеПартийНДСФИФОСкользящаяПоДопРасходам(ПараметрыРасчета)
	
	ОписаниеЦепочек = Новый Соответствие;
	
	ПоляСвязи = ПоляПотребленийРаспределениеПартийНДСФИФОСкользящаяПоДопРасходам(ПараметрыРасчета);
	
	#Область БазаДопРасходыРегл
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ДопРасходыДляРаспределенияРегл);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.БазаДопРасходыРегл,
		ПоляСвязи,
		Источники);
	
	#КонецОбласти
	
	#Область БазаДопРасходыУпр
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ДопРасходыДляРаспределенияУпр);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.БазаДопРасходыУпр,
		ПоляСвязи,
		Источники);
	
	#КонецОбласти
	
	Возврат ОписаниеЦепочек;
	
КонецФункции

Функция ОписаниеДвиженийРаспределениеПартийНДСФИФОСкользящаяПоДопРасходам(ПараметрыРасчета)
	
	КолонкиТаблицыРаспределения = ТаблицаРаспределениеПартийНДСФИФОСкользящаяПоДопРасходам(ПараметрыРасчета).Колонки;
	
	ОписаниеДвижений = РасчетСебестоимостиПрикладныеАлгоритмы.ОписаниеДвижений();
	ОписаниеДвижений.Вставить("Контекст", "РаспределениеПартийНДСФИФОСкользящаяПоДопРасходам");
	ОписаниеДвижений.Вставить("ИмяВременнойТаблицы", "ВТДопРасходыДляПостатейныхЗатрат");
	ОписаниеДвижений.Вставить("ПоляИндексирования", "АналитикаУчетаНоменклатуры");
	ОписаниеДвижений.Вставить("ПоляРасчета", РасчетСебестоимостиПрикладныеАлгоритмы.ПереченьПолей(КолонкиТаблицыРаспределения));
	ОписаниеДвижений.Вставить("КлючиСравнения",	ПоляПотребленийРаспределениеПартийНДСФИФОСкользящаяПоДопРасходам(ПараметрыРасчета));
	ОписаниеДвижений.Вставить("Показатели", "Знаменатель, СтоимостьСНДС, СтоимостьБезНДС, СтоимостьБезНДСРегл, НДСРегл, СтоимостьБезНДСУпр, НДСУпр");
	ОписаниеДвижений.Вставить("ИсключенияПоказатели", "ЗнаменательДляИсточников");
	ОписаниеДвижений.Вставить("БазисПрихода", "Знаменатель");
	ОписаниеДвижений.Вставить("БазисРасхода", "Знаменатель");
	ОписаниеДвижений.Вставить("КлючРасхода", "ДокументИсточник");
	ОписаниеДвижений.Вставить("ПолеПорядка", "ПериодПоступления");
	ОписаниеДвижений.Вставить("ПоляСортировки", "Партия");
	ОписаниеДвижений.Вставить("СортировкаПоУсловию", Истина);
	
	ОписаниеДвижений.Вставить("ПоляСуммирования", "СтоимостьСНДС, СтоимостьБезНДС, СтоимостьБезНДСРегл, НДСРегл, СтоимостьБезНДСУпр, НДСУпр");
	ОписаниеДвижений.Вставить("ИсключенияПоляСуммирования", "Знаменатель, ЗнаменательДляИсточников");
	ОписаниеДвижений.Вставить("ПоляГруппировки",  
		РасчетСебестоимостиПрикладныеАлгоритмы.ПереченьПолей(КолонкиТаблицыРаспределения, ОписаниеДвижений.ПоляСуммирования));
	ОписаниеДвижений.Вставить("УменьшатьБазис", Истина);
	ОписаниеДвижений.Вставить("УдалятьСтрокиБезИсточников", Истина);
	
	ОписаниеДвижений.Вставить("ВременныеТаблицыДляСледующихЭтапов", "ВТДопРасходыДляРаспределенияФИФО, ВТДвиженияВключенияИсключениНДСДопРасходов");
	
	Возврат ОписаниеДвижений;
	
КонецФункции

Функция ОписаниеНезаписываемыхРаспределениеПартийНДСФИФОСкользящаяПоДопРасходам(ПараметрыРасчета, НезаписываемыеТипыЗаписей = Неопределено)
	
	Если НезаписываемыеТипыЗаписей = Неопределено Тогда
		НезаписываемыеТипыЗаписей = Новый Соответствие;
	КонецЕсли;
	
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.БазаДопРасходыРегл, 	  		  Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.БазаДопРасходыУпр, 		  	  Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.ДопРасходыДляРаспределенияРегл, Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.ДопРасходыДляРаспределенияУпр,  Истина);
	
	Возврат РасчетСебестоимостиПрикладныеАлгоритмы.ОписаниеНезаписываемыхДанных(Ложь, НезаписываемыеТипыЗаписей);
	
КонецФункции

Функция ТаблицаРаспределениеПартийНДСФИФОСкользящаяПоДопРасходам(ПараметрыРасчета)
	
	Возврат РасчетСебестоимостиПрикладныеАлгоритмы.ТаблицаДляРаспределенияПартий(ПараметрыРасчета, ТекстОписаниеДанныхДляРаспределениеПартийНДСФИФОСкользящая());
	
КонецФункции

// Выборка данных

Процедура ПолучитьДанныеДляРаспределениеПартийНДСФИФОСкользящаяПоДопРасходам(ПараметрыРасчета)
	
	ПараметрыНумерации = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		"ДокументПоступления", // разделитель
		"Знаменатель, СтоимостьСНДС, СтоимостьБезНДС, СтоимостьБезНДСРегл, НДСРегл, СтоимостьБезНДСУпр, НДСУпр", // ресурсы
		"Период, Приоритет ВОЗР, Организация, Партия, АналитикаУчетаПартий, Регистратор"); // порядок
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьДанныеЭтапаРасчета(
		ПараметрыРасчета,
		ТекстЗапросаДляРаспределениеПартийНДСФИФОСкользящаяПоДопРасходам(ПараметрыРасчета),
		ПараметрыНумерации);
	
КонецПроцедуры

// Тексты запросов

// ... общий

Функция ТекстЗапросаДляРаспределениеПартийНДСФИФОСкользящаяПоДопРасходам(ПараметрыРасчета = Неопределено) Экспорт
	
	ТекстЗапроса = "";
	
	ЕстьТаблицаДопРасходов = Ложь;
	//++ Локализация
	ЕстьТаблицаДопРасходов = Истина;
	//-- Локализация
	
	// выборка данных
	Если НЕ ЕстьТаблицаДопРасходов Тогда
	 	ТекстЗапроса = ТекстРаспределениеДопРасходов() + ОбщегоНазначения.РазделительПакетаЗапросов();
	КонецЕсли;
	
	ТекстЗапроса = ТекстЗапроса
		+ ТекстДопРасходыДляРаспределенияФИФО()
		+ ОбщегоНазначения.РазделительПакетаЗапросов()
		+ ТекстОписаниеДанныхДляРаспределениеПартийНДСФИФОСкользящая() //вт Данные
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстДопРасходыДляРаспределенияРегл()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстБазаДопРасходыРегл()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстДопРасходыДляРаспределенияУпр()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстБазаДопРасходыУпр()
		+ "";
		
	Возврат ТекстЗапроса;
	
КонецФункции

// ... выборки данных

Функция ТекстДопРасходыДляРаспределенияФИФО() // ВТДопРасходыДляРаспределенияФИФО, использует ВТДопРасходыДляРаспределения
	Возврат 
		"ВЫБРАТЬ
		|	1 КАК Источник,
		|	Т.Регистратор КАК Регистратор,
		|	Т.Период КАК Период,
		|	Т.Организация КАК Организация,
		|	Т.Подразделение КАК Подразделение,
		|	Т.СтатьяРасходов КАК СтатьяРасходов,
		|	Т.АналитикаРасходов КАК АналитикаРасходов,
		|	Т.ДокументПоступления КАК ДокументПоступления,
		|	Т.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
		|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК ИдентификаторФинЗаписи,
		|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
		|	Т.РасчетПартий,
		|	Т.ЭтоПартииПрочихРасходов,
		|	Т.СтоимостьРегл,
		|	Т.НДСРегл,
		|	Т.Стоимость,
		|	Т.СтоимостьБезНДС,
		|	Т.СтоимостьБезНДСУпр,
		|	Т.НДСУпр,
		|	Т.ЗнаменательРегл,
		|	Т.ЗнаменательУпр
		|ПОМЕСТИТЬ ВТДопРасходыДляРаспределенияФИФО
		|ИЗ
		|	ВТДопРасходыДляРаспределения КАК Т
		|ГДЕ
		|	Т.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	2 КАК Источник,
		|	Т.Регистратор КАК Регистратор,
		|	Т.Период КАК Период,
		|	Т.Организация КАК Организация,
		|	Т.Подразделение КАК Подразделение,
		|	Т.СтатьяРасходовСписания КАК СтатьяРасходов,
		|	Т.АналитикаРасходов КАК АналитикаРасходов,
		|	Т.ДокументПоступления КАК ДокументПоступления,
		|	Т.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
		|	Т.КорВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	Т.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
		|	Т.ИдентификаторФинЗаписи,
		|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
		|	ЛОЖЬ КАК РасчетПартий,
		|	ЛОЖЬ КАК ЭтоПартииПрочихРасходов,
		|	СУММА(ВЫРАЗИТЬ(Т.СтоимостьБезНДСРегл * Статьи.КоэффициентРегл КАК ЧИСЛО (31,2))) КАК СтоимостьРегл,
		|	СУММА(ВЫРАЗИТЬ(Т.НДСРегл * Статьи.КоэффициентРегл КАК ЧИСЛО (31,2))) КАК НДСРегл,
		|	СУММА(ВЫРАЗИТЬ(Т.СтоимостьСНДС * Статьи.КоэффициентУпр КАК ЧИСЛО (31,2))) КАК Стоимость,
		|	СУММА(ВЫРАЗИТЬ(Т.СтоимостьБезНДС * Статьи.КоэффициентУпр КАК ЧИСЛО (31,2))) КАК СтоимостьБезНДС,
		|	СУММА(ВЫРАЗИТЬ(Т.СтоимостьБезНДСУпр * Статьи.КоэффициентУпр КАК ЧИСЛО (31,2))) КАК СтоимостьБезНДСУпр,
		|	СУММА(ВЫРАЗИТЬ(Т.НДСУпр * Статьи.КоэффициентУпр КАК ЧИСЛО (31,2))) КАК НДСУпр,
		|	СУММА(ВЫРАЗИТЬ(Т.СтоимостьБезНДСРегл * Статьи.КоэффициентРегл КАК ЧИСЛО (31,2))) КАК ЗнаменательРегл,
		|	СУММА(ВЫРАЗИТЬ(Т.СтоимостьСНДС * Статьи.КоэффициентУпр КАК ЧИСЛО (31,2))) КАК ЗнаменательУпр
		|ИЗ
		|	ВТОборотыСтоимостьПартийНДС КАК Т
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТСтатьиЗатратНаСебестоимость КАК Статьи
		|		ПО Статьи.Ссылка = Т.СтатьяРасходовСписания
		|ГДЕ
		|	Т.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНаРасходыФиксированнаяСтоимость)
		|	И НЕ Т.СлужебноеВидДвиженияПриход
		|
		|СГРУППИРОВАТЬ ПО
		|	Т.Регистратор,
		|	Т.Период,
		|	Т.Организация,
		|	Т.Подразделение,
		|	Т.СтатьяРасходовСписания,
		|	Т.АналитикаРасходов,
		|	Т.ДокументПоступления,
		|	Т.АналитикаУчетаПартийДокументаПоступления,
		|	Т.КорВидДеятельностиНДС,
		|	Т.КорНаправлениеДеятельности,
		|	Т.ИдентификаторФинЗаписи,
		|	Т.ХозяйственнаяОперация
		|
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	СтатьяРасходов,
		|	АналитикаРасходов,
		|	Подразделение,
		|	Организация,
		|	НаправлениеДеятельности
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЛОЖЬ КАК НаВыбытие,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВключениеИсключениеНДСВСтоимости) КАК ТипЗаписи,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения
		|ПОМЕСТИТЬ ВТДвиженияВключенияИсключениНДСДопРасходов
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ИСТИНА КАК НаВыбытие,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам) КАК ТипЗаписи,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ИСТИНА КАК НаВыбытие,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам) КАК ТипЗаписи,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения
		|"
КонецФункции

Функция ТекстДопРасходыДляРаспределенияРегл() // использует ВТДопРасходыДляРаспределенияФИФО
	Возврат
		"ВЫБРАТЬ
		|	""ТекстДопРасходыДляРаспределенияРегл"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыДляРаспределенияРегл) КАК ТипЗаписи,
		|	ВЫБОР КОГДА МАКСИМУМ(База.ЗнаменательРегл) < 0 ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ КАК ЭтоСторно,
		|	0 											КАК Приоритет,
		|	ВЫБОР КОГДА МАКСИМУМ(База.ЗнаменательРегл) < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ * МАКСИМУМ(База.ЗнаменательРегл) КАК Знаменатель,
		|	0											КАК ЗнаменательДляИсточников,
		|	ИСТИНА 										КАК РасчетЗавершен,
		|	
		|	ДД.Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Партия,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартийДокументаПоступления,
		|	ДД.НаправлениеДеятельности,
		|
		|	0 КАК СтоимостьСНДС,
		|	0 КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьБезНДСРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	0 КАК СтоимостьБезНДСУпр,
		|	0 КАК НДСУпр,
		|
		|	ЛОЖЬ КАК НаВыбытие,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.ВидДеятельностиНДС КАК КорВидДеятельностиНДС,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК КорАналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК КорНаправлениеДеятельности,
		|	ДД.Подразделение КАК Подразделение,
		|	ДД.СтатьяРасходов КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК ИдентификаторФинЗаписи,
		|	ЛОЖЬ КАК Сторно
		|ИЗ
		|	ВТДопРасходыДляРаспределенияФИФО КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТБазаРаспределенияДопРасходовСводно КАК База
		|		ПО ДД.Организация = База.Организация
		|		И ДД.Подразделение = База.Подразделение
		|		И ДД.НаправлениеДеятельности = База.НаправлениеДеятельности
		|		И ДД.СтатьяРасходов = База.СтатьяРасходов
		|		И ДД.АналитикаРасходов = База.АналитикаРасходов
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И База.ЗнаменательРегл <> 0
		|	И (ДД.СтоимостьРегл <> 0 ИЛИ ДД.НДСРегл <> 0)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартийДокументаПоступления,
		|	ДД.НаправлениеДеятельности,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов
		|";
КонецФункции

Функция ТекстБазаДопРасходыРегл()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстБазаДопРасходыРегл"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.БазаДопРасходыРегл) КАК ТипЗаписи,
		|	ВЫБОР КОГДА ДД.ЗнакРегл = -1 ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ КАК ЭтоСторно,
		|	ВЫБОР КОГДА ДД.ЗнакРегл = -1 ТОГДА 0 ИНАЧЕ 10 КОНЕЦ КАК Приоритет,
		|	ДД.ЗнаменательРегл							КАК Знаменатель,
		|	0 											КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ 										КАК РасчетЗавершен,
		|	
		|	ДД.Период КАК Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор КАК Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДД.Партия КАК Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартийДокументаПоступления,
		|	ДД.НаправлениеДеятельности,
		|
		|	0 КАК СтоимостьСНДС,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьБезНДСРегл,
		|	0 КАК НДСРегл,
		|	0 КАК СтоимостьБезНДСУпр,
		|	0 КАК НДСУпр,
		|
		|	ДД.НаВыбытие,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК КорАналитикаУчетаПартий,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходов КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	ДД.КорСтатьяРасходов,
		|	ДД.КорАналитикаРасходов,
		|	ДД.КорПодразделение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	ДД.РазделУчета,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ИдентификаторФинЗаписи,
		|	ЛОЖЬ КАК Сторно
		|ИЗ
		|	ВТБазаРаспределенияДопРасходов КАК ДД
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И ДД.ЗнаменательРегл <> 0
		|";
КонецФункции

Функция ТекстДопРасходыДляРаспределенияУпр() // использует ВТДопРасходыДляРаспределенияФИФО
	Возврат
		"ВЫБРАТЬ
		|	""ТекстДопРасходыДляРаспределенияУпр"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыДляРаспределенияУпр) КАК ТипЗаписи,
		|	ВЫБОР КОГДА МАКСИМУМ(База.ЗнаменательУпр) < 0 ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ КАК ЭтоСторно,
		|	0 											КАК Приоритет,
		|	ВЫБОР КОГДА МАКСИМУМ(База.ЗнаменательУпр) < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ * МАКСИМУМ(База.ЗнаменательУпр) КАК Знаменатель,
		|	0											КАК ЗнаменательДляИсточников,
		|	ИСТИНА 										КАК РасчетЗавершен,
		|	
		|	ДД.Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Партия,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартийДокументаПоступления,
		|	ДД.НаправлениеДеятельности,
		|
		|	СУММА(ДД.Стоимость) КАК СтоимостьСНДС,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьБезНДСРегл,
		|	0 КАК НДСРегл,
		|	СУММА(ДД.СтоимостьБезНДСУпр) КАК СтоимостьБезНДСУпр,
		|	СУММА(ДД.НДСУпр) КАК НДСУпр,
		|
		|	ЛОЖЬ КАК НаВыбытие,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.ВидДеятельностиНДС КАК КорВидДеятельностиНДС,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК КорАналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК КорНаправлениеДеятельности,
		|	ДД.Подразделение КАК Подразделение,
		|	ДД.СтатьяРасходов КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК ИдентификаторФинЗаписи,
		|	ЛОЖЬ КАК Сторно
		|ИЗ
		|	ВТДопРасходыДляРаспределенияФИФО КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТБазаРаспределенияДопРасходовСводно КАК База
		|		ПО ДД.Организация = База.Организация
		|		И ДД.Подразделение = База.Подразделение
		|		И ДД.НаправлениеДеятельности = База.НаправлениеДеятельности
		|		И ДД.СтатьяРасходов = База.СтатьяРасходов
		|		И ДД.АналитикаРасходов = База.АналитикаРасходов
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И База.ЗнаменательУпр <> 0
		|	И (ДД.Стоимость <> 0 ИЛИ ДД.СтоимостьБезНДС <> 0 ИЛИ ДД.НДСУпр <> 0)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартийДокументаПоступления,
		|	ДД.НаправлениеДеятельности,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов
		|";
КонецФункции

Функция ТекстБазаДопРасходыУпр()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстБазаДопРасходыУпр"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.БазаДопРасходыУпр) КАК ТипЗаписи,
		|	ВЫБОР КОГДА ДД.ЗнакУпр = -1 ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ КАК ЭтоСторно,
		|	ВЫБОР КОГДА ДД.ЗнакУпр = -1 ТОГДА 0 ИНАЧЕ 10 КОНЕЦ КАК Приоритет,
		|	ДД.ЗнаменательУпр							КАК Знаменатель,
		|	0 											КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ 										КАК РасчетЗавершен,
		|	
		|	ДД.Период КАК Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор КАК Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДД.Партия КАК Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартийДокументаПоступления,
		|	ДД.НаправлениеДеятельности,
		|
		|	0 КАК СтоимостьСНДС,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьБезНДСРегл,
		|	0 КАК НДСРегл,
		|	0 КАК СтоимостьБезНДСУпр,
		|	0 КАК НДСУпр,
		|
		|	ДД.НаВыбытие,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК КорАналитикаУчетаПартий,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходов КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	ДД.КорСтатьяРасходов,
		|	ДД.КорАналитикаРасходов,
		|	ДД.КорПодразделение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	ДД.РазделУчета,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ИдентификаторФинЗаписи,
		|	ЛОЖЬ КАК Сторно
		|ИЗ
		|	ВТБазаРаспределенияДопРасходов КАК ДД
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И ДД.ЗнаменательУпр <> 0
		|";
КонецФункции

#КонецОбласти

#Область ПроцедурыЭтапа_РасчетПартийНДС2_4ПоПартиямПрочихРасходов

//++ Локализация

// Инициализация данных

Функция ТаблицаРаспределениеПартийНДСФИФОСкользящая(ПараметрыРасчета)
	
	Возврат РасчетСебестоимостиПрикладныеАлгоритмы.ТаблицаДляРаспределенияПартий(ПараметрыРасчета,	ТекстОписаниеДанныхДляРаспределениеПартийНДСФИФОСкользящаяПоПартиямПрочихРасходов());
	
КонецФункции

// Выборка данных

Процедура ПолучитьДанныеДляРаспределениеПартийНДСФИФОСкользящая(ПараметрыРасчета)
	
	
	// Получим данные этапа
	ДопПараметры = ПараметрыРасчета.ДополнительныеПараметрыЗапросаЭтапа;
	ДопПараметры.Вставить("РасчетПоПартиямПрочихРасходов", Истина);
	
	ПараметрыНумерации = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		"ДокументПоступления", // разделитель
		"Знаменатель, ЗнаменательУпр, ЗнаменательДляИсточников, ЗнаменательДляИсточниковУпр, СтоимостьСНДС, СтоимостьБезНДС, СтоимостьБезНДСРегл, НДСРегл, НДСУпр", // ресурсы
		"ТипЗаписи, Знаменатель УБЫВ, ЗнаменательУпр УБЫВ, Период, Организация, Партия, АналитикаУчетаПартий, Регистратор"); // порядок
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьДанныеЭтапаРасчета(
		ПараметрыРасчета,
		ТекстЗапросаДляРаспределениеПартийНДСФИФОСкользящая(ПараметрыРасчета),
		ПараметрыНумерации);
	
КонецПроцедуры

// Тексты запросов

// ... общий

Функция ТекстЗапросаДляРаспределениеПартийНДСФИФОСкользящая(ПараметрыРасчета = Неопределено) Экспорт
	
	ТекстЗапроса = ""
		// подготовка временных таблиц
		""
		+ ТекстИнициализацияРаспределениеПартийНДСФИФОСкользящая() + ОбщегоНазначения.РазделительПакетаЗапросов()
		+ ТекстДвиженияСебестоимостиНДСФИФОСкользящая() + ОбщегоНазначения.РазделительПакетаЗапросов()

		// выборка данных
		+ ТекстОписаниеДанныхДляРаспределениеПартийНДСФИФОСкользящаяПоПартиямПрочихРасходов() //вт Данные

		+ "";
		
	Возврат ТекстЗапроса;
	
КонецФункции

//-- Локализация
//
// ... описания данных

Функция ТекстОписаниеДанныхДляРаспределениеПартийНДСФИФОСкользящая() Экспорт
	ТекстЗапроса = 
		"ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80)) 								 КАК ЗапросИсточник,
		|	Себестоимость.ТипЗаписи 									 КАК ТипЗаписи,
		|	ЛОЖЬ														 КАК ЭтоСторно,
		|	0 															 КАК Приоритет,
		|	0 															 КАК Знаменатель,
		|	0 															 КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ 														 КАК РасчетЗавершен,
		|	
		|	Себестоимость.Период,
		|	Себестоимость.Период КАК ПериодПоступления,
		|	Себестоимость.Регистратор,
		|	Себестоимость.ВидДвижения,
		|	ДД.Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) 				      КАК ВидЗапасов,
		|	Себестоимость.КорАналитикаУчетаНоменклатуры,
		|	Себестоимость.КорВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	Себестоимость.ВидДеятельностиНДС,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|
		|
		|	0 КАК СтоимостьСНДС,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьБезНДСРегл,
		|	0 КАК НДСРегл,
		|	0 КАК СтоимостьБезНДСУпр,
		|	0 КАК НДСУпр,
		|
		|	ЛОЖЬ КАК НаВыбытие,
		|	Себестоимость.ХозяйственнаяОперация,
		|	Себестоимость.КорВидДеятельностиНДС,
		|	ДД.Организация КАК КорОрганизация,
		|	ДД.Партия КАК КорПартия,
		|	ДД.АналитикаУчетаПартий КАК КорАналитикаУчетаПартий,
		|	Себестоимость.КорНаправлениеДеятельности,
		|	Себестоимость.Подразделение,
		|	ПартииПрочихРасходов.СтатьяРасходов КАК СтатьяРасходовАктивов,
		|	ПартииПрочихРасходов.АналитикаРасходов,
		|	ПартииПрочихРасходов.АналитикаАктивовПассивов КАК АналитикаАктивов,
		|	Себестоимость.СтатьяРасходовСписания КАК КорСтатьяРасходов,
		|	Себестоимость.АналитикаРасходов КАК КорАналитикаРасходов,
		|	Себестоимость.Подразделение КорПодразделение,
		|	Себестоимость.ДокументИсточник,
		|	Себестоимость.СтатьяРасходовСписания КАК СтатьяСписанияНДС,
		|	Себестоимость.АналитикаРасходов КАК АналитикаСписанияНДС,
		|	Себестоимость.РазделУчета,
		|	Себестоимость.АналитикаФинансовогоУчета,
		|	Себестоимость.ИдентификаторФинЗаписи,
		|	Себестоимость.Сторно
		|ПОМЕСТИТЬ Данные
		|ИЗ
		|	РегистрСведений.ДетализацияСебестоимостиПартииТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров КАК Себестоимость
		|		ПО ЛОЖЬ
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииПрочихРасходов КАК ПартииПрочихРасходов
		|		ПО ЛОЖЬ
		|";

	ТекстЗапроса = РасчетСебестоимостиПрикладныеАлгоритмы.ПодготовитьЗапросОписанияДанных(ТекстЗапроса);

	Возврат ТекстЗапроса;

КонецФункции

Функция ТекстОписаниеДанныхДляРаспределениеПартийНДСФИФОСкользящаяПоПартиямПрочихРасходов() Экспорт
	ТекстЗапроса = 
		"ВЫБРАТЬ ПЕРВЫЕ 0
		|	Себестоимость.ТипЗаписи 									 КАК ТипЗаписи,
		|	ЛОЖЬ														 КАК ЧастичноОставитьВНЗП,
		|	0 															 КАК Знаменатель,
		|	0 															 КАК ЗнаменательУпр,
		|	0 															 КАК ЗнаменательДляИсточников,
		|	0 															 КАК ЗнаменательДляИсточниковУпр,
		|	
		|	Себестоимость.Период,
		|	Себестоимость.Регистратор,
		|	Себестоимость.ВидДвижения,
		|	ДД.Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) 				      КАК ВидЗапасов,
		|	Себестоимость.КорАналитикаУчетаНоменклатуры,
		|	Себестоимость.КорВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	Себестоимость.ВидДеятельностиНДС,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|
		|
		|	0 КАК СтоимостьСНДС,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьБезНДСРегл,
		|	0 КАК НДСРегл,
		|	0 КАК НДСУпр,
		|
		|	Себестоимость.ИдентификаторФинЗаписи,
		|	Себестоимость.ХозяйственнаяОперация,
		|	Себестоимость.КорВидДеятельностиНДС,
		|	ДД.Партия КАК КорПартия,
		|	ДД.АналитикаУчетаПартий КАК КорАналитикаУчетаПартий,
		|	Себестоимость.КорНаправлениеДеятельности,
		|	Себестоимость.Подразделение,
		|	ПартииПрочихРасходов.СтатьяРасходов КАК СтатьяРасходовАктивов,
		|	ПартииПрочихРасходов.АналитикаРасходов,
		|	Себестоимость.Подразделение КорПодразделение,
		|	Себестоимость.СтатьяРасходовСписания КАК СтатьяСписанияНДС,
		|	Себестоимость.АналитикаРасходов КАК АналитикаСписанияНДС,
		|	Себестоимость.РазделУчета,
		|	Себестоимость.АналитикаФинансовогоУчета
		|ПОМЕСТИТЬ Данные
		|ИЗ
		|	РегистрСведений.ДетализацияСебестоимостиПартииТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров КАК Себестоимость
		|		ПО ЛОЖЬ
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииПрочихРасходов КАК ПартииПрочихРасходов
		|		ПО ЛОЖЬ
		|";

	ТекстЗапроса = РасчетСебестоимостиПрикладныеАлгоритмы.ПодготовитьЗапросОписанияДанных(ТекстЗапроса);

	Возврат ТекстЗапроса;

КонецФункции

//++ Локализация
// ... формирования временные таблиц

Функция ТекстИнициализацияРаспределениеПартийНДСФИФОСкользящая()
	Возврат
		"
		|ВЫБРАТЬ
		|	НАЧАЛОПЕРИОДА(МАКСИМУМ(Т.Период), МЕСЯЦ) КАК Период
		|ПОМЕСТИТЬ ПериодПредыдущегоРассчитанногоПериода
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК Т
		|ГДЕ
		|	Т.Период < &НачалоПериода
		|	И Т.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|ИНДЕКСИРОВАТЬ ПО
		|	Период
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	Цены.Цена КАК Цена
		|ПОМЕСТИТЬ ВТПлановыеЦены
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Ключи
		|		ПО ДД.АналитикаУчетаНоменклатуры = Ключи.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&КонецПериода, ВидЦены = &ВидПлановыхЦен) КАК Цены
		|		ПО Цены.Номенклатура   = Ключи.Номенклатура
		|		 И Цены.Характеристика = Ключи.Характеристика
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
		|	И ЕСТЬNULL(Цены.Цена, 0) <> 0
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.РазделУчета,
		|	ДД.СтоимостьРегл
		|ПОМЕСТИТЬ ВТРасчетныеЦены
		|ИЗ
		|	ВТСтоимостьПартийТоваров КАК ДД
		|ГДЕ
		|	ДД.СтоимостьРегл <> 0
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.РазделУчета,
		|	ВЫРАЗИТЬ(ДД.СтоимостьРегл / ДД.Количество КАК ЧИСЛО(31,2)) КАК СтоимостьРегл
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТСтоимостьПартийТоваров КАК Цены
		|		ПО Цены.Организация = ДД.Организация
		|		И Цены.Партия = ДД.Партия
		|		И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|		И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|		И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Цены.ВидЗапасов = ДД.ВидЗапасов
		|		И Цены.РазделУчета = ДД.РазделУчета
		|	
		|ГДЕ
		|	ДД.Регистратор = ДД.Партия
		|	И ДД.Количество <> 0
		|	И (Цены.Организация ЕСТЬ NULL
		|		ИЛИ Цены.СтоимостьРегл = 0)
		|	И ВЫРАЗИТЬ(ДД.СтоимостьРегл / ДД.Количество КАК ЧИСЛО(31,2)) <> 0
		|	И НЕ ДД.Сторно
		|	И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры,
		|	Организация,
		|	Партия
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ВЫРАЗИТЬ(ДД.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Номенклатура КАК Номенклатура,
		|	ВЫРАЗИТЬ(ДД.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Характеристика КАК Характеристика,
		|	СУММА(ДД.Знаменатель) КАК Знаменатель
		|ПОМЕСТИТЬ ВТЗнаменателиПоНоменклатуре
		|ИЗ
		|	(ВЫБРАТЬ
		|		ДД.РазделУчета,
		|		ДД.Организация,
		|		ДД.Партия,
		|		ДД.АналитикаУчетаПартий,
		|		ДД.АналитикаФинансовогоУчета,
		|		ДД.ВидДеятельностиНДС,
		|		ДД.АналитикаУчетаНоменклатуры,
		|		ДД.ВидЗапасов,
		|		ВЫРАЗИТЬ(
		|			ВЫРАЗИТЬ(ДД.Количество КАК ЧИСЛО(15, 3)) 
		|			* ВЫРАЗИТЬ(ЕСТЬNULL(Цены.СтоимостьРегл,	ЕСТЬNULL(ПлановыеЦены.Цена, 0)) КАК ЧИСЛО(31, 10))
		|		  КАК ЧИСЛО(31, 2)) КАК Знаменатель
		|	ИЗ
		|		ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТРасчетныеЦены КАК Цены
		|			ПО Цены.Организация = ДД.Организация
		|			И Цены.Партия = ДД.Партия
		|			И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|			И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|			И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|			И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|			И Цены.ВидЗапасов = ДД.ВидЗапасов
		|			И Цены.РазделУчета = ДД.РазделУчета
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТПлановыеЦены КАК ПлановыеЦены
		|			ПО ПлановыеЦены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|	ГДЕ
		|		ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|		И ДД.СлужебноеВидДвиженияПриход
		|		И ДД.ТипЗаписи В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
		|		И НЕ ДД.Сторно
		|		И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		|	ВЫБРАТЬ
		|		ДД.РазделУчета,
		|		ДД.Организация,
		|		ДД.Партия,
		|		ДД.АналитикаУчетаПартий,
		|		ДД.АналитикаФинансовогоУчета,
		|		ДД.ВидДеятельностиНДС,
		|		ДД.АналитикаУчетаНоменклатуры,
		|		ДД.ВидЗапасов,
		|		ВЫРАЗИТЬ(
		|			ВЫРАЗИТЬ(ДД.КоличествоОстаток КАК ЧИСЛО(15, 3)) 
		|			* ВЫРАЗИТЬ(ЕСТЬNULL(Цены.СтоимостьРегл,	ЕСТЬNULL(ПлановыеЦены.Цена, 0)) КАК ЧИСЛО(31, 10))
		|		  КАК ЧИСЛО(31, 2)) КАК Знаменатель
		|	ИЗ
		|		РегистрНакопления.СебестоимостьТоваров.Остатки(&ГраницаКонецПредыдущегоПериода,
		|			Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|			И РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)) КАК ДД
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТРасчетныеЦены КАК Цены
		|			ПО Цены.Организация = ДД.Организация
		|			И Цены.Партия = ДД.Партия
		|			И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|			И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|			И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|			И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|			И Цены.ВидЗапасов = ДД.ВидЗапасов
		|			И Цены.РазделУчета = ДД.РазделУчета
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТПлановыеЦены КАК ПлановыеЦены
		|			ПО ПлановыеЦены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|	) КАК ДД
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ВЫРАЗИТЬ(ДД.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Номенклатура,
		|	ВЫРАЗИТЬ(ДД.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Характеристика
		|ИМЕЮЩИЕ
		|	СУММА(ДД.Знаменатель) > 0
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Регистратор КАК Регистратор,
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	ДД.РазделУчета КАК РазделУчета,
		|	ДД.ВидЗапасов КАК ВидЗапасов,
		|	ДД.Организация КАК Организация,
		|	ДД.Партия КАК Партия,
		|	ДД.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
		|	ДД.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ДД.ЭтоДопРасходы КАК ЭтоДопРасходы,
		|	СУММА(ДД.ЗнаменательПриход) КАК Знаменатель,
		|	СУММА(ДД.ЗнаменательРасход) КАК ЗнаменательДляИсточников
		|ПОМЕСТИТЬ ЗнаменателиПриходов
		|ИЗ
		|	(ВЫБРАТЬ
		|		ДД.Регистратор КАК Регистратор,
		|		ЛОЖЬ КАК ЭтоДопРасходы,
		|		ИСТИНА КАК ЕстьПриход,
		|		ЛОЖЬ КАК ЕстьРасход,
		|		ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|		ДД.РазделУчета КАК РазделУчета,
		|		ДД.ВидЗапасов КАК ВидЗапасов,
		|		ДД.Организация КАК Организация,
		|		ДД.Партия КАК Партия,
		|		ДД.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
		|		ДД.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
		|		ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|		ВЫРАЗИТЬ(СУММА(
		|			ВЫРАЗИТЬ(ДД.Количество КАК ЧИСЛО(15, 3)) 
		|			* ВЫРАЗИТЬ(ЕСТЬNULL(Цены.СтоимостьРегл,	ЕСТЬNULL(ПлановыеЦены.Цена, 1)) КАК ЧИСЛО(31, 10)))
		|		  КАК ЧИСЛО(31, 2)) КАК ЗнаменательПриход,
		|		0 КАК ЗнаменательРасход
		|	ИЗ
		|		ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТРасчетныеЦены КАК Цены
		|			ПО Цены.Организация = ДД.Организация
		|			И Цены.Партия = ДД.Партия
		|			И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|			И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|			И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|			И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|			И Цены.ВидЗапасов = ДД.ВидЗапасов
		|			И Цены.РазделУчета = ДД.РазделУчета
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТПлановыеЦены КАК ПлановыеЦены
		|			ПО ПлановыеЦены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|	ГДЕ
		|		ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|		И ДД.СлужебноеВидДвиженияПриход
		|		И НЕ ДД.ТипЗаписи В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией))
		|		И НЕ ДД.ХозяйственнаяОперация В (
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводстваФиксированнаяСтоимость))
		|		И НЕ ДД.Сторно
		|		И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
		|	СГРУППИРОВАТЬ ПО
		|		ДД.Регистратор,
		|		ДД.АналитикаУчетаНоменклатуры,
		|		ДД.РазделУчета,
		|		ДД.ВидЗапасов,
		|		ДД.Организация,
		|		ДД.Партия,
		|		ДД.АналитикаУчетаПартий,
		|		ДД.АналитикаФинансовогоУчета,
		|		ДД.ВидДеятельностиНДС
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		ДД.Регистратор КАК Регистратор,
		|		ИСТИНА КАК ЭтоДопРасходы,
		|		ИСТИНА КАК ЕстьПриход,
		|		ЛОЖЬ КАК ЕстьРасход,
		|		ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|		ДД.РазделУчета КАК РазделУчета,
		|		ДД.ВидЗапасов КАК ВидЗапасов,
		|		ДД.Организация КАК Организация,
		|		ДД.Партия КАК Партия,
		|		ДД.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
		|		ДД.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
		|		ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|		МАКСИМУМ(ЕСТЬNULL(Знаменатели.Знаменатель, 0)) КАК ЗнаменательПриход,
		|		0 КАК ЗнаменательРасход
		|	ИЗ
		|		ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТЗнаменателиПоНоменклатуре КАК Знаменатели
		|			ПО Знаменатели.Организация = ДД.Организация
		|			И Знаменатели.Партия = ДД.Партия
		|			И Знаменатели.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|			И Знаменатели.Номенклатура = ДД.АналитикаУчетаНоменклатуры.Номенклатура
		|			И Знаменатели.Характеристика = ДД.АналитикаУчетаНоменклатуры.Характеристика
		|	ГДЕ
		|		ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|		И ДД.СлужебноеВидДвиженияПриход
		|		И ДД.ТипЗаписи В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией))
		|		И НЕ ДД.Сторно
		|		И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
		|	СГРУППИРОВАТЬ ПО
		|		ДД.Регистратор,
		|		ДД.АналитикаУчетаНоменклатуры,
		|		ДД.РазделУчета,
		|		ДД.ВидЗапасов,
		|		ДД.Организация,
		|		ДД.Партия,
		|		ДД.АналитикаУчетаПартий,
		|		ДД.АналитикаФинансовогоУчета,
		|		ДД.ВидДеятельностиНДС
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		ДД.Регистратор,
		|		ЛОЖЬ,
		|		ЛОЖЬ,
		|		ИСТИНА,
		|		ДД.КорАналитикаУчетаНоменклатуры,
		|		ДД.КорРазделУчета,
		|		ДД.КорВидЗапасов,
		|		ВЫБОР КОГДА ДД.КорОрганизация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) ТОГДА ДД.Организация ИНАЧЕ ДД.КорОрганизация КОНЕЦ,
		|		ДД.КорПартия,
		|		ДД.КорАналитикаУчетаПартий,
		|		ДД.КорАналитикаФинансовогоУчета,
		|		ДД.КорВидДеятельностиНДС,
		|		0,
		|		ВЫРАЗИТЬ(
		|			ВЫРАЗИТЬ(ДД.Количество КАК ЧИСЛО(15, 3)) 
		|			* ВЫРАЗИТЬ(ЕСТЬNULL(Цены.СтоимостьРегл,	ЕСТЬNULL(ПлановыеЦены.Цена, 1)) КАК ЧИСЛО(31, 10))
		|		  КАК ЧИСЛО(31, 2))
		|	ИЗ
		|		ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТРасчетныеЦены КАК Цены
		|			ПО Цены.Организация = ДД.Организация
		|			И Цены.Партия = ДД.Партия
		|			И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|			И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|			И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|			И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|			И Цены.ВидЗапасов = ДД.ВидЗапасов
		|			И Цены.РазделУчета = ДД.РазделУчета
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТПлановыеЦены КАК ПлановыеЦены
		|			ПО ПлановыеЦены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|	ГДЕ
		|		ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|		И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
		|		И НЕ ДД.СлужебноеВидДвиженияПриход
		|		И НЕ ДД.Сторно) КАК ДД
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Регистратор,
		|	ДД.ЭтоДопРасходы,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.РазделУчета,
		|	ДД.ВидЗапасов,
		|	ДД.Организация,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС
		|
		|ИМЕЮЩИЕ
		|	МАКСИМУМ(ДД.ЕстьПриход) = ИСТИНА
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры,
		|	Организация,
		|	Партия
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Т.Регистратор КАК Регистратор,
		|	СУММА(Т.Знаменатель) КАК Знаменатель
		|ПОМЕСТИТЬ ЗнаменателиРегистраторов
		|ИЗ
		|	ЗнаменателиПриходов КАК Т
		|ГДЕ
		|	Т.ЗнаменательДляИсточников <> 0
		|
		|СГРУППИРОВАТЬ ПО
		|	Т.Регистратор
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Т.Партия КАК Партия,
		|	СУММА(Т.Знаменатель) КАК Знаменатель
		|ПОМЕСТИТЬ ЗнаменателиПартий
		|ИЗ
		|	ЗнаменателиПриходов КАК Т
		|ГДЕ
		|	Т.ЗнаменательДляИсточников <> 0
		|
		|СГРУППИРОВАТЬ ПО
		|	Т.Партия
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Т.Регистратор,
		|	Т.Период,
		|	Т.Организация КАК Организация,
		|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	Т.Партия КАК Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.АналитикаФинансовогоУчета,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.РазделУчета,
		|	Т.Подразделение,
		|	Т.СтатьяРасходовСписания КАК СтатьяРасходов,
		|	Т.АналитикаРасходов КАК АналитикаРасходов,
		|	Т.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
		|	ВЫБОР КОГДА Т.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|		ТОГДА Т.ВидДеятельностиНДС
		|		ИНАЧЕ Т.КорВидДеятельностиНДС
		|	КОНЕЦ КАК КорВидДеятельностиНДС,
		|	Т.ИдентификаторФинЗаписи,
		|	Т.ХозяйственнаяОперация,
		|	Т.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	Т.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
		|	ВЫБОР КОГДА НЕ ОСНО.СистемаНалогообложения ЕСТЬ NULL ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ КАК ОСНО,
		|	СУММА(ВЫРАЗИТЬ(Т.Количество * Статьи.КоэффициентРегл КАК ЧИСЛО (15,3))) КАК КоличествоРегл,
		|	СУММА(ВЫРАЗИТЬ(Т.Количество * Статьи.КоэффициентУпр КАК ЧИСЛО (15,3))) КАК КоличествоУпр
		|ПОМЕСТИТЬ ВТДвиженияСебестоимостиДляСписаниеТоваров
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК Т
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТСтатьиПроизводственныхЗатрат КАК Статьи
		|		ПО Т.СтатьяРасходовСписания = Статьи.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиОрганизаций КАК ОСНО
		|		ПО ОСНО.Организация = Т.Организация
		|		И ОСНО.СистемаНалогообложения = ЗНАЧЕНИЕ(Перечисление.СистемыНалогообложения.Общая)
		|ГДЕ
		|	Т.Организация В(&ОрганизацииСРаздельнымУчетомПостатейныхЗатрат)
		|	И НЕ Т.СлужебноеВидДвиженияПриход
		|	И Т.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию)
		|	И Т.Количество <> 0
		|
		|СГРУППИРОВАТЬ ПО
		|	Т.Регистратор,
		|	Т.Период,
		|	Т.Организация,
		|	Т.ВидДеятельностиНДС,
		|	Т.Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.АналитикаФинансовогоУчета,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.РазделУчета,
		|	Т.Подразделение,
		|	Т.СтатьяРасходовСписания,
		|	Т.АналитикаРасходов,
		|	Т.КорНаправлениеДеятельности,
		|	ВЫБОР КОГДА Т.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|		ТОГДА Т.ВидДеятельностиНДС
		|		ИНАЧЕ Т.КорВидДеятельностиНДС
		|	КОНЕЦ,
		|	Т.ИдентификаторФинЗаписи,
		|	Т.ХозяйственнаяОперация,
		|	Т.АналитикаУчетаНоменклатуры.Номенклатура,
		|	Т.АналитикаУчетаНоменклатуры.Характеристика,
		|	ВЫБОР КОГДА НЕ ОСНО.СистемаНалогообложения ЕСТЬ NULL ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ
		|ИНДЕКСИРОВАТЬ ПО
		|	Партия,
		|	Организация,
		|	Номенклатура
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Т.Организация,
		|	Т.ВидДеятельностиНДС,
		|	Т.Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.АналитикаФинансовогоУчета,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.РазделУчета,
		|	Т.ИдентификаторФинЗаписи,
		|	Т.Номенклатура,
		|	Т.ДокументПоступления,
		|	Т.АналитикаУчетаПартийДокументаПоступления,
		// Если по набору полей есть записи в прошлом и в текущем периоде, то берем цену из текущего периода
		|   ВЫБОР КОГДА МИНИМУМ(Т.Прошлое) = ИСТИНА ТОГДА СУММА(Т.СтоимостьБезНДСРеглПрошлая) ИНАЧЕ СУММА(Т.СтоимостьБезНДСРегл) КОНЕЦ СтоимостьБезНДСРегл,
		|   ВЫБОР КОГДА МИНИМУМ(Т.Прошлое) = ИСТИНА ТОГДА СУММА(Т.НДСРеглПрошлая) ИНАЧЕ СУММА(Т.НДСРегл) КОНЕЦ НДСРегл,
		|   ВЫБОР КОГДА МИНИМУМ(Т.Прошлое) = ИСТИНА ТОГДА СУММА(Т.СтоимостьБезНДСУпрПрошлая) ИНАЧЕ СУММА(Т.СтоимостьБезНДСУпр) КОНЕЦ СтоимостьБезНДСУпр,
		|   ВЫБОР КОГДА МИНИМУМ(Т.Прошлое) = ИСТИНА ТОГДА СУММА(Т.НДСУпрПрошлая) ИНАЧЕ СУММА(Т.НДСУпр) КОНЕЦ НДСУпр
		|ПОМЕСТИТЬ ВТЦеныСписанияТоваровПеременные
		|ИЗ
		|	(ВЫБРАТЬ
		|		ИСТИНА КАК Прошлое,
		|		Т.Организация,
		|		Т.ВидДеятельностиНДС,
		|		Т.Партия,
		|		Т.АналитикаУчетаПартий,
		|		Т.АналитикаФинансовогоУчета,
		|		Т.АналитикаУчетаНоменклатуры,
		|		Т.ВидЗапасов,
		|		Т.РазделУчета,
		|		Т.ИдентификаторФинЗаписи,
		|		Партии.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|		Партии.ДокументПоступления,
		|		Партии.АналитикаУчетаПартийДокументаПоступления,
		|		Партии.СтоимостьБезНДСРегл КАК СтоимостьБезНДСРеглПрошлая,
		|		Партии.НДСРегл КАК НДСРеглПрошлая,
		|		Партии.СтоимостьБезНДСУпр КАК СтоимостьБезНДСУпрПрошлая,
		|		Партии.НДСУпр КАК НДСУпрПрошлая,
		|		0 КАК СтоимостьБезНДСРегл,
		|		0 КАК НДСРегл,
		|		0 КАК СтоимостьБезНДСУпр,
		|		0 КАК НДСУпр
		|	ИЗ
		|		ВТДвиженияСебестоимостиДляСписаниеТоваров КАК Т
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ДетализацияСебестоимостиТоваровПостатейныеЗатраты КАК Партии
		|			ПО Партии.Организация = Т.Организация
		|			И Партии.РазделУчета = Т.РазделУчета
		|			И Партии.АналитикаУчетаНоменклатуры = Т.АналитикаУчетаНоменклатуры
		|			И Партии.ВидЗапасов = Т.ВидЗапасов
		|			И Партии.Партия = Т.Партия
		|			И Партии.АналитикаУчетаПартий = Т.АналитикаУчетаПартий
		|			И Партии.ВидДеятельностиНДС = Т.ВидДеятельностиНДС
		|			И Партии.АналитикаФинансовогоУчета = Т.АналитикаФинансовогоУчета
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПериодПредыдущегоРассчитанногоПериода КАК ПериодДвижений
		|			ПО Партии.Период = ПериодДвижений.Период
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		ЛОЖЬ КАК Прошлое,
		|		Т.Организация,
		|		Т.ВидДеятельностиНДС,
		|		Т.Партия,
		|		Т.АналитикаУчетаПартий,
		|		Т.АналитикаФинансовогоУчета,
		|		Т.АналитикаУчетаНоменклатуры,
		|		Т.ВидЗапасов,
		|		Т.РазделУчета,
		|		Т.ИдентификаторФинЗаписи,
		|		Партии.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|		Партии.ДокументПоступления,
		|		Партии.АналитикаУчетаПартийДокументаПоступления,
		|		0 КАК СтоимостьБезНДСРеглПрошлая,
		|		0 КАК НДСРеглПрошлая,
		|		0 КАК СтоимостьБезНДСУпрПрошлая,
		|		0 КАК НДСУпрПрошлая,
		|		Партии.СтоимостьБезНДСРегл,
		|		Партии.НДСРегл,
		|		Партии.СтоимостьБезНДСУпр,
		|		Партии.НДСУпр
		|	ИЗ
		|		ВТДвиженияСебестоимостиДляСписаниеТоваров КАК Т
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТКэшДетализацияСебестоимостиТоваровПостатейныеЗатраты КАК Партии
		|			ПО Партии.Организация = Т.Организация
		|			И Партии.РазделУчета = Т.РазделУчета
		|			И Партии.АналитикаУчетаНоменклатуры = Т.АналитикаУчетаНоменклатуры
		|			И Партии.ВидЗапасов = Т.ВидЗапасов
		|			И Партии.Партия = Т.Партия
		|			И Партии.АналитикаУчетаПартий = Т.АналитикаУчетаПартий
		|			И Партии.ВидДеятельностиНДС = Т.ВидДеятельностиНДС
		|			И Партии.АналитикаФинансовогоУчета = Т.АналитикаФинансовогоУчета
		|)КАК Т
		|СГРУППИРОВАТЬ ПО
		|	Т.Организация,
		|	Т.ВидДеятельностиНДС,
		|	Т.Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.АналитикаФинансовогоУчета,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.РазделУчета,
		|	Т.ИдентификаторФинЗаписи,
		|	Т.Номенклатура,
		|	Т.ДокументПоступления,
		|	Т.АналитикаУчетаПартийДокументаПоступления
		|ИНДЕКСИРОВАТЬ ПО
		|	Партия,
		|	Организация,
		|	Номенклатура
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Т.Регистратор,
		|	Т.Период,
		|	Т.Организация,
		|	Т.ВидДеятельностиНДС,
		|	Т.Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.АналитикаФинансовогоУчета,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.РазделУчета,
		|	Т.Подразделение,
		|	Т.СтатьяРасходов,
		|	Т.АналитикаРасходов,
		|	Партии.ДокументПоступления КАК ДокументПоступления,
		|	Партии.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
		|	Т.НаправлениеДеятельности,
		|	Т.КорВидДеятельностиНДС,
		|	Т.ИдентификаторФинЗаписи,
		|	Т.ХозяйственнаяОперация,
		|	СУММА(ВЫБОР КОГДА ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл КАК ЧИСЛО (31,2)) > Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл
		|			И Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл > 0
		|			И Т.ОСНО
		|		ТОГДА ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл КАК ЧИСЛО (31,2)) - 0.01
		|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл КАК ЧИСЛО (31,2))
		|	КОНЕЦ) КАК СтоимостьБезНДС,
		|	СУММА(ВЫБОР КОГДА ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.НДСРегл КАК ЧИСЛО (31,2)) > Т.КоличествоРегл * Партии.НДСРегл
		|			И Т.КоличествоРегл * Партии.НДСРегл > 0
		|			И Т.ОСНО
		|		ТОГДА ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.НДСРегл КАК ЧИСЛО (31,2)) - 0.01
		|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.НДСРегл КАК ЧИСЛО (31,2))
		|	КОНЕЦ) КАК НДС,
		|	СУММА(ВЫБОР КОГДА ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр КАК ЧИСЛО (31,2)) > Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр
		|			И Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр > 0
		|			И Т.ОСНО
		|		ТОГДА ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр КАК ЧИСЛО (31,2)) - 0.01
		|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр КАК ЧИСЛО (31,2))
		|	КОНЕЦ) КАК СтоимостьБезНДСУпр,
		|	СУММА(ВЫБОР КОГДА ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.НДСУпр КАК ЧИСЛО (31,2)) > Т.КоличествоУпр * Партии.НДСУпр
		|			И Т.КоличествоУпр * Партии.НДСУпр > 0
		|			И Т.ОСНО
		|		ТОГДА ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.НДСУпр КАК ЧИСЛО (31,2)) - 0.01
		|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.НДСУпр КАК ЧИСЛО (31,2))
		|	КОНЕЦ) КАК НДСУпр
		|ПОМЕСТИТЬ ВТСебестоимостьСписаниеТоваров
		|ИЗ
		|	ВТДвиженияСебестоимостиДляСписаниеТоваров КАК Т
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТКэшДетализацияСебестоимостиПартииТоваров КАК Партии
		|		ПО Партии.Организация = Т.Организация
		|		И Партии.Партия = Т.Партия
		|		И Партии.АналитикаУчетаПартий = Т.АналитикаУчетаПартий
		|		И Партии.ВидЗапасов = Т.ВидЗапасов
		|		И Партии.Номенклатура = Т.Номенклатура
		|		И Партии.Характеристика = Т.Характеристика
		|		И (Т.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
		|			ИЛИ Т.АналитикаУчетаНоменклатуры = Партии.АналитикаУчетаНоменклатурыНЗП)
		|
		|СГРУППИРОВАТЬ ПО
		|	Т.Регистратор,
		|	Т.Период,
		|	Т.Организация,
		|	Т.ВидДеятельностиНДС,
		|	Т.Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.АналитикаФинансовогоУчета,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.РазделУчета,
		|	Т.Подразделение,
		|	Т.СтатьяРасходов,
		|	Т.АналитикаРасходов,
		|	Партии.ДокументПоступления,
		|	Партии.АналитикаУчетаПартийДокументаПоступления,
		|	Т.НаправлениеДеятельности,
		|	Т.КорВидДеятельностиНДС,
		|	Т.ИдентификаторФинЗаписи,
		|	Т.ХозяйственнаяОперация
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	Т.Регистратор,
		|	Т.Период,
		|	Т.Организация,
		|	Т.ВидДеятельностиНДС,
		|	Т.Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.АналитикаФинансовогоУчета,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.РазделУчета,
		|	Т.Подразделение,
		|	Т.СтатьяРасходов,
		|	Т.АналитикаРасходов,
		|	Партии.ДокументПоступления КАК ДокументПоступления,
		|	Партии.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
		|	Т.НаправлениеДеятельности,
		|	Т.КорВидДеятельностиНДС,
		|	Т.ИдентификаторФинЗаписи,
		|	Т.ХозяйственнаяОперация,
		|	СУММА(ВЫБОР КОГДА ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл КАК ЧИСЛО (31,2)) > Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл
		|			И Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл > 0
		|			И Т.ОСНО
		|		ТОГДА ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл КАК ЧИСЛО (31,2)) - 0.01
		|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл КАК ЧИСЛО (31,2))
		|	КОНЕЦ) КАК СтоимостьБезНДС,
		|	СУММА(ВЫБОР КОГДА ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.НДСРегл КАК ЧИСЛО (31,2)) > Т.КоличествоРегл * Партии.НДСРегл
		|			И Т.КоличествоРегл * Партии.НДСРегл > 0
		|			И Т.ОСНО
		|		ТОГДА ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.НДСРегл КАК ЧИСЛО (31,2)) - 0.01
		|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.НДСРегл КАК ЧИСЛО (31,2))
		|	КОНЕЦ) КАК НДС,
		|	СУММА(ВЫБОР КОГДА ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр КАК ЧИСЛО (31,2)) > Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр
		|			И Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр > 0
		|			И Т.ОСНО
		|		ТОГДА ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр КАК ЧИСЛО (31,2)) - 0.01
		|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр КАК ЧИСЛО (31,2))
		|	КОНЕЦ) КАК СтоимостьБезНДСУпр,
		|	СУММА(ВЫБОР КОГДА ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.НДСУпр КАК ЧИСЛО (31,2)) > Т.КоличествоУпр * Партии.НДСУпр
		|			И Т.КоличествоУпр * Партии.НДСУпр > 0
		|			И Т.ОСНО
		|		ТОГДА ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.НДСУпр КАК ЧИСЛО (31,2)) - 0.01
		|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.НДСУпр КАК ЧИСЛО (31,2))
		|	КОНЕЦ) КАК НДСУпр
		|ИЗ
		|	ВТДвиженияСебестоимостиДляСписаниеТоваров КАК Т
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ДетализацияСебестоимостиПартииТоваров КАК Партии
		|		ПО Партии.Организация = Т.Организация
		|		И Партии.Партия = Т.Партия
		|		И Партии.АналитикаУчетаПартий = Т.АналитикаУчетаПартий
		|		И Партии.ВидЗапасов = Т.ВидЗапасов
		|		И Партии.Номенклатура = Т.Номенклатура
		|		И Партии.Характеристика = Т.Характеристика
		|		И (Т.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
		|			ИЛИ Т.АналитикаУчетаНоменклатуры = Партии.АналитикаУчетаНоменклатурыНЗП)
		|ГДЕ
		|	Партии.ПериодРегистрации < &НачалоПериода
		|
		|СГРУППИРОВАТЬ ПО
		|	Т.Регистратор,
		|	Т.Период,
		|	Т.Организация,
		|	Т.ВидДеятельностиНДС,
		|	Т.Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.АналитикаФинансовогоУчета,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.РазделУчета,
		|	Т.Подразделение,
		|	Т.СтатьяРасходов,
		|	Т.АналитикаРасходов,
		|	Партии.ДокументПоступления,
		|	Партии.АналитикаУчетаПартийДокументаПоступления,
		|	Т.НаправлениеДеятельности,
		|	Т.КорВидДеятельностиНДС,
		|	Т.ИдентификаторФинЗаписи,
		|	Т.ХозяйственнаяОперация
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	Т.Регистратор,
		|	Т.Период,
		|	Т.Организация,
		|	Т.ВидДеятельностиНДС,
		|	Т.Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.АналитикаФинансовогоУчета,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.РазделУчета,
		|	Т.Подразделение,
		|	Т.СтатьяРасходов,
		|	Т.АналитикаРасходов,
		|	Партии.ДокументПоступления КАК ДокументПоступления,
		|	Партии.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
		|	Т.НаправлениеДеятельности,
		|	Т.КорВидДеятельностиНДС,
		|	Т.ИдентификаторФинЗаписи,
		|	Т.ХозяйственнаяОперация,
		|	СУММА(ВЫБОР КОГДА ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл КАК ЧИСЛО (31,2)) > Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл
		|			И Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл > 0
		|			И Т.ОСНО
		|		ТОГДА ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл КАК ЧИСЛО (31,2)) - 0.01
		|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл КАК ЧИСЛО (31,2))
		|	КОНЕЦ) КАК СтоимостьБезНДС,
		|	СУММА(ВЫБОР КОГДА ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.НДСРегл КАК ЧИСЛО (31,2)) > Т.КоличествоРегл * Партии.НДСРегл
		|			И Т.КоличествоРегл * Партии.НДСРегл > 0
		|			И Т.ОСНО
		|		ТОГДА ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.НДСРегл КАК ЧИСЛО (31,2)) - 0.01
		|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.НДСРегл КАК ЧИСЛО (31,2))
		|	КОНЕЦ) КАК НДС,
		|	СУММА(ВЫБОР КОГДА ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр КАК ЧИСЛО (31,2)) > Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр
		|			И Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр > 0
		|			И Т.ОСНО
		|		ТОГДА ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр КАК ЧИСЛО (31,2)) - 0.01
		|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр КАК ЧИСЛО (31,2))
		|	КОНЕЦ) КАК СтоимостьБезНДСУпр,
		|	СУММА(ВЫБОР КОГДА ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.НДСУпр КАК ЧИСЛО (31,2)) > Т.КоличествоУпр * Партии.НДСУпр
		|			И Т.КоличествоУпр * Партии.НДСУпр > 0
		|			И Т.ОСНО
		|		ТОГДА ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.НДСУпр КАК ЧИСЛО (31,2)) - 0.01
		|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.НДСУпр КАК ЧИСЛО (31,2))
		|	КОНЕЦ) КАК НДСУпр
		|ИЗ
		|	ВТДвиженияСебестоимостиДляСписаниеТоваров КАК Т
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТКэшДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты КАК Партии
		|		ПО Партии.Организация = Т.Организация
		|		И Партии.Партия = Т.Партия
		|		И Партии.АналитикаУчетаПартий = Т.АналитикаУчетаПартий
		|		И Партии.ВидЗапасов = Т.ВидЗапасов
		|		И Партии.Номенклатура = Т.Номенклатура
		|		И Партии.Характеристика = Т.Характеристика
		|		И (Т.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
		|			ИЛИ Т.АналитикаУчетаНоменклатуры = Партии.АналитикаУчетаНоменклатурыНЗП)
		|
		|СГРУППИРОВАТЬ ПО
		|	Т.Регистратор,
		|	Т.Период,
		|	Т.Организация,
		|	Т.ВидДеятельностиНДС,
		|	Т.Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.АналитикаФинансовогоУчета,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.РазделУчета,
		|	Т.Подразделение,
		|	Т.СтатьяРасходов,
		|	Т.АналитикаРасходов,
		|	Партии.ДокументПоступления,
		|	Партии.АналитикаУчетаПартийДокументаПоступления,
		|	Т.НаправлениеДеятельности,
		|	Т.КорВидДеятельностиНДС,
		|	Т.ИдентификаторФинЗаписи,
		|	Т.ХозяйственнаяОперация
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	Т.Регистратор,
		|	Т.Период,
		|	Т.Организация,
		|	Т.ВидДеятельностиНДС,
		|	Т.Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.АналитикаФинансовогоУчета,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.РазделУчета,
		|	Т.Подразделение,
		|	Т.СтатьяРасходов,
		|	Т.АналитикаРасходов,
		|	Партии.ДокументПоступления КАК ДокументПоступления,
		|	Партии.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
		|	Т.НаправлениеДеятельности,
		|	Т.КорВидДеятельностиНДС,
		|	Т.ИдентификаторФинЗаписи,
		|	Т.ХозяйственнаяОперация,
		|	СУММА(ВЫБОР КОГДА ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл КАК ЧИСЛО (31,2)) > Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл
		|			И Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл > 0
		|			И Т.ОСНО
		|		ТОГДА ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл КАК ЧИСЛО (31,2)) - 0.01
		|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл КАК ЧИСЛО (31,2))
		|	КОНЕЦ) КАК СтоимостьБезНДС,
		|	СУММА(ВЫБОР КОГДА ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.НДСРегл КАК ЧИСЛО (31,2)) > Т.КоличествоРегл * Партии.НДСРегл
		|			И Т.КоличествоРегл * Партии.НДСРегл > 0
		|			И Т.ОСНО
		|		ТОГДА ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.НДСРегл КАК ЧИСЛО (31,2)) - 0.01
		|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.НДСРегл КАК ЧИСЛО (31,2))
		|	КОНЕЦ) КАК НДС,
		|	СУММА(ВЫБОР КОГДА ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр КАК ЧИСЛО (31,2)) > Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр
		|			И Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр > 0
		|			И Т.ОСНО
		|		ТОГДА ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр КАК ЧИСЛО (31,2)) - 0.01
		|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр КАК ЧИСЛО (31,2))
		|	КОНЕЦ) КАК СтоимостьБезНДСУпр,
		|	СУММА(ВЫБОР КОГДА ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.НДСУпр КАК ЧИСЛО (31,2)) > Т.КоличествоУпр * Партии.НДСУпр
		|			И Т.КоличествоУпр * Партии.НДСУпр > 0
		|			И Т.ОСНО
		|		ТОГДА ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.НДСУпр КАК ЧИСЛО (31,2)) - 0.01
		|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.НДСУпр КАК ЧИСЛО (31,2))
		|	КОНЕЦ) КАК НДСУпр
		|ИЗ
		|	ВТДвиженияСебестоимостиДляСписаниеТоваров КАК Т
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты КАК Партии
		|		ПО Партии.Организация = Т.Организация
		|		И Партии.Партия = Т.Партия
		|		И Партии.АналитикаУчетаПартий = Т.АналитикаУчетаПартий
		|		И Партии.ВидЗапасов = Т.ВидЗапасов
		|		И Партии.Номенклатура = Т.Номенклатура
		|		И Партии.Характеристика = Т.Характеристика
		|		И (Т.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
		|			ИЛИ Т.АналитикаУчетаНоменклатуры = Партии.АналитикаУчетаНоменклатурыНЗП)
		|ГДЕ
		|	Партии.ПериодРегистрации < &НачалоПериода
		|
		|СГРУППИРОВАТЬ ПО
		|	Т.Регистратор,
		|	Т.Период,
		|	Т.Организация,
		|	Т.ВидДеятельностиНДС,
		|	Т.Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.АналитикаФинансовогоУчета,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.РазделУчета,
		|	Т.Подразделение,
		|	Т.СтатьяРасходов,
		|	Т.АналитикаРасходов,
		|	Партии.ДокументПоступления,
		|	Партии.АналитикаУчетаПартийДокументаПоступления,
		|	Т.НаправлениеДеятельности,
		|	Т.КорВидДеятельностиНДС,
		|	Т.ИдентификаторФинЗаписи,
		|	Т.ХозяйственнаяОперация
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	Т.Регистратор,
		|	Т.Период,
		|	Т.Организация,
		|	Т.ВидДеятельностиНДС,
		|	Т.Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.АналитикаФинансовогоУчета,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.РазделУчета,
		|	Т.Подразделение,
		|	Т.СтатьяРасходов,
		|	Т.АналитикаРасходов,
		|	Партии.ДокументПоступления КАК ДокументПоступления,
		|	Партии.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
		|	Т.НаправлениеДеятельности,
		|	Т.КорВидДеятельностиНДС,
		|	Т.ИдентификаторФинЗаписи,
		|	Т.ХозяйственнаяОперация,
		|	СУММА(ВЫБОР КОГДА ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл КАК ЧИСЛО (31,2)) > Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл
		|			И Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл > 0
		|			И Т.ОСНО
		|		ТОГДА ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл КАК ЧИСЛО (31,2)) - 0.01
		|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.СтоимостьБезНДСРегл КАК ЧИСЛО (31,2))
		|	КОНЕЦ) КАК СтоимостьБезНДС,
		|	СУММА(ВЫБОР КОГДА ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.НДСРегл КАК ЧИСЛО (31,2)) > Т.КоличествоРегл * Партии.НДСРегл
		|			И Т.КоличествоРегл * Партии.НДСРегл > 0
		|			И Т.ОСНО
		|		ТОГДА ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.НДСРегл КАК ЧИСЛО (31,2)) - 0.01
		|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоРегл * Партии.НДСРегл КАК ЧИСЛО (31,2))
		|	КОНЕЦ) КАК НДС,
		|	СУММА(ВЫБОР КОГДА ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр КАК ЧИСЛО (31,2)) > Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр
		|			И Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр > 0
		|			И Т.ОСНО
		|		ТОГДА ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр КАК ЧИСЛО (31,2)) - 0.01
		|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.СтоимостьБезНДСУпр КАК ЧИСЛО (31,2))
		|	КОНЕЦ) КАК СтоимостьБезНДСУпр,
		|	СУММА(ВЫБОР КОГДА ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.НДСУпр КАК ЧИСЛО (31,2)) > Т.КоличествоУпр * Партии.НДСУпр
		|			И Т.КоличествоУпр * Партии.НДСУпр > 0
		|			И Т.ОСНО
		|		ТОГДА ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.НДСУпр КАК ЧИСЛО (31,2)) - 0.01
		|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоУпр * Партии.НДСУпр КАК ЧИСЛО (31,2))
		|	КОНЕЦ) КАК НДСУпр
		|ИЗ
		|	ВТДвиженияСебестоимостиДляСписаниеТоваров КАК Т
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТЦеныСписанияТоваровПеременные КАК Партии
		|		ПО Партии.Партия = Т.Партия
		|		И Партии.Организация = Т.Организация
		|		И Партии.Номенклатура = Т.Номенклатура
		|		И Партии.РазделУчета = Т.РазделУчета
		|		И Партии.АналитикаУчетаНоменклатуры = Т.АналитикаУчетаНоменклатуры
		|		И Партии.ВидЗапасов = Т.ВидЗапасов
		|		И Партии.АналитикаУчетаПартий = Т.АналитикаУчетаПартий
		|		И Партии.ВидДеятельностиНДС = Т.ВидДеятельностиНДС
		|		И Партии.АналитикаФинансовогоУчета = Т.АналитикаФинансовогоУчета
		|		И Партии.ИдентификаторФинЗаписи = Т.ИдентификаторФинЗаписи
		|
		|СГРУППИРОВАТЬ ПО
		|	Т.Регистратор,
		|	Т.Период,
		|	Т.Организация,
		|	Т.ВидДеятельностиНДС,
		|	Т.Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.АналитикаФинансовогоУчета,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.РазделУчета,
		|	Т.Подразделение,
		|	Т.СтатьяРасходов,
		|	Т.АналитикаРасходов,
		|	Партии.ДокументПоступления,
		|	Партии.АналитикаУчетаПартийДокументаПоступления,
		|	Т.НаправлениеДеятельности,
		|	Т.КорВидДеятельностиНДС,
		|	Т.ИдентификаторФинЗаписи,
		|	Т.ХозяйственнаяОперация
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		// Отнесение отклонений в стоимости товаров на статьи расходов, распределяемые на себестоимость производства.
		// Движения по регистру "Партии прочих расходов" для таких расходов формируются в этапе "ПодготовкаДанныхДляПартийПрочихРасходов"
		// в процедуре ТекстПоступленияПартийПрочихРасходовИзСебестоимостьСписаниеТоваров().
		// Выборка данных должна соответствовать процедуре СформироватьДвиженияПоОтклонениямВСтоимостиТоваров() #Область ОтклоненияВСтоимостиПрочиеРасходы
		|ВЫБРАТЬ
		|	Т.Регистратор,
		|	Т.Период,
		|	Т.Организация,
		|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	Т.Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.АналитикаФинансовогоУчета,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.РазделУчета,
		|	Т.Подразделение,
		|	Т.СтатьяРасходовСписания КАК СтатьяРасходов,
		|	Т.АналитикаРасходов КАК АналитикаРасходов,
		|	Т.Регистратор КАК ДокументПоступления,
		|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартийДокументаПоступления,
		|	Т.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
		|	ВЫБОР КОГДА Т.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|		ТОГДА Т.ВидДеятельностиНДС
		|		ИНАЧЕ Т.КорВидДеятельностиНДС
		|	КОНЕЦ КАК КорВидДеятельностиНДС,
		|	Т.ИдентификаторФинЗаписи,
		|	Т.ХозяйственнаяОперация,
		|	СУММА(Т.СтоимостьРегл * Статьи.КоэффициентРегл) КАК СтоимостьБезНДС,
		|	СУММА(Т.НДСРегл * Статьи.КоэффициентРегл) КАК НДС,
		|	СУММА(Т.СтоимостьУпр * Статьи.КоэффициентУпр) КАК СтоимостьБезНДСУпр,
		|	СУММА(Т.НДСУпр * Статьи.КоэффициентУпр) КАК НДСУпр
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК Т
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТСтатьиПроизводственныхЗатрат КАК Статьи
		|		ПО Т.СтатьяРасходовСписания = Статьи.Ссылка
		|ГДЕ
		|	Т.Организация В(&ОрганизацииСРаздельнымУчетомПостатейныхЗатрат)
		|	И Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейпартий.ОтклонениеВСтоимостиНаПрочиеРасходы)
		|	И Т.РасчетПартий
		|	И НЕ Т.Сторно
		|
		|СГРУППИРОВАТЬ ПО
		|	Т.Регистратор,
		|	Т.Период,
		|	Т.Организация,
		|	Т.ВидДеятельностиНДС,
		|	Т.Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.АналитикаФинансовогоУчета,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.РазделУчета,
		|	Т.Подразделение,
		|	Т.СтатьяРасходовСписания,
		|	Т.АналитикаРасходов,
		|	Т.КорНаправлениеДеятельности,
		|	ВЫБОР КОГДА Т.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|		ТОГДА Т.ВидДеятельностиНДС
		|		ИНАЧЕ Т.КорВидДеятельностиНДС
		|	КОНЕЦ,
		|	Т.ИдентификаторФинЗаписи,
		|	Т.ХозяйственнаяОперация
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Т.Организация,
		|	Т.Подразделение,
		|	Т.СтатьяРасходов,
		|	Т.АналитикаРасходов,
		|	Т.НаправлениеДеятельности,
		|	СУММА(Т.Сумма) КАК Сумма,
		|	СУММА(Т.СуммаБезНДС) КАК СуммаБезНДС,
		|	СУММА(Т.СуммаРегл) КАК СуммаРегл
		|ПОМЕСТИТЬ ВТОстаткиПрочиеРасходыДляОтбора
		|ИЗ
		|	(ВЫБРАТЬ
		|		Т.Организация КАК Организация,
		|		Т.Подразделение КАК Подразделение,
		|		Т.СтатьяРасходов КАК СтатьяРасходов,
		|		Т.АналитикаРасходов КАК АналитикаРасходов,
		|		Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|		Т.СуммаОстаток КАК Сумма,
		|		Т.СуммаБезНДСОстаток КАК СуммаБезНДС,
		|		Т.СуммаРеглОстаток КАК СуммаРегл
		|	ИЗ
		|		РегистрНакопления.ПрочиеРасходы.Остатки(&НачалоПериода, Организация В(&ОрганизацииСРаздельнымУчетомПостатейныхЗатрат)) КАК Т
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		Т.Организация КАК Организация,
		|		Т.Подразделение КАК Подразделение,
		|		Т.СтатьяРасходов КАК СтатьяРасходов,
		|		Т.АналитикаРасходов КАК АналитикаРасходов,
		|		Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|		ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход ТОГДА Т.Сумма ИНАЧЕ -Т.Сумма КОНЕЦ КАК Сумма,
		|		ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход ТОГДА Т.СуммаБезНДС ИНАЧЕ -Т.СуммаБезНДС КОНЕЦ КАК СуммаБезНДС,
		|		ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход ТОГДА Т.СуммаРегл ИНАЧЕ -Т.СуммаРегл КОНЕЦ КАК СуммаРегл
		|	ИЗ
		|		ВТКэшРасчетныеОборотыПрочиеРасходы КАК Т
		|	ГДЕ
		|		НЕ Т.РасчетСебестоимости
		|	) КАК Т
		|СГРУППИРОВАТЬ ПО
		|	Т.Организация,
		|	Т.Подразделение,
		|	Т.СтатьяРасходов,
		|	Т.АналитикаРасходов,
		|	Т.НаправлениеДеятельности
		|ИМЕЮЩИЕ
		|	СУММА(Т.Сумма) <> 0
		|	ИЛИ СУММА(Т.СуммаБезНДС) <> 0
		|	ИЛИ СУММА(Т.СуммаРегл) <> 0
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Организация,
		|	СтатьяРасходов
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЛОЖЬ КАК ЭтоДопРасходы,
		|	Т.Регистратор КАК Регистратор,
		|	Т.Период КАК Период,
		|	Т.Организация КАК Организация,
		|	Т.Подразделение КАК Подразделение,
		|	Т.СтатьяРасходов КАК СтатьяРасходов,
		|	Т.АналитикаРасходов КАК АналитикаРасходов,
		|	Т.ДокументПоступленияРасходов КАК ДокументПоступления,
		|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартийДокументаПоступления,
		|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
		|	СУММА(Т.Стоимость * Статьи.КоэффициентУпр * ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход ТОГДА 1 ИНАЧЕ -1 КОНЕЦ * ВЫБОР КОГДА ЕСТЬNULL(ПрочиеРасходы.Сумма, 0) <> 0 ТОГДА 1 ИНАЧЕ 0 КОНЕЦ) КАК Стоимость,
		|	СУММА(Т.СтоимостьБезНДС * Статьи.КоэффициентУпр * ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход ТОГДА 1 ИНАЧЕ -1 КОНЕЦ * ВЫБОР КОГДА ЕСТЬNULL(ПрочиеРасходы.СуммаБезНДС, 0) <> 0 ТОГДА 1 ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьБезНДС,
		|	СУММА(Т.СтоимостьРегл * Статьи.КоэффициентРегл * ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход ТОГДА 1 ИНАЧЕ -1 КОНЕЦ * ВЫБОР КОГДА ЕСТЬNULL(ПрочиеРасходы.СуммаРегл, 0) <> 0 ТОГДА 1 ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьРегл,
		|	СУММА(Т.НДСРегл * Статьи.КоэффициентРегл * ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход ТОГДА 1 ИНАЧЕ -1 КОНЕЦ * ВЫБОР КОГДА ЕСТЬNULL(ПрочиеРасходы.СуммаРегл, 0) <> 0 ТОГДА 1 ИНАЧЕ 0 КОНЕЦ) КАК НДСРегл,
		|	СУММА(Т.НДСУпр * Статьи.КоэффициентУпр * ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход ТОГДА 1 ИНАЧЕ -1 КОНЕЦ * ВЫБОР КОГДА ЕСТЬNULL(ПрочиеРасходы.Сумма, 0) <> 0 ТОГДА 1 ИНАЧЕ 0 КОНЕЦ) КАК НДСУпр
		|ПОМЕСТИТЬ ВТПартииПрочихДляРаспределения2_4
		|ИЗ
		|	ВТКэшРасчетныеОборотыПартииПрочихРасходов КАК Т
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТСтатьиПроизводственныхЗатрат КАК Статьи
		|		ПО Т.СтатьяРасходов = Статьи.Ссылка
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОстаткиПрочиеРасходыДляОтбора КАК ПрочиеРасходы
		|		ПО Т.Организация = ПрочиеРасходы.Организация
		|		И Т.Подразделение = ПрочиеРасходы.Подразделение
		|		И Т.НаправлениеДеятельности = ПрочиеРасходы.НаправлениеДеятельности
		|		И Т.СтатьяРасходов = ПрочиеРасходы.СтатьяРасходов
		|		И Т.АналитикаРасходов = ПрочиеРасходы.АналитикаРасходов
		|ГДЕ
		|	Т.Организация В(&ОрганизацииСРаздельнымУчетомПостатейныхЗатрат)
		|
		|СГРУППИРОВАТЬ ПО
		|	Т.Регистратор,
		|	Т.Период,
		|	Т.Организация,
		|	Т.Подразделение,
		|	Т.СтатьяРасходов,
		|	Т.АналитикаРасходов,
		|	Т.ВидДеятельностиНДС,
		|	Т.ДокументПоступленияРасходов,
		|	Т.АналитикаУчетаПартий,
		|	Т.НаправлениеДеятельности,
		|	Т.ХозяйственнаяОперация
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЛОЖЬ КАК ЭтоДопРасходы,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	&НачалоПериода КАК Период,
		|	Т.Организация КАК Организация,
		|	Т.Подразделение КАК Подразделение,
		|	Т.СтатьяРасходов КАК СтатьяРасходов,
		|	Т.АналитикаРасходов КАК АналитикаРасходов,
		|	Т.ДокументПоступленияРасходов КАК ДокументПоступления,
		|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартийДокументаПоступления,
		|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	СУММА(Т.СтоимостьОстаток * Статьи.КоэффициентУпр) КАК Стоимость,
		|	СУММА(Т.СтоимостьБезНДСОстаток * Статьи.КоэффициентУпр) КАК СтоимостьБез,
		|	СУММА(Т.СтоимостьРеглОстаток * Статьи.КоэффициентРегл) КАК СтоимостьРегл,
		|	СУММА(Т.НДСРеглОстаток * Статьи.КоэффициентРегл) КАК НДСРегл,
		|	СУММА(Т.НДСУпрОстаток * Статьи.КоэффициентУпр) КАК НДСУпр
		|ИЗ
		|	РегистрНакопления.ПартииПрочихРасходов.Остатки(&ГраницаКонецПредыдущегоПериода,
		|		Организация В(&ОрганизацииСРаздельнымУчетомПостатейныхЗатрат)) КАК Т
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТСтатьиПроизводственныхЗатрат КАК Статьи
		|		ПО Т.СтатьяРасходов = Статьи.Ссылка
		|
		|СГРУППИРОВАТЬ ПО
		|	Т.Организация,
		|	Т.Подразделение,
		|	Т.СтатьяРасходов,
		|	Т.АналитикаРасходов,
		|	Т.ВидДеятельностиНДС,
		|	Т.ДокументПоступленияРасходов,
		|	Т.АналитикаУчетаПартий,
		|	Т.НаправлениеДеятельности
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЛОЖЬ КАК ЭтоДопРасходы,
		|	Т.Регистратор КАК Регистратор,
		|	Т.Период КАК Период,
		|	Т.Организация КАК Организация,
		|	Т.Подразделение КАК Подразделение,
		|	Т.СтатьяРасходов КАК СтатьяРасходов,
		|	Т.АналитикаРасходов КАК АналитикаРасходов,
		|	Т.ДокументПоступления КАК ДокументПоступления,
		|	Т.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
		|	Т.КорВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
		|	СУММА(Т.СтоимостьБезНДСУпр + Т.НДСУпр) КАК Стоимость,
		|	СУММА(Т.СтоимостьБезНДСУпр) КАК СтоимостьБезНДС,
		|	СУММА(Т.СтоимостьБезНДС) КАК СтоимостьРегл,
		|	СУММА(Т.НДС) КАК НДСРегл,
		|	СУММА(Т.НДСУпр) КАК НДСУпр
		|ИЗ
		|	ВТСебестоимостьСписаниеТоваров КАК Т
		|СГРУППИРОВАТЬ ПО
		|	Т.Регистратор,
		|	Т.Период,
		|	Т.Организация,
		|	Т.Подразделение,
		|	Т.СтатьяРасходов,
		|	Т.АналитикаРасходов,
		|	Т.ДокументПоступления,
		|	Т.АналитикаУчетаПартийДокументаПоступления,
		|	Т.КорВидДеятельностиНДС,
		|	Т.НаправлениеДеятельности,
		|	Т.ХозяйственнаяОперация
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ИСТИНА КАК ЭтоДопРасходы,
		|	Т.Регистратор КАК Регистратор,
		|	Т.Период КАК Период,
		|	Т.Организация КАК Организация,
		|	Т.КорПодразделение КАК Подразделение,
		|	Т.КорСтатьяРасходов КАК СтатьяРасходов,
		|	Т.КорАналитикаРасходов КАК АналитикаРасходов,
		|	Т.ДокументПоступления КАК ДокументПоступления,
		|	Т.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
		|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	Т.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
		|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
		|	СУММА(ВЫРАЗИТЬ(ЕСТЬNULL(Коэффициенты.Коэффициент, 1) * Т.СтоимостьСНДС КАК ЧИСЛО(31,2))) КАК Стоимость,
		|	СУММА(ВЫРАЗИТЬ(ЕСТЬNULL(Коэффициенты.Коэффициент, 1) * Т.СтоимостьБезНДС КАК ЧИСЛО(31,2))) КАК СтоимостьБезНДС,
		|	СУММА(ВЫРАЗИТЬ(ЕСТЬNULL(Коэффициенты.Коэффициент, 1) * Т.СтоимостьБезНДСРегл КАК ЧИСЛО(31,2))) КАК СтоимостьРегл,
		|	СУММА(ВЫРАЗИТЬ(ЕСТЬNULL(Коэффициенты.Коэффициент, 1) * 
		|		ВЫБОР КОГДА Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|			ТОГДА 0
		|		ИНАЧЕ Т.НДСРегл КОНЕЦ КАК ЧИСЛО(31,2))) КАК НДСРегл,
		|	СУММА(ВЫРАЗИТЬ(ЕСТЬNULL(Коэффициенты.Коэффициент, 1) * 
		|		ВЫБОР КОГДА Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|			ТОГДА 0
		|		ИНАЧЕ Т.НДСУпр КОНЕЦ КАК ЧИСЛО(31,2))) КАК НДСУпр
		|ИЗ
		|	ВТДопРасходыДляПостатейныхЗатрат КАК Т
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТСтатьиПроизводственныхЗатрат КАК Статьи
		|		ПО Т.КорСтатьяРасходов = Статьи.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаноменклатуры КАК Отбор
		|		ПО Т.АналитикаУчетаНоменклатуры = Отбор.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТКоэффициентыДопРасходов КАК Коэффициенты
		|		ПО Т.Организация = Коэффициенты.Организация
		|		И Т.РазделУчета = Коэффициенты.РазделУчета
		|		И Т.АналитикаУчетаНоменклатуры = Коэффициенты.АналитикаУчетаНоменклатуры
		|		И Т.ВидЗапасов = Коэффициенты.ВидЗапасов
		|		И Т.Партия = Коэффициенты.Партия
		|		И Т.АналитикаУчетаПартий = Коэффициенты.АналитикаУчетаПартий
		|		И Т.ВидДеятельностиНДС = Коэффициенты.ВидДеятельностиНДС
		|		И Т.АналитикаФинансовогоУчета = Коэффициенты.АналитикаФинансовогоУчета
		|		И Т.Регистратор = Коэффициенты.Регистратор
		|ГДЕ
		|	Отбор.Ссылка ЕСТЬ NULL
		|	И Т.Организация В(&ОрганизацииСРаздельнымУчетомПостатейныхЗатрат)
		|	И Т.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|СГРУППИРОВАТЬ ПО
		|	Т.Регистратор,
		|	Т.Период,
		|	Т.Организация,
		|	Т.КорПодразделение,
		|	Т.КорСтатьяРасходов,
		|	Т.КорАналитикаРасходов,
		|	Т.ДокументПоступления,
		|	Т.АналитикаУчетаПартийДокументаПоступления,
		|	Т.ВидДеятельностиНДС,
		|	Т.КорНаправлениеДеятельности,
		|	Т.ХозяйственнаяОперация
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	СтатьяРасходов,
		|	Организация
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ ПЕРВЫЕ 1
		|	ИСТИНА КАК ЕстьЗаписи
		|ПОМЕСТИТЬ ВыполнятьРаспределениеПартийНДС2_4
		|ИЗ
		|	ВТПартииПрочихДляРаспределения2_4 КАК Т
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Т.Организация КАК Организация,
		|	Т.Подразделение КАК Подразделение,
		|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	Т.СтатьяРасходов КАК СтатьяРасходов,
		|	Т.АналитикаРасходов КАК АналитикаРасходов
		|ПОМЕСТИТЬ ВТАналитикиРаспределенияПартийПрочих2_4
		|ИЗ
		|	ВТПартииПрочихДляРаспределения2_4 КАК Т
		|";
КонецФункции

Функция ТекстДвиженияСебестоимостиНДСФИФОСкользящая()
	Возврат "
		|ВЫБРАТЬ
		|	ВЫБОР
		//++ Устарело_Переработка24
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		//-- Устарело_Переработка24
		
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщика)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПеремещениеАвто)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|
		|		ИНАЧЕ ДД.ТипЗаписи
		|	КОНЕЦ КАК ТипЗаписи,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения) ТОГДА ЛОЖЬ
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК ЭтоСторно,
		|	МАКСИМУМ(ЕСТЬNULL(Знаменатели.Знаменатель, 0))
		|		+ СУММА(ВЫБОР
		|			КОГДА ЕСТЬNULL(Знаменатели.Знаменатель, 0) <> 0
		|				ТОГДА 0
		|				ИНАЧЕ ВЫРАЗИТЬ(
		|						ВЫРАЗИТЬ(ДД.Количество КАК ЧИСЛО(15, 3))
		|						* ВЫРАЗИТЬ(ЕСТЬNULL(Цены.СтоимостьРегл, ЕСТЬNULL(ПлановыеЦены.Цена, 0)) КАК ЧИСЛО(31, 10))
		|					  КАК ЧИСЛО(31,2))
		|		  КОНЕЦ) КАК Знаменатель,
		|	МАКСИМУМ(ЕСТЬNULL(Знаменатели.ЗнаменательДляИсточников, 0)) КАК ЗнаменательДляИсточников,
		|	СУММА(ДД.Количество) КАК Количество,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	ДД.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
		|	
		|	ДД.Период,
		|	ДД.Регистратор КАК Регистратор,
		|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|		 ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ КАК ВидДвижения,
		|	ДД.Организация КАК Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ВЫБОР
		|		КОГДА ИСТИНА
		|			ТОГДА ДД.Партия
		|	КОНЕЦ КАК Партия,
		|	ЕСТЬNULL(АналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)) КАК АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС КАК КорВидДеятельностиНДС,
		|	ДД.КорОрганизация,
		|	ВЫБОР
		|		КОГДА ИСТИНА
		|			ТОГДА ДД.КорПартия
		|	КОНЕЦ КАК КорПартия,
		|	ЕСТЬNULL(КорАналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)) КАК КорАналитикаУчетаПартий,
		|	ЕСТЬNULL(ДД.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ДД.КорНаправлениеДеятельности) КАК КорНаправлениеДеятельности,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов КАК КорВидЗапасов,
		|	ДД.Подразделение,
		|	(ВЫБОР
		|		КОГДА ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|		 И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.СтатьяРасходовСписания
		|		КОГДА ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
		|			ТОГДА ДД.СтатьяАктивовПассивов
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов КАК АналитикаАктивов,
		|	(ВЫБОР
		//++ Устарело_Переработка24
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика)
		|			ТОГДА ДД.Регистратор
		//-- Устарело_Переработка24
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика2_5)
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение))
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ) КАК ДокументИсточник,
		|	ДД.РазделУчета КАК РазделУчета,
		|	ДД.КорРазделУчета КАК КорРазделУчета,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.Сторно
		|ПОМЕСТИТЬ ДвиженияСебестоимостиНДС2_4
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ЗнаменателиПриходов КАК Знаменатели
		|		ПО Знаменатели.Регистратор = ДД.Регистратор
		|		И Знаменатели.Организация = ДД.Организация
		|		И Знаменатели.Партия = ДД.Партия
		|		И Знаменатели.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|		И Знаменатели.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Знаменатели.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|		И Знаменатели.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Знаменатели.ВидЗапасов = ДД.ВидЗапасов
		|		И Знаменатели.РазделУчета = ДД.РазделУчета
		|		И ДД.СлужебноеВидДвиженияПриход
		|		И НЕ (ДД.Сторно И ДД.Количество < 0)
		|		И ВЫБОР КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией))
		|			ТОГДА ИСТИНА
		|			ИНАЧЕ ЛОЖЬ
		|		  КОНЕЦ = Знаменатели.ЭтоДопРасходы
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРасчетныеЦены КАК Цены
		|		ПО Цены.Организация = ДД.Организация
		|		И Цены.Партия = ДД.Партия
		|		И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|		И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|		И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Цены.ВидЗапасов = ДД.ВидЗапасов
		|		И Цены.РазделУчета = ДД.РазделУчета
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТПлановыеЦены КАК ПлановыеЦены
		|		ПО ПлановыеЦены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОтборАналитикиУчетаПартийНДС2_4 КАК АналитикиУчетаПартий
		|		ПО ДД.АналитикаУчетаПартий = АналитикиУчетаПартий.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОтборАналитикиУчетаПартийНДС2_4 КАК КорАналитикиУчетаПартий
		|		ПО ДД.КорАналитикаУчетаПартий = КорАналитикиУчетаПартий.Ссылка
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И ДД.Партия <> НЕОПРЕДЕЛЕНО
		|	И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
		|	И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииФиксированнаяСтоимость)
		|	И ВЫБОР
		|		КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПотреблениеАвто),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПотреблениеПроизводство),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Распределение),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратНаДругойСклад))
		|			И ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|				= ЕСТЬNULL(ДД.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|			И ДД.ВидДеятельностиНДС         = ДД.КорВидДеятельностиНДС
		|			И ДД.Партия         			= ДД.КорПартия
		|			И (ДД.КорОрганизация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
		|				ИЛИ ДД.Организация = ДД.КорОрганизация)
		|			И ДД.КорРазделУчета	<> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		|			ТОГДА ЛОЖЬ
		|			
		|		КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПеремещениеОбособленно),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПеремещениеАвто),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Сторно),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СторноВозвратНаДругойСклад))
		|			И ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|				= ЕСТЬNULL(ДД.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|			И ДД.ВидДеятельностиНДС         = ДД.КорВидДеятельностиНДС
		|			И ДД.Партия         			= ДД.КорПартия
		|			И (ДД.КорОрганизация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
		|				ИЛИ ДД.Организация = ДД.КорОрганизация)
		|			ТОГДА ЛОЖЬ
		|			
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости)
		|			ТОГДА ЛОЖЬ
		|			
		|		ИНАЧЕ ИСТИНА
		|	КОНЕЦ = ИСТИНА
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И НЕ ДД.РазделУчета В (
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажи),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажиПереданныеПартнерам),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажиКОформлениюСписания),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки))
		|	И НЕ (ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		И ДД.ВидЗапасов.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца))
		|	И (НЕ ДД.ТипЗаписи В (
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов))
		|	  )
		|	И НЕ (ДД.Регистратор ССЫЛКА Документ.ПересортицаТоваров И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение))
		|	И НЕ (ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|		И ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|		И ДД.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением))
		|
		|СГРУППИРОВАТЬ ПО
		|	ВЫБОР
		//++ Устарело_Переработка24
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		//-- Устарело_Переработка24
		
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщика)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПеремещениеАвто)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|
		|		ИНАЧЕ ДД.ТипЗаписи
		|	КОНЕЦ,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения) ТОГДА ЛОЖЬ
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ),
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура,
		|	ДД.АналитикаУчетаНоменклатуры.Характеристика,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|	ЕСТЬNULL(ДД.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ДД.КорНаправлениеДеятельности),
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|		 ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ВЫБОР
		|		КОГДА ИСТИНА
		|			ТОГДА ДД.Партия
		|	КОНЕЦ,
		|	ЕСТЬNULL(АналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)),
		|	ДД.ВидДеятельностиНДС,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорОрганизация,
		|	ВЫБОР
		|		КОГДА ИСТИНА
		|			ТОГДА ДД.КорПартия
		|	КОНЕЦ,
		|	ЕСТЬNULL(ДД.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|	ДД.Подразделение,
		|	(ВЫБОР
		|		КОГДА ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|		 И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.СтатьяРасходовСписания
		|		КОГДА ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
		|			ТОГДА ДД.СтатьяАктивовПассивов
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	(ВЫБОР
		//++ Устарело_Переработка24
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика)
		|			ТОГДА ДД.Регистратор
		//-- Устарело_Переработка24
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика2_5)
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение))
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ),
		|	ДД.РазделУчета,
		|	ДД.КорРазделУчета,
		|	ЕСТЬNULL(КорАналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)),
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.Сторно
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СУММА(ВЫБОР КОГДА ДД.Знаменатель <> 0
		|			ТОГДА ДД.Знаменатель
		|			ИНАЧЕ ЕСТЬNULL(Знаменатели.Знаменатель, ЕСТЬNULL(ЗнаменателиПартий.Знаменатель, 0))
		|		КОНЕЦ) КАК Знаменатель,
		|	ДД.Период,
		|	ДД.Регистратор КАК Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|			И ДД.КорАналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|		ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ ДД.КорАналитикаУчетаНоменклатуры
		|	КОНЕЦ КАК КорАналитикаУчетаНоменклатуры,
		|	ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|			И ДД.КорВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|		ТОГДА ДД.ВидЗапасов
		|		ИНАЧЕ ДД.КорВидЗапасов
		|	КОНЕЦ КАК КорВидЗапасов,
		|	ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|		 И ДД.Партия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.Партия
		|	КОНЕЦ КАК Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.НаправлениеДеятельности,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаУчетаПартий,
		|	ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|			И ДД.КорНаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|		ТОГДА ДД.НаправлениеДеятельности
		|		ИНАЧЕ ДД.КорНаправлениеДеятельности
		|	КОНЕЦ КАК КорНаправлениеДеятельности,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.РазделУчета,
		|	ДД.АналитикаФинансовогоУчета
		|ПОМЕСТИТЬ ДвиженияСебестоимостиНДС2_4ДляРаспределения
		|ИЗ
		|	ДвиженияСебестоимостиНДС2_4 КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ЗнаменателиРегистраторов КАК Знаменатели
		|		ПО Знаменатели.Регистратор = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ ЗнаменателиПартий КАК ЗнаменателиПартий
		|		ПО ЗнаменателиПартий.Партия = ДД.Партия
		|ГДЕ
		|	ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|	И (ИСТИНА В (ВЫБРАТЬ Т.ЕстьЗаписи ИЗ ВыполнятьРаспределениеПартийНДС2_4 КАК Т)
		|	)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|			И ДД.КорАналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|		ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ ДД.КорАналитикаУчетаНоменклатуры
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|			И ДД.КорВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|		ТОГДА ДД.ВидЗапасов
		|		ИНАЧЕ ДД.КорВидЗапасов
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|		 И ДД.Партия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.Партия
		|	КОНЕЦ,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.НаправлениеДеятельности,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаУчетаПартий,
		|	ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|			И ДД.КорНаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|		ТОГДА ДД.НаправлениеДеятельности
		|		ИНАЧЕ ДД.КорНаправлениеДеятельности
		|	КОНЕЦ,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.РазделУчета,
		|	ДД.АналитикаФинансовогоУчета
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор
		|";
	КонецФункции
	

Функция ТекстЗапросаРаспределенияПартийНДС(ИмяТаблицыДанных, ИмяТаблицыСвязей)
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	Т.К,
	|	Т.НомерУзла,
	|	Т.ЧастичноОставитьВНЗП,
	|	Т.Знаменатель,
	|	Т.ЗнаменательУпр,
	|	Т.СтоимостьСНДС,
	|	Т.СтоимостьБезНДС,
	|	Т.СтоимостьБезНДСРегл,
	|	Т.НДСРегл,
	|	Т.НДСУпр
	|ПОМЕСТИТЬ ТаблицаДанныхИндексированная
	|ИЗ
	|	ИмяТаблицыДанных КАК Т
	|ИНДЕКСИРОВАТЬ ПО
	|	К
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Связи.Источник КАК Источник,
	|	Приемники.НомерУзла КАК Приемник,
	|	Приемники.Знаменатель,
	|	Приемники.ЗнаменательУпр
	|ПОМЕСТИТЬ ВТЗнаменателиПриемников
	|ИЗ
	|	ИмяТаблицыСвязей КАК Связи
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаДанныхИндексированная КАК Приемники
	|		ПО Связи.Приемник = Приемники.К
	|ИНДЕКСИРОВАТЬ ПО
	|	Источник
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Источники.НомерУзла КАК Источник,
	|	Приемники.Приемник КАК Приемник,
	|	Источники.ЧастичноОставитьВНЗП,
	|	Приемники.Знаменатель,
	|	Приемники.ЗнаменательУпр,
	|
	|	Источники.СтоимостьСНДС КАК СтоимостьСНДСИсходная,
	|	Источники.СтоимостьБезНДС КАК СтоимостьБезНДСИсходная,
	|	Источники.СтоимостьБезНДСРегл КАК СтоимостьБезНДСРеглИсходная,
	|	Источники.НДСРегл КАК НДСРеглИсходная,
	|	Источники.НДСУпр КАК НДСУпрИсходная,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА Источники.ЗнаменательУпр = 0
	|				ТОГДА 0
	|			ИНАЧЕ Источники.СтоимостьСНДС * ВЫРАЗИТЬ(Приемники.ЗнаменательУпр / Источники.ЗнаменательУпр КАК ЧИСЛО(23,10))
	|		КОНЕЦ КАК ЧИСЛО(31, 2)) КАК СтоимостьСНДС,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА Источники.ЗнаменательУпр = 0
	|				ТОГДА 0
	|			ИНАЧЕ Источники.СтоимостьБезНДС * ВЫРАЗИТЬ(Приемники.ЗнаменательУпр / Источники.ЗнаменательУпр КАК ЧИСЛО(23,10))
	|		КОНЕЦ КАК ЧИСЛО(31, 2)) КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА Источники.ЗнаменательУпр = 0
	|				ТОГДА 0
	|			ИНАЧЕ Источники.НДСУпр * ВЫРАЗИТЬ(Приемники.ЗнаменательУпр / Источники.ЗнаменательУпр КАК ЧИСЛО(23,10))
	|		КОНЕЦ КАК ЧИСЛО(31, 2)) КАК НДСУпр,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА Источники.Знаменатель = 0
	|				ТОГДА 0
	|			ИНАЧЕ Источники.СтоимостьБезНДСРегл * ВЫРАЗИТЬ(Приемники.Знаменатель / Источники.Знаменатель КАК ЧИСЛО(23,10))
	|		КОНЕЦ КАК ЧИСЛО(31, 2)) КАК СтоимостьБезНДСРегл,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА Источники.Знаменатель = 0
	|				ТОГДА 0
	|			ИНАЧЕ Источники.НДСРегл * ВЫРАЗИТЬ(Приемники.Знаменатель / Источники.Знаменатель КАК ЧИСЛО(23,10))
	|		КОНЕЦ КАК ЧИСЛО(31, 2)) КАК НДСРегл
	|ПОМЕСТИТЬ ВТРаспределениеПредварительное
	|ИЗ
	|	ВТЗнаменателиПриемников КАК Приемники
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаДанныхИндексированная КАК Источники
	|		ПО Приемники.Источник = Источники.К
	|ГДЕ
	|	(Приемники.ЗнаменательУпр <> 0
	|		И Источники.ЗнаменательУпр <> 0
	|		И (Источники.СтоимостьСНДС <> 0
	|			ИЛИ Источники.СтоимостьБезНДС <> 0
	|			ИЛИ Источники.НДСУпр <> 0))
	|	ИЛИ
	|	(Приемники.Знаменатель <> 0
	|		И Источники.Знаменатель <> 0
	|		И (Источники.СтоимостьБезНДСРегл <> 0
	|			ИЛИ Источники.НДСРегл <> 0))
	|ИНДЕКСИРОВАТЬ ПО
	|	Источник
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	| УНИЧТОЖИТЬ ТаблицаДанныхИндексированная
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Источник,
	|	МАКСИМУМ(Т.СтоимостьСНДСИсходная) - СУММА(Т.СтоимостьСНДС) КАК СтоимостьСНДС,
	|	МАКСИМУМ(Т.СтоимостьБезНДСИсходная) - СУММА(Т.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	МАКСИМУМ(Т.СтоимостьБезНДСРеглИсходная) - СУММА(Т.СтоимостьБезНДСРегл) КАК СтоимостьБезНДСРегл,
	|	МАКСИМУМ(Т.НДСРеглИсходная) - СУММА(Т.НДСРегл) КАК НДСРегл,
	|	МАКСИМУМ(Т.НДСУпрИсходная) - СУММА(Т.НДСУпр) КАК НДСУпр
	|ПОМЕСТИТЬ ВТРаспределениеКопейки
	|ИЗ
	|	ВТРаспределениеПредварительное КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.Источник
	|ИМЕЮЩИЕ
	|	МАКСИМУМ(Т.ЧастичноОставитьВНЗП) = ЛОЖЬ
	|	И (МАКСИМУМ(Т.СтоимостьСНДСИсходная) - СУММА(Т.СтоимостьСНДС) <> 0
	|		ИЛИ МАКСИМУМ(Т.СтоимостьБезНДСИсходная) - СУММА(Т.СтоимостьБезНДС) <> 0
	|		ИЛИ МАКСИМУМ(Т.СтоимостьБезНДСРеглИсходная) - СУММА(Т.СтоимостьБезНДСРегл) <> 0
	|		ИЛИ МАКСИМУМ(Т.НДСРеглИсходная) - СУММА(Т.НДСРегл) <> 0
	|		ИЛИ МАКСИМУМ(Т.НДСУпрИсходная) - СУММА(Т.НДСУпр) <> 0)
	|ИНДЕКСИРОВАТЬ ПО
	|	Источник
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Источник,
	|	Т.Приемник,
	|	СУММА(Т.СтоимостьСНДС) КАК СтоимостьСНДС,
	|	СУММА(Т.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	СУММА(Т.СтоимостьБезНДСРегл) КАК СтоимостьБезНДСРегл,
	|	СУММА(Т.НДСРегл) КАК НДСРегл,
	|	СУММА(Т.НДСУпр) КАК НДСУпр
	|ПОМЕСТИТЬ ВТРаспределение
	|ИЗ
	|	(ВЫБРАТЬ
	|		Т.Источник,
	|		Т.Приемник,
	|		Т.СтоимостьСНДС,
	|		Т.СтоимостьБезНДС,
	|		Т.СтоимостьБезНДСРегл,
	|		Т.НДСРегл,
	|		Т.НДСУпр
	|	ИЗ
	|		ВТРаспределениеПредварительное КАК Т
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Т.Источник,
	|		МИНИМУМ(Т.Приемник) КАК Приемник,
	|		0,
	|		0,
	|		Копейки.СтоимостьБезНДСРегл,
	|		Копейки.НДСРегл,
	|		0
	|	ИЗ
	|		ВТРаспределениеПредварительное КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТРаспределениеКопейки КАК Копейки
	|			ПО Т.Источник = Копейки.Источник
	|			И Т.Знаменатель <> 0
	|	СГРУППИРОВАТЬ ПО
	|		Т.Источник,
	|		Копейки.СтоимостьБезНДСРегл,
	|		Копейки.НДСРегл
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Т.Источник,
	|		МИНИМУМ(Т.Приемник) КАК Приемник,
	|		Копейки.СтоимостьСНДС,
	|		Копейки.СтоимостьБезНДС,
	|		0,
	|		0,
	|		Копейки.НДСУпр
	|	ИЗ
	|		ВТРаспределениеПредварительное КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТРаспределениеКопейки КАК Копейки
	|			ПО Т.Источник = Копейки.Источник
	|			И Т.ЗнаменательУпр <> 0
	|	СГРУППИРОВАТЬ ПО
	|		Т.Источник,
	|		Копейки.СтоимостьСНДС,
	|		Копейки.СтоимостьБезНДС,
	|		Копейки.НДСУпр
	|) КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.Источник,
	|	Т.Приемник
	|ИМЕЮЩИЕ
	|	СУММА(Т.СтоимостьСНДС) <> 0
	|	ИЛИ СУММА(Т.СтоимостьБезНДС) <> 0
	|	ИЛИ СУММА(Т.СтоимостьБезНДСРегл) <> 0
	|	ИЛИ СУММА(Т.НДСРегл) <> 0
	|	ИЛИ СУММА(Т.НДСУпр) <> 0
	|ИНДЕКСИРОВАТЬ ПО
	|	Источник
	|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ИмяТаблицыДанных", ИмяТаблицыДанных);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ИмяТаблицыСвязей", ИмяТаблицыСвязей);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Процедура СформироватьПромежуточныйРезультатРаспределенияПартийНДС(ПараметрыРасчета, Запрос, НомерШага)
	
	ТипыЗаписейДополнения = Новый Массив;
	
	ВозможноСписаниеНДС = (РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(ПараметрыРасчета, "ВТНастройкиСписанияНДС") > 0);
	
	Если НомерШага = 1 Тогда // доп. расходы по базе
		
		Пояснение = НСтр("ru = 'Доп. расходы по базе'", ОбщегоНазначения.КодОсновногоЯзыка());
		
		ИмяТаблицыИсточникаДанных = "ВТДанныеПостатейныеЗатратыПоУзлу";
		ИмяТаблицыРезультатаПредварительная = "ВТРезультатШаг1Предварительная";
		ИмяТаблицыРезультата = "ВТРезультатШаг1";
		ИмяТаблицыСвязей = "ВТСвязи1";
		
		ИмяПоляЗнаменательРегл = "Т.ЗнаменательДляИсточников";
		ИмяПоляЗнаменательУпр = "Т.ЗнаменательДляИсточниковУпр";
		ИмяПоляПартия = "Т.Партия";
		ИмяПоляАналитикаУчетаПартий = "Т.АналитикаУчетаПартий";
		ИмяПоляСтатьяКалькуляции = "Т.СтатьяКалькуляции";
		ИмяПоляГруппаПродукции = "Т.ГруппаПродукции";
		ИмяПоляПравилоОтнесенияНаВыпуск = "Т.ПравилоОтнесенияНаВыпуск";
		ИмяПоляХозяйственнаяОперация = "Источники.ХозяйственнаяОперация";
		ИмяПоляКорВидДеятельностиНДС = "Источники.ВидДеятельностиНДС";
		ИмяПоляПодразделение = "Источники.Подразделение";
		ИмяПоляКорПодразделение = "Т.КорПодразделение";
		ИмяПоляАналитикаСписанияНДС = "Источники.АналитикаСписанияНДС";
		
		ТекстУсловиеРегистратор = "ИСТИНА";
		ИмяПоляИндекса = "К";
		
		ТипЗаписиРезультата = Перечисления.ТипыЗаписейПартий.ДопРасходы;
		
		ТипыЗаписейДополнения.Добавить(Перечисления.ТипыЗаписейПартий.ОстатокНЗП); // еще не обработанные записи
		ТипыЗаписейДополнения.Добавить(Перечисления.ТипыЗаписейПартий.СписанияНаВыпускПостатейные); // еще не обработанные записи
		ТипыЗаписейДополнения.Добавить(Перечисления.ТипыЗаписейПартий.Выпуск); // еще не обработанные записи
		
	ИначеЕсли НомерШага = 2 Тогда // доп. расходы по списанию на выпуск
		
		Пояснение = НСтр("ru = 'Доп. расходы по списанию на выпуск'", ОбщегоНазначения.КодОсновногоЯзыка());
		
		ИмяТаблицыИсточникаДанных = "ВТРезультатШаг1";
		ИмяТаблицыРезультатаПредварительная = "ВТРезультатШаг2Предварительная";
		ИмяТаблицыРезультата = "ВТРезультатШаг2";
		ИмяТаблицыСвязей = "ВТСвязи2";
		
		ИмяПоляЗнаменательРегл = "Т.Знаменатель";
		ИмяПоляЗнаменательУпр = "Т.ЗнаменательУпр";
		ИмяПоляПартия = "ВЫБОР КОГДА Т.Партия = НЕОПРЕДЕЛЕНО ТОГДА Источники.Партия ИНАЧЕ Т.Партия КОНЕЦ";
		ИмяПоляАналитикаУчетаПартий = "ВЫБОР КОГДА Т.Партия = НЕОПРЕДЕЛЕНО ТОГДА Источники.АналитикаУчетаПартий ИНАЧЕ Т.АналитикаУчетаПартий КОНЕЦ";
		ИмяПоляСтатьяКалькуляции = "Источники.СтатьяКалькуляции";
		ИмяПоляГруппаПродукции = "Источники.ГруппаПродукции";
		ИмяПоляПравилоОтнесенияНаВыпуск = "Источники.ПравилоОтнесенияНаВыпуск";
		ИмяПоляХозяйственнаяОперация = "Т.ХозяйственнаяОперация";
		ИмяПоляКорВидДеятельностиНДС = "Т.КорВидДеятельностиНДС";
		ИмяПоляПодразделение = "Т.Подразделение";
		ИмяПоляКорПодразделение = "Источники.КорПодразделение";
		ИмяПоляАналитикаСписанияНДС = "Т.АналитикаСписанияНДС";
		
		ТекстУсловиеРегистратор = "ИСТИНА";
		ИмяПоляИндекса = "К";
		
		ТипЗаписиРезультата = Перечисления.ТипыЗаписейПартий.СписанияНаВыпускПостатейные;
		
		ТипыЗаписейДополнения.Добавить(Перечисления.ТипыЗаписейПартий.ДопРасходы); // результат предыдущего шага
		ТипыЗаписейДополнения.Добавить(Перечисления.ТипыЗаписейПартий.Выпуск); // еще не обработанные записи
		
	Иначе // доп. расходы по выпуску
		
		Пояснение = НСтр("ru = 'Доп. расходы по выпуску'", ОбщегоНазначения.КодОсновногоЯзыка());
		
		ИмяТаблицыИсточникаДанных = "ВТРезультатШаг2";
		ИмяТаблицыРезультатаПредварительная = "ВТСписаниеПостатейныхЗатратПредварительная";
		ИмяТаблицыРезультата = "ВТСписаниеПостатейныхЗатрат";
		ИмяТаблицыСвязей = "ВТСвязи3";
		
		ИмяПоляЗнаменательРегл = "Т.Знаменатель";
		ИмяПоляЗнаменательУпр = "Т.ЗнаменательУпр";
		ИмяПоляПартия = "ВЫБОР КОГДА Т.Партия = НЕОПРЕДЕЛЕНО ТОГДА Источники.Партия ИНАЧЕ Т.Партия КОНЕЦ";
		ИмяПоляАналитикаУчетаПартий = "ВЫБОР КОГДА Т.Партия = НЕОПРЕДЕЛЕНО ТОГДА Источники.АналитикаУчетаПартий ИНАЧЕ Т.АналитикаУчетаПартий КОНЕЦ";
		ИмяПоляСтатьяКалькуляции = "Источники.СтатьяКалькуляции";
		ИмяПоляГруппаПродукции = "Источники.ГруппаПродукции";
		ИмяПоляПравилоОтнесенияНаВыпуск = "Источники.ПравилоОтнесенияНаВыпуск";
		ИмяПоляХозяйственнаяОперация = "Т.ХозяйственнаяОперация";
		ИмяПоляКорВидДеятельностиНДС = "Т.КорВидДеятельностиНДС";
		ИмяПоляПодразделение = "Т.Подразделение";
		ИмяПоляКорПодразделение = "Источники.КорПодразделение";
		ИмяПоляАналитикаСписанияНДС = "Т.АналитикаСписанияНДС";
		
		ТекстУсловиеРегистратор = "Т.Регистратор <> НЕОПРЕДЕЛЕНО";
		ИмяПоляИндекса = "Регистратор, АналитикаУчетаНоменклатуры, Партия, ДокументПоступления";
		
		ТипЗаписиРезультата = Перечисления.ТипыЗаписейПартий.Выпуск;
		
		ТипыЗаписейДополнения.Добавить(Перечисления.ТипыЗаписейПартий.ДопРасходы); // результат предыдущего шага
		ТипыЗаписейДополнения.Добавить(Перечисления.ТипыЗаписейПартий.СписанияНаВыпускПостатейные); // результат предыдущего шага
		
	КонецЕсли;
	
	Запрос.Текст = ТекстЗапросаРаспределенияПартийНДС(ИмяТаблицыИсточникаДанных, ИмяТаблицыСвязей);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(
		ПараметрыРасчета,
		Запрос,,,,
		Пояснение);
	
	Запрос.УстановитьПараметр("ТипыЗаписейДополнения", ТипыЗаписейДополнения);
	Запрос.УстановитьПараметр("ТипЗаписиРезультата", ТипЗаписиРезультата);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.К,
	|	Источники.Приемник,
	|	Т.ТипЗаписи,
	|	Т.ЧастичноОставитьВНЗП,
	|	Т.Знаменатель,
	|	Т.ЗнаменательУпр,
	|	Т.ЗнаменательДляИсточников,
	|	Т.ЗнаменательДляИсточниковУпр,
	|	Т.КорАналитикаУчетаНоменклатуры,
	|	Т.КорВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.ДокументПоступленияВТекущемПериоде,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.ХозяйственнаяОперация,
	|	Т.КорВидДеятельностиНДС,
	|	Т.Подразделение,
	|	Т.КорПодразделение,
	|	Т.СтатьяРасходовАктивов,
	|	Т.АналитикаРасходов,
	|	Т.АналитикаСписанияНДС,
	|
	|	Источники.СтоимостьСНДС,
	|	Источники.СтоимостьБезНДС,
	|	Источники.СтоимостьБезНДСРегл,
	|	Источники.НДСРегл,
	|	Источники.НДСУпр
	|ПОМЕСТИТЬ ВТРезультатПредварительный
	|ИЗ
	|	ИмяТаблицыИсточникаДанных КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТРаспределение КАК Источники
	|		ПО Т.НомерУзла = Источники.Источник
	|ИНДЕКСИРОВАТЬ ПО
	|	Приемник
	|";
	
	Запрос.Текст = Запрос.Текст + "
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|";
	
	Если ВозможноСписаниеНДС Тогда
	
		Запрос.Текст = Запрос.Текст + "
		|ВЫБРАТЬ
		|	Т.К КАК К,
		|	&ТипЗаписиРезультата КАК ТипЗаписи,
		|	Т.ЧастичноОставитьВНЗП,
		|	&ИмяПоляЗнаменательРегл КАК Знаменатель,
		|	&ИмяПоляЗнаменательУпр КАК ЗнаменательУпр,
		|	Т.ЗнаменательДляИсточников,
		|	Т.ЗнаменательДляИсточниковУпр,
		|	Т.Период,
		|	Т.Регистратор КАК Регистратор,
		|	Т.ВидДвижения,
		|	Т.Организация,
		|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	ВЫБОР КОГДА Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) ИНАЧЕ Т.КорАналитикаУчетаНоменклатуры КОНЕЦ КАК КорАналитикаУчетаНоменклатуры,
		|	ВЫБОР КОГДА Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) ИНАЧЕ Т.КорВидЗапасов КОНЕЦ КАК КорВидЗапасов,
		|	&ИмяПоляПартия КАК Партия,
		|	&ИмяПоляАналитикаУчетаПартий КАК АналитикаУчетаПартий,
		|	Т.ВидДеятельностиНДС,
		|	Источники.ДокументПоступления КАК ДокументПоступления,
		|	Источники.ДокументПоступленияВТекущемПериоде,
		|	Источники.АналитикаУчетаПартийДокументаПоступления,
		|	Т.НаправлениеДеятельности,
		|	&ИмяПоляХозяйственнаяОперация КАК ХозяйственнаяОперация,
		|	&ИмяПоляКорВидДеятельностиНДС КАК КорВидДеятельностиНДС,
		|	Т.КорНаправлениеДеятельности,
		|	&ИмяПоляПодразделение КАК Подразделение,
		|	Источники.СтатьяРасходовАктивов,
		|	Источники.АналитикаРасходов,
		|	&ИмяПоляКорПодразделение КАК КорПодразделение,
		|	ВЫБОР
		|		КОГДА НЕ НастройкиСписанияНДС.Организация ЕСТЬ NULL
		|	  	  И (НЕ НастройкиСписанияНДС.ЗависитОтПериод ИЛИ НЕ Источники.ДокументПоступленияВТекущемПериоде)
		|	  	  И Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|		  И &ИмяПоляКорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|	  	ТОГДА
		|			ВЫБОР КОГДА &ИмяПоляКорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
		|				ТОГДА НастройкиСписанияНДС.СтатьяРасходовНеНДС
		|				ИНАЧЕ НастройкиСписанияНДС.СтатьяРасходовЕНВД
		|			КОНЕЦ
		|		ИНАЧЕ Т.СтатьяСписанияНДС
		|	КОНЕЦ КАК СтатьяСписанияНДС, 
		|	ВЫБОР
		|		КОГДА НЕ НастройкиСписанияНДС.Организация ЕСТЬ NULL
		|	  	  И (НЕ НастройкиСписанияНДС.ЗависитОтПериод ИЛИ НЕ Источники.ДокументПоступленияВТекущемПериоде)
		|	  	  И Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|		  И &ИмяПоляКорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|	  	ТОГДА
		|			ВЫБОР КОГДА &ИмяПоляКорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
		|				ТОГДА НастройкиСписанияНДС.АналитикаРасходовНеНДС
		|				ИНАЧЕ НастройкиСписанияНДС.АналитикаРасходовЕНВД
		|			КОНЕЦ
		|		ИНАЧЕ &ИмяПоляАналитикаСписанияНДС
		|	КОНЕЦ КАК АналитикаСписанияНДС, 
		|	Т.РазделУчета,
		|	Т.АналитикаФинансовогоУчета,
		|
		|	Источники.СтоимостьСНДС,
		|	Источники.СтоимостьБезНДС,
		|	Источники.СтоимостьБезНДСРегл,
		|	ВЫБОР
		|		КОГДА НЕ НастройкиСписанияНДС.Организация ЕСТЬ NULL
		|	  	  И (НЕ НастройкиСписанияНДС.ЗависитОтПериод ИЛИ НЕ Источники.ДокументПоступленияВТекущемПериоде)
		|	  	  И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	  	  И Источники.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|	  	  И Источники.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|	  	ТОГДА 0
		|	  	ИНАЧЕ Источники.НДСРегл
		|	КОНЕЦ КАК НДСРегл,
		|	ВЫБОР
		|		КОГДА НЕ НастройкиСписанияНДС.Организация ЕСТЬ NULL
		|	  	  И (НЕ НастройкиСписанияНДС.ЗависитОтПериод ИЛИ НЕ Источники.ДокументПоступленияВТекущемПериоде)
		|	  	  И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	  	  И Источники.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|	  	  И Источники.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|	  	ТОГДА 0
		|	  	ИНАЧЕ Источники.НДСУпр
		|	КОНЕЦ КАК НДСУпр
		|ПОМЕСТИТЬ ИмяТаблицыРезультатаПредварительная
		|ИЗ
		|	ВТРезультатПредварительный КАК Источники
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИмяТаблицыИсточникаДанных КАК Т
		|		ПО Источники.Приемник = Т.НомерУзла
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТНастройкиСписанияНДС КАК НастройкиСписанияНДС
		|		ПО Т.Организация = НастройкиСписанияНДС.Организация
		|ГДЕ
		|	&УсловиеРегистратор
		|";
		
	Иначе
		
		Запрос.Текст = Запрос.Текст + "
		|ВЫБРАТЬ
		|	Т.К КАК К,
		|	&ТипЗаписиРезультата КАК ТипЗаписи,
		|	Т.ЧастичноОставитьВНЗП,
		|	&ИмяПоляЗнаменательРегл КАК Знаменатель,
		|	&ИмяПоляЗнаменательУпр КАК ЗнаменательУпр,
		|	Т.ЗнаменательДляИсточников,
		|	Т.ЗнаменательДляИсточниковУпр,
		|	Т.Период,
		|	Т.Регистратор КАК Регистратор,
		|	Т.ВидДвижения,
		|	Т.Организация,
		|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	ВЫБОР КОГДА Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) ИНАЧЕ Т.КорАналитикаУчетаНоменклатуры КОНЕЦ КАК КорАналитикаУчетаНоменклатуры,
		|	ВЫБОР КОГДА Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) ИНАЧЕ Т.КорВидЗапасов КОНЕЦ КАК КорВидЗапасов,
		|	&ИмяПоляПартия КАК Партия,
		|	&ИмяПоляАналитикаУчетаПартий КАК АналитикаУчетаПартий,
		|	Т.ВидДеятельностиНДС,
		|	Источники.ДокументПоступления КАК ДокументПоступления,
		|	Источники.ДокументПоступленияВТекущемПериоде,
		|	Источники.АналитикаУчетаПартийДокументаПоступления,
		|	Т.НаправлениеДеятельности,
		|	&ИмяПоляХозяйственнаяОперация КАК ХозяйственнаяОперация,
		|	&ИмяПоляКорВидДеятельностиНДС КАК КорВидДеятельностиНДС,
		|	Т.КорНаправлениеДеятельности,
		|	&ИмяПоляПодразделение КАК Подразделение,
		|	Источники.СтатьяРасходовАктивов,
		|	Источники.АналитикаРасходов,
		|	&ИмяПоляКорПодразделение КАК КорПодразделение,
		|	Т.СтатьяСписанияНДС КАК СтатьяСписанияНДС, 
		|	&ИмяПоляАналитикаСписанияНДС КАК АналитикаСписанияНДС, 
		|	Т.РазделУчета,
		|	Т.АналитикаФинансовогоУчета,
		|
		|	Источники.СтоимостьСНДС,
		|	Источники.СтоимостьБезНДС,
		|	Источники.СтоимостьБезНДСРегл,
		|	Источники.НДСРегл КАК НДСРегл,
		|	Источники.НДСУпр КАК НДСУпр
		|ПОМЕСТИТЬ ИмяТаблицыРезультатаПредварительная
		|ИЗ
		|	ВТРезультатПредварительный КАК Источники
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИмяТаблицыИсточникаДанных КАК Т
		|		ПО Источники.Приемник = Т.НомерУзла
		|ГДЕ
		|	&УсловиеРегистратор
		|";
		
	КонецЕсли;
	
	Запрос.Текст = Запрос.Текст + "
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|";
	
	Запрос.Текст = Запрос.Текст + "
	|ВЫБРАТЬ
	|	Т.К,
	|	Т.ТипЗаписи,
	|	Т.ЧастичноОставитьВНЗП,
	|	Т.Знаменатель,
	|	Т.ЗнаменательУпр,
	|	Т.ЗнаменательДляИсточников,
	|	Т.ЗнаменательДляИсточниковУпр,
	|	Т.Период,
	|	Т.Регистратор,
	|	Т.ВидДвижения,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.КорАналитикаУчетаНоменклатуры,
	|	Т.КорВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.ДокументПоступленияВТекущемПериоде,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.НаправлениеДеятельности,
	|	Т.ХозяйственнаяОперация,
	|	Т.КорВидДеятельностиНДС,
	|	Т.КорНаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.СтатьяРасходовАктивов,
	|	Т.АналитикаРасходов,
	|	Т.КорПодразделение,
	|	Т.СтатьяСписанияНДС,
	|	Т.АналитикаСписанияНДС,
	|	Т.РазделУчета,
	|	Т.АналитикаФинансовогоУчета,
	|
	|	Т.СтоимостьСНДС,
	|	Т.СтоимостьБезНДС,
	|	Т.СтоимостьБезНДСРегл,
	|	Т.НДСРегл,
	|	Т.НДСУпр
	|ИЗ
	|	ИмяТаблицыИсточникаДанных КАК Т
	|ГДЕ
	|	Т.ТипЗаписи В (&ТипыЗаписейДополнения)
	|	И &УсловиеРегистратор
	|";
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИмяТаблицыИсточникаДанных", ИмяТаблицыИсточникаДанных);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИмяТаблицыРезультатаПредварительная", ИмяТаблицыРезультатаПредварительная);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИмяТаблицыСвязей", ИмяТаблицыСвязей);
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИмяПоляЗнаменательРегл", ИмяПоляЗнаменательРегл);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИмяПоляЗнаменательУпр", ИмяПоляЗнаменательУпр);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИмяПоляПартия", ИмяПоляПартия);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИмяПоляАналитикаУчетаПартий", ИмяПоляАналитикаУчетаПартий);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИмяПоляСтатьяКалькуляции", ИмяПоляСтатьяКалькуляции);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИмяПоляГруппаПродукции", ИмяПоляГруппаПродукции);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИмяПоляПравилоОтнесенияНаВыпуск", ИмяПоляПравилоОтнесенияНаВыпуск);
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИмяПоляХозяйственнаяОперация", ИмяПоляХозяйственнаяОперация);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИмяПоляКорВидДеятельностиНДС", ИмяПоляКорВидДеятельностиНДС);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИмяПоляПодразделение", ИмяПоляПодразделение);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИмяПоляКорПодразделение", ИмяПоляКорПодразделение);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИмяПоляАналитикаСписанияНДС", ИмяПоляАналитикаСписанияНДС);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеРегистратор", ТекстУсловиеРегистратор);
	
	Запрос.Текст = Запрос.Текст + "
	|ИНДЕКСИРОВАТЬ ПО
	|	" + ИмяПоляИндекса;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(
		ПараметрыРасчета,
		"ВТЗнаменателиПриемников, ВТРаспределениеПредварительное, ВТРаспределениеКопейки, ВТРаспределение, ВТРезультатПредварительный"
			 + ", " + ИмяТаблицыИсточникаДанных + ", " + ИмяТаблицыСвязей);
	
	Если НомерШага < 3 Тогда
		
		ПараметрыНумерации = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
			"", // разделитель
			"", // ресурсы
			"К", // порядок
			"НомерУзла", // номер
			"НомерУзла", // индекс
			);
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ЗаполнитьНомераСтрокВременнойТаблицы(
			ПараметрыРасчета,
			ПараметрыНумерации,
			ИмяТаблицыРезультатаПредварительная,
			ИмяТаблицыРезультата);
		
	Иначе
		
		Запрос.Текст =
		"ВЫБРАТЬ
		|	Т.ТипЗаписи,
		|	Т.Период,
		|	Т.Регистратор,
		|	Т.ВидДвижения,
		|	Т.Организация,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.КорАналитикаУчетаНоменклатуры,
		|	Т.КорВидЗапасов,
		|	Т.Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.ВидДеятельностиНДС,
		|	Т.ДокументПоступления,
		|	Т.ДокументПоступленияВТекущемПериоде,
		|	Т.АналитикаУчетаПартийДокументаПоступления,
		|	Т.НаправлениеДеятельности,
		|	Т.ХозяйственнаяОперация,
		|	Т.КорВидДеятельностиНДС,
		|	Т.КорНаправлениеДеятельности,
		|	Т.Подразделение,
		|	Т.СтатьяРасходовАктивов,
		|	Т.АналитикаРасходов,
		|	Т.КорПодразделение,
		|	Т.СтатьяСписанияНДС,
		|	Т.АналитикаСписанияНДС,
		|	Т.РазделУчета,
		|	Т.АналитикаФинансовогоУчета,
		|
		|	СУММА(Т.СтоимостьСНДС) КАК СтоимостьСНДС,
		|	СУММА(Т.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(Т.СтоимостьБезНДСРегл) КАК СтоимостьБезНДСРегл,
		|	СУММА(Т.НДСРегл) КАК НДСРегл,
		|	СУММА(Т.СтоимостьБезНДС) КАК СтоимостьБезНДСУпр,
		|	СУММА(Т.НДСУпр) КАК НДСУпр
		|ПОМЕСТИТЬ ИмяТаблицыРезультата 
		|ИЗ
		|	ИмяТаблицыРезультатаПредварительная КАК Т
		|СГРУППИРОВАТЬ ПО
		|	Т.ТипЗаписи,
		|	Т.Период,
		|	Т.Регистратор,
		|	Т.ВидДвижения,
		|	Т.Организация,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.КорАналитикаУчетаНоменклатуры,
		|	Т.КорВидЗапасов,
		|	Т.Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.ВидДеятельностиНДС,
		|	Т.ДокументПоступления,
		|	Т.ДокументПоступленияВТекущемПериоде,
		|	Т.АналитикаУчетаПартийДокументаПоступления,
		|	Т.НаправлениеДеятельности,
		|	Т.ХозяйственнаяОперация,
		|	Т.КорВидДеятельностиНДС,
		|	Т.КорНаправлениеДеятельности,
		|	Т.Подразделение,
		|	Т.СтатьяРасходовАктивов,
		|	Т.АналитикаРасходов,
		|	Т.КорПодразделение,
		|	Т.СтатьяСписанияНДС,
		|	Т.АналитикаСписанияНДС,
		|	Т.РазделУчета,
		|	Т.АналитикаФинансовогоУчета
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор
		|";
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИмяТаблицыРезультатаПредварительная", ИмяТаблицыРезультатаПредварительная);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИмяТаблицыРезультата", ИмяТаблицыРезультата);
	
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
		
		РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(
			ПараметрыРасчета,
			"ВТДанныеПостатейныеЗатраты, ВТНастройкиСписанияНДС, " + ИмяТаблицыРезультатаПредварительная);
		
	КонецЕсли;
	
КонецПроцедуры

// ... выборки данных


//-- Локализация

// Заполнение расчетной партии

Процедура ЗаполнитьРасчетнуюПартиюНДС2_4(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход)
	
	СуммовыеРесурсы = Новый Структура("СтоимостьСНДС, СтоимостьБезНДС, СтоимостьБезНДСРегл, НДСРегл, СтоимостьБезНДСУпр, НДСУпр");
	
	// Заполняем расчетную партию по расходной партии-основании
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	
	// Заполняем партионную идентификацию в расчетной партии
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход,
		"ДокументПоступления, АналитикаУчетаПартийДокументаПоступления, СтатьяРасходовАктивов, АналитикаРасходов
		|");
	
	РасчетнаяПартия.ДокументИсточник = Неопределено;
	
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.Партия) Тогда
		РасчетнаяПартия.Партия = Приход.Партия;
		РасчетнаяПартия.АналитикаУчетаПартий = Приход.АналитикаУчетаПартий;
	КонецЕсли;
	
	// Расчетная партия заполняется на наибольшее общее вычитаемое
	КоличествоСписания = Мин(Расход.Знаменатель * ?(Расход.ЭтоСторно, -1, 1), Приход.Знаменатель);
	ЗнаменательСписания = ?(Приход.ЭтоСторно, -1, 1) * КоличествоСписания;
	ПриходБазис = ?(Приход.Знаменатель <> 0, КоличествоСписания / (Приход.Знаменатель * ?(Приход.ЭтоСторно, -1, 1)), 0);
	
	Если ПриходБазис = 0 Тогда
		Возврат;
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход, "ХозяйственнаяОперация, АналитикаСписанияНДС, Подразделение");
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход, "Партия, АналитикаУчетаПартий, ВидДеятельностиНДС, Период, Регистратор, АналитикаФинансовогоУчета, РазделУчета");
	
	РасчетнаяПартия.КорВидДеятельностиНДС = Приход.ВидДеятельностиНДС;
	РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ДопРасходыСПартией;
	РасчетнаяПартия.ХозяйственнаяОперация = Расход.ХозяйственнаяОперация;
		
	// Заполняем показатели расчетной партии
	Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
		РасчетнаяПартия[ИмяРесурса.Ключ] = Окр(ПриходБазис * Приход[ИмяРесурса.Ключ], 2);
	КонецЦикла;
	
	РасчетнаяПартия.Знаменатель = 0;
	
	// Корректируем базу расчета в приходе
    Приход.Знаменатель = Приход.Знаменатель - ЗнаменательСписания;
	
	Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
		Приход[ИмяРесурса.Ключ] = Приход[ИмяРесурса.Ключ] - РасчетнаяПартия[ИмяРесурса.Ключ];
	КонецЦикла;
	
	//++ Локализация
	СуммовыеРесурсыНДС = Новый Структура("НДСРегл, НДСУпр");
	ЗаполнитьСтатьюИАналитикуСписанияНДС(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход, СуммовыеРесурсыНДС);
	//-- Локализация
	
	// По результатам партионной идентификации определяем завершенность расчета
	Если РасчетнаяПартия.СтоимостьСНДС = 0
	 И РасчетнаяПартия.СтоимостьБезНДС = 0
	 И РасчетнаяПартия.СтоимостьБезНДСРегл = 0
	 И РасчетнаяПартия.НДСРегл = 0
	 И РасчетнаяПартия.СтоимостьБезНДСУпр = 0
	 И РасчетнаяПартия.НДСУпр = 0 Тогда
		// Сформирована пустая расчетная запись. Такая запись не нужна в результатах расчета.
		РасчетнаяПартия.РасчетЗавершен = Ложь;
	Иначе
		РасчетнаяПартия.РасчетЗавершен = Приход.РасчетЗавершен;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ПроцедурыЭтапа_ПодготовкаДанныхДляВключенияИсключенияНДСДопРасходовВСтоимость24

// Выборка данных

Процедура ПолучитьДанныеДляВключенияИсключенияНДСДопРасходов(ПараметрыРасчета)
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьДанныеЭтапаРасчета(
		ПараметрыРасчета,
		ТекстЗапросаДляВключенияИсключенияНДСДопРасходов(ПараметрыРасчета));
	
КонецПроцедуры

// Тексты запросов

// ... общий

Функция ТекстЗапросаДляВключенияИсключенияНДСДопРасходов(ПараметрыРасчета = Неопределено) Экспорт
	
	ТекстЗапроса = ""
		// выборка данных
		+ ТекстОписаниеДанныхДляВключенияИсключенияНДСДопРасходов() //вт Данные
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстВключенияИсключенияНДСДопРасходов()
		//++ Локализация
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстВключенияИсключенияНДСДопРасходовСредняя()
		//-- Локализация
		+ "";
	
	Возврат ТекстЗапроса;
	
КонецФункции

// ... описания данных

Функция ТекстОписаниеДанныхДляВключенияИсключенияНДСДопРасходов()
	ТекстЗапроса = 
		"ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80)) КАК ЗапросИсточник,
		|	0 КАК Приоритет,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	Т.ТипЗаписи КАК ТипЗаписи,
		|	Т.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи,
		|	Т.ВидДвижения КАК ВидДвижения,
		|	Т.Период КАК Период,
		|	Т.Регистратор КАК Регистратор,
		|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	Т.РазделУчета КАК РазделУчета,
		|	Т.ВидЗапасов КАК ВидЗапасов,
		|	Т.Организация КАК Организация,
		|	Т.Партия КАК Партия,
		|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
		|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	Т.КорВидДеятельностиНДС КАК КорВидДеятельностиНДС,
		|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
		|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
		|	Т.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
		|	0 КАК СтоимостьРегл,
		|	0 КАК СтоимостьУпр
		|ПОМЕСТИТЬ Данные
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК Т";

	ТекстЗапроса = РасчетСебестоимостиПрикладныеАлгоритмы.ПодготовитьЗапросОписанияДанных(ТекстЗапроса);

	Возврат ТекстЗапроса;

КонецФункции

// ... выборки данных

Функция ТекстВключенияИсключенияНДСДопРасходов()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстВключенияИсключенияНДСДопРасходов"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ОписаниеДвижений.ТипЗаписи КАК ТипЗаписи,
		|	Т.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи,
		|	ОписаниеДвижений.ВидДвижения КАК ВидДвижения,
		|	Т.Период КАК Период,
		|	Т.Регистратор КАК Регистратор,
		|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	Т.РазделУчета КАК РазделУчета,
		|	Т.ВидЗапасов КАК ВидЗапасов,
		|	Т.Организация КАК Организация,
		|	Т.Партия КАК Партия,
		|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
		|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	Т.КорВидДеятельностиНДС КАК КорВидДеятельностиНДС,
		|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВключениеИсключениеНДСВСтоимости) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВключениеИсключениеНДСВСтоимости) КАК НастройкаХозяйственнойОперации,
		|	ВЫБОР
		|		КОГДА Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|		 И Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|			ТОГДА Т.НДСРегл
		//++ Локализация
		|		КОГДА Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|		 И Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
		|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) < &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
		|			ТОГДА Т.НДСРегл
		//-- Локализация
		|		КОГДА Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|		 И Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|			ТОГДА -Т.НДСРегл
		//++ Локализация
		|		КОГДА Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|		 И Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
		|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) >= &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
		|			ТОГДА -Т.НДСРегл
		//-- Локализация
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК СтоимостьРегл,
		|	ВЫБОР
		|		КОГДА Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|		 И Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|			ТОГДА Т.НДСУпр
		//++ Локализация
		|		КОГДА Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|		 И Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
		|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) < &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
		|			ТОГДА Т.НДСУпр
		//-- Локализация
		|		КОГДА Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|		 И Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|			ТОГДА -Т.НДСУпр
		//++ Локализация
		|		КОГДА Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|		 И Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
		|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) >= &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
		|			ТОГДА -Т.НДСУпр
		//-- Локализация
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК СтоимостьУпр
		|ИЗ
		|	ВТДопрасходыДляПостатейныхЗатрат КАК Т
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДвиженияВключенияИсключениНДСДопРасходов КАК ОписаниеДвижений
		|		ПО Т.НаВыбытие = ОписаниеДвижений.НаВыбытие
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
		|		ПО ДанныеПервичныхДокументов.Организация = Т.Организация
		|		И ДанныеПервичныхДокументов.Документ = Т.ДокументПоступления
		|ГДЕ
		|	Т.ВидДеятельностиНДС <> Т.КорВидДеятельностиНДС
		|	И Т.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И Т.КорВидДеятельностиНДС <> НЕОПРЕДЕЛЕНО
		|	И Т.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		|	И Т.РазделУчета <> НЕОПРЕДЕЛЕНО
		|	И Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией)
		|	И (Т.НДСРегл <> 0 ИЛИ Т.НДСУпр <> 0)
		|";
КонецФункции

//++ Локализация

Функция ТекстВключенияИсключенияНДСДопРасходовСредняя()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстВключенияИсключенияНДСДопРасходовСредняя"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход
		|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВключениеИсключениеНДСВСтоимости)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
		|	КОНЕЦ КАК ТипЗаписи,
		|	&ИдентификаторНеиспользуемойФинЗаписи КАК ИдентификаторФинЗаписи,
		|	ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход
		|		ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ КАК ВидДвижения,
		|	Т.Период КАК Период,
		|	Т.Регистратор КАК Регистратор,
		|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	Т.РазделУчета КАК РазделУчета,
		|	Т.ВидЗапасов КАК ВидЗапасов,
		|	Т.Организация КАК Организация,
		|	НЕОПРЕДЕЛЕНО КАК Партия,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	Т.КорВидДеятельностиНДС КАК КорВидДеятельностиНДС,
		|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВключениеИсключениеНДСВСтоимости) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВключениеИсключениеНДСВСтоимости) КАК НастройкаХозяйственнойОперации,
		|	ВЫБОР
		|		КОГДА Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|		 И Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|			ТОГДА Т.НДС
		|		КОГДА Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|		 И Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
		|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) < &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
		|			ТОГДА Т.НДС
		|		КОГДА Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|		 И Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|			ТОГДА -Т.НДС
		|		КОГДА Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|		 И Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
		|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) >= &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
		|			ТОГДА -Т.НДС
		|			ИНАЧЕ 0
		|	КОНЕЦ КАК СтоимостьРегл,
		|	ВЫБОР
		|		КОГДА Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|		 И Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|			ТОГДА Т.НДСУпр
		|		КОГДА Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|		 И Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
		|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) < &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
		|			ТОГДА Т.НДСУпр
		|		КОГДА Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|		 И Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|			ТОГДА -Т.НДСУпр
		|		КОГДА Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|		 И Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
		|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) >= &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
		|			ТОГДА -Т.НДСУпр
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК СтоимостьУпр
		|ИЗ
		|	ВТКэшРасчетныеОборотыДетализацияПартийТоваровДляНДСиУСН КАК Т
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК Отбор
		|		ПО Т.Регистратор = Отбор.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
		|		ПО ДанныеПервичныхДокументов.Организация = Т.Организация
		|		И ДанныеПервичныхДокументов.Документ = Т.ДокументПоступления
		|ГДЕ
		// Условия выборки данных должны соответствовать заполнению настройки хозяйственной операции
		// в функции ТекстСписаниеПартийПрочихРасходовДляДопРасходовФИФО().
		|	Т.ВидДеятельностиНДС <> Т.КорВидДеятельностиНДС
		|	И Т.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И Т.КорВидДеятельностиНДС <> НЕОПРЕДЕЛЕНО
		|	И Т.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		|	И Т.РазделУчета <> НЕОПРЕДЕЛЕНО
		|	И Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы)
		|	И (Т.НДС <> 0 ИЛИ Т.НДСУпр <> 0)
		|	И НЕ (НЕ Т.СлужебноеВидДвиженияПриход
		|		И Т.Партия = НЕОПРЕДЕЛЕНО
		|		И Т.КорВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.СобственныйТоварВПути))
		|";
КонецФункции

//-- Локализация

#КонецОбласти

#Область ПроцедурыЭтапа_ПодготовкаДанныхДляПартийПрочихРасходов

#Область Описание_ПодготовкаДанныхДляПартийПрочихРасходов

// Документы поступления постатейных расходов при проведении формируют приходные онлайн движения по партиям прочих расходов
//
// В данном этапе формируются оффлайн движения по партиям прочих расходов
//
// Производственные статьи:
// 3. Поступление производственных затрат при списании номенклатуры на статью расходов
//		- если в движении себестоимости заполнено реквизит СтатьяРасходовСписания, то это списание номенклатуры на статью
//		- для этой номенклатуры могут быть затраты 3х регистрах учета партий НДС
//		- эти затраты надо перенести из себестоимости в партии прочих расходов на статью, указанную в СтатьяРасходовСписания
// 2. Поступлениение затрат при списании статьи затрат "на себестоимость" на статью затрат "на производство"
//		Возникает в следующих сценариях:
//		- поступление материала в прошлом периоде, и из него производится выпуск
//			- в следующем периоде поступили доп. расходы по этой партии материала
//			- эти расходы будут отнесены на предопределенную статью "Производственные расходы прошлых периодов"
// 		- поступление затрат по производственной статье с видом деятельности НДС "Налоговый агент по НДС"
//			- НДС по данным затратам будет отнесен на статью "НДС налогового агента" и дальше переброшен на исходную производственную статью
// 1. Выбытие производственных затрат в незавершенном производстве
//		- когда затраты приходят на партию производства (в раздел себестоимости Незавершенное производство) они выбывают из регистр а партий прочих расходов
//		- по таким затратам формируется расходное движения
//  	- приход этих затрат - или онлайн движение, если если в документе сумма затрат, или делается п.2
// Если сложить онлайн приходы по производственным затратам, движения из п.2 и 3, и вычесть из них затраты п.1, то регистр партий прочих должен закрыться в 0
//
// Статьи "на себестоимость"
// 3. Поступление затрат "на себестоимость" при списании номенклатуры на статью расходов (аналогично п.2)
// 4. Списание затрат документами Распределение расходов
//		- выполняется списание всех затрат "на себестоимость": и сформированных онлайн и оффлайн
// Если сложить онлайн приходы по затратам "на себестоимость", движения из п.3 и вычесть из них затраты п.4, то регистр партий прочих должен закрыться в 0
// 

#КонецОбласти

// Выборка данных

Процедура ПолучитьДанныеДляПартийПрочихРасходов(ПараметрыРасчета)
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьДанныеЭтапаРасчета(
		ПараметрыРасчета,
		ТекстЗапросаДляПартийПрочихРасходов(ПараметрыРасчета));
	
КонецПроцедуры

// Тексты запросов

// ... общий

Функция ТекстЗапросаДляПартийПрочихРасходов(ПараметрыРасчета = Неопределено) Экспорт
	
	ТекстЗапроса = ""
		// выборка данных
		+ ТекстОписаниеДанныхДляПартийПрочихРасходов() //вт Данные
		//++ Локализация

		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстПоступлениеПартийПрочихРасходовДляДопРасходовФИФО()
		//-- Локализация
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстПоступлениеПартийПрочихРасходовПриСписанииНоменклатурыНаДопРасходыФИФО()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстСписаниеПартийПрочихРасходовДляДопРасходовФИФО()
		//++ Локализация
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстПоступлениеПартийПрочихРасходовПриСписанииНоменклатурыНаДопРасходыСредняяЗаМесяц()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстСписаниеПартийПрочихРасходовДляДопРасходовСредняяЗаМесяц()
		//-- Локализация
		+ "";
	
	Возврат ТекстЗапроса;
	
КонецФункции

// ... описания данных

Функция ТекстОписаниеДанныхДляПартийПрочихРасходов()
	ТекстЗапроса = 
		"ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80)) КАК ЗапросИсточник,
		|	0 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК Организация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК ВидДеятельностиНДС,
		|	ДД.КорСтатьяРасходов,
		|	ДД.КорАналитикаРасходов,
		|	ДД.КорПодразделение,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.КорГруппаПродукции,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК НДСУпр,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ДД.НастройкаХозяйственнойОперации,
		|	ДД.ИдентификаторФинЗаписи,
		|	ДД.Сторно
		|ПОМЕСТИТЬ Данные
		|ИЗ
		|	РегистрНакопления.ПартииПрочихРасходов КАК ДД 
		|";

	ТекстЗапроса = РасчетСебестоимостиПрикладныеАлгоритмы.ПодготовитьЗапросОписанияДанных(ТекстЗапроса);

	Возврат ТекстЗапроса;

КонецФункции

// ... выборки данных

//++ Локализация


Функция ТекстПоступлениеПартийПрочихРасходовДляДопРасходовФИФО()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПоступлениеПартийПрочихРасходовДляДопРасходовФИФО"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.КорПодразделение КАК Подразделение,
		|	ДД.КорСтатьяРасходов КАК СтатьяРасходов,
		|	ДД.КорАналитикаРасходов КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.ДокументПоступления КАК ДокументПоступленияРасходов,
		|	ДД.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартий,
		|	ДД.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ДД.СтатьяРасходовАктивов КАК КорСтатьяРасходов,
		|	ДД.АналитикаРасходов КАК КорАналитикаРасходов,
		|	ДД.Подразделение КАК КорПодразделение,
		|	ДД.НаправлениеДеятельности КАК КорНаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК КорГруппаПродукции,
		|	СУММА(ДД.СтоимостьСНДС * Статьи.КоэффициентУпр) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС * Статьи.КоэффициентУпр) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьБезНДСРегл * Статьи.КоэффициентРегл) КАК СтоимостьРегл,
		|	СУММА(ВЫБОР
		|		КОГДА ЕСТЬNULL(Статья.ПринятиеКНалоговомуУчету, ИСТИНА) ИЛИ НЕ ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
		|		ТОГДА ДД.НДСРегл * Статьи.КоэффициентРегл
		|		ИНАЧЕ 0
		|	КОНЕЦ) КАК НДСРегл,
		|	СУММА(ВЫБОР
		|		КОГДА ЕСТЬNULL(Статья.ПринятиеКНалоговомуУчету, ИСТИНА) ИЛИ НЕ ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
		|		ТОГДА ДД.НДСУпр * Статьи.КоэффициентУпр
		|		ИНАЧЕ 0
		|	КОНЕЦ) КАК НДСУпр,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ДД.КорВидДеятельностиНДС КАК НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК НастройкаХозяйственнойОперации,
		|	ДД.ИдентификаторФинЗаписи,
		|	ДД.Сторно
		|ИЗ
		|	ВТДопРасходыДляПостатейныхЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТСтатьиПроизводственныхЗатрат КАК Статьи
		|		ПО ДД.КорСтатьяРасходов = Статьи.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
		|		ПО Статья.Ссылка = ДД.КорСтатьяРасходов
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТНастройкиУчетаНДС КАК НастройкиУчетаНДС
		|		ПО НастройкиУчетаНДС.Организация = ДД.Организация
		|ГДЕ
		|	ДД.Организация В(&ОрганизацииСРаздельнымУчетомПостатейныхЗатрат)
		|	И ДД.ТипЗаписи В (ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией))
		|	И (ДД.СтоимостьСНДС <> 0 ИЛИ ДД.СтоимостьБезНДС <> 0
		|		ИЛИ ДД.СтоимостьБезНДСРегл <> 0 ИЛИ ДД.НДСРегл <> 0 ИЛИ ДД.НДСУпр <> 0)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.КорСтатьяРасходов,
		|	ДД.КорАналитикаРасходов,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартийДокументаПоступления,
		|	ДД.НаправлениеДеятельности,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.ИдентификаторФинЗаписи,
		|	ДД.Сторно,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.КорПодразделение,
		|	ДД.КорНаправлениеДеятельности
		|";
КонецФункции

//-- Локализация

// Аналогичная функция для учета по средней ТекстПоступлениеПартийПрочихРасходовПриСписанииНоменклатурыНаДопРасходыСредняяЗаМесяц
//
Функция ТекстПоступлениеПартийПрочихРасходовПриСписанииНоменклатурыНаДопРасходыФИФО()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПоступлениеПартийПрочихРасходовПриСписанииНоменклатурыНаДопРасходыФИФО"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.ДокументПоступления КАК ДокументПоступленияРасходов,
		|	ДД.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартий,
		|	ДД.НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК КорГруппаПродукции,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ВЫБОР
		|		КОГДА ИСТИНА
		//++ Локализация
		|			И ЕСТЬNULL(Статья.ПринятиеКНалоговомуУчету, ИСТИНА) ИЛИ НЕ ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
		//-- Локализация
		|		ТОГДА ДД.НДСРегл
		|		ИНАЧЕ 0
		|	КОНЕЦ) КАК НДСРегл,
		|	СУММА(ВЫБОР
		|		КОГДА ИСТИНА
		//++ Локализация
		|			И ЕСТЬNULL(Статья.ПринятиеКНалоговомуУчету, ИСТИНА) ИЛИ НЕ ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
		//-- Локализация
		|		ТОГДА ДД.НДСУпр
		|		ИНАЧЕ 0
		|	КОНЕЦ) КАК НДСУпр,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК НастройкаХозяйственнойОперации,
		|	ДД.ИдентификаторФинЗаписи,
		|	ЛОЖЬ КАК Сторно
		|ИЗ
		|	ВТДопРасходыДляРаспределенияФИФО КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями КАК Передача
		|		ПО ДД.Регистратор = Передача.Ссылка
		|		И ДД.Организация = Передача.Организация
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК Корректировка
		|		ПО ДД.Регистратор = Корректировка.Ссылка
		//++ Локализация
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученныйНалоговыйАгент КАК СчетФактура
		|		ПО ДД.Регистратор = СчетФактура.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
		|		ПО Статья.Ссылка = ДД.СтатьяРасходов
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТНастройкиУчетаНДС КАК НастройкиУчетаНДС
		|		ПО НастройкиУчетаНДС.Организация = ДД.Организация
		//-- Локализация
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.НачислениеРеверсивногоНДС КАК НачислениеРеверсивногоНДС
		|		ПО ДД.Регистратор = НачислениеРеверсивногоНДС.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПоступлениеУслугВПодразделение КАК ПоступлениеУслуг
		|		ПО ПоступлениеУслуг.Ссылка = ДД.Регистратор
		|ГДЕ
		// Исключаем доп расходы, которые были в остатках регистра ""Партии прочих расходов""
		|	ДД.Регистратор <> НЕОПРЕДЕЛЕНО
		// Исключаем доп расходы, по которым уже есть приходы в регистр ""Партии прочих расходов"" в текущем периоде.
		|	И (ДД.Регистратор <> ДД.ДокументПоступления
		|		ИЛИ ДД.РасчетПартий
		|		ИЛИ (ДД.ХозяйственнаяОперация В (
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщикаФактуровкаПоставки),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСФактуровкаПоставки))
		|			И НЕ ДД.ЭтоПартииПрочихРасходов)
		|		)
		|	И ДД.ДокументПоступления <> НЕОПРЕДЕЛЕНО
		|	И ЕСТЬNULL(Корректировка.ДокументОснование, НЕОПРЕДЕЛЕНО) <> ДД.ДокументПоступления
		|	И (ЕСТЬNULL(ПоступлениеУслуг.ИсправляемыйДокумент, НЕОПРЕДЕЛЕНО) <> ДД.ДокументПоступления
		|		ИЛИ ДД.РасчетПартий)
		//++ Локализация
		|	И ЕСТЬNULL(СчетФактура.СчетФактураОснование, НЕОПРЕДЕЛЕНО) <> ДД.ДокументПоступления
		//-- Локализация
		|	И ЕСТЬNULL(НачислениеРеверсивногоНДС.ДокументОснование, НЕОПРЕДЕЛЕНО) <> ДД.ДокументПоступления
		|	И ТИПЗНАЧЕНИЯ(ДД.Регистратор) <> ТИП(Документ.Сторно)
		// Исключаем доп расходы у организации-отправителя - они учитываются только у организации-получателя
		|	И Передача.Ссылка ЕСТь NULL
		|	И (ДД.Стоимость <> 0 ИЛИ ДД.СтоимостьБезНДС <> 0
		|		ИЛИ ДД.СтоимостьРегл <> 0 ИЛИ ДД.НДСРегл <> 0 ИЛИ ДД.НДСУпр <> 0)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартийДокументаПоступления,
		|	ДД.НаправлениеДеятельности,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.ИдентификаторФинЗаписи
		|";
КонецФункции

Функция ТекстСписаниеПартийПрочихРасходовДляДопРасходовФИФО()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстСписаниеПартийПрочихРасходовДляДопРасходовФИФО"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходовАктивов КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.ДокументПоступления КАК ДокументПоступленияРасходов,
		|	ДД.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартий,
		|	ДД.НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	ДД.КорВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ДД.КорСтатьяРасходов,
		|	ДД.КорАналитикаРасходов,
		|	ДД.КорПодразделение,
		|	ДД.КорНаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК КорГруппаПродукции,
		|	СУММА(ДД.СтоимостьСНДС) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьБезНДСРегл) КАК СтоимостьРегл,
		|	СУММА(ВЫБОР
		|		КОГДА ИСТИНА
		//++ Локализация
		|			И ЕСТЬNULL(Статья.ПринятиеКНалоговомуУчету, ИСТИНА) ИЛИ НЕ ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
		//-- Локализация
		|		ТОГДА ДД.НДСРегл
		|		ИНАЧЕ 0
		|	КОНЕЦ) КАК НДСРегл,
		|	СУММА(ВЫБОР
		|		КОГДА ИСТИНА
		//++ Локализация
		|			И ЕСТЬNULL(Статья.ПринятиеКНалоговомуУчету, ИСТИНА) ИЛИ НЕ ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
		//-- Локализация
		|		ТОГДА ДД.НДСУпр
		|		ИНАЧЕ 0
		|	КОНЕЦ) КАК НДСУпр,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ДД.ВидДеятельностиНДС КАК НалогообложениеНДС,
		|	(ВЫБОР
		// Условия заполнения настройки хозяйственной операции должны соответствовать условиям
		// в функции ТекстВключенияИсключенияНДСДопРасходов().
		|		КОГДА ДД.ВидДеятельностиНДС <> ДД.КорВидДеятельностиНДС
		|		 И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|		 И ДД.ВидДеятельностиНДС <> НЕОПРЕДЕЛЕНО
		|		 И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		|		 И ДД.РазделУчета <> НЕОПРЕДЕЛЕНО
		|		 И (ДД.СтатьяСписанияНДС = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|				ИЛИ ДД.СтатьяСписанияНДС = НЕОПРЕДЕЛЕНО)
		|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВключениеИсключениеНДСВСтоимости)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.РаспределениеРасходовНаСебестоимость)
		|		КОНЕЦ) КАК НастройкаХозяйственнойОперации,
		|	ДД.ИдентификаторФинЗаписи,
		|	ДД.Сторно
		|ИЗ
		|	ВТДопРасходыДляПостатейныхЗатрат КАК ДД
		//++ Локализация
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
		|		ПО Статья.Ссылка = ДД.СтатьяРасходовАктивов
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТНастройкиУчетаНДС КАК НастройкиУчетаНДС
		|		ПО НастройкиУчетаНДС.Организация = ДД.Организация
		//-- Локализация
		|ГДЕ
		|	ДД.ТипЗаписи В (ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией))
		|	И (ДД.СтоимостьСНДС <> 0 ИЛИ ДД.СтоимостьБезНДС <> 0
		|		ИЛИ ДД.СтоимостьБезНДСРегл <> 0 ИЛИ ДД.НДСРегл <> 0
		|		ИЛИ ДД.СтоимостьБезНДСУпр <> 0 ИЛИ ДД.НДСУпр <> 0)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартийДокументаПоступления,
		|	ДД.НаправлениеДеятельности,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.КорВидДеятельностиНДС,
		|	(ВЫБОР
		|		КОГДА ДД.ВидДеятельностиНДС <> ДД.КорВидДеятельностиНДС
		|		 И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|		 И ДД.ВидДеятельностиНДС <> НЕОПРЕДЕЛЕНО
		|		 И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		|		 И ДД.РазделУчета <> НЕОПРЕДЕЛЕНО
		|		 И (ДД.СтатьяСписанияНДС = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|				ИЛИ ДД.СтатьяСписанияНДС = НЕОПРЕДЕЛЕНО)
		|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВключениеИсключениеНДСВСтоимости)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.РаспределениеРасходовНаСебестоимость)
		|		КОНЕЦ), // НастройкаХозяйственнойОперации
		|	ДД.ИдентификаторФинЗаписи,
		|	ДД.Сторно,
		|	ДД.КорСтатьяРасходов,
		|	ДД.КорАналитикаРасходов,
		|	ДД.КорПодразделение,
		|	ДД.КорНаправлениеДеятельности
		|";
КонецФункции

//++ Локализация

// Аналогичная функция для учета по ФИФО ТекстПоступлениеПартийПрочихРасходовПриСписанииНоменклатурыНаДопРасходыФИФО
//
Функция ТекстПоступлениеПартийПрочихРасходовПриСписанииНоменклатурыНаДопРасходыСредняяЗаМесяц()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПоступлениеПартийПрочихРасходовПриСписанииНоменклатурыНаДопРасходыСредняяЗаМесяц"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.ДокументПоступления КАК ДокументПоступленияРасходов,
		|	ДД.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартий,
		|	ДД.НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК КорГруппаПродукции,
		|	СУММА(ДД.СтоимостьБезНДСУпр + ДД.НДСУпр) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДСУпр) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ВЫБОР
		|		КОГДА ЕСТЬNULL(Статья.ПринятиеКНалоговомуУчету, ИСТИНА) ИЛИ НЕ ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
		|		ТОГДА ДД.НДСРегл
		|		ИНАЧЕ 0
		|	КОНЕЦ) КАК НДСРегл,
		|	СУММА(ВЫБОР
		|		КОГДА ЕСТЬNULL(Статья.ПринятиеКНалоговомуУчету, ИСТИНА) ИЛИ НЕ ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
		|		ТОГДА ДД.НДСУпр
		|		ИНАЧЕ 0
		|	КОНЕЦ) КАК НДСУпр,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ДД.ВидДеятельностиНДС КАК НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК НастройкаХозяйственнойОперации,
		|	НЕОПРЕДЕЛЕНО КАК ИдентификаторФинЗаписи,
		|	ЛОЖЬ КАК Сторно
		|ИЗ
		|	ВТДопРасходыДляРаспределения КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями КАК Передача
		|		ПО ДД.Регистратор = Передача.Ссылка
		|		И ДД.Организация = Передача.Организация
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК Корректировка
		|		ПО ДД.Регистратор = Корректировка.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученныйНалоговыйАгент КАК СчетФактура
		|		ПО ДД.Регистратор = СчетФактура.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
		|		ПО Статья.Ссылка = ДД.СтатьяРасходов
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТНастройкиУчетаНДС КАК НастройкиУчетаНДС
		|		ПО НастройкиУчетаНДС.Организация = ДД.Организация
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.НачислениеРеверсивногоНДС КАК НачислениеРеверсивногоНДС
		|		ПО ДД.Регистратор = НачислениеРеверсивногоНДС.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПоступлениеУслугВПодразделение КАК ПоступлениеУслуг
		|		ПО ПоступлениеУслуг.Ссылка = ДД.Регистратор
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		// Исключаем доп расходы, которые были в остатках регистра ""Партии прочих расходов""
		|	И ДД.Регистратор <> НЕОПРЕДЕЛЕНО
		// Исключаем доп расходы, по которым уже есть приходы в регистр ""Партии прочих расходов"" в текущем периоде.
		|	И (ДД.Регистратор <> ДД.ДокументПоступления
		|		ИЛИ ДД.РасчетПартий
		|		ИЛИ ДД.ХозяйственнаяОперация В (
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщикаФактуровкаПоставки),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСФактуровкаПоставки))
		|		)
		|	И ДД.ДокументПоступления <> НЕОПРЕДЕЛЕНО
		|	И ЕСТЬNULL(Корректировка.ДокументОснование, НЕОПРЕДЕЛЕНО) <> ДД.ДокументПоступления
		|	И (ЕСТЬNULL(ПоступлениеУслуг.ИсправляемыйДокумент, НЕОПРЕДЕЛЕНО) <> ДД.ДокументПоступления
		|		ИЛИ ДД.РасчетПартий)
		|	И ЕСТЬNULL(СчетФактура.СчетФактураОснование, НЕОПРЕДЕЛЕНО) <> ДД.ДокументПоступления
		|	И ЕСТЬNULL(НачислениеРеверсивногоНДС.ДокументОснование, НЕОПРЕДЕЛЕНО) <> ДД.ДокументПоступления
		|	И ТИПЗНАЧЕНИЯ(ДД.Регистратор) <> ТИП(Документ.Сторно)
		// Исключаем доп расходы у организации-отправителя - они учитываются только у организации-получателя
		|	И Передача.Ссылка ЕСТь NULL
		|	И (ДД.Стоимость <> 0 ИЛИ ДД.СтоимостьБезНДС <> 0
		|		ИЛИ ДД.СтоимостьРегл <> 0 ИЛИ ДД.НДСРегл <> 0 ИЛИ ДД.НДСУпр <> 0)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартийДокументаПоступления,
		|	ДД.НаправлениеДеятельности,
		|	ДД.ВидДеятельностиНДС
		|";
КонецФункции

Функция ТекстСписаниеПартийПрочихРасходовДляДопРасходовСредняяЗаМесяц()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстСписаниеПартийПрочихРасходовДляДопРасходовСредняяЗаМесяц"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходовАктивов КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ВЫБОР КОГДА ДД.ДокументПоступления = НЕОПРЕДЕЛЕНО
		|		ТОГДА ДД.ДокументИсточник
		|		ИНАЧЕ ДД.ДокументПоступления
		|	КОНЕЦ КАК ДокументПоступленияРасходов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	ДД.КорВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ДД.КорСтатьяРасходов,
		|	ДД.КорАналитикаРасходов,
		|	ДД.КорПодразделение,
		|	ДД.КорНаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК КорГруппаПродукции,
		|	СУММА(ВЫБОР
		|		КОГДА (Статьи.Ссылка ЕСТЬ NULL
		|		  ИЛИ Статьи.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
		|		 И Статьи.Ссылка <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.НДСНалоговогоАгента)
		|			ТОГДА ДД.СтоимостьБезНДСУпр + ДД.НДСУпр
		|		ИНАЧЕ 0 КОНЕЦ) КАК Стоимость,
		|	СУММА(ВЫБОР
		|		КОГДА (Статьи.Ссылка ЕСТЬ NULL
		|		  ИЛИ Статьи.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
		|			ТОГДА ДД.СтоимостьБезНДСУпр
		|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьБезНДС,
		|	СУММА(ВЫБОР
		|		КОГДА Статьи.Ссылка ЕСТЬ NULL
		|		  ИЛИ Статьи.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|			ТОГДА ДД.СтоимостьБезНДС
		|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьРегл,
		|	СУММА(ВЫБОР
		|		КОГДА Статьи.Ссылка ЕСТЬ NULL
		|		  ИЛИ Статьи.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|			И (Статьи.ПринятиеКНалоговомуУчету ИЛИ НЕ ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ))
		|			ТОГДА ДД.НДС
		|		ИНАЧЕ 0 КОНЕЦ) КАК НДСРегл,
		|	СУММА(ВЫБОР
		|		КОГДА Статьи.Ссылка ЕСТЬ NULL
		|		  ИЛИ Статьи.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|			И (Статьи.ПринятиеКНалоговомуУчету ИЛИ НЕ ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ))
		|			ТОГДА ДД.НДСУпр
		|		ИНАЧЕ 0 КОНЕЦ) КАК НДСУпр,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ДД.ВидДеятельностиНДС КАК НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК НастройкаХозяйственнойОперации,
		|	НЕОПРЕДЕЛЕНО КАК ИдентификаторФинЗаписи,
		|	ДД.Сторно
		|ИЗ
		|	ВТДетализацияПартийТоваровДляНДСиУСН КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статьи
		|		ПО ДД.СтатьяРасходовАктивов = Статьи.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТНастройкиУчетаНДС КАК НастройкиУчетаНДС
		|		ПО НастройкиУчетаНДС.Организация = ДД.Организация
		|ГДЕ
		|	ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.ТипЗаписи В (
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам))
		|	И ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат)
		|	И (ДД.СтоимостьБезНДС <> 0 ИЛИ ДД.НДС <> 0 ИЛИ ДД.НДСУпр <> 0)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ВЫБОР КОГДА ДД.ДокументПоступления = НЕОПРЕДЕЛЕНО
		|		ТОГДА ДД.ДокументИсточник
		|		ИНАЧЕ ДД.ДокументПоступления
		|	КОНЕЦ,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.НаправлениеДеятельности,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорСтатьяРасходов,
		|	ДД.КорАналитикаРасходов,
		|	ДД.КорПодразделение,
		|	ДД.Сторно
		|";
КонецФункции
//-- Локализация

#КонецОбласти

//++ Локализация
#Область ПроцедурыЭтапа_ПодготовкаДанныхДляПрочихРасходов

// Выборка данных

Процедура ПолучитьДанныеДляПрочихРасходов(ПараметрыРасчета)
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьДанныеЭтапаРасчета(
		ПараметрыРасчета,
		ТекстЗапросаДляПрочихРасходов(ПараметрыРасчета));
	
КонецПроцедуры

// Тексты запросов

// ... общий

Функция ТекстЗапросаДляПрочихРасходов(ПараметрыРасчета = Неопределено) Экспорт
	
	ТекстЗапроса = ""
		// выборка данных
		+ ТекстОписаниеДанныхДляПрочихРасходов() //вт Данные
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстВключениеИсключениеНДСВСтоимостиНДСНалоговогоАгента()
		+ "";
	
	Возврат ТекстЗапроса;
	
КонецФункции

// ... описания данных

Функция ТекстОписаниеДанныхДляПрочихРасходов()
	ТекстЗапроса = 
		"ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80)) КАК ЗапросИсточник,
		|	0 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.НаправлениеДеятельности,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	0 КАК Сумма,
		|	0 КАК СуммаБезНДС,
		|	0 КАК СуммаРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	0 КАК СуммаУпр,
		|	ДД.ИдентификаторФинЗаписи
		|ПОМЕСТИТЬ Данные
		|ИЗ
		|	РегистрНакопления.ПрочиеРасходы КАК ДД
		|";

	ТекстЗапроса = РасчетСебестоимостиПрикладныеАлгоритмы.ПодготовитьЗапросОписанияДанных(ТекстЗапроса);

	Возврат ТекстЗапроса;

КонецФункции

// ... выборки данных

Функция ТекстВключениеИсключениеНДСВСтоимостиНДСНалоговогоАгента()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстВключениеИсключениеНДСВСтоимостиНДСНалоговогоАгента"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.КорПодразделение КАК Подразделение,
		|	ДД.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
		|	ДД.КорСтатьяРасходов КАК СтатьяРасходов,
		|	ДД.КорАналитикаРасходов КАК АналитикаРасходов,
		|	0 КАК Сумма,
		|	0 КАК СуммаБезНДС,
		|	СУММА(ВЫБОР
		|		КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|		 И ДД.НалогообложениеНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|			ТОГДА ДД.НДСРегл
		|		КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|		 И ДД.НалогообложениеНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|			ТОГДА -ДД.НДСРегл
		|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	СУММА(ВЫБОР
		|		КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|		 И ДД.НалогообложениеНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|			ТОГДА ДД.НДСУпр
		|		КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|		 И ДД.НалогообложениеНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
		|			ТОГДА -ДД.НДСУпр
		|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаУпр,
		|	&ИдентификаторНеиспользуемойФинЗаписи КАК ИдентификаторФинЗаписи
		|ИЗ
		|	ВТКэшРасчетныеОборотыПартииПрочихРасходов КАК ДД
		|ГДЕ
		|	НЕ ДД.СлужебноеВидДвиженияПриход
		|	И ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат)
		|	И ДД.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.НДСНалоговогоАгента)
		|	И ДД.КорСтатьяРасходов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.КорПодразделение,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.КорСтатьяРасходов,
		|	ДД.КорАналитикаРасходов
		|";
КонецФункции

#КонецОбласти

#Область ПроцедурыЭтапа_ПодготовкаДанныхДляПартийНДСКРаспределению

#Область Описание_ПодготовкаДанныхДляПартийНДСКРаспределению

// Этап подготовки данных для партий НДС к распределению выполняет формирование движений по регистру "Партии НДС к распределению".
// Выходные данные этапа формируются в функции ТекстЗапросаДляПартийНДСКРаспределению()
//
// Исходные данные для базы распределения выбираются в разных функциях, в зависимости от типа источника и метода оценки 
// стоимости товаров в учетной политике организации.
// Для дальнейшего распределения важны поля СтатьяРасходов и ВидДеятельностиНДС.
// 
// Для учета по средней:
// 1. Партии НДС.
//	Выборка описана в функции ТекстПоступленияПартийНДСКРаспределениюИзПартийНДС().
//	Отбор данных выполняется по данным временной таблицы ВтДетализацияПартийТоваровДляНДСиУСН,
//	которая формируется на этапе РасчетПартийНДС.
//	Подбираются расходные движения с суммами НДС (НДС или НДСУпр), отличными от нуля. Вид деятельности НДС должен быть заполнен.
//	Документы возврата товаров от поставщика и возврата между организациями не учитываются. Есть условия по комбинациям настроек
//	статей расходов активов и кор. вида деятельности НДС.
//	СтатьяРасходов подбирается из СтатьяРасходовАктивов. ВидДеятельностиНДС зависит от КорВидДеятельностиНДС и настроек статьи.
// 2. Приходы себестоимости.
//	Выборка описана в функции ТекстПоступленияПартийНДСКРаспределениюИзПриходовСебестоимости().
//	Отбор данных выполняется по данным временной таблицы ПриходыТоваровНДС.
//	Подбираются движения по типу записей распределения по выбывшим товарам, виду деятельности, определяемому распределением,
//	СтатьяРасходов устанавливается в НЕОПРЕДЕЛЕНО. ВидДеятельностиНДС совпадает с ВидДеятельностиНДС из ПриходыТоваровНДС.
// 3. Доп. расходы партий НДС.
//	Выборка описана в функции ТекстПоступленияПартийНДСКРаспределениюИзДопРасходовПартийНДС().
//	Отбор данных выполняется по данным временной таблицы ВтДетализацияПартийТоваровДляНДСиУСН.
//	Подбираются приходные движения по типу записей доп. расходов, виду деятельности, определяемому распределением, и пустой
//	кор. статьей расходов.
//	СтатьяРасходов подбирается из СтатьяРасходовАктивов. ВидДеятельностиНДС совпадает с ВидДеятельностиНДС из ПриходыТоваровНДС.
//
// Для учета по ФИФО используется одноименные процедуры с пометкой "2_4":
// 4. Партии НДС.
//	Выборка описана в функции ТекстПоступленияПартийНДСКРаспределениюИзПартийНДС2_4().
//	Отбор данных выполняется по данным временной таблицы ВТОборотыСтоимостьПартийНДС.
// 5. Приходы себестоимости.
//	Выборка описана в функции ТекстПоступленияПартийНДСКРаспределениюИзПриходовСебестоимости2_4().
//	Отбор данных выполняется по данным временной таблицы ПриходыТоваровНДС2_4.
// 6. Доп. расходы партий НДС.
//	Выборка описана в функции ТекстПоступленияПартийНДСКРаспределениюИзДопРасходовПартийНДС2_4().
//	Отбор данных выполняется по данным временной таблицы ВТДопрасходыДляПостатейныхЗатрат.
// Условия отбора для функций по ФИФО, в целом, совпадают с условиями в функциях для учета по средней.
//
// Общие источники:
// 7. Партии прочих расходов.
//	Выборка описана в функции ТекстПоступленияПартийНДСКРаспределениюИзПартийПрочихРасходов().
//	Отбор данных выполняется по данным временной таблицы ВТКэшРасчетныеОборотыПартииПрочихРасходов.
//	Подбираются расходные движения по статье расходов "НДСНалоговогоАгента" и распределяемой кор. статьей расходов.
//	СтатьяРасходов подбирается из КорСтатьяРасходов. ВидДеятельностиНДС совпадает с ВидДеятельностиНДС из ПриходыТоваровНДС.
//
// 8. Формирование движений по фактуровке работ и услуг, списанных на расходы.
// Если указана статья расходов с раздельным учет НДС по расходам "НДС распределяется пропорционально выручке".
// Выборка описана в функции ТекстПоступленияПартийНДСКРаспределениюИзФактуровкиРаботУслуг().
// Исходными данными являются движения документов "Приобретения товаров и услуг" по разделу "Неотфактурованные поставки"
// на полную сумму фактуровки.

#КонецОбласти

// Выборка данных

Процедура ПолучитьДанныеДляПартийНДСКРаспределению(ПараметрыРасчета)
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьДанныеЭтапаРасчета(
		ПараметрыРасчета,
		ТекстЗапросаДляПартийНДСКРаспределению(ПараметрыРасчета));
	
КонецПроцедуры

// Тексты запросов

// ... общий

Функция ТекстЗапросаДляПартийНДСКРаспределению(ПараметрыРасчета = Неопределено) Экспорт
	
	ТекстЗапроса = ""
		// выборка данных
		+ ТекстОписаниеДанныхДляПартийНДСКРаспределению() //вт Данные
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстПоступленияПартийНДСКРаспределениюИзПартийНДС()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстПоступленияПартийНДСКРаспределениюИзПриходовСебестоимости() // использует ПриходыТоваровНДС
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстПоступленияПартийНДСКРаспределениюИзДопРасходовПартийНДС()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстПоступленияПартийНДСКРаспределениюИзПартийНДС2_4()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстПоступленияПартийНДСКРаспределениюИзПриходовСебестоимости2_4() // использует ПриходыТоваровНДС2_4
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстПоступленияПартийНДСКРаспределениюИзДопРасходовПартийНДС2_4()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстПоступленияПартийНДСКРаспределениюИзПартийПрочихРасходов()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстПоступленияПартийНДСКРаспределениюИзФактуровкиРаботУслуг()
		+ "";
	
	Возврат ТекстЗапроса;
	
КонецФункции

// ... описания данных

Функция ТекстОписаниеДанныхДляПартийНДСКРаспределению()
	ТекстЗапроса = 
		"ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80)) КАК ЗапросИсточник,
		|	0 КАК Приоритет,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.НаправлениеДеятельности,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.Поставщик,
		|	ДД.ДокументПоступленияРасходов,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.ВидЦенности,
		|	ДД.СтавкаНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК НДСУпр,
		|	ДД.Сторно
		|ПОМЕСТИТЬ Данные
		|ИЗ
		|	РегистрНакопления.ПартииНДСКРаспределению КАК ДД
		|";

	ТекстЗапроса = РасчетСебестоимостиПрикладныеАлгоритмы.ПодготовитьЗапросОписанияДанных(ТекстЗапроса);

	Возврат ТекстЗапроса;

КонецФункции

// ... выборки данных

Функция ТекстПоступленияПартийНДСКРаспределениюИзПартийНДС()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПоступленияПартийНДСКРаспределениюИзПартийНДС"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение КАК Подразделение,
		|	ДД.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
		|	ДД.СтатьяРасходовАктивов КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов КАК АналитикаАктивовПассивов,
		|	ДД.АналитикаУчетаПартий.Контрагент КАК Поставщик,
		|	ВЫБОР КОГДА ДД.ДокументПоступления = НЕОПРЕДЕЛЕНО
		|		ТОГДА ДД.ДокументИсточник
		|		ИНАЧЕ ДД.ДокументПоступления
		|	КОНЕЦ КАК ДокументПоступленияРасходов,
		|	(ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|			ТОГДА ДД.КорВидДеятельностиНДС
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС) ТОГДА
		|			(ВЫБОР
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.КорВидДеятельностиНДС
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.ВидДеятельностиНДС
		|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию) КОНЕЦ)
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НМА)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС КОНЕЦ) КАК ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий.ВидЦенности КАК ВидЦенности,
		|	ДД.АналитикаУчетаПартий.СтавкаНДС КАК СтавкаНДС,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьРегл,
		|	СУММА(ДД.НДС) КАК НДСРегл,
		|	СУММА(ДД.НДСУпр) КАК НДСУпр,
		|	ДД.Сторно
		|ИЗ
		|	ВтДетализацияПартийТоваровДляНДСиУСН КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Склады КАК Склады
		|		ПО Аналитика.МестоХранения = Склады.Ссылка
		|			ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
		|		ПО Назначения.Ссылка = Аналитика.Назначение
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВнутреннееПотребление КАК Потребление
		|		ПО Потребление.Ссылка = ДД.Регистратор
		
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
		|		ПО Статья.Ссылка = ДД.СтатьяРасходовАктивов
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиАктивовПассивов КАК СтатьяАктивов
		|		ПО СтатьяАктивов.Ссылка = ДД.СтатьяРасходовАктивов
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТНастройкиУчетаНДС КАК НастройкиУчетаНДС
		|		ПО НастройкиУчетаНДС.Организация = ДД.Организация
		|ГДЕ
		|	ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.Организация В (&ОрганизацииСРаспределениемПартийНДС)
		|	И (Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
		|		ИЛИ Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|			И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС)
		|		ИЛИ ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|		ИЛИ НЕ СтатьяАктивов.Ссылка ЕСТЬ NULL
		|			И ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|		ИЛИ (НЕ Статья.Ссылка ЕСТЬ NULL ИЛИ НЕ СтатьяАктивов.Ссылка ЕСТЬ NULL)
		|			И ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортСырьевыхТоваровУслуг)
		|	)
		|	И (ДД.НДС <> 0 ИЛИ ДД.НДСУпр <> 0)
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВозвратТоваровМеждуОрганизациями
		|	И (ЕСТЬNULL(Статья.ПринятиеКНалоговомуУчету, ИСТИНА) ИЛИ НЕ ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ))
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	ДД.АналитикаУчетаПартий.Контрагент,
		|	ВЫБОР КОГДА ДД.ДокументПоступления = НЕОПРЕДЕЛЕНО
		|		ТОГДА ДД.ДокументИсточник
		|		ИНАЧЕ ДД.ДокументПоступления
		|	КОНЕЦ,
		|	(ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|			ТОГДА ДД.КорВидДеятельностиНДС
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС) ТОГДА
		|			(ВЫБОР
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.КорВидДеятельностиНДС
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.ВидДеятельностиНДС
		|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию) КОНЕЦ)
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НМА)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС КОНЕЦ),
		|	ДД.АналитикаУчетаПартий.ВидЦенности,
		|	ДД.АналитикаУчетаПартий.СтавкаНДС,
		|	ДД.Сторно
		|";
КонецФункции

Функция ТекстПоступленияПартийНДСКРаспределениюИзПриходовСебестоимости()// использует ПриходыТоваровНДС
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПоступленияПартийНДСКРаспределениюИзПриходовСебестоимости"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение КАК Подразделение,
		|	ЕСТЬNULL(Потребление.НаправлениеДеятельности,
		|		ЕСТЬNULL(Назначения.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))) КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.АналитикаУчетаПартий.Контрагент КАК Поставщик,
		|	ДД.ДокументПоступления КАК ДокументПоступленияРасходов,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий.ВидЦенности КАК ВидЦенности,
		|	ДД.АналитикаУчетаПартий.СтавкаНДС КАК СтавкаНДС,
		|	ДД.СтоимостьБезНДС КАК СтоимостьРегл,
		|	ДД.НДС КАК НДСРегл,
		|	ДД.НДСУпр КАК НДСУпр,
		|	ДД.Сторно
		|ИЗ
		|	ПриходыТоваровНДС КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Склады КАК Склады
		|		ПО Аналитика.МестоХранения = Склады.Ссылка
		|			ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
		|		ПО Назначения.Ссылка = Аналитика.Назначение
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВнутреннееПотребление КАК Потребление
		|		ПО Потребление.Ссылка = ДД.Регистратор
		|
		|ГДЕ
		|	ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|	И ДД.Организация В (&ОрганизацииСРаспределениемПартийНДС)
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|";
КонецФункции

Функция ТекстПоступленияПартийНДСКРаспределениюИзДопРасходовПартийНДС()// использует ПриходыТоваровНДС
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПоступленияПартийНДСКРаспределениюИзДопРасходовПартийНДС"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение КАК Подразделение,
		|	ДД.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.АналитикаУчетаПартий.Контрагент КАК Поставщик,
		|	ДД.ДокументПоступления КАК ДокументПоступленияРасходов,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий.ВидЦенности КАК ВидЦенности,
		|	ДД.АналитикаУчетаПартий.СтавкаНДС КАК СтавкаНДС,
		|	ДД.СтоимостьБезНДС КАК СтоимостьРегл,
		|	ДД.НДС КАК НДСРегл,
		|	ДД.НДСУпр КАК НДСУпр,
		|	ДД.Сторно
		|ИЗ
		|	ВтДетализацияПартийТоваровДляНДСиУСН КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК КорСтатья
		|		ПО КорСтатья.Ссылка = ДД.КорСтатьяРасходов
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
		|		ПО Статья.Ссылка = ДД.СтатьяРасходовАктивов
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТНастройкиУчетаНДС КАК НастройкиУчетаНДС
		|		ПО НастройкиУчетаНДС.Организация = ДД.Организация
		|ГДЕ
		|	ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|	И ДД.Организация В (&ОрганизацииСРаспределениемПартийНДС)
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы)
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И КорСтатья.Ссылка ЕСТЬ NULL
		|	И (ЕСТЬNULL(Статья.ПринятиеКНалоговомуУчету, ИСТИНА) ИЛИ НЕ ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ))
		|";
КонецФункции

Функция ТекстПоступленияПартийНДСКРаспределениюИзПартийНДС2_4()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПоступленияПартийНДСКРаспределениюИзПартийНДС2_4"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение КАК Подразделение,
		|	ЕСТЬNULL(Потребление.НаправлениеДеятельности,
		|		ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))) КАК НаправлениеДеятельности,
		|	ДД.СтатьяРасходовАктивов КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
		|	ДД.АналитикаУчетаПартийДокументаПоступления.Контрагент КАК Поставщик,
		|	ВЫБОР КОГДА НЕ Корректировка.ДокументОснование ЕСТЬ NULL И ДД.НДСРегл < 0
		|		ТОГДА Корректировка.ДокументОснование
		|		ИНАЧЕ ДД.ДокументПоступления
		|	КОНЕЦ КАК ДокументПоступленияРасходов,
		|	(ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|			ТОГДА ДД.КорВидДеятельностиНДС
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС) ТОГДА
		|			(ВЫБОР
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.КорВидДеятельностиНДС
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.ВидДеятельностиНДС
		|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию) КОНЕЦ)
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НМА)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС КОНЕЦ) КАК ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартийДокументаПоступления.ВидЦенности КАК ВидЦенности,
		|	ДД.АналитикаУчетаПартийДокументаПоступления.СтавкаНДС КАК СтавкаНДС,
		|	СУММА(ДД.СтоимостьБезНДСРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.НДСУпр) КАК НДСУпр,
		|	ДД.Сторно
		|ИЗ
		|	ВТОборотыСтоимостьПартийНДС КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВнутреннееПотребление КАК Потребление
		|		ПО Потребление.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
		|		ПО Статья.Ссылка = ДД.СтатьяРасходовАктивов
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиАктивовПассивов КАК СтатьяАктивов
		|		ПО СтатьяАктивов.Ссылка = ДД.СтатьяРасходовАктивов
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Склады КАК Склады
		|		ПО Аналитика.МестоХранения = Склады.Ссылка
		|			ПО Аналитика.Ссылка = ДД.КорАналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТНастройкиУчетаНДС КАК НастройкиУчетаНДС
		|		ПО НастройкиУчетаНДС.Организация = ДД.Организация
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК Корректировка
		|		ПО Корректировка.Ссылка  = ДД.ДокументПоступления
		|		И Корректировка.ВидКорректировки = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон)
		|ГДЕ
		// Условия в см. СформироватьСтоимостьПартийНДСНаКонецПериода по полю ЭтоДанныеДляПартийНДСКРаспределению должны совпадать.
		|	НЕ ДД.СлужебноеВидДвиженияПриход
		|	И ДД.Организация В (&ОрганизацииСРаспределениемПартийНДС)
		|	И (Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
		|		ИЛИ Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|			И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС)
		|		ИЛИ ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|		ИЛИ НЕ СтатьяАктивов.Ссылка ЕСТЬ NULL
		|			И ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|		ИЛИ (НЕ Статья.Ссылка ЕСТЬ NULL ИЛИ НЕ СтатьяАктивов.Ссылка ЕСТЬ NULL)
		|			И ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортСырьевыхТоваровУслуг)
		// Если КорАналитикаУчетаНоменклатуры не пустая - значит это выпуск со списанием в производство (прямые расходы).
		// Прямые расходы не должны формировать движений по РН ПартииНДСКРаспределению.
		|			И ДД.КорАналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|	)
		|	И (ДД.НДСРегл <> 0 ИЛИ ДД.НДСУпр <> 0)
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВозвратТоваровМеждуОрганизациями
		|	И НЕ ДД.РазделУчета В (
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажиКОформлениюСписания),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработкуКОформлениюСписания),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания))
		|	И (ЕСТЬNULL(Статья.ПринятиеКНалоговомуУчету, ИСТИНА) ИЛИ НЕ ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ))
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ЕСТЬNULL(Потребление.НаправлениеДеятельности,
		|		ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))),
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.АналитикаУчетаПартийДокументаПоступления.Контрагент,
		|	ВЫБОР КОГДА НЕ Корректировка.ДокументОснование ЕСТЬ NULL И ДД.НДСРегл < 0
		|		ТОГДА Корректировка.ДокументОснование
		|		ИНАЧЕ ДД.ДокументПоступления
		|	КОНЕЦ,
		|	(ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|			ТОГДА ДД.КорВидДеятельностиНДС
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС) ТОГДА
		|			(ВЫБОР
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.КорВидДеятельностиНДС
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.ВидДеятельностиНДС
		|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию) КОНЕЦ)
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НМА)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС КОНЕЦ),
		|	ДД.АналитикаУчетаПартийДокументаПоступления.ВидЦенности,
		|	ДД.АналитикаУчетаПартийДокументаПоступления.СтавкаНДС,
		|	ДД.Сторно
		|";
КонецФункции

Функция ТекстПоступленияПартийНДСКРаспределениюИзПриходовСебестоимости2_4()// использует ПриходыТоваровНДС2_4
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПоступленияПартийНДСКРаспределениюИзПриходовСебестоимости2_4"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение КАК Подразделение,
		|	ЕСТЬNULL(Потребление.НаправлениеДеятельности,
		|		ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))) КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.АналитикаУчетаПартийДокументаПоступления.Контрагент КАК Поставщик,
		|	ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(ДД.ДокументПоступления) В (&ТипыДокументовПартии)
		|		ТОГДА ДД.ДокументПоступления
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ КАК ДокументПоступленияРасходов,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартийДокументаПоступления.ВидЦенности КАК ВидЦенности,
		|	ДД.АналитикаУчетаПартийДокументаПоступления.СтавкаНДС КАК СтавкаНДС,
		|	ДД.СтоимостьБезНДСРегл КАК СтоимостьРегл,
		|	ДД.НДСРегл КАК НДСРегл,
		|	ДД.НДСУпр КАК НДСУпр,
		|	ДД.Сторно
		|ИЗ
		|	ПриходыТоваровНДС2_4 КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВнутреннееПотребление КАК Потребление
		|		ПО Потребление.Ссылка = ДД.Регистратор
		|
		|ГДЕ
		|	ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|	И ДД.Организация В (&ОрганизацииСРаспределениемПартийНДС)
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|";
КонецФункции

Функция ТекстПоступленияПартийНДСКРаспределениюИзДопРасходовПартийНДС2_4()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПоступленияПартийНДСКРаспределениюИзДопРасходовПартийНДС2_4"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение КАК Подразделение,
		|	ДД.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.АналитикаУчетаПартийДокументаПоступления.Контрагент КАК Поставщик,
		|	ДД.ДокументПоступления КАК ДокументПоступленияРасходов,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартийДокументаПоступления.ВидЦенности КАК ВидЦенности,
		|	ДД.АналитикаУчетаПартийДокументаПоступления.СтавкаНДС КАК СтавкаНДС,
		|	ДД.СтоимостьБезНДС КАК СтоимостьРегл,
		|	ДД.НДСРегл КАК НДСРегл,
		|	ДД.НДСУпр КАК НДСУпр,
		|	ДД.Сторно
		|ИЗ
		|	ВТДопрасходыДляПостатейныхЗатрат КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК КорСтатья
		|		ПО КорСтатья.Ссылка = ДД.КорСтатьяРасходов
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
		|		ПО Статья.Ссылка = ДД.СтатьяРасходовАктивов
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТНастройкиУчетаНДС КАК НастройкиУчетаНДС
		|		ПО НастройкиУчетаНДС.Организация = ДД.Организация
		|ГДЕ
		|	ДД.Организация В(&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И ДД.Организация В (&ОрганизацииСРаспределениемПартийНДС)
		|	И ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией)
		// Отбор по КорСтатье, аналогично как в ТекстПоступленияПартийНДСКРаспределениюИзДопРасходовПартийНДС
		|	И КорСтатья.Ссылка ЕСТЬ NULL
		|	И (ЕСТЬNULL(Статья.ПринятиеКНалоговомуУчету, ИСТИНА) ИЛИ НЕ ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ))
		|";
КонецФункции

Функция ТекстПоступленияПартийНДСКРаспределениюИзПартийПрочихРасходов()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПоступленияПартийНДСКРаспределениюИзПартийПрочихРасходов"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.КорПодразделение КАК Подразделение,
		|	ДД.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
		|	ДД.КорСтатьяРасходов КАК СтатьяРасходов,
		|	ДД.КорАналитикаРасходов КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.АналитикаУчетаПартий.Контрагент КАК Поставщик,
		|	ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(ДД.ДокументПоступленияРасходов) В (&ТипыДокументовПартии)
		|		ТОГДА ДД.ДокументПоступленияРасходов
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ КАК ДокументПоступленияРасходов,
		|	ДД.НалогообложениеНДС,
		|	ДД.АналитикаУчетаПартий.ВидЦенности КАК ВидЦенности,
		|	ДД.АналитикаУчетаПартий.СтавкаНДС КАК СтавкаНДС,
		|	ДД.СтоимостьРегл КАК СтоимостьРегл,
		|	ДД.НДСРегл КАК НДСРегл,
		|	ДД.НДСУпр КАК НДСУпр,
		|	ДД.Сторно
		|ИЗ
		|	ВТКэшРасчетныеОборотыПартииПрочихРасходов КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК КорСтатья
		|		ПО КорСтатья.Ссылка = ДД.КорСтатьяРасходов
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТНастройкиУчетаНДС КАК НастройкиУчетаНДС
		|		ПО НастройкиУчетаНДС.Организация = ДД.Организация
		|ГДЕ
		|	НЕ ДД.СлужебноеВидДвиженияПриход
		|	И ДД.Организация В (&ОрганизацииСРаспределениемПартийНДС)
		// Приход партий НДС к распределению нужен в случае, когда НДС налогового агента распределяется на статью,
		// для которой НДС распределяется пропорционально выручке, или, что то же самое, когда НДС налогового агента распределяется
		// на закупку под вид деятельности НДС "Определяется распределением"
		|	И (КорСтатья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
		|		ИЛИ ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением))
		|	И (ЕСТЬNULL(КорСтатья.ПринятиеКНалоговомуУчету, ИСТИНА) ИЛИ НЕ ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ))
		|";
КонецФункции

// При фактуровке работ и услуг, списанных на расходы, необходимо сформировать движения по регистру "Партии НДС к распределению",
// если в статье расходов указан раздельный учет НДС по расходам "НДС распределяется пропорционально выручке".
// Такие движения отражаются всегда по виду деятельности НДС "Определяется распределением".
//
Функция ТекстПоступленияПартийНДСКРаспределениюИзФактуровкиРаботУслуг()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПоступленияПартийНДСКРаспределениюИзФактуровкиРаботУслуг"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
		|	ДД.СтатьяРасходовСписания КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.АналитикаУчетаПартий.Контрагент КАК Поставщик,
		|	ДД.Регистратор КАК ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением) КАК НалогообложениеНДС,
		|	ДД.АналитикаУчетаПартий.ВидЦенности КАК ВидЦенности,
		|	ДД.АналитикаУчетаПартий.СтавкаНДС КАК СтавкаНДС,
		|	ДД.СтоимостьРегл КАК СтоимостьРегл,
		|	ДД.НДСРегл КАК НДСРегл,
		|	ДД.НДСУпр КАК НДСУпр,
		|	ДД.Сторно
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
		|		ПО Статья.Ссылка = ДД.СтатьяРасходовСписания
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТНастройкиУчетаНДС КАК НастройкиУчетаНДС
		|		ПО НастройкиУчетаНДС.Организация = ДД.Организация
		|ГДЕ
		|	ДД.СлужебноеВидДвиженияПриход
		|	И ДД.Организация В (&ОрганизацииСРаспределениемПартийНДС)
		|	И ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
		|	И ДД.Количество <> 0
		|	И Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
		|	И НЕ ДД.Сторно
		|	И (ЕСТЬNULL(Статья.ПринятиеКНалоговомуУчету, ИСТИНА) ИЛИ НЕ ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ))
		|";
КонецФункции

#КонецОбласти

//-- Локализация

#Область ПроцедурыЭтапов_Контекстные

// Используется для всех вызовов заполнения расчетной партии.
//
Процедура ЗаполнитьРасчетнуюПартию(ПараметрыРасчета, Контекст, РасчетнаяПартия, Расход, Приход, ПартияЗаполнена) Экспорт
	
	Если Контекст = "РаспределениеПартийНДСФИФОСкользящаяПоДопРасходам" Тогда
		ЗаполнитьРасчетнуюПартиюНДС2_4(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход);
		ПартияЗаполнена = Истина;
	//++ Локализация
	ИначеЕсли Контекст = "ПодготовкаДанныхДляУчетаНДСиУСН" Тогда
		// Этап 11
		ЗаполнитьРасчетнуюПартиюНДС(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход);
		ПартияЗаполнена = Истина;
	//-- Локализация
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

//++ Локализация

#Область ВключитьИсключитьНДСВСтоимость

// Этап 3.1
Процедура ВключитьИсключитьНДСВСтоимость(ПараметрыРасчета) Экспорт

	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "ВключитьИсключитьНДСВСтоимость");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Партии.Регистратор,
	|	Партии.Организация,
	|	Партии.АналитикаУчетаНоменклатуры,
	|	Партии.ДокументПоступления,
	|	Партии.ВидЗапасов,
	|	Партии.СтатьяРасходовСписания,
	|	Партии.АналитикаРасходов
	|ПОМЕСТИТЬ РасходыПартий
	|ИЗ
	|	РегистрНакопления.ПартииТоваровОрганизаций КАК Партии
	|ГДЕ
	|	НЕ &ПартионныйУчетВерсии22
	|	И Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Партии.Активность
	|	И Партии.Организация В(&МассивОрганизаций)
	|	И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И Партии.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)
	|ИНДЕКСИРОВАТЬ ПО
	|	Партии.Регистратор
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	УчетСебестоимости.Период,
	|	УчетСебестоимости.Регистратор,
	|	УчетСебестоимости.Организация,
	|	УчетСебестоимости.АналитикаУчетаНоменклатуры,
	|	УчетСебестоимости.Партия,
	|	УчетСебестоимости.АналитикаФинансовогоУчета,
	|	УчетСебестоимости.ВидДеятельностиНДС
	|ПОМЕСТИТЬ ДвиженияСебестоимости
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК УчетСебестоимости
	|ГДЕ
	|	&ПартионныйУчетВерсии22
	|	И НЕ УчетСебестоимости.СлужебноеВидДвиженияПриход
	|	И УчетСебестоимости.Организация В(&ОрганизацииСУчетомПартийНДСВерсии22)
	|	И (УчетСебестоимости.КорРазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|		ИЛИ УчетСебестоимости.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			И УчетСебестоимости.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО)
	|	И УчетСебестоимости.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|	И УчетСебестоимости.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию)
	|	И УчетСебестоимости.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
	|ИНДЕКСИРОВАТЬ ПО
	|	Период,
	|	Регистратор,
	|	Организация,
	|	АналитикаУчетаНоменклатуры,
	|	Партия,
	|	АналитикаФинансовогоУчета,
	|	ВидДеятельностиНДС
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Партии.Период КАК Период,
	|	Партии.Регистратор КАК Регистратор,
	|	Партии.Организация КАК Организация,
	|	Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Партии.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов КАК ВидЗапасов,
	|	Партии.Партия КАК Партия,
	|	Партии.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Партии.КорАналитикаФинансовогоУчета КАК КорАналитикаФинансовогоУчета,
	|	Партии.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	Партии.АналитикаРасходов КАК АналитикаРасходов,
	|	Партии.СтатьяСписанияНДС,
	|	Партии.АналитикаСписанияНДС,
	|	Партии.НалогообложениеПартии,
	|	Партии.Сторно,
	|	СУММА(Партии.Количество) КАК Количество,
	|	СУММА(
	|		ВЫБОР КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА 0
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		ТОГДА
	|			Партии.НДСРегл
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) < &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			Партии.НДСРегл
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		ТОГДА
	|			-Партии.НДСРегл
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) >= &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			-Партии.НДСРегл
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ
	|	) КАК НДСРегл,
	|	СУММА(
	|		ВЫБОР КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА 0
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		ТОГДА
	|			Партии.НДСУпр
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) < &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			Партии.НДСУпр
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		ТОГДА
	|			-Партии.НДСУпр
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) >= &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			-Партии.НДСУпр
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ
	|	) КАК НДСУпр
	|
	|ПОМЕСТИТЬ ВтПартии
	|ИЗ (
	|	ВЫБРАТЬ
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Партии.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|		Партии.ВидЗапасов КАК ВидЗапасов,
	|		НЕОПРЕДЕЛЕНО КАК Партия,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
	|		НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
	|		Партии.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|		Партии.АналитикаРасходов КАК АналитикаРасходов,
	|		Партии.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
	|		Партии.НалогообложениеНДС,
	|		Партии.ДокументПоступления,
	|		Партии.Количество КАК Количество,
	|		Партии.НДСРегл КАК НДСРегл,
	|		0 КАК НДСУпр,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС,
	|		ЛОЖЬ КАК Сторно
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровОрганизаций КАК Партии
	|	ГДЕ
	|		НЕ &ПартионныйУчетВерсии22
	|		И Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Партии.Активность
	|		И Партии.Организация В(&МассивОрганизаций)
	|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Партии.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.АналитикаУчетаПродукции КАК АналитикаУчетаНоменклатуры,
	|		Партии.КорАналитикаУчетаПродукции КАК КорАналитикаУчетаНоменклатуры,
	|		РасходыПартий.ВидЗапасов КАК ВидЗапасов,
	|		НЕОПРЕДЕЛЕНО КАК Партия,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
	|		НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
	|		Партии.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|		Партии.АналитикаРасходов КАК АналитикаРасходов,
	|		Партии.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
	|		Партии.НалогообложениеНДС,
	|		Партии.ДокументПоступления,
	|		0 КАК Количество,
	|		Партии.НДСРегл КАК НДСРегл,
	|		0 КАК НДСУпр,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС,
	|		ЛОЖЬ КАК Сторно
	|	ИЗ
	|		РегистрНакопления.ПартииЗатратНаВыпуск КАК Партии
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РасходыПартий КАК РасходыПартий
	|			ПО РасходыПартий.Регистратор = Партии.Регистратор
	|			И РасходыПартий.Организация = Партии.Организация
	|			И РасходыПартий.АналитикаУчетаНоменклатуры = Партии.АналитикаУчетаПродукции
	|			И РасходыПартий.ДокументПоступления = Партии.ДокументВыпуска
	|			И РасходыПартий.СтатьяРасходовСписания = Партии.СтатьяРасходовСписания
	|			И РасходыПартий.АналитикаРасходов = Партии.АналитикаРасходов 
	|	ГДЕ
	|		НЕ &ПартионныйУчетВерсии22
	|		И Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Партии.Активность
	|		И Партии.Организация В(&МассивОрганизаций)
	|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Партии.НДСРегл <> 0
	|		И Партии.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Партии.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|		Партии.ВидЗапасов КАК ВидЗапасов,
	|		НЕОПРЕДЕЛЕНО КАК Партия,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
	|		НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
	|		Партии.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|		Партии.АналитикаРасходов КАК АналитикаРасходов,
	|		Партии.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
	|		Партии.НалогообложениеНДС,
	|		Партии.ДокументПоступления,
	|		0 КАК Количество,
	|		Партии.НДСРегл КАК НДСРегл,
	|		0 КАК НДСУпр,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС,
	|		ЛОЖЬ КАК Сторно
	|	ИЗ
	|		РегистрНакопления.ПартииРасходовНаСебестоимостьТоваров КАК Партии
	|	ГДЕ
	|		НЕ &ПартионныйУчетВерсии22
	|		И Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Партии.Активность
	|		И Партии.Организация В(&МассивОрганизаций)
	|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Партии.НДСРегл <> 0
	|		И Партии.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Партии.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|		Партии.ВидЗапасов КАК ВидЗапасов,
	|		(ВЫБОР
	|			КОГДА ДвиженияСебестоимости.Регистратор ЕСТЬ NULL ТОГДА НЕОПРЕДЕЛЕНО
	|			ИНАЧЕ Партии.Партия КОНЕЦ) КАК Партия,
	|		Партии.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|		Партии.КорАналитикаФинансовогоУчета КАК КорАналитикаФинансовогоУчета,
	|		Партии.СтатьяРасходовАктивов КАК СтатьяРасходовСписания,
	|		Партии.АналитикаРасходов КАК АналитикаРасходов,
	|		Партии.ВидДеятельностиНДС КАК НалогообложениеПартии,
	|		Партии.КорВидДеятельностиНДС КАК НалогообложениеНДС,
	|		Партии.ДокументПоступления,
	|		(ВЫБОР
	|			КОГДА Партии.ТипЗаписи В (
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
	|				ТОГДА (ВЫБОР
	|					КОГДА Партии.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|						ТОГДА Партии.СтоимостьБезНДС + Партии.НДС
	|					КОГДА Партии.СтоимостьБезНДС = 0 ТОГДА Партии.НДС
	|					ИНАЧЕ Партии.СтоимостьБезНДС КОНЕЦ)
	|			ИНАЧЕ Партии.Количество КОНЕЦ) КАК Количество,
	|		Партии.НДС КАК НДСРегл,
	|		Партии.НДСУпр КАК НДСУпр,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС,
	|		Партии.Сторно
	|	ИЗ
	|		ВТКэшРасчетныеОборотыДетализацияПартийТоваровДляНДСиУСН КАК Партии
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДвиженияСебестоимости КАК ДвиженияСебестоимости
	|		 ПО ДвиженияСебестоимости.Период = Партии.Период
	|		 И ДвиженияСебестоимости.Регистратор = Партии.Регистратор
	|		 И ДвиженияСебестоимости.Организация = Партии.Организация
	|		 И ДвиженияСебестоимости.АналитикаУчетаНоменклатуры = Партии.АналитикаУчетаНоменклатуры
	|		 И ДвиженияСебестоимости.Партия = Партии.Партия
	|		 И ДвиженияСебестоимости.АналитикаФинансовогоУчета = Партии.АналитикаФинансовогоУчета
	|		 И ДвиженияСебестоимости.ВидДеятельностиНДС = Партии.ВидДеятельностиНДС
	|	ГДЕ
	|		&ПартионныйУчетВерсии22
	|		И Партии.Организация В(&ОрганизацииСУчетомПартийНДСВерсии22)
	|		И НЕ Партии.СлужебноеВидДвиженияПриход
	|
	|	) КАК Партии
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|	ПО
	|		ДанныеПервичныхДокументов.Организация = Партии.Организация
	|		И ДанныеПервичныхДокументов.Документ = Партии.ДокументПоступления
	|	
	|ГДЕ
	|	НЕ Партии.НалогообложениеПартии ЕСТЬ NULL
	|	И Партии.НалогообложениеПартии <> Партии.НалогообложениеНДС
	|	И Партии.НалогообложениеНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|
	|СГРУППИРОВАТЬ ПО
	|	Партии.Период,
	|	Партии.Регистратор,
	|	Партии.Организация,
	|	Партии.АналитикаУчетаНоменклатуры,
	|	Партии.КорАналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов,
	|	Партии.Партия,
	|	Партии.АналитикаФинансовогоУчета,
	|	Партии.КорАналитикаФинансовогоУчета,
	|	Партии.СтатьяРасходовСписания,
	|	Партии.АналитикаРасходов,
	|	Партии.СтатьяСписанияНДС,
	|	Партии.АналитикаСписанияНДС,
	|	Партии.НалогообложениеПартии,
	|	Партии.Сторно
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Партии.Регистратор КАК Регистратор
	|ПОМЕСТИТЬ ВтРегистраторы
	|ИЗ
	|	ВтПартии КАК Партии
	|ГДЕ
	|	Партии.НДСРегл <> 0
	|	ИЛИ Партии.НДСУпр <> 0
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	2 КАК Порядок,
	|	УчетСебестоимости.Период КАК Период,
	|	УчетСебестоимости.Регистратор КАК Регистратор,
	|	УчетСебестоимости.Организация КАК Организация,
	|	УчетСебестоимости.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	УчетСебестоимости.ВидЗапасов КАК ВидЗапасов,
	|	УчетСебестоимости.Партия КАК Партия,
	|	ВЫБОР КОГДА &ПартионныйУчетВерсии22
	|		ТОГДА УчетСебестоимости.ВидДеятельностиНДС
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|	КОНЕЦ КАК ВидДеятельностиНДС,
	|	УчетСебестоимости.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	ВЫБОР КОГДА УчетСебестоимости.СтатьяРасходовСписания = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ УчетСебестоимости.СтатьяРасходовСписания
	|	КОНЕЦ КАК СтатьяРасходовСписания,
	|	УчетСебестоимости.АналитикаРасходов КАК АналитикаРасходов,
	|	УчетСебестоимости.Сторно КАК Сторно,
	|
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	УчетСебестоимости.РазделУчета КАК РазделУчета,
	|	УчетСебестоимости.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	УчетСебестоимости.ЗаказКлиента КАК ЗаказКлиента,
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ УчетСебестоимости.ХозяйственнаяОперация КОНЕЦ) КАК ХозяйственнаяОперация,
	|	УчетСебестоимости.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|	УчетСебестоимости.КорРазделУчета КАК КорРазделУчета,
	|	УчетСебестоимости.КорВидЗапасов КАК КорВидЗапасов,
	|	УчетСебестоимости.КорОрганизация КАК КорОрганизация,
	|	УчетСебестоимости.Подразделение КАК Подразделение,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовУпр КАК ВариантРаспределенияРасходовУпр,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовРегл КАК ВариантРаспределенияРасходовРегл,
	|	ЕСТЬNULL(УчетСебестоимости.СтатьяРасходовСписания.ПринятиеКНалоговомуУчету, ЛОЖЬ) КАК ПринятиеКНалоговомуУчету,
	|	УчетСебестоимости.ГруппаПродукции КАК ГруппаПродукции,
	|	ЕСТЬNULL(СпрНазначения.НаправлениеДеятельности,
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
	|	УчетСебестоимости.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	УчетСебестоимости.КорПартия,
	|	УчетСебестоимости.КорАналитикаУчетаПартий,
	|	УчетСебестоимости.КорАналитикаФинансовогоУчета,
	|	УчетСебестоимости.КорВидДеятельностиНДС,
	|	УчетСебестоимости.Регистратор КАК ДокументДвижения,
	|	ЛОЖЬ КАК ЭтоПередачаМеждуОрганизациями,
	|	&ИдентификаторНеиспользуемойФинЗаписи КАК ИдентификаторФинЗаписи,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВключениеИсключениеНДСВСтоимости) КАК ТипЗаписи,
	|
	|	СУММА(ВЫБОР
	|		КОГДА УчетСебестоимости.ТипЗаписи В (
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам),
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
	|			ТОГДА (ВЫБОР
	|				КОГДА УчетСебестоимости.ДопРасходыРегл = 0 ТОГДА УчетСебестоимости.НДСРегл
	|				ИНАЧЕ УчетСебестоимости.ДопРасходыРегл КОНЕЦ)
	|		ИНАЧЕ УчетСебестоимости.Количество КОНЕЦ) КАК Количество,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК ДопРасходы,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК СтоимостьЗабалансовая,
	|	0 КАК СтоимостьЗабалансоваяРегл,
	|	0 КАК СтоимостьРегл,
	|	0 КАК СтоимостьУпр,
	|	0 КАК ДопРасходыРегл,
	|	0 КАК ДопРасходыУпр,
	|	0 КАК НДСРегл,
	|	0 КАК НДСУпр,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	0 КАК СтоимостьНДД,
	|	СУММА(УчетСебестоимости.Количество) КАК ИсходноеКоличество,
	|	ВЫБОР
	|		КОГДА СУММА(ЕСТЬNULL(Цены.СтоимостьНДД, 0)) = 0
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ЕстьСтоимостьНДД
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК УчетСебестоимости
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтРегистраторы КАК Регистраторы
	|		ПО Регистраторы.Регистратор = УчетСебестоимости.Регистратор
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаНоменклатуры
	|		ПО УчетСебестоимости.АналитикаУчетаНоменклатуры = АналитикаНоменклатуры.Ссылка
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК СпрНазначения
	|		ПО СпрНазначения.Ссылка = АналитикаНоменклатуры.Назначение
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КорАналитикаНоменклатуры
	|		ПО УчетСебестоимости.КорАналитикаУчетаНоменклатуры = КорАналитикаНоменклатуры.Ссылка
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТСтоимостьПартийТоваров КАК Цены
	|		ПО Цены.Организация = УчетСебестоимости.Организация
	|		И Цены.Партия = УчетСебестоимости.Партия
	|		И Цены.АналитикаУчетаПартий = УчетСебестоимости.АналитикаУчетаПартий
	|		И Цены.АналитикаФинансовогоУчета = УчетСебестоимости.АналитикаФинансовогоУчета
	|		И Цены.ВидДеятельностиНДС = УчетСебестоимости.ВидДеятельностиНДС
	|		И Цены.АналитикаУчетаНоменклатуры = УчетСебестоимости.АналитикаУчетаНоменклатуры
	|		И Цены.ВидЗапасов = УчетСебестоимости.ВидЗапасов
	|		И Цены.РазделУчета = УчетСебестоимости.РазделУчета
	|ГДЕ
	|	НЕ УчетСебестоимости.СлужебноеВидДвиженияПриход
	|	И (УчетСебестоимости.КорРазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|		ИЛИ УчетСебестоимости.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			И УчетСебестоимости.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО)
	|	И УчетСебестоимости.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|	И УчетСебестоимости.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию)
	|	И УчетСебестоимости.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
	|	И НЕ УчетСебестоимости.Сторно
	|	
	|СГРУППИРОВАТЬ ПО
	|	УчетСебестоимости.Период,
	|	УчетСебестоимости.Регистратор,
	|	УчетСебестоимости.Организация,
	|	УчетСебестоимости.АналитикаУчетаНоменклатуры,
	|	УчетСебестоимости.ВидЗапасов,
	|	УчетСебестоимости.Партия,
	|	ВЫБОР КОГДА &ПартионныйУчетВерсии22
	|		ТОГДА УчетСебестоимости.ВидДеятельностиНДС
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|	КОНЕЦ,
	|	УчетСебестоимости.АналитикаФинансовогоУчета,
	|	ВЫБОР КОГДА УчетСебестоимости.СтатьяРасходовСписания = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ УчетСебестоимости.СтатьяРасходовСписания
	|	КОНЕЦ,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовУпр,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовРегл,
	|	ЕСТЬNULL(УчетСебестоимости.СтатьяРасходовСписания.ПринятиеКНалоговомуУчету, ЛОЖЬ),
	|	УчетСебестоимости.АналитикаРасходов,
	|	УчетСебестоимости.Сторно,
	|
	|	УчетСебестоимости.РазделУчета,
	|	УчетСебестоимости.АналитикаУчетаПоПартнерам,
	|	УчетСебестоимости.ЗаказКлиента,
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ УчетСебестоимости.ХозяйственнаяОперация КОНЕЦ),
	|	УчетСебестоимости.КорАналитикаУчетаНоменклатуры,
	|	УчетСебестоимости.КорРазделУчета,
	|	УчетСебестоимости.КорВидЗапасов,
	|	УчетСебестоимости.КорОрганизация,
	|	УчетСебестоимости.Подразделение,
	|	УчетСебестоимости.ГруппаПродукции,
	|	ЕСТЬNULL(СпрНазначения.НаправлениеДеятельности,
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
	|	УчетСебестоимости.КорНаправлениеДеятельности,
	|	УчетСебестоимости.КорПартия,
	|	УчетСебестоимости.КорАналитикаУчетаПартий,
	|	УчетСебестоимости.КорАналитикаФинансовогоУчета,
	|	УчетСебестоимости.КорВидДеятельностиНДС
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	1 КАК Порядок,
	|	Партии.Период КАК Период,
	|	Партии.Регистратор КАК Регистратор,
	|	Партии.Организация КАК Организация,
	|	Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов КАК ВидЗапасов,
	|	Партии.Партия КАК Партия,
	|	ВЫБОР КОГДА &ПартионныйУчетВерсии22
	|		ТОГДА Партии.НалогообложениеПартии
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|	КОНЕЦ КАК ВидДеятельностиНДС,
	|	Партии.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Партии.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	Партии.АналитикаРасходов КАК АналитикаРасходов,
	|	Партии.Сторно КАК Сторно,
	|
	|	НЕОПРЕДЕЛЕНО КАК ВидДвижения,
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
	|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
	|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
	|	Партии.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
	|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
	|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
	|	НЕОПРЕДЕЛЕНО КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовУпр,
	|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовРегл,
	|	НЕОПРЕДЕЛЕНО КАК ПринятиеКНалоговомуУчету,
	|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК КорПартия,
	|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
	|	Партии.КорАналитикаФинансовогоУчета КАК КорАналитикаФинансовогоУчета,
	|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
	|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
	|	ЛОЖЬ 		 КАК ЭтоПередачаМеждуОрганизациями,
	|	"""" КАК ИдентификаторФинЗаписи,
	|	НЕОПРЕДЕЛЕНО КАК ТипЗаписи,
	|
	|	СУММА(Партии.Количество) КАК Количество,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК ДопРасходы,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК СтоимостьЗабалансовая,
	|	0 КАК СтоимостьЗабалансоваяРегл,
	|	СУММА(Партии.НДСРегл) КАК СтоимостьРегл,
	|	СУММА(Партии.НДСУпр) КАК СтоимостьУпр,
	|	0 КАК ДопРасходыРегл,
	|	0 КАК ДопРасходыУпр,
	|	0 КАК НДСРегл,
	|	0 КАК НДСУпр,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	СУММА(Партии.НДСРегл) КАК СтоимостьНДД,
	|	0 КАК ИсходноеКоличество,
	|	ЛОЖЬ КАК ЕстьСтоимостьНДД
	|ИЗ
	|	ВтПартии КАК Партии
	|		
	|ГДЕ
	|	Партии.Количество > 0
	|
	|СГРУППИРОВАТЬ ПО
	|	Партии.Период,
	|	Партии.Регистратор,
	|	Партии.Организация,
	|	Партии.АналитикаУчетаНоменклатуры,
	|	Партии.КорАналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов,
	|	Партии.Партия,
	|	ВЫБОР КОГДА &ПартионныйУчетВерсии22
	|		ТОГДА Партии.НалогообложениеПартии
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|	КОНЕЦ,
	|	Партии.АналитикаФинансовогоУчета,
	|	Партии.КорАналитикаФинансовогоУчета,
	|	Партии.СтатьяРасходовСписания,
	|	Партии.АналитикаРасходов,
	|	Партии.Сторно
	|
	|ИМЕЮЩИЕ
	|	СУММА(Партии.НДСРегл) <> 0
	|	ИЛИ СУММА(Партии.НДСУпр) <> 0
	|
	|УПОРЯДОЧИТЬ ПО
	|	Регистратор,
	|	Организация,
	|	АналитикаУчетаНоменклатуры,
	|	ВидЗапасов,
	|	Партия,
	|	ВидДеятельностиНДС,
	|	АналитикаФинансовогоУчета,
	|	СтатьяРасходовСписания,
	|	АналитикаРасходов,
	|	КорАналитикаУчетаНоменклатуры,
	|	КорАналитикаФинансовогоУчета,
	|	Сторно,
	|	Порядок
	|";
	
	ЗаписьРаспределения = Новый Структура("
	|Период, АналитикаУчетаНоменклатуры, РазделУчета, ВидЗапасов, Организация, Склад, Партия, АналитикаФинансовогоУчета,
	|ХозяйственнаяОперация, ЗаказКлиента, ТипЗапасов, АналитикаУчетаПоПартнерам, ЭтоПередачаМеждуОрганизациями,
	|КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорТипЗапасов, КорОрганизация,
	|АналитикаУчетаНоменклатурыВО, АналитикаФинансовогоУчетаВО, АналитикаАктивовПассивов, КорСклад,
	|СтатьяАктивовПассивов, Подразделение, АналитикаРасходов, СтатьяРасходовСписания, СтатьяДоходов, АналитикаДоходов,
	|ВариантРаспределенияРасходовУпр, ВариантРаспределенияРасходовРегл,
	|ДокументДвижения, ИдентификаторСтроки, ПринятиеКНалоговомуУчету, ГруппаПродукции, СписаниеПриПередачеНУ,
	|ИсточникГФУНоменклатуры, КорИсточникГФУНоменклатуры, НаправлениеДеятельности, КорНаправлениеДеятельности,
	|Стоимость, СтоимостьБезНДС, Количество, КорСтоимость, ПостояннаяРазница, ВременнаяРазница, СтоимостьНДД,
	|ДопРасходы, ДопРасходыБезНДС, СтоимостьРегл, НДСРегл,
	|КорПартия, КорАналитикаУчетаПартий, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС, ВидДеятельностиНДС,
	|СтатьяКалькуляции, ТипЗаписи, ДокументИсточник, ИдентификаторФинЗаписи, Сторно,
	|СтоимостьЗабалансовая, Трудозатраты, ПостатейныеПостоянныеСНДС, ПостатейныеПостоянныеБезНДС,
	|СтоимостьЗабалансоваяРегл, ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеПостоянныеРегл,
	|ПостатейныеПеременныеСНДС, ПостатейныеПеременныеБезНДС, ПостатейныеПеременныеРегл,
	|СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр, НДСУпр
	|");
	
	СуммыРаспределения = Новый Структура("
	|Количество, Стоимость, СтоимостьБезНДС, СтоимостьЗабалансовая, СтоимостьРегл, СтоимостьУпр, СтоимостьЗабалансоваяРегл, НДСРегл, НДСУпр,
	|ДопРасходы, ДопРасходыБезНДС, ДопРасходыРегл, ДопРасходыУпр, ПостояннаяРазница, ВременнаяРазница, СтоимостьНДД
	|");
	
	СтрокаОстатка = Новый Структура("
	|Регистратор, Организация, АналитикаУчетаНоменклатуры, ВидЗапасов, Партия, АналитикаФинансовогоУчета, СтатьяРасходовСписания, АналитикаРасходов,
	|КорАналитикаУчетаНоменклатуры, КорАналитикаФинансовогоУчета, Сторно, ВидДеятельностиНДС,
	|Количество, Стоимость, СтоимостьБезНДС, СтоимостьЗабалансовая, СтоимостьРегл, СтоимостьУпр, СтоимостьЗабалансоваяРегл, НДСРегл, НДСУпр,
	|ДопРасходы, ДопРасходыБезНДС, ДопРасходыРегл, ДопРасходыУпр, ПостояннаяРазница, ВременнаяРазница, СтоимостьНДД
	|");
	
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина,,,
		Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя);
	
	// Формируются движения по регистрам:
	// - СебестоимостьТоваров
	// - ПрочиеРасходы
	Пока Выборка.Следующий() Цикл
		
		Если Выборка.Порядок = 1 Тогда
			
			ЗаполнитьЗначенияСвойств(СтрокаОстатка, Выборка);
			
		ИначеЕсли СтрокаОстатка.Регистратор = Выборка.Регистратор
			И СтрокаОстатка.Организация = Выборка.Организация
			И СтрокаОстатка.АналитикаУчетаНоменклатуры = Выборка.АналитикаУчетаНоменклатуры
			И (СтрокаОстатка.КорАналитикаУчетаНоменклатуры = Выборка.КорАналитикаУчетаНоменклатуры
				ИЛИ НЕ ЗначениеЗаполнено(Выборка.КорРазделУчета))
			И СтрокаОстатка.ВидЗапасов = Выборка.ВидЗапасов
			И СтрокаОстатка.Партия = Выборка.Партия
			И СтрокаОстатка.ВидДеятельностиНДС = Выборка.ВидДеятельностиНДС
			И СтрокаОстатка.АналитикаФинансовогоУчета = Выборка.АналитикаФинансовогоУчета
			И (СтрокаОстатка.КорАналитикаФинансовогоУчета = Выборка.КорАналитикаФинансовогоУчета
				ИЛИ НЕ ЗначениеЗаполнено(Выборка.КорРазделУчета))
			И СтрокаОстатка.СтатьяРасходовСписания = Выборка.СтатьяРасходовСписания
			И СтрокаОстатка.АналитикаРасходов = Выборка.АналитикаРасходов
			И СтрокаОстатка.Сторно = Выборка.Сторно Тогда
				
			Если СтрокаОстатка.Количество = 0 Тогда
				Продолжить;
			КонецЕсли;
			
			ЗаполнитьЗначенияСвойств(ЗаписьРаспределения, Выборка);
			
			// Если в себестоимости нет суммы НДД, то включать/исключать НДС в стоимость НДД не нужно
			Если Выборка.ЕстьСтоимостьНДД = Ложь Тогда
				СтрокаОстатка.СтоимостьНДД = 0;
			КонецЕсли;
			
			РасчетСебестоимостиКорректировкаСтоимости.РаспределитьСтоимость(СуммыРаспределения, СтрокаОстатка, Выборка, Выборка.Количество);
			РасчетСебестоимостиКорректировкаСтоимости.ДополнитьСуммыРаспределения(ЗаписьРаспределения, СуммыРаспределения);
			
			Если ЗаписьРаспределения.СтоимостьРегл <> 0 ИЛИ ЗаписьРаспределения.СтоимостьУпр <> 0 
				ИЛИ ЗаписьРаспределения.СтоимостьНДД <> 0 Тогда
					
				// Если есть кор. раздел - необходимо скорректировать стоимость в кор. части.
				Если ЗначениеЗаполнено(ЗаписьРаспределения.КорРазделУчета) Тогда
					
					РасчетСебестоимостиКорректировкаСтоимости.СформироватьКорДвиженияСебестоимостьТоваров(ПараметрыРасчета, ЗаписьРаспределения, ПараметрыРасчета.ПредварительныйРасчет);
							
				КонецЕсли;
				
				Если ПараметрыРасчета.ПредварительныйРасчет Тогда
					Продолжить;
				КонецЕсли;
				
				// Корректировка списания товаров на затраты в регистре учет прочих расходов.
				Если Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СписаниеТоваров
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СписаниеТоваровПоТребованию
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СторноСписанияНаРасходы
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПересортицаТоваровСПереоценкой
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПорчаТоваровСПереоценкой
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратТоваровПоставщику
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПересортицаПартийТоваров
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СписаниеРасхожденийПоступлениеПриобретение
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаНаПрочиеЦели
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаВЭксплуатацию
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ОтчетКомиссионераОСписании Тогда
				 	
				 	СуммовыеПоказатели = Новый Структура;
					СуммовыеПоказатели.Вставить("СуммаСНДС", 0);
					СуммовыеПоказатели.Вставить("СуммаБезНДС", 0);
					СуммовыеПоказатели.Вставить("СуммаРегл", ЗаписьРаспределения.СтоимостьРегл);
					СуммовыеПоказатели.Вставить("СуммаУпр", ЗаписьРаспределения.СтоимостьУпр);
					СуммовыеПоказатели.Вставить("ПостояннаяРазница", 0);
					СуммовыеПоказатели.Вставить("ВременнаяРазница", 0);
					СуммовыеПоказатели.Вставить("СуммаНДД", ЗаписьРаспределения.СтоимостьНДД);
				 
				 	РасчетСебестоимостиКорректировкаСтоимости.СформироватьДвиженияПрочиеРасходы(
				 		ПараметрыРасчета,
						ЗаписьРаспределения,
						СуммовыеПоказатели);
					
				КонецЕсли;

			КонецЕсли;
			
		КонецЕсли;

	КонецЦикла;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, "РасходыПартий, ДвиженияСебестоимости, ВтПартии, ВтРегистраторы");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвижения(ПараметрыРасчета);
	
КонецПроцедуры

// Этап 3.1.2
Процедура ВключитьИсключитьНДСВСтоимость24(ПараметрыРасчета, ТолькоПостатейные) Экспорт
	
	Если НЕ РасчетСебестоимостиПрикладныеАлгоритмы.ВременнаяТаблицаСуществует(ПараметрыРасчета, "ВТОборотыСтоимостьПартийНДС") Тогда
		Возврат;
	КонецЕсли;
		
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "ВключитьИсключитьНДСВСтоимость24");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	Запрос.УстановитьПараметр("ТолькоПостатейные", ТолькоПостатейные);
	
	#Область ВТСписаниеПостатейныхЗатрат
	
	Если ТолькоПостатейные Тогда
		
		Запрос.Текст =
		"ВЫБРАТЬ
		|	Т.Регистратор,
		|	Т.Организация,
		|	Т.КорАналитикаУчетаНоменклатуры,
		|	Т.КорВидЗапасов,
		|	Т.ВидДеятельностиНДС,
		|	Т.КорВидДеятельностиНДС,
		|	Т.КорНаправлениеДеятельности,
		|	Т.КорПодразделение,
		|
		|	Т.СтатьяРасходовАктивов,
		|	Статьи.ХарактерПроизводственныхЗатрат КАК ХарактерПроизводственныхЗатрат,
		|	Т.АналитикаРасходов
		|ПОМЕСТИТЬ ВТНДССписаниеНаВыпуск
		|ИЗ
		|	ВТСписаниеПостатейныхЗатрат КАК Т
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статьи
		|		ПО Т.СтатьяРасходовАктивов = Статьи.Ссылка
		|ГДЕ
		|	&ПартионныйУчетВерсии22
		|	И Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпускПостатейные)
		|	И Т.ВидДеятельностиНДС <> Т.КорВидДеятельностиНДС
		|	И Т.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор,
		|	КорАналитикаУчетаНоменклатуры
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Т.Период,
		|	Т.Регистратор,
		|	Т.Организация КАК Организация,
		|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.РазделУчета,
		|	Т.Партия КАК Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.АналитикаФинансовогоУчета,
		|	Т.ВидДеятельностиНДС КАК КорВидДеятельностиНДС,
		|	Списание.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|
		|	Т.ДокументПоступления,
		|	Т.СтатьяРасходовАктивов,
		|	Т.АналитикаРасходов,
		|	Списание.ХарактерПроизводственныхЗатрат,
		|	ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Т.СтатьяСписанияНДС) = ТИП(ПланВидовХарактеристик.СтатьиРасходов)
		|		ТОГДА Т.СтатьяСписанияНДС
		|		ИНАЧЕ ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|	КОНЕЦ КАК СтатьяСписанияНДС,
		|	Т.АналитикаСписанияНДС,
		|
		|	ВЫБОР
		|		КОГДА Т.НДСРегл > 0
		|			ТОГДА Т.НДСРегл
		|		КОГДА Т.НДСРегл < 0
		|			ТОГДА -Т.НДСРегл
		|		КОГДА Т.НДСУпр > 0
		|			ТОГДА Т.НДСУпр
		|			ИНАЧЕ -Т.НДСУпр
		|	КОНЕЦ КАК Количество,
		|	Т.СтоимостьБезНДСРегл,
		|	Т.СтоимостьБезНДСУпр,
		|	Т.НДСРегл,
		|	Т.НДСУпр
		|ПОМЕСТИТЬ ВТВключениеИсключениеНДСПостатейные
		|ИЗ
		|	ВТСписаниеПостатейныхЗатрат КАК Т
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТНДССписаниеНаВыпуск КАК Списание
		|		ПО Т.Регистратор = Списание.Регистратор
		|		И Т.АналитикаУчетаНоменклатуры = Списание.КорАналитикаУчетаНоменклатуры
		|		И Т.ВидЗапасов = Списание.КорВидЗапасов
		|		И Т.Организация = Списание.Организация
		|		И Т.ВидДеятельностиНДС = Списание.КорВидДеятельностиНДС
		|		И Т.НаправлениеДеятельности = Списание.КорНаправлениеДеятельности
		|		И Т.Подразделение = Списание.КорПодразделение
		|		И Т.СтатьяРасходовАктивов = Списание.СтатьяРасходовАктивов
		|		И Т.АналитикаРасходов = Списание.АналитикаРасходов
		|ГДЕ
		|	Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры,
		|	Организация,
		|	Партия
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Т.Период,
		|	Т.Регистратор,
		|	Т.Организация,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.РазделУчета,
		|	Т.Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.АналитикаФинансовогоУчета,
		|	Т.КорВидДеятельностиНДС,
		|	Т.ВидДеятельностиНДС,
		|
		|	СУММА(Т.Количество) КАК Количество
		|ПОМЕСТИТЬ ВТВключениеИсключениеНДСПостатейныеСвернуто
		|ИЗ
		|	ВТВключениеИсключениеНДСПостатейные КАК Т
		|СГРУППИРОВАТЬ ПО
		|	Т.Период,
		|	Т.Регистратор,
		|	Т.Организация,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.РазделУчета,
		|	Т.Партия,
		|	Т.АналитикаУчетаПартий,
		|	Т.АналитикаФинансовогоУчета,
		|	Т.КорВидДеятельностиНДС,
		|	Т.ВидДеятельностиНДС
		|;
		|";
		
	Иначе
		
		Запрос.Текст =
		"ВЫБРАТЬ ПЕРВЫЕ 0
		|	НЕОПРЕДЕЛЕНО КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК Организация,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК Партия,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК ВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ХарактерПроизводственныхЗатрат,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|
		|	0 КАК Количество,
		|	0 КАК СтоимостьБезНДСРегл,
		|	0 КАК СтоимостьБезНДСУпр,
		|	0 КАК НДСРегл,
		|	0 КАК НДСУпр
		|ПОМЕСТИТЬ ВТВключениеИсключениеНДСПостатейные
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	НЕОПРЕДЕЛЕНО КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК Организация,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК Партия,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК ВидДеятельностиНДС,
		|
		|	0 КАК Количество
		|ПОМЕСТИТЬ ВТВключениеИсключениеНДСПостатейныеСвернуто
		|;";
		
	КонецЕсли;
	
	#КонецОбласти
	
	#Область ВтПартии
	Запрос.Текст = Запрос.Текст + "
	|ВЫБРАТЬ
	|	Партии.СлужебноеВидДвиженияПриход,
	|	Партии.Период,
	|	Партии.Регистратор,
	|	Партии.Организация,
	|	Партии.АналитикаУчетаНоменклатуры,
	|	Партии.КорАналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов,
	|	Партии.РазделУчета,
	|	Партии.Партия,
	|	Партии.АналитикаУчетаПартий,
	|	Партии.АналитикаФинансовогоУчета,
	|	Партии.ВидДеятельностиНДС,
	|
	|	ВЫБОР КОГДА Партии.СтатьяРасходовСписания = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ Партии.СтатьяРасходовСписания
	|	КОНЕЦ КАК СтатьяРасходовСписания,
	|	Партии.АналитикаРасходов,
	|	Партии.КорВидДеятельностиНДС,
	|	Партии.СтатьяСписанияНДС,
	|	Партии.Сторно КАК Сторно,
	|	Партии.ХарактерПроизводственныхЗатрат,
	|
	|	СУММА(Партии.Количество) КАК Количество,
	|	СУММА(Партии.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	СУММА(Партии.СтоимостьБезНДСУпр) КАК СтоимостьБезНДСУпр,
	|	СУММА(
	|		ВЫБОР КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА 0
	|		КОГДА Партии.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		ТОГДА
	|			Партии.НДСРегл
	|
	|		КОГДА Партии.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) < &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			Партии.НДСРегл
	|
	|		КОГДА Партии.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		ТОГДА
	|			-Партии.НДСРегл
	|		КОГДА Партии.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) >= &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			-Партии.НДСРегл
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ * Партии.Знак
	|	) КАК НДСРегл,
	|	СУММА(
	|		ВЫБОР КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА 0
	|		КОГДА Партии.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		ТОГДА
	|			Партии.НДСУпр
	|
	|		КОГДА Партии.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) < &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			Партии.НДСУпр
	|
	|		КОГДА Партии.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		ТОГДА
	|			-Партии.НДСУпр
	|		КОГДА Партии.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) >= &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			-Партии.НДСУпр
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ * Партии.Знак
	|	) КАК НДСУпр
	|
	|ПОМЕСТИТЬ ВтПартии
	|ИЗ (
	|	ВЫБРАТЬ
	|		Партии.СлужебноеВидДвиженияПриход,
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.АналитикаУчетаНоменклатуры,
	|		Партии.КорАналитикаУчетаНоменклатуры,
	|		Партии.ВидЗапасов,
	|		Партии.РазделУчета,
	|		Партии.Партия,
	|		Партии.АналитикаУчетаПартий,
	|		Партии.АналитикаФинансовогоУчета,
	|		ВЫБОР КОГДА Партии.СлужебноеВидДвиженияПриход
	|			ТОГДА Партии.КорВидДеятельностиНДС
	|			ИНАЧЕ Партии.ВидДеятельностиНДС
	|		КОНЕЦ КАК ВидДеятельностиНДС,
	|
	|		Партии.ДокументПоступления КАК ДокументПоступления,
	|		Партии.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|		Партии.АналитикаРасходов КАК АналитикаРасходов,
	|		ВЫБОР КОГДА Партии.СлужебноеВидДвиженияПриход
	|			ТОГДА Партии.ВидДеятельностиНДС
	|			ИНАЧЕ Партии.КорВидДеятельностиНДС
	|		КОНЕЦ КАК КорВидДеятельностиНДС,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС,
	|		Партии.Сторно,
	|		Партии.ХарактерПроизводственныхЗатрат,
	|
	|       ВЫБОР КОГДА Партии.СлужебноеВидДвиженияПриход
	|		  И Партии.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноСписанияНаРасходы)
	|			ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ КАК Знак,
	|		Партии.Количество,
	|		Партии.СтоимостьБезНДСРегл КАК СтоимостьБезНДС,
	|		Партии.СтоимостьБезНДСУпр КАК СтоимостьБезНДСУпр,
	|		Партии.НДСРегл КАК НДСРегл,
	|		Партии.НДСУпр КАК НДСУпр
	|	ИЗ
	|		ВТОборотыСтоимостьПартийНДС КАК Партии
	|	ГДЕ
	|		&ПартионныйУчетВерсии22
	|		И Партии.Организация В(&ОрганизацииСУчетомПартийНДСВерсии24)
	|		И (НЕ Партии.СлужебноеВидДвиженияПриход
	|			ИЛИ Партии.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов))
	|		И НЕ (Партии.Сторно
	|			И Партии.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ИсправлениеПрошлогоПериода))
	|		И (НЕ &ТолькоПостатейные
	|			И Партии.ХарактерПроизводственныхЗатрат = НЕОПРЕДЕЛЕНО
	|			ИЛИ &ТолькоПостатейные
	|			И Партии.ХарактерПроизводственныхЗатрат <> НЕОПРЕДЕЛЕНО
	|			)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		ЛОЖЬ КАК СлужебноеВидДвиженияПриход,
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Партии.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|		Партии.ВидЗапасов КАК ВидЗапасов,
	|		Партии.РазделУчета КАК РазделУчета,
	|		Партии.Партия,
	|		Партии.АналитикаУчетаПартий,
	|		Партии.АналитикаФинансовогоУчета,
	|		Партии.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|
	|		Партии.ДокументПоступления КАК ДокументПоступления,
	|		ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|		Партии.КорВидДеятельностиНДС КАК КорВидДеятельностиНДС,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС,
	|		ЛОЖЬ КАК Сторно,
	|		Партии.ХарактерПроизводственныхЗатрат,
	|
	|       1 КАК Знак,
	|		Партии.Количество КАК Количество,
	|		Партии.СтоимостьБезНДСРегл КАК СтоимостьБезНДС,
	|		Партии.СтоимостьБезНДСУпр КАК СтоимостьБезНДСУпр,
	|		Партии.НДСРегл КАК НДСРегл,
	|		Партии.НДСУпр КАК НДСУпр
	|	ИЗ
	|		ВТВключениеИсключениеНДСПостатейные КАК Партии
	|
	|	) КАК Партии
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|	ПО
	|		ДанныеПервичныхДокументов.Организация = Партии.Организация
	|		И ДанныеПервичныхДокументов.Документ = Партии.ДокументПоступления
	|ГДЕ
	|	НЕ Партии.ВидДеятельностиНДС ЕСТЬ NULL
	|	И Партии.ВидДеятельностиНДС <> Партии.КорВидДеятельностиНДС
	|	И Партии.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|
	|СГРУППИРОВАТЬ ПО
	|	Партии.СлужебноеВидДвиженияПриход,
	|	Партии.Период,
	|	Партии.Регистратор,
	|	Партии.Организация,
	|	Партии.АналитикаУчетаНоменклатуры,
	|	Партии.КорАналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов,
	|	Партии.РазделУчета,
	|	Партии.Партия,
	|	Партии.АналитикаУчетаПартий,
	|	Партии.АналитикаФинансовогоУчета,
	|	Партии.ВидДеятельностиНДС,
	|
	|	ВЫБОР КОГДА Партии.СтатьяРасходовСписания = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ Партии.СтатьяРасходовСписания
	|	КОНЕЦ,
	|	Партии.АналитикаРасходов,
	|	Партии.КорВидДеятельностиНДС,
	|	Партии.СтатьяСписанияНДС,
	|	Партии.Сторно,
	|	Партии.ХарактерПроизводственныхЗатрат
	|;";
	#КонецОбласти
	
	#Область ВтРегистраторы
	Запрос.Текст = Запрос.Текст + "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Партии.Регистратор КАК Регистратор
	|ПОМЕСТИТЬ ВтРегистраторы
	|ИЗ
	|	ВтПартии КАК Партии
	|ГДЕ
	|	Партии.НДСРегл <> 0
	|	ИЛИ Партии.НДСУпр <> 0
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;";
	#КонецОбласти
	
	#Область ВТСебестоимость
	Запрос.Текст = Запрос.Текст + "
	|ВЫБРАТЬ
	|	УчетСебестоимости.Период КАК Период,
	|	УчетСебестоимости.Регистратор КАК Регистратор,
	|	УчетСебестоимости.Организация КАК Организация,
	|	УчетСебестоимости.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	УчетСебестоимости.ВидЗапасов КАК ВидЗапасов,
	|	УчетСебестоимости.Партия КАК Партия,
	|	УчетСебестоимости.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	УчетСебестоимости.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	ВЫБОР КОГДА УчетСебестоимости.СтатьяРасходовСписания = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ УчетСебестоимости.СтатьяРасходовСписания
	|	КОНЕЦ КАК СтатьяРасходовСписания,
	|	УчетСебестоимости.АналитикаРасходов КАК АналитикаРасходов,
	|
	|	УчетСебестоимости.РазделУчета КАК РазделУчета,
	|	УчетСебестоимости.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	УчетСебестоимости.ЗаказКлиента КАК ЗаказКлиента,
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ УчетСебестоимости.ХозяйственнаяОперация КОНЕЦ) КАК ХозяйственнаяОперация,
	|
	|	ВЫБОР КОГДА НЕ НДСПостатейные.Регистратор ЕСТЬ NULL
	|			ТОГДА УчетСебестоимости.АналитикаУчетаНоменклатуры
	|		ИНАЧЕ УчетСебестоимости.КорАналитикаУчетаНоменклатуры
	|	КОНЕЦ КАК КорАналитикаУчетаНоменклатуры,
	|	ВЫБОР КОГДА НЕ НДСПостатейные.Регистратор ЕСТЬ NULL
	|			ТОГДА УчетСебестоимости.РазделУчета
	|		ИНАЧЕ УчетСебестоимости.КорРазделУчета
	|	КОНЕЦ КАК КорРазделУчета,
	|	ВЫБОР КОГДА НЕ НДСПостатейные.Регистратор ЕСТЬ NULL
	|			ТОГДА УчетСебестоимости.ВидЗапасов
	|		ИНАЧЕ УчетСебестоимости.КорВидЗапасов
	|	КОНЕЦ КАК КорВидЗапасов,
	|	УчетСебестоимости.КорОрганизация КАК КорОрганизация,
	|	УчетСебестоимости.Подразделение КАК Подразделение,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовУпр КАК ВариантРаспределенияРасходовУпр,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовРегл КАК ВариантРаспределенияРасходовРегл,
	|	ЕСТЬNULL(УчетСебестоимости.СтатьяРасходовСписания.ПринятиеКНалоговомуУчету, ЛОЖЬ) КАК ПринятиеКНалоговомуУчету,
	|	УчетСебестоимости.ГруппаПродукции КАК ГруппаПродукции,
	|	ЕСТЬNULL(СпрНазначения.НаправлениеДеятельности,
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
	|	УчетСебестоимости.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	ВЫБОР КОГДА УчетСебестоимости.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
	|	  ИЛИ НЕ НДСПостатейные.Регистратор ЕСТЬ NULL
	|		ТОГДА УчетСебестоимости.Партия
	|		ИНАЧЕ УчетСебестоимости.КорПартия
	|	КОНЕЦ КАК КорПартия,
	|	ВЫБОР КОГДА УчетСебестоимости.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
	|	  ИЛИ НЕ НДСПостатейные.Регистратор ЕСТЬ NULL
	|		ТОГДА УчетСебестоимости.АналитикаУчетаПартий
	|		ИНАЧЕ УчетСебестоимости.КорАналитикаУчетаПартий
	|	КОНЕЦ КАК КорАналитикаУчетаПартий,
	|	ВЫБОР КОГДА НЕ НДСПостатейные.Регистратор ЕСТЬ NULL
	|			ТОГДА УчетСебестоимости.АналитикаФинансовогоУчета
	|		ИНАЧЕ УчетСебестоимости.КорАналитикаФинансовогоУчета
	|	КОНЕЦ КАК КорАналитикаФинансовогоУчета,
	|	ВЫБОР КОГДА НЕ НДСПостатейные.Регистратор ЕСТЬ NULL
	|			ТОГДА НДСПостатейные.ВидДеятельностиНДС
	|		КОГДА УчетСебестоимости.СлужебноеВидДвиженияПриход
	|			ТОГДА УчетСебестоимости.КорВидДеятельностиНДС
	|		ИНАЧЕ УчетСебестоимости.ВидДеятельностиНДС
	|	КОНЕЦ КАК ВидДеятельностиНДС,
	|	ВЫБОР КОГДА НЕ НДСПостатейные.Регистратор ЕСТЬ NULL
	|			ТОГДА НДСПостатейные.КорВидДеятельностиНДС
	|		КОГДА УчетСебестоимости.СлужебноеВидДвиженияПриход
	|			ТОГДА УчетСебестоимости.ВидДеятельностиНДС
	|		ИНАЧЕ УчетСебестоимости.КорВидДеятельностиНДС
	|	КОНЕЦ КАК КорВидДеятельностиНДС,
	|	УчетСебестоимости.Регистратор КАК ДокументДвижения,
	|	УчетСебестоимости.Сторно КАК Сторно,
	|	НАЧАЛОПЕРИОДА(УчетСебестоимости.ПериодПродажи, МЕСЯЦ) КАК ПериодПродажи,
	|
	|	СУММА(ЕСТЬNULL(НДСПостатейные.Количество, УчетСебестоимости.Количество)) КАК Количество,
	|	СУММА(ЕСТЬNULL(Цены.СтоимостьНДД, 0)) КАК СтоимостьНДД
	|ПОМЕСТИТЬ ВТСебестоимость
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК УчетСебестоимости
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтРегистраторы КАК Регистраторы
	|		ПО Регистраторы.Регистратор = УчетСебестоимости.Регистратор
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТВключениеИсключениеНДСПостатейныеСвернуто КАК НДСПостатейные
	|		ПО НДСПостатейные.Регистратор = УчетСебестоимости.Регистратор
	|		И НДСПостатейные.Период = УчетСебестоимости.Период
	|		И НДСПостатейные.Организация = УчетСебестоимости.Организация
	|		И НДСПостатейные.Партия = УчетСебестоимости.Партия
	|		И НДСПостатейные.АналитикаУчетаПартий = УчетСебестоимости.АналитикаУчетаПартий
	|		И НДСПостатейные.АналитикаФинансовогоУчета = УчетСебестоимости.АналитикаФинансовогоУчета
	|		И НДСПостатейные.КорВидДеятельностиНДС = УчетСебестоимости.ВидДеятельностиНДС
	|		И НДСПостатейные.АналитикаУчетаНоменклатуры = УчетСебестоимости.АналитикаУчетаНоменклатуры
	|		И НДСПостатейные.ВидЗапасов = УчетСебестоимости.ВидЗапасов
	|		И НДСПостатейные.РазделУчета = УчетСебестоимости.РазделУчета
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТСтоимостьПартийТоваров КАК Цены
	|		ПО Цены.Организация = УчетСебестоимости.Организация
	|		И Цены.Партия = УчетСебестоимости.Партия
	|		И Цены.АналитикаУчетаПартий = УчетСебестоимости.АналитикаУчетаПартий
	|		И Цены.АналитикаФинансовогоУчета = УчетСебестоимости.АналитикаФинансовогоУчета
	|		И Цены.ВидДеятельностиНДС = УчетСебестоимости.ВидДеятельностиНДС
	|		И Цены.АналитикаУчетаНоменклатуры = УчетСебестоимости.АналитикаУчетаНоменклатуры
	|		И Цены.ВидЗапасов = УчетСебестоимости.ВидЗапасов
	|		И Цены.РазделУчета = УчетСебестоимости.РазделУчета
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаНоменклатуры
	|		ПО УчетСебестоимости.АналитикаУчетаНоменклатуры = АналитикаНоменклатуры.Ссылка
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК СпрНазначения
	|		ПО СпрНазначения.Ссылка = АналитикаНоменклатуры.Назначение
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КорАналитикаНоменклатуры
	|		ПО УчетСебестоимости.КорАналитикаУчетаНоменклатуры = КорАналитикаНоменклатуры.Ссылка
	|ГДЕ
	|	((НЕ УчетСебестоимости.СлужебноеВидДвиженияПриход
	|		ИЛИ УчетСебестоимости.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов))
	|	И УчетСебестоимости.Организация В(&ОрганизацииСУчетомПартийНДСВерсии24)
	|	И (УчетСебестоимости.КорРазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|		ИЛИ УчетСебестоимости.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			И УчетСебестоимости.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО)
	|	И УчетСебестоимости.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|	И УчетСебестоимости.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию)
	|	И УчетСебестоимости.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
	|	И НЕ (УчетСебестоимости.Сторно
	|		И УчетСебестоимости.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ИсправлениеПрошлогоПериода))
	|	И УчетСебестоимости.ВидДеятельностиНДС <> УчетСебестоимости.КорВидДеятельностиНДС
	|	И УчетСебестоимости.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|	)
	|		ИЛИ (НЕ НДСПостатейные.Регистратор ЕСТЬ NULL И УчетСебестоимости.Количество <> 0)
	|	
	|СГРУППИРОВАТЬ ПО
	|	УчетСебестоимости.Период,
	|	УчетСебестоимости.Регистратор,
	|	УчетСебестоимости.Организация,
	|	УчетСебестоимости.АналитикаУчетаНоменклатуры,
	|	УчетСебестоимости.ВидЗапасов,
	|	УчетСебестоимости.Партия,
	|	УчетСебестоимости.АналитикаУчетаПартий,
	|	УчетСебестоимости.АналитикаФинансовогоУчета,
	|	ВЫБОР КОГДА УчетСебестоимости.СтатьяРасходовСписания = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ УчетСебестоимости.СтатьяРасходовСписания
	|	КОНЕЦ,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовУпр,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовРегл,
	|	ЕСТЬNULL(УчетСебестоимости.СтатьяРасходовСписания.ПринятиеКНалоговомуУчету, ЛОЖЬ),
	|	УчетСебестоимости.АналитикаРасходов,
	|
	|	УчетСебестоимости.РазделУчета,
	|	УчетСебестоимости.АналитикаУчетаПоПартнерам,
	|	УчетСебестоимости.ЗаказКлиента,
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ УчетСебестоимости.ХозяйственнаяОперация КОНЕЦ),
	|
	|	ВЫБОР КОГДА НЕ НДСПостатейные.Регистратор ЕСТЬ NULL
	|			ТОГДА УчетСебестоимости.АналитикаУчетаНоменклатуры
	|		ИНАЧЕ УчетСебестоимости.КорАналитикаУчетаНоменклатуры
	|	КОНЕЦ,
	|	ВЫБОР КОГДА НЕ НДСПостатейные.Регистратор ЕСТЬ NULL
	|			ТОГДА УчетСебестоимости.РазделУчета
	|		ИНАЧЕ УчетСебестоимости.КорРазделУчета
	|	КОНЕЦ,
	|	ВЫБОР КОГДА НЕ НДСПостатейные.Регистратор ЕСТЬ NULL
	|			ТОГДА УчетСебестоимости.ВидЗапасов
	|		ИНАЧЕ УчетСебестоимости.КорВидЗапасов
	|	КОНЕЦ,
	|	УчетСебестоимости.КорОрганизация,
	|	УчетСебестоимости.Подразделение,
	|	УчетСебестоимости.ГруппаПродукции,
	|	ЕСТЬNULL(СпрНазначения.НаправлениеДеятельности,
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
	|	УчетСебестоимости.КорНаправлениеДеятельности,
	|	ВЫБОР КОГДА УчетСебестоимости.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
	|	  ИЛИ НЕ НДСПостатейные.Регистратор ЕСТЬ NULL
	|		ТОГДА УчетСебестоимости.Партия
	|		ИНАЧЕ УчетСебестоимости.КорПартия
	|	КОНЕЦ,
	|	ВЫБОР КОГДА УчетСебестоимости.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
	|	  ИЛИ НЕ НДСПостатейные.Регистратор ЕСТЬ NULL
	|		ТОГДА УчетСебестоимости.АналитикаУчетаПартий
	|		ИНАЧЕ УчетСебестоимости.КорАналитикаУчетаПартий
	|	КОНЕЦ,
	|	ВЫБОР КОГДА НЕ НДСПостатейные.Регистратор ЕСТЬ NULL
	|			ТОГДА УчетСебестоимости.АналитикаФинансовогоУчета
	|		ИНАЧЕ УчетСебестоимости.КорАналитикаФинансовогоУчета
	|	КОНЕЦ,
	|	ВЫБОР КОГДА НЕ НДСПостатейные.Регистратор ЕСТЬ NULL
	|			ТОГДА НДСПостатейные.ВидДеятельностиНДС
	|		КОГДА УчетСебестоимости.СлужебноеВидДвиженияПриход
	|			ТОГДА УчетСебестоимости.КорВидДеятельностиНДС
	|		ИНАЧЕ УчетСебестоимости.ВидДеятельностиНДС
	|	КОНЕЦ,
	|	ВЫБОР КОГДА НЕ НДСПостатейные.Регистратор ЕСТЬ NULL
	|			ТОГДА НДСПостатейные.КорВидДеятельностиНДС
	|		КОГДА УчетСебестоимости.СлужебноеВидДвиженияПриход
	|			ТОГДА УчетСебестоимости.ВидДеятельностиНДС
	|		ИНАЧЕ УчетСебестоимости.КорВидДеятельностиНДС
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА УчетСебестоимости.КорАналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|		ТОГДА УчетСебестоимости.АналитикаУчетаНоменклатуры
	|		ИНАЧЕ УчетСебестоимости.КорАналитикаУчетаНоменклатуры
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА УчетСебестоимости.КорВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
	|		ТОГДА УчетСебестоимости.ВидЗапасов
	|		ИНАЧЕ УчетСебестоимости.КорВидЗапасов
	|	КОНЕЦ,
	|	НАЧАЛОПЕРИОДА(УчетСебестоимости.ПериодПродажи, МЕСЯЦ),
	|	УчетСебестоимости.Сторно
	|;";
	#КонецОбласти
	
	#Область ЗнаменателиРасходовПартийНДС
	Запрос.Текст = Запрос.Текст + "
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.КорАналитикаУчетаНоменклатуры,
	|	ДД.РазделУчета,
	|	ДД.ВидЗапасов,
	|	ДД.Организация,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.СтатьяРасходовСписания,
	|	ДД.АналитикаРасходов,
	|	ДД.Сторно,
	|	СУММА(ВЫБОР КОГДА ДД.Количество < 0
	|		ТОГДА -ДД.Количество
	|		ИНАЧЕ ДД.Количество КОНЕЦ) КАК Количество
	|ПОМЕСТИТЬ ЗнаменателиРасходовПартийНДС
	|ИЗ
	|	ВтПартии КАК ДД
	|ГДЕ
	|	ДД.Количество <> 0
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.КорАналитикаУчетаНоменклатуры,
	|	ДД.РазделУчета,
	|	ДД.ВидЗапасов,
	|	ДД.Организация,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.СтатьяРасходовСписания,
	|	ДД.АналитикаРасходов,
	|	ДД.Сторно
	|;";
	#КонецОбласти
	
	#Область ЗнаменателиРасходовСебестоимости
	Запрос.Текст = Запрос.Текст + "
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.КорАналитикаУчетаНоменклатуры,
	|	ДД.РазделУчета,
	|	ДД.ВидЗапасов,
	|	ДД.Организация,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.СтатьяРасходовСписания,
	|	ДД.АналитикаРасходов,
	|	ДД.Сторно,
	|	СУММА(ВЫБОР КОГДА ДД.Количество < 0
	|		ТОГДА -ДД.Количество
	|		ИНАЧЕ ДД.Количество 
	|	КОНЕЦ) КАК Количество
	|ПОМЕСТИТЬ ЗнаменателиРасходовСебестоимости
	|ИЗ
	|	ВТСебестоимость КАК ДД
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.КорАналитикаУчетаНоменклатуры,
	|	ДД.РазделУчета,
	|	ДД.ВидЗапасов,
	|	ДД.Организация,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.СтатьяРасходовСписания,
	|	ДД.АналитикаРасходов,
	|	ДД.Сторно
	|;";
	#КонецОбласти
	
	#Область Выборка
	Запрос.Текст = Запрос.Текст + "
	|ВЫБРАТЬ
	|	2 КАК Порядок,
	|	УчетСебестоимости.Период КАК Период,
	|	УчетСебестоимости.Регистратор КАК Регистратор,
	|	УчетСебестоимости.Организация КАК Организация,
	|	УчетСебестоимости.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	УчетСебестоимости.ВидЗапасов КАК ВидЗапасов,
	|	УчетСебестоимости.Партия КАК Партия,
	|	УчетСебестоимости.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	УчетСебестоимости.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	УчетСебестоимости.АналитикаРасходов КАК АналитикаРасходов,
	|	УчетСебестоимости.Сторно КАК Сторно,
	|
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	УчетСебестоимости.РазделУчета КАК РазделУчета,
	|	УчетСебестоимости.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	УчетСебестоимости.ЗаказКлиента КАК ЗаказКлиента,
	|	УчетСебестоимости.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	УчетСебестоимости.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|	УчетСебестоимости.КорРазделУчета КАК КорРазделУчета,
	|	УчетСебестоимости.КорВидЗапасов КАК КорВидЗапасов,
	|	УчетСебестоимости.КорОрганизация КАК КорОрганизация,
	|	УчетСебестоимости.Подразделение КАК Подразделение,
	|	УчетСебестоимости.ВариантРаспределенияРасходовУпр КАК ВариантРаспределенияРасходовУпр,
	|	УчетСебестоимости.ВариантРаспределенияРасходовРегл КАК ВариантРаспределенияРасходовРегл,
	|	УчетСебестоимости.ПринятиеКНалоговомуУчету КАК ПринятиеКНалоговомуУчету,
	|	УчетСебестоимости.ГруппаПродукции КАК ГруппаПродукции,
	|	УчетСебестоимости.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	УчетСебестоимости.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	УчетСебестоимости.КорПартия,
	|	УчетСебестоимости.КорАналитикаУчетаПартий,
	|	УчетСебестоимости.КорАналитикаФинансовогоУчета,
	|	УчетСебестоимости.КорВидДеятельностиНДС,
	|	УчетСебестоимости.ДокументДвижения КАК ДокументДвижения,
	|	ЛОЖЬ КАК ЭтоПередачаМеждуОрганизациями,
	|	УчетСебестоимости.ПериодПродажи,
	|	&ИдентификаторНеиспользуемойФинЗаписи КАК ИдентификаторФинЗаписи,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВключениеИсключениеНДСВСтоимости) КАК ТипЗаписи,
	|	НЕОПРЕДЕЛЕНО КАК ХарактерПроизводственныхЗатрат,
	|
	|	СУММА(ВЫБОР КОГДА УчетСебестоимости.Количество < 0
	|		ТОГДА -УчетСебестоимости.Количество
	|		ИНАЧЕ УчетСебестоимости.Количество 
	|	КОНЕЦ * ЗнаменателиРасходов.Количество) КАК Количество,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК ДопРасходы,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК СтоимостьЗабалансовая,
	|	0 КАК СтоимостьЗабалансоваяРегл,
	|	0 КАК СтоимостьРегл,
	|	0 КАК СтоимостьУпр,
	|	0 КАК ДопРасходыРегл,
	|	0 КАК ДопРасходыУпр,
	|	0 КАК НДСРегл,
	|	0 КАК НДСУпр,
	|	0 КАК ПостатейныеПостоянныеРегл,
	|	0 КАК ПостатейныеПеременныеРегл,
	|	0 КАК ПостатейныеПостоянныеУпр,
	|	0 КАК ПостатейныеПеременныеУпр,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	0 КАК СтоимостьНДД,
	|	СУММА(ВЫБОР КОГДА УчетСебестоимости.Количество < 0
	|		ТОГДА -УчетСебестоимости.Количество
	|		ИНАЧЕ УчетСебестоимости.Количество 
	|	КОНЕЦ * ЗнаменателиРасходов.Количество) КАК ИсходноеКоличество,
	|	ВЫБОР
	|		КОГДА СУММА(УчетСебестоимости.СтоимостьНДД) = 0
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ  КАК ЕстьСтоимостьНДД
	|ИЗ
	|	ВТСебестоимость КАК УчетСебестоимости
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ЗнаменателиРасходовПартийНДС КАК ЗнаменателиРасходов
	|		ПО ЗнаменателиРасходов.Регистратор = УчетСебестоимости.Регистратор
	|		И ЗнаменателиРасходов.Партия = УчетСебестоимости.Партия
	|		И ЗнаменателиРасходов.АналитикаУчетаПартий = УчетСебестоимости.АналитикаУчетаПартий
	|		И ЗнаменателиРасходов.ВидДеятельностиНДС = УчетСебестоимости.ВидДеятельностиНДС
	|		И ЗнаменателиРасходов.АналитикаФинансовогоУчета = УчетСебестоимости.АналитикаФинансовогоУчета
	|		И ЗнаменателиРасходов.АналитикаУчетаНоменклатуры = УчетСебестоимости.АналитикаУчетаНоменклатуры
	|		И ЗнаменателиРасходов.КорАналитикаУчетаНоменклатуры = УчетСебестоимости.КорАналитикаУчетаНоменклатуры
	|		И ЗнаменателиРасходов.ВидЗапасов = УчетСебестоимости.ВидЗапасов
	|		И ЗнаменателиРасходов.РазделУчета = УчетСебестоимости.РазделУчета
	|		И ЗнаменателиРасходов.Организация = УчетСебестоимости.Организация
	|		И ЗнаменателиРасходов.СтатьяРасходовСписания = УчетСебестоимости.СтатьяРасходовСписания
	|		И ЗнаменателиРасходов.АналитикаРасходов = УчетСебестоимости.АналитикаРасходов
	|		И ЗнаменателиРасходов.Сторно = УчетСебестоимости.Сторно
	|
	|СГРУППИРОВАТЬ ПО
	|	УчетСебестоимости.Период,
	|	УчетСебестоимости.Регистратор,
	|	УчетСебестоимости.Организация,
	|	УчетСебестоимости.АналитикаУчетаНоменклатуры,
	|	УчетСебестоимости.ВидЗапасов,
	|	УчетСебестоимости.Партия,
	|	УчетСебестоимости.АналитикаУчетаПартий,
	|	УчетСебестоимости.КорПартия,
	|	УчетСебестоимости.КорАналитикаУчетаПартий,
	|	УчетСебестоимости.АналитикаФинансовогоУчета,
	|	УчетСебестоимости.СтатьяРасходовСписания,
	|	УчетСебестоимости.АналитикаРасходов,
	|	УчетСебестоимости.Сторно,
	|	УчетСебестоимости.РазделУчета,
	|	УчетСебестоимости.АналитикаУчетаПоПартнерам,
	|	УчетСебестоимости.ЗаказКлиента,
	|	УчетСебестоимости.ХозяйственнаяОперация,
	|	УчетСебестоимости.КорАналитикаУчетаНоменклатуры,
	|	УчетСебестоимости.КорРазделУчета,
	|	УчетСебестоимости.КорВидЗапасов,
	|	УчетСебестоимости.КорОрганизация,
	|	УчетСебестоимости.Подразделение,
	|	УчетСебестоимости.ВариантРаспределенияРасходовУпр,
	|	УчетСебестоимости.ВариантРаспределенияРасходовРегл,
	|	УчетСебестоимости.ПринятиеКНалоговомуУчету,
	|	УчетСебестоимости.ГруппаПродукции,
	|	УчетСебестоимости.НаправлениеДеятельности,
	|	УчетСебестоимости.КорНаправлениеДеятельности,
	|	УчетСебестоимости.КорАналитикаФинансовогоУчета,
	|	УчетСебестоимости.КорВидДеятельностиНДС,
	|	УчетСебестоимости.ПериодПродажи,
	|	УчетСебестоимости.ДокументДвижения
	|
	|ИМЕЮЩИЕ
	|	СУММА(ВЫБОР КОГДА УчетСебестоимости.Количество < 0
	|		ТОГДА -УчетСебестоимости.Количество
	|		ИНАЧЕ УчетСебестоимости.Количество 
	|	КОНЕЦ) <> 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	1 КАК Порядок,
	|	Партии.Период КАК Период,
	|	Партии.Регистратор КАК Регистратор,
	|	Партии.Организация КАК Организация,
	|	Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов КАК ВидЗапасов,
	|	Партии.Партия КАК Партия,
	|	Партии.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Партии.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	Партии.АналитикаРасходов КАК АналитикаРасходов,
	|	Партии.Сторно КАК Сторно,
	|
	|	НЕОПРЕДЕЛЕНО КАК ВидДвижения,
	|	Партии.РазделУчета,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
	|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
	|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
	|	Партии.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
	|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
	|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
	|	НЕОПРЕДЕЛЕНО КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовУпр,
	|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовРегл,
	|	НЕОПРЕДЕЛЕНО КАК ПринятиеКНалоговомуУчету,
	|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК КорПартия,
	|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
	|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
	|	Партии.КорВидДеятельностиНДС,
	|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
	|	ЛОЖЬ 		 КАК ЭтоПередачаМеждуОрганизациями,
	|	ЛОЖЬ		 КАК ПериодПродажи,
	|	"""" КАК ИдентификаторФинЗаписи,
	|	НЕОПРЕДЕЛЕНО КАК ТипЗаписи,
	|	Партии.ХарактерПроизводственныхЗатрат,
	|
	|	СУММА(ВЫБОР КОГДА Партии.Количество < 0
	|		ТОГДА -Партии.Количество
	|		ИНАЧЕ Партии.Количество 
	|	КОНЕЦ * ЗнаменателиРасходов.Количество) КАК Количество,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК ДопРасходы,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК СтоимостьЗабалансовая,
	|	0 КАК СтоимостьЗабалансоваяРегл,
	|	СУММА(ВЫБОР
	|		КОГДА ЛОЖЬ ТОГДА 0 // для удобства расстановки тегов
	|		 ИНАЧЕ Партии.НДСРегл КОНЕЦ) КАК СтоимостьРегл,
	|	СУММА(ВЫБОР
	|		КОГДА ЛОЖЬ ТОГДА 0 // для удобства расстановки тегов
	|		 ИНАЧЕ Партии.НДСУпр КОНЕЦ) КАК СтоимостьУпр,
	|	0 КАК ДопРасходыРегл,
	|	0 КАК ДопРасходыУпр,
	|	0 КАК НДСРегл,
	|	0 КАК НДСУпр,
	|	СУММА(ВЫБОР
	|		КОГДА ЛОЖЬ ТОГДА 0 // для удобства расстановки тегов
	|		 ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеРегл,
	|	СУММА(ВЫБОР
	|		КОГДА ЛОЖЬ ТОГДА 0 // для удобства расстановки тегов
	|		 ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеРегл,
	|	СУММА(ВЫБОР
	|		КОГДА ЛОЖЬ ТОГДА 0 // для удобства расстановки тегов
	|		 ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеУпр,
	|	СУММА(ВЫБОР
	|		КОГДА ЛОЖЬ ТОГДА 0 // для удобства расстановки тегов
	|		 ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеУпр,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	СУММА(ВЫБОР КОГДА Партии.СлужебноеВидДвиженияПриход ТОГДА -1 ИНАЧЕ 1 КОНЕЦ * Партии.НДСРегл) КАК СтоимостьНДД,
	|	0 КАК ИсходноеКоличество,
	|	ЛОЖЬ КАК ЕстьСтоимостьНДД
	|ИЗ
	|	ВтПартии КАК Партии
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ЗнаменателиРасходовСебестоимости КАК ЗнаменателиРасходов
	|		ПО ЗнаменателиРасходов.Регистратор = Партии.Регистратор
	|		И ЗнаменателиРасходов.Партия = Партии.Партия
	|		И ЗнаменателиРасходов.АналитикаУчетаПартий = Партии.АналитикаУчетаПартий
	|		И ЗнаменателиРасходов.ВидДеятельностиНДС = Партии.ВидДеятельностиНДС
	|		И ЗнаменателиРасходов.АналитикаФинансовогоУчета = Партии.АналитикаФинансовогоУчета
	|		И ЗнаменателиРасходов.АналитикаУчетаНоменклатуры = Партии.АналитикаУчетаНоменклатуры
	|		И ЗнаменателиРасходов.КорАналитикаУчетаНоменклатуры = Партии.КорАналитикаУчетаНоменклатуры
	|		И ЗнаменателиРасходов.ВидЗапасов = Партии.ВидЗапасов
	|		И ЗнаменателиРасходов.РазделУчета = Партии.РазделУчета
	|		И ЗнаменателиРасходов.Организация = Партии.Организация
	|		И ЗнаменателиРасходов.СтатьяРасходовСписания = Партии.СтатьяРасходовСписания
	|		И ЗнаменателиРасходов.АналитикаРасходов = Партии.АналитикаРасходов
	|		И ЗнаменателиРасходов.Сторно = Партии.Сторно
	|ГДЕ
	|	Партии.Количество <> 0
	|
	|СГРУППИРОВАТЬ ПО
	|	Партии.Период,
	|	Партии.Регистратор,
	|	Партии.Организация,
	|	Партии.АналитикаУчетаНоменклатуры,
	|	Партии.КорАналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов,
	|	Партии.Партия,
	|	Партии.АналитикаФинансовогоУчета,
	|	Партии.СтатьяРасходовСписания,
	|	Партии.АналитикаРасходов,
	|	Партии.Сторно,
	|	Партии.РазделУчета,
	|	Партии.КорВидДеятельностиНДС,
	|	Партии.ХарактерПроизводственныхЗатрат
	|
	|ИМЕЮЩИЕ
	|	СУММА(Партии.Количество) <> 0
	|	И (СУММА(Партии.НДСРегл) <> 0 ИЛИ СУММА(Партии.НДСУпр) <> 0)
	|
	|УПОРЯДОЧИТЬ ПО
	|	Регистратор,
	|	Организация,
	|	Партия,
	|	СтатьяРасходовСписания,
	|	АналитикаРасходов,
	|	АналитикаУчетаНоменклатуры,
	|	КорАналитикаУчетаНоменклатуры,
	|	ВидЗапасов,
	|	АналитикаФинансовогоУчета,
	|	Сторно,
	|	Порядок
	|;";
	#КонецОбласти
	
	ЗаписьРаспределения = Новый Структура("
	|Период, АналитикаУчетаНоменклатуры, РазделУчета, ВидЗапасов, Организация, Склад, Партия, АналитикаФинансовогоУчета,
	|ХозяйственнаяОперация, ЗаказКлиента, ТипЗапасов, АналитикаУчетаПоПартнерам, ЭтоПередачаМеждуОрганизациями,
	|КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорТипЗапасов, КорОрганизация,
	|АналитикаУчетаНоменклатурыВО, АналитикаФинансовогоУчетаВО, АналитикаАктивовПассивов, КорСклад,
	|СтатьяАктивовПассивов, Подразделение, АналитикаРасходов, СтатьяРасходовСписания, СтатьяДоходов, АналитикаДоходов,
	|ВариантРаспределенияРасходовУпр, ВариантРаспределенияРасходовРегл,
	|ДокументДвижения, ИдентификаторСтроки, ПринятиеКНалоговомуУчету, ГруппаПродукции, СписаниеПриПередачеНУ,
	|ИсточникГФУНоменклатуры, КорИсточникГФУНоменклатуры, НаправлениеДеятельности, КорНаправлениеДеятельности, ПериодПродажи,
	|Стоимость, СтоимостьБезНДС, Количество, КорСтоимость, ПостояннаяРазница, ВременнаяРазница, СтоимостьНДД,
	|ДопРасходы, ДопРасходыБезНДС, СтоимостьРегл, НДСРегл,
	|КорПартия, КорАналитикаУчетаПартий, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС,
	|СтатьяКалькуляции, ТипЗаписи, ДокументИсточник, ИдентификаторФинЗаписи, Сторно,
	|СтоимостьЗабалансовая, Трудозатраты, ПостатейныеПостоянныеСНДС, ПостатейныеПостоянныеБезНДС,
	|СтоимостьЗабалансоваяРегл, ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеПостоянныеРегл,
	|ПостатейныеПеременныеСНДС, ПостатейныеПеременныеБезНДС, ПостатейныеПеременныеРегл,
	|СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр, НДСУпр
	|");
	
	СуммыРаспределения = Новый Структура("
	|Количество, Стоимость, СтоимостьБезНДС, СтоимостьЗабалансовая, СтоимостьРегл, СтоимостьУпр, СтоимостьЗабалансоваяРегл, НДСРегл, НДСУпр,
	|ДопРасходы, ДопРасходыБезНДС, ДопРасходыРегл, ДопРасходыУпр, ПостояннаяРазница, ВременнаяРазница, СтоимостьНДД,
	|ПостатейныеПостоянныеРегл, ПостатейныеПеременныеРегл, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр
	|");
	
	СтрокаОстатка = Новый Структура("
	|Регистратор, Организация, АналитикаУчетаНоменклатуры, ВидЗапасов, Партия, АналитикаФинансовогоУчета, СтатьяРасходовСписания, АналитикаРасходов,
	|КорАналитикаУчетаНоменклатуры, РазделУчета, Сторно,
	|Количество, Стоимость, СтоимостьБезНДС, СтоимостьЗабалансовая, СтоимостьРегл, СтоимостьУпр, СтоимостьЗабалансоваяРегл, НДСРегл, НДСУпр,
	|ДопРасходы, ДопРасходыБезНДС, ДопРасходыРегл, ДопРасходыУпр, ПостояннаяРазница, ВременнаяРазница, СтоимостьНДД,
	|ПостатейныеПостоянныеРегл, ПостатейныеПеременныеРегл, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр
	|");
	
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина,,,
		Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя);
	
	// Формируются движения по регистрам:
	// - СебестоимостьТоваров
	// - ПрочиеРасходы
	Пока Выборка.Следующий() Цикл
		
		Если Выборка.Порядок = 1 Тогда
			
			ЗаполнитьЗначенияСвойств(СтрокаОстатка, Выборка);
			
		ИначеЕсли СтрокаОстатка.Регистратор = Выборка.Регистратор
			И СтрокаОстатка.Организация = Выборка.Организация
			И СтрокаОстатка.Партия = Выборка.Партия
			И СтрокаОстатка.РазделУчета = Выборка.РазделУчета
			И СтрокаОстатка.СтатьяРасходовСписания = Выборка.СтатьяРасходовСписания
			И СтрокаОстатка.АналитикаРасходов = Выборка.АналитикаРасходов
			И СтрокаОстатка.АналитикаУчетаНоменклатуры = Выборка.АналитикаУчетаНоменклатуры
			И (СтрокаОстатка.КорАналитикаУчетаНоменклатуры = Выборка.КорАналитикаУчетаНоменклатуры
				ИЛИ НЕ ЗначениеЗаполнено(Выборка.КорРазделУчета))
			И СтрокаОстатка.ВидЗапасов = Выборка.ВидЗапасов
			И СтрокаОстатка.СтатьяРасходовСписания = Выборка.СтатьяРасходовСписания
			И СтрокаОстатка.АналитикаРасходов = Выборка.АналитикаРасходов
			И СтрокаОстатка.Сторно = Выборка.Сторно Тогда
			
			ЗаполнитьЗначенияСвойств(ЗаписьРаспределения, Выборка);
			
			// Если в себестоимости не суммы НДД, то включать/исключать НДС в стоимость НДД не нужно
			Если Выборка.ЕстьСтоимостьНДД = Ложь Тогда
				СтрокаОстатка.СтоимостьНДД = 0;
			КонецЕсли;
			
			РасчетСебестоимостиКорректировкаСтоимости.РаспределитьСтоимость(СуммыРаспределения, СтрокаОстатка, Выборка, Выборка.Количество);
			РасчетСебестоимостиКорректировкаСтоимости.ДополнитьСуммыРаспределения(ЗаписьРаспределения, СуммыРаспределения);
			
			Если ЗаписьРаспределения.СтоимостьРегл <> 0 ИЛИ ЗаписьРаспределения.СтоимостьУпр <> 0
			 ИЛИ ЗаписьРаспределения.ПостатейныеПостоянныеРегл <> 0 ИЛИ ЗаписьРаспределения.ПостатейныеПеременныеРегл <> 0
			 ИЛИ ЗаписьРаспределения.ПостатейныеПостоянныеУпр <> 0 ИЛИ ЗаписьРаспределения.ПостатейныеПеременныеУпр <> 0 Тогда
					
				// Если есть кор. раздел - необходимо скорректировать стоимость в кор. части.
				Если ЗначениеЗаполнено(ЗаписьРаспределения.КорРазделУчета) Тогда
					
					РасчетСебестоимостиКорректировкаСтоимости.СформироватьКорДвиженияСебестоимостьТоваров(ПараметрыРасчета, ЗаписьРаспределения, ПараметрыРасчета.ПредварительныйРасчет);
							
				КонецЕсли;
				
				Если ПараметрыРасчета.ПредварительныйРасчет Тогда
					Продолжить;
				КонецЕсли;
				
				// Корректировка списания товаров на затраты в регистре учет прочих расходов.
				Если Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СписаниеТоваров
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СписаниеТоваровПоТребованию
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СторноСписанияНаРасходы
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПересортицаТоваровСПереоценкой
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПорчаТоваровСПереоценкой
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратТоваровПоставщику
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПересортицаПартийТоваров
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СписаниеРасхожденийПоступлениеПриобретение
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаНаПрочиеЦели
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаВЭксплуатацию
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ОтчетКомиссионераОСписании Тогда
				 	
				 	СуммовыеПоказатели = Новый Структура;
					СуммовыеПоказатели.Вставить("СуммаСНДС", 0);
					СуммовыеПоказатели.Вставить("СуммаБезНДС", 0);
					СуммовыеПоказатели.Вставить("СуммаРегл", ЗаписьРаспределения.СтоимостьРегл
						+ ЗаписьРаспределения.ПостатейныеПостоянныеРегл
						+ ЗаписьРаспределения.ПостатейныеПеременныеРегл);
					СуммовыеПоказатели.Вставить("СуммаУпр", ЗаписьРаспределения.СтоимостьУпр
						+ ЗаписьРаспределения.ПостатейныеПостоянныеУпр
						+ ЗаписьРаспределения.ПостатейныеПеременныеУпр);
					СуммовыеПоказатели.Вставить("ПостояннаяРазница", 0);
					СуммовыеПоказатели.Вставить("ВременнаяРазница", 0);
					СуммовыеПоказатели.Вставить("СуммаНДД", ЗаписьРаспределения.СтоимостьНДД);
				 
				 	РасчетСебестоимостиКорректировкаСтоимости.СформироватьДвиженияПрочиеРасходы(
				 		ПараметрыРасчета,
						ЗаписьРаспределения,
						СуммовыеПоказатели);
					
				КонецЕсли;

			КонецЕсли;
			
		КонецЕсли;

	КонецЦикла;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"ВТВключениеИсключениеНДСПостатейные, ВТВключениеИсключениеНДСПостатейныеСвернуто, ВТНДССписаниеНаВыпуск,
		|ВтПартии, ВтРегистраторы, ВТСебестоимость, ЗнаменателиРасходовПартийНДС, ЗнаменателиРасходовСебестоимости");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвижения(ПараметрыРасчета);
	
КонецПроцедуры

// Этап 3.18
Процедура ВключитьИсключитьНДСВСтоимостьПродаж(ПараметрыРасчета) Экспорт

	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "ВключитьИсключитьНДСВСтоимостьПродаж");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Продажи.Период КАК Период,
	|	Продажи.Регистратор КАК Регистратор,
	|	АналитикаПартнеров.Организация КАК Организация,
	|	Продажи.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Продажи.Партия КАК Партия,
	|	Продажи.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Продажи.ВидДеятельностиНДС КАК ВидДеятельностиНДС
	|ПОМЕСТИТЬ ДвиженияПродаж
	|ИЗ
	|	ВТКэшРасчетныеОборотыВыручкаИСебестоимостьПродаж КАК Продажи
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборАналитикаПоПартнерам КАК АналитикаПартнеров
	|		ПО Продажи.АналитикаУчетаПоПартнерам = АналитикаПартнеров.КлючАналитики
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументы
	|		ПО ИсправленныеДокументы.Регистратор = Продажи.Регистратор
	|ГДЕ
	|	&ПартионныйУчетВерсии22
	|	И АналитикаПартнеров.Организация В(&ОрганизацииСУчетомПартийНДСВерсии22)
	|	И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	// Исключаем сторно движения исправлений и корректировок прошлого периода.
	// Такие движения уже сформированы в процедуре СкорректироватьСтоимостьСторноДвиженийИсправленныхДокументов() Область ИсправлениеСебестоимостьТоваров
	|	И НЕ (НЕ ИсправленныеДокументы.ДатаДокументаИсточника ЕСТЬ NULL
	|		И ИсправленныеДокументы.ДатаДокументаИсточника < &НачалоПериода
	|		И Продажи.Сторно)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Период,
	|	Регистратор,
	|	Организация,
	|	АналитикаУчетаНоменклатуры,
	|	Партия,
	|	АналитикаФинансовогоУчета,
	|	ВидДеятельностиНДС
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Партии.Период КАК Период,
	|	Партии.Регистратор КАК Регистратор,
	|	Партии.Организация КАК Организация,
	|	Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов КАК ВидЗапасов,
	|	Партии.СтатьяСписанияНДС,
	|	Партии.АналитикаСписанияНДС,
	// Подразделение должно заполняться аналогично УчетНДСРФ.ПолучитьПартии
	|	Партии.ПодразделениеСписанияНДС,
	|	Партии.РазделУчета,
	|	Партии.Партия,
	|	Партии.АналитикаУчетаПартий,
	|	Партии.АналитикаФинансовогоУчета,
	|	Партии.ВидДеятельностиНДС,
	|	Партии.РаспределениеПоВыбывшимТоварам,
	|	СУММА(Партии.Количество) КАК Количество,
	|	СУММА(ВЫБОР
	|		КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА 0
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		ТОГДА
	|			Партии.НДСРегл
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) < &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			Партии.НДСРегл
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		ТОГДА
	|			-Партии.НДСРегл
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) >= &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			-Партии.НДСРегл
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ
	|	) КАК НДСРегл,
	|	СУММА(
	|		ВЫБОР КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА 0
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		ТОГДА
	|			Партии.НДСУпр
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) < &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			Партии.НДСУпр
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		ТОГДА
	|			-Партии.НДСУпр
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) >= &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			-Партии.НДСУпр
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ
	|	) КАК НДСУпр,
	|	СУММА(
	|		ВЫБОР КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА Партии.НДСРегл
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ
	|	) КАК СписаниеНДС,
	|	СУММА(
	|		ВЫБОР КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА Партии.НДСУпр
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ
	|	) КАК СписаниеНДСУпр
	|ПОМЕСТИТЬ ВтПартии
	|ИЗ (
	|	ВЫБРАТЬ
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Партии.ВидЗапасов КАК ВидЗапасов,
	|		Партии.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
	|		Партии.НалогообложениеНДС,
	|		Партии.ДокументПоступления,
	|		Партии.Количество КАК Количество,
	|		Партии.НДСРегл КАК НДСРегл,
	|		0 КАК НДСУпр,
	|		ВЫБОР
	|			КОГДА Партии.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА Партии.АналитикаУчетаНоменклатуры.СкладскаяТерритория.Подразделение
	|			КОГДА Партии.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Партии.АналитикаУчетаНоменклатуры.Подразделение
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ КАК ПодразделениеСписанияНДС,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС,
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|		НЕОПРЕДЕЛЕНО КАК Партия,
	|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК ВидДеятельностиНДС,
	|		ЛОЖЬ КАК РаспределениеПоВыбывшимТоварам
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровОрганизаций КАК Партии
	|	ГДЕ
	|		НЕ &ПартионныйУчетВерсии22
	|		И Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Партии.Активность
	|		И Партии.Организация В(&МассивОрганизаций)
	|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Партии.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.АналитикаУчетаПродукции КАК АналитикаУчетаНоменклатуры,
	|		ВЫБОР КОГДА Партии.КорВидЗапасов <> ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
	|			ТОГДА Партии.КорВидЗапасов
	|			ИНАЧЕ Партии.ВидЗапасов
	|		КОНЕЦ КАК ВидЗапасов,
	|		Партии.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
	|		Партии.НалогообложениеНДС,
	|		Партии.ДокументПоступления,
	|		0 КАК Количество,
	|		Партии.НДСРегл КАК НДСРегл,
	|		0 КАК НДСУпр,
	|		ВЫБОР
	|			КОГДА Партии.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА Партии.АналитикаУчетаНоменклатуры.СкладскаяТерритория.Подразделение
	|			КОГДА Партии.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Партии.АналитикаУчетаНоменклатуры.Подразделение
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ КАК ПодразделениеСписанияНДС,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС,
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|		НЕОПРЕДЕЛЕНО КАК Партия,
	|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК ВидДеятельностиНДС,
	|		ЛОЖЬ КАК РаспределениеПоВыбывшимТоварам
	|	ИЗ
	|		РегистрНакопления.ПартииЗатратНаВыпуск КАК Партии
	|	ГДЕ
	|		НЕ &ПартионныйУчетВерсии22
	|		И Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Партии.Активность
	|		И Партии.Организация В(&МассивОрганизаций)
	|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Партии.НДСРегл <> 0
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Партии.ВидЗапасов КАК ВидЗапасов,
	|		Партии.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
	|		Партии.НалогообложениеНДС,
	|		Партии.ДокументПоступления,
	|		0 КАК Количество,
	|		Партии.НДСРегл КАК НДСРегл,
	|		0 КАК НДСУпр,
	|		ВЫБОР
	|			КОГДА Партии.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА Партии.АналитикаУчетаНоменклатуры.СкладскаяТерритория.Подразделение
	|			КОГДА Партии.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Партии.АналитикаУчетаНоменклатуры.Подразделение
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ КАК ПодразделениеСписанияНДС,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС,
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|		НЕОПРЕДЕЛЕНО КАК Партия,
	|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК ВидДеятельностиНДС,
	|		ЛОЖЬ КАК РаспределениеПоВыбывшимТоварам
	|	ИЗ
	|		РегистрНакопления.ПартииРасходовНаСебестоимостьТоваров КАК Партии
	|	ГДЕ
	|		НЕ &ПартионныйУчетВерсии22
	|		И Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Партии.Активность
	|		И Партии.Организация В(&МассивОрганизаций)
	|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Партии.НДСРегл <> 0
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Партии.ВидЗапасов КАК ВидЗапасов,
	|		Партии.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
	|		Партии.НалогообложениеНДС,
	|		Партии.ДокументПоступления,
	|		Партии.Количество КАК Количество,
	|		Партии.НДСРегл КАК НДСРегл,
	|		0 КАК НДСУпр,
	|		ВЫБОР
	|			КОГДА Партии.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА Партии.АналитикаУчетаНоменклатуры.СкладскаяТерритория.Подразделение
	|			КОГДА Партии.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Партии.АналитикаУчетаНоменклатуры.Подразделение
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ КАК ПодразделениеСписанияНДС,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС,
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|		НЕОПРЕДЕЛЕНО КАК Партия,
	|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК ВидДеятельностиНДС,
	|		ЛОЖЬ КАК РаспределениеПоВыбывшимТоварам
	|	ИЗ
	|		РегистрНакопления.ПартииПроизводственныхЗатрат КАК Партии
	|	ГДЕ
	|		НЕ &ПартионныйУчетВерсии22
	|		И Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Партии.Активность
	|		И Партии.Организация В(&МассивОрганизаций)
	|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Партии.НДСРегл <> 0
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Партии.ВидЗапасов КАК ВидЗапасов,
	|		Партии.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
	|		Партии.НалогообложениеНДС,
	|		Партии.ДокументПоступления,
	|		Партии.Количество КАК Количество,
	|		Партии.НДСРегл КАК НДСРегл,
	|		0 КАК НДСУпр,
	|		НЕОПРЕДЕЛЕНО КАК ПодразделениеСписанияНДС,
	|		ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяСписанияНДС,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|		НЕОПРЕДЕЛЕНО КАК Партия,
	|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК ВидДеятельностиНДС,
	|		ЛОЖЬ КАК РаспределениеПоВыбывшимТоварам
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровПереданныеНаКомиссию КАК Партии
	|	ГДЕ
	|		НЕ &ПартионныйУчетВерсии22
	|		И Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Партии.Активность
	|		И Партии.Организация В(&МассивОрганизаций)
	|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Партии.ВидЗапасов КАК ВидЗапасов,
	|		Партии.ВидДеятельностиНДС КАК НалогообложениеПартии,
	|		Партии.КорВидДеятельностиНДС КАК НалогообложениеНДС,
	|		Партии.ДокументПоступления,
	|		(ВЫБОР
	|			КОГДА Партии.ТипЗаписи В (
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
	|				ТОГДА (ВЫБОР
	|					КОГДА Партии.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|						ТОГДА Партии.СтоимостьБезНДС + Партии.НДС
	|					КОГДА Партии.СтоимостьБезНДС = 0 ТОГДА Партии.НДС
	|					ИНАЧЕ Партии.СтоимостьБезНДС КОНЕЦ)
	|			ИНАЧЕ Партии.Количество КОНЕЦ) КАК Количество,
	|		Партии.НДС КАК НДСРегл,
	|		Партии.НДСУпр КАК НДСУпр,
	|		Партии.Подразделение КАК ПодразделениеСписанияНДС,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС,
	|		Партии.РазделУчета,
	|		(ВЫБОР
	|			КОГДА ДвиженияПродаж.Регистратор ЕСТЬ NULL ТОГДА НЕОПРЕДЕЛЕНО
	|			ИНАЧЕ Партии.Партия КОНЕЦ) КАК Партия,
	|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
	|		Партии.АналитикаФинансовогоУчета,
	|		Партии.ВидДеятельностиНДС,
	|		(ВЫБОР
	|			КОГДА Партии.ТипЗаписи В (
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК РаспределениеПоВыбывшимТоварам
	|	ИЗ
	|		ВТКэшРасчетныеОборотыДетализацияПартийТоваровДляНДСиУСН КАК Партии
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДвиженияПродаж КАК ДвиженияПродаж
	|		 ПО ДвиженияПродаж.Период = Партии.Период
	|		 И ДвиженияПродаж.Регистратор = Партии.Регистратор
	|		 И ДвиженияПродаж.Организация = Партии.Организация
	|		 И ДвиженияПродаж.АналитикаУчетаНоменклатуры = Партии.АналитикаУчетаНоменклатуры
	|		 И ДвиженияПродаж.Партия = Партии.Партия
	|		 И ДвиженияПродаж.АналитикаФинансовогоУчета = Партии.АналитикаФинансовогоУчета
	|		 И ДвиженияПродаж.ВидДеятельностиНДС = Партии.ВидДеятельностиНДС
	|	ГДЕ
	|		&ПартионныйУчетВерсии22
	|		И Партии.Организация В(&ОрганизацииСУчетомПартийНДСВерсии22)
	|		И НЕ Партии.СлужебноеВидДвиженияПриход
	|	
	|	) КАК Партии
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|	ПО
	|		ДанныеПервичныхДокументов.Организация = Партии.Организация
	|		И ДанныеПервичныхДокументов.Документ = Партии.ДокументПоступления
	|ГДЕ
	|	Партии.НалогообложениеНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|
	|СГРУППИРОВАТЬ ПО
	|	Партии.Период,
	|	Партии.Регистратор,
	|	Партии.Организация,
	|	Партии.АналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов,
	|	Партии.СтатьяСписанияНДС,
	|	Партии.АналитикаСписанияНДС,
	|	Партии.ПодразделениеСписанияНДС,
	|	Партии.РазделУчета,
	|	Партии.Партия,
	|	Партии.АналитикаУчетаПартий,
	|	Партии.АналитикаФинансовогоУчета,
	|	Партии.ВидДеятельностиНДС,
	|	Партии.РаспределениеПоВыбывшимТоварам
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Партии.Регистратор КАК Регистратор
	|ПОМЕСТИТЬ ВтРегистраторы
	|ИЗ
	|	ВтПартии КАК Партии
	|ГДЕ
	|	Партии.НДСРегл <> 0
	|	ИЛИ Партии.НДСУпр <> 0
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	2 КАК Порядок,
	|	ЛОЖЬ 							   КАК СлужебноеВидДвиженияПриход,
	|	Продажи.Период                     КАК Период,
	|	Продажи.Регистратор                КАК Регистратор,
	|	Продажи.Регистратор                КАК ДокументДвижения,
	|	АналитикаПартнеров.Организация     КАК Организация,
	|	Продажи.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Продажи.ВидЗапасов                 КАК ВидЗапасов,
	|	Продажи.РазделУчета				   КАК РазделУчета,
	|	Продажи.Партия				   	   КАК Партия,
	|	Продажи.АналитикаУчетаПартий	   КАК АналитикаУчетаПартий,
	|	Продажи.АналитикаФинансовогоУчета  КАК АналитикаФинансовогоУчета,
	|	Продажи.ВидДеятельностиНДС		   КАК ВидДеятельностиНДС,
	|
	|	Продажи.ЗаказКлиента               КАК ЗаказКлиента,
	|	Продажи.АналитикаУчетаПоПартнерам  КАК АналитикаУчетаПоПартнерам,
	|	Продажи.Подразделение              КАК Подразделение,
	|	Продажи.ТипЗапасов                 КАК ТипЗапасов,
	|	Продажи.Менеджер                   КАК Менеджер,
	|	Продажи.Склад                      КАК Склад,
	|	Продажи.Соглашение                 КАК Соглашение,
	|	Продажи.Договор                    КАК Договор,
	|	Продажи.ХозяйственнаяОперация      КАК ХозяйственнаяОперация,
	|	Продажи.НалогообложениеНДС         КАК НалогообложениеНДС,
	|	Продажи.ВалютаВзаиморасчетов       КАК ВалютаВзаиморасчетов,
	|	Продажи.ВалютаДокумента            КАК ВалютаДокумента,
	|	Продажи.ИсточникГФУНоменклатуры    КАК ИсточникГФУНоменклатуры,
	|	Продажи.ИсточникГФУРасчетов        КАК ИсточникГФУРасчетов,
	|	Продажи.НаправлениеДеятельностиКонтрагента КАК НаправлениеДеятельностиКонтрагента,
	|	Продажи.НаправлениеДеятельностиНоменклатуры КАК НаправлениеДеятельностиНоменклатуры,
	|	&ИдентификаторНеиспользуемойФинЗаписи КАК ИдентификаторФинЗаписи,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетПартий И Продажи.Количество = 0
	|			ТОГДА (ВЫБОР
	|				КОГДА Продажи.ДопРасходыРегл = 0 ТОГДА Продажи.НДСРегл
	|				ИНАЧЕ Продажи.ДопРасходыРегл КОНЕЦ)
	|		КОГДА Продажи.Количество < 0 ТОГДА
	|			0 - Продажи.Количество
	|		ИНАЧЕ
	|			Продажи.Количество
	|		КОНЕЦ
	|	) КАК Количество,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК ДопРасходы,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК СтоимостьЗабалансовая,
	|	0 КАК СтоимостьЗабалансоваяРегл,
	|	0 КАК СтоимостьРегл,
	|	0 КАК НДСРегл,
	|	0 КАК НДСУпр,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	0 КАК Трудозатраты,
	|	0 КАК ПостатейныеПостоянныеСНДС,
	|	0 КАК ПостатейныеПеременныеСНДС,
	|	0 КАК ПостатейныеПостоянныеБезНДС,
	|	0 КАК ПостатейныеПеременныеБезНДС,
	|	0 КАК ДопРасходыРегл,
	|	0 КАК ТрудозатратыРегл,
	|	0 КАК ПостатейныеПостоянныеРегл,
	|	0 КАК ПостатейныеПеременныеРегл,
	|	0 КАК СтоимостьУпр,
	|	0 КАК ДопРасходыУпр,
	|	0 КАК ТрудозатратыУпр,
	|	0 КАК ПостатейныеПостоянныеУпр,
	|	0 КАК ПостатейныеПеременныеУпр,
	|
	|	СУММА(Продажи.Количество)          КАК ИсходноеКоличество,
	|	0                                  КАК КорСтоимость
	|ИЗ
	|	ВТКэшРасчетныеОборотыВыручкаИСебестоимостьПродаж КАК Продажи
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтРегистраторы КАК Регистраторы
	|			ПО Регистраторы.Регистратор = Продажи.Регистратор
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборАналитикаПоПартнерам КАК АналитикаПартнеров
	|			ПО Продажи.АналитикаУчетаПоПартнерам = АналитикаПартнеров.КлючАналитики
	|
	|ГДЕ
	|	Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|	
	|СГРУППИРОВАТЬ ПО
	|	Продажи.Период,
	|	Продажи.Регистратор,
	|	Продажи.АналитикаУчетаНоменклатуры,
	|	Продажи.ЗаказКлиента,
	|	Продажи.АналитикаУчетаПоПартнерам,
	|	Продажи.Подразделение,
	|	Продажи.ТипЗапасов,
	|	Продажи.ВидЗапасов,
	|	Продажи.Менеджер,
	|	Продажи.Склад,
	|	Продажи.Соглашение,
	|	Продажи.Договор,
	|	Продажи.ХозяйственнаяОперация,
	|	Продажи.НалогообложениеНДС,
	|	Продажи.ВалютаВзаиморасчетов,
	|	Продажи.ВалютаДокумента,
	|	Продажи.ИсточникГФУНоменклатуры,
	|	Продажи.ИсточникГФУРасчетов,
	|	Продажи.НаправлениеДеятельностиКонтрагента,
	|	Продажи.НаправлениеДеятельностиНоменклатуры,
	|	АналитикаПартнеров.Организация,
	|	Продажи.РазделУчета,
	|	Продажи.Партия,
	|	Продажи.АналитикаУчетаПартий,
	|	Продажи.АналитикаФинансовогоУчета,
	|	Продажи.ВидДеятельностиНДС
	|
	|ИМЕЮЩИЕ
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетПартий И Продажи.Количество = 0
	|			ТОГДА (ВЫБОР
	|				КОГДА Продажи.ДопРасходыРегл = 0 ТОГДА Продажи.НДСРегл
	|				ИНАЧЕ Продажи.ДопРасходыРегл КОНЕЦ)
	|		КОГДА Продажи.Количество < 0 ТОГДА
	|			0 - Продажи.Количество
	|		ИНАЧЕ
	|			Продажи.Количество
	|		КОНЕЦ
	|	) <> 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	1 								   КАК Порядок,
	|	ЛОЖЬ 							   КАК СлужебноеВидДвиженияПриход,
	|	Партии.Период 					   КАК Период,
	|	Партии.Регистратор 				   КАК Регистратор,
	|	Партии.Регистратор 				   КАК ДокументДвижения,
	|	Партии.Организация 				   КАК Организация,
	|	Партии.АналитикаУчетаНоменклатуры  КАК АналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов 				   КАК ВидЗапасов,
	|	Партии.РазделУчета				   КАК РазделУчета,
	|	Партии.Партия				   	   КАК Партия,
	|	Партии.АналитикаУчетаПартий	       КАК АналитикаУчетаПартий,
	|	Партии.АналитикаФинансовогоУчета   КАК АналитикаФинансовогоУчета,
	|	Партии.ВидДеятельностиНДС		   КАК ВидДеятельностиНДС,
	|
	|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
	|	НЕОПРЕДЕЛЕНО КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО КАК ТипЗапасов,
	|	НЕОПРЕДЕЛЕНО КАК Менеджер,
	|	НЕОПРЕДЕЛЕНО КАК Склад,
	|	НЕОПРЕДЕЛЕНО КАК Соглашение,
	|	НЕОПРЕДЕЛЕНО КАК Договор,
	|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
	|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
	|	НЕОПРЕДЕЛЕНО КАК ВалютаВзаиморасчетов,
	|	НЕОПРЕДЕЛЕНО КАК ВалютаДокумента,
	|	НЕОПРЕДЕЛЕНО КАК ИсточникГФУНоменклатуры,
	|	НЕОПРЕДЕЛЕНО КАК ИсточникГФУРасчетов,
	|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельностиКонтрагента,
	|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельностиНоменклатуры,
	|	"""" КАК ИдентификаторФинЗаписи,
	|
	|	СУММА(ВЫБОР
	|		КОГДА Партии.Количество < 0 ТОГДА
	|			0 - Партии.Количество
	|		ИНАЧЕ
	|			Партии.Количество
	|		КОНЕЦ
	|	) КАК Количество,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК ДопРасходы,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК СтоимостьЗабалансовая,
	|	0 КАК СтоимостьЗабалансоваяРегл,
	|	СУММА(ВЫБОР
	|		КОГДА Партии.РаспределениеПоВыбывшимТоварам ТОГДА 0
	|		КОГДА Партии.Количество < 0
	|			ТОГДА - Партии.НДСРегл
	|		ИНАЧЕ Партии.НДСРегл КОНЕЦ) КАК СтоимостьРегл,
	|	0 КАК НДСРегл,
	|	0 КАК НДСУпр,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	0 КАК Трудозатраты,
	|	0 КАК ПостатейныеПостоянныеСНДС,
	|	0 КАК ПостатейныеПеременныеСНДС,
	|	0 КАК ПостатейныеПостоянныеБезНДС,
	|	0 КАК ПостатейныеПеременныеБезНДС,
	|	СУММА(ВЫБОР
	|		КОГДА Партии.РаспределениеПоВыбывшимТоварам ТОГДА Партии.НДСРегл
	|		КОГДА Партии.Количество < 0
	|			ТОГДА - Партии.НДСРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыРегл,
	|	0 КАК ТрудозатратыРегл,
	|	0 КАК ПостатейныеПостоянныеРегл,
	|	0 КАК ПостатейныеПеременныеРегл,
	|	СУММА(ВЫБОР
	|		КОГДА Партии.РаспределениеПоВыбывшимТоварам ТОГДА 0
	|		КОГДА Партии.Количество < 0
	|			ТОГДА - Партии.НДСУпр
	|		ИНАЧЕ Партии.НДСРегл КОНЕЦ) КАК СтоимостьУпр,
	|	СУММА(ВЫБОР
	|		КОГДА Партии.РаспределениеПоВыбывшимТоварам ТОГДА Партии.НДСУпр
	|		КОГДА Партии.Количество < 0
	|			ТОГДА - Партии.НДСУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыУпр,
	|	0 КАК ТрудозатратыУпр,
	|	0 КАК ПостатейныеПостоянныеУпр,
	|	0 КАК ПостатейныеПеременныеУпр,
	|
	|	0 КАК ИсходноеКоличество,
	|	0 КАК КорСтоимость
	|ИЗ
	|	ВтПартии КАК Партии
	|ГДЕ
	|	Партии.Количество <> 0
	|
	|СГРУППИРОВАТЬ ПО
	|	Партии.Период,
	|	Партии.Регистратор,
	|	Партии.Организация,
	|	Партии.АналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов,
	|	Партии.РазделУчета,
	|	Партии.Партия,
	|	Партии.АналитикаУчетаПартий,
	|	Партии.АналитикаФинансовогоУчета,
	|	Партии.ВидДеятельностиНДС
	|
	|ИМЕЮЩИЕ
	|	СУММА(Партии.НДСРегл) <> 0
	|	ИЛИ СУММА(Партии.НДСУпр) <> 0
	|
	|УПОРЯДОЧИТЬ ПО
	|	Регистратор,
	|	Организация,
	|	АналитикаУчетаНоменклатуры,
	|	ВидЗапасов,
	|	РазделУчета,
	|	Партия,
	|	АналитикаФинансовогоУчета,
	|	ВидДеятельностиНДС,
	|	Порядок
	|";
	
	ЗаписьРаспределения = Новый Структура("
	|Период, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, Менеджер, СлужебноеВидДвиженияПриход,
	|ХозяйственнаяОперация, ЗаказКлиента, ТипЗапасов,
	|Подразделение, АналитикаУчетаПоПартнерам,
	|Склад, Соглашение, Договор, ВалютаВзаиморасчетов, ВалютаДокумента,
	|ИсточникГФУНоменклатуры, ИсточникГФУРасчетов,
	|НаправлениеДеятельностиКонтрагента, НаправлениеДеятельностиНоменклатуры,
	|НалогообложениеНДС, ДокументДвижения, ИдентификаторФинЗаписи,
	|РазделУчета, Партия, АналитикаУчетаПартий, АналитикаФинансовогоУчета, ВидДеятельностиНДС,
	|Стоимость, СтоимостьБезНДС, Количество,
	|ДопРасходы, ДопРасходыБезНДС,
	|СтоимостьРегл, НДСРегл, НДСУпр, ПостояннаяРазница, ВременнаяРазница,
	|СтоимостьЗабалансовая, Трудозатраты, ПостатейныеПостоянныеСНДС, ПостатейныеПеременныеСНДС,
	|ПостатейныеПостоянныеБезНДС, ПостатейныеПеременныеБезНДС,
	|СтоимостьЗабалансоваяРегл, ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеПостоянныеРегл, ПостатейныеПеременныеРегл,
	|СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр");
	
	СтрокаОстатка = Новый Структура("
	|Регистратор, Организация, АналитикаУчетаНоменклатуры, ВидЗапасов,
	|РазделУчета, Партия, АналитикаУчетаПартий, АналитикаФинансовогоУчета, ВидДеятельностиНДС,
	|Количество, Стоимость, СтоимостьБезНДС, СтоимостьРегл, НДСРегл, НДСУпр,
	|ДопРасходы, ДопРасходыБезНДС, ПостояннаяРазница, ВременнаяРазница,
	|СтоимостьЗабалансовая, Трудозатраты, ПостатейныеПостоянныеСНДС, ПостатейныеПеременныеСНДС,
	|ПостатейныеПостоянныеБезНДС, ПостатейныеПеременныеБезНДС,
	|СтоимостьЗабалансоваяРегл, ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеПостоянныеРегл, ПостатейныеПеременныеРегл,
	|СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр");
	
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина,,,
		Метаданные.РегистрыНакопления.ВыручкаИСебестоимостьПродаж.Имя);
	
	// Формируются движения по регистрам:
	// - ВыручкаИСебестоимостьПродаж
	Пока Выборка.Следующий() Цикл
		
		Если Выборка.Порядок = 1 Тогда
			
			ЗаполнитьЗначенияСвойств(СтрокаОстатка, Выборка);
			
		ИначеЕсли СтрокаОстатка.Регистратор = Выборка.Регистратор
		 И СтрокаОстатка.Организация = Выборка.Организация
		 И СтрокаОстатка.АналитикаУчетаНоменклатуры = Выборка.АналитикаУчетаНоменклатуры
		 И СтрокаОстатка.ВидЗапасов = Выборка.ВидЗапасов
		 И СтрокаОстатка.РазделУчета = Выборка.РазделУчета
		 И СтрокаОстатка.Партия = Выборка.Партия
		 И СтрокаОстатка.АналитикаФинансовогоУчета = Выборка.АналитикаФинансовогоУчета
		 И СтрокаОстатка.ВидДеятельностиНДС = Выборка.ВидДеятельностиНДС
		 И СтрокаОстатка.Количество > 0 Тогда
		
			ЗаполнитьЗначенияСвойств(ЗаписьРаспределения, Выборка);
			
			РасчетСебестоимостиКорректировкаСтоимости.РаспределитьСтоимость(ЗаписьРаспределения, СтрокаОстатка, Выборка, Выборка.Количество);
			
			РасчетСебестоимостиКорректировкаСтоимости.СформироватьДвиженияВыручкаИСебестоимостьПродаж(ПараметрыРасчета, ЗаписьРаспределения);

		КонецЕсли;
		
	КонецЦикла;
	
 	// Формируются движения по регистрам:
	// - ПрочиеРасходы
	РасчетСебестоимостиКорректировкаСтоимости.СформироватьДвиженияПрочиеРасходыСписаниеНДС(ПараметрыРасчета);
	
	// Формируются движения по регистрам:
	// - ДвиженияНоменклатураДоходыРасходы
	РасчетСебестоимостиКорректировкаСтоимости.СформироватьДвиженияНоменклатураДоходыРасходыСписаниеНДС(ПараметрыРасчета);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, "ВтПартии, ДвиженияПродаж, ВтРегистраторы");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвижения(ПараметрыРасчета);
	
КонецПроцедуры

// Этап 3.18.2
Процедура ВключитьИсключитьНДСВСтоимостьПродаж24(ПараметрыРасчета) Экспорт

	Если НЕ РасчетСебестоимостиПрикладныеАлгоритмы.ВременнаяТаблицаСуществует(ПараметрыРасчета, "ВТОборотыСтоимостьПартийНДС") Тогда
		Возврат;
	КонецЕсли;
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "ВключитьИсключитьНДСВСтоимостьПродаж24");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Продажи.Период КАК Период,
	|	Продажи.Регистратор КАК Регистратор,
	|	АналитикаПартнеров.Организация КАК Организация,
	|	Продажи.Партия КАК Партия,
	|	Продажи.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Продажи.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Продажи.ВидЗапасов КАК ВидЗапасов
	|ПОМЕСТИТЬ ДвиженияПродаж
	|ИЗ
	|	ВТКэшРасчетныеОборотыВыручкаИСебестоимостьПродаж КАК Продажи
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборАналитикаПоПартнерам КАК АналитикаПартнеров
	|		ПО Продажи.АналитикаУчетаПоПартнерам = АналитикаПартнеров.КлючАналитики
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументы
	|		ПО ИсправленныеДокументы.Регистратор = Продажи.Регистратор
	|
	|ГДЕ
	|	&ПартионныйУчетВерсии22
	|	И АналитикаПартнеров.Организация В(&ОрганизацииСУчетомПартийНДСВерсии24)
	|	И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|	И НЕ Продажи.Сторно
	// Исключаем сторно движения исправлений и корректировок прошлого периода.
	// Такие движения уже сформированы в процедуре СкорректироватьСтоимостьСторноДвиженийИсправленныхДокументов() Область ИсправлениеСебестоимостьТоваров
	|	И НЕ (НЕ ИсправленныеДокументы.ДатаДокументаИсточника ЕСТЬ NULL
	|		И ИсправленныеДокументы.ДатаДокументаИсточника < &НачалоПериода
	|		И Продажи.Сторно)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Период,
	|	Регистратор,
	|	Организация,
	|	Партия,
	|	ВидДеятельностиНДС,
	|	АналитикаУчетаНоменклатуры,
	|	ВидЗапасов
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Регистратор КАК Регистратор
	|ПОМЕСТИТЬ ВтРегистраторыВыручки
	|ИЗ
	|	ВТКэшРасчетныеОборотыВыручкаИСебестоимостьПродаж КАК ДД
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Партии.СлужебноеВидДвиженияПриход КАК СлужебноеВидДвиженияПриход,
	|	Партии.Период КАК Период,
	|	Партии.Регистратор КАК Регистратор,
	|	Партии.Организация КАК Организация,
	|	Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов,
	// Подразделение должно заполняться аналогично УчетНДСРФ.ПолучитьПартии
	|	НЕОПРЕДЕЛЕНО КАК ПодразделениеСписанияНДС,
	|	Партии.СтатьяСписанияНДС,
	|	Партии.АналитикаСписанияНДС,
	|	Партии.РазделУчета,
	|	Партии.Партия,
	|	Партии.АналитикаФинансовогоУчета,
	|	Партии.ВидДеятельностиНДС,
	|	Партии.ЕстьДвиженияПоВыручке,
	|	Партии.РаспределениеПоВыбывшимТоварам,
	|
	|	МАКСИМУМ(Партии.Количество) КАК Количество,
	|	СУММА(Партии.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	СУММА(Партии.СтоимостьБезНДСУпр) КАК СтоимостьБезНДСУпр,
	|	СУММА(
	|		ВЫБОР КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА 0
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		ТОГДА
	|			Партии.НДСРегл
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) < &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			Партии.НДСРегл
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		ТОГДА
	|			-Партии.НДСРегл
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) >= &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			-Партии.НДСРегл
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ
	|	) КАК НДСРегл,
	|	СУММА(
	|		ВЫБОР КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА 0
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		ТОГДА
	|			Партии.НДСУпр
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) < &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			Партии.НДСУпр
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		ТОГДА
	|			-Партии.НДСУпр
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) >= &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			-Партии.НДСУпр
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ
	|	) КАК НДСУпр,
	|	СУММА(
	|		ВЫБОР КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА Партии.НДСРегл
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ
	|	) КАК СписаниеНДС,
	|	СУММА(
	|		ВЫБОР КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА Партии.НДСУпр
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ
	|	) КАК СписаниеНДСУпр,
	|	СУММА(ВЫБОР
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|			ТОГДА Партии.СтоимостьБезНДС + Партии.НДСРегл
	|		КОГДА Партии.СтоимостьБезНДС = 0
	|			ТОГДА Партии.НДСРегл
	|		ИНАЧЕ Партии.СтоимостьБезНДС КОНЕЦ) КАК Стоимость
	|ПОМЕСТИТЬ ВтПартии
	|ИЗ (
	|	ВЫБРАТЬ
	|		Партии.СлужебноеВидДвиженияПриход,
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.АналитикаУчетаНоменклатуры,
	|		Партии.ВидЗапасов,
	|		ВЫБОР КОГДА Партии.СлужебноеВидДвиженияПриход
	|			ТОГДА Партии.КорВидДеятельностиНДС
	|			ИНАЧЕ Партии.ВидДеятельностиНДС
	|		КОНЕЦ КАК НалогообложениеПартии,
	|		ВЫБОР КОГДА Партии.СлужебноеВидДвиженияПриход
	|			ТОГДА Партии.ВидДеятельностиНДС
	|			ИНАЧЕ Партии.КорВидДеятельностиНДС
	|		КОНЕЦ КАК НалогообложениеНДС,
	|		Партии.ДокументПоступления КАК ДокументПоступления,
	|		Партии.СтоимостьБезНДСРегл КАК СтоимостьБезНДС,
	|		Партии.СтоимостьБезНДСУпр КАК СтоимостьБезНДСУпр,
	|		Партии.НДСРегл КАК НДСРегл,
	|		Партии.НДСУпр КАК НДСУпр,
	|		Партии.Количество,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС,
	|		Партии.РазделУчета,
	|		(ВЫБОР
	|			КОГДА ДвиженияПродаж.Регистратор ЕСТЬ NULL ТОГДА НЕОПРЕДЕЛЕНО
	|			ИНАЧЕ Партии.Партия КОНЕЦ) КАК Партия,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
	|		Партии.ВидДеятельностиНДС,
	|		Партии.АналитикаУчетаНоменклатуры,
	|		Партии.ВидЗапасов,
	|		ВЫБОР КОГДА Регистраторы.Регистратор ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ КАК ЕстьДвиженияПоВыручке,
	|		(ВЫБОР
	|			КОГДА Партии.ТипЗаписи В (
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК РаспределениеПоВыбывшимТоварам
	|	ИЗ
	|		ВТОборотыСтоимостьПартийНДС КАК Партии
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВтРегистраторыВыручки КАК Регистраторы
	|			ПО Регистраторы.Регистратор = Партии.Регистратор
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДвиженияПродаж КАК ДвиженияПродаж
	|		 ПО ДвиженияПродаж.Период = Партии.Период
	|		 И ДвиженияПродаж.Регистратор = Партии.Регистратор
	|		 И ДвиженияПродаж.Организация = Партии.Организация
	|		 И ДвиженияПродаж.Партия = Партии.Партия
	|		 И ДвиженияПродаж.ВидДеятельностиНДС = Партии.ВидДеятельностиНДС
	|		 И ДвиженияПродаж.АналитикаУчетаНоменклатуры = Партии.АналитикаУчетаНоменклатуры
	|		 И ДвиженияПродаж.ВидЗапасов = Партии.ВидЗапасов
	|	ГДЕ
	|		&ПартионныйУчетВерсии22
	|		И Партии.Организация В(&ОрганизацииСУчетомПартийНДСВерсии24)
	|		И (НЕ Партии.СлужебноеВидДвиженияПриход
	|			ИЛИ Партии.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов))
	|	
	|	) КАК Партии
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|	ПО
	|		ДанныеПервичныхДокументов.Организация = Партии.Организация
	|		И ДанныеПервичныхДокументов.Документ = Партии.ДокументПоступления
	|ГДЕ
	|	Партии.НалогообложениеНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|	И (Партии.ЕстьДвиженияПоВыручке
	|		ИЛИ Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка))
	|
	|СГРУППИРОВАТЬ ПО
	|	Партии.СлужебноеВидДвиженияПриход,
	|	Партии.Период,
	|	Партии.Регистратор,
	|	Партии.Организация,
	|	Партии.АналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов,
	|	Партии.СтатьяСписанияНДС,
	|	Партии.АналитикаСписанияНДС,
	|	Партии.РазделУчета,
	|	Партии.Партия,
	|	Партии.АналитикаФинансовогоУчета,
	|	Партии.ВидДеятельностиНДС,
	|	Партии.ЕстьДвиженияПоВыручке,
	|	Партии.РаспределениеПоВыбывшимТоварам
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Партии.Регистратор КАК Регистратор
	|ПОМЕСТИТЬ ВтРегистраторы
	|ИЗ
	|	ВтПартии КАК Партии
	|ГДЕ
	|	Партии.НДСРегл <> 0
	|	ИЛИ Партии.НДСУпр <> 0
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	2 КАК Порядок,
	|	ЛОЖЬ 							   КАК СлужебноеВидДвиженияПриход,
	|	Продажи.Период                     КАК Период,
	|	Продажи.Регистратор                КАК Регистратор,
	|	Продажи.Регистратор                КАК ДокументДвижения,
	|	АналитикаПартнеров.Организация     КАК Организация,
	|	Продажи.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Продажи.ВидЗапасов                 КАК ВидЗапасов,
	|	Продажи.РазделУчета				   КАК РазделУчета,
	|	Продажи.Партия				   	   КАК Партия,
	|	Продажи.АналитикаУчетаПартий	   КАК АналитикаУчетаПартий,
	|	Продажи.АналитикаФинансовогоУчета  КАК АналитикаФинансовогоУчета,
	|	Продажи.ВидДеятельностиНДС		   КАК ВидДеятельностиНДС,
	|
	|	Продажи.ЗаказКлиента               КАК ЗаказКлиента,
	|	Продажи.АналитикаУчетаПоПартнерам  КАК АналитикаУчетаПоПартнерам,
	|	Продажи.Подразделение              КАК Подразделение,
	|	Продажи.ТипЗапасов                 КАК ТипЗапасов,
	|	Продажи.Менеджер                   КАК Менеджер,
	|	Продажи.Склад                      КАК Склад,
	|	Продажи.Соглашение                 КАК Соглашение,
	|	Продажи.Договор                    КАК Договор,
	|	Продажи.ХозяйственнаяОперация      КАК ХозяйственнаяОперация,
	|	Продажи.НалогообложениеНДС         КАК НалогообложениеНДС,
	|	Продажи.ВалютаВзаиморасчетов       КАК ВалютаВзаиморасчетов,
	|	Продажи.ВалютаДокумента            КАК ВалютаДокумента,
	|	Продажи.ИсточникГФУНоменклатуры    КАК ИсточникГФУНоменклатуры,
	|	Продажи.ИсточникГФУРасчетов        КАК ИсточникГФУРасчетов,
	|	Продажи.НаправлениеДеятельностиКонтрагента КАК НаправлениеДеятельностиКонтрагента,
	|	Продажи.НаправлениеДеятельностиНоменклатуры КАК НаправлениеДеятельностиНоменклатуры,
	|	&ИдентификаторНеиспользуемойФинЗаписи КАК ИдентификаторФинЗаписи,
	|
	|	СУММА(Продажи.Количество) КАК Количество,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК ДопРасходы,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК СтоимостьЗабалансовая,
	|	0 КАК СтоимостьЗабалансоваяРегл,
	|	0 КАК СтоимостьРегл,
	|	0 КАК НДСРегл,
	|	0 КАК НДСУпр,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	0 КАК Трудозатраты,
	|	0 КАК ПостатейныеПостоянныеСНДС,
	|	0 КАК ПостатейныеПеременныеСНДС,
	|	0 КАК ПостатейныеПостоянныеБезНДС,
	|	0 КАК ПостатейныеПеременныеБезНДС,
	|	0 КАК ДопРасходыРегл,
	|	0 КАК ТрудозатратыРегл,
	|	0 КАК ПостатейныеПостоянныеРегл,
	|	0 КАК ПостатейныеПеременныеРегл,
	|	0 КАК СтоимостьУпр,
	|	0 КАК ДопРасходыУпр,
	|	0 КАК ТрудозатратыУпр,
	|	0 КАК ПостатейныеПостоянныеУпр,
	|	0 КАК ПостатейныеПеременныеУпр,
	|
	|	СУММА(Продажи.Количество) КАК ИсходноеКоличество,
	|	0 КАК КорСтоимость
	|ИЗ
	|	ВТКэшРасчетныеОборотыВыручкаИСебестоимостьПродаж КАК Продажи
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтРегистраторы КАК Регистраторы
	|			ПО Регистраторы.Регистратор = Продажи.Регистратор
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборАналитикаПоПартнерам КАК АналитикаПартнеров
	|			ПО Продажи.АналитикаУчетаПоПартнерам = АналитикаПартнеров.КлючАналитики
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТСтоимостьПартийТоваров КАК Цены
	|			ПО Цены.Организация = АналитикаПартнеров.Организация
	|			И Цены.Партия = Продажи.Партия
	|			И Цены.АналитикаУчетаПартий = Продажи.АналитикаУчетаПартий
	|			И Цены.АналитикаФинансовогоУчета = Продажи.АналитикаФинансовогоУчета
	|			И Цены.ВидДеятельностиНДС = Продажи.ВидДеятельностиНДС
	|			И Цены.АналитикаУчетаНоменклатуры = Продажи.АналитикаУчетаНоменклатуры
	|			И Цены.ВидЗапасов = Продажи.ВидЗапасов
	|			И Цены.РазделУчета = Продажи.РазделУчета
	|
	|ГДЕ
	|	АналитикаПартнеров.Организация В(&ОрганизацииСУчетомПартийНДСВерсии24)
	|	И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|	
	|СГРУППИРОВАТЬ ПО
	|	Продажи.Период,
	|	Продажи.Регистратор,
	|	Продажи.АналитикаУчетаНоменклатуры,
	|	Продажи.ЗаказКлиента,
	|	Продажи.АналитикаУчетаПоПартнерам,
	|	Продажи.Подразделение,
	|	Продажи.ТипЗапасов,
	|	Продажи.ВидЗапасов,
	|	Продажи.Менеджер,
	|	Продажи.Склад,
	|	Продажи.Соглашение,
	|	Продажи.Договор,
	|	Продажи.ХозяйственнаяОперация,
	|	Продажи.НалогообложениеНДС,
	|	Продажи.ВалютаВзаиморасчетов,
	|	Продажи.ВалютаДокумента,
	|	Продажи.ИсточникГФУНоменклатуры,
	|	Продажи.ИсточникГФУРасчетов,
	|	Продажи.НаправлениеДеятельностиКонтрагента,
	|	Продажи.НаправлениеДеятельностиНоменклатуры,
	|	АналитикаПартнеров.Организация,
	|	Продажи.РазделУчета,
	|	Продажи.Партия,
	|	Продажи.АналитикаУчетаПартий,
	|	Продажи.АналитикаФинансовогоУчета,
	|	Продажи.ВидДеятельностиНДС
	|
	|ИМЕЮЩИЕ
	|	СУММА(Продажи.Количество) <> 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	1 								   КАК Порядок,
	|	Партии.СлужебноеВидДвиженияПриход  КАК СлужебноеВидДвиженияПриход,
	|	Партии.Период 					   КАК Период,
	|	Партии.Регистратор 				   КАК Регистратор,
	|	Партии.Регистратор 				   КАК ДокументДвижения,
	|	Партии.Организация 				   КАК Организация,
	|	Партии.АналитикаУчетаНоменклатуры  КАК АналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов 				   КАК ВидЗапасов,
	|	Партии.РазделУчета				   КАК РазделУчета,
	|	Партии.Партия				   	   КАК Партия,
	|	НЕОПРЕДЕЛЕНО	       			   КАК АналитикаУчетаПартий,
	|	Партии.АналитикаФинансовогоУчета   КАК АналитикаФинансовогоУчета,
	|	Партии.ВидДеятельностиНДС		   КАК ВидДеятельностиНДС,
	|
	|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
	|	НЕОПРЕДЕЛЕНО КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО КАК ТипЗапасов,
	|	НЕОПРЕДЕЛЕНО КАК Менеджер,
	|	НЕОПРЕДЕЛЕНО КАК Склад,
	|	НЕОПРЕДЕЛЕНО КАК Соглашение,
	|	НЕОПРЕДЕЛЕНО КАК Договор,
	|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
	|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
	|	НЕОПРЕДЕЛЕНО КАК ВалютаВзаиморасчетов,
	|	НЕОПРЕДЕЛЕНО КАК ВалютаДокумента,
	|	НЕОПРЕДЕЛЕНО КАК ИсточникГФУНоменклатуры,
	|	НЕОПРЕДЕЛЕНО КАК ИсточникГФУРасчетов,
	|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельностиКонтрагента,
	|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельностиНоменклатуры,
	|	"""" КАК ИдентификаторФинЗаписи,
	|
	|	СУММА(ВЫБОР КОГДА Партии.Количество < 0 ТОГДА -Партии.Количество
	|		ИНАЧЕ Партии.Количество КОНЕЦ) КАК Количество,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК ДопРасходы,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК СтоимостьЗабалансовая,
	|	0 КАК СтоимостьЗабалансоваяРегл,
	|	СУММА(ВЫБОР
	|		КОГДА Партии.РаспределениеПоВыбывшимТоварам ТОГДА 0
	|		ИНАЧЕ Партии.НДСРегл КОНЕЦ) КАК СтоимостьРегл,
	|	0 КАК НДСРегл,
	|	0 КАК НДСУпр,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	0 КАК Трудозатраты,
	|	0 КАК ПостатейныеПостоянныеСНДС,
	|	0 КАК ПостатейныеПеременныеСНДС,
	|	0 КАК ПостатейныеПостоянныеБезНДС,
	|	0 КАК ПостатейныеПеременныеБезНДС,
	|	СУММА(ВЫБОР
	|		КОГДА Партии.РаспределениеПоВыбывшимТоварам ТОГДА Партии.НДСРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыРегл,
	|	0 КАК ТрудозатратыРегл,
	|	0 КАК ПостатейныеПостоянныеРегл,
	|	0 КАК ПостатейныеПеременныеРегл,
	|	СУММА(ВЫБОР
	|		КОГДА Партии.РаспределениеПоВыбывшимТоварам ТОГДА 0
	|		ИНАЧЕ Партии.НДСУпр КОНЕЦ) КАК СтоимостьУпр,
	|	СУММА(ВЫБОР
	|		КОГДА Партии.РаспределениеПоВыбывшимТоварам ТОГДА Партии.НДСУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыУпр,
	|	0 КАК ТрудозатратыУпр,
	|	0 КАК ПостатейныеПостоянныеУпр,
	|	0 КАК ПостатейныеПеременныеУпр,
	|
	|	0 КАК ИсходноеКоличество,
	|	0 КАК КорСтоимость
	|ИЗ
	|	ВтПартии КАК Партии
	|ГДЕ
	|	Партии.Стоимость <> 0
	|	И Партии.ЕстьДвиженияПоВыручке
	|
	|СГРУППИРОВАТЬ ПО
	|	Партии.СлужебноеВидДвиженияПриход,
	|	Партии.Период,
	|	Партии.Регистратор,
	|	Партии.Организация,
	|	Партии.АналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов,
	|	Партии.РазделУчета,
	|	Партии.Партия,
	|	Партии.АналитикаФинансовогоУчета,
	|	Партии.ВидДеятельностиНДС
	|
	|ИМЕЮЩИЕ
	|	СУММА(Партии.НДСРегл) <> 0
	|	ИЛИ СУММА(Партии.НДСУпр) <> 0
	|
	|УПОРЯДОЧИТЬ ПО
	|	Регистратор,
	|	Организация,
	|	Партия,
	|	ВидДеятельностиНДС,
	|	АналитикаУчетаНоменклатуры,
	|	ВидЗапасов,
	|	Порядок
	|";
	
	ЗаписьРаспределения = Новый Структура("
	|Период, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, Менеджер, СлужебноеВидДвиженияПриход,
	|ХозяйственнаяОперация, ЗаказКлиента, ТипЗапасов,
	|Подразделение, АналитикаУчетаПоПартнерам,
	|Склад, Соглашение, Договор, ВалютаВзаиморасчетов, ВалютаДокумента,
	|ИсточникГФУНоменклатуры, ИсточникГФУРасчетов,
	|НаправлениеДеятельностиКонтрагента, НаправлениеДеятельностиНоменклатуры,
	|НалогообложениеНДС, ДокументДвижения, ИдентификаторФинЗаписи,
	|РазделУчета, Партия, АналитикаУчетаПартий, АналитикаФинансовогоУчета, ВидДеятельностиНДС,
	|Стоимость, СтоимостьБезНДС, Количество,
	|ДопРасходы, ДопРасходыБезНДС,
	|СтоимостьРегл, НДСРегл, НДСУпр, ПостояннаяРазница, ВременнаяРазница,
	|СтоимостьЗабалансовая, Трудозатраты, ПостатейныеПостоянныеСНДС, ПостатейныеПеременныеСНДС,
	|ПостатейныеПостоянныеБезНДС, ПостатейныеПеременныеБезНДС,
	|СтоимостьЗабалансоваяРегл, ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеПостоянныеРегл, ПостатейныеПеременныеРегл,
	|СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр");
	
	СтрокаОстатка = Новый Структура("
	|Регистратор, Организация, АналитикаУчетаНоменклатуры, ВидЗапасов,
	|РазделУчета, Партия, АналитикаУчетаПартий, АналитикаФинансовогоУчета, ВидДеятельностиНДС,
	|Количество, Стоимость, СтоимостьБезНДС, СтоимостьРегл, НДСРегл, НДСУпр,
	|ДопРасходы, ДопРасходыБезНДС, ПостояннаяРазница, ВременнаяРазница,
	|СтоимостьЗабалансовая, Трудозатраты, ПостатейныеПостоянныеСНДС, ПостатейныеПеременныеСНДС,
	|ПостатейныеПостоянныеБезНДС, ПостатейныеПеременныеБезНДС,
	|СтоимостьЗабалансоваяРегл, ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеПостоянныеРегл, ПостатейныеПеременныеРегл,
	|СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр");
	
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина,,,
		Метаданные.РегистрыНакопления.ВыручкаИСебестоимостьПродаж.Имя);
	
	ЭтоПриходноеДвижение = Ложь;
	
	// Формируются движения по регистрам:
	// - ВыручкаИСебестоимостьПродаж
	Пока Выборка.Следующий() Цикл
		
		Если Выборка.Порядок = 1 Тогда
			
			ЗаполнитьЗначенияСвойств(СтрокаОстатка, Выборка);
			ЭтоПриходноеДвижение = Выборка.СлужебноеВидДвиженияПриход;
			
		ИначеЕсли СтрокаОстатка.Регистратор = Выборка.Регистратор
		 И СтрокаОстатка.Организация = Выборка.Организация
		 И СтрокаОстатка.Партия = Выборка.Партия
		 И СтрокаОстатка.ВидДеятельностиНДС = Выборка.ВидДеятельностиНДС
		 И СтрокаОстатка.АналитикаУчетаНоменклатуры = Выборка.АналитикаУчетаНоменклатуры
		 И СтрокаОстатка.ВидЗапасов = Выборка.ВидЗапасов
		 И СтрокаОстатка.Количество > 0 Тогда
		
			ЗаполнитьЗначенияСвойств(ЗаписьРаспределения, Выборка);
			
			РасчетСебестоимостиКорректировкаСтоимости.РаспределитьСтоимость(ЗаписьРаспределения, СтрокаОстатка, Выборка, Выборка.Количество);
			ЗаписьРаспределения.СлужебноеВидДвиженияПриход = ЭтоПриходноеДвижение;
			
			РасчетСебестоимостиКорректировкаСтоимости.СформироватьДвиженияВыручкаИСебестоимостьПродаж(ПараметрыРасчета, ЗаписьРаспределения);

		КонецЕсли;
		
	КонецЦикла;
	
	// Формируются движения по регистрам:
	// - ПрочиеРасходы
	РасчетСебестоимостиКорректировкаСтоимости.СформироватьДвиженияПрочиеРасходыСписаниеНДС(ПараметрыРасчета);
	
	// Формируются движения по регистрам:
	// - ДвиженияНоменклатураДоходыРасходы
	РасчетСебестоимостиКорректировкаСтоимости.СформироватьДвиженияНоменклатураДоходыРасходыСписаниеНДС(ПараметрыРасчета);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(
		ПараметрыРасчета,
		"ВтПартии, ДвиженияПродаж, ВтРегистраторыВыручки, ВтРегистраторы");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвижения(ПараметрыРасчета);
	
КонецПроцедуры

#КонецОбласти

#Область УчетНДС

// Возвращает имя регистра, используемого для учета партий НДС, при партионном учете версии 2.2.
//
// Параметры:
//	Организация - СправочникСсылка.Организации - организация
//	Период 		- Дата - период учета НДС
//
// Возвращаемое значение:
//	Строка - имя регистра учета партий НДС; возможные значения "ДетализацияПартийТоваровДляНДСиУСН", "ДетализацияПартийТоваровДляНДСиУСН2_4"
//
Функция ИмяРегистраУчетаПартийНДС(Организация, Период = Неопределено) Экспорт
	
	ИмяРегистра 		   = "";
	ПериодПолитики		   = НачалоМесяца(?(ЗначениеЗаполнено(Период), Период, ТекущаяДатаСеанса()));
	ПартионныйУчетВерсии22 = РасчетСебестоимостиПовтИсп.ПартионныйУчетВерсии22(ПериодПолитики);
	
	Если ПартионныйУчетВерсии22 Тогда
		
		ПараметрыУчетнойПолитикиНастройкиУчетаНДС = НастройкиНалоговУчетныхПолитик.ДействующиеПараметрыНалоговУчетныхПолитикНаДату(
			"НастройкиУчетаНДС",
			Организация,
			ПериодПолитики);
		
		ПараметрыУчетнойПолитикиНастройкиУчетаУСН = НастройкиНалоговУчетныхПолитик.ДействующиеПараметрыНалоговУчетныхПолитикНаДату(
			"НастройкиУчетаУСН",
			Организация,
			ПериодПолитики);
		
		ПараметрыУчетнойПолитикиНастройкиСистемыНалогообложения = НастройкиНалоговУчетныхПолитик.ДействующиеПараметрыНалоговУчетныхПолитикНаДату(
			"НастройкиСистемыНалогообложения",
			Организация,
			ПериодПолитики);
		
		Если (ПараметрыУчетнойПолитикиНастройкиУчетаНДС <> Неопределено 
		 	И ПараметрыУчетнойПолитикиНастройкиУчетаНДС.РаздельныйУчетТоваровПоНалогообложениюНДС)
		 ИЛИ (ПараметрыУчетнойПолитикиНастройкиСистемыНалогообложения <> Неопределено
		 		И ПараметрыУчетнойПолитикиНастройкиУчетаНДС <> Неопределено 
		 		И ПараметрыУчетнойПолитикиНастройкиСистемыНалогообложения.СистемаНалогообложения = Перечисления.СистемыНалогообложения.Упрощенная
		 		И ПараметрыУчетнойПолитикиНастройкиУчетаУСН.РаздельныйУчетТоваров) Тогда
				
					ПараметрыУчетнойПолитики = НастройкиНалоговУчетныхПолитик.ДействующиеПараметрыНалоговУчетныхПолитикНаДату(
						"УчетнаяПолитикаФинансовогоУчета",
						Организация,
						ПериодПолитики);
						
					Если ПараметрыУчетнойПолитики <> Неопределено
						И ПараметрыУчетнойПолитики.МетодОценкиСтоимостиТоваров = Перечисления.МетодыОценкиСтоимостиТоваров.ФИФОСкользящаяОценка Тогда
						ИмяРегистра = Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН2_4.Имя;
					Иначе
						ИмяРегистра = Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН.Имя;
					КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат ИмяРегистра;
	
КонецФункции

#Область Описание_СформироватьДетализациюПартийНДС

// Процедура СформироватьДетализациюПартийНДС() является интерфейсом между механизмом детализации себестоимости и 
// механизмами учета НДС и формирования бухгалтерских проводок.
// Выходными данными процедуры является временная таблица ВТСтоимостьПартийНДС(), которая формируется по движениям
// регистра "Себестоимость товаров" с добавлением данных детализации партий.
//
// Входные данные:
// - ВТТаблицаОтбораРегистраторов - временная таблица документов - регистраторов, для которых необходимо сформировать детализацию
//
// Запросы выборки данных формируются в функции ТекстЗапросаДетализацияПартийНДС() и содержат следующие временные таблицы:
// - ВТПередачиБезНДС - ссылки на документы "Передача товаров между организациями" и аналитики номенклатуры, для которых
//	в строке документа указана ставка "Без НДС". По таким строкам кор вид деятельности НДС должен быть "Продажа не облагается НДС".
//	По движениям регистра "Себестоимость товаров" это не определить, т.к. в движениях поле "Кор вид деятельности НДС"
//	соответствует движению "Приход" у организации - получателя, которое заполняется значением поля "Передача под деятельность" документа.
//	Это необходимо для расчета СЛУ в части стоимости управленческого учета предприятия.
//
// - ВТРаспределениеЗатрат - итоговые движения по регистру "Партии прочих расходов" документов "Распределение расходов".
// 		Используется для формирования детализации партий в таблице ВТСтоимостьПартийНДСПредварительная по движениям регистра "Партии прочих расходов".
// - ВТРаспределениеЗатратСИдентификаторами - ссылки на документы "Распределение расходов", у которых в движениях 
//		по регистру "Партии прочих расходов" заполнено поле ИдентификаторФинЗаписи.
// 		Формируется по данным временной таблицы ВТРаспределениеЗатрат.
// 		Используется для формирования детализации партий в таблице ВТСтоимостьПартийНДСПредварительная по движениям регистра "Партии прочих расходов".
// - ВТПартииИзСебестоимости - таблица партий из регистра "Себестоимость товаров" за текущий период.
//		Используется для отбора движений детализации партий.
// - ВТЦеныПартийНДС - данные регистров детализации партий по партиям текущего периода.
//		Формируется по данным непериодических регистров сведений ДетализацияСебестоимостиПартииТоваров и ДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты
//		с отбором по временной таблице ВТПартииИзСебестоимости.
// 		Используется для формирования детализации партий в таблице ВТСтоимостьПартийНДСПредварительная.
// - ВТЦеныПартийНДСДетально - данные периодическийх регистров детализации партий по партиям текущего периода.
//		Формируется по данным периодических регистров сведений ДетализацияСебестоимостиТоваров и ДетализацияСебестоимостиТоваровПостатейныеЗатраты
//		с отбором по временной таблице ВТПартииИзСебестоимости.
// 		Используется для формирования детализации партий в таблице ВТСтоимостьПартийНДСПредварительная.
// - ВТКорректировкиВДокументеПоступления - таблица документов "Корректировка приобретения" которые присутствуют в детализации партий.
//		Формируется по данным временных таблиц ВТЦеныПартийНДС и ВТЦеныПартийНДСДетально.
// - ВТОтборПартии - таблица партий, по которым есть детализация партий.
//		Формируется по данным временных таблоиц ВТЦеныПартийНДС и ВТЦеныПартийНДСДетально.
//		Используется для отбора двмжений по регистру "Себестоимость товаров".
// - ВТДвиженияПеремещения - таблица изменений аналитики в себестоимости товаров.
//		Формируется по движениям "Приход" и "Расход" по реистру "Себестоимость товаров" с отбором по таблице ВТОтборПартии.
//		В таблицу попадают документы, по которым в себестоимости товаров поменялись измерения:
//		Партия, ВидДеятельностиНДС, АналитикаУчетаНоменклатуры (если в анлитике изменилась направление деятельности), Организация
// - ВТИтогКоличествоПредварительная - таблица итогов по полю "Колючество" по документам и измерениям себестоимости товаров
// - ВТНоменклатураБезКоличества - таблица аналитики номенклатуры, по которым есть движения себестоимости товаров без количества
//		Формируется по данным таблицы ВТИтогКоличествоПредварительная
// - ВТПартииБезКоличества - таблица партий, по которым есть движения себестоимости товаров без количества
//		Формируется по данным таблицы ВТИтогКоличествоПредварительная
// - ВТКоличествоПартий - таблица количества поступивших товаров по партиям и аналитике учета номенклатуры.
//		Формируется по движениям регистра "Себестоимость товаров" с отбором по типу записей "Партия" с заполненным количеством, и
//		отбором по временным таблицам ВТПартииБезКоличества и ВТНоменклатураБезКоличества
// - ВТОстаткиПартий - начальные остатки из регистра "Себестоимость товаров" в разрезе периодов - месяц с отбором
//		по временным таблицам ВТПартииБезКоличества и ВТНоменклатураБезКоличества.
// - ВТИтогКоличество - таблица количества номенклатуры по документам и аналитике учета номенклатуры, в которой
//		количество равно либо остатку партии на начало месяца, либо приходу партии в текущем месяце.
//		Формируется по данным временных таблиц ВТИтогКоличествоПредварительная, ВТОстаткиПартий, ВТКоличествоПартий.
// - ВТДвиженияСебестоимостиДляПартийНДС - таблица движений себестоимости товаров, которые имеют смысл для целей НДС
//		Формируется по движениям регистра "Себестоимость товаров" с отбором по таблицам ВТТаблицаОтбораРегистраторов и ВТОтборПартии.
//		Исключаютя движения по которым нет изменений аналитики - используются данные таблицы ВТДвиженияПеремещения.
//		Итоговое количество товаров берется из таблицы ВТИтогКоличество.
//		Поле КорВидДеятельностиНДС переопределяется по следующим правилам:
//		- для передач товаров без НДС устанавливается "Продажа не облагается НДС". Используются данные таблицы ВТПередачиБезНДС.
//		- для расходных движений передач товаров берется из поля НалогообложениеНДС документа. 
//			Это вид деятельности НДС продажи товаров у организации - отправителя.
//		- для приходных движений возвратов между организациями берется из поля НалогообложениеНДС документа
//			Это вид деятельности НДС, по которому был продан товар в организации - получателе (в которую возвращается товар).
//		Для целей учета НДС исключаются:
//		- движения документов "Распределение расходов" с типом записей "ВключениеИсключениеНДСВСтоимости"
//		- движения по забалансовым разделам учета
//		- движения с пустым количеством или стоимостями
// - ВТСтоимостьПартийНДСПредварительная - таблица движений себестоимости товаров, дополненная детализацией партий.
//		Формируется по данным временной таблицы ВТДвиженияСебестоимостиДляПартийНДС и данных детализации партий.
//		Для движений документов "Распределение затрат" детализация определяется из движений регистра "Партии прочих расходов".
//		Для этого используются временные таблицы ВТРаспределениеЗатратСИдентификаторами и ВТРаспределениеЗатрат.
//		Таблица ВТСтоимостьПартийНДСПредварительная формируется тремя запросами:
//		1. Детализация партий из непериодических регистров - по данным временной таблицы ВТЦеныПартийНДС.
//		2. Детализация партий из периодических регистров - по данным временной таблицы ВТЦеныПартийНДСДетально
//		3. Детализация незавершенного производства. Используются движения регистра ДетализацияСебестоимостиТоваровПостатейныеЗатратыНЗП
//		4. Корректировки приобретения прошлого периода. Используются движения регистра СебестоимостьТоваров
// - ВТДокументыПоступленияНДС - таблица документов поступления из временной таблицы ВТСтоимостьПартийНДСПредварительная
// - ВТПериодыУчетныхПолитик - период используемой учетной политики НДС из регистра НастройкиУчетаНДС для каждого документа поступления
//		Формируется по данным временной таблицы ВТДокументыПоступленияНДС.
// - ВТНастройкиСписанияНДС - таблица настроек списания НДС для каждого документа поступления, если в настройках учета НДС 
//		не используется включение НДС в стоимость.
// - ВТДокументыСписанияНДС - таблица документов поступлений по которым НДС списывается на статью расходов
// - ВТСтоимостьПартийНДСБезКорректировокНДС - промежуточная таблица детализации партий. Формируется на основании временной таблицы ВТСтоимостьПартийНДСПредварительная.
//		Поля СтатьяСписанияНДС и АналитикаСписанияНДС заполняются по данным временной таблицы ВТДокументыСписанияНДС.
// - ВТДокументыПоступления - таблица, в которой хранится информация о всех документах поступления, для которых выполныесть включение НДС в стоимость
// 		Поле НомерЗаписи определяет, на какую строку таблицы ВТСтоимостьПартийНДСБезКорректировокНДС будет отнесено отклонение в копейках (если таковое имеется)
// - ВТОборотыДвиженияПоНДС - сумма оборотов по регистру ДвиженияПоНДС за предыдущие периоды с отбором по документам поступления из ВТДокументыПоступления
// - ВТКорректировкиНДС - таблица расхождения сумм НДС между регистрами себестоимости (партиями НДС) и регистром ДвиженияПоНДС
// 		Если сумма расхождений укладывается в погрешность ПорогСписанияПогрешностейОкругленияНДС, то эту сумму надо скорректировать в итоговой таблице  
// - ВТСтоимостьПартийНДС - итоговая таблица детализации партий с учетом расхождений в копейках.
//
// Возвращаемое значение:
//	Временная таблица, содержащая следующие поля:
//		ЭтоНЗП - Булево - признак того, что записи выбирались из регистра РегистрСведений.ДетализацияСебестоимостиТоваровПостатейныеЗатратыНЗП;
//		ЭтоРаспределениеПрочихЗатрат - Булево - признак того, что регистратором документа выступает РаспределениеПрочихЗатрат;
//		ДатаРегистратора - Дата - Дата документа поступления, полученная из реестра документов;
//		Период - Дата - период записи исходного регистра;
//		ВидДвижения - ВидДвиженияНакопления - вид движения исходного регистра;
//		Регистратор - ДокументСсылка - регистратор исходного регистра;
//		АналитикаУчетаНоменклатуры - СправочникСсылка.КлючиАналитикиУчетаНоменклатуры;
//		КорАналитикаУчетаНоменклатуры - СправочникСсылка.КлючиАналитикиУчетаНоменклатуры;
//		ВидЗапасов - СправочникСсылка.ВидыЗапасов - используется в основном для получения ГФУ номенклатуры;
//		КорВидЗапасов - СправочникСсылка.ВидыЗапасов - используется в основном для получения ГФУ номенклатуры;
//		Организация - СправочникСсылка.Организации;
//		АналитикаУчетаПартийДокументаПоступления - СправочникСсылка.КлючиАналитикиУчетаПартий - используется в основном для получения контрагента и виду ценности;
//		СтатьяСписанияНДС - ПланВидовХарактеристикСсылка.СтатьиРасходов - статья расходов направления списания НДС
//			при изменении вида деятельности на "Продажи, не облагаемые НДС" / "Продажи, облагаемые ЕНВД" из учетной политики настройки учета НДС;
//		АналитикаСписанияНДС - Характеристика.СтатьиРасходов - аналитика расходов направления списания НДС
//			при изменении вида деятельности на "Продажи, не облагаемые НДС" / "Продажи, облагаемые ЕНВД" из учетной политики настройки учета НДС;
//		Партия - ДокументСсылка - ссылка на исходный документ появления товаров на остатках организации;
//		ДокументПоступления - ДокументСсылка - ссылка на документ, который стал инициатором расхода;
//		ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации;
//		Сторно - Булево;
//		СтоимостьБезНДС - Число - сумма без НДС в валюте регл. учета;
//		НДС - Число - сумма НДС в валюте регл. учета;
//		СтоимостьБезНДСУпр - Число - сумма без НДС в валюте упр. учета;
//		НДСУпр - Число - сумма НДС в валюте упр. учета;

#КонецОбласти

// Формирует временную таблицу ВТСтоимостьПартийНДС, содержащую информацию о ценах партий НДС.
//
Процедура СформироватьДетализациюПартийНДС(МенеджерВременныхТаблиц, Организация,
			НачалоПериода, КонецПериода, УничтожатьВспомогательныеТаблицы = Истина, СтруктураОтбора = Неопределено, СтруктураДанных = Неопределено) Экспорт
	
	ИмяТаблицыРезультата = "ВТСтоимостьПартийНДС"; 
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(МенеджерВременныхТаблиц, ИмяТаблицыРезультата);
	
	СуществующиеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(МенеджерВременныхТаблиц);
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	Запрос.УстановитьПараметр("МассивОрганизаций", 			  ОбщегоНазначенияУТКлиентСервер.Массив(Организация));
	Запрос.УстановитьПараметр("НачалоПериода", 	   			  НачалоМесяца(НачалоПериода));
	Запрос.УстановитьПараметр("КонецПериода", 	   			  КонецМесяца(КонецПериода));
	
	ИнициализироватьДополнительныеПараметрыЗапросаДетализацииПартийНДС(Запрос, СтруктураДанных);
	
	Запрос.Текст = ТекстЗапросаДетализацияПартийНДС(,,, СтруктураОтбора, СтруктураДанных);
	
	ПараметрыРасчета = Новый Структура;
	ПараметрыРасчета.Вставить("РезультатВыполненияЗапроса", "");
	
	ВремяНачала = ТекущаяУниверсальнаяДатаВМиллисекундах();
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
	
	Длительность = (ТекущаяУниверсальнаяДатаВМиллисекундах() - ВремяНачала)/1000;
	
	// Выведем информацию в журнал регистрации
	Если ЗначениеЗаполнено(СтруктураОтбора) Тогда
		
		Для Каждого КлючИЗначение Из СтруктураОтбора Цикл
			ИмяТаблицы = КлючИЗначение.Ключ;
			Прервать;
		КонецЦикла;
		
		ТекстОтбор = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			"""%1"" (%2)",
			ИмяТаблицы,
			РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(МенеджерВременныхТаблиц, ИмяТаблицы));
		
	Иначе
		ТекстОтбор = НСтр("ru = 'не задан'", ОбщегоНазначения.КодОсновногоЯзыка())
	КонецЕсли;
	
	ТекстДляПротокола = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Общее время: %1
			|Период: %2
			|Организации: %3
			|Отбор: %4
			|%5'", ОбщегоНазначения.КодОсновногоЯзыка()),
		РасчетСебестоимостиПротоколРасчета.ПредставлениеВремени(Длительность),
		РасчетСебестоимостиПротоколРасчета.ПредставлениеПериодаРасчета(НачалоПериода),
		РасчетСебестоимостиПрикладныеАлгоритмы.ПредставлениеОрганизаций(ОбщегоНазначенияУТКлиентСервер.Массив(Организация), ", ", Истина),
		ТекстОтбор,
		ПараметрыРасчета.РезультатВыполненияЗапроса);
	
	ЗаписьЖурналаРегистрации(
		РасчетСебестоимостиПрикладныеАлгоритмы.ИмяСобытияЖурналаРегистрации(Неопределено, "СформироватьДетализациюПартийНДС"),
		УровеньЖурналаРегистрации.Информация,,,
		ТекстДляПротокола);
	
	Если УничтожатьВспомогательныеТаблицы Тогда
		
		НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(
			МенеджерВременныхТаблиц,
			РасчетСебестоимостиУниверсальныеАлгоритмы.СоединитьСтроки(СуществующиеВТ, ИмяТаблицыРезультата));
		
		РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(МенеджерВременныхТаблиц, НовыеВТ);
		
	КонецЕсли;
	
КонецПроцедуры

// Возвращает текст запроса формирования временной таблицы ВТСтоимостьПартийНДС.
// 
// Параметры:
// 	ТекстОрганизация - Строка - имя параметра для отбора по организации
// 	ТекстНачалоПериода - Строка - имя параметра для отбора по началу периода
// 	ТекстКонецПериода - Строка - имя параметра для отбора по концу периода
//	СтруктураОтбора - Структура, Неопределено - описание временной таблицы для отбора
//	СтруктураДанных - Структура, Неопределено - описание возвращаемых данных для конкретного места вызова метода 
//
// Возвращаемое значение:
// 	Строка - текст запроса
//
Функция ТекстЗапросаДетализацияПартийНДС(ТекстОрганизация = "", ТекстНачалоПериода = "", ТекстКонецПериода = "", СтруктураОтбора = Неопределено, СтруктураДанных = Неопределено) Экспорт
	
	Если ЗначениеЗаполнено(СтруктураДанных)
	 И ЗначениеЗаполнено(СтруктураДанных.ИмяДокумента)
	 И НЕ Метаданные.Документы[СтруктураДанных.ИмяДокумента].Движения.Содержит(Метаданные.РегистрыНакопления.СебестоимостьТоваров) Тогда
		
		// Запрос получения партий НДС выполнять не нужно, т.к. документ не может иметь движений по себестоимости.
		// Надо вернуть пустую таблицу, совпадающую по структуре с таблицей ВТСтоимостьПартийНДС.
		ТекстЗапроса =
		"ВЫБРАТЬ ПЕРВЫЕ 0
		|	ЛОЖЬ КАК ЭтоНЗП,
		|	ЛОЖЬ КАК ЭтоРаспределениеПрочихЗатрат,
		|	Т.Период КАК ДатаРегистратора,
		|	Т.Период КАК Период,
		|	Т.ВидДвижения КАК ВидДвижения,
		|	Т.Регистратор КАК Регистратор,
		|	Т.Партия КАК Партия,
		|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	Т.РазделУчета КАК РазделУчета,
		|	Т.ВидЗапасов КАК ВидЗапасов,
		|	Т.Организация КАК Организация,
		|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
		|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
		|	Т.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	Т.КорРазделУчета КАК КорРазделУчета,
		|	Т.КорВидЗапасов КАК КорВидЗапасов,
		|	Т.Подразделение КАК Подразделение,
		|   Т.Подразделение КАК КорПодразделение,
		|   Т.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
		|   Т.АналитикаРасходов КАК АналитикаРасходов,
		|	Т.СтатьяАктивовПассивов КАК СтатьяАктивовПассивов,
		|	Т.АналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
		|	Т.ГруппаПродукции КАК ГруппаПродукции,
		|	Т.КорАналитикаФинансовогоУчета КАК КорАналитикаФинансовогоУчета,
		|	Т.КорВидДеятельностиНДС КАК КорВидДеятельностиНДС,
		|	Т.ТипЗаписи КАК ТипЗаписи,
		|	Т.ДокументИсточник КАК ДокументИсточник,
		|	Т.Сторно КАК Сторно,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК КорНаправлениеДеятельности,
		|   Т.ГруппаПродукции КАК КорГруппаПродукции,
		|	Т.СтатьяРасходовСписания КАК СтатьяСписанияНДС,
		|	Т.АналитикаРасходов КАК АналитикаСписанияНДС,
		|	Т.Партия КАК ДокументПоступления,
		|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартийДокументаПоступления,
		|	0 КАК Количество,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДС,
		|	0 КАК СтоимостьБезНДСУпр,
		|	0 КАК НДСУпр
		|ПОМЕСТИТЬ ВТСтоимостьПартийНДС
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК Т
		|ГДЕ
		|	ЛОЖЬ";
		
		Возврат ТекстЗапроса;
		
 	КонецЕсли;
 	
	МассивЗапросов = Новый Массив;
	
	ТекстЗапроса = НастройкиНалоговУчетныхПолитик.ТекстЗапросаГоловныеОрганизации(); 
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, ";", " ");
	МассивЗапросов.Добавить(ТекстЗапроса);

	ТекстЗапроса = РегистрыСведений.НастройкиСистемыНалогообложения.ТекстЗапросаДействующиеПараметрыНалоговУчетныхПолитик();	
	СхемаЗапроса = Новый СхемаЗапроса;
	СхемаЗапроса.УстановитьТекстЗапроса(ТекстЗапроса);
	СхемаЗапроса.ПакетЗапросов[0].ТаблицаДляПомещения = "ВТУчетныеПолитикиОрганизаций";
	СхемаЗапроса.ПакетЗапросов[0].Индекс.Добавить("Организация");
	НовыйПакет = СхемаЗапроса.ПакетЗапросов.Добавить(Тип("ЗапросУничтоженияТаблицыСхемыЗапроса"));
	НовыйПакет.ИмяТаблицы = "ВтГоловныеОрганизации";
	ТекстЗапроса = СхемаЗапроса.ПолучитьТекстЗапроса();	
	МассивЗапросов.Добавить(ТекстЗапроса);
	
	ТекстЗапроса =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Ссылка КАК Ссылка,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	Т.АналитикаУчетаНоменклатуры.Серия КАК Серия
	|ПОМЕСТИТЬ ВТПередачиБезНДС
	|ИЗ
	|	Документ.ПередачаТоваровМеждуОрганизациями.ВидыЗапасов КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями КАК Передачи
	|		ПО Т.Ссылка = Передачи.Ссылка
	|ГДЕ
	|	Передачи.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Передачи.Организация В (&МассивОрганизаций)
	|	И Передачи.Проведен
	|	И Т.СтавкаНДС = ЗНАЧЕНИЕ(Справочник.СтавкиНДС.БезНДС)
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Регистратор КАК Регистратор,
	|	Т.ДокументПоступленияРасходов,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.НаправлениеДеятельности,
	|	Т.КорНаправлениеДеятельности,
	|	Т.ИдентификаторФинЗаписи,
	|	СУММА(Т.Стоимость) КАК Стоимость,
	|	СУММА(Т.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	СУММА(Т.СтоимостьРегл) КАК СтоимостьРегл,
	|	СУММА(Т.НДСРегл) КАК НДСРегл,
	|	СУММА(Т.НДСУпр) КАК НДСУпр
	|ПОМЕСТИТЬ ВТРаспределениеЗатрат
	|ИЗ
	|	РегистрНакопления.ПартииПрочихРасходов КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК Отбор
	|		ПО Т.Регистратор = Отбор.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТТаблицаОтбораРегистраторов КАК ОтборРегистраторов
	|		ПО &УсловияДляРегистраторов
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.ДокументПоступленияРасходов,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.НаправлениеДеятельности,
	|	Т.КорНаправлениеДеятельности,
	|	Т.ИдентификаторФинЗаписи
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Регистратор
	|ПОМЕСТИТЬ ВТРаспределениеЗатратСИдентификаторами
	|ИЗ
	|	ВТРаспределениеЗатрат КАК Т
	|ГДЕ
	|	Т.ИдентификаторФинЗаписи <> """"
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Регистратор КАК Регистратор,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	ВЫБОР КОГДА НЕ Корректировка.ВидКорректировки ЕСТЬ NULL
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЭтоКорректировка,
	|	ВЫБОР
	|		КОГДА НЕ Корректировка.ВидКорректировки ЕСТЬ NULL
	|		 И Корректировка.ВидКорректировки <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон)
	|			ТОГДА Корректировка.ДокументОснование
	|			ИНАЧЕ Т.Регистратор
	|	КОНЕЦ КАК ДокументПоступления,
	|	МАКСИМУМ(ВЫБОР
	|		КОГДА НЕ Корректировка.Ссылка ЕСТЬ NULL
	|			ТОГДА Т.АналитикаУчетаПартий
	|		КОГДА Т.КорАналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|			ТОГДА Т.КорАналитикаУчетаПартий
	|			ИНАЧЕ Т.АналитикаУчетаПартий
	|	КОНЕЦ) КАК АналитикаУчетаПартийДокументаПоступления
	|ПОМЕСТИТЬ ВТДопРасходыБезКоличества
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК Корректировка
	|		ПО Корректировка.Ссылка = Т.Регистратор
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТТаблицаОтбораРегистраторов КАК ОтборРегистраторов
	|		ПО &УсловияДляРегистраторов
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	// Доп. расходы без количества могут возникать при корректировке суммы приобретения, заявлении о ввозе и таможенной декларации,
	//	во всех случаях они определяются перечисленными типами записи, за исключением фактуровки поставки при включении НДС в стоимость в операциях приобретения.
	//	Такое же условие должно быть прописано при заполнении поля ЭтоДопРасходыБезКоличества временной таблицы "ВТДвиженияСебестоимостиДляПартийНДСПредварительная".
	|	И (Т.ТипЗаписи В (
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии))
	|		ИЛИ Т.ТипЗаписи В (
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией))
	|		И (Т.Регистратор ССЫЛКА Документ.ЗаявлениеОВвозеТоваров
	|			ИЛИ Т.Регистратор ССЫЛКА Документ.ТаможеннаяДекларацияИмпорт)
	|	)
	|	И НЕ Т.РасчетСебестоимости
	|	И НЕ Т.Сторно
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	ВЫБОР КОГДА НЕ Корректировка.ВидКорректировки ЕСТЬ NULL
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА НЕ Корректировка.ВидКорректировки ЕСТЬ NULL
	|		 И Корректировка.ВидКорректировки <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон)
	|			ТОГДА Корректировка.ДокументОснование
	|			ИНАЧЕ Т.Регистратор
	|	КОНЕЦ
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия,
	|	АналитикаУчетаПартий,
	|	Организация
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Партия,
	|	МАКСИМУМ(ВЫБОР КОГДА Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
	|			ТОГДА ИСТИНА
	|			ИНАЧЕ ЛОЖЬ
	|		КОНЕЦ) КАК ОпределяетсяРаспределением
	|ПОМЕСТИТЬ ВТПартииИзСебестоимости
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТТаблицаОтбораРегистраторов КАК ОтборРегистраторов
	|		ПО &УсловияДляРегистраторов
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|	И НЕ Т.РасчетСебестоимости
	|	И Т.ТипЗаписи <> ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
	|	И НЕ Т.РазделУчета В (&РазделыУчетаЗабалансовые)
	|	И Т.Активность
	|СГРУППИРОВАТЬ ПО
	|	Т.Партия
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.Организация КАК Организация,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.Номенклатура КАК Номенклатура,
	|	Т.Характеристика КАК Характеристика,
	|
	|	Т.ДокументПоступления КАК ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	СУММА(Т.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	СУММА(Т.НДС) КАК НДС,
	|	СУММА(Т.СтоимостьБезНДСУпр) КАК СтоимостьБезНДСУпр,
	|	СУММА(Т.НДСУпр) КАК НДСУпр
	|ПОМЕСТИТЬ ВТЦеныПартийНДС
	|ИЗ
	|(ВЫБРАТЬ
	|	ВЫБОР КОГДА Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка)
	|		ТОГДА Т.ПериодРегистрации
	|		ИНАЧЕ ДОБАВИТЬКДАТЕ(Т.ПериодРегистрации, МЕСЯЦ, 1)
	|	КОНЕЦ КАК Период,
	|	Т.Организация КАК Организация,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.Номенклатура КАК Номенклатура,
	|	Т.Характеристика КАК Характеристика,
	|
	|	Т.ДокументПоступления КАК ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
	|	ВЫБОР КОГДА Корректировка.Ссылка ЕСТЬ NULL
	|		ТОГДА ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|		ИНАЧЕ Т.АналитикаУчетаНоменклатурыДокументаПоступления
	|	КОНЕЦ КАК АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.СтоимостьБезНДСРегл КАК СтоимостьБезНДС,
	|	Т.НДСРегл КАК НДС,
	|	Т.СтоимостьБезНДСУпр КАК СтоимостьБезНДСУпр,
	|	Т.НДСУпр КАК НДСУпр
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиПартииТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТТаблицаОтбораПартийНДС КАК ОтборПартийНДС
	|	ПО &УсловияСоединения
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПартииИзСебестоимости КАК ОтборПартийСебестоимости
	|	ПО Т.Партия = ОтборПартийСебестоимости.Партия
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК Корректировка
	|		ПО Т.ДокументПоступления = Корректировка.Ссылка
	|		И Корректировка.ВидКорректировки = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон)
	|		И НЕ &ОтражениеВРеглУчете
	|ГДЕ
	|	Т.ПериодРегистрации <= &КонецПериода
	|	И Т.Организация В (&МассивОрганизаций)
	|	И ВЫБОР
	|		КОГДА &ОтражениеВРеглУчете ИЛИ &ОтражениеВУчетеНДС ТОГДА
	|			Т.НДСРегл <> 0 ИЛИ ОтборПартийСебестоимости.ОпределяетсяРаспределением
	|		ИНАЧЕ
	|			ИСТИНА
	|	КОНЕЦ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.ПериодРегистрации КАК Период,
	|	Т.Организация КАК Организация,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.Номенклатура КАК Номенклатура,
	|	Т.Характеристика КАК Характеристика,
	|
	|	Т.ДокументПоступления КАК ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.СтоимостьБезНДСРегл КАК СтоимостьБезНДС,
	|	Т.НДСРегл КАК НДС,
	|	Т.СтоимостьБезНДСУпр КАК СтоимостьБезНДСУпр,
	|	Т.НДСУпр КАК НДСУпр
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТТаблицаОтбораПартийНДС КАК ОтборПартийНДС
	|	ПО &УсловияСоединения
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПартииИзСебестоимости КАК ОтборПартийСебестоимости
	|	ПО Т.Партия = ОтборПартийСебестоимости.Партия
	|ГДЕ
	|	Т.ПериодРегистрации <= &КонецПериода
	|	И Т.Организация В (&МассивОрганизаций)
	|	И ВЫБОР
	|		КОГДА &ОтражениеВРеглУчете ИЛИ &ОтражениеВУчетеНДС ТОГДА
	|			Т.НДСРегл <> 0 ИЛИ ОтборПартийСебестоимости.ОпределяетсяРаспределением
	|		ИНАЧЕ
	|			ИСТИНА
	|	КОНЕЦ
	|) КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.Период,
	|	Т.Организация,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидЗапасов,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия,
	|	АналитикаУчетаПартий,
	|	Организация
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Т.ДокументПоступления КАК ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	СУММА(Т.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	СУММА(Т.НДС) КАК НДС,
	|	СУММА(Т.СтоимостьБезНДСУпр) КАК СтоимостьБезНДСУпр,
	|	СУММА(Т.НДСУпр) КАК НДСУпр
	|ПОМЕСТИТЬ ВТЦеныПартийНДСДетально
	|ИЗ
	|(ВЫБРАТЬ
	|	Т.Период,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Т.ДокументПоступления КАК ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
	|	ВЫБОР КОГДА Корректировка.Ссылка ЕСТЬ NULL
	|		ТОГДА ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|		ИНАЧЕ Т.АналитикаУчетаНоменклатурыДокументаПоступления
	|	КОНЕЦ КАК АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|	Т.НДС КАК НДС,
	|	Т.СтоимостьБезНДСУпр КАК СтоимостьБезНДСУпр,
	|	Т.НДСУпр КАК НДСУпр
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТТаблицаОтбораПартийНДС КАК ОтборПартийНДС
	|	ПО &УсловияСоединения
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПартииИзСебестоимости КАК ОтборПартийСебестоимости
	|	ПО Т.Партия = ОтборПартийСебестоимости.Партия
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК Корректировка
	|		ПО Т.ДокументПоступления = Корректировка.Ссылка
	|		И Корректировка.ВидКорректировки = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон)
	|		И НЕ &ОтражениеВРеглУчете
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В (&МассивОрганизаций)
	|	И НЕ Т.ТипЗаписи В (&ТипыЗаписейКонвертацииДанных)
	|	И ВЫБОР
	|		КОГДА &ОтражениеВРеглУчете ИЛИ &ОтражениеВУчетеНДС ТОГДА
	|			Т.НДС <> 0 ИЛИ Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
	|		ИНАЧЕ
	|			ИСТИНА
	|	КОНЕЦ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	ВЫБОР КОГДА Корректировка.Ссылка ЕСТЬ NULL
	|		ТОГДА ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|		ИНАЧЕ Т.АналитикаУчетаНоменклатурыДокументаПоступления
	|	КОНЕЦ КАК АналитикаУчетаНоменклатурыДокументаПоступления,
	|	Т.СтоимостьБезНДСРегл,
	|	Т.НДСРегл,
	|	Т.СтоимостьБезНДСУпр,
	|	Т.НДСУпр
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиТоваровПостатейныеЗатраты КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТТаблицаОтбораПартийНДС КАК ОтборПартийНДС
	|	ПО &УсловияСоединения
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПартииИзСебестоимости КАК ОтборПартийСебестоимости
	|	ПО Т.Партия = ОтборПартийСебестоимости.Партия
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК Корректировка
	|		ПО Т.ДокументПоступления = Корректировка.Ссылка
	|		И Корректировка.ВидКорректировки = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон)
	|		И НЕ &ОтражениеВРеглУчете
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В (&МассивОрганизаций)
	|	И НЕ Т.ТипЗаписи В (&ТипыЗаписейКонвертацииДанных)
	|	И ВЫБОР
	|		КОГДА &ОтражениеВРеглУчете ИЛИ &ОтражениеВУчетеНДС ТОГДА
	|			Т.НДСРегл <> 0 ИЛИ Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
	|		ИНАЧЕ
	|			ИСТИНА
	|	КОНЕЦ
	|) КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.Период,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.АналитикаУчетаНоменклатурыДокументаПоступления
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия,
	|	АналитикаУчетаПартий,
	|	Организация
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Партия
	|ПОМЕСТИТЬ ВТОтборПартии
	|ИЗ
	|	ВТЦеныПартийНДС КАК Т
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Партия
	|ИЗ
	|	ВТЦеныПартийНДСДетально КАК Т
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Регистратор КАК Регистратор,
	|   Т.Партия,
	|   Т.АналитикаУчетаНоменклатуры,
	|   Т.РазделУчета,
	|   Т.ВидЗапасов,
	|   Т.Организация,
	|   Т.АналитикаУчетаПартий,
	|   Т.АналитикаФинансовогоУчета,
	|   Т.ВидДеятельностиНДС
	|ПОМЕСТИТЬ ВТДвиженияПеремещения
	|ИЗ
	|(ВЫБРАТЬ
	|	Т.Регистратор КАК Регистратор,
	|   Т.Партия,
	|   Т.АналитикаУчетаНоменклатуры,
	|   Т.РазделУчета,
	|   Т.ВидЗапасов,
	|   Т.Организация,
	|   Т.АналитикаУчетаПартий,
	|   Т.АналитикаФинансовогоУчета,
	|   Т.ВидДеятельностиНДС,
	|	Т.Количество
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТТаблицаОтбораРегистраторов КАК ОтборРегистраторов
	|	ПО &УсловияДляРегистраторов
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборПартии КАК ОтборПартии
	|	ПО Т.Партия = ОтборПартии.Партия
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|	И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И Т.ТипЗаписи <> ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
	|	И Т.Количество <> 0
	|	И НЕ Т.РазделУчета В (&РазделыУчетаЗабалансовые)
	|	И НЕ Т.РасчетСебестоимости
	|	И Т.Активность
	|	И НЕ &ОтражениеВРеглУчете
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Регистратор КАК Регистратор,
	|   Т.КорПартия,
	|   Т.КорАналитикаУчетаНоменклатуры,
	|   Т.КорРазделУчета,
	|   Т.КорВидЗапасов,
	|   ВЫБОР КОГДА Т.КорОрганизация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|		ТОГДА Т.Организация
	|		ИНАЧЕ Т.КорОрганизация
	|	КОНЕЦ,
	|   Т.КорАналитикаУчетаПартий,
	|   Т.КорАналитикаФинансовогоУчета,
	|   Т.КорВидДеятельностиНДС,
	|	-Т.Количество
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТТаблицаОтбораРегистраторов КАК ОтборРегистраторов
	|	ПО &УсловияДляРегистраторов
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборПартии КАК ОтборПартии
	|	ПО Т.Партия = ОтборПартии.Партия
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|	И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И Т.Количество <> 0
	|	И НЕ Т.РасчетСебестоимости
	|	И Т.Партия = Т.КорПартия
	|	И Т.ВидДеятельностиНДС = Т.КорВидДеятельностиНДС
	|	И ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, НЕОПРЕДЕЛЕНО)
	|		= ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, НЕОПРЕДЕЛЕНО)
	|	И (Т.Организация = Т.КорОрганизация
	|		ИЛИ Т.КорОрганизация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка))
	|	И Т.Активность
	|	И НЕ &ОтражениеВРеглУчете
	|) КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|   Т.Партия,
	|   Т.АналитикаУчетаНоменклатуры,
	|   Т.РазделУчета,
	|   Т.ВидЗапасов,
	|   Т.Организация,
	|   Т.АналитикаУчетаПартий,
	|   Т.АналитикаФинансовогоУчета,
	|   Т.ВидДеятельностиНДС
	|ИМЕЮЩИЕ
	|	СУММА(Т.Количество) = 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.ВидДвижения,
	|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ) КАК Период,
	|	Т.Регистратор КАК Регистратор,
	|   Т.Партия КАК Партия,
	|   Т.АналитикаУчетаНоменклатуры,
	|   Т.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|   Т.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|   Т.АналитикаУчетаНоменклатуры.Назначение КАК Назначение,
	|   Т.РазделУчета,
	|   Т.ВидЗапасов,
	|   Т.Организация,
	|   Т.АналитикаУчетаПартий,
	|   Т.АналитикаФинансовогоУчета,
	|   Т.ВидДеятельностиНДС,
	|	СУММА(Т.Количество) КАК Количество
	|ПОМЕСТИТЬ ВТИтогКоличествоПредварительная
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТТаблицаОтбораРегистраторов КАК ОтборРегистраторов
	|	ПО &УсловияДляРегистраторов
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборПартии КАК ОтборПартии
	|	ПО Т.Партия = ОтборПартии.Партия
	|	И НЕ Т.РазделУчета В (&РазделыУчетаЗабалансовые)
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|	И НЕ Т.РасчетСебестоимости
	|	И Т.ТипЗаписи <> ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
	|	И Т.Активность
	|СГРУППИРОВАТЬ ПО
	|	Т.ВидДвижения,
	|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ),
	|	Т.Регистратор,
	|   Т.Партия,
	|   Т.АналитикаУчетаНоменклатуры,
	|   Т.РазделУчета,
	|   Т.ВидЗапасов,
	|   Т.Организация,
	|   Т.АналитикаУчетаПартий,
	|   Т.АналитикаФинансовогоУчета,
	|   Т.ВидДеятельностиНДС
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия,
	|	Номенклатура,
	|	Характеристика
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|   Т.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|   Т.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|   Т.АналитикаУчетаНоменклатуры.Назначение КАК Назначение
	|ПОМЕСТИТЬ ВТНоменклатураБезКоличества
	|ИЗ
	|	ВТИтогКоличествоПредварительная КАК Т
	|ГДЕ
	|	Т.Количество = 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|   Т.Партия КАК Партия
	|ПОМЕСТИТЬ ВТПартииБезКоличества
	|ИЗ
	|	ВТИтогКоличествоПредварительная КАК Т
	|ГДЕ
	|	Т.Количество = 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|   Т.Партия КАК Партия,
	|   Т.АналитикаУчетаПартий,
	|   ОтборНоменклатура.Номенклатура КАК Номенклатура,
	|   ОтборНоменклатура.Характеристика КАК Характеристика,
	|   ОтборНоменклатура.Назначение КАК Назначение,
	|   Т.ВидЗапасов,
	|   Т.Организация,
	|	СУММА(Т.Количество) КАК Количество
	|ПОМЕСТИТЬ ВТКоличествоПартий
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПартииБезКоличества КАК ОтборРегистраторов
	|		ПО Т.Регистратор = ОтборРегистраторов.Партия
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК ОтборАналитикаНоменклатуры
	|		ПО Т.АналитикаУчетаНоменклатуры = ОтборАналитикаНоменклатуры.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТНоменклатураБезКоличества КАК ОтборНоменклатура
	|		ПО ОтборАналитикаНоменклатуры.Номенклатура = ОтборНоменклатура.Номенклатура
	|		И ОтборАналитикаНоменклатуры.Характеристика = ОтборНоменклатура.Характеристика
	|		И ОтборАналитикаНоменклатуры.Назначение = ОтборНоменклатура.Назначение
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Партия = Т.Регистратор
	|	И Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
	|	И Т.Количество <> 0
	|	И Т.Активность
	|СГРУППИРОВАТЬ ПО
	|   Т.Партия,
	|   Т.АналитикаУчетаПартий,
	|   ОтборНоменклатура.Номенклатура,
	|   ОтборНоменклатура.Характеристика,
	|   ОтборНоменклатура.Назначение,
	|   Т.ВидЗапасов,
	|   Т.Организация
	|ИМЕЮЩИЕ
	|	СУММА(Т.Количество) <> 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия,
	|	Номенклатура,
	|	Характеристика
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Период КАК Период,
	|	Т.Партия КАК Партия,
	|   Т.АналитикаУчетаПартий,
	|   ОтборНоменклатура.Номенклатура КАК Номенклатура,
	|   ОтборНоменклатура.Характеристика КАК Характеристика,
	|   ОтборНоменклатура.Назначение КАК Назначение,
	|   Т.ВидЗапасов,
	|   Т.Организация,
	|	СУММА(Т.КоличествоНачальныйОстаток) КАК Количество
	|ПОМЕСТИТЬ ВТОстаткиПартий
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров.ОстаткиИОбороты(&НачалоПериода, &КонецПериода, Месяц, ,
	|		Партия В (ВЫБРАТЬ Отбор.Партия ИЗ ВТПартииБезКоличества КАК Отбор)) КАК Т	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК ОтборАналитикаНоменклатуры
	|		ПО Т.АналитикаУчетаНоменклатуры = ОтборАналитикаНоменклатуры.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТНоменклатураБезКоличества КАК ОтборНоменклатура
	|		ПО ОтборАналитикаНоменклатуры.Номенклатура = ОтборНоменклатура.Номенклатура
	|		И ОтборАналитикаНоменклатуры.Характеристика = ОтборНоменклатура.Характеристика
	|		И ОтборАналитикаНоменклатуры.Назначение = ОтборНоменклатура.Назначение
	|СГРУППИРОВАТЬ ПО
	|	Т.Период,
	|   Т.Партия,
	|   Т.АналитикаУчетаПартий,
	|   ОтборНоменклатура.Номенклатура,
	|   ОтборНоменклатура.Характеристика,
	|   ОтборНоменклатура.Назначение,
	|   Т.ВидЗапасов,
	|   Т.Организация
	|ИМЕЮЩИЕ
	|	СУММА(Т.КоличествоНачальныйОстаток) <> 0
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия,
	|	Номенклатура,
	|	Характеристика
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.ВидДвижения,
	|	Т.Регистратор КАК Регистратор,
	|   Т.Партия КАК Партия,
	|   Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|   Т.РазделУчета,
	|   Т.ВидЗапасов,
	|   Т.Организация КАК Организация,
	|   Т.АналитикаУчетаПартий,
	|   Т.АналитикаФинансовогоУчета,
	|   Т.ВидДеятельностиНДС,
	|	Т.Количество,
	|	СУММА(ЕСТЬNULL(ОстаткиПартий.Количество, ЕСТЬNULL(КоличествоПартий.Количество, 1))) КАК КоличествоПартии
	|ПОМЕСТИТЬ ВТИтогКоличество
	|ИЗ
	|	ВТИтогКоличествоПредварительная КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиПартий КАК ОстаткиПартий
	|		ПО Т.Партия = ОстаткиПартий.Партия
	|		И Т.АналитикаУчетаПартий = ОстаткиПартий.АналитикаУчетаПартий
	|		И Т.Номенклатура = ОстаткиПартий.Номенклатура
	|		И Т.Характеристика = ОстаткиПартий.Характеристика
	|		И Т.Назначение = ОстаткиПартий.Назначение
	|		И Т.ВидЗапасов = ОстаткиПартий.ВидЗапасов
	|		И Т.Организация = ОстаткиПартий.Организация
	|		И Т.Количество = 0
	|		И Т.Период = ОстаткиПартий.Период
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТКоличествоПартий КАК КоличествоПартий
	|		ПО Т.Партия = КоличествоПартий.Партия
	|		И Т.АналитикаУчетаПартий = КоличествоПартий.АналитикаУчетаПартий
	|		И Т.Номенклатура = КоличествоПартий.Номенклатура
	|		И Т.Характеристика = КоличествоПартий.Характеристика
	|		И Т.Назначение = КоличествоПартий.Назначение
	|		И Т.ВидЗапасов = КоличествоПартий.ВидЗапасов
	|		И Т.Организация = КоличествоПартий.Организация
	|		И Т.Количество = 0
	|СГРУППИРОВАТЬ ПО
	|	Т.ВидДвижения,
	|	Т.Регистратор,
	|   Т.Партия,
	|   Т.АналитикаУчетаНоменклатуры,
	|   Т.РазделУчета,
	|   Т.ВидЗапасов,
	|   Т.Организация,
	|   Т.АналитикаУчетаПартий,
	|   Т.АналитикаФинансовогоУчета,
	|   Т.ВидДеятельностиНДС,
	|	Т.Количество
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Период КАК Период,
	|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ) КАК МесяцДвижения,
	|	Т.Регистратор КАК Регистратор,
	|	ВЫБОР КОГДА РаспределениеЗатратСИдентификаторами.Регистратор ЕСТЬ NULL ТОГДА ЛОЖЬ ИНАЧЕ ИСТИНА КОНЕЦ КАК ЭтоРаспределениеЗатратСИдентификаторами,
	|	ВЫБОР КОГДА Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов)
	|		ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		ИНАЧЕ Т.ВидДвижения
	|	КОНЕЦ КАК ВидДвижения,
	|   Т.Партия КАК Партия,
	|   Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|   Т.РазделУчета,
	|   Т.ВидЗапасов,
	|   Т.Организация КАК Организация,
	|   Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|   Т.АналитикаФинансовогоУчета,
	|   Т.ВидДеятельностиНДС,
	|   Т.ХозяйственнаяОперация,
	|   Т.КорАналитикаУчетаНоменклатуры,
	|   Т.КорРазделУчета,
	|   Т.КорВидЗапасов,
	|   Т.Подразделение,
	|   Т.СтатьяРасходовСписания,
	|   Т.АналитикаРасходов,
	|   Т.СтатьяАктивовПассивов,
	|   Т.АналитикаАктивовПассивов,
	|   Т.ГруппаПродукции,
	|   Т.КорАналитикаФинансовогоУчета,
	|	ВЫБОР
	|		КОГДА НЕ ПередачаВидыЗапасов.Ссылка ЕСТЬ NULL И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		 И Передача.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|		КОГДА НЕ Передача.Ссылка ЕСТЬ NULL И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|			ТОГДА Передача.НалогообложениеНДС
	|		КОГДА НЕ Возврат.Ссылка ЕСТЬ NULL И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА Возврат.НалогообложениеНДС
	|		ИНАЧЕ Т.КорВидДеятельностиНДС
	|	КОНЕЦ КАК КорВидДеятельностиНДС,
	|	ВЫБОР
	|		КОГДА ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.РеализацияТоваровУслуг)
	|			ИЛИ ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.ВозвратТоваровПоставщику)
	|			ИЛИ ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.АктВыполненныхРабот)
	// В данных документах изменение направления деятельности не происходит
	|		ТОГДА Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности
	|		ИНАЧЕ ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, Т.КорНаправлениеДеятельности)
	|	КОНЕЦ КАК КорНаправлениеДеятельности,
	|	ВЫБОР
	// Доп. расходы без количества могут возникать при корректировке суммы приобретения, заявлении о ввозе и таможенной декларации,
	//	во всех случаях они определяются перечисленными типами записи, за исключением фактуровки поставки при включении НДС в стоимость в операциях приобретения.
	//	Такое же условие должно быть прописано при получении временной таблицы "ВТДопРасходыБезКоличества".
	|		КОГДА (Т.ТипЗаписи В (ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии))
	|		ИЛИ Т.ТипЗаписи В (ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией))
	|		И (Т.Регистратор ССЫЛКА Документ.ЗаявлениеОВвозеТоваров
	|		ИЛИ Т.Регистратор ССЫЛКА Документ.ТаможеннаяДекларацияИмпорт))
	|		И НЕ Т.Сторно
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЭтоДопРасходыБезКоличества,
	|	Т.ГруппаПродукции КАК КорГруппаПродукции,
	|	Т.ТипЗаписи,
	|	Т.ДокументИсточник,
	|	Т.ИдентификаторФинЗаписи,
	|	Т.Сторно,
	|
	|	ВЫБОР КОГДА Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов)
	|		ТОГДА -1
	|		ИНАЧЕ 1
	|	КОНЕЦ КАК ЗнакКоличество,
	|	Т.Количество КАК Количество,
	|	Т.ДопРасходы,
	|	Т.ДопРасходыБезНДС,
	|	Т.ДопРасходыРегл,
	|	Т.ДопРасходыУпр,
	|	Т.СтоимостьРегл,
	|	Т.СтоимостьУпр,
	|	Т.НДСРегл,
	|	Т.НДСУпр,
	|	ИтогКоличество.Количество КАК КоличествоИтог,
	|	ИтогКоличество.КоличествоПартии КАК КоличествоПартии
	|ПОМЕСТИТЬ ВТДвиженияСебестоимостиДляПартийНДСПредварительная
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТТаблицаОтбораРегистраторов КАК ОтборРегистраторов
	|		ПО &УсловияДляРегистраторов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборПартии КАК ОтборПартии
	|		ПО Т.Партия = ОтборПартии.Партия
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТДвиженияПеремещения КАК ИсключитьПриходы
	|		ПО (ИсключитьПриходы.Регистратор = Т.Регистратор)
	|			И (ИсключитьПриходы.АналитикаУчетаНоменклатуры = Т.АналитикаУчетаНоменклатуры)
	|			И (ИсключитьПриходы.Организация = Т.Организация)
	|			И (ИсключитьПриходы.Партия = Т.Партия)
	|			И (ИсключитьПриходы.РазделУчета = Т.РазделУчета)
	|			И (ИсключитьПриходы.ВидЗапасов = Т.ВидЗапасов)
	|			И (ИсключитьПриходы.АналитикаУчетаПартий = Т.АналитикаУчетаПартий)
	|			И (ИсключитьПриходы.ВидДеятельностиНДС = Т.ВидДеятельностиНДС)
	|			И (ИсключитьПриходы.АналитикаФинансовогоУчета = Т.АналитикаФинансовогоУчета)
	|			И (Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход))
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТДвиженияПеремещения КАК ИсключитьРасходы
	|		ПО (ИсключитьРасходы.Регистратор = Т.Регистратор)
	|			И (ИсключитьРасходы.АналитикаУчетаНоменклатуры = Т.КорАналитикаУчетаНоменклатуры)
	|			И (ИсключитьРасходы.Организация =
	|				ВЫБОР КОГДА Т.КорОрганизация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|					ТОГДА Т.Организация
	|					ИНАЧЕ Т.КорОрганизация
	|				КОНЕЦ)
	|			И (ИсключитьРасходы.Партия = Т.КорПартия)
	|			И (ИсключитьРасходы.РазделУчета = Т.КорРазделУчета)
	|			И (ИсключитьРасходы.ВидЗапасов = Т.КорВидЗапасов)
	|			И (ИсключитьРасходы.АналитикаУчетаПартий = Т.КорАналитикаУчетаПартий)
	|			И (ИсключитьРасходы.ВидДеятельностиНДС = Т.КорВидДеятельностиНДС)
	|			И (ИсключитьРасходы.АналитикаФинансовогоУчета = Т.КорАналитикаФинансовогоУчета)
	|			И (Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход))
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТИтогКоличество КАК ИтогКоличество
	|		ПО (ИтогКоличество.Регистратор = Т.Регистратор)
	|			И (ИтогКоличество.АналитикаУчетаНоменклатуры = Т.АналитикаУчетаНоменклатуры)
	|			И (ИтогКоличество.Организация = Т.Организация)
	|			И (ИтогКоличество.Партия = Т.Партия)
	|			И (ИтогКоличество.РазделУчета = Т.РазделУчета)
	|			И (ИтогКоличество.ВидЗапасов = Т.ВидЗапасов)
	|			И (ИтогКоличество.АналитикаУчетаПартий = Т.АналитикаУчетаПартий)
	|			И (ИтогКоличество.ВидДеятельностиНДС = Т.ВидДеятельностиНДС)
	|			И (ИтогКоличество.АналитикаФинансовогоУчета = Т.АналитикаФинансовогоУчета)
	|			И (ИтогКоличество.ВидДвижения = Т.ВидДвижения)
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями КАК Передача
	|		ПО Передача.Ссылка = Т.Регистратор
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТПередачиБезНДС КАК ПередачаВидыЗапасов
	|		ПО ПередачаВидыЗапасов.Ссылка = Т.Регистратор
	|			И ПередачаВидыЗапасов.Номенклатура = Т.АналитикаУчетаНоменклатуры.Номенклатура
	|			И ПередачаВидыЗапасов.Характеристика = Т.АналитикаУчетаНоменклатуры.Характеристика
	|			И ПередачаВидыЗапасов.Серия = Т.АналитикаУчетаНоменклатуры.Серия
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровМеждуОрганизациями КАК Возврат
	|		ПО Возврат.Ссылка = Т.Регистратор
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРаспределениеЗатратСИдентификаторами КАК РаспределениеЗатратСИдентификаторами
	|		ПО РаспределениеЗатратСИдентификаторами.Регистратор = Т.Регистратор
	|
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|	И НЕ Т.РасчетСебестоимости
	|	И ВЫБОР КОГДА &ОтражениеВРеглУчете ТОГДА
	|		((Т.Количество <> 0
	|			И (Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ИЛИ Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов)))
	|			ИЛИ (ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат)
	|				  И Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВключениеИсключениеНДСВСтоимости)))
	|		И Т.Партия <> НЕОПРЕДЕЛЕНО
	|	ИНАЧЕ
	|		Т.ТипЗаписи <> ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
	|		И НЕ (Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВключениеИсключениеНДСВСтоимости)
	|			И ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат))
	|		И НЕ Т.РазделУчета В (&РазделыУчетаЗабалансовые)
	|		И (Т.Количество <> 0
	|			ИЛИ Т.СтоимостьБезНДС <> 0
	|			ИЛИ Т.СтоимостьЗабалансовая <> 0
	|			ИЛИ Т.ДопРасходы <> 0
	|			ИЛИ Т.ДопРасходыБезНДС <> 0
	|			ИЛИ Т.СтоимостьРегл <> 0
	|			ИЛИ Т.СтоимостьЗабалансоваяРегл <> 0
	|			ИЛИ Т.ДопРасходыРегл <> 0
	|			ИЛИ Т.СтоимостьУпр <> 0
	|			ИЛИ Т.ДопРасходыУпр <> 0
	|			ИЛИ Т.НДСРегл <> 0
	|			ИЛИ Т.НДСУпр <> 0)
	|		И НЕ (Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			И ИсключитьПриходы.Регистратор ЕСТЬ НЕ NULL)
	|		И НЕ (Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|			И ИсключитьРасходы.Регистратор ЕСТЬ НЕ NULL)
	|		И ВЫБОР КОГДА &ОтражениеВУчетеНДС
	|			ТОГДА
	|				((Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				  ИЛИ Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов))
	|					ИЛИ (ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат)
	|						И Т.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.НДСНалоговогоАгента)))
	|				И НЕ Т.Сторно
	|				И (Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности)
	|					ИЛИ Т.Регистратор <> Т.Партия)
	|			ИНАЧЕ ИСТИНА
	|		  КОНЕЦ
	|	КОНЕЦ
	|	И Т.Активность
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.МесяцДвижения,
	|	Т.Регистратор,
	|	Т.ЭтоРаспределениеЗатратСИдентификаторами,
	|	Т.ВидДвижения,
	|   Т.Партия КАК Партия,
	|   Т.АналитикаУчетаНоменклатуры,
	|   Т.РазделУчета,
	|   Т.ВидЗапасов,
	|   Т.Организация КАК Организация,
	|   Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|   Т.АналитикаФинансовогоУчета,
	|   Т.ВидДеятельностиНДС,
	|   Т.ХозяйственнаяОперация,
	|   Т.КорАналитикаУчетаНоменклатуры,
	|   Т.КорРазделУчета,
	|   Т.КорВидЗапасов,
	|   Т.Подразделение,
	|   Т.СтатьяРасходовСписания,
	|   Т.АналитикаРасходов,
	|   Т.СтатьяАктивовПассивов,
	|   Т.АналитикаАктивовПассивов,
	|   Т.ГруппаПродукции,
	|   Т.КорАналитикаФинансовогоУчета,
	|	ВЫБОР КОГДА РаспределениеЗатратПоИдентификатору.Регистратор ЕСТЬ NULL
	|		ТОГДА Т.КорВидДеятельностиНДС
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|	КОНЕЦ КАК КорВидДеятельностиНДС,
	|	ВЫБОР КОГДА РаспределениеЗатратПоИдентификатору.Регистратор ЕСТЬ NULL
	|		ТОГДА Т.КорНаправлениеДеятельности
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК КорНаправлениеДеятельности,
	|   Т.КорГруппаПродукции,
	|   Т.ТипЗаписи,
	|   Т.ДокументИсточник,
	|   Т.ИдентификаторФинЗаписи,
	|   Т.Сторно,
	|	ВЫБОР КОГДА Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|	  И Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ВозможноСписаниеНДС,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	ВЫБОР
	|		КОГДА РаспределениеЗатратПоИдентификатору.Регистратор ЕСТЬ NULL
	|		ТОГДА ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	Т.ЭтоДопРасходыБезКоличества КАК ЭтоДопРасходыБезКоличества,
	|
	|	Т.ЗнакКоличество,
	|	СУММА(Т.Количество) КАК Количество,
	|	СУММА(Т.ДопРасходы) КАК ДопРасходы,
	|	СУММА(Т.ДопРасходыБезНДС) КАК ДопРасходыБезНДС,
	|	СУММА(Т.ДопРасходыРегл) КАК ДопРасходыРегл,
	|	СУММА(Т.ДопРасходыУпр) КАК ДопРасходыУпр,
	|	СУММА(Т.СтоимостьРегл) КАК СтоимостьРегл,
	|	СУММА(Т.СтоимостьУпр) КАК СтоимостьУпр,
	|	СУММА(Т.НДСРегл) КАК НДСРегл,
	|	СУММА(Т.НДСУпр) КАК НДСУпр,
	|	МАКСИМУМ(Т.КоличествоИтог) КАК КоличествоИтог,
	|	МАКСИМУМ(Т.КоличествоПартии) КАК КоличествоПартии
	|ПОМЕСТИТЬ ВТДвиженияСебестоимостиДляПартийНДС
	|ИЗ
	|	ВТДвиженияСебестоимостиДляПартийНДСПредварительная КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРаспределениеЗатрат КАК РаспределениеЗатратПоИдентификатору
	|		ПО РаспределениеЗатратПоИдентификатору.Регистратор = Т.Регистратор
	|		И РаспределениеЗатратПоИдентификатору.ИдентификаторФинЗаписи <> """"
	|		И РаспределениеЗатратПоИдентификатору.ИдентификаторФинЗаписи = Т.ИдентификаторФинЗаписи
	|ГДЕ
	|	ВЫБОР
	|	КОГДА &ОтражениеВРеглУчете ТОГДА
	|		ВЫБОР
	|		КОГДА ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат)
	|			ТОГДА Т.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|					ИЛИ Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|					ИЛИ Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДСВСтранеЕАЭС)
	|					ИЛИ Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров)
	|			ИНАЧЕ Т.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|				И (Т.ВидДеятельностиНДС <> Т.КорВидДеятельностиНДС
	|					ИЛИ Т.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|					ИЛИ Т.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДСВСтранеЕАЭС)
	|					ИЛИ Т.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров)
	|					ИЛИ Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров))
	|		КОНЕЦ
	|	КОГДА &ОтражениеВУчетеНДС ТОГДА
	|		ВЫБОР
	|		КОГДА ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат)
	|			ТОГДА Т.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|		ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|	ИНАЧЕ
	|		ИСТИНА
	|	КОНЕЦ
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Период,
	|	Т.МесяцДвижения,
	|	Т.Регистратор,
	|	Т.ЭтоРаспределениеЗатратСИдентификаторами,
	|	Т.ВидДвижения,
	|   Т.Партия,
	|   Т.АналитикаУчетаНоменклатуры,
	|   Т.РазделУчета,
	|   Т.ВидЗапасов,
	|   Т.Организация,
	|   Т.АналитикаУчетаПартий,
	|   Т.АналитикаФинансовогоУчета,
	|   Т.ВидДеятельностиНДС,
	|   Т.ХозяйственнаяОперация,
	|   Т.КорАналитикаУчетаНоменклатуры,
	|   Т.КорРазделУчета,
	|   Т.КорВидЗапасов,
	|   Т.Подразделение,
	|   Т.СтатьяРасходовСписания,
	|   Т.АналитикаРасходов,
	|   Т.СтатьяАктивовПассивов,
	|   Т.АналитикаАктивовПассивов,
	|   Т.ГруппаПродукции,
	|   Т.КорАналитикаФинансовогоУчета,
	|	ВЫБОР КОГДА РаспределениеЗатратПоИдентификатору.Регистратор ЕСТЬ NULL
	|		ТОГДА Т.КорВидДеятельностиНДС
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|	КОНЕЦ,
	|	ВЫБОР КОГДА РаспределениеЗатратПоИдентификатору.Регистратор ЕСТЬ NULL
	|		ТОГДА Т.КорНаправлениеДеятельности
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ,
	|   Т.КорГруппаПродукции,
	|   Т.ТипЗаписи,
	|   Т.ДокументИсточник,
	|   Т.ИдентификаторФинЗаписи,
	|   Т.Сторно,
	|	ВЫБОР КОГДА Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|	  И Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика,
	|	ВЫБОР
	|		КОГДА РаспределениеЗатратПоИдентификатору.Регистратор ЕСТЬ NULL
	|		ТОГДА ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ,
	|	Т.ЭтоДопРасходыБезКоличества,
	|	Т.ЗнакКоличество
	|	
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия,
	|	АналитикаУчетаПартий,
	|	Организация
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	1 КАК КодИсточника,
	|	ЛОЖЬ КАК ЭтоНЗП,
	|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ) КАК Месяц,
	|	Т.Период КАК Период,
	|	Т.ВидДвижения,
	|	Т.Регистратор КАК Регистратор,
	|   Т.Партия,
	|   Т.АналитикаУчетаНоменклатуры,
	|   Т.РазделУчета,
	|   Т.ВидЗапасов,
	|   Т.Организация КАК Организация,
	|   Т.АналитикаФинансовогоУчета,
	|   Т.ВидДеятельностиНДС,
	|   Т.ХозяйственнаяОперация,
	|   Т.КорАналитикаУчетаНоменклатуры,
	|   Т.КорРазделУчета,
	|   Т.КорВидЗапасов,
	|   Т.Подразделение,
	|   НЕОПРЕДЕЛЕНО КАК КорПодразделение,
	|   Т.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|   Т.АналитикаРасходов КАК АналитикаРасходов,
	|   Т.СтатьяАктивовПассивов,
	|   Т.АналитикаАктивовПассивов,
	|   Т.ГруппаПродукции,
	|   Т.КорАналитикаФинансовогоУчета,
	|   ЕСТЬNULL(РаспределениеЗатратПоИдентификатору.ВидДеятельностиНДС, Т.КорВидДеятельностиНДС) КАК КорВидДеятельностиНДС,
	|   Т.ТипЗаписи,
	|   Т.ДокументИсточник,
	|   Т.Сторно,
	|	Т.ВозможноСписаниеНДС,
	|
	|	ВЫБОР
	|		КОГДА НЕ РаспределениеЗатратПоИдентификатору.Регистратор ЕСТЬ NULL
	|			ТОГДА РаспределениеЗатратПоИдентификатору.КорНаправлениеДеятельности
	|		КОГДА НЕ РаспределениеЗатрат.Регистратор ЕСТЬ NULL
	|			ТОГДА РаспределениеЗатрат.КорНаправлениеДеятельности
	|			ИНАЧЕ Т.НаправлениеДеятельности
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА НЕ РаспределениеЗатратПоИдентификатору.Регистратор ЕСТЬ NULL
	|			ТОГДА РаспределениеЗатратПоИдентификатору.НаправлениеДеятельности
	|		КОГДА НЕ РаспределениеЗатрат.Регистратор ЕСТЬ NULL
	|			ТОГДА РаспределениеЗатрат.НаправлениеДеятельности
	|			ИНАЧЕ Т.КорНаправлениеДеятельности
	|	КОНЕЦ КАК КорНаправлениеДеятельности,
	|   Т.КорГруппаПродукции,
	|
	|	ВЫБОР
	|		КОГДА НЕ РаспределениеЗатратПоИдентификатору.ДокументПоступленияРасходов ЕСТЬ NULL
	|			ТОГДА РаспределениеЗатратПоИдентификатору.ДокументПоступленияРасходов
	|		КОГДА Т.ЭтоДопРасходыБезКоличества
	|			ТОГДА ДопРасходыБезКоличества.ДокументПоступления
	|		ИНАЧЕ Цены.ДокументПоступления
	|	КОНЕЦ КАК ДокументПоступления,
	|	ВЫБОР
	|		КОГДА НЕ РаспределениеЗатратПоИдентификатору.АналитикаУчетаПартий ЕСТЬ NULL
	|			ТОГДА РаспределениеЗатратПоИдентификатору.АналитикаУчетаПартий
	|		КОГДА Т.ЭтоДопРасходыБезКоличества
	|			ТОГДА ДопРасходыБезКоличества.АналитикаУчетаПартийДокументаПоступления
	|		ИНАЧЕ Цены.АналитикаУчетаПартийДокументаПоступления
	|	КОНЕЦ КАК АналитикаУчетаПартийДокументаПоступления,
	|	Цены.АналитикаУчетаНоменклатурыДокументаПоступления КАК АналитикаУчетаНоменклатурыДокументаПоступления,
	|
	|	Т.ЗнакКоличество * Т.Количество 	КАК Количество,
	|	ВЫБОР
	|		КОГДА Т.Количество <> 0
	|			ТОГДА Т.Количество
	|		КОГДА НЕ РаспределениеЗатратПоИдентификатору.Регистратор ЕСТЬ NULL
	|			ТОГДА 1
	|		КОГДА НЕ РаспределениеЗатрат.Регистратор ЕСТЬ NULL
	|			ТОГДА ВЫБОР
	|				КОГДА Т.ДопРасходы <> 0 И (Цены.СтоимостьБезНДСУпр + Цены.НДСУпр) <> 0
	|					ТОГДА Т.ДопРасходы / (Цены.СтоимостьБезНДСУпр + Цены.НДСУпр)
	|				КОГДА Т.ДопРасходыРегл <> 0 И (Цены.СтоимостьБезНДС + ВЫБОР КОГДА РаспределениеЗатрат.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости) ТОГДА Цены.НДС ИНАЧЕ 0 КОНЕЦ) <> 0
	|					ТОГДА Т.ДопРасходыРегл / (Цены.СтоимостьБезНДС + ВЫБОР КОГДА РаспределениеЗатрат.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости) ТОГДА Цены.НДС ИНАЧЕ 0 КОНЕЦ)
	|				КОГДА Т.ДопРасходыУпр <> 0 И (Цены.СтоимостьБезНДСУпр + ВЫБОР КОГДА РаспределениеЗатрат.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости) ТОГДА Цены.НДСУпр ИНАЧЕ 0 КОНЕЦ) <> 0
	|					ТОГДА Т.ДопРасходыУпр / (Цены.СтоимостьБезНДСУпр + ВЫБОР КОГДА РаспределениеЗатрат.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости) ТОГДА Цены.НДСУпр ИНАЧЕ 0 КОНЕЦ)
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		КОГДА Т.ЭтоДопРасходыБезКоличества
	|			ТОГДА 1
	|		КОГДА Т.Партия = Цены.ДокументПоступления
	|		  И Т.АналитикаУчетаПартий = Цены.АналитикаУчетаПартийДокументаПоступления
	|		  И Т.КоличествоИтог ЕСТЬ НЕ NULL
	|			ТОГДА 0
	|			ИНАЧЕ ЕСТЬNULL(Т.КоличествоПартии, 1)
	|	КОНЕЦ * Т.ЗнакКоличество 			КАК Коэффициент,
	|	ВЫРАЗИТЬ(ВЫБОР КОГДА НЕ РаспределениеЗатратПоИдентификатору.Регистратор ЕСТЬ NULL
	|			ТОГДА ВЫРАЗИТЬ(РаспределениеЗатратПоИдентификатору.СтоимостьРегл КАК ЧИСЛО (31,10))
	|	    КОГДА Т.ЭтоДопРасходыБезКоличества И ДопРасходыБезКоличества.ЭтоКорректировка
	|			ТОГДА ВЫБОР КОГДА Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|					ТОГДА Т.ДопРасходыРегл
	|					ИНАЧЕ Т.ДопРасходыРегл - Т.НДСРегл
	|				  КОНЕЦ
	|	    КОГДА Т.ЭтоДопРасходыБезКоличества
	|			ТОГДА Т.СтоимостьРегл
	|			ИНАЧЕ ВЫРАЗИТЬ(ЕСТЬNULL(ВЫРАЗИТЬ(Цены.СтоимостьБезНДС КАК ЧИСЛО (31,10)), ВЫРАЗИТЬ(0 КАК ЧИСЛО (31,10))) КАК ЧИСЛО (31,10))
	|	КОНЕЦ КАК ЧИСЛО (31,10)) КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(ВЫБОР КОГДА НЕ РаспределениеЗатратПоИдентификатору.Регистратор ЕСТЬ NULL
	|			ТОГДА ВЫРАЗИТЬ(РаспределениеЗатратПоИдентификатору.НДСРегл КАК ЧИСЛО (31,10))
	|	    КОГДА Т.ЭтоДопРасходыБезКоличества
	|			ТОГДА Т.НДСРегл
	|			ИНАЧЕ ВЫРАЗИТЬ(ЕСТЬNULL(ВЫРАЗИТЬ(Цены.НДС КАК ЧИСЛО (31,10)), ВЫРАЗИТЬ(0 КАК ЧИСЛО (31,10))) КАК ЧИСЛО (31,10))
	|	КОНЕЦ КАК ЧИСЛО (31,10)) КАК НДС,
	|	ВЫРАЗИТЬ(ВЫБОР КОГДА НЕ РаспределениеЗатратПоИдентификатору.Регистратор ЕСТЬ NULL
	|			ТОГДА ВЫРАЗИТЬ(РаспределениеЗатратПоИдентификатору.СтоимостьБезНДС КАК ЧИСЛО (31,10))
	|	    КОГДА Т.ЭтоДопРасходыБезКоличества И ДопРасходыБезКоличества.ЭтоКорректировка
	|			ТОГДА ВЫБОР КОГДА Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|					ТОГДА Т.ДопРасходыУпр
	|					ИНАЧЕ Т.ДопРасходыУпр - Т.НДСУпр
	|				  КОНЕЦ
	|	    КОГДА Т.ЭтоДопРасходыБезКоличества
	|			ТОГДА Т.СтоимостьУпр
	|			ИНАЧЕ ВЫРАЗИТЬ(ЕСТЬNULL(ВЫРАЗИТЬ(Цены.СтоимостьБезНДСУпр КАК ЧИСЛО (31,10)), ВЫРАЗИТЬ(0 КАК ЧИСЛО (31,10))) КАК ЧИСЛО (31,10))
	|	КОНЕЦ КАК ЧИСЛО (31,10)) КАК СтоимостьБезНДСУпр,
	|	ВЫРАЗИТЬ(ВЫБОР КОГДА НЕ РаспределениеЗатратПоИдентификатору.Регистратор ЕСТЬ NULL
	|			ТОГДА ВЫРАЗИТЬ(РаспределениеЗатратПоИдентификатору.НДСУпр КАК ЧИСЛО (31,10))
	|	    КОГДА Т.ЭтоДопРасходыБезКоличества
	|			ТОГДА Т.НДСУпр
	|			ИНАЧЕ ВЫРАЗИТЬ(ЕСТЬNULL(ВЫРАЗИТЬ(Цены.НДСУпр КАК ЧИСЛО (31,10)), ВЫРАЗИТЬ(0 КАК ЧИСЛО (31,10))) КАК ЧИСЛО (31,10))
	|	КОНЕЦ КАК ЧИСЛО (31,10)) КАК НДСУпр
	|ПОМЕСТИТЬ ВТСтоимостьПартийНДСПредварительная
	|ИЗ
	|	ВТДвиженияСебестоимостиДляПартийНДС КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТЦеныПартийНДС КАК Цены
	|		ПО (Цены.Партия = Т.Партия)
	|			И (Цены.Организация = Т.Организация)
	|			И (Цены.АналитикаУчетаПартий = Т.АналитикаУчетаПартий)
	|			И (Цены.ВидЗапасов = Т.ВидЗапасов)
	|			И (Цены.Номенклатура = Т.Номенклатура)
	|			И (Цены.Характеристика = Т.Характеристика)
	|			И НЕ Т.ЭтоРаспределениеЗатратСИдентификаторами 
	|			И НЕ Т.ЭтоДопРасходыБезКоличества
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТДопРасходыБезКоличества КАК ДопРасходыБезКоличества
	|		ПО (ДопРасходыБезКоличества.Регистратор = Т.Регистратор)
	|			И (ДопРасходыБезКоличества.Партия = Т.Партия)
	|			И (ДопРасходыБезКоличества.Организация = Т.Организация)
	|			И (ДопРасходыБезКоличества.АналитикаУчетаНоменклатуры = Т.АналитикаУчетаНоменклатуры)
	|			И (ДопРасходыБезКоличества.РазделУчета = Т.РазделУчета)
	|			И (ДопРасходыБезКоличества.ВидЗапасов = Т.ВидЗапасов)
	|			И (ДопРасходыБезКоличества.АналитикаУчетаПартий = Т.АналитикаУчетаПартий)
	|			И (ДопРасходыБезКоличества.ВидДеятельностиНДС = Т.ВидДеятельностиНДС)
	|			И (ДопРасходыБезКоличества.АналитикаФинансовогоУчета = Т.АналитикаФинансовогоУчета)
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРаспределениеЗатрат КАК РаспределениеЗатратПоИдентификатору
	|		ПО РаспределениеЗатратПоИдентификатору.Регистратор = Т.Регистратор
	|		И РаспределениеЗатратПоИдентификатору.ИдентификаторФинЗаписи <> """"
	|		И РаспределениеЗатратПоИдентификатору.ИдентификаторФинЗаписи = Т.ИдентификаторФинЗаписи
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРаспределениеЗатрат КАК РаспределениеЗатрат
	|		ПО РаспределениеЗатрат.Регистратор = Т.Регистратор
	|		И РаспределениеЗатрат.ИдентификаторФинЗаписи = """"
	|		И РаспределениеЗатрат.ДокументПоступленияРасходов = Цены.ДокументПоступления
	|		И РаспределениеЗатрат.АналитикаУчетаПартий = Цены.АналитикаУчетаПартийДокументаПоступления
	|ГДЕ
	|   НЕ (Т.Регистратор = Т.Партия
	|		И Т.Регистратор <> Цены.ДокументПоступления
	|		И НЕ ТИПЗНАЧЕНИЯ(Т.Регистратор) В (
	|			ТИП(Документ.РеализацияТоваровУслуг),
	|			ТИП(Документ.СборкаТоваров),

	|			ТИП(Документ.ПередачаТоваровМеждуОрганизациями),
	|			ТИП(Документ.ВозвратТоваровМеждуОрганизациями),
	|			ТИП(Документ.ОтчетПоКомиссииМеждуОрганизациямиОСписании)))
	|	И (НЕ (Т.Количество = 0
	|		  	И Т.Партия = Цены.ДокументПоступления
	|			И Т.АналитикаУчетаПартий = Цены.АналитикаУчетаПартийДокументаПоступления
	|			И Т.КоличествоИтог ЕСТЬ НЕ NULL)
	|		ИЛИ Т.ЭтоДопРасходыБезКоличества
	|		ИЛИ НЕ РаспределениеЗатратПоИдентификатору.Регистратор ЕСТЬ NULL)
	|	И (ТИПЗНАЧЕНИЯ(Т.Регистратор) <> ТИП(Документ.РаспределениеПрочихЗатрат)
	|		ИЛИ НЕ РаспределениеЗатратПоИдентификатору.Регистратор ЕСТЬ NULL
	|		ИЛИ НЕ РаспределениеЗатрат.Регистратор ЕСТЬ NULL)
	|	И (Цены.Организация ЕСТЬ NULL ИЛИ Цены.Период <= Т.Период ИЛИ Т.ЭтоДопРасходыБезКоличества)
	|	И ВЫБОР
	|	КОГДА &ОтражениеВРеглУчете ТОГДА
	|		ВЫБОР
	|		КОГДА ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат)
	|			ТОГДА ЕСТЬNULL(РаспределениеЗатратПоИдентификатору.ВидДеятельностиНДС, Т.КорВидДеятельностиНДС) <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|				И (Т.ВидДеятельностиНДС <> ЕСТЬNULL(РаспределениеЗатратПоИдентификатору.ВидДеятельностиНДС, Т.КорВидДеятельностиНДС)
	|					ИЛИ ЕСТЬNULL(РаспределениеЗатратПоИдентификатору.ВидДеятельностиНДС, Т.КорВидДеятельностиНДС) = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|					ИЛИ ЕСТЬNULL(РаспределениеЗатратПоИдентификатору.ВидДеятельностиНДС, Т.КорВидДеятельностиНДС) = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДСВСтранеЕАЭС)
	|					ИЛИ ЕСТЬNULL(РаспределениеЗатратПоИдентификатору.ВидДеятельностиНДС, Т.КорВидДеятельностиНДС) = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров)
	|					ИЛИ Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров))
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|	КОГДА &ОтражениеВУчетеНДС ТОГДА
	|		ВЫБОР
	|		КОГДА ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат)
	|			ТОГДА ЕСТЬNULL(РаспределениеЗатратПоИдентификатору.ВидДеятельностиНДС, Т.КорВидДеятельностиНДС) <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|		ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|	ИНАЧЕ
	|		ИСТИНА
	|	КОНЕЦ
	|	И ВЫБОР
	|		КОГДА (&ОтражениеВРеглУчете ИЛИ &ОтражениеВУчетеНДС) И Т.Количество <> 0 ТОГДА
	|		    ВЫБОР КОГДА Т.ЭтоДопРасходыБезКоличества
	|				ТОГДА Т.НДСРегл
	|				ИНАЧЕ ВЫРАЗИТЬ(Т.Количество * ВЫРАЗИТЬ(ЕСТЬNULL(Цены.НДС, 0) КАК ЧИСЛО (31,10)) КАК ЧИСЛО(31, 2))
	|			КОНЕЦ <> 0
	|		ИНАЧЕ
	|			ИСТИНА
	|	КОНЕЦ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	2 КАК КодИсточника,
	|	ЛОЖЬ КАК ЭтоНЗП,
	|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ) КАК Месяц,
	|	Т.Период КАК Период,
	|	Т.ВидДвижения,
	|	Т.Регистратор КАК Регистратор,
	|   Т.Партия,
	|   Т.АналитикаУчетаНоменклатуры,
	|   Т.РазделУчета,
	|   Т.ВидЗапасов,
	|   Т.Организация КАК Организация,
	|   Т.АналитикаФинансовогоУчета,
	|   Т.ВидДеятельностиНДС,
	|   Т.ХозяйственнаяОперация,
	|   Т.КорАналитикаУчетаНоменклатуры,
	|   Т.КорРазделУчета,
	|   Т.КорВидЗапасов,
	|   Т.Подразделение,
	|   НЕОПРЕДЕЛЕНО КАК КорПодразделение,
	|   Т.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|   Т.АналитикаРасходов КАК АналитикаРасходов,
	|   Т.СтатьяАктивовПассивов,
	|   Т.АналитикаАктивовПассивов,
	|   Т.ГруппаПродукции,
	|   Т.КорАналитикаФинансовогоУчета,
	|   Т.КорВидДеятельностиНДС КАК КорВидДеятельностиНДС,
	|   Т.ТипЗаписи,
	|   Т.ДокументИсточник,
	|   Т.Сторно,
	|	Т.ВозможноСписаниеНДС,
	|
	|	ВЫБОР
	|		КОГДА НЕ РаспределениеЗатрат.Регистратор ЕСТЬ NULL
	|		ТОГДА РаспределениеЗатрат.КорНаправлениеДеятельности
	|		ИНАЧЕ Т.НаправлениеДеятельности
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА НЕ РаспределениеЗатрат.Регистратор ЕСТЬ NULL
	|		ТОГДА РаспределениеЗатрат.НаправлениеДеятельности
	|		ИНАЧЕ Т.КорНаправлениеДеятельности
	|	КОНЕЦ КАК КорНаправлениеДеятельности,
	|   Т.КорГруппаПродукции,
	|
	|	Цены.ДокументПоступления КАК ДокументПоступления,
	|	Цены.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
	|	Цены.АналитикаУчетаНоменклатурыДокументаПоступления КАК АналитикаУчетаНоменклатурыДокументаПоступления,
	|
	|	Т.ЗнакКоличество * Т.Количество 	КАК Количество,
	|	ВЫБОР
	|		КОГДА Т.Количество <> 0
	|			ТОГДА Т.Количество
	|		КОГДА НЕ РаспределениеЗатрат.Регистратор ЕСТЬ NULL
	|			ТОГДА ВЫБОР
	|				КОГДА Т.ДопРасходы <> 0 И (Цены.СтоимостьБезНДСУпр + Цены.НДСУпр) <> 0
	|					ТОГДА Т.ДопРасходы / (Цены.СтоимостьБезНДСУпр + Цены.НДСУпр)
	|				КОГДА Т.ДопРасходыРегл <> 0 И (Цены.СтоимостьБезНДС + ВЫБОР КОГДА РаспределениеЗатрат.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости) ТОГДА Цены.НДС ИНАЧЕ 0 КОНЕЦ) <> 0
	|					ТОГДА Т.ДопРасходыРегл / (Цены.СтоимостьБезНДС + ВЫБОР КОГДА РаспределениеЗатрат.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости) ТОГДА Цены.НДС ИНАЧЕ 0 КОНЕЦ)
	|				КОГДА Т.ДопРасходыУпр <> 0 И (Цены.СтоимостьБезНДСУпр + ВЫБОР КОГДА РаспределениеЗатрат.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости) ТОГДА Цены.НДСУпр ИНАЧЕ 0 КОНЕЦ) <> 0
	|					ТОГДА Т.ДопРасходыУпр / (Цены.СтоимостьБезНДСУпр + ВЫБОР КОГДА РаспределениеЗатрат.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости) ТОГДА Цены.НДСУпр ИНАЧЕ 0 КОНЕЦ)
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		КОГДА Т.Партия = Цены.ДокументПоступления
	|		  И Т.АналитикаУчетаПартий = Цены.АналитикаУчетаПартийДокументаПоступления
	|		  И Т.КоличествоИтог ЕСТЬ НЕ NULL
	|			ТОГДА 0
	|			ИНАЧЕ ЕСТЬNULL(Т.КоличествоПартии, 1)
	|	КОНЕЦ * Т.ЗнакКоличество КАК Коэффициент,
	|	ВЫРАЗИТЬ(ЕСТЬNULL(ВЫРАЗИТЬ(Цены.СтоимостьБезНДС КАК ЧИСЛО (31,10)), ВЫРАЗИТЬ(0 КАК ЧИСЛО (31,10))) КАК ЧИСЛО (31,10)) КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(ЕСТЬNULL(ВЫРАЗИТЬ(Цены.НДС КАК ЧИСЛО (31,10)), ВЫРАЗИТЬ(0 КАК ЧИСЛО (31,10))) КАК ЧИСЛО (31,10)) КАК НДС,
	|	ВЫРАЗИТЬ(ЕСТЬNULL(ВЫРАЗИТЬ(Цены.СтоимостьБезНДСУпр КАК ЧИСЛО (31,10)), ВЫРАЗИТЬ(0 КАК ЧИСЛО (31,10))) КАК ЧИСЛО (31,10)) КАК СтоимостьБезНДСУпр,
	|	ВЫРАЗИТЬ(ЕСТЬNULL(ВЫРАЗИТЬ(Цены.НДСУпр КАК ЧИСЛО (31,10)), ВЫРАЗИТЬ(0 КАК ЧИСЛО (31,10))) КАК ЧИСЛО (31,10)) КАК НДСУпр
	|ИЗ
	|	ВТДвиженияСебестоимостиДляПартийНДС КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТЦеныПартийНДСДетально КАК Цены
	|		ПО (Цены.Партия = Т.Партия)
	|			И (Цены.Организация = Т.Организация)
	|			И (Цены.АналитикаУчетаНоменклатуры = Т.АналитикаУчетаНоменклатуры)
	|			И (Цены.РазделУчета = Т.РазделУчета)
	|			И (Цены.ВидЗапасов = Т.ВидЗапасов)
	|			И (Цены.АналитикаУчетаПартий = Т.АналитикаУчетаПартий)
	|			И (Цены.ВидДеятельностиНДС = Т.ВидДеятельностиНДС)
	|			И (Цены.АналитикаФинансовогоУчета = Т.АналитикаФинансовогоУчета)
	|			И (Цены.Период = Т.МесяцДвижения)
	|			И НЕ Т.ЭтоРаспределениеЗатратСИдентификаторами 
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРаспределениеЗатрат КАК РаспределениеЗатрат
	|		ПО РаспределениеЗатрат.Регистратор = Т.Регистратор
	|		И РаспределениеЗатрат.ИдентификаторФинЗаписи = """"
	|		И РаспределениеЗатрат.ДокументПоступленияРасходов = Цены.ДокументПоступления
	|		И РаспределениеЗатрат.АналитикаУчетаПартий = Цены.АналитикаУчетаПартийДокументаПоступления
	|ГДЕ
	|   НЕ (Т.Регистратор = Т.Партия
	|		И Т.Регистратор <> Цены.ДокументПоступления
	|		И НЕ ТИПЗНАЧЕНИЯ(Т.Регистратор) В (
	|			ТИП(Документ.РеализацияТоваровУслуг),
	|			ТИП(Документ.СборкаТоваров),

	|			ТИП(Документ.ПередачаТоваровМеждуОрганизациями),
	|			ТИП(Документ.ВозвратТоваровМеждуОрганизациями),
	|			ТИП(Документ.ОтчетПоКомиссииМеждуОрганизациямиОСписании)))
	|	И (НЕ (Т.Количество = 0
	|		  	И Т.Партия = Цены.ДокументПоступления
	|			И Т.АналитикаУчетаПартий = Цены.АналитикаУчетаПартийДокументаПоступления
	|			И Т.КоличествоИтог ЕСТЬ НЕ NULL))
	|	И ((ТИПЗНАЧЕНИЯ(Т.Регистратор) <> ТИП(Документ.РаспределениеПрочихЗатрат)
	|		И НЕ Цены.Организация ЕСТЬ NULL)
	|			ИЛИ НЕ РаспределениеЗатрат.Регистратор ЕСТЬ NULL)
	|	И НЕ Т.ЭтоРаспределениеЗатратСИдентификаторами
	|	И НЕ Т.ЭтоДопРасходыБезКоличества
	|	И (НЕ ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.ТаможеннаяДекларацияИмпорт)
	|		ИЛИ Т.Регистратор = Цены.ДокументПоступления)
	|	И ВЫБОР
	|	КОГДА &ОтражениеВРеглУчете ТОГДА
	|		ВЫБОР
	|		КОГДА ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат)
	|			ТОГДА Т.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|				И (Т.ВидДеятельностиНДС <> Т.КорВидДеятельностиНДС
	|					ИЛИ Т.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|					ИЛИ Т.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДСВСтранеЕАЭС)
	|					ИЛИ Т.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров)
	|					ИЛИ Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров))
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|	КОГДА &ОтражениеВУчетеНДС ТОГДА
	|		ВЫБОР
	|		КОГДА ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат)
	|			ТОГДА Т.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|		ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|	ИНАЧЕ
	|		ИСТИНА
	|	КОНЕЦ
	|	И ВЫБОР
	|		КОГДА (&ОтражениеВРеглУчете ИЛИ &ОтражениеВУчетеНДС) И Т.Количество <> 0 ТОГДА
	|			ВЫРАЗИТЬ(Т.Количество * ВЫРАЗИТЬ(ЕСТЬNULL(Цены.НДС, 0) КАК ЧИСЛО (31,10)) КАК ЧИСЛО(31, 2)) <> 0
	|		ИНАЧЕ
	|			ИСТИНА
	|	КОНЕЦ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	3 КАК КодИсточника,
	|	ИСТИНА КАК ЭтоНЗП,
	|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ) КАК Месяц,
	|	Т.Период КАК Период,
	|	ВЫБОР КОГДА ПриходЗатрат
	|		ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	КОНЕЦ КАК ВидДвижения,
	|	Т.ДокументДвижения КАК Регистратор,
	|   Т.Партия,
	|   Т.АналитикаУчетаНоменклатуры,
	|   ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
	|   Т.ВидЗапасов,
	|   Т.Организация КАК Организация,
	|   НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
	|   Т.ВидДеятельностиНДС,
	|   НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
	|   Т.КорАналитикаУчетаНоменклатуры,
	|   ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК КорРазделУчета,
	|   Т.КорВидЗапасов,
	|   Т.Подразделение,
	|   Т.КорПодразделение,
	|   Т.СтатьяРасходов КАК СтатьяРасходовСписания,
	|   Т.АналитикаРасходов КАК АналитикаРасходов,
	|   ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка) КАК СтатьяАктивовПассивов,
	|   НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
	|   ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КАК ГруппаПродукции,
	|   НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
	|	Т.КорВидДеятельностиНДС КАК КорВидДеятельностиНДС,
	|   ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка) КАК ТипЗаписи,
	|   НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
	|   ЛОЖЬ КАК Сторно,
	|	ЛОЖЬ КАК ВозможноСписаниеНДС,
	|
	|		ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		КАК НаправлениеДеятельности,
	|   Т.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|   Т.КорГруппаПродукции КАК КорГруппаПродукции,
	|
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатурыДокументаПоступления,
	|
	|	1 						КАК Количество,
	|	1 						КАК Коэффициент,
	|	ВЫРАЗИТЬ(Т.СтоимостьБезНДС КАК ЧИСЛО(31,10))	КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(Т.НДС КАК ЧИСЛО(31,10))				КАК НДС,
	|	ВЫРАЗИТЬ(Т.СтоимостьБезНДСУпр КАК ЧИСЛО(31,10))	КАК СтоимостьБезНДСУпр,
	|	ВЫРАЗИТЬ(Т.НДСУпр КАК ЧИСЛО(31,10))				КАК НДСУпр
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиТоваровПостатейныеЗатратыНЗП КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТТаблицаОтбораПартийНДС КАК ОтборПартийНДС
	|	ПО &УсловияСоединения
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТТаблицаОтбораРегистраторов КАК ОтборРегистраторов
	|	ПО &УсловияДляРегистраторовНЗП
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|	И ВЫБОР КОГДА &ОтражениеВРеглУчете ТОГДА
	|		(НЕ Т.ПриходЗатрат
	|			И Т.НДС <> 0)
	|		ИЛИ (ТИПЗНАЧЕНИЯ(Т.ДокументДвижения) = ТИП(Документ.РаспределениеПрочихЗатрат)
	|			И Т.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|			И Т.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|			И Т.ВидДеятельностиНДС <> Т.КорВидДеятельностиНДС)
	|	ИНАЧЕ ИСТИНА
	|	КОНЕЦ
	|	И ВЫБОР
	|		КОГДА &ОтражениеВРеглУчете ИЛИ &ОтражениеВУчетеНДС ТОГДА
	|			Т.НДС <> 0
	|		ИНАЧЕ
	|			ИСТИНА
	|	КОНЕЦ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Отклонения в стоимости неотфактурованных поставок на прочие расходы.
	// Используется для корректировки вида деятельности НДС в движениях по регистру "НДС предъявленный".
	|ВЫБРАТЬ
	|	4 КАК КодИсточника,
	|	Ложь КАК ЭтоНЗП,
	|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ) КАК Месяц,
	|	Т.Период КАК Период,
	|	Т.ВидДвижения,
	|	Т.Регистратор,
	|	Т.Партия,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.РазделУчета,
	|	Т.ВидЗапасов,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаФинансовогоУчета,
	|	ЕСТЬNULL(Поступление.ЗакупкаПодДеятельность, Т.ВидДеятельностиНДС) КАК ВидДеятельностиНДС,
	|	Т.ХозяйственнаяОперация,
	|	Т.КорАналитикаУчетаНоменклатуры,
	|	Т.КорРазделУчета,
	|	Т.КорВидЗапасов,
	|	Т.Подразделение,
	|	Т.Подразделение КАК КорПодразделение,
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.ГруппаПродукции,
	|	Т.КорАналитикаФинансовогоУчета,
	|	Т.КорВидДеятельностиНДС,
	|	Т.ТипЗаписи,
	|	Т.ДокументИсточник,
	|	Т.Сторно,
	|	ЛОЖЬ КАК ВозможноСписаниеНДС,
	|
	|	ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
	|	ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|		Т.КорНаправлениеДеятельности) КАК КорНаправлениеДеятельности,
	|	Т.ГруппаПродукции КАК КорГруппаПродукции,
	|
	|	Т.Регистратор КАК ДокументПоступления,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартийДокументаПоступления,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатурыДокументаПоступления,
	|
	|	1 						КАК Количество,
	|	1 						КАК Коэффициент,
	|	0						КАК СтоимостьБезНДС,
	|	Т.НДСРегл				КАК НДС,
	|	0						КАК СтоимостьБезНДСУпр,
	|	Т.НДСУпр				КАК НДСУпр
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТТаблицаОтбораРегистраторов КАК ОтборРегистраторов
	|		ПО &УсловияДляРегистраторов
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборПартии КАК ОтборПартии
	|		ПО Т.Партия = ОтборПартии.Партия
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПриобретениеТоваровУслуг КАК Поступление
	|		ПО Поступление.Ссылка = Т.Регистратор
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|	И Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимостиНаПрочиеРасходы)
	|	И Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
	|	И НЕ Т.РасчетСебестоимости
	|	И Т.Активность
	|	И ВЫБОР
	|		КОГДА &ОтражениеВРеглУчете ИЛИ &ОтражениеВУчетеНДС ТОГДА
	|			Т.НДСРегл <> 0
	|		ИНАЧЕ
	|			ИСТИНА
	|	КОНЕЦ
	|
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Корректировки приобретения прошлого периода.
	// Используется для корректировки вида деятельности НДС в движениях по регистру "НДС предъявленный".
	|ВЫБРАТЬ
	|	5 КАК КодИсточника,
	|	Ложь КАК ЭтоНЗП,
	|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ) КАК Месяц,
	|	Т.Период КАК Период,
	|	Т.ВидДвижения,
	|	Т.Регистратор,
	|	Т.Партия,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.РазделУчета,
	|	Т.ВидЗапасов,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.ХозяйственнаяОперация,
	|	Т.КорАналитикаУчетаНоменклатуры,
	|	Т.КорРазделУчета,
	|	Т.КорВидЗапасов,
	|	Т.Подразделение,
	|	Т.Подразделение КАК КорПодразделение,
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.ГруппаПродукции,
	|	Т.КорАналитикаФинансовогоУчета,
	|	Т.КорВидДеятельностиНДС,
	|	Т.ТипЗаписи,
	|	Т.ДокументИсточник,
	|	Т.Сторно,
	|	ЛОЖЬ КАК ВозможноСписаниеНДС,
	|
	|	ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
	|	ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|		Т.КорНаправлениеДеятельности) КАК КорНаправлениеДеятельности,
	|	Т.ГруппаПродукции КАК КорГруппаПродукции,
	|
	|	Т.Регистратор КАК ДокументПоступления,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартийДокументаПоступления,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатурыДокументаПоступления,
	|
	|	1 						КАК Количество,
	|	1 						КАК Коэффициент,
	|	0						КАК СтоимостьБезНДС,
	|	Т.НДСРегл				КАК НДС,
	|	0						КАК СтоимостьБезНДСУпр,
	|	Т.НДСУпр				КАК НДСУпр
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТТаблицаОтбораРегистраторов КАК ОтборРегистраторов
	|		ПО &УсловияДляРегистраторов
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборПартии КАК ОтборПартии
	|		ПО Т.Партия = ОтборПартии.Партия
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПриобретениеТоваровУслуг КАК Поступление
	|		ПО Поступление.Ссылка = Т.Регистратор
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И Т.Организация В(&МассивОрганизаций)
	|	И Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода)
	|	И Т.РасчетПартий
	|	И Т.Активность
	|	И ВЫБОР
	|		КОГДА &ОтражениеВРеглУчете ИЛИ &ОтражениеВУчетеНДС ТОГДА
	|			Т.НДСРегл <> 0
	|		ИНАЧЕ
	|			ИСТИНА
	|	КОНЕЦ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	&НачалоПериода КАК НачалоПериода,
	|	НастройкиУчетаНДС.Организация КАК Организация,
	|	НастройкиУчетаНДС.ВариантУчетаНДСПриИзмененииВидаДеятельности,
	|	НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ,
	|	НастройкиУчетаНДС.СтатьяРасходовНеНДС,
	|	НастройкиУчетаНДС.АналитикаРасходовНеНДС,
	|	НастройкиУчетаНДС.СтатьяРасходовЕНВД,
	|	НастройкиУчетаНДС.АналитикаРасходовЕНВД,
	|	НастройкиУчетаНДС.СтатьяРасходовСписаниеНДС,
	|	НастройкиУчетаНДС.АналитикаРасходовСписаниеНДС
	|ПОМЕСТИТЬ ВтНастройкиУчетаНДС
	|ИЗ
	|	РегистрСведений.НастройкиУчетаНДС.СрезПоследних(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК НастройкиУчетаНДС
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НастройкиУчетаНДС.Период,
	|	НастройкиУчетаНДС.Организация,
	|	НастройкиУчетаНДС.ВариантУчетаНДСПриИзмененииВидаДеятельности,
	|	НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ,
	|	НастройкиУчетаНДС.СтатьяРасходовНеНДС,
	|	НастройкиУчетаНДС.АналитикаРасходовНеНДС,
	|	НастройкиУчетаНДС.СтатьяРасходовЕНВД,
	|	НастройкиУчетаНДС.АналитикаРасходовЕНВД,
	|	НастройкиУчетаНДС.СтатьяРасходовСписаниеНДС,
	|	НастройкиУчетаНДС.АналитикаРасходовСписаниеНДС
	|ИЗ
	|	РегистрСведений.НастройкиУчетаНДС КАК НастройкиУчетаНДС
	|ГДЕ
	|	НастройкиУчетаНДС.Организация В (&МассивОрганизаций)
	|	И НастройкиУчетаНДС.Период > &НачалоПериода
	|	И НастройкиУчетаНДС.Период <= &КонецПериода
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	НачалоПериода
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	НастройкиУчетаНДС.НачалоПериода,
	|	НастройкиУчетаНДС.Организация КАК Организация,
	|	КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(МИНИМУМ(ЕСТЬNULL(БудущиеНастройкиУчетаНДС.НачалоПериода, &КонецПериода)), СЕКУНДА, -1), ДЕНЬ) КАК ОкончаниеПериода,
	|	НастройкиУчетаНДС.ВариантУчетаНДСПриИзмененииВидаДеятельности,
	|	НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ,
	|	НастройкиУчетаНДС.СтатьяРасходовНеНДС,
	|	НастройкиУчетаНДС.АналитикаРасходовНеНДС,
	|	НастройкиУчетаНДС.СтатьяРасходовЕНВД,
	|	НастройкиУчетаНДС.АналитикаРасходовЕНВД,
	|	НастройкиУчетаНДС.СтатьяРасходовСписаниеНДС,
	|	НастройкиУчетаНДС.АналитикаРасходовСписаниеНДС
	|ПОМЕСТИТЬ НастройкиУчетаНДСПоПериодам
	|ИЗ
	|	ВтНастройкиУчетаНДС КАК НастройкиУчетаНДС
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВтНастройкиУчетаНДС КАК БудущиеНастройкиУчетаНДС
	|		ПО НастройкиУчетаНДС.Организация = БудущиеНастройкиУчетаНДС.Организация
	|			И НастройкиУчетаНДС.НачалоПериода < БудущиеНастройкиУчетаНДС.НачалоПериода
	|
	|СГРУППИРОВАТЬ ПО
	|	НастройкиУчетаНДС.НачалоПериода,
	|	НастройкиУчетаНДС.Организация,
	|	НастройкиУчетаНДС.ВариантУчетаНДСПриИзмененииВидаДеятельности,
	|	НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ,
	|	НастройкиУчетаНДС.СтатьяРасходовНеНДС,
	|	НастройкиУчетаНДС.АналитикаРасходовНеНДС,
	|	НастройкиУчетаНДС.СтатьяРасходовЕНВД,
	|	НастройкиУчетаНДС.АналитикаРасходовЕНВД,
	|	НастройкиУчетаНДС.СтатьяРасходовСписаниеНДС,
	|	НастройкиУчетаНДС.АналитикаРасходовСписаниеНДС
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ ПЕРВЫЕ 9999999999999
	|	АВТОНОМЕРЗАПИСИ() КАК НомерЗаписи,
	|	Т.ЭтоНЗП,
	|	ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат) КАК ЭтоРаспределениеПрочихЗатрат,
	|	ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) КАК ДатаРегистратора,
	|	Т.Период КАК Период,
	|	Т.ВидДвижения КАК ВидДвижения,
	|	Т.Регистратор КАК Регистратор,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	ВЫБОР
	|		КОГДА ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат)
	|			И Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|			И НЕ ЕСТЬNULL(СтатьиРасходов.ПринятиеКНалоговомуУчету, ИСТИНА)
	|			И ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
	|			И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|		КОГДА ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат)
	|		ТОГДА Т.КорВидДеятельностиНДС
	|		ИНАЧЕ Т.ВидДеятельностиНДС
	|	КОНЕЦ КАК ВидДеятельностиНДС,
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	ВЫБОР
	|		КОГДА Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И НЕ ЕСТЬNULL(СтатьиРасходов.ПринятиеКНалоговомуУчету, ИСТИНА) 
	|		 И ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
	|		 И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеНДСПоПриобретеннымЦенностям)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПустаяСсылка)
	|	КОНЕЦ КАК НастройкаХозяйственнойОперации,
	|	Т.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|	Т.КорРазделУчета КАК КорРазделУчета,
	|	Т.КорВидЗапасов КАК КорВидЗапасов,
	|	Т.Подразделение КАК Подразделение,
	|	Т.КорПодразделение КАК КорПодразделение,
	|	Т.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов КАК СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
	|	Т.ГруппаПродукции КАК ГруппаПродукции,
	|	Т.КорАналитикаФинансовогоУчета КАК КорАналитикаФинансовогоУчета,
	|	ВЫБОР
	|		КОГДА Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|			И НЕ ЕСТЬNULL(СтатьиРасходов.ПринятиеКНалоговомуУчету, ИСТИНА)
	|			И ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
	|			И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|		КОГДА ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат)
	|		ТОГДА Т.ВидДеятельностиНДС
	|		ИНАЧЕ Т.КорВидДеятельностиНДС
	|	КОНЕЦ КАК КорВидДеятельностиНДС,
	|	Т.ТипЗаписи КАК ТипЗаписи,
	|	Т.ДокументИсточник КАК ДокументИсточник,
	|	Т.Сторно КАК Сторно,
	|	ВЫБОР
	|		КОГДА &ОтражениеВУчетеНДС И ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат)
	|		ТОГДА Т.КорНаправлениеДеятельности
	|		ИНАЧЕ Т.НаправлениеДеятельности
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА &ОтражениеВУчетеНДС И ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат)
	|		ТОГДА Т.НаправлениеДеятельности
	|		ИНАЧЕ Т.КорНаправлениеДеятельности
	|	КОНЕЦ КАК КорНаправлениеДеятельности,
	|	Т.КорГруппаПродукции КАК КорГруппаПродукции,
	|	ВЫБОР
	// Если в настройке учета НДС установлен флажок "Списывать НДС по расходам, не принимаемым к НУ" и указана статья расходов,
	// не принимаемая к налоговому учету по налогу на прибыль, то такие расходы списываются на статью и аналитику расходов 
	// из настройки учета НДС, если НДС не был включен в стоимость товара.
	|		КОГДА Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И НЕ ЕСТЬNULL(СтатьиРасходов.ПринятиеКНалоговомуУчету, ИСТИНА) 
	|		 И ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
	|		 И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|			ТОГДА НастройкиУчетаНДС.СтатьяРасходовСписаниеНДС
	|		КОГДА НастройкиУчетаНДС.ВариантУчетаНДСПриИзмененииВидаДеятельности ЕСТЬ NULL
	|			ИЛИ НастройкиУчетаНДС.ВариантУчетаНДСПриИзмененииВидаДеятельности = ЗНАЧЕНИЕ(Перечисление.ВариантыУчетаНДСПриИзмененииВидаДеятельностиНаНеоблагаемую.ВключатьВСтоимость)
	|			ИЛИ НЕ Т.ВозможноСписаниеНДС ИЛИ НастройкиУчетаНДС.СтатьяРасходовСписаниеНДС = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ИЛИ НАЧАЛОПЕРИОДА(ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)), МЕСЯЦ) = &НачалоПериода
	|			И НастройкиУчетаНДС.ВариантУчетаНДСПриИзмененииВидаДеятельности = ЗНАЧЕНИЕ(Перечисление.ВариантыУчетаНДСПриИзмененииВидаДеятельностиНаНеоблагаемую.ВключатьВСтоимостьИлиРасходыВЗависимостиОтПериода)
	|		ТОГДА ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		КОГДА Т.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|		ТОГДА НастройкиУчетаНДС.СтатьяРасходовНеНДС
	|		ИНАЧЕ НастройкиУчетаНДС.СтатьяРасходовЕНВД
	|	КОНЕЦ КАК СтатьяСписанияНДС,
	|	ВЫБОР
	|		КОГДА Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И НЕ ЕСТЬNULL(СтатьиРасходов.ПринятиеКНалоговомуУчету, ИСТИНА) 
	|		 И ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
	|		 И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|			ТОГДА НастройкиУчетаНДС.АналитикаРасходовСписаниеНДС
	|		КОГДА НастройкиУчетаНДС.ВариантУчетаНДСПриИзмененииВидаДеятельности ЕСТЬ NULL
	|			ИЛИ НастройкиУчетаНДС.ВариантУчетаНДСПриИзмененииВидаДеятельности = ЗНАЧЕНИЕ(Перечисление.ВариантыУчетаНДСПриИзмененииВидаДеятельностиНаНеоблагаемую.ВключатьВСтоимость)
	|			ИЛИ НЕ Т.ВозможноСписаниеНДС ИЛИ НастройкиУчетаНДС.СтатьяРасходовСписаниеНДС = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ИЛИ НАЧАЛОПЕРИОДА(ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)), МЕСЯЦ) = &НачалоПериода
	|			И НастройкиУчетаНДС.ВариантУчетаНДСПриИзмененииВидаДеятельности = ЗНАЧЕНИЕ(Перечисление.ВариантыУчетаНДСПриИзмененииВидаДеятельностиНаНеоблагаемую.ВключатьВСтоимостьИлиРасходыВЗависимостиОтПериода)
	|		ТОГДА НЕОПРЕДЕЛЕНО
	|		КОГДА Т.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|		ТОГДА НастройкиУчетаНДС.АналитикаРасходовНеНДС
	|		ИНАЧЕ НастройкиУчетаНДС.АналитикаРасходовЕНВД
	|	КОНЕЦ КАК АналитикаСписанияНДС,
	|	Т.ДокументПоступления КАК ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления КАК АналитикаУчетаПартийДокументаПоступления,
	|	Т.Количество КАК Количество,
	|	ВЫБОР КОГДА ВЫРАЗИТЬ(Т.Коэффициент * Т.СтоимостьБезНДС КАК ЧИСЛО(31, 2)) > Т.Коэффициент * Т.СтоимостьБезНДС
	|			И Т.Коэффициент * Т.СтоимостьБезНДС > 0
	|			И НЕ ОСНО.СистемаНалогообложения ЕСТЬ NULL
	|		ТОГДА ВЫРАЗИТЬ(Т.Коэффициент * Т.СтоимостьБезНДС КАК ЧИСЛО(31, 2)) - 0.01
	|		ИНАЧЕ ВЫРАЗИТЬ(Т.Коэффициент * Т.СтоимостьБезНДС КАК ЧИСЛО(31, 2))
	|	КОНЕЦ КАК СтоимостьБезНДС,
	|	ВЫБОР КОГДА ВЫРАЗИТЬ(Т.Коэффициент * Т.НДС КАК ЧИСЛО(31, 2)) > Т.Коэффициент * Т.НДС
	|			И Т.Коэффициент * Т.НДС > 0
	|			И НЕ ОСНО.СистемаНалогообложения ЕСТЬ NULL
	|		ТОГДА ВЫРАЗИТЬ(Т.Коэффициент * Т.НДС КАК ЧИСЛО(31, 2)) - 0.01
	|		ИНАЧЕ ВЫРАЗИТЬ(Т.Коэффициент * Т.НДС КАК ЧИСЛО(31, 2))
	|	КОНЕЦ КАК НДС,
	|	ВЫБОР КОГДА ВЫРАЗИТЬ(Т.Коэффициент * Т.СтоимостьБезНДСУпр КАК ЧИСЛО(31, 2)) > Т.Коэффициент * Т.СтоимостьБезНДСУпр
	|			И Т.Коэффициент * Т.СтоимостьБезНДСУпр > 0
	|			И НЕ ОСНО.СистемаНалогообложения ЕСТЬ NULL
	|		ТОГДА ВЫРАЗИТЬ(Т.Коэффициент * Т.СтоимостьБезНДСУпр КАК ЧИСЛО(31, 2)) - 0.01
	|		ИНАЧЕ ВЫРАЗИТЬ(Т.Коэффициент * Т.СтоимостьБезНДСУпр КАК ЧИСЛО(31, 2))
	|	КОНЕЦ КАК СтоимостьБезНДСУпр,
	|	ВЫБОР КОГДА ВЫРАЗИТЬ(Т.Коэффициент * Т.НДСУпр КАК ЧИСЛО(31, 2)) > Т.Коэффициент * Т.НДСУпр
	|				И Т.Коэффициент * Т.НДСУпр > 0
	|				И НЕ ОСНО.СистемаНалогообложения ЕСТЬ NULL
	|		ТОГДА ВЫРАЗИТЬ(Т.Коэффициент * Т.НДСУпр КАК ЧИСЛО(31, 2)) - 0.01
	|		ИНАЧЕ ВЫРАЗИТЬ(Т.Коэффициент * Т.НДСУпр КАК ЧИСЛО(31, 2))
	|	КОНЕЦ КАК НДСУпр
	|ПОМЕСТИТЬ ВТСтоимостьПартийНДСБезКорректировокНДС
	|ИЗ
	|	ВТСтоимостьПартийНДСПредварительная КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ НастройкиУчетаНДСПоПериодам КАК НастройкиУчетаНДС
	|		ПО НастройкиУчетаНДС.Организация = Т.Организация
	|		И Т.Период >= НастройкиУчетаНДС.НачалоПериода
	|		И Т.Период < НастройкиУчетаНДС.ОкончаниеПериода
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиОрганизаций КАК ОСНО
	|		ПО ОСНО.Организация = Т.Организация
	|		И ОСНО.СистемаНалогообложения = ЗНАЧЕНИЕ(Перечисление.СистемыНалогообложения.Общая)
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|		ПО ДанныеПервичныхДокументов.Организация = Т.Организация
	|		И ДанныеПервичныхДокументов.Документ = Т.ДокументПоступления
	|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходов
	|		ПО Т.СтатьяРасходовСписания = СтатьиРасходов.Ссылка
	|ГДЕ
	|	ВЫБОР
	|		КОГДА &ОтражениеВРеглУчете ИЛИ &ОтражениеВУчетеНДС ТОГДА
	|			ВЫРАЗИТЬ(Т.Коэффициент * Т.НДС КАК ЧИСЛО(31, 2)) <> 0
	|		ИНАЧЕ
	|			ИСТИНА
	|	КОНЕЦ
	|
	// Порядок полей и дальнейшая логика корректировки копеек должна быть идентичная СформироватьСтоимостьПартийНДСНаКонецПериода()
	|УПОРЯДОЧИТЬ ПО
	|	Регистратор,
	|	Период,
	|	ВидДвижения,
	|	Партия,
	|	АналитикаУчетаНоменклатуры,
	|	ВидЗапасов,
	|	РазделУчета,
	|	Организация,
	|	АналитикаФинансовогоУчета,
	|	ВидДеятельностиНДС,
	|	КорАналитикаУчетаНоменклатуры,
	|	Количество
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументПоступления,
	|	Организация,
	|	НомерЗаписи
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.ДокументПоступления,
	|	Т.Организация КАК Организация,
	|	МАКСИМУМ(Т.НомерЗаписи) КАК НомерЗаписи,
	|	СУММА(Т.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	СУММА(Т.НДС) КАК НДС,
	|	СУММА(Т.НДСУпр) КАК НДСУпр
	|ПОМЕСТИТЬ ВТДокументыПоступления
	|ИЗ
	|	ВТСтоимостьПартийНДСБезКорректировокНДС КАК Т
	|ГДЕ
	// НДС включается в стоимость
	|	Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|	И Т.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|	И Т.СтатьяСписанияНДС = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|	И (Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		ИЛИ ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат))
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.ДокументПоступления,
	|	Т.Организация
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументПоступления
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.СчетФактура КАК ДокументПоступления,
	|	Т.Организация КАК Организация,
	|	СУММА(Т.СуммаБезНДСОборот) КАК СтоимостьБезНДС,
	|	СУММА(Т.НДСОборот) КАК НДС,
	|	СУММА(Т.НДСУпрОборот) КАК НДСУпр
	|ПОМЕСТИТЬ ВТОборотыДвиженияПоНДС
	|ИЗ
	|	РегистрНакопления.ДвиженияПоНДС.Обороты(, ДОБАВИТЬКДАТЕ(&НачалоПериода, СЕКУНДА, -1), ,
	|		СчетФактура В (ВЫБРАТЬ Отбор.ДокументПоступления ИЗ ВТДокументыПоступления КАК Отбор)) КАК Т	
	|СГРУППИРОВАТЬ ПО
	|	Т.СчетФактура,
	|	Т.Организация
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументПоступления
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.ДокументПоступления КАК ДокументПоступления,
	|	Т.Организация КАК Организация,
	|	Т.НомерЗаписи КАК НомерЗаписи,
	|	ВЫБОР КОГДА ОборотыНДС.СтоимостьБезНДС - Т.СтоимостьБезНДС <> 0
	|		И ОборотыНДС.СтоимостьБезНДС - Т.СтоимостьБезНДС <= &ПорогСписанияПогрешностейОкругленияНДС
	|		И ОборотыНДС.СтоимостьБезНДС - Т.СтоимостьБезНДС >= -&ПорогСписанияПогрешностейОкругленияНДС
	|	  ТОГДА ОборотыНДС.СтоимостьБезНДС - Т.СтоимостьБезНДС
	|	  ИНАЧЕ 0
	|	КОНЕЦ КАК СтоимостьБезНДС,
	|	ВЫБОР КОГДА ОборотыНДС.НДС - Т.НДС <> 0
	|		И ОборотыНДС.НДС - Т.НДС <= &ПорогСписанияПогрешностейОкругленияНДС
	|		И ОборотыНДС.НДС - Т.НДС >= -&ПорогСписанияПогрешностейОкругленияНДС
	|	  ТОГДА ОборотыНДС.НДС - Т.НДС
	|	  ИНАЧЕ 0
	|	КОНЕЦ КАК НДС,
	|	ВЫБОР КОГДА ОборотыНДС.НДСУпр - Т.НДСУпр <> 0
	|		И ОборотыНДС.НДСУпр - Т.НДСУпр <= &ПорогСписанияПогрешностейОкругленияНДС
	|		И ОборотыНДС.НДСУпр - Т.НДСУпр >= -&ПорогСписанияПогрешностейОкругленияНДС
	|	  ТОГДА ОборотыНДС.НДСУпр - Т.НДСУпр
	|	  ИНАЧЕ 0
	|	КОНЕЦ КАК НДСУпр
	|ПОМЕСТИТЬ ВТКорректировкиНДС
	|ИЗ
	|	ВТДокументыПоступления КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОборотыДвиженияПоНДС КАК ОборотыНДС
	|		ПО Т.ДокументПоступления = ОборотыНДС.ДокументПоступления
	|		И Т.Организация = ОборотыНДС.Организация
	|ГДЕ
	|	ВЫБОР КОГДА ОборотыНДС.СтоимостьБезНДС - Т.СтоимостьБезНДС <> 0
	|		И ОборотыНДС.СтоимостьБезНДС - Т.СтоимостьБезНДС <= &ПорогСписанияПогрешностейОкругленияНДС
	|		И ОборотыНДС.СтоимостьБезНДС - Т.СтоимостьБезНДС >= -&ПорогСписанияПогрешностейОкругленияНДС
	|	  ТОГДА ОборотыНДС.СтоимостьБезНДС - Т.СтоимостьБезНДС
	|	  ИНАЧЕ 0
	|	КОНЕЦ  <> 0
	|	ИЛИ ВЫБОР КОГДА ОборотыНДС.НДС - Т.НДС <> 0
	|		И ОборотыНДС.НДС - Т.НДС <= &ПорогСписанияПогрешностейОкругленияНДС
	|		И ОборотыНДС.НДС - Т.НДС >= -&ПорогСписанияПогрешностейОкругленияНДС
	|	  ТОГДА ОборотыНДС.НДС - Т.НДС
	|	  ИНАЧЕ 0
	|	КОНЕЦ  <> 0
	|	ИЛИ ВЫБОР КОГДА ОборотыНДС.НДСУпр - Т.НДСУпр <> 0
	|		И ОборотыНДС.НДСУпр - Т.НДСУпр <= &ПорогСписанияПогрешностейОкругленияНДС
	|		И ОборотыНДС.НДСУпр - Т.НДСУпр >= -&ПорогСписанияПогрешностейОкругленияНДС
	|	  ТОГДА ОборотыНДС.НДСУпр - Т.НДСУпр
	|	  ИНАЧЕ 0
	|	КОНЕЦ  <> 0
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументПоступления,
	|	Организация,
	|	НомерЗаписи
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.ЭтоНЗП,
	|	Т.ЭтоРаспределениеПрочихЗатрат,
	|	Т.ДатаРегистратора,
	|	Т.Период,
	|	Т.ВидДвижения,
	|	Т.Регистратор,
	|	Т.Партия,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.РазделУчета,
	|	Т.ВидЗапасов,
	|	Т.Организация,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации,
	|	Т.КорАналитикаУчетаНоменклатуры,
	|	Т.КорРазделУчета,
	|	Т.КорВидЗапасов,
	|	Т.Подразделение,
	|	Т.КорПодразделение,
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.ГруппаПродукции,
	|	Т.КорАналитикаФинансовогоУчета,
	|	Т.КорВидДеятельностиНДС,
	|	Т.ТипЗаписи,
	|	Т.ДокументИсточник,
	|	Т.Сторно,
	|	Т.НаправлениеДеятельности,
	|	Т.КорНаправлениеДеятельности,
	|	Т.КорГруппаПродукции,
	|	Т.СтатьяСписанияНДС,
	|	Т.АналитикаСписанияНДС,
	|	ВЫБОР КОГДА НЕ Корректировка.ДокументОснование ЕСТЬ NULL
	|				И (Т.ВидДеятельностиНДС В (ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПроизводствоСДЦ),
	|										   ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.Космос))
	|					ИЛИ Т.НДС < 0)
	|		ТОГДА Корректировка.ДокументОснование
	|		ИНАЧЕ Т.ДокументПоступления
	|	КОНЕЦ КАК ДокументПоступления,
	|	Т.АналитикаУчетаПартийДокументаПоступления,
	|	Т.Количество,
	|
	|	ВЫРАЗИТЬ(Т.СтоимостьБезНДС + ЕСТЬNULL(КорректировкиНДС.СтоимостьБезНДС, 0) КАК ЧИСЛО(31, 2)) КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(Т.НДС + ЕСТЬNULL(КорректировкиНДС.НДС, 0) КАК ЧИСЛО(31, 2)) КАК НДС,
	|	Т.СтоимостьБезНДСУпр,
	|	ВЫРАЗИТЬ(Т.НДСУпр + ЕСТЬNULL(КорректировкиНДС.НДСУпр, 0) КАК ЧИСЛО(31, 2)) КАК НДСУпр
	|ПОМЕСТИТЬ ВТСтоимостьПартийНДС
	|ИЗ
	|	ВТСтоимостьПартийНДСБезКорректировокНДС КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТКорректировкиНДС КАК КорректировкиНДС
	|		ПО КорректировкиНДС.ДокументПоступления = Т.ДокументПоступления
	|		И КорректировкиНДС.Организация = Т.Организация
	|		И КорректировкиНДС.НомерЗаписи = Т.НомерЗаписи
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК Корректировка
	|		ПО Т.ДокументПоступления = Корректировка.Ссылка
	|		И Корректировка.ВидКорректировки = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|";
	
	МассивЗапросов.Добавить(ТекстЗапроса); 
	
	ТекстЗапроса = СтрСоединить(МассивЗапросов, ОбщегоНазначения.РазделительПакетаЗапросов());
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&Организации", "&МассивОрганизаций");
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&Период", "&НачалоПериода");
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ПоВсемОрганизациям", "ЛОЖЬ");
	
	Если ЗначениеЗаполнено(ТекстОрганизация) Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&МассивОрганизаций", "&" + ТекстОрганизация);
	КонецЕсли;
		
	Если ЗначениеЗаполнено(ТекстНачалоПериода) Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&НачалоПериода", "&" + ТекстНачалоПериода);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ТекстКонецПериода) Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&КонецПериода", "&" + ТекстКонецПериода);
	КонецЕсли;
	
	ПолеОтбораПоРегистратору = "";
	ТаблицаОтбораПоРегистратору = "";
	
	// Условия отбора партий НДС
	Если ЗначениеЗаполнено(СтруктураОтбора) Тогда
		
		ПоляОтбора = "";
		СоединениеПолей = "";
		
		Для Каждого КлючИЗначение Из СтруктураОтбора Цикл
			
			ТекстТаблицаОтбора =
			"ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	&ПоляОтбора
			|ПОМЕСТИТЬ ВТТаблицаОтбораПартийНДС
			|ИЗ
			|	&ТаблицаОтбора КАК Т
			|ИНДЕКСИРОВАТЬ ПО
			|	&ПоляИндексирования
			|;
			|";
			
			ТаблицаПоляИндекса = Новый ТаблицаЗначений;
			ТаблицаПоляИндекса.Колонки.Добавить("Поле");
			ТаблицаПоляИндекса.Колонки.Добавить("Приоритет");
			
			ПоляИндексирования = "";
			
			Для Каждого ОписаниеПолей Из КлючИЗначение.Значение Цикл
				
				Если НРег(ОписаниеПолей.Значение) = НРег("Регистратор") Тогда
					ТаблицаОтбораПоРегистратору = КлючИЗначение.Ключ;
					ПолеОтбораПоРегистратору = ОписаниеПолей.Ключ;
					Продолжить;
				КонецЕсли;
				
				ПоляОтбора = ПоляОтбора + ?(ПоляОтбора = "", "", ",
					|	") + "Т." + ОписаниеПолей.Ключ;
				
				СоединениеПолей = СоединениеПолей + ?(СоединениеПолей = "", "", "
					|	И ") + "ОтборПартийНДС." + ОписаниеПолей.Ключ + " = "
					+ "Т." + ОписаниеПолей.Значение;
				
				НовоеПоле = ТаблицаПоляИндекса.Добавить();
				НовоеПоле.Поле = ОписаниеПолей.Ключ;
				НовоеПоле.Приоритет = ?(НРег(ОписаниеПолей.Значение) = НРег("ДокументПоступления"), 0, 1);
				
			КонецЦикла;
			
			Если ТаблицаПоляИндекса.Количество() = 0 Тогда
				// Пустой отбор или отбор только по регистраторам
				ТекстТаблицаОтбора =
				"ВЫБРАТЬ
				|	ИСТИНА КАК Поле
				|ПОМЕСТИТЬ ВТТаблицаОтбораПартийНДС
				|;
				|";
				СоединениеПолей = "ИСТИНА";
				Прервать;
			КонецЕсли;
			
			ТаблицаПоляИндекса.Сортировать("Приоритет, Поле");
			
			Для Каждого НовоеПоле Из ТаблицаПоляИндекса Цикл
				ПоляИндексирования = ПоляИндексирования + ?(ПоляИндексирования = "", "", ",
					|	") + "Т." + НовоеПоле.Поле;
			КонецЦикла;
			
			ТекстТаблицаОтбора = СтрЗаменить(ТекстТаблицаОтбора, "&ТаблицаОтбора", КлючИЗначение.Ключ);
			ТекстТаблицаОтбора = СтрЗаменить(ТекстТаблицаОтбора, "&ПоляОтбора", ПоляОтбора);
			ТекстТаблицаОтбора = СтрЗаменить(ТекстТаблицаОтбора, "&ПоляИндексирования", ПоляИндексирования);
			
			Прервать; // поддерживается отбор только по одной таблице
			
		КонецЦикла;
			
	Иначе
		
		ТекстТаблицаОтбора =
		"ВЫБРАТЬ
		|	ИСТИНА КАК Поле
		|ПОМЕСТИТЬ ВТТаблицаОтбораПартийНДС
		|;
		|";
		СоединениеПолей = "ИСТИНА";
		
	КонецЕсли;
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&УсловияСоединения", СоединениеПолей);
	ТекстЗапроса = ТекстТаблицаОтбора + ТекстЗапроса;
	
	// Условия отбора регистраторов себестоимости
	Если ЗначениеЗаполнено(ПолеОтбораПоРегистратору) Тогда
		
		ТекстТаблицаОтбора =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	&ПолеОтбора
		|ПОМЕСТИТЬ ВТТаблицаОтбораРегистраторов
		|ИЗ
		|	&ТаблицаОтбора КАК Т
		|ИНДЕКСИРОВАТЬ ПО
		|	&ПолеОтбора
		|;
		|";
		
		ТекстТаблицаОтбора = СтрЗаменить(ТекстТаблицаОтбора, "&ТаблицаОтбора", ТаблицаОтбораПоРегистратору);
		ТекстТаблицаОтбора = СтрЗаменить(ТекстТаблицаОтбора, "&ПолеОтбора", "Т." + ПолеОтбораПоРегистратору);
		
		СоединениеПолей = "ОтборРегистраторов." + ПолеОтбораПоРегистратору + " = Т.Регистратор";
		СоединениеПолейНЗП = "ОтборРегистраторов." + ПолеОтбораПоРегистратору + " = Т.ДокументДвижения";
		
	Иначе
		
		ТекстТаблицаОтбора =
		"ВЫБРАТЬ
		|	ИСТИНА КАК Регистратор
		|ПОМЕСТИТЬ ВТТаблицаОтбораРегистраторов
		|;
		|";
		СоединениеПолей = "ИСТИНА";
		СоединениеПолейНЗП = "ИСТИНА";
		
	КонецЕсли;
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&УсловияДляРегистраторовНЗП", СоединениеПолейНЗП);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&УсловияДляРегистраторов", СоединениеПолей);
	ТекстЗапроса = ТекстТаблицаОтбора + ТекстЗапроса;
	
	Возврат ТекстЗапроса;
	
КонецФункции

// Дополняет структуру параметров для запроса детализации партий НДС.
// 
// Параметры:
//  СтруктураПараметров - Структура - Структура параметров
//  ОтражениеВРеглУчете - Булево - признак вызова из механизма формрования проводок
Процедура ДополнитьСтруктуруПараметровДляДетализацииПартийНДС(СтруктураПараметров, СтруктураДанных = Неопределено) Экспорт
	
	СтруктураПараметров.Вставить("ТипыЗаписейКонвертацииДанных", РасчетСебестоимостиПрикладныеАлгоритмы.ТипыЗаписейКонвертацииДанных());
	СтруктураПараметров.Вставить("ПорогСписанияПогрешностейОкругленияНДС", УчетНДСУПСлужебный.ПорогСписанияПогрешностейОкругления());
	
	// Типы налогообложения НДС
	СтруктураПараметров.Вставить("ТипыНалогообложенияНДСНеУчитываетсяВСтоимости",
		УчетНДСУП.ВидыДеятельностиНДСПринимаетсяКВозмещению());
	СтруктураПараметров.Вставить("ТипыНалогообложенияНДСУчитываетсяВСтоимости",
		УчетНДСУП.ВидыДеятельностиНДСУчитываетсяВСтоимости());
	
	// Разделы учета себестоимости для забалансового учета товаров. 
	СтруктураПараметров.Вставить("РазделыУчетаЗабалансовые", Перечисления.РазделыУчетаСебестоимостиТоваров.ЗабалансовыеРазделыУчета());
	
	Если НЕ ЗначениеЗаполнено(СтруктураДанных) Тогда
		СтруктураДанных = ИнициализироватьСтруктуруДанныхДетализацииПартийНДС();
	КонецЕсли;
	
	Для Каждого КлючИЗначение Из СтруктураДанных.ПараметрыЗапроса Цикл
		СтруктураПараметров.Вставить(КлючИЗначение.Ключ, КлючИЗначение.Значение);
	КонецЦикла;
	
	Если СтруктураДанных.ПараметрыЗапроса.ОтражениеВРеглУчете Тогда
		// Отборы по умолчанию
		СтруктураПараметров.Вставить("НачалоПериода", Дата(1,1,1));
		СтруктураПараметров.Вставить("КонецПериода", КонецМесяца(ТекущаяДатаСеанса()));
		СтруктураПараметров.Вставить("МассивОрганизаций", Справочники.Организации.ДоступныеОрганизации(Истина));
	КонецЕсли;
	
КонецПроцедуры

// Устанавливает параметры запроса детализации партий НДС.
// 
// Параметры:
//  Запрос - Запрос - запрос формирования детализации партий НДС.
//  ОтражениеВРеглУчете - Булево - признак вызова из механизма формрования проводок
//
Процедура ИнициализироватьДополнительныеПараметрыЗапросаДетализацииПартийНДС(Запрос, СтруктураДанных)
	
	СтруктураПараметров = Новый Структура;
	ДополнитьСтруктуруПараметровДляДетализацииПартийНДС(СтруктураПараметров, СтруктураДанных);
	
	Для Каждого КлючИЗначение Из СтруктураПараметров Цикл
		Запрос.УстановитьПараметр(КлючИЗначение.Ключ, КлючИЗначение.Значение);
	КонецЦикла;
	
КонецПроцедуры


Функция ИнициализироватьСтруктуруДанныхДетализацииПартийНДСДляУчетаНДС() Экспорт
	
	СтруктураДанных = ИнициализироватьСтруктуруДанныхДетализацииПартийНДС(0);
	
	Возврат СтруктураДанных;
	
КонецФункции

Функция ИнициализироватьСтруктуруДанныхДетализацииПартийНДС(КодПотребителя = Неопределено)
	
	ПараметрыЗапроса = Новый Структура;
	ПараметрыЗапроса.Вставить("ОтражениеВУчетеНДС",  КодПотребителя = 0);
	ПараметрыЗапроса.Вставить("ОтражениеВРеглУчете", КодПотребителя = 1);
	
	СтруктураДанных = Новый Структура;
	СтруктураДанных.Вставить("ПараметрыЗапроса", ПараметрыЗапроса);
	СтруктураДанных.Вставить("ИмяДокумента", 	 Неопределено);
	СтруктураДанных.Вставить("Измерения", 		 Неопределено);
	СтруктураДанных.Вставить("Ресурсы", 		 Неопределено);
	СтруктураДанных.Вставить("Индексы", 		 "Регистратор");
	
	Возврат СтруктураДанных;
	
КонецФункции

#КонецОбласти

//-- Локализация

#Область ПоследовательностиРасчета

//++ Локализация

// Устанавливает признак необходимости распределению НДС и формирования записей книги покупок/продаж в указанном периоде.
//
Процедура СформироватьЗаданияДляМеханизмовУчетаНДСПартионныйУчет21(РассчитанныйПериод, МассивОрганизаций, ОкончаниеРасчета = Истина) Экспорт
	
	ТекстЗапроса = "";
	ШаблонТекстаЗапроса = "
	|%1
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Организация КАК Организация,
	|	%2
	|	%3
	|	Т.НалогообложениеНДС КАК КорВидДеятельностиНДС
	|ИЗ 
	|	РегистрНакопления.%4 КАК Т
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В (&МассивОрганизаций)
	|	И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И Т.Активность
	|	%5
	|";
	
	ПартионныеРегистры = Новый Соответствие;
	ПартионныеРегистры.Вставить(Метаданные.РегистрыНакопления.ПартииТоваровОрганизаций, 			"ДокументПоступления");
	ПартионныеРегистры.Вставить(Метаданные.РегистрыНакопления.ПартииТоваровПереданныеНаКомиссию, 	"ДокументПоступления");
	ПартионныеРегистры.Вставить(Метаданные.РегистрыНакопления.ПартииРасходовНаСебестоимостьТоваров, "ДокументПоступления");
	ПартионныеРегистры.Вставить(Метаданные.РегистрыНакопления.ПартииПроизводственныхЗатрат, 		"ДокументПоступления");
	ПартионныеРегистры.Вставить(Метаданные.РегистрыНакопления.ПартииЗатратНаВыпуск, 				"ДокументПоступления");
	ПартионныеРегистры.Вставить(Метаданные.РегистрыНакопления.ПартииПрочихРасходов, 				"ДокументПоступленияРасходов");
	
	Для Каждого КлючИЗначение Из ПартионныеРегистры Цикл
		
		ОбслуживаемыйРегистр = КлючИЗначение.Ключ; // ОбъектМетаданныхРегистрНакопления
		ИмяПоляРегистра = КлючИЗначение.Значение; // Строка
		
		ТекстЗапроса = ТекстЗапроса
			+ СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				ШаблонТекстаЗапроса,
				?(ТекстЗапроса = "", "", "ОБЪЕДИНИТЬ ВСЕ"),
				?(ОкончаниеРасчета, "ЕСТЬNULL(Т.АналитикаУчетаПартий.НалогообложениеНДС, ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)) КАК ВидДеятельностиНДС,", ""),
				?(ОкончаниеРасчета, "Т." + ИмяПоляРегистра + " КАК СчетФактура,", ""),
				ОбслуживаемыйРегистр.Имя,
				?(ОбслуживаемыйРегистр = Метаданные.РегистрыНакопления.ПартииПрочихРасходов, "И НЕ Т.Регистратор ССЫЛКА Документ.РаспределениеНДС", ""));
		
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
	Запрос.УстановитьПараметр("НачалоПериода",     НачалоМесяца(РассчитанныйПериод));
	Запрос.УстановитьПараметр("КонецПериода",      КонецМесяца(РассчитанныйПериод));
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	&НачалоПериода КАК Период,
	|	Т.Организация,
	|	%1
	|	%2
	|	Т.КорВидДеятельностиНДС
	|ПОМЕСТИТЬ ВтИзменениеПартий
	|ИЗ
	|(%3) КАК Т";
	
	Запрос.Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		Запрос.Текст,
		?(ОкончаниеРасчета, "Т.ВидДеятельностиНДС,", ""),
		?(ОкончаниеРасчета, "Т.СчетФактура,", ""),
		СокрЛП(ТекстЗапроса));
	
	Запрос.Выполнить();
	
	Если РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(Запрос, "ВтИзменениеПартий") = 0 Тогда
		Возврат;
	КонецЕсли;
	
	УчетНДСЛокализация.СформироватьЗаданияДляРаспределенияНДС(Запрос.МенеджерВременныхТаблиц);
	
	Если ОкончаниеРасчета Тогда
		УчетНДСЛокализация.СформироватьЗаданияДляФормированияКнигиПокупокПродаж(Запрос.МенеджерВременныхТаблиц);
	КонецЕсли;
	
КонецПроцедуры

// Подготавливает данные для формирования записей книги покупок/продаж в указанном периоде.
// Для этого необходимо собрать данные регистров НДС из ИБ до начала записи сформированных при расчете движений.
//
Процедура ПодготовитьДанныеДляФормированияЗаданийДляМеханизмовУчетаНДСПартионныйУчет22(ПараметрыРасчета) Экспорт
	
	Если ПараметрыРасчета.ВариантРасчета <> Перечисления.ВариантыРасчетаПартийИСебестоимости.ПартииИСебестоимость Тогда
		Возврат;
	КонецЕсли;
	
	Если РасчетСебестоимостиПрикладныеАлгоритмы.ВременнаяТаблицаСуществует(ПараметрыРасчета, "ВтСтарыеДанныеДляМеханизмовУчетаНДС") Тогда
		Возврат;
	КонецЕсли;
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "ПодготовитьДанныеДляФормированияЗаданийДляМеханизмовУчетаНДСПартионныйУчет22");
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.ИсходныеЗаданияКРасчетуСебестоимости;
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Документ
	|ИЗ
	|	ИсходныеЗадания КАК Т
	|ГДЕ
	|	Т.Документ <> НЕОПРЕДЕЛЕНО";
	
	ТаблицаДокументы = Запрос.Выполнить().Выгрузить();
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.УстановитьПараметр("ТаблицаДокументы", ТаблицаДокументы);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.Документ
	|ПОМЕСТИТЬ ВТДокументыИзЗаданийКРасчетуСебестоимости
	|ИЗ
	|	&ТаблицаДокументы КАК Т
	|ИНДЕКСИРОВАТЬ ПО
	|	Документ
	|
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.КорВидДеятельностиНДС,
	|	ИСТИНА КАК ДвиженияТекущегоПериода
	|ПОМЕСТИТЬ ВТДвиженияСебестоимостиДляФормированияЗаданий
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|	И Т.Активность
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.КорВидДеятельностиНДС,
	|	ЛОЖЬ КАК ДвиженияТекущегоПериода
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыИзЗаданийКРасчетуСебестоимости КАК Отбор
	|		ПО Т.Регистратор = Отбор.Документ
	|ГДЕ
	|	Т.Период > &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|	И Т.Активность
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаНоменклатуры,
	|	Организация
	|
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.КорВидДеятельностиНДС,
	|	ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Номенклатура КАК Номенклатура,
	|	ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Характеристика КАК Характеристика
	|ПОМЕСТИТЬ ВТДвиженияСебестоимостиДляФормированияЗаданийСНоменклатурой
	|ИЗ
	|	ВТДвиженияСебестоимостиДляФормированияЗаданий КАК Т
	|ГДЕ
	|	Т.ДвиженияТекущегоПериода
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия,
	|	Организация,
	|	Номенклатура
	|
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.ДокументПоступления
	|ПОМЕСТИТЬ ВТДвиженияПартийНДСДляФормированияЗаданий
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиТоваров КАК Т
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|	И (Т.СтоимостьБезНДС <> 0 ИЛИ Т.НДС <> 0 ИЛИ Т.НДСУпр <> 0)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.ДокументПоступления
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиТоваровПостатейныеЗатраты КАК Т
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|	И (Т.СтоимостьБезНДС <> 0 ИЛИ Т.НДСРегл <> 0 ИЛИ Т.НДСУпр <> 0)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаНоменклатуры,
	|	Организация
	|
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Организация КАК Организация,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Т.КорВидДеятельностиНДС КАК КорВидДеятельностиНДС,
	|	Т.СчетФактура КАК СчетФактура
	|ПОМЕСТИТЬ ВтСтарыеДанныеДляМеханизмовУчетаНДС
	|ИЗ
	|	(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация КАК Организация,
	|		Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|		Т.КорВидДеятельностиНДС КАК КорВидДеятельностиНДС,
	|		Т.ДокументПоступления КАК СчетФактура
	|	ИЗ
	|		РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН КАК Т
	|	ГДЕ
	|		Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Т.Организация В(&МассивОрганизаций)
	|		И (Т.СтоимостьБезНДС <> 0 ИЛИ Т.НДС <> 0 ИЛИ Т.НДСУпр <> 0)
	|		И Т.Активность
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		Т.ВидДеятельностиНДС,
	|		Т.КорВидДеятельностиНДС,
	|		Т.ДокументПоступления
	|	ИЗ
	|		РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН2_4 КАК Т
	|	ГДЕ
	|		Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Т.Организация В(&МассивОрганизаций)
	|		И (Т.СтоимостьБезНДС <> 0 ИЛИ Т.НДС <> 0 ИЛИ Т.НДСУпр <> 0)
	|		И Т.Активность
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		Т.ВидДеятельностиНДС,
	|		Т.КорВидДеятельностиНДС,
	|		Цены.ДокументПоступления
	|	ИЗ
	|		ВТДвиженияСебестоимостиДляФормированияЗаданий КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДвиженияПартийНДСДляФормированияЗаданий КАК Цены
	|		ПО (Цены.АналитикаУчетаНоменклатуры = Т.АналитикаУчетаНоменклатуры)
	|			И (Цены.Организация = Т.Организация)
	|			И (Цены.Партия = Т.Партия)
	|			И (Цены.РазделУчета = Т.РазделУчета)
	|			И (Цены.ВидЗапасов = Т.ВидЗапасов)
	|			И (Цены.АналитикаУчетаПартий = Т.АналитикаУчетаПартий)
	|			И (Цены.ВидДеятельностиНДС = Т.ВидДеятельностиНДС)
	|			И (Цены.АналитикаФинансовогоУчета = Т.АналитикаФинансовогоУчета)
	|			И  Т.ДвиженияТекущегоПериода
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		Т.ВидДеятельностиНДС,
	|		Т.КорВидДеятельностиНДС,
	|		Цены.ДокументПоступления
	|	ИЗ
	|		ВТДвиженияСебестоимостиДляФормированияЗаданий КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДвиженияПартийНДСДляФормированияЗаданий КАК Цены
	|		ПО (Цены.АналитикаУчетаНоменклатуры = Т.АналитикаУчетаНоменклатуры)
	|			И (Цены.Организация = Т.Организация)
	|			И (Цены.РазделУчета = Т.РазделУчета)
	|			И (Цены.ВидЗапасов = Т.ВидЗапасов)
	|			И  НЕ Т.ДвиженияТекущегоПериода
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		Т.ВидДеятельностиНДС,
	|		Т.КорВидДеятельностиНДС,
	|		Цены.ДокументПоступления
	|	ИЗ
	|		ВТДвиженияСебестоимостиДляФормированияЗаданийСНоменклатурой КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ДетализацияСебестоимостиПартииТоваров КАК Цены
	|		ПО (Цены.Партия = Т.Партия)
	|			И (Цены.Организация = Т.Организация)
	|			И (Цены.Номенклатура = Т.Номенклатура)
	|			И (Цены.Характеристика = Т.Характеристика)
	|			И (Цены.АналитикаУчетаПартий = Т.АналитикаУчетаПартий)
	|			И (Цены.ВидЗапасов = Т.ВидЗапасов)
	|			И (Цены.ПериодРегистрации <= &НачалоПериода)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		Т.ВидДеятельностиНДС,
	|		Т.КорВидДеятельностиНДС,
	|		Цены.ДокументПоступления
	|	ИЗ
	|		ВТДвиженияСебестоимостиДляФормированияЗаданийСНоменклатурой КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты КАК Цены
	|		ПО (Цены.Партия = Т.Партия)
	|			И (Цены.Организация = Т.Организация)
	|			И (Цены.Номенклатура = Т.Номенклатура)
	|			И (Цены.Характеристика = Т.Характеристика)
	|			И (Цены.АналитикаУчетаПартий = Т.АналитикаУчетаПартий)
	|			И (Цены.ВидЗапасов = Т.ВидЗапасов)
	|			И (Цены.ПериодРегистрации <= &НачалоПериода)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		Т.ВидДеятельностиНДС,
	|		Т.КорВидДеятельностиНДС,
	|		Т.ДокументПоступления
	|	ИЗ
	|		РегистрСведений.ДетализацияСебестоимостиТоваровПостатейныеЗатратыНЗП КАК Т
	|	ГДЕ
	|		Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Т.Организация В(&МассивОрганизаций)
	|		И (Т.СтоимостьБезНДС <> 0 ИЛИ Т.НДС <> 0 ИЛИ Т.НДСУпр <> 0)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		ЕСТЬNULL(Т.АналитикаУчетаПартий.НалогообложениеНДС, ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)),
	|		Т.НалогообложениеНДС,
	|		Т.ДокументПоступленияРасходов
	|	ИЗ
	|		РегистрНакопления.ПартииПрочихРасходов КАК Т
	|	ГДЕ
	|		Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Т.Организация В(&МассивОрганизаций)
	|		И НЕ Т.Регистратор ССЫЛКА Документ.РаспределениеНДС
	|		И (Т.СтоимостьРегл <> 0 ИЛИ Т.НДСРегл <> 0 ИЛИ Т.НДСУпр <> 0)
	|		И Т.Активность
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		Т.ВидДеятельностиНДС,
	|		Т.КорВидДеятельностиНДС,
	|		Т.СчетФактура
	|	ИЗ
	|		РегистрНакопления.НДСПредъявленный КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыИзЗаданийКРасчетуСебестоимости КАК Отбор
	|			ПО Т.Регистратор = Отбор.Документ
	|	ГДЕ
	|		Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Т.Организация В(&МассивОрганизаций)
	|		И НЕ Т.Регистратор ССЫЛКА Документ.РаспределениеНДС
	|		И Т.Активность
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		Т.ВидДеятельностиНДС,
	|		Т.КорВидДеятельностиНДС,
	|		Т.ДокументПоступленияРасходов
	|	ИЗ
	|		РегистрНакопления.ПартииНДСКРаспределению КАК Т
	|	ГДЕ
	|		Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Т.Организация В(&МассивОрганизаций)
	|		И НЕ Т.Регистратор ССЫЛКА Документ.РаспределениеНДС
	|		И (Т.СтоимостьРегл <> 0 ИЛИ Т.НДСРегл <> 0 ИЛИ Т.НДСУпр <> 0)
	|		И Т.Активность
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		Т.ВидДеятельностиНДС,
	|		Т.КорВидДеятельностиНДС,
	|		Т.ДокументПоступленияРасходов
	|	ИЗ
	|		РегистрНакопления.ПартииНДСКРаспределению КАК Т
	|	ГДЕ
	|		Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Т.Организация В(&МассивОрганизаций)
	|		И НЕ Т.Регистратор ССЫЛКА Документ.РаспределениеНДС
	|		И (Т.СтоимостьРегл <> 0 ИЛИ Т.НДСРегл <> 0 ИЛИ Т.НДСУпр <> 0)
	|		И Т.Активность
	|	) КАК Т";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"ВТДокументыИзЗаданийКРасчетуСебестоимости, ВТДвиженияСебестоимостиДляФормированияЗаданий, ВТДвиженияПартийНДСДляФормированияЗаданий");
	
КонецПроцедуры

//-- Локализация

// Устанавливает признак необходимости распределению НДС и формирования записей книги покупок/продаж в указанном периоде.
//
Процедура СформироватьЗаданияДляМеханизмовУчетаНДСПартионныйУчет22(ПараметрыРасчета) Экспорт
	
	Если ПараметрыРасчета.ВариантРасчета <> Перечисления.ВариантыРасчетаПартийИСебестоимости.ПартииИСебестоимость Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ПараметрыРасчета.ОграниченияВыборки.КоличествоЗаписейВНЗ) Тогда
		// Для отладки - расчет без изменения данных ИБ
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Организация,
	|	Т.ВидДеятельностиНДС,
	|	ВЫБОР
	|		КОГДА Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|			И НЕ ЕСТЬNULL(СтатьиРасходов.ПринятиеКНалоговомуУчету, ИСТИНА) И ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
	|			И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|		ИНАЧЕ Т.КорВидДеятельностиНДС
	|	КОНЕЦ КАК КорВидДеятельностиНДС,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидЗапасов,
	|	Т.АналитикаУчетаНоменклатуры,
	|	ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Номенклатура КАК Номенклатура,
	|	ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Характеристика КАК Характеристика
	|ПОМЕСТИТЬ ВтСебестоимостьДляФормированияЗаданий
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходов
	|		ПО СтатьиРасходов.Ссылка = Т.СтатьяРасходовСписания
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТНастройкиУчетаНДС КАК НастройкиУчетаНДС
	|		ПО НастройкиУчетаНДС.Организация = Т.Организация
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия,
	|	Т.Организация,
	|	Номенклатура
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	&НачалоПериода КАК Период,
	|	Т.Организация КАК Организация,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Т.КорВидДеятельностиНДС КАК КорВидДеятельностиНДС,
	|	Т.СчетФактура КАК СчетФактура
	|ПОМЕСТИТЬ ВтИзменениеПартий
	|ИЗ
	|	(
	//++ Локализация
	|	 ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация КАК Организация,
	|		Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|		Т.КорВидДеятельностиНДС КАК КорВидДеятельностиНДС,
	|		Т.ДокументПоступления КАК СчетФактура
	|	ИЗ
	|		ВТКэшДетализацияПартийТоваровДляНДСиУСН КАК Т
	|	ГДЕ
	|		Т.СтоимостьБезНДС <> 0 ИЛИ Т.НДС <> 0 ИЛИ Т.НДСУпр <> 0
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	//-- Локализация
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		Т.ВидДеятельностиНДС,
	|		Т.КорВидДеятельностиНДС,
	|		Цены.ДокументПоступления КАК СчетФактура
	|	ИЗ
	|		ВтСебестоимостьДляФормированияЗаданий КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТКэшДетализацияСебестоимостиПартииТоваров КАК Цены
	|		ПО (Цены.Партия = Т.Партия)
	|			И (Цены.Организация = Т.Организация)
	|			И (Цены.Номенклатура = Т.Номенклатура)
	|			И (Цены.Характеристика = Т.Характеристика)
	|			И (Цены.АналитикаУчетаПартий = Т.АналитикаУчетаПартий)
	|			И (Цены.ВидЗапасов = Т.ВидЗапасов)
	|	ГДЕ
	|		Цены.СтоимостьБезНДСРегл <> 0 ИЛИ Цены.НДСРегл <> 0 ИЛИ Цены.НДСУпр <> 0
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		Т.ВидДеятельностиНДС,
	|		Т.КорВидДеятельностиНДС,
	|		Цены.ДокументПоступления
	|	ИЗ
	|		ВтСебестоимостьДляФормированияЗаданий КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ДетализацияСебестоимостиПартииТоваров КАК Цены
	|		ПО (Цены.Партия = Т.Партия)
	|			И (Цены.Организация = Т.Организация)
	|			И (Цены.Номенклатура = Т.Номенклатура)
	|			И (Цены.Характеристика = Т.Характеристика)
	|			И (Цены.АналитикаУчетаПартий = Т.АналитикаУчетаПартий)
	|			И (Цены.ВидЗапасов = Т.ВидЗапасов)
	|			И (Цены.ПериодРегистрации < &НачалоПериода)
	|	ГДЕ
	|		(Цены.СтоимостьБезНДСРегл <> 0 ИЛИ Цены.НДСРегл <> 0 ИЛИ Цены.НДСУпр <> 0)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		Т.ВидДеятельностиНДС,
	|		Т.КорВидДеятельностиНДС,
	|		Цены.ДокументПоступления
	|	ИЗ
	|		ВтСебестоимостьДляФормированияЗаданий КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТКэшДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты КАК Цены
	|		ПО (Цены.Партия = Т.Партия)
	|			И (Цены.Организация = Т.Организация)
	|			И (Цены.Номенклатура = Т.Номенклатура)
	|			И (Цены.Характеристика = Т.Характеристика)
	|			И (Цены.АналитикаУчетаПартий = Т.АналитикаУчетаПартий)
	|			И (Цены.ВидЗапасов = Т.ВидЗапасов)
	|	ГДЕ
	|		Цены.СтоимостьБезНДСРегл <> 0 ИЛИ Цены.НДСРегл <> 0 ИЛИ Цены.НДСУпр <> 0
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		Т.ВидДеятельностиНДС,
	|		Т.КорВидДеятельностиНДС,
	|		Цены.ДокументПоступления
	|	ИЗ
	|		ВтСебестоимостьДляФормированияЗаданий КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты КАК Цены
	|		ПО (Цены.Партия = Т.Партия)
	|			И (Цены.Организация = Т.Организация)
	|			И (Цены.Номенклатура = Т.Номенклатура)
	|			И (Цены.Характеристика = Т.Характеристика)
	|			И (Цены.АналитикаУчетаПартий = Т.АналитикаУчетаПартий)
	|			И (Цены.ВидЗапасов = Т.ВидЗапасов)
	|			И (Цены.ПериодРегистрации < &НачалоПериода)
	|	ГДЕ
	|		(Цены.СтоимостьБезНДСРегл <> 0 ИЛИ Цены.НДСРегл <> 0 ИЛИ Цены.НДСУпр <> 0)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		Т.ВидДеятельностиНДС,
	|		Т.КорВидДеятельностиНДС,
	|		Цены.ДокументПоступления
	|	ИЗ
	|		ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТКэшДетализацияСебестоимостиТоваровПостатейныеЗатраты КАК Цены
	|		ПО (Цены.Партия = Т.Партия)
	|			И (Цены.Организация = Т.Организация)
	|			И (Цены.АналитикаУчетаНоменклатуры = Т.АналитикаУчетаНоменклатуры)
	|			И (Цены.АналитикаУчетаПартий = Т.АналитикаУчетаПартий)
	|			И (Цены.ВидЗапасов = Т.ВидЗапасов)
	|			И (Цены.РазделУчета = Т.РазделУчета)
	|			И (Цены.ВидДеятельностиНДС = Т.ВидДеятельностиНДС)
	|			И (Цены.АналитикаФинансовогоУчета = Т.АналитикаФинансовогоУчета)
	|	ГДЕ
	|		(Цены.СтоимостьБезНДСРегл <> 0 ИЛИ Цены.НДСРегл <> 0 ИЛИ Цены.НДСУпр <> 0)
	|	
	
	//++ Локализация
	
	 
	//-- Локализация
	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		ЕСТЬNULL(Т.АналитикаУчетаПартий.НалогообложениеНДС, ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)),
	|		Т.НалогообложениеНДС,
	|		Т.ДокументПоступленияРасходов
	|	ИЗ
	|		ВТКэшПартииПрочихРасходов КАК Т
	|	ГДЕ
	|		Т.СтоимостьРегл <> 0 ИЛИ Т.НДСРегл <> 0 ИЛИ Т.НДСУпр <> 0
	|
	//++ Локализация
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		Т.ВидДеятельностиНДС,
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением),
	|		Т.ДокументПоступленияРасходов
	|	ИЗ
	|		ВТКэшПартииНДСКРаспределению КАК Т
	|	ГДЕ
	|		Т.СтоимостьРегл <> 0 ИЛИ Т.НДСРегл <> 0 ИЛИ Т.НДСУпр <> 0
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		Т.ВидДеятельностиНДС,
	|		Т.КорВидДеятельностиНДС,
	|		Т.СчетФактура
	|	ИЗ
	|		ВтСтарыеДанныеДляМеханизмовУчетаНДС КАК Т
	//-- Локализация
	|	) КАК Т
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	СчетФактура,
	|	Период
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
	
	Если РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(Запрос, "ВтИзменениеПартий") > 0 Тогда
		
		//++ Локализация
		УчетНДСЛокализация.СформироватьЗаданияДляРаспределенияНДС(Запрос.МенеджерВременныхТаблиц);
		//-- Локализация
		
		ПараметрыОтраженияВУчете = РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьПараметрыОтраженияВУчете(
			ПараметрыРасчета,
			НСтр("ru = 'Отражение в книге покупок и продаж'", ОбщегоНазначения.КодОсновногоЯзыка()),
			"УчетНДСЛокализация.СформироватьЗаданияДляФормированияКнигиПокупокПродаж",
			"ВтИзменениеПартий",
			Ложь,
			"Организация, СчетФактура, Период");
			
		РасчетСебестоимостиПрикладныеАлгоритмы.ОтразитьДокументыВУчете(ПараметрыРасчета, ПараметрыОтраженияВУчете);
		
	КонецЕсли;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(
		ПараметрыРасчета,
		"ВтСебестоимостьДляФормированияЗаданий, ВтСтарыеДанныеДляМеханизмовУчетаНДС, ВтИзменениеПартий");
	
КонецПроцедуры

#КонецОбласти

//++ Локализация

#Область СостояниеОперацииЗакрытияМесяца

Процедура Использование_РасчетПартийИСебестоимости(ПараметрыОбработчика) Экспорт
	
	ПараметрыРасчета = ПараметрыОбработчика.ПараметрыРасчета;
	ПериодРасчета    = ПараметрыРасчета.ПериодРегистрации;
	МассивОрганизаций = ПараметрыОбработчика.ДанныеЭтапа.МассивОрганизаций;
	
	ПериодПересчетаПартийНДС = ПроверкаНеобходимостьПересчетаРегистраПартийНДС(ПараметрыРасчета);
	
	Если ЗначениеЗаполнено(ПериодПересчетаПартийНДС) Тогда
		
		ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru='Обнаружены некорректные движения по регистру ""%1"" за период %2.
				|Необходимо выполнить закрытие месяца начиная с данного периода.'", ОбщегоНазначения.КодОсновногоЯзыка()),
			Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН2_4.Синоним,
			РасчетСебестоимостиПротоколРасчета.ПредставлениеПериодаРасчета(ПериодПересчетаПартийНДС));
		
		ЗакрытиеМесяцаСервер.ДобавитьПоясняющуюИнформациюКЭтапу(
			ПараметрыОбработчика,
			ТекстОшибки,
			,
			,
			Перечисления.ВажностьПроблемыУчета.Ошибка);
		
	КонецЕсли;
	
	ОрганизацииСДвижениямиПоСебестоимости = РасчетСебестоимостиПрикладныеАлгоритмы.ОрганизацииСДвижениямиПоСебестоимости(
		ПериодРасчета,
		МассивОрганизаций);
	
	СостояниеКорректировкиНДС = СостояниеКорректировкиНДС(ПериодРасчета, МассивОрганизаций);
	
	ЗакрытиеМесяцаСервер.УвеличитьКоличествоОбработанныхДанныхДляЗамера(ПараметрыОбработчика, 1);
	
	Если СостояниеКорректировкиНДС = Перечисления.СостоянияОперацийЗакрытияМесяца.НеВыполнено Тогда
		
		ЗакрытиеМесяцаСервер.УстановитьСостояниеНеВыполнен(
			ПараметрыОбработчика,
			НСтр("ru='Требуется выполнить корректировку налогообложения НДС.'", ОбщегоНазначения.КодОсновногоЯзыка()));
		Возврат;
		
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ОрганизацииСДвижениямиПоСебестоимости)
 	 И СостояниеКорректировкиНДС = Перечисления.СостоянияОперацийЗакрытияМесяца.НеТребуется Тогда
		
		ЗакрытиеМесяцаСервер.УстановитьСостояниеНеТребуется(
			ПараметрыОбработчика,
			НСтр("ru='Нет движений по регистрам себестоимости и прочих расходов.'", ОбщегоНазначения.КодОсновногоЯзыка()));
		Возврат;
		
	КонецЕсли;
	
КонецПроцедуры

// Возвращает текущее состояние корректировки налогообложения НДС.
//
// Возвращаемое значение:
//	ПеречислениеСсылка.СостоянияОперацийЗакрытияМесяца -
//
Функция СостояниеКорректировкиНДС(ПериодРасчета, МассивОрганизаций) Экспорт
	
	НеТребуетсяКорректировкаНДС = Истина;
	ВыполненаКорректировкаНДС	= Истина;
	
	Если РасчетСебестоимостиПовтИсп.ПартионныйУчетВерсии21(НачалоМесяца(ПериодРасчета))
	 И КонецКвартала(ПериодРасчета) = КонецМесяца(ПериодРасчета) Тогда
		
		НачалоСледНалПериода = КонецМесяца(ПериодРасчета) + 1;
		
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("НачалоПериода", 	   		 НачалоМесяца(ПериодРасчета));
		Запрос.УстановитьПараметр("КонецПериода",  	   		 КонецМесяца(ПериодРасчета));
		Запрос.УстановитьПараметр("МассивОрганизаций", 		 МассивОрганизаций);
		Запрос.УстановитьПараметр("ГраницаКонецПериода", 	 Новый Граница(КонецМесяца(ПериодРасчета), ВидГраницы.Исключая));
		Запрос.УстановитьПараметр("НачалоПериодаМинус3Года", ДобавитьМесяц(НачалоСледНалПериода, -36));
		Запрос.УстановитьПараметр("КонецПериодаМинус3Года",  ДобавитьМесяц(КонецКвартала(НачалоСледНалПериода), -36));
		
		// Необходимость корректировки НДС проверяем по наборам аналитик
		Запрос.Текст =
		"ВЫБРАТЬ
		|	Партии.Организация,
		|	Партии.АналитикаУчетаНоменклатуры,
		|	Партии.ДокументПоступления,
		|	Партии.ВидЗапасов,
		|	Партии.АналитикаУчетаПартий,
		|	СУММА(Партии.КоличествоОстаток) КАК КоличествоОстаток,
		|	СУММА(Партии.Количество) КАК Количество
		|ПОМЕСТИТЬ ВТПартии
		|ИЗ
		// Регистры, используемые только в партионном учете версии 2.1
		|	(ВЫБРАТЬ
		|		Остатки.Организация						КАК Организация,
		|		Остатки.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
		|		Остатки.ДокументПоступления				КАК ДокументПоступления,
		|		Остатки.ВидЗапасов						КАК ВидЗапасов,
		|		Остатки.АналитикаУчетаПартий			КАК АналитикаУчетаПартий,
		|		Остатки.КоличествоОстаток				КАК КоличествоОстаток,
		|		Остатки.КоличествоОстаток				КАК Количество
		|	ИЗ
		|		РегистрНакопления.ПартииТоваровОрганизаций.Остатки(
		|				&ГраницаКонецПериода,
		|				АналитикаУчетаПартий.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПоФактическомуИспользованию)
		|				И Организация В(&МассивОрганизаций)
		|		) КАК Остатки
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
		|			ПО Остатки.ДокументПоступления = ДанныеПервичныхДокументов.Документ
		|	ГДЕ
		|		ДанныеПервичныхДокументов.ДатаРегистратора МЕЖДУ &НачалоПериодаМинус3Года И &КонецПериодаМинус3Года
		|		И Остатки.КоличествоОстаток > 0
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		Остатки.Организация						КАК Организация,
		|		Остатки.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
		|		Остатки.ДокументПоступления				КАК ДокументПоступления,
		|		Остатки.ВидЗапасов						КАК ВидЗапасов,
		|		Остатки.АналитикаУчетаПартий			КАК АналитикаУчетаПартий,
		|		0										КАК КоличествоОстаток,
		|		Остатки.Количество						КАК Количество
		|	ИЗ
		|		РегистрНакопления.ПартииТоваровОрганизаций КАК Остатки
		|	ГДЕ
		|		Остатки.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|		И Остатки.Организация В(&МассивОрганизаций)
		|		И Остатки.Активность
		|		И Остатки.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|		И Остатки.Регистратор ССЫЛКА Документ.КорректировкаНалогообложенияНДСПартийТоваров
		|		И Остатки.ДокументПоступления.Дата МЕЖДУ &НачалоПериодаМинус3Года И &КонецПериодаМинус3Года
		|	) КАК Партии
		|
		|СГРУППИРОВАТЬ ПО
		|	Партии.Организация,
		|	Партии.АналитикаУчетаНоменклатуры,
		|	Партии.ДокументПоступления,
		|	Партии.ВидЗапасов,
		|	Партии.АналитикаУчетаПартий
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	МИНИМУМ(Партии.КоличествоОстаток) КАК КоличествоОстаток,
		|	МАКСИМУМ(Партии.Количество) КАК Количество
		|ИЗ
		|	ВТПартии КАК Партии";
		
		Выборка = Запрос.Выполнить().Выбрать();
		Выборка.Следующий();
		
		НеТребуетсяКорректировкаНДС = (Выборка.Количество = NULL ИЛИ Выборка.Количество <= 0);
		ВыполненаКорректировкаНДС   = НеТребуетсяКорректировкаНДС ИЛИ (Выборка.КоличествоОстаток <> NULL И Выборка.КоличествоОстаток > 0);
		
	КонецЕсли;
	
	Если НеТребуетсяКорректировкаНДС Тогда
		Состояние = Перечисления.СостоянияОперацийЗакрытияМесяца.НеТребуется;
	ИначеЕсли ВыполненаКорректировкаНДС Тогда
		Состояние = Перечисления.СостоянияОперацийЗакрытияМесяца.ВыполненоУспешно;
	Иначе
		Состояние = Перечисления.СостоянияОперацийЗакрытияМесяца.НеВыполнено;
	КонецЕсли;
	
	Возврат Состояние;
	
КонецФункции

#КонецОбласти

//-- Локализация

#Область АнализСостоянияСистемы

// Заполняет проверки, выполняемые в рамках расчета партий и себестоимости.
//
// Параметры:
//	ТаблицаПроверок - см. АудитСостоянияСистемы.ТаблицаПроверокСостоянияСистемы
//
Процедура ЗаполнитьПроверкиДляРегистрации(ТаблицаПроверок) Экспорт
	
	// Соответствие остатков в регистрах СебестоимостьТоваров и ДетализацияПартийТоваровДляНДСиУСН.
	// Технологическая проверка для автотестов, см. технологический параметр "ПроверятьСоответствиеСебестоимостиИПартийНДС".
	ОписаниеПроверки = ЗакрытиеМесяцаСервер.ДобавитьОписаниеНовойПроверки(ТаблицаПроверок,
		"СоответствиеРегистровСебестоимостиИПартийНДС",
		Перечисления.ОперацииЗакрытияМесяца.РасчетПартийИСебестоимости,
		Перечисления.МоментЗапускаПроверкиОперацииЗакрытияМесяца.ПослеРасчета,
		"РасчетСебестоимостиНДС.ПроверкаСоответствияРегистровСебестоимостиИПартийНДС",
		Перечисления.ВажностьПроблемыУчета.Ошибка);
	
	ОписаниеПроверки.ВозможноИзменениеВажности = Истина;
	
	ЗакрытиеМесяцаСервер.ЗаполнитьПредставлениеНовойПроверки(ОписаниеПроверки,
		НСтр("ru='Соответствие остатков в регистрах себестоимости и партий НДС.'", ОбщегоНазначения.КодОсновногоЯзыка()),
		НСтр("ru='Остатки по регистру ""Детализация партий товаров для НДС и УСН"" должны соответствовать остаткам по регистру ""Себестоимость товаров"":
			|- остатки по количеству в регистре партий НДС не должны превышать остатки по количеству в регистре себестоимости
			|- не должно быть остатков по суммам регл. (Стоимость без НДС + НДС) в регистре партий НДС при отсутствии остатков по суммам регл. в регистре себестоимости (Стоимость регл + Доп расходы регл)
			|- не должно быть остатков по суммам упр. в регистре партий НДС (НДС упр) при отсутствии остатков по суммам упр. в регистре себестоимости (Стоимость упр + Доп расходы упр)'", ОбщегоНазначения.КодОсновногоЯзыка()));
	
	// Соответствие остатков в регистрах ПрочиеРасходы и ПартииПрочихРасходов.
	// Технологическая проверка для автотестов, см. технологический параметр "ПроверятьСоответствиеПрочихРасходовИПартийПрочихРасходов".
	ОписаниеПроверки = ЗакрытиеМесяцаСервер.ДобавитьОписаниеНовойПроверки(ТаблицаПроверок,
		"СоответствиеРегистровПрочиеРасходыИПартийПрочихРасходов",
		Перечисления.ОперацииЗакрытияМесяца.РасчетПартийИСебестоимости,
		Перечисления.МоментЗапускаПроверкиОперацииЗакрытияМесяца.ПослеРасчета,
		"РасчетСебестоимостиНДС.ПроверкаСоответствияРегистровПрочиеРасходыИПартийПрочихРасходов",
		Перечисления.ВажностьПроблемыУчета.Ошибка);
	
	ОписаниеПроверки.ВозможноИзменениеВажности = Истина;
	
	ЗакрытиеМесяцаСервер.ЗаполнитьПредставлениеНовойПроверки(ОписаниеПроверки,
		НСтр("ru='Соответствие остатков в регистрах прочие расходы и партии прочих расходов.'", ОбщегоНазначения.КодОсновногоЯзыка()),
		НСтр("ru='Остатки по регистру ""Партии прочих расходов"" должны соответствовать остаткам по регистру ""Прочие расходы"":
			|- не должно быть остатков в регистре партий прочих расходов при отсутствии остатков по в регистре прочих расходов'", ОбщегоНазначения.КодОсновногоЯзыка()));
	
	// Проверка корректности данных в регистрах ДетализацияСебестоимостиПартииТоваров и ДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты.
	ОписаниеПроверки = ЗакрытиеМесяцаСервер.ДобавитьОписаниеНовойПроверки(ТаблицаПроверок,
		"КорректностьДанныхВРегистрахДетализацияСебестоимостиПартий",
		Перечисления.ОперацииЗакрытияМесяца.РасчетПартийИСебестоимости,
		Перечисления.МоментЗапускаПроверкиОперацииЗакрытияМесяца.ПослеРасчета,
		"РасчетСебестоимостиНДС.ПроверкаКорректностиДанныхВРегистрахДетализацияСебестоимостиПартий",
		Перечисления.ВажностьПроблемыУчета.Ошибка);
	
	ОписаниеПроверки.ВозможноИзменениеВажности = Истина;
	
	ЗакрытиеМесяцаСервер.ЗаполнитьПредставлениеНовойПроверки(ОписаниеПроверки,
		НСтр("ru='Корректность данных в регистрах детализации себестоимости партий товаров.'", ОбщегоНазначения.КодОсновногоЯзыка()),
		НСтр("ru='По одной партии не должно быть записей с разными периодами регистрации.
			|Затраты предыдущих переделов могут быть заполнены только для партий выпуска продукции и работ'", ОбщегоНазначения.КодОсновногоЯзыка()));
	
КонецПроцедуры

// Процедура-обработчик проверки состояния системы "СоответствиеРегистровСебестоимостиИПартийНДС".
//
// Параметры:
//	ПараметрыПроверки - см. АудитСостоянияСистемы.ИнициализироватьПараметрыПроверки
//
Процедура ПроверкаСоответствияРегистровСебестоимостиИПартийНДС(ПараметрыПроверки) Экспорт
	
	Если ПараметрыПроверки.ДополнительныеПараметры.РежимЗакрытияМесяца = Перечисления.РежимыЗакрытияМесяца.ПредварительноеЗакрытие Тогда
		Возврат;
	КонецЕсли;
	
	ЗначенияПараметров = РасчетСебестоимостиПовтИсп.ЗначенияТехнологическихПараметров();
	
	АвтоматическоеТестирование = ЗакрытиеМесяцаСервер.ЗначениеДополнительногоПараметраПроверки(
		ПараметрыПроверки,
		"АвтоматическоеТестирование",
		Ложь);
	
	// Проверка выполняется если явно включены соответствующие технологические параметры.
	Если НЕ ЗначенияПараметров.ПроверятьСоответствиеСебестоимостиИПартийНДС
	 И НЕ ЗначенияПараметров.ПроверятьСоответствиеСебестоимостиИПартийНДСФИФОСкользящая
	 И НЕ АвтоматическоеТестирование Тогда
		Возврат;
	КонецЕсли;
	
	ТекстЗапроса =
	ТекстЗапросаТаблицыДляОтбораАналитикУчетаПартийНДС2_4() + "
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|" + "
	|
	|ВЫБРАТЬ ПЕРВЫЕ 0
	|	Т.Ссылка
	|ПОМЕСТИТЬ ВТСтатьиПроизводственныхЗатрат
	|ИЗ
	|	ПланВидовХарактеристик.СтатьиРасходов КАК Т
	//++ Локализация
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Ссылка
	|ИЗ
	|	ПланВидовХарактеристик.СтатьиРасходов КАК Т
	|ГДЕ
	|	(Т.ВариантРаспределенияРасходовУпр В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства))
	|		ИЛИ Т.ВариантРаспределенияРасходовРегл В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства))
	|	)
	|	И Т.ВариантРаздельногоУчетаНДС <> ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
	//-- Локализация
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Т.КоличествоОстаток КАК Количество,
	|	Т.СтоимостьРеглОстаток + Т.ДопРасходыРеглОстаток КАК СтоимостьРегл,
	|	Т.СтоимостьУпрОстаток + Т.ДопРасходыУпрОстаток КАК СтоимостьУпр
	|ПОМЕСТИТЬ ВТСебестоимость
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров.Остатки(
	|		&ГраницаКонецПериода,
	|		Организация В (&МассивОрганизаций)
	|		И &ПартионныйУчетВерсии22
	
	|		И НЕ РазделУчета В (
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку),
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки))
	|	) КАК Т
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия,
	|	Организация,
	|	Номенклатура
	|;

	//++ Локализация
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Т.КоличествоОстаток КАК Количество,
	|	Т.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС
	|ПОМЕСТИТЬ ВТПартииНДС
	|ИЗ
	|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН.Остатки(
	|		&ГраницаКонецПериода,
	|		Организация В (&МассивОрганизаций)
	|		И Организация В (&ОрганизацииПоСредней)
	|		И &ПартионныйУчетВерсии22
	|		И &ПроверятьСоответствиеСебестоимостиИПартийНДС
	|		И НЕ РазделУчета В (
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку),
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки))
	|	) КАК Т
	|;
	//-- Локализация
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация КАК Организация,
	|	МАКСИМУМ(Т.ПериодРегистрации) КАК ПериодРегистрации
	|ПОМЕСТИТЬ ПериодПерехода
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиПартииТоваров КАК Т
	|ГДЕ
	|	Т.ПериодРегистрации <= &НачалоПериода
	|	И Т.ТипЗаписи В
	|		(ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СлужебноеПереходНаРегистрДетализацияСебестоимостиТоваров),
	|		 ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СлужебноеИзменениеМетодаОценкиСтоимости))
	|	И Т.Организация В (&МассивОрганизаций)
	|	И Т.Организация В (&ОрганизацииСФИФОСкользящая)
	|	И &ПартионныйУчетВерсии22
	|	И &ПроверятьСоответствиеСебестоимостиИПартийНДСФИФОСкользящая
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Организация КАК Организация,
	|	Т.ДокументПоступления КАК ДокументПоступления
	|ПОМЕСТИТЬ СтарыеДокументыПоступления
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиПартииТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПериодПерехода КАК Отбор
	|		ПО Т.Организация = Отбор.Организация
	|		И Т.ПериодРегистрации <= Отбор.ПериодРегистрации
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Организация,
	|	Т.ДокументПоступления
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиТоваровПостатейныеЗатраты КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПериодПерехода КАК Отбор
	|		ПО Т.Организация = Отбор.Организация
	|		И Т.Период <= Отбор.ПериодРегистрации
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументПоступления,
	|	Организация
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	1 КАК НомерРегистра,
	|	Т.Организация КАК Организация,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Остатки.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Остатки.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Остатки.ВидЗапасов,
	|	Т.ДокументПоступления КАК ДокументПоступления,
	|	Остатки.Количество КАК Количество,
	|	ВЫРАЗИТЬ((Т.СтоимостьБезНДСРегл
	|		+ ВЫБОР
	|			КОГДА Остатки.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|				ТОГДА Т.НДСРегл
	|			ИНАЧЕ 0
	|		КОНЕЦ) * Остатки.Количество КАК ЧИСЛО (31,2)) КАК СтоимостьРегл,
	|	ВЫРАЗИТЬ((Т.СтоимостьБезНДСУпр
	|		+ ВЫБОР
	|			КОГДА Остатки.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|				ТОГДА Т.НДСУпр
	|			ИНАЧЕ 0
	|		КОНЕЦ) * Остатки.Количество КАК ЧИСЛО (31,2)) КАК СтоимостьУпр
	|ПОМЕСТИТЬ ВТПартииНДС2_4
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиПартииТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТСебестоимость КАК Остатки
	|		ПО Т.Организация = Остатки.Организация
	|		И Т.Номенклатура = Остатки.Номенклатура
	|		И Т.Характеристика = Остатки.Характеристика
	|		И Т.ВидЗапасов = Остатки.ВидЗапасов
	|		И Т.Партия = Остатки.Партия
	|		И Т.АналитикаУчетаПартий = Остатки.АналитикаУчетаПартий
	|		И (Остатки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|			ИЛИ Остатки.АналитикаУчетаНоменклатуры = Т.АналитикаУчетаНоменклатурыНЗП)
	|ГДЕ
	|	Т.ПериодРегистрации <= &НачалоПериода
	|	И Т.Организация В (&МассивОрганизаций)
	|	И Т.Организация В (&ОрганизацииСДетализациейЗатрат)
	|	И &ПартионныйУчетВерсии22
	|	И &ПроверятьСоответствиеСебестоимостиИПартийНДСФИФОСкользящая
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	2 КАК НомерРегистра,
	|	Т.Организация КАК Организация,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Остатки.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Остатки.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Остатки.ВидЗапасов,
	|	Т.ДокументПоступления КАК ДокументПоступления,
	|	Остатки.Количество КАК Количество,
	|	ВЫРАЗИТЬ((Т.СтоимостьБезНДСРегл
	|		+ ВЫБОР
	|			КОГДА Остатки.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|				ТОГДА Т.НДСРегл
	|			ИНАЧЕ 0
	|		КОНЕЦ) * Остатки.Количество КАК ЧИСЛО (31,2)) КАК СтоимостьРегл,
	|	ВЫРАЗИТЬ((Т.СтоимостьБезНДСУпр
	|		+ ВЫБОР
	|			КОГДА Остатки.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|				ТОГДА Т.НДСУпр
	|			ИНАЧЕ 0
	|		КОНЕЦ) * Остатки.Количество КАК ЧИСЛО (31,2)) КАК СтоимостьУпр
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТСебестоимость КАК Остатки
	|		ПО Т.Организация = Остатки.Организация
	|		И Т.Номенклатура = Остатки.Номенклатура
	|		И Т.Характеристика = Остатки.Характеристика
	|		И Т.ВидЗапасов = Остатки.ВидЗапасов
	|		И Т.Партия = Остатки.Партия
	|		И Т.АналитикаУчетаПартий = Остатки.АналитикаУчетаПартий
	|		И (Остатки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|			ИЛИ Остатки.АналитикаУчетаНоменклатуры = Т.АналитикаУчетаНоменклатурыНЗП)
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТСтатьиПроизводственныхЗатрат КАК Статьи
	|		ПО Т.СтатьяРасходов = Статьи.Ссылка
	|ГДЕ
	|	Т.ПериодРегистрации <= &НачалоПериода
	|	И Т.Организация В (&МассивОрганизаций)
	|	И Т.Организация В (&ОрганизацииСДетализациейЗатрат)
	|	И Статьи.Ссылка ЕСТЬ NULL
	|	И &ПартионныйУчетВерсии22
	|	И &ПроверятьСоответствиеСебестоимостиИПартийНДСФИФОСкользящая
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	3 КАК НомерРегистра,
	|	Т.Организация КАК Организация,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Остатки.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Остатки.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Остатки.ВидЗапасов,
	|	Т.ДокументПоступления КАК ДокументПоступления,
	|	Остатки.Количество КАК Количество,
	|	ВЫРАЗИТЬ((Т.СтоимостьБезНДСРегл
	|		+ ВЫБОР
	|			КОГДА Остатки.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|				ТОГДА Т.НДСРегл
	|			ИНАЧЕ 0
	|		КОНЕЦ) * Остатки.Количество КАК ЧИСЛО (31,2)) КАК СтоимостьРегл,
	|	ВЫРАЗИТЬ((Т.СтоимостьБезНДСУпр
	|		+ ВЫБОР
	|			КОГДА Остатки.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|				ТОГДА Т.НДСУпр
	|			ИНАЧЕ 0
	|		КОНЕЦ) * Остатки.Количество КАК ЧИСЛО (31,2)) КАК СтоимостьУпр
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиТоваровПостатейныеЗатраты КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТСебестоимость КАК Остатки
	|		ПО Т.Организация = Остатки.Организация
	|		И Т.АналитикаУчетаНоменклатуры = Остатки.АналитикаУчетаНоменклатуры
	|		И Т.ВидЗапасов = Остатки.ВидЗапасов
	|		И Т.Партия = Остатки.Партия
	|		И Т.АналитикаУчетаПартий = Остатки.АналитикаУчетаПартий
	|		И Т.РазделУчета = Остатки.РазделУчета
	|		И Т.АналитикаФинансовогоУчета = Остатки.АналитикаФинансовогоУчета
	|		И Т.ВидДеятельностиНДС = Остатки.ВидДеятельностиНДС
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТСтатьиПроизводственныхЗатрат КАК Статьи
	|		ПО Т.СтатьяРасходов = Статьи.Ссылка
	|ГДЕ
	|	Т.Период = &НачалоПериода
	|	И Т.Организация В (&МассивОрганизаций)
	|	И Т.Организация В (&ОрганизацииСДетализациейЗатрат)
	|	И Статьи.Ссылка ЕСТЬ NULL
	|	И Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка)
	|	И &ПартионныйУчетВерсии22
	|	И &ПроверятьСоответствиеСебестоимостиИПартийНДСФИФОСкользящая
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументПоступления,
	|	Организация
	|;
	//++ Локализация
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	СУММА(Т.КоличествоСебестоимость) КАК КоличествоСебестоимость,
	|	СУММА(Т.КоличествоПартииНДС) КАК КоличествоПартииНДС
	|ПОМЕСТИТЬ ВТРасхожденияСебестоимостиИПартийНДС
	|ИЗ
	|	(ВЫБРАТЬ
	|		Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Т.РазделУчета КАК РазделУчета,
	|		Т.ВидЗапасов КАК ВидЗапасов,
	|		Т.Организация КАК Организация,
	|		Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|		Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|		Т.Количество КАК КоличествоСебестоимость,
	|		0 КАК КоличествоПартииНДС
	|	ИЗ
	|		ВТСебестоимость КАК Т
	|	ГДЕ
	|		&ПроверятьСоответствиеСебестоимостиИПартийНДС
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.РазделУчета,
	|		Т.ВидЗапасов,
	|		Т.Организация,
	|		Т.АналитикаФинансовогоУчета,
	|		Т.ВидДеятельностиНДС,
	|		0,
	|		Т.Количество
	|	ИЗ
	|		ВТПартииНДС КАК Т
	|	ГДЕ
	|		&ПроверятьСоответствиеСебестоимостиИПартийНДС) КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.РазделУчета,
	|	Т.ВидЗапасов,
	|	Т.Организация,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС
	|
	|ИМЕЮЩИЕ
	|	СУММА(Т.КоличествоСебестоимость) >= 0
	|	И СУММА(Т.КоличествоСебестоимость) < СУММА(Т.КоличествоПартииНДС)
	|;
	//-- Локализация
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	СУММА(Т.КоличествоСебестоимость) КАК КоличествоСебестоимость,
	|	СУММА(Т.СтоимостьРеглСебестоимость) КАК СтоимостьРеглСебестоимость,
	|	СУММА(Т.СтоимостьУпрСебестоимость) КАК СтоимостьУпрСебестоимость,
	|	СУММА(Т.СтоимостьРеглПартииНДС) КАК СтоимостьРеглПартииНДС,
	|	СУММА(Т.СтоимостьУпрПартииНДС) КАК СтоимостьУпрПартииНДС
	|ПОМЕСТИТЬ ВТРасхожденияСебестоимостиИПартийНДС2_4
	|ИЗ
	|	(ВЫБРАТЬ
	|		Т.Организация,
	|		Т.Партия,
	|		ЕСТЬNULL(АналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)) КАК АналитикаУчетаПартий,
	|		Т.ВидДеятельностиНДС,
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов,
	|		Т.Количество КАК КоличествоСебестоимость,
	|		Т.СтоимостьРегл КАК СтоимостьРеглСебестоимость,
	|		Т.СтоимостьУпр КАК СтоимостьУпрСебестоимость,
	|		0 КАК СтоимостьРеглПартииНДС,
	|		0 КАК СтоимостьУпрПартииНДС
	|	ИЗ
	|		ВТСебестоимость КАК Т
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТОтборАналитикиУчетаПартийНДС2_4 КАК АналитикиУчетаПартий
	|			ПО Т.АналитикаУчетаПартий = АналитикиУчетаПартий.Ссылка
	|	ГДЕ
	|		&ПроверятьСоответствиеСебестоимостиИПартийНДСФИФОСкользящая
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Т.Организация,
	|		Т.Партия,
	|		Т.АналитикаУчетаПартий,
	|		Т.ВидДеятельностиНДС,
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов,
	|		0 КАК КоличествоСебестоимость,
	|		0 КАК СтоимостьРеглСебестоимость,
	|		0 КАК СтоимостьУпрСебестоимость,
	|		Т.СтоимостьРегл КАК СтоимостьРеглПартииНДС,
	|		Т.СтоимостьУпр КАК СтоимостьУпрПартииНДС
	|	ИЗ
	|		ВТПартииНДС2_4 КАК Т
	|		ЛЕВОЕ СОЕДИНЕНИЕ СтарыеДокументыПоступления КАК Отбор
	|			ПО Т.ДокументПоступления = Отбор.ДокументПоступления
	|			И Т.Организация = Отбор.Организация
	|	ГДЕ
	|		&ПроверятьСоответствиеСебестоимостиИПартийНДСФИФОСкользящая
	|		И Отбор.ДокументПоступления ЕСТЬ NULL) КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов
	|
	|ИМЕЮЩИЕ
	|	(СУММА(Т.КоличествоСебестоимость) > 0
	|		И СУММА(Т.СтоимостьРеглСебестоимость) >= 0
	|		И СУММА(Т.СтоимостьРеглСебестоимость) + &ЗначениеПогрешностиСебестоимостьРегл < СУММА(Т.СтоимостьРеглПартииНДС))
	|	ИЛИ
	|	(СУММА(Т.КоличествоСебестоимость) > 0
	|		И СУММА(Т.СтоимостьУпрСебестоимость) >= 0
	|		И СУММА(Т.СтоимостьУпрСебестоимость) + &ЗначениеПогрешностиСебестоимостьУпр < СУММА(Т.СтоимостьУпрПартииНДС))
	|;
	//++ Локализация
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	СУММА(Т.КоличествоСебестоимость) КАК КоличествоСебестоимость,
	|	СУММА(Т.КоличествоПартииНДС) КАК КоличествоПартииНДС,
	|	СУММА(Т.СтоимостьПартииНДС) КАК СтоимостьПартииНДС
	|ПОМЕСТИТЬ ВТСуммовыеОстаткиПартийНДС
	|ИЗ
	|	(ВЫБРАТЬ
	|		Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Т.РазделУчета КАК РазделУчета,
	|		Т.ВидЗапасов КАК ВидЗапасов,
	|		Т.Организация КАК Организация,
	|		Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|		Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|		Т.Количество КАК КоличествоСебестоимость,
	|		0 КАК КоличествоПартииНДС,
	|		0 КАК СтоимостьПартииНДС
	|	ИЗ
	|		ВТСебестоимость КАК Т
	|	ГДЕ
	|		&ПроверятьСоответствиеСебестоимостиИПартийНДС
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.РазделУчета,
	|		Т.ВидЗапасов,
	|		Т.Организация,
	|		Т.АналитикаФинансовогоУчета,
	|		Т.ВидДеятельностиНДС,
	|		0 КАК КоличествоСебестоимость,
	|		Т.Количество КАК КоличествоПартииНДС,
	|		Т.СтоимостьБезНДС КАК СтоимостьПартииНДС
	|	ИЗ
	|		ВТПартииНДС КАК Т
	|	ГДЕ
	|		&ПроверятьСоответствиеСебестоимостиИПартийНДС) КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.РазделУчета,
	|	Т.ВидЗапасов,
	|	Т.Организация,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС
	|
	|ИМЕЮЩИЕ
	|	СУММА(Т.КоличествоСебестоимость) = 0
	|	И СУММА(Т.КоличествоПартииНДС) = 0
	|	И СУММА(Т.СтоимостьПартииНДС) <> 0
	//-- Локализация
	|";
	
	// Регистрация расхождений по количеству между регистрами себестоимости и партиями НДС 2.4.
	СписокПолей = Новый СписокЗначений;
	СписокПолей.Добавить("Организация", 				НСтр("ru='Организация'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("Партия",						НСтр("ru='Партия'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("АналитикаУчетаПартий",		НСтр("ru='Аналитика партий'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("ВидДеятельностиНДС",			НСтр("ru='Вид деятельности НДС'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("АналитикаУчетаНоменклатуры",	НСтр("ru = 'Аналитика учета номенклатуры'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("ВидЗапасов",					НСтр("ru = 'Вид запасов'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("СтоимостьРеглСебестоимость",	НСтр("ru='Стоимость регл. (себестоимость)'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("СтоимостьУпрСебестоимость",	НСтр("ru='Стоимость упр. (себестоимость)'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("СтоимостьРеглПартииНДС",		НСтр("ru='Стоимость регл. (партии НДС)'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("СтоимостьУпрПартииНДС",		НСтр("ru='Стоимость упр. (партии НДС)'", ОбщегоНазначения.КодОсновногоЯзыка()));
	
	ПараметрыРегистрации = ЗакрытиеМесяцаСервер.ИнициализироватьПараметрыРегистрацииПроблемПроверки(
		"ВТРасхожденияСебестоимостиИПартийНДС2_4",
		НСтр("ru='Обнаружены расхождения в суммах между регистрами себестоимости и детализации себестоимости партий товаров по организации ""%1"" на конец периода %2'", ОбщегоНазначения.КодОсновногоЯзыка()),
		СписокПолей,
		,
		Метаданные.РегистрыСведений.ДетализацияСебестоимостиПартииТоваров.ПолноеИмя());
	
	//++ Локализация
	// Регистрация расхождений по количеству между регистрами себестоимости и партиями НДС 2.2.
	СписокПолей = Новый СписокЗначений;
	СписокПолей.Добавить("Организация", 				НСтр("ru='Организация'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("РазделУчета",					НСтр("ru='Раздел учета'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("АналитикаУчетаНоменклатуры",	НСтр("ru='Аналитика номенклатуры'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("ВидЗапасов",					НСтр("ru='Вид запасов'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("АналитикаФинансовогоУчета",	НСтр("ru='Аналитика финансового учета'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("ВидДеятельностиНДС",			НСтр("ru='Вид деятельности НДС'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("КоличествоСебестоимость",		НСтр("ru='Количество (себестоимость)'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("КоличествоПартииНДС",			НСтр("ru='Количество (партии НДС)'", ОбщегоНазначения.КодОсновногоЯзыка()));
	
	ЗакрытиеМесяцаСервер.ДополнитьПараметрыРегистрацииПроблемПроверки(ПараметрыРегистрации,
		"ВТРасхожденияСебестоимостиИПартийНДС",
		НСтр("ru='Обнаружены расхождения по количеству между регистрами себестоимости и партий НДС (средняя за месяц) по организации ""%1"" на конец периода %2'", ОбщегоНазначения.КодОсновногоЯзыка()),
		СписокПолей,
		,
		Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН.ПолноеИмя());
		
	// Регистрация наличия суммовых остатков в регистре "Детализация партий товаров для НДС и УСН (средняя за месяц)".
	СписокПолей = Новый СписокЗначений;
	СписокПолей.Добавить("Организация", 				НСтр("ru='Организация'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("РазделУчета",					НСтр("ru='Раздел учета'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("АналитикаУчетаНоменклатуры",	НСтр("ru='Аналитика номенклатуры'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("ВидЗапасов",					НСтр("ru='Вид запасов'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("АналитикаФинансовогоУчета",	НСтр("ru='Аналитика финансового учета'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("ВидДеятельностиНДС",			НСтр("ru='Вид деятельности НДС'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("СтоимостьПартииНДС",			НСтр("ru='Стоимость без НДС'", ОбщегоНазначения.КодОсновногоЯзыка()));
	
	ЗакрытиеМесяцаСервер.ДополнитьПараметрыРегистрацииПроблемПроверки(ПараметрыРегистрации,
		"ВТСуммовыеОстаткиПартийНДС",
		НСтр("ru='Обнаружены суммовые остатки без количества в регистре ""Детализация партий товаров для НДС и УСН (средняя за месяц)"" по организации ""%1"" на конец периода %2'", ОбщегоНазначения.КодОсновногоЯзыка()),
		СписокПолей,
		,
		Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН.ПолноеИмя());
	//-- Локализация
		
	// Регистрация проблем.
	ДопПараметры = Новый Структура;
	ДопПараметры.Вставить("ТипыНалогообложенияНДСУчитываетсяВСтоимости", УчетНДСУП.ВидыДеятельностиНДСУчитываетсяВСтоимости());
	ДопПараметры.Вставить("ЗначениеПогрешностиСебестоимостьРегл", 		 ЗначенияПараметров.ЗначениеПогрешностиСебестоимостьРегл);
	ДопПараметры.Вставить("ЗначениеПогрешностиСебестоимостьУпр", 		 ЗначенияПараметров.ЗначениеПогрешностиСебестоимостьУпр);
	ДопПараметры.Вставить("ПроверятьСоответствиеСебестоимостиИПартийНДС", ЗначенияПараметров.ПроверятьСоответствиеСебестоимостиИПартийНДС);
	Если АвтоматическоеТестирование Тогда
		ДопПараметры.Вставить("ПроверятьСоответствиеСебестоимостиИПартийНДСФИФОСкользящая", Истина);
	Иначе
		ДопПараметры.Вставить("ПроверятьСоответствиеСебестоимостиИПартийНДСФИФОСкользящая", ЗначенияПараметров.ПроверятьСоответствиеСебестоимостиИПартийНДСФИФОСкользящая);
	КонецЕсли;
	
	ЗакрытиеМесяцаСервер.ЗарегистрироватьПроблемыВыполненияПроверки(
		ПараметрыПроверки,
		ПараметрыРегистрации,
		ТекстЗапроса,
		ДопПараметры);
	
КонецПроцедуры

// Процедура-обработчик проверки состояния системы.
//
// Параметры:
//	ПараметрыПроверки - см. АудитСостоянияСистемы.ИнициализироватьПараметрыПроверки
// 
Процедура ПроверкаКорректностиДанныхВРегистрахДетализацияСебестоимостиПартий(ПараметрыПроверки) Экспорт
	
	Если ПараметрыПроверки.ДополнительныеПараметры.РежимЗакрытияМесяца = Перечисления.РежимыЗакрытияМесяца.ПредварительноеЗакрытие Тогда
		Возврат;
	КонецЕсли;
	
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.Организация,
	|	ДД.ВидЗапасов,
	|	ДД.Номенклатура,
	|	ДД.Характеристика,
	|	ДД.ЗатратыПредыдущихПеределов,
	|	ДД.ДокументПоступления,
	|	ДД.АналитикаУчетаПартийДокументаПоступления,
	|	ДД.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	ДД.АналитикаУчетаНоменклатурыНЗП
	|ПОМЕСТИТЬ РазныеПериодыРегистрации
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиПартииТоваров КАК ДД
	|ГДЕ
	|	ДД.Организация В (&МассивОрганизаций)
	|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка)
	|	И ДД.ПериодРегистрации <= &КонецПериода
	|СГРУППИРОВАТЬ ПО
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.Организация,
	|	ДД.ВидЗапасов,
	|	ДД.Номенклатура,
	|	ДД.Характеристика,
	|	ДД.ЗатратыПредыдущихПеределов,
	|	ДД.ДокументПоступления,
	|	ДД.АналитикаУчетаПартийДокументаПоступления,
	|	ДД.АналитикаУчетаНоменклатурыДокументаПоступления,
	|	ДД.АналитикаУчетаНоменклатурыНЗП
	|ИМЕЮЩИЕ
	|	СУММА(ВЫРАЗИТЬ(1 КАК ЧИСЛО(15,0))) > 1
	|;
	|ВЫБРАТЬ
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.Организация,
	|	ДД.ВидЗапасов,
	|	ДД.Номенклатура,
	|	ДД.Характеристика,
	|	ДД.ЗатратыПредыдущихПеределов,
	|	ДД.ДокументПоступления,
	|	ДД.АналитикаУчетаПартийДокументаПоступления,
	|	ДД.АналитикаУчетаНоменклатурыНЗП,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов
	|ПОМЕСТИТЬ РазныеПериодыРегистрацииПостатейныеЗатраты
	|ИЗ
	|	РегистрСведений.ДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты КАК ДД
	|ГДЕ
	|	ДД.Организация В (&МассивОрганизаций)
	|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка)
	|	И ДД.ПериодРегистрации <= &КонецПериода
	|СГРУППИРОВАТЬ ПО
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.Организация,
	|	ДД.ВидЗапасов,
	|	ДД.Номенклатура,
	|	ДД.Характеристика,
	|	ДД.ЗатратыПредыдущихПеределов,
	|	ДД.ДокументПоступления,
	|	ДД.АналитикаУчетаПартийДокументаПоступления,
	|	ДД.АналитикаУчетаНоменклатурыНЗП,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов
	|ИМЕЮЩИЕ
	|	СУММА(ВЫРАЗИТЬ(1 КАК ЧИСЛО(15,0))) > 1
	|";
	
	СписокПолей = Новый СписокЗначений;
	СписокПолей.Добавить("Организация", 				НСтр("ru='Организация'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("Партия",						НСтр("ru='Партия'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("АналитикаУчетаПартий",		НСтр("ru='Аналитика учета партий'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("ВидЗапасов",					НСтр("ru='Вид запасов'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("Номенклатура",				НСтр("ru='Номенклатура'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("Характеристика",				НСтр("ru='Характеристика'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("ДокументПоступления",			НСтр("ru = 'Документ поступления'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("АналитикаУчетаПартийДокументаПоступления", НСтр("ru = 'Аналитика документа поступления'", ОбщегоНазначения.КодОсновногоЯзыка()));
	
	ПараметрыРегистрации = ЗакрытиеМесяцаСервер.ИнициализироватьПараметрыРегистрацииПроблемПроверки(
		"РазныеПериодыРегистрации",
		НСтр("ru='Обнаружены записи с разными периодами регистрации для одной партии по организации ""%1"" в периоде %2'", 
		ОбщегоНазначения.КодОсновногоЯзыка()),
		СписокПолей,
		,
		Метаданные.РегистрыСведений.ДетализацияСебестоимостиПартииТоваров.ПолноеИмя());
		
	ЗакрытиеМесяцаСервер.ДополнитьПараметрыРегистрацииПроблемПроверки(ПараметрыРегистрации,
		"РазныеПериодыРегистрацииПостатейныеЗатраты",
		НСтр("ru='Обнаружены записи с разными периодами регистрации для одной партии постатейных затрат по организации ""%1"" в периоде %2'", 
		ОбщегоНазначения.КодОсновногоЯзыка()),
		СписокПолей,
		,
		Метаданные.РегистрыСведений.ДетализацияСебестоимостиПартииТоваровПостатейныеЗатраты.ПолноеИмя());
		
	ЗакрытиеМесяцаСервер.ЗарегистрироватьПроблемыВыполненияПроверки(
		ПараметрыПроверки,
		ПараметрыРегистрации,
		ТекстЗапроса);
	
КонецПроцедуры

// Процедура-обработчик проверки состояния системы "СоответствиеРегистровПрочиеРасходыИПартийПрочихРасходов".
//
// Параметры:
//	ПараметрыПроверки - Структура - параметры проверки, см. АудитСостоянияСистемы.ИнициализироватьПараметрыПроверки.
//
Процедура ПроверкаСоответствияРегистровПрочиеРасходыИПартийПрочихРасходов(ПараметрыПроверки) Экспорт
	
	Если ПараметрыПроверки.ДополнительныеПараметры.РежимЗакрытияМесяца = Перечисления.РежимыЗакрытияМесяца.ПредварительноеЗакрытие Тогда
		Возврат;
	КонецЕсли;
	
	ЗначенияПараметров = РасчетСебестоимостиПовтИсп.ЗначенияТехнологическихПараметров();
	
	// Проверка выполняется если явно включен соответствующий технологический параметр.
	Если НЕ ЗначенияПараметров.ПроверятьСоответствиеПрочихРасходовИПартийПрочихРасходов Тогда
		Возврат;
	КонецЕсли;
	
	ТекстЗапроса = ТекстЗапросаСоответствияПрочиеРасходыИПартийПрочихРасходов();
	
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("УчитыватьКорректировки", Ложь);
	
	СписокПолей = Новый СписокЗначений;
	СписокПолей.Добавить("Организация", 			НСтр("ru='Организация'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("Подразделение",			НСтр("ru='Подразделение'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("НаправлениеДеятельности",	НСтр("ru='Направление деятельности'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("СтатьяРасходов",			НСтр("ru='Статья расходов'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("АналитикаРасходов",		НСтр("ru='Аналитика расходов'", ОбщегоНазначения.КодОсновногоЯзыка()));
	
	ПараметрыРегистрации = ЗакрытиеМесяцаСервер.ИнициализироватьПараметрыРегистрацииПроблемПроверки(
		"ВТОстаткиПартийПрочихРасходов",
		НСтр("ru='Обнаружены остатки в регистре партий прочих расходов по организации ""%1"" на конец периода %2'", ОбщегоНазначения.КодОсновногоЯзыка()),
		СписокПолей,
		,
		Метаданные.РегистрыНакопления.ПартииПрочихРасходов.ПолноеИмя());
		
	// Регистрация проблем.
	ЗакрытиеМесяцаСервер.ЗарегистрироватьПроблемыВыполненияПроверки(
		ПараметрыПроверки,
		ПараметрыРегистрации,
		ТекстЗапроса,
		ДополнительныеПараметры);
	
КонецПроцедуры

// Возвращает текст запроса соответствия прочие расходы и партий прочих расходов.
// 
// Возвращаемое значение:
//  Строка - Текст запроса
//
Функция ТекстЗапросаСоответствияПрочиеРасходыИПартийПрочихРасходов() Экспорт
	
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	Т.Ссылка КАК Ссылка,
	|	ВЫБОР 
	|		КОГДА Т.ВариантРаспределенияРасходовРегл В (
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
	|			ТОГДА 1
	|			ИНАЧЕ 0
	|	КОНЕЦ КАК КоэффициентРегл,
	|	ВЫБОР 
	|		КОГДА Т.ВариантРаспределенияРасходовУпр В (
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
	|			ТОГДА 1
	|			ИНАЧЕ 0
	|	КОНЕЦ КАК КоэффициентУпр
	|ПОМЕСТИТЬ ВТОтборСтатьиПартийПрочихРасходов
	|ИЗ
	|	ПланВидовХарактеристик.СтатьиРасходов КАК Т
	|ГДЕ
	|	Т.ВариантРаспределенияРасходовУпр В (
	|		ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|		ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
	|	  И Т.ВариантРаздельногоУчетаНДС <> ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
	|	ИЛИ Т.ВариантРаспределенияРасходовРегл В (
	|		ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|		ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
	|	  И Т.ВариантРаздельногоУчетаНДС <> ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|//////////////////////////////////////////////////////////////////////////////////////////////
	// Пока проверка остатков регистра "Партии прочих расходов" для метода оценки Среднескользящая не выполняется
	|ВЫБРАТЬ
	|	Т.Ссылка
	|ПОМЕСТИТЬ ВТОрганизацииДляПроверки
	|ИЗ
	|	Справочник.Организации КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.УчетнаяПолитикаФинансовогоУчета.СрезПоследних(&НачалоПериода ,Организация В (&МассивОрганизаций)) КАК Политики
	|		ПО Т.Ссылка = Политики.Организация
	|ГДЕ
	|	Т.Ссылка В (&МассивОрганизаций)
	|	И (ЕСТЬNULL(Политики.МетодОценкиСтоимостиТоваров, НЕОПРЕДЕЛЕНО) <> ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	// При списании зависших остатков в партиях прочих расходов (УчитыватьКорректировки = Истина) метод оценки стоимости не важен
	|		ИЛИ &УчитыватьКорректировки)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|//////////////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.ДокументПоступленияРасходов,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидДеятельностиНДС,
	|	Отбор.КоэффициентРегл * Т.СтоимостьРеглОстаток КАК СтоимостьРегл,
	|	Отбор.КоэффициентРегл * Т.НДСРеглОстаток КАК НДСРегл,
	|	Отбор.КоэффициентУпр * Т.НДСУпрОстаток КАК НДСУпр
	|ПОМЕСТИТЬ ВТПартииПрочихРасходовПредварительная
	|ИЗ
	|	РегистрНакопления.ПартииПрочихРасходов.Остатки(
	|		&ГраницаКонецПериода,
	|		Организация В (&МассивОрганизаций)
	|		И &ПартионныйУчетВерсии22
	|	) КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборСтатьиПартийПрочихРасходов КАК Отбор
	|		ПО Т.СтатьяРасходов = Отбор.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОрганизацииДляПроверки КАК ОтборОрганизации
	|		ПО Т.Организация = ОтборОрганизации.Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Для диагностики текущего периода надо исключить результаты процедуры СкорректироватьНачальныеОстаткиПартииПрочихРасходов следующего периода 
	// Для процедуры СкорректироватьНачальныеОстаткиПартииПрочихРасходов не нужно учитывать результаты корректировки следующего периода
	|ВЫБРАТЬ
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.ДокументПоступленияРасходов,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидДеятельностиНДС,
	|	-Отбор.КоэффициентРегл * Т.СтоимостьРегл КАК СтоимостьРегл,
	|	-Отбор.КоэффициентРегл * Т.НДСРегл КАК НДСРегл,
	|	-Отбор.КоэффициентУпр * Т.НДСУпр КАК НДСУпр
	|ИЗ
	|	РегистрНакопления.ПартииПрочихРасходов КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборСтатьиПартийПрочихРасходов КАК Отбор
	|		ПО Т.СтатьяРасходов = Отбор.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОрганизацииДляПроверки КАК ОтборОрганизации
	|		ПО Т.Организация = ОтборОрганизации.Ссылка
	|ГДЕ
	|	Т.Период = &КонецПериода
	|	И Т.Организация В (&МассивОрганизаций)
	|	И Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СлужебноеКорректировкаОстатковПартийПрочихРасходов)
	|	И НЕ &УчитыватьКорректировки
	|	И &ПартионныйУчетВерсии22
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Для диагностики текущего периода нужны "реальные" остатки на начало периода
	// Для процедуры СкорректироватьНачальныеОстаткиПартииПрочихРасходов нужно получить остатки без учета результата предыдущей корректировки текущего периода
	|ВЫБРАТЬ
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.ДокументПоступленияРасходов,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидДеятельностиНДС,
	|	-Отбор.КоэффициентРегл * Т.СтоимостьРегл КАК СтоимостьРегл,
	|	-Отбор.КоэффициентРегл * Т.НДСРегл КАК НДСРегл,
	|	-Отбор.КоэффициентУпр * Т.НДСУпр КАК НДСУпр
	|ИЗ
	|	РегистрНакопления.ПартииПрочихРасходов КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборСтатьиПартийПрочихРасходов КАК Отбор
	|		ПО Т.СтатьяРасходов = Отбор.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОрганизацииДляПроверки КАК ОтборОрганизации
	|		ПО Т.Организация = ОтборОрганизации.Ссылка
	|ГДЕ
	|	Т.Период = ДОБАВИТЬКДАТЕ(&НачалоПериода, СЕКУНДА, -1)
	|	И Т.Организация В (&МассивОрганизаций)
	|	И Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СлужебноеКорректировкаОстатковПартийПрочихРасходов)
	|	И &УчитыватьКорректировки
	|	И &ПартионныйУчетВерсии22
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СтатьяРасходов,
	|	АналитикаРасходов,
	|	Подразделение,
	|	Организация,
	|	НаправлениеДеятельности
	|;
	|//////////////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.ДокументПоступленияРасходов,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидДеятельностиНДС,
	|	СУММА(Т.СтоимостьРегл) КАК СтоимостьРегл,
	|	СУММА(Т.НДСРегл) КАК НДСРегл,
	|	СУММА(Т.НДСУпр) КАК НДСУпр
	|ПОМЕСТИТЬ ВТПартииПрочихРасходов
	|ИЗ
	|	ВТПартииПрочихРасходовПредварительная КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.ДокументПоступленияРасходов,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидДеятельностиНДС
	|ИМЕЮЩИЕ
	|	СУММА(Т.СтоимостьРегл) <> 0
	|	ИЛИ СУММА(Т.НДСРегл) <> 0
	|	ИЛИ СУММА(Т.НДСУпр) <> 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СтатьяРасходов,
	|	АналитикаРасходов,
	|	Подразделение,
	|	Организация,
	|	НаправлениеДеятельности
	|;
	|//////////////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Отбор.КоэффициентРегл * Т.СуммаОстаток КАК Сумма,
	|	Отбор.КоэффициентРегл * Т.СуммаРеглОстаток КАК СуммаРегл,
	|	Отбор.КоэффициентУпр * Т.СуммаУпрОстаток КАК СуммаУпр
	|ПОМЕСТИТЬ ВТПрочиеРасходы
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходы.Остатки(
	|		&ГраницаКонецПериода,
	|		Организация В (&МассивОрганизаций)
	|		И &ПартионныйУчетВерсии22
	|		И (Организация, Подразделение, НаправлениеДеятельности, СтатьяРасходов, АналитикаРасходов) В (
	|			ВЫБРАТЬ
	|				Организация,
	|				Подразделение,
	|				НаправлениеДеятельности,
	|				СтатьяРасходов,
	|				АналитикаРасходов
	|			ИЗ
	|				ВТПартииПрочихРасходов)
	|	) КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборСтатьиПартийПрочихРасходов КАК Отбор
	|		ПО Т.СтатьяРасходов = Отбор.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОрганизацииДляПроверки КАК ОтборОрганизации
	|		ПО Т.Организация = ОтборОрганизации.Ссылка
	|ИНДЕКСИРОВАТЬ ПО
	|	СтатьяРасходов,
	|	АналитикаРасходов,
	|	Подразделение,
	|	Организация,
	|	НаправлениеДеятельности
	|;
	|//////////////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.ДокументПоступленияРасходов,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидДеятельностиНДС,
	|	Т.СтоимостьРегл,
	|	Т.НДСРегл,
	|	Т.НДСУпр
	|ПОМЕСТИТЬ ВТОстаткиПартийПрочихРасходовДетальные
	|ИЗ
	|	ВТПартииПрочихРасходов КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТПрочиеРасходы КАК Отбор
	|		ПО Т.СтатьяРасходов = Отбор.СтатьяРасходов
	|		 И Т.АналитикаРасходов = Отбор.АналитикаРасходов
	|		 И Т.Подразделение = Отбор.Подразделение
	|		 И Т.Организация = Отбор.Организация
	|		 И Т.НаправлениеДеятельности = Отбор.НаправлениеДеятельности
	|ГДЕ
	|	((Т.СтоимостьРегл <> 0 ИЛИ Т.НДСРегл <> 0) И ЕСТЬNULL(Отбор.СуммаРегл, 0) = 0 И ЕСТЬNULL(Отбор.Сумма, 0) = 0)
	|	ИЛИ (Т.НДСУпр <> 0 И ЕСТЬNULL(Отбор.СуммаУпр, 0) = 0 И ЕСТЬNULL(Отбор.Сумма, 0) = 0)
	|;
	|//////////////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	СУММА(Т.СтоимостьРегл) КАК СтоимостьРегл,
	|	СУММА(Т.НДСРегл) КАК НДСРегл,
	|	СУММА(Т.НДСУпр) КАК НДСУпр
	|
	|ПОМЕСТИТЬ ВТОстаткиПартийПрочихРасходов
	|ИЗ
	|	ВТОстаткиПартийПрочихРасходовДетальные КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	СтатьяРасходов
	|";
	
	Возврат ТекстЗапроса;
	
КонецФункции

//++ Локализация

// Проверка необходимости пересчета себестоимости из-за незаполненного измерения АналитикаУчетаПартий регистра ДетализацияПартийТоваровДляНДСиУСН2_4.
// Вызывается в процедуре определения состояния этапа расчета партий и себестоимости.
//
// Возвращаемое значение:
//	Дата, Неопределено -
//
Функция ПроверкаНеобходимостьПересчетаРегистраПартийНДС(ПараметрыРасчета) Экспорт
	
	Если НЕ РасчетСебестоимостиПовтИсп.ПартионныйУчетВерсии22(НачалоМесяца(ПараметрыРасчета.ПериодРегистрации)) Тогда
		Возврат Неопределено; // проверка нужна только при ПУ22
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
	Запрос.УстановитьПараметр("КонецПериода", 				  КонецМесяца(ПараметрыРасчета.ПериодРегистрации));
	Запрос.УстановитьПараметр("МассивОрганизаций",  		  ПараметрыРасчета.МассивОрганизаций);
	Запрос.УстановитьПараметр("ТипыЗаписейКонвертацииДанных", РасчетСебестоимостиПрикладныеАлгоритмы.ТипыЗаписейКонвертацииДанных());
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	МИНИМУМ(ВЫБОР
	|			КОГДА Т.ТипЗаписи В (&ТипыЗаписейКонвертацииДанных)
	|				ТОГДА ДОБАВИТЬКДАТЕ(Т.Период, МЕСЯЦ, 1)
	|			ИНАЧЕ Т.Период
	|		КОНЕЦ) КАК Период
	|ИЗ
	|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН2_4 КАК Т
	|ГДЕ
	|	Т.Организация В(&МассивОрганизаций)
	|	И Т.ДокументПоступления = Т.Партия
	|	И Т.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|	И Т.АналитикаУчетаДокументаПоступления <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|	И НЕ Т.АналитикаУчетаДокументаПоступления.Контрагент В (ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка), ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка), НЕОПРЕДЕЛЕНО)
	|	И ВЫБОР
	|			КОГДА Т.ТипЗаписи В (&ТипыЗаписейКонвертацииДанных)
	|				ТОГДА ДОБАВИТЬКДАТЕ(Т.Период, МЕСЯЦ, 1)
	|			ИНАЧЕ Т.Период
	|		КОНЕЦ <= &КонецПериода
	|	И Т.Активность";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() И ЗначениеЗаполнено(Выборка.Период) Тогда
		Возврат Выборка.Период;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

//-- Локализация

#КонецОбласти

#Область Тестирование

// Дополняет список этапов расчета.
// 
// Параметры:
// 	СписокЭтапов - СписокЗначений - 
//
Процедура ДополнитьЭтапыСРаспределениемПартий(СписокЭтапов) Экспорт
	
	СписокЭтапов.Добавить("РаспределениеПартийНДСФИФОСкользящаяПоДопРасходам");
	//++ Локализация
	СписокЭтапов.Добавить("ПодготовкаДанныхДляУчетаНДСиУСН");
	//-- Локализация
	
КонецПроцедуры

// Дополняет список этапов расчета.
// 
// Параметры:
// 	СписокЭтапов - СписокЗначений - 
//
Процедура ДополнитьЭтапыСТрансляциейПартий(СписокЭтапов) Экспорт
	
	СписокЭтапов.Добавить("ПодготовкаДанныхДляПартийПрочихРасходов");

	//++ Локализация
	СписокЭтапов.Добавить("ПодготовкаДанныхДляВключенияИсключенияНДСДопРасходовВСтоимость24");
	СписокЭтапов.Добавить("ПодготовкаДанныхДляПрочихРасходов");
	СписокЭтапов.Добавить("ПодготовкаДанныхДляПартийНДСКРаспределению");
	СписокЭтапов.Добавить("РаспределениеПартийНДСФИФОСкользящаяПоПартиямПрочихРасходов");
	//-- Локализация
	
КонецПроцедуры

// Дополняет список этапов расчета.
// 
// Параметры:
// 	СписокЭтапов - СписокЗначений - 
//
Процедура ДополнитьЭтапыСПодготовкойДанныхДляСледующихЭтапов(СписокЭтапов) Экспорт
	
	СписокЭтапов.Добавить("РаспределениеПартийНДСФИФОСкользящая");
	
КонецПроцедуры

Процедура ТекстЗапросаДляРасчетаЭтапа(ИмяЭтапа, ПараметрыРасчета, ТекстЗапроса) Экспорт
	
	Если ИмяЭтапа = "ПодготовкаДанныхДляПартийПрочихРасходов" Тогда
		ТекстЗапроса = ТекстЗапросаДляПартийПрочихРасходов(ПараметрыРасчета);
		
	ИначеЕсли ИмяЭтапа = "РаспределениеПартийНДСФИФОСкользящая" Тогда
		ТекстЗапроса = ТекстЗапросаПодготовкаДанныхРаспределенияНДС(ПараметрыРасчета);
		
	ИначеЕсли ИмяЭтапа = "РаспределениеПартийНДСФИФОСкользящаяПоДопРасходам" Тогда
		ТекстЗапроса = ТекстЗапросаДляРаспределениеПартийНДСФИФОСкользящаяПоДопРасходам(ПараметрыРасчета);
		
	//++ Локализация
	ИначеЕсли ИмяЭтапа = "ПодготовкаДанныхДляВключенияИсключенияНДСДопРасходовВСтоимость24" Тогда
		ТекстЗапроса = ТекстЗапросаДляВключенияИсключенияНДСДопРасходов(ПараметрыРасчета);
		
	ИначеЕсли ИмяЭтапа = "ПодготовкаДанныхДляПрочихРасходов" Тогда
		ТекстЗапроса = ТекстЗапросаДляПрочихРасходов(ПараметрыРасчета);
	
	ИначеЕсли ИмяЭтапа = "ПодготовкаДанныхДляУчетаНДСиУСН" Тогда
		ТекстЗапроса = ТекстЗапросаДляПартийНДС(ПараметрыРасчета);
	
	ИначеЕсли ИмяЭтапа = "РаспределениеПартийНДСФИФОСкользящаяПоПартиямПрочихРасходов" Тогда
		ТекстЗапроса = ТекстЗапросаДляРаспределениеПартийНДСФИФОСкользящая(ПараметрыРасчета);
		
	ИначеЕсли ИмяЭтапа = "ПодготовкаДанныхДляПартийНДСКРаспределению" Тогда
		ТекстЗапроса =  ТекстЗапросаДляПартийНДСКРаспределению(ПараметрыРасчета);
	//-- Локализация
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти
